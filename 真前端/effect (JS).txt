  </style>

  <!-- â­ JSï¼šä½œå“åˆ—è¡¨ + ç‰¹æ•ˆç¼–è¾‘é€»è¾‘ -->
  <script>
    // å’Œ write ä¿æŒä¸€è‡´çš„ API åœ°å€
    const API_BASE_URL = 'https://api.anchorx.ca/api/works';
     const EFFECT_API_BASE_URL = 'https://api.anchorx.ca/api/effects'; // â­ æ–°å¢è¿™ä¸€è¡Œ
      const IMGBB_API_KEY = '040dbc9e6e680f321e09d9e05f447094';
    const WORK_UPLOAD_URL = 'https://api.anchorx.ca/api/works/upload';

    // ç”Ÿæˆå¸¦ Authorization çš„è¯·æ±‚å¤´
    function authHeaders(json) {
      const h = { 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') };
      if (json) h['Content-Type'] = 'application/json';
      return h;
    }

    // Delta -> çº¯æ–‡æœ¬ï¼ˆç”¨äºè‡ªåŠ¨æŒ‰è¡Œæ‹†ï¼‰
    function deltaToPlainText(delta) {
      if (!delta || typeof delta !== 'object' || !Array.isArray(delta.ops)) return '';
      let text = '';
      delta.ops.forEach(op => {
        if (typeof op.insert === 'string') text += op.insert;
      });
      return text;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const listPage = document.getElementById('effect-list-page');
      const editorPage = document.getElementById('effect-editor-page');
      const workListEl = document.getElementById('effect-work-list');
      const workCountEl = document.getElementById('effect-work-count');

      const backBtn = document.getElementById('effect-back-btn');
      const editorTitleEl = document.getElementById('effect-editor-title');

      const lineListEl = document.getElementById('effect-line-list');
      const selectedLineLabel = document.getElementById('effect-selected-line-label');
      const debugJsonEl = document.getElementById('effect-debug-json');

      const previewBtn = document.getElementById('effect-preview-btn');
      const saveDraftBtn = document.getElementById('effect-save-draft-btn');
      const publishBtn = document.getElementById('effect-publish-btn');
      const removeEffectBtn = document.getElementById('effect-remove-btn');

      // ====== æ¨¡å¼ / èƒŒæ™¯å›¾åº“ç›¸å…³ ======
let currentEffectMode = 'text'; // 'text' | 'background'

const effectToolbarTipPrefix = document.getElementById('effect-toolbar-tip-prefix');
const effectInsertLabel      = document.getElementById('effect-insert-label');
const textEffectGroup        = document.getElementById('text-effect-toolbar-group');
const bgEffectGroup          = document.getElementById('bg-effect-toolbar-group');
const bgPanel                = document.getElementById('bg-panel');

const bgUploadLocalBtn   = document.getElementById('bg-upload-local-btn');
const bgUploadInput      = document.getElementById('bg-upload-input');
const bgAddFromSharedBtn = document.getElementById('bg-add-from-shared-btn');
const bgRemoveImageBtn   = document.getElementById('bg-remove-image-btn');
const bgImageListEl      = document.getElementById('bg-image-list');

// èƒŒæ™¯ç›¸å…³æ•°æ®ç»“æ„
let bgImages = [];      // [{ id, name, url }]
let bgBindings = [];    // [{ imageId, imageName, startLine, endLine }]
let bgTransitions = []; // [{ fromLine, toLine, effectType }]

let bgSelectionPhase = 'idle'; // 'idle' | 'chooseStart' | 'chooseEnd' | 'chooseTransitionEnd'
let currentBgImageId   = null;
let currentBgImageName = '';
let bgTempStartLine    = null;
let currentTransitionEffectType = null;
let bgImageAutoId = 1;

      // â­ æ–°å¢ï¼šè‡ªå®šä¹‰ç‰¹æ•ˆç®¡ç†é¡µ DOM
      const customEffectPage = document.getElementById('custom-effect-page');
      const customEffectManageBtn = document.getElementById('custom-effect-manage-btn');
      const customEffectBackBtn = document.getElementById('custom-effect-back-btn');
      const customEffectNewBtn = document.getElementById('custom-effect-new-btn');
      const customEffectListEl = document.getElementById('custom-effect-list');
      const customEffectEmptyTip = document.getElementById('custom-effect-empty-tip');
      const customEffectEditorTitle = document.getElementById('custom-effect-editor-title');
      const customEffectNameInput = document.getElementById('custom-effect-name-input');
      const customEffectKeyInput = document.getElementById('custom-effect-key-input');
      const customEffectCodeInput = document.getElementById('custom-effect-code-input');
      const customEffectSaveBtn = document.getElementById('custom-effect-save-btn');
      const customEffectEditorPanel = document.getElementById('custom-effect-editor-panel'); // â­ æ–°å¢
      const customEffectDeleteBtn = document.getElementById('custom-effect-delete-btn');

      // â­ æ–°å¢ï¼šç¼–è¾‘å™¨é¡¶éƒ¨è‡ªå®šä¹‰ç‰¹æ•ˆä¸‹æ‹‰ DOM
      const customEffectToggleBtn = document.getElementById('custom-effect-toggle-btn');
      const customEffectDropdownPanel = document.getElementById('custom-effect-dropdown-panel');
      const customEffectDropdownClose = document.getElementById('custom-effect-dropdown-close');
      const customEffectDropdownList = document.getElementById('custom-effect-dropdown-list');
      const customEffectOpenManageBtn = document.getElementById('custom-effect-open-manage-btn');

      let currentWorkId = null;
      let currentLines = [];         // æ‰€æœ‰è¡Œæ–‡æœ¬ï¼ˆåŒ…å«ç©ºè¡Œï¼‰
      let rawToEffectiveIndex = [];  // åŸå§‹è¡Œå· -> â€œé˜…è¯»ç«¯å¥å­ç¼–å·â€ï¼ˆç©ºè¡Œä¸º nullï¼‰
      let selectedLineIndex = null;  // å½“å‰é€‰ä¸­è¡Œï¼ˆæŒ‰â€œæœ‰æ•ˆå¥å­ç¼–å·â€è®¡æ•°ï¼‰
      let effectsDraft = [];         // [{ lineIndex, effectType }]ï¼ŒlineIndex å­˜çš„æ˜¯â€œæœ‰æ•ˆå¥å­ç¼–å·â€
      let isPreviewing = false;


       // â­ æ–°å¢ï¼šè‡ªå®šä¹‰ç‰¹æ•ˆçŠ¶æ€
      let customEffects = [];
      let currentCustomEffectId = null;
      const DEFAULT_SAMPLE_CODE =
`/**
 * çº¦å®šï¼šç³»ç»Ÿå°†æ¥ä¼šæŠŠå½“å‰å¥å­çš„ DOM å…ƒç´ ä¼ å…¥è¿™ä¸ªå‡½æ•°
 * ä½ åªéœ€è¦å®ç° applyEffect(targetEl) å³å¯
 */
function applyEffect(targetEl) {
  // ç¤ºä¾‹ï¼šç»™å¥å­åŠ ä¸Šã€Œeffect-shakeã€ç±»ï¼Œè®©å®ƒæ™ƒåŠ¨ä¸€ä¸‹
  targetEl.classList.add('effect-shake');
  setTimeout(() => {
    targetEl.classList.remove('effect-shake');
  }, 600);
}`;

      /* ---------- ä½œå“ç›¸å…³ ---------- */

      async function fetchMyWorks() {
        try {
          const res = await fetch(API_BASE_URL, { headers: authHeaders(false) });
          if (res.status === 401) {
            alert('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
            window.location.href = 'https://zhidianworld.com/login/';
            return [];
          }
          if (!res.ok) {
            const j = await res.json().catch(() => ({}));
            alert('è·å–ä½œå“å¤±è´¥ï¼š' + (j.message || res.status));
            return [];
          }
          return await res.json();
        } catch (e) {
          console.error(e);
          alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½ä½œå“');
          return [];
        }
      }

      async function loadWorkList() {
  workListEl.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">æ­£åœ¨åŠ è½½ä½œå“...</p>';
  const works = await fetchMyWorks();
  if (!works || works.length === 0) {
    workListEl.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">æš‚æ— ä½œå“ã€‚</p>';
    workCountEl.textContent = '0';
    return;
  }

  workListEl.innerHTML = '';
  works.forEach(w => {
    const div = document.createElement('div');
    div.className = 'work-item-wrapper';
    div.dataset.id = w._id;
    div.innerHTML = `
      <div class="work-item">
        <div class="work-info">
          <div class="work-date">${new Date(w.updatedAt).toLocaleString()}</div>
          <div class="work-details">
            <span class="work-title">${w.title}</span>
          </div>
        </div>

        <div class="work-actions">
          <button class="create-button" data-action="edit-text-effects">
            ç¼–è¾‘æ–‡å­—ç‰¹æ•ˆ
          </button>
          <button class="create-button work-bg-button" data-action="edit-bg-effects">
            ç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆ
          </button>
        </div>
      </div>
    `;
    workListEl.appendChild(div);
  });
  workCountEl.textContent = String(works.length);
}


      workListEl.addEventListener('click', async e => {
  const textBtn = e.target.closest('[data-action="edit-text-effects"]');
  const bgBtn   = e.target.closest('[data-action="edit-bg-effects"]');
  const btn = textBtn || bgBtn;
  if (!btn) return;

  const wrapper = btn.closest('.work-item-wrapper');
  if (!wrapper) return;
  const id = wrapper.dataset.id;

  const mode = bgBtn ? 'background' : 'text';
  await enterEffectEditor(id, mode);
});

      /* ---------- è¿›å…¥ç‰¹æ•ˆç¼–è¾‘å™¨ ---------- */

      async function fetchWorkById(id) {
        try {
          const res = await fetch(API_BASE_URL + '/' + id, { headers: authHeaders(false) });
          if (!res.ok) {
            throw new Error('åŠ è½½å¤±è´¥');
          }
          return await res.json();
        } catch (e) {
          console.error(e);
          alert('åŠ è½½ä½œå“å¤±è´¥');
          return null;
        }
      }

      async function enterEffectEditor(workId, mode = 'text') {
        const work = await fetchWorkById(workId);
        if (!work) return;

        currentWorkId = workId;
        setEditorMode(mode);
        editorTitleEl.textContent = work.title || '';
        // è¯»å–å·²æœ‰è‰ç¨¿/å·²å‘å¸ƒç‰¹æ•ˆï¼ˆå¦‚æœä½ åœ¨åç«¯åŠ äº†å­—æ®µï¼‰
        // ä¼˜å…ˆåŠ è½½ effectsDraftï¼›è‹¥è‰ç¨¿ä¸ºç©ºåˆ™åŠ è½½å·²å‘å¸ƒ
// â­ æ­£ç¡®é€»è¾‘ï¼šåªè¦ effectsDraft å­—æ®µå­˜åœ¨ï¼Œå°±ä½¿ç”¨å®ƒï¼ˆå³ä½¿ä¸ºç©ºæ•°ç»„ä¹Ÿæ˜¯æœ‰æ•ˆè‰ç¨¿ï¼‰
//    åªæœ‰å­—æ®µä¸å­˜åœ¨ï¼ˆundefinedï¼‰æ—¶ï¼Œæ‰ fallback ä½¿ç”¨ effectsPublished
if (Array.isArray(work.effectsDraft)) {
    effectsDraft = work.effectsDraft.map(e => ({
        lineIndex: e.lineIndex,
        effectType: e.effectType
    }));
} else if (Array.isArray(work.effectsPublished)) {
    effectsDraft = work.effectsPublished.map(e => ({
        lineIndex: e.lineIndex,
        effectType: e.effectType
    }));
} else {
    effectsDraft = [];
}

// ===== èƒŒæ™¯é…ç½®ï¼šä¼˜å…ˆç”¨ backgroundDraftï¼Œè‹¥æœªå®šä¹‰å† fallback åˆ° backgroundPublished =====
// ===== èƒŒæ™¯é…ç½®ï¼šä¼˜å…ˆç”¨ backgroundDraftï¼Œè‹¥æœªå®šä¹‰å† fallback åˆ° backgroundPublished =====
function pickBackgroundConfig(work) {
  if (work.backgroundDraft && typeof work.backgroundDraft === 'object') {
    return work.backgroundDraft;
  }
  if (work.backgroundPublished && typeof work.backgroundPublished === 'object') {
    return work.backgroundPublished;
  }
  return { images: [], bindings: [], transitions: [] };
}

const bgCfg = pickBackgroundConfig(work);

// ---------- æŠŠæ¥å£é‡Œçš„ backgroundXXX æ˜ å°„æˆå‰ç«¯å†…éƒ¨ä½¿ç”¨çš„ç»“æ„ ----------
// å†…éƒ¨çº¦å®šï¼š
//   bgImages:     [{ id, name, url }]
//   bgBindings:   [{ imageId, imageName, startLine, endLine }]
//   bgTransitions:[{ fromLine, toLine, effectType }]

// 1ï¼‰å›¾ç‰‡åˆ—è¡¨
if (Array.isArray(bgCfg.images) && bgCfg.images.length > 0) {
  bgImages = bgCfg.images.map(function (img, idx) {
    // å…¼å®¹è€æ•°æ®ï¼šå¯èƒ½åªæœ‰ name+urlï¼Œæˆ–è€…åªæœ‰ imageId
    var id = img.id || img.imageId;
    if (!id) {
      // è€æ•°æ®å®Œå…¨æ²¡æœ‰ idï¼Œå°±æŒ‰é¡ºåºè¡¥ä¸€ä¸ª
      id = 'bg-' + String(idx + 1);
    }
    return {
      id: id,
      // é¡ºæ‰‹æŠŠ imageId ä¹Ÿå¸¦ä¸€ä»½ï¼Œæ–¹ä¾¿è°ƒè¯•
      imageId: id,
      name: img.name || img.imageName || '',
      url: img.url || ''
    };
  });

  // æ ¹æ®å·²æœ‰ id è®¡ç®—ä¸‹ä¸€ä¸ªè‡ªå¢å€¼ï¼šbgImageAutoId
  var maxNum = 0;
  bgImages.forEach(function (img) {
    var m = String(img.id).match(/^bg-(\d+)$/);
    if (m) {
      var n = parseInt(m[1], 10);
      if (n > maxNum) maxNum = n;
    }
  });
  bgImageAutoId = maxNum + 1;

  // é»˜è®¤é€‰ä¸­ç¬¬ä¸€å¼ ï¼Œæ–¹ä¾¿åé¢ç»‘å®š
  currentBgImageId = bgImages[0] ? bgImages[0].id : null;
} else {
  bgImages = [];
  bgImageAutoId = 1;
  currentBgImageId = null;
}

// 2ï¼‰ç»‘å®šåŒºé—´
bgBindings = Array.isArray(bgCfg.bindings)
  ? bgCfg.bindings.map(function (b) {
      return {
        imageId: b.imageId,
        imageName: b.imageName || '',
        startLine: Number(b.startLine),
        endLine: Number(b.endLine),
      };
    })
  : [];

// 3ï¼‰è½¬åœºç‰¹æ•ˆ
bgTransitions = Array.isArray(bgCfg.transitions)
  ? bgCfg.transitions.map(function (t) {
      return {
        fromLine: Number(t.fromLine),
        toLine: Number(t.toLine),
        effectType: t.effectType || 'crossfade',
      };
    })
  : [];

// 4ï¼‰æŠŠæ•°æ®å›å¡«åˆ°å³ä¾§èƒŒæ™¯é¢æ¿
renderBgImageList();
renderBgBindingList();
renderBgTransitionList();


        // åˆå¹¶æ‰€æœ‰é¡µé¢æ–‡æœ¬
        const pages = Array.isArray(work.content) ? work.content : [];
        let fullText = '';
        pages.forEach((p, idx) => {
          const t = deltaToPlainText(p.content || {});
          if (idx > 0) fullText += '\n';       // é¡µé¢ä¹‹é—´ä¹Ÿæ¢ä¸€è¡Œ
          fullText += t;
        });

        currentLines = fullText.split(/\r?\n/);

        renderLineList();
        updateDebugJson();

        listPage.classList.add('hidden');
        customEffectPage.classList.add('hidden');  // â­ æ–°å¢
        editorPage.classList.remove('hidden');
      }

      backBtn.addEventListener('click', () => {
        editorPage.classList.add('hidden');
        listPage.classList.remove('hidden');
        currentWorkId = null;
        currentLines = [];
        effectsDraft = [];
        selectedLineIndex = null;
        isPreviewing = false;
        lineListEl.innerHTML = '';
        selectedLineLabel.textContent = 'æ— ';
        previewBtn.textContent = 'é¢„è§ˆç‰¹æ•ˆ';
      });

      /* ---------- è¡Œåˆ—è¡¨ / é€‰ä¸­è¡Œ / è®¾ç½®ç‰¹æ•ˆ ---------- */

      function bgEffectLabel(type) {
  switch (type) {
    case 'crossfade': return 'äº¤å‰æ·¡å…¥æ·¡å‡º';
    case 'matrix':    return 'çŸ©é˜µ';
    case 'ink':       return 'å¢¨æŸ“';
    default:          return type || 'èƒŒæ™¯å˜åŒ–';
  }
}

function renderLineList() {
  lineListEl.innerHTML = '';

  if (!currentLines || currentLines.length === 0) {
    lineListEl.innerHTML = '<li>æš‚æ— å†…å®¹ï¼Œè¯·å…ˆåœ¨åˆ›ä½œç«¯å†™ä½œã€‚</li>';
    return;
  }

  rawToEffectiveIndex = [];
  let effIndexCounter = 0;

  currentLines.forEach((line, rawIdx) => {
    const trimmed = line.replace(/\r?\n$/, '');
    let effIndex = null;
    if (trimmed.trim()) {
      effIndex = effIndexCounter++;
    }
    rawToEffectiveIndex[rawIdx] = effIndex;

    const li = document.createElement('li');
    li.className = 'effect-line-item';
    li.dataset.index = String(rawIdx);
    if (effIndex != null) li.dataset.effIndex = String(effIndex);

    const displayNum  = effIndex != null ? (effIndex + 1) : '-';
    const displayText = trimmed ? trimmed : 'ï¼ˆç©ºè¡Œï¼‰';

    const tags = [];

    // æ–‡å­—ç‰¹æ•ˆ tag
    if (effIndex != null) {
      const tag = effectsDraft.find(e => e.lineIndex === effIndex);
      if (tag) {
        tags.push(`<span class="effect-tag">${escapeHtml(effectTypeLabel(tag.effectType))}</span>`);
      }

      // èƒŒæ™¯èµ·å§‹ / ç»“æŸ tag
      const bindingsForLine = bgBindings.filter(
        b => b.startLine === effIndex || b.endLine === effIndex
      );
      bindingsForLine.forEach(b => {
        const isStart = b.startLine === effIndex;
        const label = (isStart ? 'èµ·å§‹' : 'ç»“æŸ') + `ï¼šã€${escapeHtml(b.imageName)}ã€‘`;
        tags.push(
          `<span class="bg-tag ${isStart ? 'bg-tag-start' : 'bg-tag-end'}">${label}</span>`
        );
      });
    }

    const tagsHtml = tags.join(' ');

    li.innerHTML = `
      <span class="effect-line-num">${displayNum}</span>
      <span class="effect-line-text">${escapeHtml(displayText)}</span>
      <span class="effect-line-tags">${tagsHtml}</span>
    `;
    lineListEl.appendChild(li);

    // åœ¨è¿™ä¸€è¡Œåé¢æ’å…¥èƒŒæ™¯è½¬åœºè¡Œï¼ˆfromLine = å½“å‰å¥ï¼‰
    if (effIndex != null) {
      const transitions = bgTransitions.filter(t => t.fromLine === effIndex);
      transitions.forEach(t => {
        const trLi = document.createElement('li');
        trLi.className = 'bg-transition-item';
        trLi.dataset.from = String(t.fromLine);
        trLi.dataset.to   = String(t.toLine);
        trLi.textContent  = `ã€${bgEffectLabel(t.effectType)}ã€‘`;
        lineListEl.appendChild(trLi);
      });
    }
  });

  // æ–‡å­—æ¨¡å¼ä¸‹ï¼Œé‡æ–°é«˜äº®å½“å‰è¡Œ
  if (currentEffectMode === 'text' && selectedLineIndex != null) {
    document.querySelectorAll('.effect-line-item').forEach(li => {
      li.classList.remove('selected');
      if (String(selectedLineIndex) === li.dataset.effIndex) {
        li.classList.add('selected');
      }
    });
  }
}


      function setEditorMode(mode) {
  currentEffectMode = mode === 'background' ? 'background' : 'text';

  if (currentEffectMode === 'text') {
    effectToolbarTipPrefix.textContent = 'å½“å‰é€‰ä¸­è¡Œï¼š';
    selectedLineLabel.textContent = selectedLineIndex == null
      ? 'æ— '
      : `ç¬¬ ${selectedLineIndex + 1} å¥ï¼ˆæŒ‰é˜…è¯»ç«¯è®¡æ•°ï¼‰`;

    effectInsertLabel.textContent = 'æ’å…¥ç‰¹æ•ˆï¼š';
    textEffectGroup.classList.remove('hidden');
    bgEffectGroup.classList.add('hidden');
    bgPanel.classList.add('hidden');

  } else {
    // èƒŒæ™¯æ¨¡å¼ï¼šæç¤ºè¡Œå®Œå…¨ç”± selectedLineLabel æ–‡æœ¬è´Ÿè´£
    effectToolbarTipPrefix.textContent = '';
    selectedLineLabel.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªèƒŒæ™¯å›¾ç‰‡';

    effectInsertLabel.textContent = 'æ’å…¥èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆï¼š';
    textEffectGroup.classList.add('hidden');
    bgEffectGroup.classList.remove('hidden');
    bgPanel.classList.remove('hidden');

    // è¿›å…¥èƒŒæ™¯æ¨¡å¼æ—¶ä¸å†å¼ºè°ƒâ€œå½“å‰é€‰ä¸­è¡Œâ€
    selectedLineIndex = null;
    document.querySelectorAll('.effect-line-item.selected')
      .forEach(li => li.classList.remove('selected'));
  }
}

      // æŠŠ File å¯¹è±¡è½¬æˆ base64 çº¯æ•°æ®ï¼ˆä¸å¸¦ data:image/... å‰ç¼€ï¼‰
function fileToBase64Data(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const result = e.target.result; // data:image/png;base64,xxxx
      const parts = String(result).split(',');
      if (parts.length < 2) {
        return reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œbase64 æ ¼å¼ä¸æ­£ç¡®'));
      }
      resolve(parts[1]); // åªè¦é€—å·åé¢çš„ base64 éƒ¨åˆ†
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

      // â­ ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡åˆ°è‡ªå·±æœåŠ¡å™¨çš„ /api/works/uploadï¼Œè¿”å› { url, name }
async function uploadBgImageToServer(file, name) {
  // 1ï¸âƒ£ ç»„è£… FormData
  const formData = new FormData();
  formData.append('image', file);

  // 2ï¸âƒ£ å‘é€åˆ°åç«¯
  const res = await fetch(WORK_UPLOAD_URL, {
    method: 'POST',
    // è¿™ä¸ªæ¥å£ç›®å‰ä¸æ ¡éªŒç™»å½•çš„è¯ï¼Œå¯ä»¥ä¸å¸¦å¤´ï¼›å¸¦ä¸Š Authorization ä¹Ÿæ²¡å…³ç³»ï¼š
    // headers: authHeaders(false),
    body: formData,
  });

  const data = await res.json().catch(function () { return {}; });

  if (!res.ok) {
    throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
  }

  if (!data.imageUrl) {
    throw new Error('æœåŠ¡å™¨æœªè¿”å› imageUrl');
  }

  // ä¸ºäº†å’Œä¹‹å‰ä»£ç ä¸€è‡´ï¼Œè¿™é‡Œä¹Ÿè¿”å› { url, name }
  return {
    url: data.imageUrl,        // ä¾‹å¦‚ https://api.anchorx.ca/uploads/image-1759....jpg
    name: name || '',
  };
}

      
// â­ ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡åˆ° imgbbï¼Œè¿”å› { url, name } å·²ç»èˆå¼ƒï¼ï¼ï¼
async function uploadBgImageToImgbb(file, name) {
  if (!IMGBB_API_KEY || IMGBB_API_KEY === 'åœ¨ imgBB åå°å¤åˆ¶æ¥çš„å®Œæ•´ API Key') {
    throw new Error('å°šæœªé…ç½® IMGBB_API_KEY');
  }

  // 1ï¸âƒ£ è¯»å–æˆ base64
  const base64Data = await fileToBase64Data(file);

  // 2ï¸âƒ£ å‘é€åˆ° imgbb
  const formData = new FormData();
  formData.append('image', base64Data);
  if (name) {
    formData.append('name', name);
  }

  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
    method: 'POST',
    body: formData,
  });

  const data = await res.json();
  if (!res.ok || !data || !data.success) {
    console.error('imgbb ä¸Šä¼ å¤±è´¥:', data);
    throw new Error('ä¸Šä¼ åˆ°å›¾åºŠå¤±è´¥');
  }

  const d = data.data;
  const url = d.display_url || d.url;
  const finalName = name || d.title || 'èƒŒæ™¯å›¾ç‰‡';

  if (!url) {
    throw new Error('å›¾åºŠæœªè¿”å›æœ‰æ•ˆå›¾ç‰‡é“¾æ¥');
  }

  return { url, name: finalName };
}

            /* ---------- è‡ªå®šä¹‰ç‰¹æ•ˆï¼šä¸åç«¯äº¤äº’ ---------- */

      async function fetchCustomEffects() {
        try {
          const res = await fetch(EFFECT_API_BASE_URL, {
            headers: authHeaders(false),
          });
          if (res.status === 401) {
            alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è‡ªå®šä¹‰ç‰¹æ•ˆåŠŸèƒ½');
            return [];
          }
          const j = await res.json().catch(() => []);
          if (!res.ok) {
            alert('è·å–è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥ï¼š' + (j.message || res.status));
            return [];
          }
          customEffects = Array.isArray(j) ? j : [];
          return customEffects;
        } catch (e) {
          console.error(e);
          alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è‡ªå®šä¹‰ç‰¹æ•ˆ');
          return [];
        }
      }

            async function fetchCustomEffects() {
        try {
          const res = await fetch(EFFECT_API_BASE_URL, {
            headers: authHeaders(false),
          });
          if (res.status === 401) {
            alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è‡ªå®šä¹‰ç‰¹æ•ˆåŠŸèƒ½');
            return [];
          }
          const j = await res.json().catch(() => []);
          if (!res.ok) {
            alert('è·å–è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥ï¼š' + (j.message || res.status));
            return [];
          }
          customEffects = Array.isArray(j) ? j : [];
          return customEffects;
        } catch (e) {
          console.error(e);
          alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è‡ªå®šä¹‰ç‰¹æ•ˆ');
          return [];
        }
      }

      function renderCustomEffectManageList() {
        // ... ä½ çš„åŸä»£ç  ...
      }

      // â­ æ–°å¢ï¼šæ ¹æ® key åœ¨å½“å‰ customEffects é‡Œæ‰¾åˆ°ä»£ç å¹¶æ‰§è¡Œ applyEffect
      function runCustomEffectOnElement(effectKey, targetEl) {
        if (!effectKey || !targetEl) return;
        const effect = customEffects.find(e => e.key === effectKey);
        if (!effect || !effect.code) return;

        try {
          const wrapped = new Function(
            'targetEl',
            effect.code + `
              if (typeof applyEffect === 'function') {
                applyEffect(targetEl);
              }
            `
          );
          wrapped(targetEl);
        } catch (err) {
          console.error('è‡ªå®šä¹‰ç‰¹æ•ˆæ‰§è¡Œå¤±è´¥:', err);
        }
      }


      function renderCustomEffectManageList() {
        customEffectListEl.innerHTML = '';

        if (!customEffects.length) {
          customEffectEmptyTip.style.display = 'block';
          return;
        }
        customEffectEmptyTip.style.display = 'none';

        customEffects.forEach(effect => {
          const li = document.createElement('li');
          li.className = 'custom-effect-item' + (effect._id === currentCustomEffectId ? ' active' : '');
          li.dataset.id = effect._id;
          li.innerHTML = `
            <span class="custom-effect-name">${escapeHtml(effect.name || '(æœªå‘½åç‰¹æ•ˆ)')}</span>
            <span class="custom-effect-meta">${escapeHtml(effect.key || '')}</span>
          `;
          customEffectListEl.appendChild(li);
        });
      }

      function resetCustomEffectEditorToEmpty() {
  currentCustomEffectId = null;
  customEffectNameInput.value = '';
  customEffectKeyInput.value = '';
  customEffectCodeInput.value = '';
  customEffectEditorTitle.textContent = 'è¯·é€‰æ‹©å·¦ä¾§ç‰¹æ•ˆï¼Œæˆ–ç‚¹å‡»â€œæ–°å»ºè‡ªå®šä¹‰ç‰¹æ•ˆâ€';

  // â­ é»˜è®¤éšè—å³ä¾§ç¼–è¾‘å™¨
  if (customEffectEditorPanel) {
    customEffectEditorPanel.classList.add('hidden');
  }
}


      async function openCustomEffectPage() {
        listPage.classList.add('hidden');
        editorPage.classList.add('hidden');
        customEffectPage.classList.remove('hidden');

        resetCustomEffectEditorToEmpty();
        await fetchCustomEffects();
        renderCustomEffectManageList();
      }

      /* ---------- è‡ªå®šä¹‰ç‰¹æ•ˆç®¡ç†é¡µï¼šäº‹ä»¶ç»‘å®š ---------- */

      if (customEffectManageBtn) {
        customEffectManageBtn.addEventListener('click', () => {
          openCustomEffectPage();
        });
      }

      if (customEffectBackBtn) {
        customEffectBackBtn.addEventListener('click', () => {
          customEffectPage.classList.add('hidden');
          editorPage.classList.add('hidden');
          listPage.classList.remove('hidden');
        });
      }

      if (customEffectNewBtn) {
  customEffectNewBtn.addEventListener('click', () => {
    currentCustomEffectId = null;
    customEffectNameInput.value = '';
    customEffectKeyInput.value = '';
    customEffectCodeInput.value = DEFAULT_SAMPLE_CODE;
    customEffectEditorTitle.textContent = 'æ–°å»ºè‡ªå®šä¹‰ç‰¹æ•ˆ';

    // â­ æ˜¾ç¤ºç¼–è¾‘å™¨
    if (customEffectEditorPanel) {
      customEffectEditorPanel.classList.remove('hidden');
    }

    renderCustomEffectManageList();
  });
}


      customEffectListEl.addEventListener('click', (e) => {
  const item = e.target.closest('.custom-effect-item');
  if (!item) return;

  const id = item.dataset.id;
  const effect = customEffects.find(x => x._id === id);
  if (!effect) return;

  currentCustomEffectId = id;
  customEffectNameInput.value = effect.name || '';
  customEffectKeyInput.value = effect.key || '';
  customEffectCodeInput.value = effect.code || '';
  customEffectEditorTitle.textContent = 'æ­£åœ¨ç¼–è¾‘ï¼š' + (effect.name || '(æœªå‘½åç‰¹æ•ˆ)');

  // â­ æ˜¾ç¤ºç¼–è¾‘å™¨
  if (customEffectEditorPanel) {
    customEffectEditorPanel.classList.remove('hidden');
  }

  renderCustomEffectManageList();
});


      if (customEffectSaveBtn) {
        customEffectSaveBtn.addEventListener('click', async () => {
          const name = customEffectNameInput.value.trim();
          const key = customEffectKeyInput.value.trim();
          const code = customEffectCodeInput.value;

          if (!name || !key || !code.trim()) {
            alert('åç§°ã€key å’Œä»£ç éƒ½ä¸èƒ½ä¸ºç©º');
            return;
          }

          const payload = { name, key, code };

          try {
            let res;
            if (currentCustomEffectId) {
              res = await fetch(`${EFFECT_API_BASE_URL}/${currentCustomEffectId}`, {
                method: 'PATCH',
                headers: authHeaders(true),
                body: JSON.stringify(payload),
              });
            } else {
              res = await fetch(EFFECT_API_BASE_URL, {
                method: 'POST',
                headers: authHeaders(true),
                body: JSON.stringify(payload),
              });
            }

            const j = await res.json().catch(() => ({}));
            if (!res.ok) {
              alert('ä¿å­˜è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥ï¼š' + (j.message || res.status));
              return;
            }

            alert('è‡ªå®šä¹‰ç‰¹æ•ˆå·²ä¿å­˜ï¼');

            // æ›´æ–°å½“å‰ idï¼ˆæ–°å»ºæ—¶è¿”å›çš„ _idï¼‰
            if (j && j._id) {
              currentCustomEffectId = j._id;
            }

            await fetchCustomEffects();
            renderCustomEffectManageList();
          } catch (err) {
            console.error(err);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
          }
        });
      }

      if (customEffectDeleteBtn) {
        customEffectDeleteBtn.addEventListener('click', async () => {
          if (!currentCustomEffectId) {
            alert('è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„è‡ªå®šä¹‰ç‰¹æ•ˆ');
            return;
          }
          if (!confirm('ç¡®å®šåˆ é™¤å½“å‰è‡ªå®šä¹‰ç‰¹æ•ˆï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

          try {
            const res = await fetch(`${EFFECT_API_BASE_URL}/${currentCustomEffectId}`, {
              method: 'DELETE',
              headers: authHeaders(false),
            });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) {
              alert('åˆ é™¤å¤±è´¥ï¼š' + (j.message || res.status));
              return;
            }

            alert('è‡ªå®šä¹‰ç‰¹æ•ˆå·²åˆ é™¤');
            resetCustomEffectEditorToEmpty();
            await fetchCustomEffects();
            renderCustomEffectManageList();
          } catch (err) {
            console.error(err);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
          }
        });
      }

      /* ---------- ç¼–è¾‘å™¨é¡¶éƒ¨ï¼šå±•å¼€è‡ªå®šä¹‰ç‰¹æ•ˆä¸‹æ‹‰ ---------- */

      function renderCustomEffectDropdownList() {
        customEffectDropdownList.innerHTML = '';

        if (!customEffects.length) {
          const li = document.createElement('li');
          li.innerHTML = '<span style="font-size:0.8rem;color:#999;">æš‚æ— è‡ªå®šä¹‰ç‰¹æ•ˆï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹â€œç®¡ç†è‡ªå®šä¹‰ç‰¹æ•ˆâ€æ–°å»ºã€‚</span>';
          customEffectDropdownList.appendChild(li);
          return;
        }

        customEffects.forEach(effect => {
          const li = document.createElement('li');
          li.innerHTML = `
            <button type="button" data-effect-key="${effect.key}">
              ${escapeHtml(effect.name || '(æœªå‘½åç‰¹æ•ˆ)')} (${escapeHtml(effect.key)})
            </button>
          `;
          customEffectDropdownList.appendChild(li);
        });
      }

      if (customEffectToggleBtn) {
        customEffectToggleBtn.addEventListener('click', async () => {
          const isHidden = customEffectDropdownPanel.classList.contains('hidden');
          if (isHidden) {
            await fetchCustomEffects();
            renderCustomEffectDropdownList();
            customEffectDropdownPanel.classList.remove('hidden');
          } else {
            customEffectDropdownPanel.classList.add('hidden');
          }
        });
      }

      if (customEffectDropdownClose) {
        customEffectDropdownClose.addEventListener('click', () => {
          customEffectDropdownPanel.classList.add('hidden');
        });
      }

      customEffectDropdownList.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-effect-key]');
        if (!btn) return;

        if (selectedLineIndex == null) {
          alert('è¯·å…ˆç‚¹å‡»å·¦ä¾§æŸä¸€è¡Œï¼Œå†åº”ç”¨è‡ªå®šä¹‰ç‰¹æ•ˆ');
          return;
        }

        const key = btn.dataset.effectKey;
        if (!key) return;

        // â­ çº¦å®šï¼šè‡ªå®šä¹‰ç‰¹æ•ˆåœ¨ effectsDraft ä¸­çš„æ ‡è®°æ–¹å¼
        const effectType = 'custom:' + key;

        setEffectForLine(selectedLineIndex, effectType);
      });

      if (customEffectOpenManageBtn) {
        customEffectOpenManageBtn.addEventListener('click', () => {
          customEffectDropdownPanel.classList.add('hidden');
          openCustomEffectPage();
        });
      }

      
      function escapeHtml(str) {
        return str.replace(/[&<>"']/g, s => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[s]));
      }

            function effectTypeLabel(type) {
        if (!type) return '';

        // â­ æ–°å¢ï¼šcustom:xxx ç±»å‹çš„æ˜¾ç¤º
        if (typeof type === 'string' && type.startsWith('custom:')) {
          const key = type.slice('custom:'.length) || '';
          return 'è‡ªå®šä¹‰ï¼š' + key;
        }

        switch (type) {
          case 'shake': return 'éœ‡åŠ¨';
          case 'flash': return 'é—ªçƒ';
          case 'fade': return 'æ·¡å…¥';
          case 'highlight': return 'é«˜äº®';
          default: return type;
        }
      }


            lineListEl.addEventListener('click', e => {
  const item = e.target.closest('.effect-line-item');
  if (!item) return;

  const effStr = item.dataset.effIndex;
  if (!effStr && effStr !== '0') {
    alert('è¯¥è¡Œä¸ºç©ºè¡Œæˆ–ä¸å¯è®¾ç½®ç‰¹æ•ˆ');
    return;
  }
  const effIdx = Number(effStr);
  if (Number.isNaN(effIdx)) return;

  if (currentEffectMode === 'text') {
    // ===== æ–‡å­—ç‰¹æ•ˆæ¨¡å¼ï¼šä¿ç•™åŸæ¥çš„è¡Œä¸º =====
    selectedLineIndex = effIdx;

    document.querySelectorAll('.effect-line-item').forEach(li => {
      li.classList.remove('selected');
    });
    item.classList.add('selected');

    selectedLineLabel.textContent = `ç¬¬ ${effIdx + 1} å¥ï¼ˆæŒ‰é˜…è¯»ç«¯è®¡æ•°ï¼‰`;
    return;
  }

  // ===== èƒŒæ™¯ç‰¹æ•ˆæ¨¡å¼ =====
  // èƒŒæ™¯æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ selectedLineIndex é«˜äº®ï¼Œç”¨æç¤ºè¡Œ + èµ·å§‹/ç»“æŸ tag
  document.querySelectorAll('.effect-line-item').forEach(li => {
    li.classList.remove('selected');
  });
  item.classList.add('selected');

  if (bgSelectionPhase === 'chooseStart') {
    // é€‰æ‹©èµ·å§‹å¥
    bgTempStartLine = effIdx;
    bgSelectionPhase = 'chooseEnd';
    selectedLineLabel.textContent = `è¯·é€‰ä¸­èƒŒæ™¯ç»“æŸåº”ç”¨çš„å¥å­ï¼ˆå½“å‰èµ·å§‹ï¼šç¬¬ ${effIdx + 1} å¥ï¼‰`;
    return;
  }

  if (bgSelectionPhase === 'chooseEnd') {
    // é€‰æ‹©ç»“æŸå¥
    if (bgTempStartLine == null || currentBgImageId == null) {
      alert('è¯·é€‰æ‹©èƒŒæ™¯å›¾ç‰‡ï¼Œå¹¶é‡æ–°é€‰æ‹©èµ·å§‹å¥ã€‚');
      resetBgSelectionState();
      return;
    }
    if (effIdx < bgTempStartLine) {
      alert('ç»“æŸå¥å¿…é¡»åœ¨èµ·å§‹å¥ä¹‹åã€‚');
      return;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰èƒŒæ™¯åŒºé—´é‡å 
    const newStart = bgTempStartLine;
    const newEnd   = effIdx;
    const overlap = bgBindings.some(b =>
      !(newEnd < b.startLine || newStart > b.endLine)
    );
    if (overlap) {
      alert('èµ·å§‹å¥å’Œç»“æŸå¥ä¹‹é—´å·²ç»æœ‰å…¶å®ƒèƒŒæ™¯åŒºé—´ï¼Œä¸èƒ½å åŠ è®¾ç½®ã€‚');
      return;
    }

    bgBindings.push({
      imageId:   currentBgImageId,
      imageName: currentBgImageName,
      startLine: newStart,
      endLine:   newEnd,
    });

    renderLineList();
    updateDebugJson();
    resetBgSelectionState();
    return;
  }

  if (bgSelectionPhase === 'chooseTransitionEnd') {
    // é€‰æ‹©â€œç»“æŸå¥â€ï¼ˆä¸Šä¸€æ®µèƒŒæ™¯çš„ç»“æŸå¥ï¼‰
    const bindAsEnd = bgBindings.find(b => b.endLine === effIdx);
    if (!bindAsEnd) {
      alert('è¿™ä¸€å¥è¿˜æ²¡æœ‰ä½œä¸ºèƒŒæ™¯çš„ç»“æŸå¥ï¼Œè¯·å…ˆå®ŒæˆèƒŒæ™¯åŒºé—´è®¾ç½®ã€‚');
      return;
    }

    // æ‰¾â€œä¸‹ä¸€å¥â€æœ‰æ–°çš„èµ·å§‹å¥ï¼ˆå¿½ç•¥ç©ºè¡Œ â†’ æˆ‘ä»¬ç”¨ startLine > endLine æ¥æ‰¾ï¼‰
    const nextBinding = bgBindings
      .filter(b => b.startLine > effIdx)
      .sort((a, b) => a.startLine - b.startLine)[0];

    if (!nextBinding) {
      alert('è¯·å…ˆæŠŠä¸‹ä¸€ä¸ªéç©ºè¡Œè®¾ç½®å‡ºèƒŒæ™¯ï¼Œç„¶åå†è®¾ç½®èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆã€‚');
      return;
    }

    bgTransitions.push({
      fromLine: effIdx,
      toLine:   nextBinding.startLine,
      effectType: currentTransitionEffectType || 'crossfade',
    });

    renderLineList();
    updateDebugJson();
    resetBgSelectionState();
    return;
  }

  // å…¶å®ƒæƒ…å†µï¼šæ¯”å¦‚ idle
  if (bgImages.length === 0) {
    selectedLineLabel.textContent = 'è¯·å…ˆåœ¨å³ä¾§ä¸Šä¼ ä¸€å¼ èƒŒæ™¯å›¾ç‰‡';
  } else {
    selectedLineLabel.textContent = 'è¯·å…ˆåœ¨å³ä¾§é€‰æ‹©ä¸€å¼ èƒŒæ™¯å›¾ç‰‡';
  }
});

function resetBgSelectionState() {
  bgSelectionPhase = 'idle';
  currentBgImageId = null;
  currentBgImageName = '';
  bgTempStartLine = null;
  currentTransitionEffectType = null;

  document.querySelectorAll('.bg-image-item').forEach(li => {
    li.classList.remove('active');
  });
  document.querySelectorAll('.effect-line-item').forEach(li => {
    li.classList.remove('selected');
  });

  if (currentEffectMode === 'background') {
    selectedLineLabel.textContent = bgImages.length
      ? 'è¯·é€‰æ‹©ä¸€ä¸ªèƒŒæ™¯å›¾ç‰‡'
      : 'è¯·å…ˆä¸Šä¼ ä¸€å¼ èƒŒæ™¯å›¾ç‰‡';
  }
}

function renderBgImageList() {
  bgImageListEl.innerHTML = '';

  if (!bgImages.length) {
    bgImageListEl.innerHTML = '<li class="bg-image-empty">æš‚æ— èƒŒæ™¯å›¾ç‰‡ï¼Œè¯·å…ˆæœ¬åœ°ä¸Šä¼ ã€‚</li>';
    return;
  }

  bgImages.forEach(img => {
    const li = document.createElement('li');
    li.className = 'bg-image-item';
    li.dataset.id = img.id;

    if (img.id === currentBgImageId) {
      li.classList.add('active');
    }

    li.innerHTML = `
      <img class="bg-image-thumb" src="${img.url}" alt="${escapeHtml(img.name)}">
      <span class="bg-image-name">${escapeHtml(img.name)}</span>
    `;
    bgImageListEl.appendChild(li);
  });
}

// æœ¬åœ°ä¸Šä¼ 
if (bgUploadLocalBtn && bgUploadInput) {
  bgUploadLocalBtn.addEventListener('click', () => {
    if (currentEffectMode !== 'background') {
      alert('è¯·å…ˆé€šè¿‡â€œç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆâ€è¿›å…¥èƒŒæ™¯æ¨¡å¼å†ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡ã€‚');
      return;
    }
    bgUploadInput.click();
  });

  bgUploadInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    // è®©ç”¨æˆ·ç»™è¿™å¼ èƒŒæ™¯èµ·ä¸ªåå­—
    let name = prompt(
      'è¯·ä¸ºè¯¥èƒŒæ™¯å›¾ç‰‡è®¾ç½®ä¸€ä¸ªåç§°ï¼š',
      file.name ? file.name.replace(/\.[^.]+$/, '') : ''
    );
    if (!name) {
      name = 'æœªå‘½åèƒŒæ™¯';
    }

        try {
      // UI æç¤ºï¼šæ­£åœ¨ä¸Šä¼ 
      selectedLineLabel.textContent = 'å›¾ç‰‡ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™...';

      // â­ æ”¹æˆä¸Šä¼ åˆ°è‡ªå·±æœåŠ¡å™¨ï¼Œæ‹¿åˆ° /uploads/... çš„ URL
      const result = await uploadBgImageToServer(file, name);
      const url = result.url;
      const finalName = result.name || name;

      // åœ¨æœ¬åœ°èƒŒæ™¯å›¾åº“ä¸­ç™»è®°ä¸€æ¡è®°å½•
      const id = 'bg-' + (bgImageAutoId++);
      bgImages.push({
        id: id,
        name: finalName,
        url: url,
      });

      // è®¾ä¸ºå½“å‰é€‰ä¸­çš„èƒŒæ™¯ï¼Œå¹¶è¿›å…¥ã€Œé€‰æ‹©èµ·å§‹å¥ã€é˜¶æ®µ
      currentBgImageId = id;
      currentBgImageName = finalName;
      bgSelectionPhase = 'chooseStart';

      // é‡æ–°æ¸²æŸ“å³ä¾§ã€ŒèƒŒæ™¯å›¾åº“ä¸Šä¼ ã€åˆ—è¡¨
      renderBgImageList();

      // æ›´æ–°æç¤ºè¡Œï¼šä¸‹ä¸€æ­¥è¯·é€‰èµ·å§‹å¥
      selectedLineLabel.textContent = 'è¯·é€‰ä¸­èƒŒæ™¯å¼€å§‹åº”ç”¨çš„å¥å­';

      // æ›´æ–°è°ƒè¯• JSON
      updateDebugJson();
    } catch (err) {
      console.error('ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡å¤±è´¥:', err);
      alert('ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯'));
      resetBgSelectionState();
    } finally {
      // æ¸…ç©º inputï¼Œæ–¹ä¾¿ä¸‹æ¬¡é€‰åŒä¸€å¼ å›¾
      bgUploadInput.value = '';
    }
  });
}

// åˆ—è¡¨é€‰æ‹©å›¾ç‰‡
if (bgImageListEl) {
  bgImageListEl.addEventListener('click', e => {
    const item = e.target.closest('.bg-image-item');
    if (!item) return;

    const id = item.dataset.id;
    const img = bgImages.find(x => x.id === id);
    if (!img) return;

    currentBgImageId = img.id;
    currentBgImageName = img.name;
    bgSelectionPhase = 'chooseStart';

    document.querySelectorAll('.bg-image-item').forEach(li => {
      li.classList.remove('active');
    });
    item.classList.add('active');

    selectedLineLabel.textContent = 'è¯·é€‰ä¸­èƒŒæ™¯å¼€å§‹åº”ç”¨çš„å¥å­';
  });
}

// ç§»é™¤å›¾ç‰‡
if (bgRemoveImageBtn) {
  bgRemoveImageBtn.addEventListener('click', () => {
    if (!currentBgImageId) {
      alert('è¯·å…ˆåœ¨ã€ŒèƒŒæ™¯å›¾åº“ä¸Šä¼ ã€ä¸­é€‰ä¸­è¦ç§»é™¤çš„å›¾ç‰‡ã€‚');
      return;
    }

    const img = bgImages.find(x => x.id === currentBgImageId);
    const name = img ? img.name : '';

    if (!confirm(`ç¡®å®šè¦åˆ é™¤èƒŒæ™¯ã€Œ${name || currentBgImageId}ã€å—ï¼Ÿ\nè¯¥èƒŒæ™¯ç»‘å®šçš„æ‰€æœ‰èƒŒæ™¯åŒºé—´å’Œè½¬åœºéƒ½ä¼šä¸€å¹¶ç§»é™¤ã€‚`)) {
      return;
    }

    // ç§»é™¤å›¾ç‰‡
    bgImages = bgImages.filter(x => x.id !== currentBgImageId);

    // ç§»é™¤ç»‘å®šå’Œè½¬åœº
    const validImageIds = new Set(bgImages.map(x => x.id));
    bgBindings = bgBindings.filter(b => validImageIds.has(b.imageId));
    bgTransitions = bgTransitions.filter(t => {
      // è½¬åœºæŒ‰å¥å­è¿æ¥ï¼Œè¿™é‡Œç®€å•ä¿ç•™ï¼›å¦‚æœå¯¹åº”èƒŒæ™¯å¥å­éƒ½æ²¡äº†ï¼Œä¹Ÿå¯ä»¥åç»­æ•´ä½“æ¸…ç†
      return true;
    });

    renderBgImageList();
    renderLineList();
    updateDebugJson();
    resetBgSelectionState();
  });
}

// å…±äº«å›¾åº“å ä½
if (bgAddFromSharedBtn) {
  bgAddFromSharedBtn.addEventListener('click', () => {
    alert('ã€Œä»å…±äº«å›¾åº“ä¸­æ·»åŠ ã€æš‚æ—¶å…ˆæç½®ï¼Œåç»­æ¥å¥½åå°æ¥å£åå†å¯ç”¨ã€‚');
  });
}


      // è®¾ç½®/æ¸…é™¤æŸä¸€è¡Œç‰¹æ•ˆ
      function setEffectForLine(lineIndex, effectType) {
        const existingIndex = effectsDraft.findIndex(e => e.lineIndex === lineIndex);
        if (!effectType) {
          if (existingIndex >= 0) effectsDraft.splice(existingIndex, 1);
        } else {
          if (existingIndex >= 0) {
            effectsDraft[existingIndex].effectType = effectType;
          } else {
            effectsDraft.push({ lineIndex, effectType });
          }
        }
        updateDebugJson();
        renderLineList();
      }

      document.querySelectorAll('.effect-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (currentEffectMode !== 'text') {
      alert('å½“å‰å¤„äºâ€œèƒŒæ™¯ç‰¹æ•ˆâ€æ¨¡å¼ï¼Œè¯·ç‚¹å‡»ä½œå“åˆ—è¡¨ä¸­çš„ã€Œç¼–è¾‘æ–‡å­—ç‰¹æ•ˆã€è¿›å…¥æ–‡å­—æ¨¡å¼åå†æ’å…¥æ–‡å­—ç‰¹æ•ˆã€‚');
      return;
    }
    if (selectedLineIndex == null) {
      alert('è¯·å…ˆç‚¹å‡»å·¦ä¾§æŸä¸€è¡Œå†æ’å…¥ç‰¹æ•ˆ');
      return;
    }
    const effectType = btn.dataset.effect;
    setEffectForLine(selectedLineIndex, effectType);
  });
});

      // èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆæŒ‰é’®
document.querySelectorAll('.effect-bg-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (currentEffectMode !== 'background') {
      alert('è¯·å…ˆé€šè¿‡ã€Œç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆã€è¿›å…¥èƒŒæ™¯æ¨¡å¼ã€‚');
      return;
    }
    if (!bgBindings.length) {
      alert('è¯·å…ˆä¸ºè‡³å°‘ä¸¤æ®µæ–‡å­—è®¾ç½®èƒŒæ™¯ï¼Œå†è®¾ç½®èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆã€‚');
      return;
    }

    currentTransitionEffectType = btn.dataset.bgEffect || 'crossfade';
    bgSelectionPhase = 'chooseTransitionEnd';
    selectedLineLabel.textContent = 'è¯·é€‰æ‹©å¯¹åº”ç»“æŸå¥ï¼ˆä¸Šä¸€æ®µèƒŒæ™¯çš„ç»“æŸè¡Œï¼‰';

    document.querySelectorAll('.effect-line-item').forEach(li => {
      li.classList.remove('selected');
    });
  });
});


      removeEffectBtn.addEventListener('click', () => {
        if (selectedLineIndex == null) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€è¡Œ');
          return;
        }
        setEffectForLine(selectedLineIndex, null);
      });

      /* ---------- é¢„è§ˆç‰¹æ•ˆ ---------- */

            function applyPreviewClasses() {
        document.querySelectorAll('.effect-line-item').forEach(li => {
          const textEl = li.querySelector('.effect-line-text');
          if (!textEl) return;

          // å…ˆæ¸…ç†å†…ç½®ç‰¹æ•ˆç”¨åˆ°çš„ class
          textEl.classList.remove('effect-shake', 'effect-flash', 'effect-fade', 'effect-highlight');

          const effStr = li.dataset.effIndex;
          if (!effStr && effStr !== '0') return; // ç©ºè¡Œ / æ— æ•ˆè¡Œ

          const effIdx = Number(effStr);
          if (Number.isNaN(effIdx)) return;

          const tag = effectsDraft.find(e => e.lineIndex === effIdx);
          if (!tag) return;

          const type = tag.effectType;

          // â­ æ–°å¢ï¼šè‡ªå®šä¹‰ç‰¹æ•ˆé¢„è§ˆï¼ˆeffectType å½¢å¦‚ custom:damieï¼‰
          if (typeof type === 'string' && type.startsWith('custom:')) {
            const key = type.slice('custom:'.length);
            if (key) {
              runCustomEffectOnElement(key, textEl);
            }
            // è‡ªå®šä¹‰ç‰¹æ•ˆä¸å†å¾€ä¸‹èµ° switch
            return;
          }

          // åŸæ¥çš„å†…ç½®ç‰¹æ•ˆé€»è¾‘
          switch (type) {
            case 'shake':     textEl.classList.add('effect-shake'); break;
            case 'flash':     textEl.classList.add('effect-flash'); break;
            case 'fade':      textEl.classList.add('effect-fade'); break;
            case 'highlight': textEl.classList.add('effect-highlight'); break;
          }
        });
      }


      function clearPreviewClasses() {
        document.querySelectorAll('.effect-line-text').forEach(el => {
          el.classList.remove('effect-shake', 'effect-flash', 'effect-fade', 'effect-highlight');
        });
      }

        previewBtn.addEventListener('click', async () => {
        isPreviewing = !isPreviewing;
        if (isPreviewing) {
          // â­ è¿›å…¥é¢„è§ˆæ—¶ï¼Œç¡®ä¿æ‹¿åˆ°æœ€æ–°çš„è‡ªå®šä¹‰ç‰¹æ•ˆåˆ—è¡¨
          await fetchCustomEffects();
          applyPreviewClasses();
          previewBtn.textContent = 'å…³é—­é¢„è§ˆ';
        } else {
          clearPreviewClasses();
          previewBtn.textContent = 'é¢„è§ˆç‰¹æ•ˆ';
        }
      });


      /* ---------- ä¿å­˜è‰ç¨¿ / å‘å¸ƒç‰¹æ•ˆ ---------- */
      function updateDebugJson() {
  const payload = {
    textEffects: effectsDraft,
    backgroundDraft: {
      images: bgImages,
      bindings: bgBindings,
      transitions: bgTransitions,
    },
  };
  debugJsonEl.textContent = JSON.stringify(payload, null, 2);
}



      // â­ ä¿®æ”¹åï¼šå‘å¸ƒæ—¶åŒæ—¶æ›´æ–° effectsDraft å’Œ effectsPublished
async function saveEffectsDraft(isPublish) {
  if (!currentWorkId) {
    alert('æœªé€‰æ‹©ä½œå“');
    return;
  }

  // â¬‡ï¸ è¿™é‡Œæ”¹æˆæ ¹æ® isPublish æ„é€ ä¸åŒçš„ payload
// ç»„è£…èƒŒæ™¯é…ç½®
// ç»„è£…èƒŒæ™¯é…ç½®ï¼ˆå¸¦ imageIdï¼‰
const backgroundPayload = {
  images: bgImages.map(function (img, idx) {
    var imageId = img.id;
    if (!imageId) {
      imageId = 'bg-' + String(idx);
    }
    return {
      imageId: imageId,           // â­ å…³é”®ï¼šæŠŠ id å†™è¿› imageId
      name: img.name || '',
      url: img.url || '',
    };
  }),
  bindings: bgBindings.map(function (b) {
    return {
      imageId: b.imageId,         // å’Œä¸Šé¢çš„ imageId å¯¹åº”
      imageName: b.imageName || '',
      startLine: Number(b.startLine),
      endLine: Number(b.endLine),
    };
  }),
  transitions: bgTransitions.map(function (t) {
    return {
      fromLine: Number(t.fromLine),
      toLine: Number(t.toLine),
      effectType: t.effectType || 'fade',
    };
  }),
};


const payload = isPublish
  ? {
      // å‘å¸ƒï¼šæ–‡å­— + èƒŒæ™¯ éƒ½åŒæ­¥è‰ç¨¿ & å·²å‘å¸ƒ
      effectsDraft: effectsDraft,
      effectsPublished: effectsDraft,
      backgroundDraft: backgroundPayload,
      backgroundPublished: backgroundPayload,
    }
  : {
      // åªä¿å­˜è‰ç¨¿ï¼šåªæ›´æ–°è‰ç¨¿
      effectsDraft: effectsDraft,
      backgroundDraft: backgroundPayload,
    };


  try {
    const res = await fetch(API_BASE_URL + '/' + currentWorkId, {
      method: 'PATCH',
      headers: authHeaders(true),
      body: JSON.stringify(payload),
    });

    const j = await res.json().catch(() => ({}));
    if (!res.ok) {
      alert((isPublish ? 'å‘å¸ƒ' : 'ä¿å­˜è‰ç¨¿') + 'å¤±è´¥ï¼š' + (j.message || res.status));
      return;
    }

    alert(
      isPublish
        ? 'ç‰¹æ•ˆå·²å‘å¸ƒï¼Œå¹¶å·²åŒæ­¥ä¿å­˜ä¸ºè‰ç¨¿ï¼'
        : 'è‰ç¨¿å·²ä¿å­˜ï¼'
    );

    // ğŸ”¥ è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œå›å¡« UI
    // è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œå›å¡« UIï¼ˆä¿æŒå½“å‰æ¨¡å¼ï¼‰
enterEffectEditor(currentWorkId, currentEffectMode);

// è‹¥åœ¨èƒŒæ™¯æ¨¡å¼ï¼Œé‡ç½®æç¤ºè¡Œ
if (currentEffectMode === 'background') {
  resetBgSelectionState();
}

  } catch (e) {
    console.error(e);
    alert((isPublish ? 'å‘å¸ƒ' : 'ä¿å­˜') + 'å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
  }
}


      saveDraftBtn.addEventListener('click', () => saveEffectsDraft(false));
      publishBtn.addEventListener('click', () => {
        if (!confirm('ç¡®å®šå‘å¸ƒå½“å‰ç‰¹æ•ˆé…ç½®ï¼Ÿ')) return;
        saveEffectsDraft(true);
      });

      /* ---------- åˆå§‹åŒ– ---------- */
      loadWorkList();
    });
  </script>