<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¸»é¢˜è¯¦æƒ… - ç½‘ç«™è®¨è®ºåŒº</title>
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
    <style>
        /* =================== */
        /* === é€šç”¨åŠå¸ƒå±€æ ·å¼ === */
        /* =================== */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px 0;
        }
        .topic-detail-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            text-decoration: none;
            color: #4d3129;
            font-weight: bold;
        }

        /* =================== */
        /* === ä¸»é¢˜å†…å®¹åŒºæ ·å¼ === */
        /* =================== */
        .topic-header {
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .topic-title {
            font-size: 2rem;
            color: #333;
            margin: 0 0 10px 0;
            word-break: break-word;
        }
        .topic-meta {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topic-author-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .meta-info {
            color: #999;
        }
        /* æ–°å¢ï¼šåˆ†åŒºæ ‡ç­¾æ ·å¼ */
        .topic-section-tag {
            background-color: #4d3129;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 15px;
            text-decoration: none; /* ç¡®ä¿å®ƒçœ‹èµ·æ¥åƒä¸ªæ ‡ç­¾ */
        }
        .topic-content {
            min-height: 200px;
            padding: 20px 0;
            line-height: 1.6;
            font-size: 1rem;
            overflow-wrap: break-word;
            word-wrap: break-word;
        }
        .topic-content .ql-editor {
            padding: 0;
        }

        /* æ–°å¢ï¼šç‚¹èµåŒºåŸŸæ ·å¼ */
        .topic-actions {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            border-top: 1px solid #eee;
            margin-top: 10px;
        }
        .like-button {
            padding: 10px 20px;
            background-color: #f7f9fc;
            border: 1px solid #ccc;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .like-button:hover:not(.liked) {
            background-color: #e6e9ed;
            border-color: #aaa;
        }
        .like-button.liked {
            background-color: #ff6b6b; /* ç‚¹èµåçš„é¢œè‰² */
            border-color: #ff6b6b;
            color: #fff;
        }
        .like-button span {
            margin-left: 8px;
            font-weight: bold;
        }
        .like-button.liked span {
             color: #fff; /* ç¡®ä¿ç‚¹èµæ•°åœ¨ç‚¹èµåä¹Ÿå˜ç™½ */
        }
        .like-button.liked:hover {
            background-color: #e65a5a; /* ç¨å¾®æ·±ä¸€ç‚¹ */
        }


        /* =================== */
        /* === å›å¤/è¯„è®ºåŒºæ ·å¼ (é‡ç‚¹ä¿®æ”¹ 2, 3) === */
        /* =================== */
        .reply-section-header {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4d3129;
            margin: 30px 0 15px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
        }

        .reply-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .reply-item {
            display: flex;
            padding: 15px 0;
            border-bottom: 1px dashed #eee;
        }
        .reply-item:last-child {
            border-bottom: none;
        }

        .reply-avatar {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ccc;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            font-size: 1.2rem;
        }
        .reply-body {
            flex-grow: 1;
        }
        .reply-user-meta {
            font-size: 0.9rem;
            color: #4d3129;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .reply-user-meta span {
            font-size: 0.8rem;
            font-weight: normal;
            color: #999;
            margin-left: 10px;
        }
        .reply-content {
            line-height: 1.5;
            word-break: break-word;
            margin-bottom: 10px;
        }
        .reply-actions {
            font-size: 0.8rem;
            color: #0077cc;
            cursor: pointer;
        }
        
        /* --- ä¿®æ­£é—®é¢˜ 2 å’Œ 3ï¼šå¼•ç”¨æ ·å¼å’Œæ¢è¡Œé—®é¢˜ --- */
        /* å¼ºåˆ¶å¼•ç”¨å—å†…çš„æ–‡æœ¬æ¢è¡Œ */
        .reply-content blockquote {
            border-left: 4px solid #ccc;
            margin: 10px 0;
            padding: 5px 15px;
            background-color: #f9f9f9;
            color: #666;
            font-style: italic;
            /* ä¿®æ­£æ¢è¡Œé—®é¢˜ */
            white-space: pre-wrap; /* ä¿æŒç©ºæ ¼å’Œæ¢è¡Œï¼Œå…è®¸æ¢è¡Œ */
            word-wrap: break-word;
        }
        /* Quill é»˜è®¤çš„ Blockquote æ ·å¼é€šå¸¸æ˜¯å¥½çš„ï¼Œè¿™é‡Œæ˜¯å¢å¼º */
        .ql-snow .ql-editor blockquote {
            margin-left: 0; /* ç§»é™¤é»˜è®¤çš„å·¦è¾¹è·ï¼Œä½¿ç”¨ padding */
        }
        /* Quill å›¾ç‰‡æ ·å¼ï¼ˆé˜²æ­¢æº¢å‡ºï¼‰ */
        .reply-content img {
            max-width: 100%;
            height: auto;
            display: block; /* ç¡®ä¿å›¾ç‰‡ç‹¬å ä¸€è¡Œ */
            margin: 10px 0;
        }
        /* --- å¼•å…¥åµŒå¥—å›å¤çš„æ ·å¼ (é—®é¢˜ 1) --- */
        /* æ ·å¼å°†ä¾èµ–äºåç«¯å¦‚ä½•ç»„ç»‡æ•°æ®ï¼Œè¿™é‡Œå…ˆå¢åŠ ä¸€ä¸ªç®€å•çš„è§†è§‰åŒºåˆ† */
        .nested-reply-list {
            border-left: 2px dashed #eee;
            padding-left: 15px;
            margin-top: 10px;
            margin-left: 15px; /* ç¨å¾®ç¼©è¿› */
        }
        .nested-reply-item {
            margin-top: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #f0f0f0;
            display: flex; /* ç¡®ä¿åµŒå¥—å›å¤å†…éƒ¨å¸ƒå±€æ­£å¸¸ */
        }
        .nested-reply-item:last-child {
            border-bottom: none;
        }

        /* =================== */
        /* === å›å¤ç¼–è¾‘å™¨æ ·å¼ === */
        /* (ä¿æŒä¸å˜) */
        /* =================== */
        .reply-editor-container {
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 30px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .reply-editor-header {
            background-color: #f7f9fc;
            padding: 10px 15px;
            font-size: 1rem;
            font-weight: bold;
            border-bottom: 1px solid #eee;
        }
        .ql-toolbar.ql-snow {
            border: none;
            border-bottom: 1px solid #eee;
        }
        .ql-container.ql-snow {
            border: none;
            min-height: 150px;
        }
        
        .reply-submit-area {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 15px;
            background-color: #fff;
            border-top: 1px solid #eee;
        }
        .submit-message {
            margin-right: auto;
            color: red;
            font-size: 0.9rem;
        }
        .submit-btn {
            padding: 8px 20px;
            background-color: #4d3129;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .submit-btn:hover:not(:disabled) {
            background-color: #6a493e;
        }
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ç§»åŠ¨é€‚é… (ä¿æŒä¸å˜) */
        @media (max-width: 600px) {
            .topic-detail-container {
                padding: 15px;
            }
            .topic-title {
                font-size: 1.5rem;
            }
            .topic-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            /* è°ƒæ•´ç§»åŠ¨ç«¯åˆ†åŒºæ ‡ç­¾ä½ç½® */
            .topic-section-tag {
                margin-bottom: 5px;
                margin-right: 0;
            }
            .topic-author-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            .reply-item {
                flex-direction: column;
            }
            .reply-avatar {
                margin-right: 0;
                margin-bottom: 10px;
                align-self: flex-start;
            }
            .reply-submit-area {
                flex-direction: column;
                gap: 10px;
            }
            .submit-message {
                margin-right: 0;
            }
        }

.user-status-badge {
    display: inline-flex;
    align-items: center;
    margin-left: 6px;
    padding: 0 8px;
    border-radius: 999px;
    font-size: 12px;
    line-height: 1.4;
    background-color: #f3f4f6;
    color: #6b7280;
}

.user-status-badge::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 999px;
    margin-right: 4px;
    background-color: #9ca3af;
}

/* åœ¨çº¿ï¼šç»¿è‰² */
.user-status-online {
    background-color: #e6f4ea;
    color: #15803d;
}
.user-status-online::before {
    background-color: #22c55e;
}

/* ä»Šå¤©æ´»è·ƒï¼šæ©™è‰² */
.user-status-recent {
    background-color: #fff7ed;
    color: #c2410c;
}
.user-status-recent::before {
    background-color: #fb923c;
}

/* ç¦»çº¿ï¼šç°è‰²ï¼ˆé»˜è®¤å·²ç»æ˜¯ç¦»çº¿é£æ ¼ï¼Œå¯ä»¥ä¸é¢å¤–å†™ï¼‰ */
.user-status-offline {
    background-color: #f3f4f6;
    color: #6b7280;
}
.user-status-offline::before {
    background-color: #9ca3af;
}

      /* é¡¶éƒ¨å¼•ç”¨æ¡ï¼ˆç±»ä¼¼ Discord â€œreplying to ...â€ï¼‰ */
.reply-parent-preview {
    font-size: 0.8rem;
    color: #555;
    background-color: #f3f4f6;
    border-radius: 4px;
    padding: 4px 8px;
    margin-bottom: 4px;
    border-left: 3px solid #d4d4d8;
}

.reply-parent-username {
    font-weight: bold;
    color: #4d3129;
}

.reply-parent-snippet {
    margin-left: 4px;
    color: #6b7280;
}

      .reply-avatar {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #ccc;
    margin-right: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #fff;
    font-size: 1.2rem;
    overflow: hidden;           /* âœ… æ–°å¢ï¼šè£æˆåœ†å½¢ */
}

.reply-avatar img {             /* âœ… æ–°å¢ï¼šå¤´åƒå›¾ç‰‡æ ·å¼ */
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

      
    </style>
</head>
<body>

<div class="topic-detail-container">
    <a href="https://zhidianworld.com/%e8%ae%a8%e8%ae%ba%e5%8c%ba/#topic-link-1" class="back-link">â† è¿”å›è®¨è®ºåŒºåˆ—è¡¨</a>
    <section class="topic-main">
        <div class="topic-header">
            <h1 class="topic-title" id="topicTitle"></h1>
            <div class="topic-meta">
                <div class="topic-author-info">
    <a href="#" class="topic-section-tag" id="topicSection">åˆ†åŒº</a>
    <div class="reply-avatar" id="topicAuthorAvatar" style="width:32px;height:32px;"></div>
    <span id="topicAuthor"></span>
    <span class="meta-info">åˆ›å»ºäº <span id="topicCreatedAt"></span></span>
</div>

                <div>
                    <span class="meta-info">ğŸ‘€ <span id="topicViews">0</span> æµè§ˆ</span>
                    <span class="meta-info">ğŸ’¬ <span id="topicRepliesCount">0</span> å›å¤</span>
                </div>
            </div>
        </div>

        
        <div class="topic-content" id="topicContent">
            <p>æ­£åœ¨åŠ è½½ä¸»é¢˜å†…å®¹...</p>
        </div>

        <div class="topic-actions">
            <button class="like-button" id="likeButton" disabled>
                â¤ï¸ <span id="likeCount">0</span>
            </button>
        </div>
        
    </section>

    
    <section class="reply-section">
        <h2 class="reply-section-header">ä¸»é¢˜å›å¤ (<span id="replyCountHeader">0</span>)</h2>
        <div class="reply-list" id="replyList">
            <p style="text-align: center; color: #999;" id="replyLoadingMessage">æ­£åœ¨åŠ è½½å›å¤...</p>
        </div>
        
        <div class="pagination" id="replyPaginationContainer" style="display: flex; justify-content: center; margin-top: 20px;">
            </div>
    </section>

    <section class="reply-editor-container">
        <div class="reply-editor-header">
            å‘è¡¨æ–°å›å¤
            <span id="replyingToMessage" style="color: #6a493e; font-size: 0.9em; margin-left: 15px;"></span>
        </div>
        <div id="replyEditor"></div>
        
        <div class="reply-submit-area">
            <input type="hidden" id="replyToId" value=""> <input type="hidden" id="replyToUsername" value=""> <span id="replyStatusMessage" class="submit-message"></span>
            <button id="submitReplyBtn" class="submit-btn" disabled>å‘è¡¨å›å¤</button>
        </div>
    </section>

  <!-- âœ… å…¨å±€åŠ è½½è¿›åº¦æ¡ -->
<div id="topic-load-progress-container" style="
  display:none;
  position:fixed;
  top:45%;
  left:50%;
  transform:translate(-50%, -50%);
  width:320px;
  background:#fff;
  border:1px solid #ccc;
  border-radius:8px;
  box-shadow:0 4px 10px rgba(0,0,0,0.2);
  text-align:center;
  padding:20px;
  z-index:2000;
">
  <p id="topic-load-progress-text" style="margin:0 0 8px; font-size:0.9rem; color:#555;">æ­£åœ¨åŠ è½½ä¸»é¢˜è¯¦æƒ…...</p>
  <div style="width:90%; margin:0 auto; height:8px; background:#eee; border-radius:5px; overflow:hidden;">
    <div id="topic-load-progress-bar" style="width:0%; height:100%; background:#0077cc; transition:width 0.3s ease;"></div>
  </div>
</div>


</div>

<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quill-image-resize@3.0.0/image-resize.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script> 
<script>
document.addEventListener('DOMContentLoaded', () => {
    // -------------------------------------------------------------------
    // --- é…ç½®éƒ¨åˆ† ---
    // -------------------------------------------------------------------
    // **æ³¨æ„ï¼šåœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œè¯·ç¡®ä¿æ­¤ API_BASE_URL æ˜¯æ‚¨çš„æœåŠ¡å™¨åœ°å€**
    const API_BASE_URL = 'https://api.anchorx.ca/api/topics'; 
    const REPLIES_PER_PAGE = 20; 

    // è·å– URL ä¸­çš„ä¸»é¢˜ ID
    const urlParams = new URLSearchParams(window.location.search);
    const topicId = urlParams.get('id');

    // æ£€æŸ¥ä¸»é¢˜ ID
    if (!topicId) {
        document.getElementById('topicContent').innerHTML = '<h2>é”™è¯¯ï¼šç¼ºå°‘ä¸»é¢˜IDå‚æ•°ã€‚</h2>';
        return;
    }

    let replyCurrentPage = 1;
    let replyTotalPages = 1;
    let isLiked = false; 

    // -------------------------------------------------------------------
    // --- DOM & Quill åˆå§‹åŒ– ---
    // -------------------------------------------------------------------

    // åˆå§‹åŒ– Quill 
    const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'], 
        ['blockquote', { 'list': 'ordered' }, { 'list': 'bullet' }],
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        [{ 'color': [] }, { 'background': [] }],
        ['link', 'image', 'clean'] // ã€é‡è¦ã€‘Quill å·¥å…·æ æ–°å¢ 'image'
    ];
// åˆå§‹åŒ– Quill 
    // ... (çœç•¥å·¥å…·æ é…ç½®)
    const replyQuill = new Quill('#replyEditor', {
        theme: 'snow',
        placeholder: 'è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„å›å¤...',
        modules: {
            toolbar: toolbarOptions,
            // ã€é‡è¦ã€‘æ–°å¢å›¾ç‰‡ç¼©æ”¾æ¨¡å—
            imageResize: {
                modules: [ 'Resize', 'DisplaySize', 'Toolbar' ]
            },
            // ã€é‡è¦ã€‘è‡ªå®šä¹‰å›¾ç‰‡å¤„ç†å¥æŸ„
            toolbar: {
                container: toolbarOptions,
                handlers: {
                    'image': imageHandler // ç»‘å®šè‡ªå®šä¹‰å‡½æ•°
                }
            }
        }
    });

    const submitReplyBtn = document.getElementById('submitReplyBtn');
    const replyStatusMessage = document.getElementById('replyStatusMessage');
    const likeButton = document.getElementById('likeButton'); 
    const replyToIdInput = document.getElementById('replyToId'); // æ¥¼ä¸­æ¥¼ ID å­˜å‚¨
    const replyingToMessage = document.getElementById('replyingToMessage'); // æ¥¼ä¸­æ¥¼æç¤ºä¿¡æ¯


    // å¯ç”¨/ç¦ç”¨å›å¤æŒ‰é’® (ç®€å•çš„å†…å®¹æ ¡éªŒ)
    replyQuill.on('text-change', () => {
        const text = replyQuill.getText().trim();
        submitReplyBtn.disabled = text.length === 0 || text.length > 5000; 
    });
    
    // -------------------------------------------------------------------
    // --- å›¾ç‰‡ä¸Šä¼ ç›¸å…³å‡½æ•°ï¼ˆé—®é¢˜ 4 ä¿®æ­£ï¼‰ ---
    // -------------------------------------------------------------------
    
    /**
     * ã€æ ¸å¿ƒä¸Šä¼ å‡½æ•°ã€‘
     * æ¥æ”¶æ–‡ä»¶ï¼Œå‹ç¼©åå‘é€åˆ°åç«¯ API
     * @param {File} file - åŸå§‹å›¾ç‰‡æ–‡ä»¶
     * @returns {Promise<string>} - è¿”å›åç«¯å­˜å‚¨çš„å›¾ç‰‡ URL
     */
    async function uploadImageFile(file) {
        // å®šä¹‰å‹ç¼©é€‰é¡¹
        const options = {
            maxSizeMB: 0.5, // æœ€å¤§æ–‡ä»¶å¤§å°ï¼Œå•ä½MBã€‚
            maxWidthOrHeight: 1920, // å…è®¸çš„æœ€å¤§å®½åº¦æˆ–é«˜åº¦
            useWebWorker: true // ä½¿ç”¨ Web Worker
        };

        const token = getAuthToken();
        if (!token) {
             throw new Error("ç”¨æˆ·æœªç™»å½•");
        }
        
        // è°ƒç”¨å‹ç¼©å‡½æ•° (éœ€è¦å¼•å…¥ browser-image-compression åº“)
        const compressedFile = await imageCompression(file, options);
        console.log('åŸå§‹æ–‡ä»¶å¤§å°:', (file.size / 1024).toFixed(2), 'KB');
        console.log('å‹ç¼©åæ–‡ä»¶å¤§å°:', (compressedFile.size / 1024).toFixed(2), 'KB');
        
        // ä½¿ç”¨ FormData æ¥åŒ…è£…å‹ç¼©åçš„æ–‡ä»¶
        const formData = new FormData();
        // ä½¿ç”¨åŸå§‹æ–‡ä»¶åï¼Œä»¥ä¾¿åç«¯å¯ä»¥è·å–æ­£ç¡®çš„æ–‡ä»¶æ‰©å±•å
        formData.append('image', compressedFile, file.name); 

        // å‘é€åˆ°åç«¯ä¸Šä¼ æ¥å£
        const res = await fetch(`${API_BASE_URL}/upload`, { // å‡è®¾æ‚¨çš„ä¸Šä¼ æ¥å£æ˜¯ /api/topics/upload
            method: 'POST',
            headers: {
                // ä¸Šä¼  FormData æ—¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® 'Content-Type'ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è®¾ç½®
                'Authorization': `Bearer ${token}` 
            },
            body: formData
        });

        if (!res.ok) {
            const errorResult = await res.json();
            throw new Error(errorResult.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
        }

        const result = await res.json();
        
        // ã€æ³¨æ„ã€‘è¿™é‡Œå‡è®¾åç«¯è¿”å›çš„ JSON ä¸­åŒ…å«ä¸€ä¸ªåä¸º imageUrl çš„å­—æ®µ
        if (!result.imageUrl) {
            throw new Error('åç«¯æœªè¿”å›å›¾ç‰‡ URL');
        }
        return result.imageUrl; 
    }


    /**
     * ã€Quill å›¾ç‰‡å·¥å…·æ å¤„ç†å¥æŸ„ã€‘
     * æ‹¦æˆª Quill çš„å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
     */
    function imageHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
            if (input.files && input.files.length > 0) {
                const file = input.files[0];
                const range = replyQuill.getSelection(true);
                
                // 1. åœ¨ç¼–è¾‘å™¨ä¸­æ’å…¥å ä½æ–‡æœ¬
                const placeholderText = " [å›¾ç‰‡ä¸Šä¼ ä¸­...] ";
                replyQuill.insertText(range.index, placeholderText, { 'color': '#999' });
                replyQuill.setSelection(range.index + placeholderText.length, 0, Quill.sources.SILENT);
                replyQuill.focus();
                
                // å­˜å‚¨å ä½æ–‡æœ¬çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ï¼Œä»¥ä¾¿åç»­åˆ é™¤
                const startIndex = range.index;
                const length = placeholderText.length;


                try {
                    // 2. è°ƒç”¨æ ¸å¿ƒä¸Šä¼ å‡½æ•°
                    const imageUrl = await uploadImageFile(file);
                    
                    // 3. ç§»é™¤å ä½æ–‡æœ¬ï¼Œæ’å…¥å›¾ç‰‡
                    replyQuill.deleteText(startIndex, length, Quill.sources.USER);
                    replyQuill.insertEmbed(startIndex, 'image', imageUrl, Quill.sources.USER);
                    replyQuill.setSelection(startIndex + 1, 0, Quill.sources.SILENT);

                } catch (error) {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                    // 4. ä¸Šä¼ å¤±è´¥ï¼Œç§»é™¤å ä½æ–‡æœ¬å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    replyQuill.deleteText(startIndex, length, Quill.sources.USER);
                    replyStatusMessage.textContent = `å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`; 
                    setTimeout(() => { replyStatusMessage.textContent = ''; }, 4000);
                }
            }
        };
    }

  
    // -------------------------------------------------------------------
    // --- è¾…åŠ©å‡½æ•° ---
    // -------------------------------------------------------------------
    
    function formatDate(dateString) {
        if (!dateString) return 'æœªçŸ¥æ—¥æœŸ';
        try {
            return new Date(dateString).toLocaleDateString('zh-CN', { 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit' 
            });
        } catch (e) {
            return 'æ—¥æœŸé”™è¯¯';
        }
    }

    function getAuthToken() {
        // **æ­£ç¡®å®ç°ï¼š**
        const token = localStorage.getItem('token');
        return token;
    }

    // ---------- è¾…åŠ©ï¼šç¡®ä¿ replyLoadingMessage å­˜åœ¨å¹¶è¿”å›å®ƒ ----------
    function ensureReplyLoadingMessage(message = 'æ­£åœ¨åŠ è½½å›å¤...') {
        let loading = document.getElementById('replyLoadingMessage');
        const list = document.getElementById('replyList');
        if (!list) return null; 
        if (!loading) {
            loading = document.createElement('p');
            loading.id = 'replyLoadingMessage';
            loading.style.textAlign = 'center';
            loading.style.color = '#999';
            loading.style.padding = '20px 0';
            list.appendChild(loading);
        }
        loading.textContent = message;
        return loading;
    }

    // ---------- è¾…åŠ©ï¼šç®€å•è½¬ä¹‰ï¼ˆç”¨äºç”¨æˆ·åç­‰æ’å…¥ innerHTML çš„åœºæ™¯ï¼‰ ----------
    function escapeHtml(unsafe) {
        return String(unsafe || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    // ---------- æ–°å¢ï¼šç”¨æˆ·æ´»è·ƒçŠ¶æ€ç›¸å…³å·¥å…· ----------
    /**
     * æ ¹æ® lastActiveAt è®¡ç®—çŠ¶æ€æ ‡ç­¾å’Œæ ·å¼
     * è§„åˆ™å¯ä»¥è‡ªå·±å¾®è°ƒï¼š
     *   <= 10 åˆ†é’Ÿï¼šåœ¨çº¿
     *   <= 1 å¤©ï¼šä»Šå¤©æ´»è·ƒ
     *   å…¶ä»–ï¼šç¦»çº¿
     */
    function getUserStatus(lastActiveAt) {
        if (!lastActiveAt) {
            return { label: 'ç¦»çº¿', className: 'user-status-offline' };
        }
        const ts = new Date(lastActiveAt).getTime();
        if (Number.isNaN(ts)) {
            return { label: 'ç¦»çº¿', className: 'user-status-offline' };
        }

        const diffMinutes = (Date.now() - ts) / (1000 * 60);
        if (diffMinutes <= 10) {
            return { label: 'åœ¨çº¿', className: 'user-status-online' };
        } else if (diffMinutes <= 60 * 24) {
            return { label: 'ä»Šå¤©æ´»è·ƒ', className: 'user-status-recent' };
        } else {
            return { label: 'ç¦»çº¿', className: 'user-status-offline' };
        }
    }

    /**
     * è¿”å›ä¸€æ®µå°å¾½ç«  HTMLï¼Œæ’åˆ°ç”¨æˆ·ååé¢
     */
    function renderUserStatusBadge(lastActiveAt) {
        const { label, className } = getUserStatus(lastActiveAt);
        return `<span class="user-status-badge ${className}">${label}</span>`;
    }

  
    // -------------------------------------------------------------------
    // --- æ¸²æŸ“å‡½æ•° ---
    // -------------------------------------------------------------------

 function renderTopicDetail(topic, _isLiked) {
    document.getElementById('topicTitle').textContent = topic.title;

    const topicAuthorEl = document.getElementById('topicAuthor');
    const topicAuthorAvatarEl = document.getElementById('topicAuthorAvatar');

    if (topic.author) {
        const statusHtml = renderUserStatusBadge(topic.author.lastActiveAt);
        topicAuthorEl.innerHTML = `ä½œè€…: ${escapeHtml(topic.author.username)} ${statusHtml}`;

        if (topic.author.avatarUrl) {
            topicAuthorAvatarEl.innerHTML =
                `<img src="${escapeHtml(topic.author.avatarUrl)}" alt="${escapeHtml(topic.author.username)}">`;
        } else {
            const initial = escapeHtml(topic.author.username[0] || 'U').toUpperCase();
            topicAuthorAvatarEl.textContent = initial;
        }
    } else {
        topicAuthorEl.textContent = 'ä½œè€…: åŒ¿å';
        topicAuthorAvatarEl.textContent = 'U';
    }

        document.getElementById('topicCreatedAt').textContent = formatDate(topic.createdAt);
        document.getElementById('topicViews').textContent = topic.viewsCount || 0;
        document.getElementById('topicRepliesCount').textContent = topic.repliesCount || 0;
        document.getElementById('replyCountHeader').textContent = topic.repliesCount || 0;

        const topicSectionEl = document.getElementById('topicSection');
        if (topic.section && topic.section.name) {
            topicSectionEl.textContent = topic.section.name;
            topicSectionEl.style.display = 'inline-block';
        } else {
            topicSectionEl.style.display = 'none';
        }

        const likeCountEl = document.getElementById('likeCount');
        likeCountEl.textContent = topic.likesCount || 0;
        isLiked = _isLiked;

        if (isLiked) {
            likeButton.classList.add('liked');
            likeButton.innerHTML = `ğŸ§¡ <span>${likeCountEl.textContent}</span>`;
        } else {
            likeButton.classList.remove('liked');
            likeButton.innerHTML = `â¤ï¸ <span>${likeCountEl.textContent}</span>`;
        }
        likeButton.disabled = false;

        const contentContainer = document.getElementById('topicContent');
        if (topic.content) {
            contentContainer.innerHTML = topic.content;
        } else {
            contentContainer.innerHTML = '<p>ä¸»é¢˜å†…å®¹ä¸ºç©ºã€‚</p>';
        }
    }



    /**
     * æ¸²æŸ“å›å¤åˆ—è¡¨ (é—®é¢˜ 1 æ¥¼ä¸­æ¥¼å®ç°)
     * ã€æ³¨æ„ã€‘ï¼šæ­¤å¤„ä»…å®ç°æ‰å¹³åŒ–æ¸²æŸ“ï¼Œæ¥¼ä¸­æ¥¼çš„åµŒå¥—é€»è¾‘éœ€è¦åç«¯æ•°æ®ç»“æ„æ”¯æŒã€‚
     * * @param {Array<Object>} replies - å›å¤åˆ—è¡¨ã€‚
     */
      /**
     * æ¸²æŸ“å›å¤åˆ—è¡¨ï¼ˆæ‰å¹³åˆ—è¡¨ + å¼•ç”¨æ¡ + å¤´åƒï¼‰
     * @param {Array<Object>} replies - å›å¤åˆ—è¡¨ã€‚
     */
    function renderReplies(replies) {
        const list = document.getElementById('replyList');
        if (!list) return;

        const loadingMsg = ensureReplyLoadingMessage();
        if (loadingMsg) loadingMsg.style.display = 'none';

        list.innerHTML = '';
        if (loadingMsg) list.appendChild(loadingMsg);

        if (!Array.isArray(replies) || replies.length === 0) {
            if (loadingMsg) {
                loadingMsg.style.display = 'block';
                loadingMsg.textContent = 'æš‚æ— å›å¤ã€‚';
            } else {
                list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">æš‚æ— å›å¤ã€‚</p>';
            }
            return;
        }

        // å•æ¡å›å¤çš„æ¸²æŸ“
        const createReplyItem = (reply, index) => {
            const authorName = reply.author ? reply.author.username : 'åŒ¿åç”¨æˆ·';
            const initial = authorName ? escapeHtml(authorName[0]).toUpperCase() : 'U';
            const avatarUrl = reply.author && reply.author.avatarUrl ? reply.author.avatarUrl : '';
            const replyId = reply._id || '';

            const item = document.createElement('div');
            item.className = 'reply-item';
            item.dataset.replyId = replyId;

            // æ¥¼å±‚å· + æ—¶é—´
            const floorNumber = (replyCurrentPage - 1) * REPLIES_PER_PAGE + index + 1;
            const replyIndexHtml = `<span>#${floorNumber} | ${formatDate(reply.createdAt)}</span>`;

            // æ´»è·ƒçŠ¶æ€å¾½ç« 
            let statusHtml = '';
            if (reply.author && reply.author.lastActiveAt) {
                statusHtml = renderUserStatusBadge(reply.author.lastActiveAt);
            }

            // é¡¶éƒ¨å¼•ç”¨æ¡
            const parentPreviewHtml = buildParentPreviewHtml(reply);

            // æœ‰å¤´åƒå°±ç”¨å›¾ç‰‡ï¼Œæ²¡æœ‰å°±ç”¨é¦–å­—æ¯
            const avatarHtml = avatarUrl
                ? `<img src="${escapeHtml(avatarUrl)}" alt="${escapeHtml(authorName)}">`
                : initial;

            item.innerHTML = `
                <div class="reply-avatar">${avatarHtml}</div>
                <div class="reply-body">
                    ${parentPreviewHtml}
                    <div class="reply-user-meta">
                        ${escapeHtml(authorName)} ${statusHtml} ${replyIndexHtml}
                    </div>
                    <div class="reply-content">${reply.content || ''}</div>
                    <div class="reply-actions"
                         data-reply-id="${replyId}"
                         data-username="${escapeHtml(authorName)}">
                         å›å¤TA
                    </div>
                </div>
            `;

            return item;
        };

        // æ‰å¹³æ¸²æŸ“ï¼šç›´æ¥æŒ‰é¡ºåº append å³å¯
        replies.forEach((reply, index) => {
            list.appendChild(createReplyItem(reply, index));
        });

        // ç‚¹å‡»â€œå›å¤TAâ€æ—¶ï¼Œåœ¨ç¼–è¾‘å™¨ä¸Šå±•ç¤ºâ€œæ­£åœ¨å›å¤ï¼šxxxâ€ï¼Œå¹¶è®¾ç½® parentId
        list.querySelectorAll('.reply-actions').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const username = e.currentTarget.dataset.username || '';
                const replyId = e.currentTarget.dataset.replyId || '';

                // 1. è®¾ç½®å›å¤ç›®æ ‡ ID å’Œç”¨æˆ·åï¼ˆç»™ submitReply ç”¨ï¼‰
                replyToIdInput.value = replyId;
                document.getElementById('replyToUsername').value = username;
                replyingToMessage.textContent = ` (æ­£åœ¨å›å¤ï¼š${username})`;

                // 2. ç¼–è¾‘å™¨é‡Œä»ç„¶æ’ä¸€æ®µ @ æç¤ºï¼ˆå¯é€‰ï¼‰
                replyQuill.setContents([{ insert: '\n' }]);
                const mention = `@${username} `;
                replyQuill.insertText(0, mention, Quill.sources.USER);
                replyQuill.setSelection(mention.length, 0, Quill.sources.SILENT);
                replyQuill.focus();

                // 3. æ»šåˆ°ç¼–è¾‘å™¨
                document.querySelector('.reply-editor-container').scrollIntoView({ behavior: 'smooth' });
            });
        });
    }


    // ... renderReplyPagination (ä¿æŒä¸å˜) ...
    function renderReplyPagination() {
        const container = document.getElementById('replyPaginationContainer');
        container.innerHTML = '';
        if (replyTotalPages <= 1) return;

        const prevBtn = `<button id="prevReplyBtn" class="pagination-btn" style="padding:8px; border:1px solid #ccc; margin-right: 10px;" ${replyCurrentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
        const info = `<span>ç¬¬ ${replyCurrentPage} / ${replyTotalPages} é¡µ</span>`;
        const nextBtn = `<button id="nextReplyBtn" class="pagination-btn" style="padding:8px; border:1px solid #ccc; margin-left: 10px;" ${replyCurrentPage === replyTotalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;

        container.innerHTML = prevBtn + info + nextBtn;
        
        // ç»‘å®šåˆ†é¡µäº‹ä»¶
        document.getElementById('prevReplyBtn').addEventListener('click', () => {
            if (replyCurrentPage > 1) {
                fetchReplies(replyCurrentPage - 1);
            }
        });
        document.getElementById('nextReplyBtn').addEventListener('click', () => {
            if (replyCurrentPage < replyTotalPages) {
                fetchReplies(replyCurrentPage + 1);
            }
        });
    }

    // -------------------------------------------------------------------
    // --- API äº¤äº’å‡½æ•° ---
    // -------------------------------------------------------------------
    
    // ... submitLike (ä¿æŒä¸å˜) ...
    async function submitLike() {
        const token = getAuthToken();
        if (!token) {
            alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµï¼');
            return;
        }

        likeButton.disabled = true; 
        
        try {
            const response = await fetch(`${API_BASE_URL}/${topicId}/like`, {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({}) 
            });

            const result = await response.json();

            if (response.ok) {
                const newLikesCount = result.likesCount || 0;
                const newIsLiked = result.isLiked; 

                renderTopicDetail({
                    ...data.topic, 
                    likesCount: newLikesCount
                }, newIsLiked);

            } else {
                alert(`æ“ä½œå¤±è´¥: ${result.message || 'æœåŠ¡å™¨é”™è¯¯'}`);
            }

        } catch (error) {
            console.error('æäº¤ç‚¹èµæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
            alert('æäº¤å¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯ã€‚');
        } finally {
            likeButton.disabled = false;
        }
    }

async function fetchTopicAndReplies() {
    const progressContainer = document.getElementById('topic-load-progress-container');
    const progressText = document.getElementById('topic-load-progress-text');
    const progressBar = document.getElementById('topic-load-progress-bar');

    // å¯åŠ¨åŠ è½½æ¡
    progressContainer.style.display = 'block';
    progressText.textContent = 'æ­£åœ¨è¯·æ±‚ä¸»é¢˜æ•°æ®...';
    progressBar.style.width = '10%';

    try {
        const token = getAuthToken();
        const topicUrl = `${API_BASE_URL}/${topicId}?page=1&limit=${REPLIES_PER_PAGE}`;
        
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const response = await fetch(topicUrl, { headers });

        if (!response.ok) throw new Error(`æ‚¨çš„æµè§ˆå™¨ä¼¼ä¹æƒ³å’Œæˆ‘ä»¬å¯¹ç€å¹²ï¼è¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ (${response.status})`);
        progressText.textContent = 'æ­£åœ¨è§£ææ•°æ®...';
        progressBar.style.width = '40%';

        const data = await response.json();

        // æ¸²æŸ“ä¸»é¢˜éƒ¨åˆ†
        renderTopicDetail(data.topic, !!data.isLiked);
        progressText.textContent = 'æ­£åœ¨æ¸²æŸ“ä¸»é¢˜å†…å®¹...';
        progressBar.style.width = '60%';

        // æ¸²æŸ“å›å¤éƒ¨åˆ†
        if (Array.isArray(data.replies)) {
            renderReplies(data.replies);
            renderReplyPagination();
        }
        progressText.textContent = 'æ­£åœ¨åŠ è½½å›å¤...';
        progressBar.style.width = '80%';

        // å›å¤é¡µæ•°ä¿¡æ¯
        replyCurrentPage = data.replyPage || 1;
        replyTotalPages = data.replyTotalPages || 1;

        // å®ŒæˆçŠ¶æ€
        progressText.textContent = 'åŠ è½½å®Œæˆï¼';
        progressBar.style.width = '100%';
        progressBar.style.background = '#4caf50';
        setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.background = '#0077cc';
        }, 1000);

    } catch (error) {
        console.error('åŠ è½½ä¸»é¢˜æˆ–å›å¤å¤±è´¥:', error);
        const headerEl = document.querySelector('.topic-header');
        if (headerEl) headerEl.style.display = 'none';

        const contentContainer = document.getElementById('topicContent');
        if (contentContainer) {
            contentContainer.innerHTML = `<p style="color:red; text-align:center;">è¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼ˆä½ çš„æµè§ˆå™¨æ¯”è¾ƒæ¾å¼›ï¼‰ï¼š${escapeHtml(error.message)}</p>`;
        }

        const loadingMsg = ensureReplyLoadingMessage('ä¸»é¢˜åŠ è½½å¤±è´¥ï¼Œå›å¤æ— æ³•æ˜¾ç¤ºã€‚');
        if (loadingMsg) loadingMsg.style.display = 'block';

        const pagination = document.getElementById('replyPaginationContainer');
        if (pagination) pagination.style.display = 'none';

        progressText.textContent = 'åŠ è½½å¤±è´¥';
        progressBar.style.background = '#e53935';
        setTimeout(() => (progressContainer.style.display = 'none'), 1200);
    }
}

    
    // ... fetchReplies (ä¿æŒä¸å˜) ...
    async function fetchReplies(page) {
        const loadingMsg = ensureReplyLoadingMessage('æ­£åœ¨åŠ è½½å›å¤...');
        if (loadingMsg) loadingMsg.style.display = 'block';

        const list = document.getElementById('replyList');
        if (list) {
            list.innerHTML = '';
            if (loadingMsg) list.appendChild(loadingMsg);
        }

        window.scrollTo(0, 0); 

        try {
            const topicUrl = `${API_BASE_URL}/${topicId}?page=${page}&limit=${REPLIES_PER_PAGE}`;
            const response = await fetch(topicUrl);
            if (!response.ok) throw new Error(`åŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            const data = await response.json();

            replyCurrentPage = data.replyPage || 1;
            replyTotalPages = data.replyTotalPages || 1;

            renderReplies(data.replies);
            renderReplyPagination();
        } catch (error) {
            console.error('åŠ è½½å›å¤é¡µå¤±è´¥:', error);
            const loadingMsg = ensureReplyLoadingMessage('å›å¤é¡µåŠ è½½å¤±è´¥ã€‚');
            if (loadingMsg) loadingMsg.style.display = 'block';
        }
    }

    /**
     * æäº¤æ–°å›å¤ (é—®é¢˜ 1 æ¥¼ä¸­æ¥¼ä¿®æ­£)
     */
    async function submitReply() {
        const contentHTML = replyQuill.root.innerHTML; 
        const replyToId = replyToIdInput.value; // è·å–å›å¤ç›®æ ‡çš„ ID

        if (replyQuill.getText().trim().length === 0) {
            replyStatusMessage.textContent = 'å›å¤å†…å®¹ä¸èƒ½ä¸ºç©ºï¼';
            return;
        }

        const token = getAuthToken();
        if (!token) {
            replyStatusMessage.textContent = 'è¯·å…ˆç™»å½•æ‰èƒ½å›å¤ï¼';
            return;
        }

        submitReplyBtn.disabled = true;
        replyStatusMessage.textContent = 'æ­£åœ¨æäº¤å›å¤...';
        
        try {
            const payload = {
                content: contentHTML,
            };
            
            // ã€ä¿®æ­£ç‚¹ã€‘å¦‚æœæœ‰ replyToIdï¼Œåˆ™å°†å…¶æ·»åŠ åˆ° payload ä¸­ï¼Œä½œä¸ºæ¥¼ä¸­æ¥¼çš„ä¾æ®
            if (replyToId) {
                payload.parentId = replyToId; // å‡è®¾æ‚¨çš„åç«¯ä½¿ç”¨ parentId æ¥æ ‡è¯†æ¥¼ä¸­æ¥¼
            }

            const response = await fetch(`${API_BASE_URL}/${topicId}/replies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify(payload) // åŒ…å« parentId
            });

            const result = await response.json();

            if (response.ok) {
                replyStatusMessage.textContent = 'å›å¤æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...';
                
                // æˆåŠŸåæ¸…é™¤æ¥¼ä¸­æ¥¼çŠ¶æ€
                replyToIdInput.value = '';
                document.getElementById('replyToUsername').value = '';
                replyingToMessage.textContent = '';

                replyQuill.setContents([{ insert: '\n' }]); 
                setTimeout(() => {
                    replyStatusMessage.textContent = '';
                    submitReplyBtn.disabled = false;
                    // é‡æ–°åŠ è½½ä¸»é¢˜å’Œå›å¤ï¼Œæœ€å¥½æ˜¯å®šä½åˆ°æ–°å›å¤æ‰€åœ¨é¡µ
                    fetchTopicAndReplies(); 
                }, 1000);

            } else {
                replyStatusMessage.textContent = `å›å¤å¤±è´¥: ${result.message || 'æœåŠ¡å™¨é”™è¯¯'}`;
                submitReplyBtn.disabled = false;
            }

        } catch (error) {
            console.error('æäº¤å›å¤æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
            replyStatusMessage.textContent = 'æäº¤å¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯ã€‚';
            submitReplyBtn.disabled = false;
        }
    }

      // ---------- ä» HTML æå–çº¯æ–‡æœ¬ï¼Œç”¨äºåšå¼•ç”¨æ‘˜è¦ ----------
    function extractPlainTextFromHtml(html) {
        if (!html) return '';
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return (tmp.textContent || tmp.innerText || '').trim();
    }

    /**
     * ç”Ÿæˆâ€œæ­£åœ¨å›å¤ï¼šxxx æ‘˜è¦...â€ è¿™ä¸€è¡Œ HTML
     * reply.parentReply éœ€è¦ç”±åç«¯ populate å‡ºæ¥
     */
    function buildParentPreviewHtml(reply) {
        const parent = reply.parentReply;
        if (!parent) return '';

        const parentAuthorName =
            parent.author && parent.author.username
                ? parent.author.username
                : 'åŒ¿åç”¨æˆ·';

        const plain = extractPlainTextFromHtml(parent.content || '').replace(/\s+/g, ' ');
        if (!plain) return '';

        const snippet = plain.length > 60 ? plain.slice(0, 60) + 'â€¦' : plain;

        return `
            <div class="reply-parent-preview">
                å›å¤ <span class="reply-parent-username">${escapeHtml(parentAuthorName)}</span>ï¼š
                <span class="reply-parent-snippet">${escapeHtml(snippet)}</span>
            </div>
        `;
    }

    
    // -------------------------------------------------------------------
    // --- äº‹ä»¶ç»‘å®šåŠåˆå§‹æ‰§è¡Œ ---
    // -------------------------------------------------------------------
    
    // ç»‘å®šæäº¤å›å¤æŒ‰é’®
    submitReplyBtn.addEventListener('click', submitReply);
    
    // ç»‘å®šç‚¹èµæŒ‰é’®
    likeButton.addEventListener('click', submitLike);

    // ã€ç§»é™¤ã€‘åŸå›¾ç‰‡ä¸Šä¼ æŒ‰é’®çš„å ä½ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬å·²å°†é€»è¾‘é›†æˆåˆ° Quill çš„ imageHandler ä¸­
    
    // åˆå§‹åŠ è½½æ•°æ®
    fetchTopicAndReplies();
});

</script>

</body>
</html>