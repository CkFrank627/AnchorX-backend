<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>åˆ›ä½œé¡µé¢</title>
    <link href="https://api.anchorx.ca/vendor_assets/quill.snow.css" rel="stylesheet">
  
<style> /* éšè—ç±» */ .hidden {
  display:none !important;
}
/* æ•´ä¸ªé¡µé¢å®¹å™¨ */ body {
  margin:0;
  padding:0;
  font-family:Arial,sans-serif;
  background-color:#f0f2f5;
}
.page-container {
  display:flex;
  min-height:100vh;
  background-color:#fff;
}
/* ä¾§è¾¹æ  */ .sidebar-nav {
  flex-shrink:0;
  width:250px;
  padding:30px 20px;
  background-color:#f7f9fc;
  border-right:1px solid #eee;
  /* æ–°å¢ï¼šæ·»åŠ è¿‡æ¸¡æ•ˆæœï¼Œä½¿å±•å¼€å’Œæ”¶èµ·æ›´å¹³æ»‘ */ transition:width 0.3s ease-in-out,padding 0.3s ease-in-out;
}
/* æ–°å¢ï¼šä¾§è¾¹æ æ”¶èµ·æ—¶çš„æ ·å¼ */ .sidebar-collapsed {
  width:70px;
  /* è°ƒæ•´ä¸ºåªå®¹çº³å›¾æ ‡çš„å®½åº¦ */ padding:30px 10px;
}
.nav-link {
  display:flex;
  align-items:center;
  /* æ–°å¢ï¼šå¯¹é½æ–¹å¼ï¼Œä¾§è¾¹æ æ”¶èµ·æ—¶å›¾æ ‡å±…ä¸­ */ justify-content:flex-start;
  padding:12px 15px;
  margin-bottom:8px;
  text-decoration:none;
  color:#333;
  border-radius:6px;
  transition:background-color 0.2s,color 0.2s,transform 0.2s;
}
/* æ–°å¢ï¼šä¾§è¾¹æ æ”¶èµ·æ—¶é“¾æ¥å›¾æ ‡å±…ä¸­ */ .sidebar-collapsed .nav-link {
  justify-content:center;
  padding:12px 0;
}
.nav-link:hover {
  background-color:#e6f7ff;
  color:#0077cc;
}
/* ... ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ ... */ .nav-icon {
  margin-right:15px;
  display:flex;
  align-items:center;
  justify-content:center;
  /* æ–°å¢ï¼šæ·»åŠ è¿‡æ¸¡æ•ˆæœ */ transition:margin-right 0.3s ease-in-out;
}
/* æ–°å¢ï¼šä¾§è¾¹æ æ”¶èµ·æ—¶ç§»é™¤å›¾æ ‡å³è¾¹è· */ .sidebar-collapsed .nav-icon {
  margin-right:0;
}
.nav-icon svg {
  width:20px;
  height:20px;
}
.nav-link.active .nav-icon svg {
  fill:#0077cc;
}
/* æ–°å¢ï¼šéšè—æ–‡å­—ï¼Œå¹¶æ·»åŠ è¿‡æ¸¡æ•ˆæœ */ .nav-text {
  opacity:1;
  transition:opacity 0.2s ease-in-out;
}
.sidebar-collapsed .nav-text {
  opacity:0;
}
/* ä¸»å†…å®¹åŒºåŸŸ */ .main-content {
  /* ä¿æŒåŸæœ‰æ ·å¼ */ flex-grow:1;
  display:flex;
  flex-direction:column;
  padding:0 40px;
  /* æ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ å³è¾¹è·ï¼Œæ•°å€¼éœ€ä¸å·¥å…·æ å®½åº¦ä¸€è‡´ */ margin-right:250px;
}
.content-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.header-left,.header-right {
  display:flex;
  align-items:center;
}
.header-left {
  gap:20px;
}
.header-title {
  display:flex;
  align-items:center;
}
.header-title h2 {
  font-size:1.5rem;
  margin:0;
  margin-left:10px;
}
.create-button {
  background-color:#0077cc;
  color:#fff;
  border:none;
  padding:10px 15px;
  border-radius:5px;
  cursor:pointer;
  font-size:1rem;
  display:flex;
  align-items:center;
  gap:5px;
  transition:background-color 0.3s ease;
}
.create-button:hover {
  background-color:#005aa7;
}
.sort-dropdown {
  position:relative;
}
.sort-button {
  background:none;
  border:1px solid #ccc;
  border-radius:5px;
  padding:8px 12px;
  cursor:pointer;
  font-size:1rem;
  color:#555;
  display:flex;
  align-items:center;
  gap:5px;
  transition:all 0.2s ease;
}
.sort-button:hover {
  border-color:#0077cc;
  color:#0077cc;
}
.sort-icon {
  margin-left:5px;
}
.work-list {
  display:flex;
  flex-direction:column;
}
.work-item-wrapper {
  position:relative;
  margin-bottom:15px;
  background-color:#fff;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,0.05);
  transition:transform 0.2s,box-shadow 0.2s;
}
.work-item-wrapper:hover {
  transform:translateY(-2px);
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
.work-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px;
  border:1px solid transparent;
  border-radius:8px;
  text-decoration:none;
  color:inherit;
}
.work-info {
  display:flex;
  flex-direction:column;
  flex-grow:1;
}
.work-date {
  font-size:0.85rem;
  color:#999;
}
.work-details {
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:5px;
}
.work-title {
  font-size:1rem;
  color:#333;
  font-weight:bold;
}
.work-status {
  font-size:0.8rem;
  color:#555;
  background-color:#f0f0f0;
  padding:2px 6px;
  border-radius:4px;
}
.item-divider {
  border:none;
  border-bottom:1px solid #eee;
  margin:10px 0;
}
.menu-button {
  background:none;
  border:none;
  cursor:pointer;
  font-size:1.2rem;
  color:#999;
}
.menu-button:hover {
  color:#333;
}
/* ä½œå“èœå•æ ·å¼ */ .menu-container {
  position:absolute;
  top:50px;
  right:10px;
  width:150px;
  background-color:#fff;
  border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  z-index:10;
  overflow:hidden;
}
.menu-item {
  display:flex;
  align-items:center;
  padding:10px 15px;
  font-size:0.9rem;
  color:#333;
  cursor:pointer;
  transition:background-color 0.2s ease;
}
.menu-item:hover {
  background-color:#e6f7ff;
}
.menu-item svg {
  width:16px;
  height:16px;
  margin-right:10px;
  fill:#888;
}
.menu-item:hover svg {
  fill:#0077cc;
}
/* å¯¹è¯æ¡†ï¼ˆModalï¼‰æ ·å¼ */ .modal {
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  overflow:auto;
  background-color:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
}
.modal-content {
  background-color:#fff;
  padding:30px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
  width:400px;
  max-width:90%;
  text-align:center;
}
.menu-modal-content {
  text-align:center;
  padding:20px;
}
.menu-modal-content h3 {
  margin-top:0;
  color:#333;
}
.modal-content input {
  width:100%;
  padding:10px;
  margin-top:15px;
  margin-bottom:20px;
  border:1px solid #ddd;
  border-radius:5px;
  box-sizing:border-box;
}
.modal-buttons {
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:20px;
}
.modal-buttons button {
  padding:8px 15px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:1rem;
}
#cancel-btn,#delete-cancel-btn {
  background-color:#f0f0f0;
  color:#555;
}
#confirm-btn,#delete-confirm-btn {
  background-color:#0077cc;
  color:#fff;
}
#delete-confirm-btn {
  background-color:#dc3545;
}
/* ç¼–è¾‘å™¨é¡µé¢æ ·å¼ */ .editor-toolbar {
  background-color:#fff;
  padding:10px 30px;
  border-bottom:1px solid #ddd;
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
  display:flex;
  gap:15px;
  align-items:center;
  flex-wrap:wrap;
}
.editor-title {
  flex-grow:1;
  font-size:1.2rem;
  color:#333;
  font-weight:bold;
  margin-right:20px;
}
.back-button {
  padding:8px 12px;
  border:1px solid #adb5bd;
  border-radius:5px;
  background-color:#f8f9fa;
  cursor:pointer;
  color:#495057;
  /* é»˜è®¤æ–‡å­—é¢œè‰² */ transition:background-color 0.2s,color 0.2s;
}
.back-button:hover {
  background-color:#0d6efd;
  /* æ‚¬åœæ—¶èƒŒæ™¯è‰² */ color:#fff;
  /* æ‚¬åœæ—¶æ–‡å­—é¢œè‰² */
}
#toolbar-quill {
  display:flex;
  gap:5px;
  flex-wrap:wrap;
  /* å…è®¸å·¥å…·æ æŒ‰é’®æ¢è¡Œ */
}
.editor-main {
  flex-grow:1;
  /* ğŸ¨ å…³é”®ä¿®æ”¹ï¼šå‡å°‘å¤–è¾¹è·ï¼Œä»¥ç¼©å°å·¥å…·æ å’Œç¼–è¾‘å™¨ä¹‹é—´çš„ç°è‰²è·ç¦» */ padding:30px;
  display:flex;
  flex-direction:column;
  background-color:#f0f2f5;
  /* âŒ ç§»é™¤ margin:20px;
  æˆ–å°†å…¶æ”¹ä¸ºæ›´å°çš„å€¼ */ margin:10px 0;
}
#editor {
  max-width:900px;
  /* èˆ‡é–±è®€é é¢ä¸€è‡´çš„æœ€å¤§å¯¬åº¦ */ width:100%;
  /* éŸ¿æ‡‰å¼å¯¬åº¦ */ padding:16px;
  font-size:16px;
  line-height:1.6;
  white-space:pre-wrap;
  /* ä¿ç•™æ›è¡Œä¸¦è‡ªå‹•æ›è¡Œ */ word-wrap:break-word;
  /* å–®å­—éé•·æ™‚è‡ªå‹•æ–·è¡Œ */ overflow-wrap:break-word;
  /* é˜²æ­¢æ–‡å­—æº¢å‡º */ box-sizing:border-box;
  border:1px solid #ccc;
  border-radius:8px;
  background-color:#fff;
  font-size:1.215rem;
}
.ql-container {
  flex-grow:1;
  display:flex;
  flex-direction:column;
}
.ql-editor {
  flex-grow:1;
  min-height:400px;
}
#plainEditor {
  background-color:#fff;
  border-radius:8px;
  height:100%;
  flex-grow:1;
  border:1px solid #ccc;
  box-sizing:border-box;
  min-height:500px;
}
/* æ–°å¢è§’è‰²ä¸‹æ‹‰èœå•å’Œå¼¹çª—æ ·å¼ */ .dropdown-container {
  position:relative;
  border:1px solid #ccc;
  border-radius:5px;
  margin-bottom:10px;
}
.dropdown-header {
  width:100%;
  background-color:#fff;
  padding:10px 15px;
  font-size:0.9rem;
  text-align:left;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:5px;
}
.dropdown-header:hover {
  background-color:#e6f7ff;
}
.dropdown-header .arrow {
  transition:transform 0.3s;
}
.dropdown-header.open .arrow {
  transform:rotate(90deg);
}
.dropdown-content {
  display:none;
  padding:10px;
  border-top:1px solid #ddd;
  background-color:#f7f9fc;
}
.dropdown-content.open {
  display:block;
}
.role-list {
  list-style:none;
  padding:0;
  margin:0;
}
.role-item {
  font-size:0.9rem;
  border-bottom:1px dashed #ddd;
  padding:8px 0;
  cursor:pointer;
}
.role-item:last-child {
  border-bottom:none;
}
.role-title-wrapper {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.role-title {
  font-weight:bold;
}
.role-title .color-dot {
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:50%;
  margin-right:8px;
  border:1px solid #ccc;
}
.role-item .edit-btn {
  font-size:0.8rem;
  color:#0077cc;
  cursor:pointer;
  margin-left:10px;
}
.role-item-notes {
  font-size:0.8rem;
  color:#555;
  padding-left:18px;
  margin-top:5px;
  display:none;
}
.role-item-notes.open {
  display:block;
}
.add-role-btn {
  width:100%;
  background-color:#e9f5ff;
  color:#0077cc;
  border:1px dashed #0077cc;
  border-radius:5px;
  padding:8px;
  font-size:0.9rem;
  text-align:center;
  cursor:pointer;
  margin-top:10px;
}
.modal-content {
  background-color:#fefefe;
  margin:10% auto;
  padding:25px;
  border:1px solid #888;
  width:400px;
  border-radius:10px;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
}
.modal-content h3 {
  margin-top:0;
  border-bottom:2px solid #ddd;
  padding-bottom:10px;
  margin-bottom:20px;
}
.modal-content label {
  display:block;
  margin-bottom:5px;
  font-weight:bold;
}
.modal-content input,.modal-content textarea {
  width:95%;
  padding:8px;
  margin-bottom:15px;
  border:1px solid #ccc;
  border-radius:4px;
}
.modal-content .color-picker-wrapper {
  display:flex;
  align-items:center;
  margin-bottom:15px;
}
.modal-content .color-picker {
  width:40px;
  height:40px;
  margin-left:10px;
  border:none;
  cursor:pointer;
}
.modal-buttons {
  text-align:right;
}
.modal-buttons button {
  padding:8px 15px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin-left:10px;
}
.modal-buttons .confirm {
  background-color:#0077cc;
  color:white;
}
.modal-buttons .cancel {
  background-color:#ddd;
}
/* æ‰¹é‡åˆªé™¤å¼¹çª—çš„ç‰¹æ®Šæ ·å¼ */ #bulk-delete-modal .modal-content {
  width:500px;
  text-align:left;
}
#bulk-delete-modal .delete-list {
  max-height:300px;
  overflow-y:auto;
  border:1px solid #eee;
  border-radius:6px;
  margin-top:15px;
  padding:10px;
}
#bulk-delete-modal .delete-item {
  display:flex;
  align-items:center;
  padding:8px 10px;
  border-bottom:1px solid #f0f0f0;
}
#bulk-delete-modal .delete-item:last-child {
  border-bottom:none;
}
#bulk-delete-modal .delete-item span {
  flex-grow:1;
  margin-left:10px;
}
#bulk-delete-modal .delete-item input {
  width:auto;
  margin:0;
}
#bulk-delete-modal .delete-buttons {
  display:flex;
  justify-content:flex-end;
  margin-top:20px;
}
.editor-container {
  display:flex;
  flex-direction:row;
}
.right-sidebar {
  flex-shrink: 0;
  width: 250px;
  background-color: #f7f9fc;
  border-left: 1px solid #eee;
  padding: 20px;
  transition: width 0.3s ease-in-out;
  position: sticky;
  top: 70px; /* âœ… å‘ä¸‹é”™å¼€ï¼Œé¿å…é®æŒ¡æ¶ˆæ¯ç®±æˆ–é¡µçœ‰ */
  right: 0;
  height: calc(100vh - 70px); /* âœ… åŒæ­¥è°ƒæ•´é«˜åº¦ */
  overflow-y: auto;
  z-index: 50; /* âœ… ä¿è¯åœ¨ç¼–è¾‘å™¨ä¸Šå±‚ä½†ä¸ç›–ä½é¡µçœ‰ */
}

/* æ–°å¢è§’è‰²é¸æ“‡æŒ‰é’®æ ·å¼ */ .role-select-btn {
  width:20px;
  height:20px;
  border-radius:50%;
  border:2px solid #ccc;
  cursor:pointer;
  display:flex;
  justify-content:center;
  align-items:center;
  transition:all 0.2s ease;
  margin-right:10px;
}
.role-select-btn.active {
  background-color:#0077cc;
  border-color:#0077cc;
}
.role-select-btn.active::after {
  content:'';
  width:8px;
  height:8px;
  border-radius:50%;
  background-color:#fff;
}
.role-item.selected .role-title-wrapper {
  background-color:#e6f7ff;
  border-radius:4px;
  padding:5px 10px;
}
/* æ–°å¢ï¼šé¡µç æ§åˆ¶å™¨æ ·å¼ */ .page-controls {
  position:relative;
  display:flex;
  align-items:center;
  margin-right:15px;
  /* ä¸Quillå·¥å…·æ çš„é—´è· */
}
.page-current {
  cursor:pointer;
  font-size:14px;
  padding:8px 12px;
  border-radius:4px;
  background-color:#f0f0f0;
  transition:background-color 0.2s;
}
.page-current:hover {
  background-color:#e0e0e0;
}
/* æ–°å¢ï¼šé¡µç ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */ .page-select-dropdown {
  position:absolute;
  top:100%;
  left:0;
  margin-top:5px;
  width:150px;
  background-color:#fff;
  border:1px solid #ddd;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
  border-radius:8px;
  z-index:9000;
}
.page-select-dropdown ul {
  list-style:none;
  padding:0;
  margin:0;
  max-height:200px;
  overflow-y:auto;
}
.page-select-dropdown li {
  padding:10px 15px;
  font-size:14px;
  cursor:pointer;
}
.page-select-dropdown li:hover {
  background-color:#f5f5f5;
}
.page-select-dropdown .active {
  background-color:#e0e2e6;
  font-weight:bold;
}
.add-page-btn {
  width:100%;
  padding:10px;
  background-color:#f7f9fc;
  border:none;
  cursor:pointer;
  text-align:center;
  border-top:1px solid #ddd;
  border-radius:0 0 8px 8px;
  color:#000;
}
.add-page-btn:hover {
  background-color:#e0e2e6;
}
/* æ–°å¢ï¼šç¼–è¾‘å™¨åˆ†é¡µå’Œå·¥å…·æ å®¹å™¨ */ .editor-controls {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
/* æ–°å¢ï¼šåˆ†é¡µæŒ‰é’®å®¹å™¨ */ .pagination {
  display:flex;
  align-items:center;
  gap:10px;
}
/* æ–°å¢ï¼šåˆ†é¡µæŒ‰é’® */ .page-btn {
  padding:5px 10px;
  border:1px solid #ccc;
  background-color:#f7f9fc;
  border-radius:5px;
  cursor:pointer;
}
.page-btn:hover {
  background-color:#e6f7ff;
}
.page-number {
  font-weight:bold;
  color:#0077cc;
}
/* æ–°å¢ï¼šç¼–è¾‘å™¨ä¸¤çº§å·¥å…·æ çš„æ•´ä½“å®¹å™¨ï¼Œå®ç°å›ºå®šåœ¨é¡¶éƒ¨çš„æ•ˆæœ */ .editor-toolbar-container {
  position:sticky;
  top:0;
  z-index:999;
  background-color:#f0f2f5;
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
}
/* æ–°å¢ï¼šå¼¹çª—æ¨¡å¼ä¸‹éšè—å·¥å…·æ  */ .modal-active .editor-toolbar-container {
  display:none;
}
.role-gallery-btn:hover {
  text-decoration:underline;
}
/* æ–°å¢ï¼šå›¾åº“å¼¹çª—çš„æ ·å¼ */ #galleryModal .modal-content {
  width:600px;
  text-align:left;
}
/* å›¾åº“å›¾ç‰‡å®¹å™¨ */ .gallery-image-list {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:10px;
  border:1px dashed #ccc;
  border-radius:8px;
  min-height:100px;
}
/* å•ä¸ªå›¾ç‰‡é¡¹ */ .gallery-image-item {
  position:relative;
  width:100px;
  height:100px;
  border-radius:8px;
  overflow:hidden;
  cursor:pointer;
}
.gallery-image-item img {
  width:100%;
  height:100%;
  object-fit:cover;
}
/* åˆ é™¤æŒ‰é’® */ .gallery-image-item .delete-btn {
  position:absolute;
  top:5px;
  right:5px;
  background-color:rgba(220,53,69,0.8);
  color:white;
  border-radius:50%;
  width:20px;
  height:20px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  cursor:pointer;
  opacity:0;
  transition:opacity 0.2s;
}
.gallery-image-item:hover .delete-btn {
  opacity:1;
}
/* æ·»åŠ å›¾ç‰‡æŒ‰é’® */ .add-image-btn {
  width:100px;
  height:100px;
  background-color:#f7f9fc;
  border:1px dashed #ddd;
  border-radius:8px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:2rem;
  color:#ccc;
  cursor:pointer;
  transition:background-color 0.2s,color 0.2s;
}
.add-image-btn:hover {
  background-color:#e6f7ff;
  color:#0077cc;
}
/* ------------------------------------------- */ /* æ–°å¢ï¼šåª’ä½“æŸ¥è¯¢ - é’ˆå¯¹æ‰‹æœºç«¯å¸ƒå±€ä¼˜åŒ–ï¼ˆæœ€å¤§å®½åº¦ 768pxï¼‰ */ /* ------------------------------------------- */ @media (max-width:768px) {
  /* æ•´ä½“å®¹å™¨ï¼šæ”¹ä¸ºä¸Šä¸‹å †å å¸ƒå±€ */ .page-container,.editor-container {
  flex-direction:column;
}
/* ä¾§è¾¹æ ï¼šå˜ä¸ºå…¨å®½ï¼Œå¹¶è°ƒæ•´é¡ºåº */ .sidebar-nav,.right-sidebar {
  width:100%;
  padding:20px 15px;
  border-right:none;
  border-left:none;
  border-bottom:1px solid #eee;
  /* åœ¨åº•éƒ¨æ·»åŠ åˆ†éš”çº¿ */ position:relative;
  /* å–æ¶ˆå›ºå®šå®šä½ï¼Œè®©å…¶éšé¡µé¢æ»šåŠ¨ */ order:3;
  /* å°†å·¦ä¾§å¯¼èˆªæ æ”¾åˆ°æœ€å */
}
/* ä¸»å†…å®¹åŒºåŸŸï¼šå˜ä¸ºå…¨å®½ï¼Œå¹¶è°ƒæ•´å¤–è¾¹è· */ /* .main-content åŒ…å«äº† .editor-main å’Œå…¶ä»–å†…å®¹ï¼Œæˆ‘ä»¬å‡è®¾ç¼–è¾‘å™¨é¡µé¢ä½¿ç”¨çš„æ˜¯è¿™ä¸ªç»“æ„ */ .main-content {
  width:100%;
  padding:0;
  /* ç§»é™¤å·¦å³å†…è¾¹è·ï¼Œè®©å­å…ƒç´ æ§åˆ¶è‡ªå·±çš„è¾¹è· */ margin-right:0;
  /* ç§»é™¤å³ä¾§å¤–è¾¹è· */ order:2;
  /* å°†ä¸»å†…å®¹åŒºåŸŸï¼ˆåŒ…å«ç¼–è¾‘å™¨ä¸»ä½“ï¼‰æ”¾åœ¨ä¸­é—´ï¼Œä½†æˆ‘ä»¬éœ€è¦è°ƒæ•´å­å…ƒç´ çš„æ’åˆ— */ /* æ–°å¢ï¼šåœ¨æ‰‹æœºç«¯ï¼Œå°† main-content å†…éƒ¨çš„å…ƒç´ ä¹Ÿå‚ç›´æ’åˆ—ï¼Œä»¥æ”¯æŒå·¥å…·æ å’Œç¼–è¾‘å™¨ä¸»ä½“çš„é¡ºåºæ§åˆ¶ */ display:flex;
  flex-direction:column;
}

/* ç¼–è¾‘å™¨ä¸»åŒºåŸŸï¼šè°ƒæ•´é¡ºåºå’Œå†…è¾¹è· */ /* .editor-main åŒ…å« Quill ç¼–è¾‘å™¨æœ¬ä½“ï¼Œå®ƒåº”è¯¥ç´§è·Ÿåœ¨ fixed çš„å·¥å…·æ ä¸‹æ–¹ */ .editor-main {
  flex-grow:1;
  padding:15px;
  /* æ¢å¤æ­£å¸¸çš„å†…è¾¹è· */ margin:0;
  /* ç§»é™¤åŸæœ‰å¤–è¾¹è· */ order:2;
  /* ç´§éšå·¥å…·æ ä¹‹å */ /* æ–°å¢ï¼šä¸º fixed çš„å·¥å…·æ ç•™å‡ºç©ºé—´ï¼Œé˜²æ­¢å†…å®¹è¢«é®æŒ¡ */ padding-top:70px;
  /* å‡è®¾å·¥å…·æ é«˜åº¦çº¦ä¸º 50pxï¼Œè¿™é‡Œç•™å‡º 70px ç¡®ä¿å®‰å…¨è¾¹è· */
}
/* ç¼–è¾‘å™¨æœ¬èº«ï¼šè°ƒæ•´æœ€å¤§å®½åº¦ */ #editor {
  max-width:100%;
  margin:0;
  padding:10px;
}
/* é¡¶éƒ¨æ ‡é¢˜å’ŒæŒ‰é’®ï¼šå˜ä¸ºä¸Šä¸‹å †å  */ .content-header {
  flex-direction:column;
  align-items:flex-start;
  gap:10px;
  margin-bottom:15px;
}
/* æ ‡é¢˜åŒºåŸŸï¼šè°ƒæ•´æ ·å¼ */ .header-title h2 {
  font-size:1.2rem;
}
/* å·¥å…·æ æŒ‰é’®ï¼šè°ƒæ•´é—´è·å’Œæ ·å¼ */ #toolbar-quill {
  gap:8px;
  justify-content:flex-start;
  /* æ‰‹æœºç«¯å·¦å¯¹é½æ›´å¸¸è§ */
}
/* å¼¹çª—å†…å®¹ï¼šé€‚åº”å°å±å¹• */ .modal-content {
  width:95%;
  margin:10% auto;
}
}/* ------------------------------------------- */ /* ä¿®æ­£ï¼šéšè—æ–‡å­— (Spoiler) Blotçš„CSS */ /* ------------------------------------------- */ /* æ–°å¢ï¼šç¡®ä¿ modal-active ç±»èƒ½å¤Ÿéšè— Quill å·¥å…·æ ï¼ˆå¦‚æœå®ƒè¢«å…¨å±€æ ·å¼æ§åˆ¶çš„è¯ï¼‰ */ .modal-active #toolbar-quill {
  /* å‡è®¾æ‚¨çš„ Quill å·¥å…·æ ä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å…ƒç´  */ z-index:1;
  /* ç¡®ä¿å®ƒåœ¨ modal ä¸‹é¢ */
}
/* Base style for both modes */ .ql-editor .spoiler-hidden {
  /* é»˜è®¤éšè—æ ·å¼ï¼šä½¿ç”¨ç™½è‰²èƒŒæ™¯ (#fff) é®ç›–é»‘è‰²æ–‡å­—ï¼Œè¾¾åˆ°éšè—æ•ˆæœ */ background-color:#000;
  /* å‡è®¾ç¼–è¾‘å™¨çš„åº•è‰²æ˜¯ç™½è‰² */ color:#000;
  /* æ–‡å­—é¢œè‰²ä¹Ÿè®¾ä¸ºç™½è‰²ï¼Œè¢«èƒŒæ™¯è‰²è¦†ç›– */ padding:0 4px;
  border-radius:2px;
  transition:color 0.3s,background-color 0.3s;
}
/* æ¨¡å¼ 1:å‰§é€æ¨¡å¼ (é¼ æ ‡æ‚¬åœå³æ˜¾ç¤º) */ .ql-editor .spoiler-hidden[data-mode="spoiler"] {
  cursor:pointer;
}
.ql-editor .spoiler-hidden[data-mode="spoiler"]:hover {
  /* æ‚¬åœæ—¶ï¼šå°†æ–‡å­—é¢œè‰²æ”¹ä¸ºé»‘è‰²ï¼ŒèƒŒæ™¯è‰²æ”¹ä¸ºé€æ˜ï¼ˆæˆ–ç™½è‰²ï¼‰ï¼Œæ˜¾ç¤ºæ­£å¸¸æ–‡æœ¬ */ color:#000;
  /* æ–‡å­—é¢œè‰²æ”¹ä¸ºé»‘è‰² */ background-color:transparent;
  /* èƒŒæ™¯è‰²æ”¹ä¸ºé€æ˜æˆ–ç™½è‰² */
}
/* æ¨¡å¼ 2:æš—éª°æ¨¡å¼ (åœ¨ç¼–è¾‘å™¨å†…å§‹ç»ˆéšè—ï¼Œä¸å“åº”æ‚¬åœ) */ .ql-editor .spoiler-hidden[data-mode="secret"] {
  /* æš—éª°æ¨¡å¼ä»ä½¿ç”¨å¼ºçƒˆçš„é¢œè‰²åŒºåˆ†å’Œæç¤ºï¼Œå¹¶ä¿æŒéšè— */ background-color:#6a0000;
  color:#6a0000;
  cursor:default;
  border:1px solid #999;
}
/* è¦†ç›–ç¼–è¾‘å™¨å†…æ‚¬åœè¡Œä¸ºï¼šæš—éª°åœ¨ç¼–è¾‘å™¨é‡Œä¿æŒéšè— */ .ql-editor .spoiler-hidden[data-mode="secret"]:hover {
  color:#6a0000;
  background-color:#6a0000;
}
/* æ–°å¢ï¼šé¡µç ä¸‹æ‹‰èœå•åº•éƒ¨æŒ‰é’®çš„é€šç”¨æ ·å¼ */ .dropdown-footer-btn {
  width:100%;
  padding:10px;
  border:none;
  cursor:pointer;
  text-align:center;
  border-top:1px solid #ddd;
  transition:background-color 0.2s;
  font-size:14px;
}
/* æ–°å¢ï¼šåˆ é™¤å½“å‰é¡µæŒ‰é’®æ ·å¼ (ä½¿ç”¨çº¢è‰²è¡¨ç¤ºå±é™©æ“ä½œ) */ .delete-page-btn {
  background-color:#fff8f8;
  /* æµ…çº¢è‰²èƒŒæ™¯ */ color:#dc3545;
  /* çº¢è‰²æ–‡å­— */ border-radius:0;
  /* ç¡®ä¿é¡¶éƒ¨æ²¡æœ‰åœ†è§’ */
}
.delete-page-btn:hover {
  background-color:#ffeaea;
  /* æ‚¬åœæ—¶é¢œè‰²åŠ æ·± */
}
/* è°ƒæ•´æ–°å¢é¡µé¢çš„æŒ‰é’®æ ·å¼ï¼Œç§»é™¤å…¶é¡¶éƒ¨è¾¹æ¡†ï¼Œç¡®ä¿åˆ é™¤æŒ‰é’®ç´§è´´å…¶ä¸Š */ .page-select-dropdown .add-page-btn {
  /* ç§»é™¤ä¹‹å‰çš„ border-top:1px solid #ddd;
  é¿å…åŒé‡è¾¹æ¡† */ border-top:none;
  border-radius:0 0 8px 8px;
  /* ç¡®ä¿æ–°å¢é¡µé¢æŒ‰é’®ä»ç„¶åœ¨åº•éƒ¨åœ†è§’ */
}
/* ------------------------------------------- */ /* âœ… å·¥å…·æ å’Œç¼–è¾‘å™¨ä¸»ä½“è·ç¦»ã€æŒ‰é’®åç§»å’Œåˆ†ç»„ä¼˜åŒ– */ /* ------------------------------------------- */ /* 1. å‡å°‘ç¼–è¾‘å™¨å’Œå·¥å…·æ ä¹‹é—´çš„ç°è‰²è·ç¦» */ .editor-main {
  flex-grow:1;
  padding:30px;
  display:flex;
  flex-direction:column;
  background-color:#f0f2f5;
  /* å…³é”®ä¿®æ”¹ï¼šå°† 20px å‡å°åˆ° 5pxï¼Œå¹¶ç§»é™¤å·¦å³è¾¹è·ï¼ˆå¦‚æœçˆ¶å®¹å™¨å·²å¤„ç†ï¼‰ */ margin:5px 0;
}
/* 2. æ¸…ç†å’Œä¼˜åŒ– #toolbar-quill å®¹å™¨ */ #toolbar-quill {
  display:flex;
  justify-content:flex-start;
  /* ä¿æŒå·¦å¯¹é½ */ gap:8px;
  /* æŒ‰é’®ç»„ä¹‹é—´çš„é—´è·ï¼Œä» 5px å¢åŠ åˆ° 8px */ flex-wrap:wrap;
}
/* 3. å®ç°å·¥å…·æ æŒ‰é’®æ•´ä½“å‘å³åç§»ï¼ˆä¸ç§»åŠ¨å·¥å…·æ èƒŒæ™¯å’Œè¾¹æ¡†ï¼‰ */ /* å¯¹ç¬¬ä¸€ä¸ªæŒ‰é’®ç»„è®¾ç½® margin-left */ #toolbar-quill .ql-formats:first-child {
  /* å¢åŠ å·¦å¤–è¾¹è·ï¼Œä½¿æ‰€æœ‰æŒ‰é’®æ•´ä½“å‘å³ç§»åŠ¨ */ margin-left:30px;
  /* ä¿æŒæŒ‰é’®ç»„ä¹‹é—´çš„é—´è· */ margin-right:8px;
}
/* 4. æ¸…ç†å’Œç»Ÿä¸€ ql-formats æ ·å¼ */ .ql-toolbar.ql-snow .ql-formats {
  display:flex;
  align-items:center;
  /* ç§»é™¤å†—ä½™çš„ margin-right:35pxï¼Œä½¿ç”¨ #toolbar-quill çš„ gap:8px å³å¯ */ margin-right:0;
}
/* ç¡®ä¿æ’¤å›/å–æ¶ˆæ’¤å›æŒ‰é’®ä¹‹é—´æœ‰å°çš„é—´è· */ #toolbar-quill .ql-formats:first-child button {
  margin-right:3px;
}
/* 5. æ¸…ç†å’Œä¼˜åŒ– #hiddenTextBtn çš„æ ·å¼ */ #toolbar-quill .ql-formats:nth-child(2) {
  /* ä¿æŒ â€œéšè—æ–‡æœ¬â€ æŒ‰é’®åœ¨è‡ªå·±çš„ç»„å†…å‚ç›´å±…ä¸­ */ display:flex;
  align-items:center;
}
#hiddenTextBtn {
  /* ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ª #hiddenTextBtn æ ·å¼å—ï¼Œå¹¶åˆ é™¤é‡å¤çš„å®šä¹‰ */ display:inline-flex;
  align-items:center;
  justify-content:center;
  white-space:nowrap;
  padding:6px 12px;
  /* ç»Ÿä¸€å†…è¾¹è· */ min-width:fit-content;
  font-size:14px;
  border:1px solid #ccc;
  border-radius:4px;
  background-color:#fff;
  color:#000;
  line-height:1.2;
  box-sizing:border-box;
  margin:0;
  /* ç¡®ä¿è‡ªèº«æ²¡æœ‰å¤–éƒ¨è¾¹è· */
}
#hiddenTextBtn:hover {
  background-color:#e6f7ff;
  border-color:#0077cc;
  color:#0077cc;
}
/* ---------- ğŸ“± æ‰‹æœºç«¯ä¼˜åŒ– ---------- */ @media (max-width:768px) {
  .page-container {
  flex-direction:column;
}
.main-content {
  margin-right:0;
  padding:10px;
}
.right-sidebar {
  position:static;
  width:100%;
  height:auto;
  border-left:none;
  padding:10px;
  overflow-y:visible;
}
.editor-container {
  flex-direction:column;
}
.editor-main {
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
}/* ============ æ–°ç‰ˆå³ä¾§æµ®çª—ï¼ˆå–ä»£åŸå›ºå®šå³æ ï¼‰ ============ */ /* æµ®åŠ¨æŒ‰é’® */ /* é»˜è®¤ï¼ˆPCï¼‰éšè—æŒ‰é’®ï¼Œåªåœ¨æ‰‹æœºç«¯æ˜¾ç¤º */
.floating-sidebar-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 80px;
  height: 80px;
  border-radius: 10px;          /* å°åœ†è§’æ–¹å— */
  background-color: #0077cc;
  color: #fff;
  border: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  cursor: pointer;
  display: none;                /* PC ç«¯éšè—ï¼Œåœ¨æ‰‹æœºç«¯ç”¨ @media æ‰“å¼€ */
  justify-content: center;
  align-items: center;
  flex-direction: column;       /* å›¾æ ‡åœ¨ä¸Šã€æ–‡å­—åœ¨ä¸‹ */
  gap: 4px;
  z-index: 9999;
  transition: transform 0.2s ease, background-color 0.2s ease;
}

.floating-sidebar-btn:hover {
  background-color: #005fa3;
  transform: translateY(-2px);
}

.floating-sidebar-icon {
  width: 26px;
  height: 26px;
}

.floating-sidebar-label {
  font-size: 12px;
  line-height: 1.2;
}

.floating-sidebar-btn:hover {
  background-color:#005fa3;
  transform:scale(1.05);
}
/* æµ®çª—å†…å®¹ */ .floating-sidebar {
  position:fixed;
  bottom:80px;
  right:20px;
  width:90vw;
  max-width:320px;
  height:70vh;
  background-color:#f7f9fc;
  border-radius:12px;
  box-shadow:0 6px 15px rgba(0,0,0,0.15);
  padding:16px;
  overflow-y:auto;
  z-index:9998;
  transform:translateY(20px);
  opacity:0;
  pointer-events:none;
  transition:all 0.3s ease;
}
/* æ‰“å¼€æ—¶ */ .floating-sidebar.open {
  transform:translateY(0);
  opacity:1;
  pointer-events:all;
}
/* å³ä¸Šè§’å…³é—­æŒ‰é’® */ .floating-sidebar .close-btn {
  position:absolute;
  top:10px;
  right:10px;
  border:none;
  background:none;
  font-size:20px;
  color:#666;
  cursor:pointer;
}
.floating-sidebar .close-btn:hover {
  color:#000;
}
/* æ‰‹æœºç«¯ä¼˜åŒ–ï¼šæŒ‰é’®ç¨å¤§ä¸€ç‚¹ */ @media (max-width:768px) {
  .floating-sidebar-btn {
  width:56px;
  height:56px;
  bottom:15px;
  right:15px;
  font-size:20px;
}
}

  /* ------------------------------------------- */
/* æ‰‹æœºç«¯æ¨¡å¼ï¼šç§»é™¤å³ä¾§å·¥å…·æ ï¼Œæ”¹ä¸ºæµ®çª—æŒ‰é’®æ¨¡å¼ */
/* ------------------------------------------- */
@media (max-width: 768px) {

  /* éšè—åŸå³ä¾§å›ºå®šå·¥å…·æ  */
  .right-sidebar {
    display: none !important;
  }

  /* æ·»åŠ å³ä¸‹è§’æµ®çª—æŒ‰é’® */
  .floating-tool-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background-color: #0077cc;
    color: white;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    cursor: pointer;
    z-index: 1001;
    transition: background-color 0.3s ease;
  }

  .floating-tool-btn:hover {
    background-color: #005fa3;
  }

  /* æµ®çª—å¼¹å‡ºé¢æ¿æ ·å¼ */
  .floating-tool-panel {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 85%;
    max-width: 360px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
    flex-direction: column;
    padding: 20px;
    animation: slideUp 0.3s ease-out;
  }

  /* æ‰“å¼€æ—¶æ˜¾ç¤º */
  .floating-tool-panel.active {
    display: flex;
  }

  /* åŠ¨ç”»æ•ˆæœ */
  @keyframes slideUp {
    from { transform: translateY(40px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
}

/* âœ… 1ï¸âƒ£ åªå›ºå®šå·¥å…·æ ï¼ˆè€Œä¸æ˜¯æ•´ä¸ªç¼–è¾‘åŒºï¼‰ */
.editor-toolbar-container {
  position: sticky;  /* å·¥å…·æ å›ºå®šåœ¨é¡¶éƒ¨ */
  top: 0;
  z-index: 999;
  background-color: #f0f2f5;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* âœ… 2ï¸âƒ£ ç¼–è¾‘å™¨ä¸»ä½“ä¸è¦å— sticky å½±å“ï¼Œè®©å®ƒæ­£å¸¸æ»šåŠ¨ */
.editor-main {
  flex-grow: 1;
  overflow-y: auto;  /* å…è®¸æ»šåŠ¨ */
  padding: 30px;
  margin: 0;         /* å»æ‰å¤šä½™å¤–è¾¹è·ï¼Œé¿å…ä¸ toolbar å å±‚ */
}

/* âœ… 3ï¸âƒ£ Quill è¾“å…¥åŒºæœ¬èº«éå›ºå®š */
#editor, .ql-container, .ql-editor {
  position: static !important;  /* é˜²æ­¢è·Ÿéš sticky çš„å®¹å™¨å¸é™„ */
}

  /* ============ æ–°ç‰ˆå³ä¾§æµ®çª—ï¼ˆå–ä»£åŸå›ºå®šå³æ ï¼‰ ============ */

/* é»˜è®¤ï¼ˆPCï¼‰éšè—æŒ‰é’®ï¼Œåªåœ¨æ‰‹æœºç«¯æ˜¾ç¤º */
.floating-sidebar-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 80px;
  height: 80px;
  border-radius: 10px;          /* å°åœ†è§’æ–¹å— */
  background-color: #0077cc;
  color: #fff;
  border: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  cursor: pointer;
  display: none;                /* PC ç«¯éšè—ï¼Œåœ¨æ‰‹æœºç«¯ç”¨ @media æ‰“å¼€ */
  justify-content: center;
  align-items: center;
  flex-direction: column;       /* å›¾æ ‡åœ¨ä¸Šã€æ–‡å­—åœ¨ä¸‹ */
  gap: 4px;
  z-index: 9999;
  transition: transform 0.2s ease, background-color 0.2s ease;
}

.floating-sidebar-btn:hover {
  background-color: #005fa3;
  transform: translateY(-2px);
}

.floating-sidebar-icon {
  width: 26px;
  height: 26px;
}

.floating-sidebar-label {
  font-size: 12px;
  line-height: 1.2;
}


@media (max-width: 768px) {
  .floating-sidebar-btn {
    display: flex;          /* æ‰‹æœºä¸Šæ˜¾ç¤º */
    right: 16px;
    bottom: 16px;
    top: auto;              /* é¿å…ä»¥å‰å†™çš„ top:50% ä¹‹ç±»ç»§ç»­ç”Ÿæ•ˆ */
    transform: none;        /* æ¸…ç†æ—§çš„ translateY(-50%) */
  }

  /* æµ®çª—æœ¬ä½“ä¹Ÿå¯ä»¥ä¿æŒä½ ç°åœ¨çš„è®¾ç½®ï¼Œç•¥å¾®è°ƒæ•´å°ºå¯¸å³å¯ */
  .floating-sidebar {
    position: fixed;
    right: 16px;
    bottom: 104px;          /* æŒ‰é’®ä¸Šæ–¹ç•™ä¸€ç‚¹ç©ºé—´ */
    width: 80vw;
    max-width: 320px;
    height: 60vh;
    border-radius: 12px;
    background-color: #fff;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    padding: 16px;
    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .floating-sidebar.open {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0);
  }
}



  #autoSaveToggleBtn {
    margin-left: 10px;
    padding: 8px 12px;
    font-size: 0.9rem;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid #0077cc;
    transition: background-color 0.2s, color 0.2s;
}

/* å¼€å¯çŠ¶æ€ï¼ˆé»˜è®¤ï¼‰ */
.autosave-on {
    background-color: #e6f7ff;
    color: #0077cc;
}

/* å…³é—­çŠ¶æ€ */
.autosave-off {
    background-color: #f8f9fa;
    color: #555;
    border-color: #999;
}

/* æ•´ä¸ªå›¾åº“æµ®çª—é®ç½©å±‚ */
#galleryModal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;              /* é»˜è®¤éšè—ï¼ŒJS ç”¨ display:flex æ‰“å¼€ */
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

/* æµ®çª—æœ¬ä½“ï¼šåŠ å®½åŠ é«˜ */
#galleryModal .gallery-modal-content {
  width: min(1100px, 96vw);   /* æ¯”åŸæ¥å®½å¾ˆå¤š */
  max-height: 90vh;           /* æ¥è¿‘å…¨å±é«˜åº¦ */
  background: #fff;
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);

  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* å›¾ç‰‡åˆ—è¡¨åŒºåŸŸå¯æ»šåŠ¨ */
#galleryImageList {
  flex: 1;
  overflow-y: auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  padding-right: 4px;
}

  /* å•ä¸ªå›¾ç‰‡æ ¼å­ */
.gallery-image-item {
  position: relative;
  background: #f8f8f8;
  border-radius: 8px;
  padding: 6px 6px 4px;
  box-sizing: border-box;
}

/* ç¼©ç•¥å›¾å®¹å™¨ï¼Œä¿æŒå¤§è‡´æ¯”ä¾‹ä½†ä¸è£æ‰å¤´ */
.gallery-image-item .thumb-wrapper {
  width: 100%;
  /* ç»™ä¸ªå¤§è‡´æ¯”ä¾‹ï¼Œæ¯”å¦‚ç«‹ç»˜å¸¸è§ 3:4ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹æˆ 2:3 ç­‰ */
  aspect-ratio: 3 / 4;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* å…³é”®ï¼šç”¨ contain è€Œä¸æ˜¯ coverï¼Œä¿è¯æ•´å¼ å›¾éƒ½è¿›æ¥ */
.gallery-image-item img {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  display: block;
}

/* æ–‡ä»¶å / è¡¨æƒ…å */
.gallery-image-item .img-name {
  margin-top: 4px;
  font-size: 12px;
  line-height: 1.2;
  text-align: center;
  color: #555;
  word-break: break-all;
}

/* åˆ é™¤æŒ‰é’®ä¿æŒå³ä¸Šè§’å°å‰ */
.gallery-image-item .delete-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-size: 12px;
  line-height: 18px;
  text-align: center;
  cursor: pointer;
}
/* å·¦ä¸Šè§’â€œå±•å¼€â€æŒ‰é’® */
.gallery-image-item .expand-btn {
  position: absolute;
  top: 4px;
  left: 4px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-size: 12px;
  line-height: 20px;
  text-align: center;
  cursor: pointer;
  z-index: 2;
}
/* å¤§å›¾é¢„è§ˆé®ç½©å±‚ */
.gallery-preview-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 11000; /* æ¯”å›¾åº“å¼¹çª—ç•¥é«˜ */
}

.gallery-preview-overlay.open {
  display: flex;
}

.gallery-preview-content {
  max-width: 90vw;
  max-height: 90vh;
  position: relative;
}

.gallery-preview-content img {
  max-width: 100%;
  max-height: 100%;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
}

.gallery-preview-close {
  position: absolute;
  top: -12px;
  right: -12px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: #fff;
  cursor: pointer;
  font-size: 18px;
  line-height: 28px;
}

  @media (max-width: 768px) {
  /* å·¥å…·æ æ•´ä½“ä¸Šä¸‹æ’å¸ƒï¼Œé¿å…ä¸€è¡ŒæŒ¤çˆ† */
  .editor-toolbar {
    flex-wrap: wrap;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .editor-title {
    width: 100%;
    margin-right: 0;
  }

  .page-controls {
    margin-right: 0;
    margin-top: 4px;
  }

  /* ä¿å­˜ / å‘å¸ƒæŒ‰é’®ç»„ï¼šä¸¤åˆ—æ’å¸ƒï¼Œä¾¿äºç‚¹å‡» */
  .editor-toolbar-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
  }

  .editor-toolbar-actions button {
    flex: 1 0 calc(50% - 6px); /* æ¯è¡Œå¤§æ¦‚ä¸¤ä¸ªæŒ‰é’® */
    font-size: 0.9rem;
    padding: 6px 4px;
  }

  /* ç¼–è¾‘æ­£æ–‡åœ¨æ‰‹æœºç«¯ä¸Šä¸‹ç•™ç™½ç¨å¾®æ”¶ç´§ä¸€ç‚¹ */
  .editor-main {
    padding: 16px 10px 20px;
    margin: 0;
  }
}

</style>
  
<body>
    <div class="page-container">

        <div id="create-modal" class="modal">
            <div class="modal-content">
                <h3>ä½œå“å</h3>
                <input type="text" id="work-title-input" placeholder="è¯·è¼¸å…¥ä½œå“å" maxlength="100">
                <div class="modal-buttons">
                    <button id="cancel-btn">å–æ¶ˆ</button>
                    <button id="confirm-btn">ç¡®å®š</button>
                </div>
                <p id="create-message" style="color:red; font-size: 0.9em; margin-top: 10px;"></p>
            </div>
        </div>

        <div id="delete-modal" class="modal">
            <div class="modal-content menu-modal-content">
                <h3>ç¡®è®¤åˆªé™¤ï¼Ÿ</h3>
                <p>æ­¤æ“ä½œä¸å¯æ¢å¾©ã€‚</p>
                <div class="modal-buttons">
                    <button id="delete-cancel-btn">å¦</button>
                    <button id="delete-confirm-btn">æ˜¯</button>
                </div>
            </div>
        </div>

        <div id="bulk-delete-modal" class="modal">
            <div class="modal-content">
                <h3>é€‰æ‹©è¦åˆªé™¤çš„ä½œå“</h3>
                <p style="color: #dc3545; font-size: 0.9em;">è­¦å‘Šï¼šåˆªé™¤åæ— æ³•æ¢å¤ï¼</p>
                <div class="delete-list"></div>
                <div class="delete-buttons">
                    <button id="bulk-delete-cancel-btn" class="back-button">å–æ¶ˆ</button>
                    <button id="bulk-delete-confirm-btn" class="back-button">ç¡®è®¤åˆªé™¤</button>
                </div>
            </div>
        </div>

        <aside class="sidebar-nav" id="sidebar">
            <a href="#" class="nav-link active">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M12 12V4h6l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2h12a2 2 0 0 0 2-2V12z" />
                    </svg>
                </div>
                <span class="nav-text">ä½œå“åˆ—è¡¨</span>
            </a>

            <a href="https://zhidianworld.com/pictureshare/" class="nav-link">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9V9h2v8zm4 0h-2V9h2v8z" />
                    </svg>
                </div>
                <span class="nav-text">å…±äº«ç´ æåº“</span>
            </a>

          <a href="https://zhidianworld.com/effect/" class="nav-link">
    <div class="nav-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L15 8l6 .5-4.5 4 1 6-5-3-5 3 1-6L3 8.5 9 8z" />
        </svg>
    </div>
    <span class="nav-text">â­æ¸²æŸ“ç‰¹æ•ˆ</span>
</a>

            <a href="https://zhidianworld.com/usercenter/" class="nav-link">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                </div>
                <span class="nav-text">ä¸ªäººä¸­å¿ƒ</span>
            </a>

            <a href="https://zhidianworld.com/home/" class="nav-link">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-8h-2v8zm4 0h-2v-8h2v8z" />
                    </svg>
                </div>
                <span class="nav-text">å®‰ç§‘é˜…è¯»</span>
            </a>

            <a href="#" class="nav-link" id="logout-btn">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zm-8 4H2v2h7v-2zM4 22h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2z" />
                    </svg>
                </div>
                <span class="nav-text">é€€å‡ºç™»éŒ„</span>
            </a>
        </aside>

        <main id="main-page" class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <div class="header-title">
                        <span class="icon-plane">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                                fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21 12l-18-9v18l18-9z" />
                            </svg>
                        </span>
                        <h2>ä½œå“åˆ—è¡¨ (<span id="work-count">0</span>)</h2>
                    </div>
                    <button id="create-btn" class="create-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                            fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                        <span>æ–°å»ºä½œå“</span>
                    </button>
                    <button id="bulk-delete-btn" class="create-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                            fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.88l1.06-1.06L12 12.94l2.48-2.48 1.06 1.06L13.06 14l2.48 2.48-1.06 1.06L12 15.06l-2.48 2.48-1.06-1.06L10.94 14l-2.48-2.48zM15.5 4l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6v2h12V4h-2.5z" />
                        </svg>
                        <span>åˆªé™¤ä½œå“</span>
                    </button>
                </div>
                <div class="header-right">
                    <div class="sort-dropdown">
                        <button class="sort-button">
                            <span>æœ€è¿‘æ‰“å¼€</span>
                            <span class="sort-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                                    fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M7 10l5 5 5-5z" />
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="work-list">
                <p style="text-align: center; color: #999; margin-top: 50px;">æ­£åœ¨åŠ è½½ä½œå“...</p>
            </div>
        </main>

        <main id="editor-page" class="main-content hidden">
            <div class="editor-toolbar-container">
                <div class="editor-toolbar">
                    <button class="back-button" id="backBtn">è¿”å›</button>
                    <div class="editor-title" id="editorTitle"></div>
                    <div class="page-controls">
                        <div class="page-current" id="pageCurrentDisplay">
                            ç¬¬ <span id="currentPage">1</span> é¡µï¼ˆå±•å¼€ï¼‰
                        </div>
                        <div class="page-select-dropdown hidden" id="pageDropdown">
                            <ul id="pageList">
                            </ul>
                            <button class="add-page-btn" id="addPageBtn">æ–°å¢é¡µé¢</button>
                            <button class="delete-page-btn" id="deletePageBtn">åˆªé™¤é¡µé¢</button> </div>
                    </div>
                   <div class="editor-toolbar-actions">
    <button class="back-button" id="localSaveBtn">ä¿å­˜åˆ°æœ¬åœ°</button>
    <button class="back-button" id="saveBtn">ä¿å­˜è‰ç¨¿</button>
    <button id="autoSaveToggleBtn" class="autosave-on">è‡ªåŠ¨ä¿å­˜ï¼šå¼€</button>
    <button class="back-button" id="publishBtn">å‘å¸ƒ</button>
</div>


                </div>

                <div id="toolbar-quill" class="ql-toolbar ql-snow">
    <span class="ql-formats">
        <button class="ql-undo">
            <svg viewBox="0 0 18 18">
                <path d="M6 10l-4-4 4-4v3h7v2H6v3z"></path>
            </svg>
        </button>
        <button class="ql-redo">
            <svg viewBox="0 0 18 18">
                <path d="M12 10v-3H5V5h7V2l4 4-4 4z"></path>
            </svg>
        </button>
    </span>

    <span class="ql-formats">
        <button id="hiddenTextBtn" title="éšè—æ–‡æœ¬è®¾ç½®ï¼ˆå‰§é€/æš—éª°ï¼‰">éšè—æ–‡æœ¬</button>
    </span>
    
    <button class="ql-bold back-button">B</button>
    <button class="ql-italic back-button">I</button>
    <button class="ql-underline back-button">U</button>
    <button class="ql-strike"></button>
    <select class="ql-color"></select>
    <select class="ql-background"></select>
    
    <span class="ql-formats">
        <select class="ql-header">
            <option value="1"></option>
            <option value="2"></option>
            <option selected></option>
        </select>
        <button id="diceBtn">ğŸ²</button>
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
    </span>
    <button class="back-button" id="listBtn">L10</button>
    <button id="insertThemeTriggerBtn" title="æ’å…¥ä¸»é¢˜åˆ‡æ¢æ ‡è®°">ğŸ¨</button>
    
    <span class="ql-formats">
        <button id="uploadImageBtn">ğŸ–¼ï¸</button>
        <input type="file" id="uploadImageInput" accept="image/*" style="display:none;">
    </span>
</div>
            <div class="editor-main full-screen">
                <div class="editor-container">
                    <div class="editor-main">
                        <div id="editor"></div>
                        <textarea id="plainEditor" class="hidden"></textarea>
                    </div>
                    <aside id="rightSidebar" class="right-sidebar">
                        <div class="tool-section">
                            <h3>å·¥å…·</h3>

                            <div class="dropdown-container">
                                <div class="dropdown-header" id="roleDropdownHeader">
                                    <span>è§’è‰²</span>
                                    <span class="arrow">&gt;</span>
                                </div>
                                <div class="dropdown-content" id="roleDropdownContent">
                                    <ul class="role-list" id="roleList">
                                    </ul>
                                    <button class="add-role-btn" id="addRoleBtn">æ·»åŠ è§’è‰²</button>
                                </div>
                            </div>

                            <div class="dropdown-container">
                                <div class="dropdown-header" id="historyDropdownHeader">
                                    <span>å†å²è®°å½•</span>
                                    <span class="arrow">&gt;</span>
                                </div>
                                <div class="dropdown-content" id="historyDropdownContent">
                                    <ul id="historyList"></ul>
                                </div>
                            </div>

                            <div class="dropdown-container">
                                <div class="dropdown-header" id="diceLogDropdownHeader">
                                    <span>ğŸ² éª°å­è®°å½•</span>
                                    <span class="arrow">&gt;</span>
                                </div>
                                <div class="dropdown-content open" id="diceLogDropdownContent">
                                    <ul class="role-list" id="diceLogList"
                                        style="list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto;">
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </aside>
                    <div id="rightSidebarToggle" class="right-sidebar-toggle"></div>
                </div>
            </div>
        </main>
        <div id="roleModal" class="modal">
            <div class="modal-content">
                <h3>æ·»åŠ /ç¼–è¾‘è§’è‰²</h3>
                <label for="roleNameInput">åç§°</label>
                <input type="text" id="roleNameInput" placeholder="è¯·è¼¸å…¥è§’è‰²åç§°">

                <label for="roleNotesTextarea">å¤‡æ³¨</label>
                <textarea id="roleNotesTextarea" rows="4" placeholder="è¯·è¼¸å…¥è§’è‰²å¤‡æ³¨"></textarea>

                <div class="color-picker-wrapper">
                    <label for="roleColorPicker">é€‰å–é¢œè‰²</label>
                    <input type="color" id="roleColorPicker" class="color-picker" value="#000000">
                </div>

                <div class="modal-buttons">
                    <button class="cancel" id="cancelRoleBtn">å–æ¶ˆ</button>
                    <button class="confirm" id="confirmRoleBtn">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <div id="galleryModal" class="modal">
    <div class="modal-content gallery-modal-content">
        <h3>ç¼–è¾‘å›¾åº“</h3>
        <div class="gallery-image-list" id="galleryImageList">
            <label for="imageUploadInput" class="add-image-btn">
                <span>+</span>
                <input type="file" id="imageUploadInput" accept="image/*" multiple style="display:none;">
            </label>
        </div>
        <div class="modal-buttons">
            <button class="cancel" id="cancelGalleryBtn">å–æ¶ˆ</button>
            <button class="confirm" id="confirmGalleryBtn">ç¡®è®¤</button>
        </div>
    </div>
</div>

      <!-- æ–°å¢ï¼šå›¾åº“å¤§å›¾é¢„è§ˆæµ®å±‚ -->
<div id="galleryPreviewOverlay" class="gallery-preview-overlay">
  <div class="gallery-preview-content">
    <button id="galleryPreviewClose" class="gallery-preview-close">Ã—</button>
    <img id="galleryPreviewImage" src="" alt="é¢„è§ˆå›¾ç‰‡">
  </div>
</div>

        <div id="hiddenTextModal" class="modal hidden">
            <div class="modal-content hidden-text-modal-content">
                <h3>è¯·é€‰æ‹©éšè—æ¨¡å¼</h3>
                <p>æ‚¨é€‰ä¸­çš„æ–‡æœ¬å°†ä»¥éšè—æ ·å¼æ˜¾ç¤ºï¼š</p>

                <button id="hiddenTextSpoilerOption" class="btn btn-primary">
                    1. ğŸ’¬ å‰§é€æ¨¡å¼ (é¼ æ ‡æ‚¬åœå³æ˜¾ç¤º)
                </button>

                <button id="hiddenTextSecretOption" class="btn btn-warning">
                    2. ğŸ² æš—éª°æ¨¡å¼ (éœ€ç‚¹å‡»å¹¶è­¦å‘Šåæ‰æ˜¾ç¤º)
                </button>

                <button id="hiddenTextCloseBtn" class="btn btn-secondary close-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

<button class="floating-sidebar-btn" id="toggleSidebarBtn">
  <svg class="floating-sidebar-icon" xmlns="http://www.w3.org/2000/svg" 
       viewBox="0 0 24 24" fill="none" stroke="currentColor" 
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- ç®€å•çš„å·¥å…·ç®±å›¾æ ‡ -->
    <rect x="3" y="8" width="18" height="11" rx="2" ry="2"></rect>
    <path d="M9 8V6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
    <path d="M3 12h18"></path>
    <path d="M10 12v3"></path>
    <path d="M14 12v3"></path>
  </svg>
  <span class="floating-sidebar-label">åˆ›ä½œå·¥å…·</span>
</button>


<div class="floating-sidebar" id="floatingSidebar">
  <div class="floating-sidebar-header">
    <span class="floating-sidebar-title">å·¥å…·æ </span>
    <button class="close-btn" id="closeSidebarBtn">âœ•</button>
  </div>

  <hr>

  <!-- è¿™å—æ˜¯æ‰‹æœºæµ®çª—çœŸæ­£çš„å†…å®¹åŒºåŸŸï¼Œç¨åç”¨ JS æŠŠ rightSidebar çš„å†…å®¹æ¬è¿›æ¥ -->
  <div class="floating-sidebar-body" id="floatingSidebarBody">
    <!-- JS ä¼šåœ¨æ‰‹æœºç«¯æŠŠ #rightSidebar é‡Œçš„å·¥å…·åˆ—è¡¨ç§»åˆ°è¿™é‡Œ -->
  </div>
</div>

  
    </body>
  
  <script src="https://api.anchorx.ca/vendor_assets/quill.js"></script>
  <script src="https://api.anchorx.ca/vendor_assets/browser-image-compression.js"></script>
  
<script>
    /* --------- å®‰å…¨æ£€æŸ¥ï¼ˆtokenï¼‰--------- */
    const token = localStorage.getItem('token');
    if (!token) {
        alert('è¯·å…ˆç™»å½•ä»¥è®¿é—®æ­¤é¡µé¢ã€‚');
        window.location.href = 'https://zhidianworld.com/login/';
    }

    /* ---------- åˆå§‹åŒ– Quill ---------- */
    const quill = new Quill('#editor', {
        modules: {
            toolbar: '#toolbar-quill'
        },
        theme: 'snow'
    });

    /* --------- è¿›å…¥ DOMContentLoaded ååˆå§‹åŒ–æ‰€æœ‰é€»è¾‘ --------- */
    document.addEventListener('DOMContentLoaded', () => {

      // ã€æ–°å¢ï¼šè‡ªåŠ¨ä¿å­˜çŠ¶æ€ã€‘
let autoSaveTimer = null;
let hasUnsavedChanges = false;
let isSaving = false; // é˜²æ­¢å¤šé‡ä¿å­˜è¯·æ±‚
      let autoSaveEnabled = true;


        /* ---------- DOM å…ƒç´ ï¼ˆæŒ‰ä½ é¡µé¢çš„ id/class åç§°æ¥æ‰¾ï¼‰---------- */
        const mainPage = document.getElementById('main-page');
        const editorPage = document.getElementById('editor-page');
        const editorTitle = document.getElementById('editorTitle');
        const backBtn = document.getElementById('backBtn');
        const sidebar = document.getElementById('sidebar');
        const workList = document.querySelector('.work-list');
        const workCountSpan = document.getElementById('work-count');

        // æ–°å»ºå¼¹çª—å…ƒç´ 
        const createBtn = document.getElementById('create-btn');
        const createModal = document.getElementById('create-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const workTitleInput = document.getElementById('work-title-input');
        const createMessage = document.getElementById('create-message');

        // åˆªé™¤å¼¹çª—
        const deleteModal = document.getElementById('delete-modal');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        let workToDelete = null;

        // æ‰¹é‡åˆªé™¤
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkDeleteModal = document.getElementById('bulk-delete-modal');
        const bulkDeleteList = bulkDeleteModal.querySelector('.delete-list');
        const bulkDeleteConfirmBtn = document.getElementById('bulk-delete-confirm-btn');
        const bulkDeleteCancelBtn = document.getElementById('bulk-delete-cancel-btn');

        // ç¼–è¾‘å™¨ç›¸å…³
        const saveBtn = document.getElementById('saveBtn');
      const localSaveBtn = document.getElementById('localSaveBtn'); // âœ… æ–°å¢ï¼šæœ¬åœ°ä¿å­˜æŒ‰é’®
        const publishBtn = document.getElementById('publishBtn');
        const quillEditor = document.getElementById('editor');
        const plainEditor = document.getElementById('plainEditor');
        const diceBtn = document.getElementById('diceBtn');
        const diceLogDropdownHeader = document.getElementById('diceLogDropdownHeader');
        const diceLogDropdownContent = document.getElementById('diceLogDropdownContent');
        const diceLogList = document.getElementById('diceLogList');
        const listBtn = document.getElementById('listBtn');

        // é¡µç æ§ä»¶
        const pageCurrentDisplay = document.getElementById('pageCurrentDisplay');
        const pageDropdown = document.getElementById('pageDropdown');
        const pageList = document.getElementById('pageList');
        const addPageBtn = document.getElementById('addPageBtn');
      const deletePageBtn = document.getElementById('deletePageBtn'); // <-- æ–°å¢æ­¤è¡Œ
        const currentPageSpan = document.getElementById('currentPage');

        // å³ä¾§ä¸è§’è‰²
        const rightSidebar = document.getElementById('rightSidebar');
        const rightSidebarToggle = document.getElementById('rightSidebarToggle');
        const roleDropdownHeader = document.getElementById('roleDropdownHeader');
        const roleDropdownContent = document.getElementById('roleDropdownContent');
        const roleList = document.getElementById('roleList');
        const addRoleBtn = document.getElementById('addRoleBtn');
        const roleModal = document.getElementById('roleModal');
        const roleNameInput = document.getElementById('roleNameInput');
        const roleNotesTextarea = document.getElementById('roleNotesTextarea');
        const roleColorPicker = document.getElementById('roleColorPicker');
        const confirmRoleBtn = document.getElementById('confirmRoleBtn');
        const cancelRoleBtn = document.getElementById('cancelRoleBtn');

        // å›¾ç‰‡ä¸Šä¼ æ§ä»¶ï¼ˆQuill å·¥å…·æ é‡Œçš„ inputï¼‰
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const uploadImageInput = document.getElementById('uploadImageInput');

        const historyDropdownHeader = document.getElementById('historyDropdownHeader');
        const historyDropdownContent = document.getElementById('historyDropdownContent');
        const historyList = document.getElementById('historyList');

        // æ–°å¢ï¼šå›¾åº“å¼¹çª—å…ƒç´ 
        const galleryModal = document.getElementById('galleryModal');
        const galleryImageList = document.getElementById('galleryImageList');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const cancelGalleryBtn = document.getElementById('cancelGalleryBtn');
        const confirmGalleryBtn = document.getElementById('confirmGalleryBtn');
      const galleryPreviewOverlay = document.getElementById('galleryPreviewOverlay');
const galleryPreviewImage = document.getElementById('galleryPreviewImage');
const galleryPreviewClose = document.getElementById('galleryPreviewClose');


 // ... åœ¨å…¶ä»–å˜é‡å®šä¹‰ä¹‹å

const hiddenTextModal = document.getElementById('hiddenTextModal');
const hiddenTextCloseBtn = document.getElementById('hiddenTextCloseBtn');
const hiddenTextSpoilerOption = document.getElementById('hiddenTextSpoilerOption');
const hiddenTextSecretOption = document.getElementById('hiddenTextSecretOption');
const hiddenTextBtn = document.getElementById('hiddenTextBtn');

const toggleBtn2 = document.getElementById('toggleSidebarBtn');
const sidebar2 = document.getElementById('floatingSidebar');
const closeBtn2 = document.getElementById('closeSidebarBtn');
const desktopSidebar = document.getElementById('rightSidebar');
const floatingBody = document.getElementById('floatingSidebarBody');

// --------- ğŸ“± æ‰‹æœºç«¯ï¼šæŠŠå³ä¾§å·¥å…·æ å†…å®¹æ¬è¿›æµ®çª—ï¼ˆä¸å†å…‹éš†ï¼‰ ---------
if (window.innerWidth <= 768) {
  if (floatingBody) {
    if (desktopSidebar) {
      if (!floatingBody.dataset.moved) {
        // æŠŠ rightSidebar é‡Œçš„æ‰€æœ‰å­èŠ‚ç‚¹æŒªåˆ°æµ®çª— body
        while (desktopSidebar.firstChild) {
          floatingBody.appendChild(desktopSidebar.firstChild);
        }
        floatingBody.dataset.moved = '1';
      }
    }
  }
}

// --------- æµ®çª—å¼€å…³é€»è¾‘ï¼ˆå’Œä¹‹å‰ç±»ä¼¼ï¼Œåªä¿ç•™è¿™ä¸€ä»½ï¼‰ ---------
if (toggleBtn2) {
  if (sidebar2) {
    const openSidebar = function () {
      sidebar2.classList.add('open');
    };

    const closeSidebarFn = function () {
      sidebar2.classList.remove('open');
    };

    // ç‚¹å‡»å³ä¸‹è§’è“è‰²æŒ‰é’®ï¼šå¼€ / å…³
    toggleBtn2.addEventListener('click', function (e) {
      e.stopPropagation();
      if (sidebar2.classList.contains('open')) {
        closeSidebarFn();
      } else {
        openSidebar();
      }
    });

    // å…³é—­æŒ‰é’®
    if (closeBtn2) {
      closeBtn2.addEventListener('click', function () {
        closeSidebarFn();
      });
    }

    // ç‚¹å‡»æµ®çª—å¤–æ”¶èµ·
    document.addEventListener('click', function (e) {
      if (window.innerWidth <= 768) {
        const insideSidebar = sidebar2.contains(e.target);
        const onToggleBtn = toggleBtn2.contains(e.target);

        if (!insideSidebar) {
          if (!onToggleBtn) {
            closeSidebarFn();
          }
        }
      }
    });
  }
}

// åŸæ¥çš„ currentSelectionRange å¯ä»¥æ¥åœ¨åé¢
let currentSelectionRange = null;

      /* ---------- è‡ªåŠ¨ä¿å­˜çš„æ ¸å¿ƒå‡½æ•° ---------- */
function startAutoSave() {
    // æ¯æ¬¡å¯åŠ¨å‰å…ˆæ¸…ç©ºæ—§çš„å®šæ—¶å™¨
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
    }

    // æ¯éš” 5 ç§’æ‰§è¡Œä¸€æ¬¡ä¿å­˜æ£€æŸ¥
    autoSaveTimer = setInterval(async () => {
          if (!autoSaveEnabled) return; // ğŸ”¹æ–°å¢ï¼šåˆ é™¤æœŸé—´ä¸æ‰§è¡Œè‡ªåŠ¨ä¿å­˜
        if (hasUnsavedChanges && currentWorkId && !isSaving) {
            console.log('è‡ªåŠ¨ä¿å­˜è§¦å‘...');
            const success = await saveWork(true); // ä¼ å…¥ true è¡¨ç¤ºæ˜¯è‡ªåŠ¨ä¿å­˜
            if (success) {
                hasUnsavedChanges = false; // æˆåŠŸä¿å­˜åé‡ç½®çŠ¶æ€
            }
        }
    }, 5000); // 5000 æ¯«ç§’ = 5 ç§’
}

// 
/* ---------- æ ‡è®°å†…å®¹æœ‰å˜åŠ¨ ---------- */
// âš ï¸ æ­¤å‡½æ•°åœ¨æ‰€æœ‰å†…å®¹å˜åŠ¨ï¼ˆQuill/Plain Textï¼‰çš„äº‹ä»¶ç›‘å¬å™¨ä¸­è¢«è°ƒç”¨
function markAsChanged() {
    if (!hasUnsavedChanges) {
        hasUnsavedChanges = true;
        saveBtn.textContent = 'ä¿å­˜*'; // ç»™ç”¨æˆ·ä¸€ä¸ªæœªä¿å­˜çš„æç¤º
        
        // ã€æ–°å¢ï¼šå¦‚æœä½œå“å¤„äºâ€œå·²å‘å¸ƒâ€çŠ¶æ€å¹¶è¢«ç¼–è¾‘ï¼Œé‡æ–°å¯ç”¨æŒ‰é’®å¹¶æ”¹ä¸ºâ€œæ›´æ–°*â€ã€‘
        if (publishBtn.disabled === true && publishBtn.textContent === 'å·²å‘å¸ƒ') {
            publishBtn.textContent = 'æ›´æ–°*';
            publishBtn.disabled = false;
        }
    }
}

/* ---------- éšè—æ–‡æœ¬/æš—éª°æ¨¡å¼é€»è¾‘ ---------- */

// ç»Ÿä¸€çš„å¼¹çª—å…³é—­å‡½æ•°
function closeHiddenTextModal() {
    // ä¿®æ­£ï¼šå°† 'hidden' ç±»åŠ å›ï¼Œä»¥ç¡®ä¿å¼¹çª—è¢«éšè—
    hiddenTextModal.classList.add('hidden'); 
    
    // ç§»é™¤ inline styleï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
    hiddenTextModal.style.display = ''; 

    // é‡æ–°æ˜¾ç¤º Quill å·¥å…·æ 
    document.body.classList.remove('modal-active');
    currentSelectionRange = null; 
}

// 1. ç»‘å®šå·¥å…·æ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
if (hiddenTextBtn) {
    hiddenTextBtn.addEventListener('click', () => {
        // æ•è·é€‰åŒº
        currentSelectionRange = quill.getSelection(true); 

        if (!currentSelectionRange || currentSelectionRange.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®çš„æ–‡æœ¬ï¼');
            return;
        }
        
        // ğŸ’¥ å…³é”®ä¿®æ­£ï¼šç§»é™¤ 'hidden' ç±»ï¼Œæ‰èƒ½è¦†ç›– CSS ä¸­çš„ display: none !important
        hiddenTextModal.classList.remove('hidden'); 

        // æ–°å¢ï¼šåœ¨æ˜¾ç¤ºå¼¹çª—å‰ï¼Œä¸º body æ·»åŠ ç±»ä»¥éšè—å·¥å…·æ ï¼ˆå¦‚æ‚¨æ‰€è¦æ±‚ï¼‰
        document.body.classList.add('modal-active');
        hiddenTextModal.style.display = 'flex'; // æ˜¾ç¤ºå¼¹çª—
    });
}

// 2. ç»‘å®šå¼¹çª—é€‰é¡¹å’Œå…³é—­äº‹ä»¶
hiddenTextCloseBtn.addEventListener('click', closeHiddenTextModal);

function applyHiddenTextFormat(mode) {
    if (currentSelectionRange) {
        const { index, length } = currentSelectionRange;

        // åº”ç”¨æ ¼å¼ï¼Œå¹¶å°† mode ä½œä¸º Blot çš„å€¼ä¼ é€’
        quill.formatText(
            index,
            length,
            'hiddenText', // Blot çš„åç§°
            { mode: mode }, // ä¼ é€’ä¸€ä¸ªåŒ…å«æ¨¡å¼çš„å¯¹è±¡
            Quill.sources.USER
        );
        // ç¡®ä¿å…‰æ ‡ä¿æŒåœ¨åº”ç”¨æ ¼å¼åçš„ä½ç½®
        quill.setSelection(index + length, 0); 

        closeHiddenTextModal();
    }
}

// ç»‘å®šé€‰é¡¹æŒ‰é’®
hiddenTextSpoilerOption.addEventListener('click', () => {
    applyHiddenTextFormat('spoiler');
});

hiddenTextSecretOption.addEventListener('click', () => {
    applyHiddenTextFormat('secret');
});

        let currentRoleForGallery = null; // ç”¨äºå­˜å‚¨å½“å‰æ­£åœ¨ç¼–è¾‘å›¾åº“çš„è§’è‰²
        let galleryImages = []; // ç”¨äºå­˜å‚¨å½“å‰è§’è‰²çš„å›¾åº“å›¾ç‰‡

        // æŠ˜å /å±•å¼€
        historyDropdownHeader.addEventListener('click', () => {
            historyDropdownContent.classList.toggle('open');
            historyDropdownHeader.classList.toggle('open');
        });

        // æ–°å¢å†å²è®°å½•çš„å‡½æ•°
        function addHistoryRecord(action) {
            const li = document.createElement('li');
            li.textContent = `${new Date().toLocaleString()} - ${action}`;
            historyList.prepend(li);
        }


        /* ---------- å…¨å±€çŠ¶æ€ ---------- */
        let pages = [{ content: {} }]; // å§‹ç»ˆå’Œåç«¯ schema å¯¹é½ï¼šæ•°ç»„ï¼Œæ¯é¡¹è‡³å°‘æœ‰ content å­—æ®µ
        let currentPageIndex = 0;       // ä½¿ç”¨ç´¢å¼•ç®¡ç†é¡µç ï¼ˆé¿å…è‡ªé€  idï¼‰
        let currentWorkId = null;       // ç¼–è¾‘æ—¶çš„ work._id
        let roles = [];                 // å½“å‰ä½œå“çš„è§’è‰²æ•°ç»„ï¼ˆæ¥è‡ªåç«¯ï¼‰
        let currentEditRoleId = null;   // è§’è‰²ç¼–è¾‘æ—¶çš„ id
        let selectedRoleColor = null;
        let isQuillActive = true;

      let pageHistories = {};

        /* ---------- API åŸºç¡€åœ°å€ ---------- */
        const API_BASE_URL = 'https://api.anchorx.ca/api/works';

/* ---------- 1. æ³¨å†Œè‡ªå®šä¹‰ Blotï¼ˆæ’ä»¶ï¼‰ - æ›´æ–° HiddenTextBlot ---------- */

// å¯¼å…¥ Quill æ ¸å¿ƒ Blot ç±»
const Inline = Quill.import('blots/inline');

/* 1.1 éšè—æ–‡å­—ï¼ˆInline Blotï¼‰ - æ›´æ–°ä»¥æ”¯æŒ mode å±æ€§ */
class HiddenTextBlot extends Inline {
    static blotName = 'hiddenText';
    static tagName = 'span';
    static className = 'spoiler-hidden'; 

    // é™æ€æ–¹æ³•ï¼šä» DOM èŠ‚ç‚¹è§£æå‡ºæ ¼å¼å€¼
    static formats(node) {
        // é»˜è®¤è¿”å› 'spoiler'
        const mode = node.getAttribute('data-mode') || 'spoiler'; 
        return { mode };
    }

    // é™æ€æ–¹æ³•ï¼šåˆ›å»º DOM èŠ‚ç‚¹
    static create(value) {
        const node = super.create(value);
        let mode = 'spoiler'; // é»˜è®¤æ¨¡å¼

        if (value && value.mode) {
            mode = value.mode;
        } else if (typeof value === 'object' && value.mode) {
            mode = value.mode;
        }

        // è®¾ç½®è‡ªå®šä¹‰å±æ€§å’Œå¯èƒ½çš„ç‰¹å®š class
        node.setAttribute('data-mode', mode);
        if (mode === 'secret') {
            node.classList.add('secret-dice');
        } else {
            node.classList.remove('secret-dice');
        }
        return node;
    }

    // å®ä¾‹æ–¹æ³•ï¼šæ›´æ–°æ ¼å¼å±æ€§
    format(name, value) {
        if (name === 'hiddenText' && value && value.mode) {
            this.domNode.setAttribute('data-mode', value.mode);
            if (value.mode === 'secret') {
                this.domNode.classList.add('secret-dice');
            } else {
                this.domNode.classList.remove('secret-dice');
            }
        } else {
            super.format(name, value);
        }
    }
}

// æ³¨å†Œè‡ªå®šä¹‰ Blot
Quill.register(HiddenTextBlot);

      // --- æ–°å¢ä»£ç ï¼šè·å– Blot Formatter çš„æ ¸å¿ƒ Actions ---

// âš ï¸ æ³¨æ„ï¼šQuill åˆå§‹åŒ–æ—¶ formats åˆ—è¡¨å¿…é¡»åŒ…å« 'hiddenText'
// ä¾‹å¦‚ï¼šformats: ['bold', ..., 'hiddenText']
      
      quill.on('text-change', markAsChanged); 


        // æ’¤é”€/é‡åšæŒ‰é’®ï¼ˆtoolbaré‡Œï¼‰
        const undoBtn = document.querySelector('.ql-undo');
        const redoBtn = document.querySelector('.ql-redo');
        if (undoBtn) undoBtn.addEventListener('click', () => quill.history.undo());
        if (redoBtn) redoBtn.addEventListener('click', () => quill.history.redo());

        /* ---------- å¸®åŠ©å‡½æ•°ï¼šheaders ---------- */
        function authHeaders(jsonContent) {
            const h = { 'Authorization': `Bearer ${localStorage.getItem('token')}` };
            if (jsonContent === true) h['Content-Type'] = 'application/json';
            return h;
        }

        /* ---------- å›¾ç‰‡ä¸Šä¼ ï¼ˆimggb helperï¼‰---------- */
        // æ³¨æ„ï¼šå¼ºçƒˆå»ºè®®æŠŠ imgbb API key æ”¾åˆ°åç«¯ï¼Œå‰ç«¯åªè°ƒç”¨åç«¯ä¸Šä¼ æ¥å£ä»¥é¿å…æ³„éœ²ã€‚
        async function uploadFileToImgBB(file) {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onloadend = async () => {
                    try {
                        const base64Image = reader.result.split(',')[1];
                        const formData = new FormData();
                        formData.append('image', base64Image);
                        // ç›®å‰ä»ç„¶ç›´æ¥è¯·æ±‚ imgbbï¼ˆä¸å®‰å…¨ï¼‰ï¼Œå»ºè®®ä½ æ”¹ä¸ºï¼šPOST /api/upload ï¼ˆåç«¯ä»£ç†ï¼‰
                        const response = await fetch('https://api.imgbb.com/1/upload?key=040dbc9e6e680f321e09d9e05f447094', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data && data.success) {
                            resolve(data.data.url);
                        } else {
                            reject(new Error('å›¾åºŠä¸Šä¼ å¤±è´¥'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Quill å·¥å…·æ é‡Œçš„æ–‡ä»¶è¼¸å…¥é€»è¾‘
        if (uploadImageBtn && uploadImageInput) {
            uploadImageBtn.addEventListener('click', () => uploadImageInput.click());
uploadImageInput.addEventListener('change', async () => {
    const file = uploadImageInput.files[0];
    if (!file) return;
    try {
        const imageUrl = await uploadFileToImgBB(file);
       const range = quill.getSelection(); // [cite: 528]
        if (range) {
            quill.insertEmbed(range.index, 'image', imageUrl);
        } else {
            quill.insertEmbed(quill.getLength(), 'image', imageUrl);// [cite: 529]
        }
        
        // ã€æ–°å¢ï¼šæ’å…¥å›¾ç‰‡åè‡ªåŠ¨è§¦å‘ä¿å­˜ã€‘
        await saveWork(); 

    } catch (err) {
        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', err);// [cite: 529]
        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
    }
});
        }

        /* ---------- å°é¢ä¸Šä¼ ï¼ˆå¼¹çª— + PATCH to backendï¼‰---------- */
        function showCoverUploadModal(workId) {
            const modalHtml = `
                <div id="cover-modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:10000;">
                    <div style="background:#fff;padding:18px;border-radius:10px; width:320px; text-align:center;">
                        <h3>ä¸Šä¼ /æ›´æ”¹å°é¢</h3>
                        <input type="file" id="cover-image-input" accept="image/*" style="display:none;">
                        <label for="cover-image-input" id="cover-label" style="display:inline-block; width:160px; height:120px; border:1px dashed #ccc; line-height:120px; cursor:pointer; margin:10px auto;">é¸æ“‡å›¾ç‰‡</label>
                        <div style="margin-top:10px;">
                            <button id="upload-confirm-btn">ç¡®è®¤</button>
                            <button id="upload-cancel-btn">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const backdrop = document.getElementById('cover-modal-backdrop');
            const fileInput = document.getElementById('cover-image-input');
            const label = document.getElementById('cover-label');
            const confirmBtnLocal = document.getElementById('upload-confirm-btn');
            const cancelBtnLocal = document.getElementById('upload-cancel-btn');
            let selectedFile = null;

            fileInput.addEventListener('change', e => {
                selectedFile = e.target.files[0];
                if (!selectedFile) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    label.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
                };
                reader.readAsDataURL(selectedFile);
            });

            cancelBtnLocal.addEventListener('click', () => backdrop.remove());
            confirmBtnLocal.addEventListener('click', async () => {
                if (!selectedFile) {
                    alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡ã€‚');
                    return;
                }
                try {
                    // ä¸Šä¼ å›¾åºŠå¹¶æŠŠ URL å‘ç»™åç«¯
                    const imgUrl = await uploadFileToImgBB(selectedFile);
                    const res = await fetch(`${API_BASE_URL}/${workId}/cover`, {
                        method: 'PATCH',
                        headers: authHeaders(true),
                        body: JSON.stringify({ coverImageUrl: imgUrl })
                    });
                    if (res.ok) {
                        alert('å°é¢æ›´æ–°æˆåŠŸï¼');
                        loadWorks(); // åˆ·æ–°åˆ—è¡¨æ˜¾ç¤º
                    } else {
                        const jd = await res.json();
                        alert('å°é¢æ›´æ–°å¤±è´¥ï¼š' + (jd.message || res.status));
                    }
                } catch (err) {
                    console.error('å°é¢ä¸Šä¼ å¤±è´¥', err);
                    alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚');
                } finally {
                    backdrop.remove();
                }
            });
        }

        /* ---------- åç«¯äº¤äº’ï¼šä½œå“åˆ—è¡¨ / åˆ›å»º / åˆªé™¤ / è·å–å•ä¸ª ---------- */
        async function fetchWorks() {
            try {
                const res = await fetch(API_BASE_URL, { headers: authHeaders(false) });
                if (res.status === 401) {
                    // token è¿‡æœŸ
                    localStorage.removeItem('token');
                    alert('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
                    window.location.href = 'https://zhidianworld.com/login/';
                    return [];
                }
                if (!res.ok) {
                    const j = await res.json();
                    console.error('è·å–ä½œå“å¤±è´¥', j);
                    alert('è·å–ä½œå“å¤±è´¥ï¼š' + (j.message || res.status));
                    return [];
                }
                return await res.json();
            } catch (err) {
                console.error('fetchWorks error', err);
                alert('æ— æ³•è·å–ä½œå“åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚');
                return [];
            }
        }

        async function createWork(title) {
            try {
                const body = { title: title, content: [{ content: {} }] };
                const res = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: authHeaders(true),
                    body: JSON.stringify(body)
                });
                const j = await res.json();
                if (!res.ok) {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + (j.message || res.status));
                    return null;
                }
                return j;
            } catch (err) {
                console.error('createWork error', err);
                alert('åˆ›å»ºä½œå“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚');
                return null;
            }
        }

        async function deleteWork(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders(false)
                });
                if (!res.ok) {
                    const j = await res.json();
                    alert('åˆªé™¤å¤±è´¥ï¼š' + (j.message || res.status));
                    return false;
                }
                return true;
            } catch (err) {
                console.error('deleteWork error', err);
                alert('åˆªé™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚');
                return false;
            }
        }

        async function fetchWorkById(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/${id}`, { headers: authHeaders(false) });
                if (!res.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }
                return await res.json();
            } catch (err) {
                console.error('fetchWorkById error', err);
                alert('åŠ è½½ä½œå“å¤±è´¥');
                return null;
            }
        }

      // ... ä½äº fetchWorkById ä¹‹åæˆ–é™„è¿‘

// ä½äº fetchWorkById ä¹‹åæˆ–é™„è¿‘

async function fetchDiceHistory(workId) {
Â  Â  if (!workId) return [];
Â  Â  try {
Â  Â  Â  Â  // ğŸš€ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ API_BASE_URL (https://api.anchorx.ca/api/works)
Â  Â  Â  Â  const res = await fetch(`${API_BASE_URL}/${workId}/dice-log`, { headers: authHeaders(false) });
Â  Â  Â  Â  if (!res.ok) {
Â  Â  Â  Â  Â  Â  console.error('åŠ è½½éª°å­å†å²å¤±è´¥', res.status);
Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  }
Â  Â  Â  Â  return await res.json();
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error('fetchDiceHistory error', err);
Â  Â  Â  Â  return [];
Â  Â  }
}

// è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“éª°å­å†å²åˆ—è¡¨
function renderDiceHistory(history) {
    diceLogList.innerHTML = '';
    // æ³¨æ„ï¼šå†å²è®°å½•é€šå¸¸æ˜¯æŒ‰æ—¶é—´å‡åºæˆ–é™åºè¿”å›ï¼Œè¿™é‡ŒæŒ‰é™åºæ¸²æŸ“ï¼ˆæœ€æ–°çš„åœ¨é¡¶ï¼‰
    history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    history.forEach(log => {
        // ä½¿ç”¨ logDiceResult å‡½æ•°æ¥ç»Ÿä¸€æ¸²æŸ“æ ·å¼
        logDiceResult(log.rollType, log.result, log.rollText, new Date(log.timestamp));
    });
}

// ... ç´§æ¥ç€åœ¨ loadWorkById å‡½æ•°ä¸­æ·»åŠ è°ƒç”¨ï¼ˆå¦‚ä¸‹ï¼‰

        /* ---------- æ¸²æŸ“ä½œå“åˆ—è¡¨ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰---------- */
        async function loadWorks() {
            const works = await fetchWorks();
            workList.innerHTML = '';
            if (!works || works.length === 0) {
                workList.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">æš‚æ— ä½œå“ï¼Œå¿«æ¥åˆ›å»ºå§ï¼</p>';
                workCountSpan.textContent = '0';
                return;
            }
            works.forEach(work => {
                const html = `
                    <div class="work-item-wrapper" data-id="${work._id}">
                        <div class="work-item">
                            <div class="work-info">
                                <div class="work-date">${new Date(work.updatedAt).toLocaleString()}</div>
                                <div class="work-details">
                                    <span class="work-title">${work.title}</span>
                                </div>
                            </div>
                            <div class="work-actions-buttons">
                                <button class="cover-settings-btn" data-work-id="${work._id}">å°é¢è®¾ç½®</button>
                                <button class="menu-button" data-action="toggle-menu">â‹¯</button>
                            </div>
                        </div>
                        <div class="menu-container hidden">
                            <div class="menu-item" data-action="delete-single">åˆªé™¤</div>
                        </div>
                    </div>
                `;
                workList.insertAdjacentHTML('beforeend', html);
            });
            workCountSpan.textContent = String(works.length);
        }

        // äº‹ä»¶å§”æ‰˜ï¼šå•ä¸ªä½œå“åˆ—è¡¨çš„å„ç±»æ“ä½œ
        workList.addEventListener('click', async (e) => {
            const wrapper = e.target.closest('.work-item-wrapper');
            if (!wrapper) return;
            const workId = wrapper.dataset.id;

            // ç‚¹å‡»èœå•æŒ‰é’®
            if (e.target.closest('.menu-button')) {
                // åˆ‡æ¢å½“å‰èœå•çš„æ˜¾ç¤ºï¼Œå¹¶éšè—å…¶å®ƒèœå•
                document.querySelectorAll('.menu-container').forEach(menu => {
                    if (menu !== wrapper.querySelector('.menu-container')) menu.classList.add('hidden');
                });
                const menu = wrapper.querySelector('.menu-container');
                menu.classList.toggle('hidden');
                return;
            }

            // ç‚¹å‡»å°é¢è®¾ç½®
            if (e.target.closest('.cover-settings-btn')) {
                showCoverUploadModal(workId);
                return;
            }

            // ç‚¹å‡»èœå•é‡Œçš„åˆªé™¤
            if (e.target.closest('[data-action="delete-single"]')) {
                workToDelete = await fetchWorkById(workId);
                if (!workToDelete) return;
                deleteModal.style.display = 'flex';
                return;
            }

            // ç‚¹å‡»ä½œå“æœ¬ä½“ï¼šåŠ è½½ä½œå“åˆ°ç¼–è¾‘å™¨
            if (e.target.closest('.work-item')) {
                await loadWorkById(workId);
                return;
            }
        });

        // ç‚¹å‡»é¡µé¢ç©ºç™½å¤„ï¼Œéšè—æ‰€æœ‰èœå•
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.work-item-wrapper')) {
                document.querySelectorAll('.menu-container').forEach(menu => menu.classList.add('hidden'));
            }
        });

        // åˆªé™¤ç¡®è®¤
        deleteConfirmBtn.addEventListener('click', async () => {
            if (!workToDelete) return;
            const id = workToDelete._id;
            const ok = await deleteWork(id);
            if (ok) {
                deleteModal.style.display = 'none';
                await loadWorks();
            }
        });
        deleteCancelBtn.addEventListener('click', () => deleteModal.style.display = 'none');

        /* ---------- æ‰¹é‡åˆªé™¤ ---------- */
        bulkDeleteBtn.addEventListener('click', async () => {
            const works = await fetchWorks();
            if (!works || works.length === 0) {
                alert('æ²¡æœ‰ä½œå“å¯ä»¥åˆªé™¤ã€‚');
                return;
            }
            bulkDeleteList.innerHTML = '';
            works.forEach(w => {
                const div = document.createElement('div');
                div.className = 'delete-item';
                div.innerHTML = `<input type="checkbox" id="work-${w._id}" value="${w._id}"><label for="work-${w._id}">${w.title}</label>`;
                bulkDeleteList.appendChild(div);
            });
            bulkDeleteModal.style.display = 'flex';
        });
        bulkDeleteCancelBtn.addEventListener('click', () => bulkDeleteModal.style.display = 'none');
        bulkDeleteConfirmBtn.addEventListener('click', async () => {
            const checked = bulkDeleteList.querySelectorAll('input[type="checkbox"]:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            if (ids.length === 0) { alert('è¯·è‡³å°‘é¸æ“‡ä¸€ä¸ªä½œå“åˆªé™¤ã€‚'); return; }
            if (!confirm(`ç¡®å®šåˆªé™¤ ${ids.length} ä¸ªä½œå“ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
            let count = 0;
            for (const id of ids) {
                const ok = await deleteWork(id);
                if (ok) count++;
            }
            alert(`å·²åˆªé™¤ ${count} ä¸ªä½œå“ã€‚`);
            bulkDeleteModal.style.display = 'none';
            await loadWorks();
        });

        /* ---------- æ–°å»ºä½œå“å¼¹çª— ---------- */
        createBtn.addEventListener('click', () => {
            createModal.style.display = 'flex';
            workTitleInput.value = '';
            createMessage.textContent = '';
            workTitleInput.focus();
        });
        cancelBtn.addEventListener('click', () => createModal.style.display = 'none');

        confirmBtn.addEventListener('click', async () => {
            const title = workTitleInput.value.trim();
            if (!title) { createMessage.textContent = 'ä½œå“åç§°ä¸èƒ½ä¸ºç©ºï¼'; return; }
            createMessage.textContent = '';
            const newWork = await createWork(title);
            if (newWork) {
                createModal.style.display = 'none';
                // ç«‹å³è¿›å…¥ç¼–è¾‘å™¨å¹¶åŠ è½½ï¼ˆåç«¯è¿”å›çš„ newWorkï¼‰
                await loadWorkById(newWork._id);
            }
        });

        /* ---------- åˆ‡æ¢åˆ°ç¼–è¾‘å™¨ï¼ˆè®¾ç½®çŠ¶æ€ï¼‰---------- */
        async function switchToEditor(work) {

  if (work && work.isPublished) {
        // ä½œå“å·²å‘å¸ƒï¼šæŒ‰é’®æ˜¾ç¤ºâ€œå·²å‘å¸ƒâ€å¹¶ç¦ç”¨
        publishBtn.textContent = 'å·²å‘å¸ƒ'; // ã€ä¿®æ”¹ç‚¹1ï¼šå¦‚æœå·²å‘å¸ƒï¼Œæ˜¾ç¤ºâ€œå·²å‘å¸ƒâ€ã€‘
        publishBtn.disabled = true;         // ã€ä¿®æ”¹ç‚¹2ï¼šå¦‚æœå·²å‘å¸ƒï¼Œç¦ç”¨æŒ‰é’®ã€‘
    } else {
        // ä½œå“æœªå‘å¸ƒï¼šæŒ‰é’®æ˜¾ç¤ºâ€œå‘å¸ƒâ€å¹¶å¯ç”¨
        publishBtn.textContent = 'å‘å¸ƒ';
        publishBtn.disabled = false;        // ã€ä¿®æ”¹ç‚¹3ï¼šå¦‚æœæœªå‘å¸ƒï¼Œç¡®ä¿æŒ‰é’®å¯ç”¨ã€‘
    }

            mainPage.classList.add('hidden');
            editorPage.classList.remove('hidden');
            if (work && work.title) {
                editorTitle.textContent = `æ­£åœ¨ç¼–è¾‘ï¼š${work.title}`;
            } else {
                editorTitle.textContent = 'æ­£åœ¨ç¼–è¾‘ï¼šæœªå‘½åä½œå“';
            }
            currentWorkId = work && work._id ? work._id : null;

            roles = await fetchRoles(currentWorkId);
            renderRoles();

            // æ˜¾ç¤º Quill
            isQuillActive = true;
            quillEditor.classList.remove('hidden');
            plainEditor.classList.add('hidden');
        
            sidebar.classList.add('sidebar-collapsed');
        }


/* ---------- è½½å…¥å•ä¸ªä½œå“ï¼ˆå¹¶åˆå§‹åŒ– pagesï¼‰---------- */
async function loadWorkById(id) {
    const work = await fetchWorkById(id);
    if (!work) return;

    // âœ…ã€æ”¹åŠ¨ 1ï¼šåç«¯å­—æ®µå…¼å®¹è¯»å–ã€‘
    // ä¼˜å…ˆè¯» work.pagesï¼Œå¦‚æœä¸ºç©ºæˆ–ä¸å­˜åœ¨ï¼Œå†å°è¯•è¯» work.content
    let loadedPages = [];
    if (Array.isArray(work.pages) && work.pages.length > 0) {
        loadedPages = work.pages;
    } else if (Array.isArray(work.content) && work.content.length > 0) {
        loadedPages = work.content;
    } else {
        loadedPages = [{ content: { ops: [] } }];
    }
    
    // èµ‹å€¼ç»™å…¨å±€å˜é‡
    pages = loadedPages;
    currentPageIndex = 0;

    // âœ…ã€æ”¹åŠ¨ 2ï¼šé‡ç½®å†å²è®°å½•æ ˆã€‘
    pageHistories = {}; // æ¢ä½œå“äº†ï¼Œæ¸…ç©ºæ‰€æœ‰é¡µçš„å†å²
    if (quill.history) quill.history.clear(); // æ¸…ç©ºå½“å‰ç¼–è¾‘å™¨å†å²

    await switchToEditor(work);
    
    // æš‚æ—¶å…³é—­è‡ªåŠ¨ä¿å­˜ï¼Œé˜²æ­¢åŠ è½½è¿‡ç¨‹è§¦å‘ä¿å­˜
    const wasAutoSave = autoSaveEnabled;
    autoSaveEnabled = false; 

    // åŠ è½½éª°å­å†å²
    const diceHistory = await fetchDiceHistory(id); 
    renderDiceHistory(diceHistory);

    // âœ…ã€æ”¹åŠ¨ 3ï¼šåŠ è½½ç¬¬ä¸€é¡µå†…å®¹ã€‘
    try {
        const firstPageContent = pages[0]?.content || { ops: [] };
        // ä½¿ç”¨ 'silent' æ¨¡å¼è®¾ç½®å†…å®¹ï¼Œä¸è§¦å‘ text-change äº‹ä»¶ï¼Œä¹Ÿä¸è®¡å…¥ history
        quill.setContents(firstPageContent, 'silent');
    } catch (err) {
        console.warn('quill.setContents failed', err);
        quill.setContents({ ops: [] }, 'silent');
    }

    updatePageDisplay();
    renderPageList();
    
    // æ¢å¤è‡ªåŠ¨ä¿å­˜çŠ¶æ€ï¼ˆå¦‚æœæ˜¯å¼€å¯çš„ï¼‰
    // å»¶è¿Ÿä¸€ç‚¹ç‚¹ç¡®ä¿ Quill ç¨³å®š
    setTimeout(() => {
        autoSaveEnabled = wasAutoSave;
        startAutoSave();
    }, 100);
}

      /* ---------- ä¿å­˜ä½œå“çš„æ ¸å¿ƒé€»è¾‘ (è¿”å›æ˜¯å¦æˆåŠŸ) ---------- */
/* ---------- ä¿å­˜ä½œå“çš„æ ¸å¿ƒé€»è¾‘ ---------- */
async function performSave() {
  if (!currentWorkId) return false;

  // åŒæ­¥å½“å‰é¡µå†…å®¹åˆ° pages
  if (isQuillActive) {
    pages[currentPageIndex].content = quill.getContents();
  } else {
    const lines = plainEditor.value.split('\n');
    pages[currentPageIndex].content = { ops: lines.map(line => ({ insert: line + '\n' })) };
  }

  // âœ… åªå‘ pagesï¼ˆåˆ«å† pages+content åŒä»½å‘äº†ï¼‰
  const data = {
    title: editorTitle.textContent.replace('æ­£åœ¨ç¼–è¾‘ï¼š', ''),
    pages: pages
  };

  // ï¼ˆå¯é€‰ï¼‰æ‰“ç‚¹çœ‹çœ‹ä½ åˆ°åº•å¤šå¤§
  // console.log('save payload bytes =', new Blob([JSON.stringify(data)]).size);

  try {
    isSaving = true;
    const res = await fetch(`${API_BASE_URL}/${currentWorkId}`, {
      method: 'PUT',
      headers: authHeaders(true),
      body: JSON.stringify(data)
    });

    const text = await res.text(); // âœ… å…ˆæ‹¿çº¯æ–‡æœ¬ï¼Œé¿å… 413 HTML ç›´æ¥æŠŠ res.json() ç‚¸æ‰
    let j = null;
    try { j = JSON.parse(text); } catch (_) {}

    if (!res.ok) {
      throw new Error(j?.message || `HTTP ${res.status}: ${text.slice(0, 200)}`);
    }

    currentWorkId = j?._id || currentWorkId;
    return true;
  } catch (err) {
    console.error('ä¿å­˜å¤±è´¥', err);
    alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
    return false;
  } finally {
    isSaving = false;
  }
}


/* ---------- ä¿å­˜ä½œå“ï¼ˆè‡ªåŠ¨/æ‰‹åŠ¨ï¼‰---------- */
// æ¥å—ä¸€ä¸ªå‚æ•° isAutoï¼Œç”¨äºåŒºåˆ†æ˜¯è‡ªåŠ¨ä¿å­˜è¿˜æ˜¯æ‰‹åŠ¨ä¿å­˜
async function saveWork(isAuto = false) {
    if (!currentWorkId) { 
        if (!isAuto) { // åªæœ‰æ‰‹åŠ¨ä¿å­˜æ‰å¼¹çª—
            alert('è¯·å…ˆä¿å­˜æˆ–åˆ›å»ºä½œå“ã€‚');
        }
        return false; 
    }
    
    // æ‰‹åŠ¨ä¿å­˜æ—¶æ˜¾ç¤ºâ€œæ­£åœ¨ä¿å­˜...â€
    if (!isAuto) {
        saveBtn.textContent = 'æ­£åœ¨ä¿å­˜...';
    }

    const success = await performSave();
    
    if (success) {
        // æˆåŠŸä¿å­˜åï¼Œæ— è®ºæ‰‹åŠ¨æˆ–è‡ªåŠ¨ï¼Œéƒ½é‡ç½® UI çŠ¶æ€
        saveBtn.textContent = 'å·²ä¿å­˜'; 
        hasUnsavedChanges = false; // é‡ç½®æœªä¿å­˜çŠ¶æ€
        addHistoryRecord(isAuto ? 'è‡ªåŠ¨ä¿å­˜' : 'æ‰‹åŠ¨ä¿å­˜'); 

        setTimeout(() => {
            if (hasUnsavedChanges) {
                saveBtn.textContent = 'ä¿å­˜*';
            } else {
                saveBtn.textContent = 'ä¿å­˜';
            }
        }, 1500);
    } else {
        // ä¿å­˜å¤±è´¥ï¼Œåªæœ‰æ‰‹åŠ¨ä¿å­˜æ‰æç¤º
        if (!isAuto) {
            saveBtn.textContent = 'ä¿å­˜å¤±è´¥';
            setTimeout(() => saveBtn.textContent = 'ä¿å­˜', 1500);
        }
    }
    return success;
}

/* ---------- æ–°å¢ï¼šå¯¼å‡ºæ‰€æœ‰æ¥¼å±‚åˆ°æœ¬åœ° JSON ---------- */
async function downloadLocalBackup() {
    if (!currentWorkId) {
        alert('è¯·å…ˆä¿å­˜æˆ–åˆ›å»ºä½œå“ï¼Œå†å¯¼å‡ºåˆ°æœ¬åœ°ã€‚');
        return;
    }

    // 1ï¸âƒ£ å…ˆæŠŠå½“å‰é¡µçš„å†…å®¹å†™å› pagesï¼ˆå’Œ performSave é‡Œçš„é€»è¾‘ä¿æŒä¸€è‡´ï¼‰
    if (isQuillActive) {
        pages[currentPageIndex].content = quill.getContents();
    } else {
        const lines = plainEditor.value.split('\n');
        const ops = lines.map(line => ({ insert: line + '\n' }));
        pages[currentPageIndex].content = { ops };
    }

    // 2ï¸âƒ£ ä»åç«¯å†æ‹¿ä¸€æ¬¡ä½œå“ï¼Œä¸»è¦æ˜¯æ‹¿ç‰¹æ•ˆå­—æ®µï¼ˆeffectsDraft / effectsPublishedï¼‰
    let effectsDraft = [];
    let effectsPublished = [];
    try {
        const work = await fetchWorkById(currentWorkId);
        if (work) {
            if (Array.isArray(work.effectsDraft)) {
                effectsDraft = work.effectsDraft;
            }
            if (Array.isArray(work.effectsPublished)) {
                effectsPublished = work.effectsPublished;
            }
        }
    } catch (err) {
        console.error('è·å–ä½œå“ç‰¹æ•ˆå¤±è´¥ï¼ˆå¯¼å‡ºæ—¶å¿½ç•¥ï¼‰ï¼š', err);
        // å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­å¯¼å‡ºé¡µé¢å†…å®¹
    }

    // 3ï¸âƒ£ ç»„è£…å¤‡ä»½æ•°æ®
    const backupData = {
        meta: {
            workId: currentWorkId,
            title: editorTitle.textContent.replace('æ­£åœ¨ç¼–è¾‘ï¼š', ''),
            exportedAt: new Date().toISOString(),
            source: 'AnchorX-write-local-backup-v1'
        },
        // æ‰€æœ‰æ¥¼å±‚å†…å®¹ï¼šè¿™é‡Œæ˜¯ Quill çš„ Deltaï¼Œä¿ç•™äº†é¢œè‰²ã€åŠ ç²—ã€æ ‡é¢˜ç­‰æ ·å¼
        pages: pages,
        // è§’è‰²ä¿¡æ¯
        roles: roles,
        // ç‰¹æ•ˆä¿¡æ¯ï¼šä»¥â€œä»£ç æ ¼å¼â€ï¼ˆJSONï¼‰ä¿ç•™ä¸‹æ¥
        effectsDraft: effectsDraft,
        effectsPublished: effectsPublished
    };

    // 4ï¸âƒ£ è½¬æˆ JSON æ–‡ä»¶å¹¶è§¦å‘æµè§ˆå™¨ä¸‹è½½
    const jsonStr = JSON.stringify(backupData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    const rawTitle = backupData.meta.title || 'æœªå‘½åä½œå“';
    const safeTitle = rawTitle.replace(/[\\/:*?"<>|]/g, '_');
    a.href = url;
    a.download = `${safeTitle}_æœ¬åœ°å¤‡ä»½_${new Date().toISOString().slice(0,10)}.json`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    // å¯é€‰ï¼šè®°ä¸€æ¡å†å²è®°å½•
    addHistoryRecord('å¯¼å‡ºæœ¬åœ°å¤‡ä»½');
}

        saveBtn.addEventListener('click', saveWork);

// âœ… æ–°å¢ï¼šç»™â€œä¿å­˜åˆ°æœ¬åœ°â€æŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
if (localSaveBtn) {
    localSaveBtn.addEventListener('click', () => {
        console.log('â–¶ ç‚¹å‡»äº†ã€ä¿å­˜åˆ°æœ¬åœ°ã€‘æŒ‰é’®');
        downloadLocalBackup();
    });
}

        // è½¬ä¹‰ HTMLï¼ˆé˜²æ­¢æ³¨å…¥ï¼‰
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, function (m) { return map[m]; });
        }

          // æ˜¾ç¤ºå›¾åº“å¤§å›¾é¢„è§ˆ
    function showGalleryPreview(src, altText) {
        if (!galleryPreviewOverlay || !galleryPreviewImage) return;
        galleryPreviewImage.src = src;
        galleryPreviewImage.alt = altText || '';
        galleryPreviewOverlay.classList.add('open');
    }

    function hideGalleryPreview() {
        if (!galleryPreviewOverlay) return;
        galleryPreviewOverlay.classList.remove('open');
    }

    if (galleryPreviewClose && galleryPreviewOverlay) {
        galleryPreviewClose.addEventListener('click', hideGalleryPreview);

        // ç‚¹å‡»é®ç½©ç©ºç™½åŒºåŸŸä¹Ÿå…³é—­
        galleryPreviewOverlay.addEventListener('click', (e) => {
            if (e.target === galleryPreviewOverlay) {
                hideGalleryPreview();
            }
        });
    }

/* ---------- ä¿®å¤ï¼šhistory åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼ˆé˜²æ­¢ delta.invert ä¸¢å¤±ï¼‰ ---------- */
const Delta = Quill.import('delta');

function _toOps(deltaLike) {
  if (!deltaLike) return [];
  if (Array.isArray(deltaLike)) return deltaLike;              // ç›´æ¥å°±æ˜¯ ops æ•°ç»„
  if (Array.isArray(deltaLike.ops)) return deltaLike.ops;      // Delta æˆ– {ops:[]}
  return [];
}

function serializeHistoryStack(stack) {
  const pack = (list) => (Array.isArray(list) ? list : []).map(item => ({
    // åªå­˜ opsï¼Œé¿å…ä¸¢å¤± Delta åŸå‹æ–¹æ³•
    deltaOps: _toOps(item && item.delta),
    range: item && item.range ? { index: item.range.index, length: item.range.length } : null,
  }));
  return { undo: pack(stack && stack.undo), redo: pack(stack && stack.redo) };
}

function deserializeHistoryStack(saved) {
  const unpack = (list) => (Array.isArray(list) ? list : []).map(item => {
    // å…¼å®¹ä½ æ—§çš„ JSON.stringify ç‰ˆæœ¬ï¼š{ delta: { ops:[...] }, range:... }
    const ops = (item && item.deltaOps) || _toOps(item && item.delta) || [];
    return {
      delta: new Delta(ops),
      range: item && item.range ? { index: item.range.index, length: item.range.length } : null,
    };
  });
  return { undo: unpack(saved && saved.undo), redo: unpack(saved && saved.redo) };
}
      
/* ---------- å‘å¸ƒï¼ˆæ‰‹åŠ¨ä¿å­˜ + ç¦ç”¨æŒ‰é’®ï¼‰---------- */
publishBtn.addEventListener('click', async () => {
    if (!currentWorkId) {
        alert('è¯·å…ˆä¿å­˜ä½œå“ã€‚');
        return;
    }
    
    // è®°å½•å½“å‰æŒ‰é’®çš„æ–‡æœ¬ï¼ˆâ€œå‘å¸ƒâ€æˆ–â€œæ›´æ–°*â€æˆ–â€œå·²å‘å¸ƒâ€ï¼‰
    const originalText = publishBtn.textContent;
    // åˆ¤æ–­å½“å‰æ˜¯å¦æ˜¯å·²å‘å¸ƒçš„ä½œå“ï¼ˆå³æŒ‰é’®æ˜¾ç¤ºâ€œæ›´æ–°*â€æˆ–â€œå·²å‘å¸ƒâ€çš„æƒ…å†µï¼‰
    const isCurrentlyPublished = originalText.startsWith('æ›´æ–°') || originalText === 'å·²å‘å¸ƒ';

    // 1. ã€æ–°å¢ï¼šå…ˆå°†æŒ‰é’®ç¦ç”¨ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»ã€‘
    publishBtn.textContent = 'å¤„ç†ä¸­...'; // ç»Ÿä¸€æ˜¾ç¤ºå¤„ç†ä¸­
    publishBtn.disabled = true; 

    // 2. ã€ä¿ç•™ï¼šå…ˆæ‰§è¡Œæ‰‹åŠ¨ä¿å­˜é€»è¾‘ã€‘
    const saveSuccess = await saveWork(false); 

    if (saveSuccess) {
        
        // 3. ã€æ–°å¢ï¼šè°ƒç”¨ PATCH API å°†åç«¯å‘å¸ƒçŠ¶æ€å˜ä¸º trueã€‘
        try {
            const res = await fetch(`${API_BASE_URL}/${currentWorkId}`, {
                method: 'PATCH',
                headers: authHeaders(true),
                body: JSON.stringify({ isPublished: true }) // å…³é”®ï¼šè®¾ç½®å‘å¸ƒçŠ¶æ€
            });
            
            if (!res.ok) {
                const j = await res.json();
                throw new Error(j.message || 'å‘å¸ƒçŠ¶æ€æ›´æ–°å¤±è´¥');
            }
            
            // 4. ã€æˆåŠŸåæ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºâ€œå·²å‘å¸ƒâ€å¹¶ä¿æŒç¦ç”¨ã€‘
            publishBtn.textContent = 'å·²å‘å¸ƒ'; 
            publishBtn.disabled = true; 
            
            alert(isCurrentlyPublished ? 'ä½œå“å·²æ›´æ–°æˆåŠŸï¼' : 'ä½œå“å·²æˆåŠŸå‘å¸ƒï¼');
            addHistoryRecord(isCurrentlyPublished ? 'æ›´æ–°' : 'å‘å¸ƒ');

            // ç§»é™¤é¡µé¢è·³è½¬é€»è¾‘
            // window.location.href = `https://zhidianworld.com/read/?id=${currentWorkId}`; 

        } catch (err) {
            console.error('å‘å¸ƒ/æ›´æ–°å¤±è´¥', err);
            alert('å‘å¸ƒ/æ›´æ–°å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯ï¼ˆè¯·åœ¨è®¨è®ºé¡µ/è´´å§æ±‡æŠ¥ç»™ç«™é•¿ï¼ä½ å°†ä¼šæ”¶è·ä¸€ä»½è¯šå¿ƒè¯šæ„åœŸä¸‹åº§å¤§ç¤¼åŒ…ä»¥åŠä¿®å¤æ–¹æ¡ˆï¼‰'));
            
            // å¤±è´¥æ—¶æ¢å¤æŒ‰é’®çŠ¶æ€
            publishBtn.textContent = isCurrentlyPublished ? 'æ›´æ–°å¤±è´¥' : 'å‘å¸ƒå¤±è´¥';
            // æ¢å¤æŒ‰é’®å¯ç”¨æ€§
            publishBtn.disabled = false; 
            setTimeout(() => {
                // æ¢å¤åˆ°ä¸Šæ¬¡çš„â€œæ›´æ–°â€æˆ–â€œå‘å¸ƒâ€çŠ¶æ€
                publishBtn.textContent = isCurrentlyPublished ? 'æ›´æ–°*' : 'å‘å¸ƒ'; 
            }, 2000);
        }
    } else {
        // å¦‚æœ saveWork å¤±è´¥ï¼Œå®ƒå·²ç»å¼¹çª—æé†’äº†ç”¨æˆ·
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        publishBtn.textContent = originalText;
        publishBtn.disabled = false;
    }
});

/* ------------------- æœ€ç»ˆç¨³å®šç‰ˆï¼šåˆ é™¤å½“å‰é¡µé¢ ------------------- */
async function deleteCurrentPage() {
    if (!currentWorkId || !Array.isArray(pages) || pages.length === 0) {
        alert('æ•°æ®å¼‚å¸¸ï¼Œæ— æ³•åˆ é™¤ã€‚');
        return;
    }
    if (pages.length === 1) {
        alert('è‡³å°‘ä¿ç•™ä¸€é¡µã€‚');
        return;
    }

    const deleteIndex = currentPageIndex;
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ç¬¬ ${deleteIndex + 1} é¡µå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;

    // 1. ğŸ›‘ å½»åº•æš‚åœè‡ªåŠ¨ä¿å­˜ï¼Œé˜²æ­¢â€œæŠ¢è·‘â€ä¿å­˜äº†è¿˜æœªå¤„ç†å®Œçš„è„æ•°æ®
    const wasAutoSave = autoSaveEnabled;
    autoSaveEnabled = false;
    if (autoSaveTimer) clearInterval(autoSaveTimer); // å¼ºåˆ¶æ¸…é™¤è®¡æ—¶å™¨

    try {
        // 2. âœ…ã€æ›´æ–° Pages æ•°ç»„ã€‘
        // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦ä¿å­˜å½“å‰ quill å†…å®¹ï¼Œå› ä¸ºæˆ‘ä»¬è¦åˆ æ‰å®ƒ
        const newPages = pages.filter((_, idx) => idx !== deleteIndex);
        
        // 3. âœ…ã€é‡æ„ History å¯¹è±¡ã€‘
        // å› ä¸ºæ•°ç»„ç´¢å¼•å˜äº†ï¼ˆæ¯”å¦‚åˆ äº†ç¬¬2é¡µï¼ŒåŸæ¥çš„ç¬¬3é¡µå˜æˆäº†ç¬¬2é¡µï¼‰
        // æ‰€ä»¥ history çš„ key ä¹Ÿå¿…é¡»è·Ÿç€ç§»ä½ï¼Œå¦åˆ™æ’¤é”€è®°å½•ä¼šä¸²å°
        const newHistories = {};
        Object.keys(pageHistories).forEach(key => {
            const idx = parseInt(key);
            if (idx < deleteIndex) {
                // åˆ é¡µä¹‹å‰çš„é¡µç ä¸å˜
                newHistories[idx] = pageHistories[idx];
            } else if (idx > deleteIndex) {
                // åˆ é¡µä¹‹åçš„é¡µç  -1
                newHistories[idx - 1] = pageHistories[idx];
            }
            // ç­‰äº deleteIndex çš„ç›´æ¥ä¸¢å¼ƒ
        });
        pageHistories = newHistories; // åº”ç”¨æ–°çš„å†å²è®°å½•è¡¨

        // 4. è®¡ç®—æ–°çš„å½“å‰é¡µç ï¼ˆå¦‚æœåˆ çš„æ˜¯æœ€åä¸€é¡µï¼Œå°±å‰ç§»ï¼‰
        let nextIndex = deleteIndex;
        if (nextIndex >= newPages.length) {
            nextIndex = newPages.length - 1;
        }

        // 5. åº”ç”¨åˆ°å…¨å±€å˜é‡
        pages = newPages;
        currentPageIndex = nextIndex;

        // 6. åŠ è½½æ–°çš„å½“å‰é¡µåˆ°ç¼–è¾‘å™¨
        const nextContent = pages[currentPageIndex]?.content || { ops: [] };
        quill.setContents(nextContent, 'silent'); // silent åŠ è½½
        
        // æ¢å¤è¯¥é¡µçš„å†å²ï¼ˆå¦‚æœæœ‰ï¼‰
        quill.history.clear();
if (pageHistories[currentPageIndex]) {
  quill.history.stack = deserializeHistoryStack(pageHistories[currentPageIndex]);
} else {
  quill.history.stack = { undo: [], redo: [] };
}


        // 7. æ›´æ–° UI
        renderPageList();
        updatePageDisplay();

        // 8. âœ…ã€å¼ºåˆ¶åŒæ­¥åç«¯ã€‘
        // ä½¿ç”¨ pages å­—æ®µå‘é€ï¼Œç¡®ä¿åç«¯åŒæ—¶æ›´æ–°
        const res = await fetch(`${API_BASE_URL}/${currentWorkId}`, {
  method: 'PATCH',
  headers: authHeaders(true),
  body: JSON.stringify({
    title: editorTitle.textContent.replace('æ­£åœ¨ç¼–è¾‘ï¼š', ''),
    pages: pages
  })
});
if (!res.ok) throw new Error('åŒæ­¥åˆ é™¤å¤±è´¥');
        
        // æˆåŠŸæç¤º
        hasUnsavedChanges = false;
        saveBtn.textContent = 'å·²ä¿å­˜';
        addHistoryRecord(`åˆ é™¤ç¬¬ ${deleteIndex + 1} é¡µ`);

    } catch (err) {
        console.error('åˆ é™¤é¡µé¢å¤±è´¥:', err);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
    } finally {
        // 9. æ¢å¤è‡ªåŠ¨ä¿å­˜
        if (wasAutoSave) {
            autoSaveEnabled = true;
            startAutoSave(); // é‡æ–°å¯åŠ¨è®¡æ—¶å™¨
        }
    }
}


        /* ---------- é¡µç ç®¡ç†ï¼ˆç»Ÿä¸€ä½¿ç”¨ pages ä¸ currentPageIndexï¼‰---------- */
        function updatePageDisplay() {
            // æŠŠå½“å‰é¡µå’Œæ€»é¡µæ•°å†™å› DOMï¼ˆä½ é¡µé¢é‡Œæœ‰ currentPage spanï¼‰
            if (currentPageSpan) {
                currentPageSpan.textContent = String(currentPageIndex + 1);
            }
        }

        function renderPageList() {
            pageList.innerHTML = '';
            pages.forEach((p, idx) => {
                const li = document.createElement('li');
                li.textContent = `ç¬¬ ${idx + 1} é¡µ`;
                li.dataset.pageIndex = String(idx);
                if (idx === currentPageIndex) li.classList.add('active');
                li.addEventListener('click', () => {
                    goToPage(idx);
                    pageDropdown.classList.add('hidden');
                });
                pageList.appendChild(li);
            });
        }

        pageCurrentDisplay.addEventListener('click', () => {
            pageDropdown.classList.toggle('hidden');
            renderPageList();
        });

deletePageBtn.addEventListener('click', deleteCurrentPage);

        addPageBtn.addEventListener('click', () => {
  // æ–°å»ºç©ºé¡µï¼ˆæ ‡å‡† Deltaï¼‰
  pages.push({ content: { ops: [] } });
  const newIndex = pages.length - 1;

  // ç»™æ–°é¡µå‡†å¤‡ç©ºå†å²ï¼ˆåºåˆ—åŒ–æ ¼å¼ï¼‰
  pageHistories[newIndex] = { undo: [], redo: [] };

  // ç»Ÿä¸€èµ°åˆ‡é¡µé€»è¾‘ï¼ˆä¿å­˜æ—§é¡µå†…å®¹+æ—§é¡µå†å²ã€silent åŠ è½½ã€æ–°é¡µå†å²æ¢å¤ã€è‡ªåŠ¨ä¿å­˜æš‚åœ/æ¢å¤ï¼‰
  goToPage(newIndex);

  renderPageList();
  updatePageDisplay();
});



        /* ---------- åˆ‡æ¢é¡µç ï¼ˆå¸¦å†å²è®°å½•éš”ç¦»ï¼‰---------- */
function goToPage(index) {
    if (index < 0 || index >= pages.length || index === currentPageIndex) return;

    // 1. æš‚åœè‡ªåŠ¨ä¿å­˜ï¼Œé˜²æ­¢åˆ‡é¡µè¿‡ç¨‹ä¸­çš„çŠ¶æ€æ··ä¹±
    const wasAutoSave = autoSaveEnabled;
    autoSaveEnabled = false;

    // 2. ã€ä¿å­˜æ—§é¡µã€‘ï¼šä¿å­˜å½“å‰é¡µå†…å®¹
    pages[currentPageIndex].content = quill.getContents();

    // âœ…ã€å…³é”®ï¼šä¿å­˜æ—§é¡µçš„å†å²è®°å½•ã€‘
    // Quill çš„ history æ¨¡å—åŒ…å« stackï¼ˆundo/redo æ ˆï¼‰
    if (quill.history) {
        // æ·±æ‹·è´ stack ä»¥é˜²å¼•ç”¨è¢«ä¿®æ”¹
        pageHistories[currentPageIndex] = serializeHistoryStack(quill.history.stack);
    }

    // 3. ã€åˆ‡æ¢ç´¢å¼•ã€‘
    currentPageIndex = index;

    // 4. ã€åŠ è½½æ–°é¡µå†…å®¹ã€‘
    const nextContent = pages[currentPageIndex]?.content || { ops: [] };
    // ä½¿ç”¨ 'silent' é¿å…è§¦å‘ user æ¥æºçš„ change äº‹ä»¶
    quill.setContents(nextContent, 'silent');

    // 5. âœ…ã€å…³é”®ï¼šæ¢å¤æ–°é¡µçš„å†å²è®°å½•ã€‘
    if (quill.history) {
        quill.history.clear();
if (pageHistories[currentPageIndex]) {
  quill.history.stack = deserializeHistoryStack(pageHistories[currentPageIndex]);
} else {
  quill.history.stack = { undo: [], redo: [] };
}

        // å¦‚æœæ²¡æœ‰å­˜è¿‡ï¼ˆç¬¬ä¸€æ¬¡ç‚¹å¼€è¿™ä¸€é¡µï¼‰ï¼Œhistory å°±æ˜¯ç©ºçš„ï¼Œè¿™æ˜¯å¯¹çš„
    }

    // 6. æ›´æ–° UI
    updatePageDisplay();
    renderPageList();
    pageDropdown.classList.add('hidden'); // é¡ºæ‰‹å…³æ‰ä¸‹æ‹‰èœå•

    // 7. æ¢å¤è‡ªåŠ¨ä¿å­˜
    setTimeout(() => {
        autoSaveEnabled = wasAutoSave;
    }, 50);
}

        /* ---------- éª°å­ï¼ˆéšæœºï¼‰---------- */
        // 2. åˆ‡æ¢éª°å­è®°å½•çš„æ˜¾ç¤º/éšè—çŠ¶æ€ (ä½¿ç”¨ç°æœ‰ä¸‹æ‹‰èœå•çš„é€»è¾‘) 
        if (diceLogDropdownHeader) {
            diceLogDropdownHeader.addEventListener('click', () => {
                diceLogDropdownContent.classList.toggle('open');
            });
        }

 /* ---------- éª°å­ï¼ˆéšæœºï¼‰---------- */
// æ ¸å¿ƒé€»è¾‘ï¼šè·å– N, æ·éª°, æ’å…¥ç¼–è¾‘å™¨, è®°å½•åˆ°åç«¯å’Œå‰ç«¯åˆ—è¡¨
async function rollDiceLogic() {
    const max = prompt("è¯·è¾“å…¥éª°å­çš„æœ€å¤§å€¼ (1åˆ°1000):");
    if (max === null) return;
    const maxNum = parseInt(max, 10);
    if (isNaN(maxNum) || maxNum < 1 || maxNum > 1000) {
        alert('è¯·è¾“å…¥ 1 åˆ° 1000 çš„æ•´æ•°');
        return;
    }

    const result = Math.floor(Math.random() * maxNum) + 1;
    const diceType = `1D${maxNum}`;
    const rollResultText = `ã€${diceType}=${result}ã€‘`;

    // 1. æ’å…¥ç»“æœåˆ° Quill ç¼–è¾‘å™¨
    const range = quill.getSelection(true);
    if (range) {
        quill.insertText(range.index, rollResultText + ' ');
        quill.setSelection(range.index + rollResultText.length + 1, 0);
    } else {
        quill.insertText(quill.getLength(), rollResultText);
        quill.setSelection(quill.getLength(), 0);
    }

    // 2. æœ¬åœ°è®°å½•ï¼ˆæ·»åŠ åˆ°ä¸‹æ‹‰åˆ—è¡¨ï¼‰
    logDiceResult(diceType, result, rollResultText, new Date());

    // 3. è°ƒç”¨åç«¯ API è®°å½•
    if (currentWorkId) {
        try {
            await fetch(`/api/work/${currentWorkId}/dice-log`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    rollType: diceType,
                    result: result,
                    rollText: rollResultText
                })
            });
        } catch (error) {
            console.error('è®°å½•éª°å­ç»“æœåˆ°åç«¯å¤±è´¥:', error);
        }
    } else {
        console.warn('æœªåŠ è½½ä½œå“ï¼Œè·³è¿‡åç«¯éª°å­è®°å½•ã€‚');
    }
}

// 2. åˆ‡æ¢éª°å­è®°å½•çš„æ˜¾ç¤º/éšè—çŠ¶æ€ (ä½¿ç”¨ç°æœ‰ä¸‹æ‹‰èœå•çš„é€»è¾‘) 
if (diceLogDropdownHeader) {
    diceLogDropdownHeader.addEventListener('click', () => {
        diceLogDropdownContent.classList.toggle('open');
    });
}

// 3. ç»‘å®šéª°å­æŒ‰é’®ç‚¹å‡»äº‹ä»¶ (ç°åœ¨è°ƒç”¨æ•´åˆåçš„æ ¸å¿ƒé€»è¾‘)
if (diceBtn) {
    diceBtn.addEventListener('click', rollDiceLogic);
}

// (logDiceResult å‡½æ•°ä¿ç•™åœ¨ä¸‹æ–¹ï¼Œæ— éœ€ä¿®æ”¹)
// ...

        function logDiceResult(type, result, resultText, date) {
            const now = date || new Date(); // ä½¿ç”¨ä¼ å…¥çš„æ—¶é—´æˆ–å½“å‰æ—¶é—´
            // æ ¼å¼åŒ–æ—¶é—´ä¸º HH:mm:ss
            const timeString = now.toTimeString().split(' ')[0];

            const logItem = document.createElement('li');
            logItem.classList.add('role-item');
            logItem.style.padding = '8px 10px';
            logItem.style.borderBottom = '1px dashed #eee';
            logItem.style.cursor = 'default';

            logItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                    <span style="font-weight: bold; color: #0077cc;">${result}</span>
                    <span style="color: #666; font-size: 0.8rem;">${timeString}</span>
                </div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 3px;">
                    æ·éª°ç±»å‹: ${type}
                </div>
            `;

            // å°†æ–°è®°å½•æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨ (æœ€æ–°è®°å½•åœ¨æœ€ä¸Š)
            if (diceLogList) {
                if (diceLogList.firstChild) {
                    diceLogList.insertBefore(logItem, diceLogList.firstChild);
                } else {
                    diceLogList.appendChild(logItem);
                }
            }
        }

        /* ---------------------------------------------------- */
        /* ---------- END: éª°å­è®°å½•åŠŸèƒ½ (Dice Log) ---------- */
        /* ---------------------------------------------------- */

  /* ---------- L10 åˆ—è¡¨æŒ‰éˆ• ---------- */
listBtn.addEventListener('click', () => {
    // æ’å…¥ä¸€ä¸ªä»1åˆ°10çš„æœ‰åºåˆ—è¡¨
    const listItems = Array.from({ length: 10 }, (_, i) => `${i + 1}. `).join('\n');
    const range = quill.getSelection();
    
    // å¦‚æœæœ‰é¸å–ç¯„åœï¼Œå°‡å…§å®¹æ’å…¥åˆ°é¸å–ä½ç½®
    if (range) {
        quill.insertText(range.index, listItems);
    } else {
        // å¦‚æœæ²’æœ‰é¸å–ç¯„åœï¼Œå°‡å…§å®¹æ’å…¥åˆ°ç·¨è¼¯å™¨çµå°¾
        quill.insertText(quill.getLength(), listItems);
    }
});

      /* ---------- 2. æ–°å¢æŒ‰é’®é€»è¾‘ ---------- */

// 2.1 ä¸»é¢˜åˆ‡æ¢æ ‡è®°æ’å…¥é€»è¾‘
// å‡è®¾æ‚¨åœ¨ HTML å·¥å…·æ ä¸­æ·»åŠ äº†ä¸€ä¸ª ID ä¸º 'insertThemeTriggerBtn' çš„æŒ‰é’®
const insertThemeTriggerBtn = document.getElementById('insertThemeTriggerBtn');

if (insertThemeTriggerBtn) {
    insertThemeTriggerBtn.addEventListener('click', () => {
        const themeName = prompt("è¯·è¾“å…¥è¦åˆ‡æ¢çš„ä¸»é¢˜åç§° (ä¾‹å¦‚: night-mode, chapter-2-theme):");
        if (!themeName) return;

        const range = quill.getSelection(true);
        if (range) {
            // æ’å…¥è‡ªå®šä¹‰ Block Embed Blot
            quill.insertEmbed(range.index, 'themeTrigger', themeName, Quill.sources.USER);
            quill.setSelection(range.index + 1, 0); // ç§»åŠ¨å…‰æ ‡åˆ°æ ‡è®°å
        }
    });
}

    /* ---------- å³ä¾§æ åˆ‡æ¢ ---------- */
    if (rightSidebarToggle && rightSidebar) {
        rightSidebarToggle.addEventListener('click', () => rightSidebar.classList.toggle('collapsed'));
    }

    /* ---------- è§’è‰²ç›¸å…³ï¼šfetch/add/update/delete & render ---------- */
    async function fetchRoles(workId) {
        if (!workId) return [];
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles`, { headers: authHeaders(false) });
            if (!res.ok) {
                console.warn('fetchRoles failed', res.status);
                return [];
            }
            return await res.json();
        } catch (err) {
            console.error('fetchRoles error', err);
            return [];
        }
    }

    async function addRole(workId, roleData) {
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles`, {
                method: 'POST', headers: authHeaders(true), body: JSON.stringify(roleData)
            });
            if (!res.ok) throw new Error('addRole failed');
            return await res.json();
        } catch (err) {
            console.error('addRole error', err);
            return null;
        }
    }

    async function updateRole(workId, roleId, roleData) {
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles/${roleId}`, {
                method: 'PUT', headers: authHeaders(true), body: JSON.stringify(roleData)
            });
            if (!res.ok) throw new Error('updateRole failed');
            return await res.json();
        } catch (err) {
            console.error('updateRole error', err);
            return null;
        }
    }

    async function deleteRole(workId, roleId) {
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles/${roleId}`, {
                method: 'DELETE', headers: authHeaders(false)
            });
            return res.ok;
        } catch (err) {
            console.error('deleteRole error', err);
            return false;
        }
    }

    // æ¸²æŸ“è§’è‰²åˆ—è¡¨ï¼ˆå¹¶ç»‘å®šç¼–è¾‘/åˆªé™¤/é¸æ“‡äº‹ä»¶ï¼‰
    function renderRoles() {
        roleList.innerHTML = '';
        roles.forEach(role => {
            const li = document.createElement('li');
            li.className = 'role-item';
            li.innerHTML = `
                <div class="role-title-wrapper" data-role-id="${role._id}">
                    <span class="role-select-btn" data-color="${role.color}" title="é€‰æ‹©è§’è‰²"></span>
                    <div class="role-title">
                        <span class="color-dot" style="background-color: ${role.color};"></span>
                        ${escapeHtml(role.name)}
                    </div>
                    <div class="role-actions">
                        <span class="edit-btn" style="cursor:pointer;color:#0077cc;">ç¼–è¾‘</span>
                        <span class="role-gallery-btn" data-role-id="${role._id}">æ˜¾ç¤ºç»‘å®šå›¾åº“</span>
                        <span class="delete-btn" style="cursor:pointer;color:#dc3545;margin-left:8px;">åˆªé™¤</span>
                    </div>
                </div>
                <div class="role-item-notes">${escapeHtml(role.notes || '')}</div>
            `;
            // å±•å¼€å¤‡æ³¨
            li.querySelector('.role-title-wrapper').addEventListener('click', (e) => {
                if (e.target.closest('.role-actions') || e.target.closest('.role-select-btn')) return;
                const notes = li.querySelector('.role-item-notes');
                notes.classList.toggle('open');
            });
            // ç¼–è¾‘
            li.querySelector('.edit-btn').addEventListener('click', () => {
                currentEditRoleId = role._id;
                roleModal.querySelector('h3').textContent = 'ç¼–è¾‘è§’è‰²';
                roleNameInput.value = role.name || '';
                roleNotesTextarea.value = role.notes || '';
                roleColorPicker.value = role.color || '#000000';
                roleModal.style.display = 'block';
            });
            // åˆªé™¤
            li.querySelector('.delete-btn').addEventListener('click', async () => {
                if (!confirm(`ç¡®å®šåˆªé™¤è§’è‰² "${role.name}" å—ï¼Ÿ`)) return;
                const ok = await deleteRole(currentWorkId, role._id);
                if (ok) {
                    roles = roles.filter(r => r._id !== role._id);
                    renderRoles();
                } else alert('åˆªé™¤å¤±è´¥');
            });
            // é¸æ“‡æŒ‰é’®
            const selectBtn = li.querySelector('.role-select-btn');
            selectBtn.addEventListener('click', () => {
                const wasActive = selectBtn.classList.contains('active');
                // æ¸…é™¤æ‰€æœ‰
                document.querySelectorAll('.role-select-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.role-item').forEach(it => it.classList.remove('selected'));
                if (!wasActive) {
                    selectBtn.classList.add('active');
                    li.classList.add('selected');
                    selectedRoleColor = selectBtn.dataset.color;
                    // æŠŠé¢œè‰²åº”ç”¨åˆ° quill çš„åç»­è¼¸å…¥
                    quill.format('color', selectedRoleColor);
                } else {
                    // å–æ¶ˆé¸æ“‡
                    selectedRoleColor = null;
                    quill.format('color', false);
                }
            });

            // å¦‚æœå½“å‰é¢œè‰²å’Œ selectedRoleColor ä¸€è‡´ï¼Œæ ‡è®°
            if (selectedRoleColor && selectedRoleColor === role.color) {
                selectBtn.classList.add('active');
                li.classList.add('selected');
            }


            roleList.appendChild(li);
        });
    }

    // æ‰“å¼€è§’è‰² modal
    addRoleBtn.addEventListener('click', () => {
        currentEditRoleId = null;
        roleModal.querySelector('h3').textContent = 'æ·»åŠ è§’è‰²';
        roleNameInput.value = '';
        roleNotesTextarea.value = '';
        roleColorPicker.value = '#000000';
        roleModal.style.display = 'block';
    });

    cancelRoleBtn.addEventListener('click', () => roleModal.style.display = 'none');

    confirmRoleBtn.addEventListener('click', async () => {
        const name = roleNameInput.value.trim();
        if (!name) { alert('è§’è‰²åä¸èƒ½ä¸ºç©º'); return; }
        const roleData = { name: name, notes: roleNotesTextarea.value.trim(), color: roleColorPicker.value };
        let result = null;
        if (currentEditRoleId) {
            result = await updateRole(currentWorkId, currentEditRoleId, roleData);
            if (result) {
                roles = roles.map(r => r._id === currentEditRoleId ? result : r);
            }
        } else {
            result = await addRole(currentWorkId, roleData);
            if (result) roles.push(result);
        }
        if (result) {
            renderRoles();
            roleModal.style.display = 'none';
            alert('è§’è‰²æ“ä½œæˆåŠŸ');
        } else {
            alert('è§’è‰²æ“ä½œå¤±è´¥');
        }
    });

    roleDropdownHeader.addEventListener('click', () => {
        roleDropdownContent.classList.toggle('open');
        roleDropdownHeader.classList.toggle('open');
    });

  // ä» URL ä¸­ç®€å•æå–ä¸€ä¸ªâ€œæ–‡ä»¶åâ€å½“ä½œé¢„è§ˆåç§°
function getImageNameFromUrl(url) {
    try {
        const withoutQuery = url.split('?')[0];
        const parts = withoutQuery.split('/');
        return parts[parts.length - 1] || 'æœªå‘½å';
    } catch (e) {
        return 'æœªå‘½å';
    }
}

// æ›¿æ¢åŸæ¥çš„ renderGalleryImages
function renderGalleryImages() {
    // æ¸…ç©ºç°æœ‰å›¾ç‰‡ï¼Œä¿ç•™ä¸Šä¼ æŒ‰é’®
    galleryImageList.querySelectorAll('.gallery-image-item').forEach(item => item.remove());
    
    galleryImages.forEach((imageUrl, idx) => {
        const imgItem = document.createElement('div');
        imgItem.className = 'gallery-image-item';

        const displayName = getImageNameFromUrl(imageUrl) || `å›¾ç‰‡ ${idx + 1}`;

                imgItem.innerHTML = `
            <div class="thumb-wrapper">
                <img src="${imageUrl}" alt="${escapeHtml(displayName)}">
            </div>
            <div class="img-name">${escapeHtml(displayName)}</div>
            <span class="expand-btn" title="æ”¾å¤§é¢„è§ˆ">â¤¢</span>
            <span class="delete-btn">Ã—</span>
        `;

        galleryImageList.prepend(imgItem);
    });
}


    // å›¾ç‰‡ä¸Šä¼ äº‹ä»¶ç›‘å¬
// å›¾ç‰‡ä¸Šä¼ äº‹ä»¶ç›‘å¬ (æ–°ç‰ˆæœ¬ï¼Œå·²åŠ å…¥å‹ç¼©)
imageUploadInput.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (files.length === 0) return;

    // ä¸ºäº†æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªåŠ è½½æŒ‡ç¤ºå™¨
    // showLoadingIndicator(); 

    for (const file of files) {
        try {
            // å®šä¹‰å‹ç¼©é€‰é¡¹
            const options = {
                maxSizeMB: 0.5, // æœ€å¤§æ–‡ä»¶å¤§å°ï¼Œå•ä½MBã€‚å¦‚æœå›¾ç‰‡å°äºè¿™ä¸ªå€¼ï¼Œåˆ™ä¸å‹ç¼©ã€‚
                maxWidthOrHeight: 1920, // å…è®¸çš„æœ€å¤§å®½åº¦æˆ–é«˜åº¦
                useWebWorker: true // ä½¿ç”¨ Web Workerï¼Œå¯ä»¥é¿å…é˜»å¡ä¸»çº¿ç¨‹
            };

            // è°ƒç”¨å‹ç¼©å‡½æ•°
            const compressedFile = await imageCompression(file, options);
            console.log('åŸå§‹æ–‡ä»¶å¤§å°:', (file.size / 1024).toFixed(2), 'KB');
            console.log('å‹ç¼©åæ–‡ä»¶å¤§å°:', (compressedFile.size / 1024).toFixed(2), 'KB');
            
            // ä½¿ç”¨ FormData æ¥åŒ…è£…å‹ç¼©åçš„æ–‡ä»¶
            const formData = new FormData();
            // åœ¨ append æ—¶æä¾›åŸå§‹æ–‡ä»¶åï¼Œé˜²æ­¢åç«¯å­˜å‚¨æ—¶ä¸¢å¤±æ–‡ä»¶æ‰©å±•å
            formData.append('image', compressedFile, file.name); 

            // å‘é€åˆ°åç«¯ä¸Šä¼ æ¥å£
            const res = await fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                headers: {
                    // æ³¨æ„ï¼šä¸Šä¼  FormData æ—¶ï¼Œä¸è¦æ‰‹åŠ¨è®¾ç½® 'Content-Type'
                    'Authorization': `Bearer ${localStorage.getItem('token')}` 
                },
                body: formData
            });

            if (!res.ok) {
                throw new Error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
            }

            const result = await res.json();
            
            // å°†åç«¯è¿”å›çš„çœŸå® URL æ·»åŠ åˆ°æ•°ç»„
            galleryImages.push(result.imageUrl);

        } catch (err) {
            console.error('ä¸Šä¼ é”™è¯¯ï¼ˆè¯·åœ¨è®¨è®ºé¡µ/è´´å§æ±‡æŠ¥ç»™ç«™é•¿ï¼ä½ å°†ä¼šæ”¶è·ä¸€ä»½è¯šå¿ƒè¯šæ„åœŸä¸‹åº§å¤§ç¤¼åŒ…ä»¥åŠä¿®å¤æ–¹æ¡ˆï¼‰:', err);
            alert('æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
        }
    }

    // æ‰€æœ‰å›¾ç‰‡å¤„ç†å®Œæ¯•åï¼Œé‡æ–°æ¸²æŸ“å›¾åº“
    renderGalleryImages();
    // hideLoadingIndicator();
});

// åŒæ ·ï¼Œä½ ä¹Ÿå¯ä»¥å°†å‹ç¼©é€»è¾‘åº”ç”¨åˆ° Quill çš„å›¾ç‰‡ä¸Šä¼ ä¸­
// æ‰¾åˆ° uploadFileToImgBB(file) å‡½æ•°ï¼Œå¹¶åœ¨å†…éƒ¨è°ƒç”¨ imageCompression
async function uploadFileToImgBB(file) {
  try {
    const compressedFile = await imageCompression(file, { maxSizeMB: 0.5, maxWidthOrHeight: 1280 });
    const reader = new FileReader();
    return new Promise((resolve, reject) => {
      reader.onloadend = async () => {
        try {
          // ... (æ­¤å¤„ä¿ç•™ä½ åŸæœ‰çš„ imgbb ä¸Šä¼ é€»è¾‘ï¼Œä½†ä½¿ç”¨ compressedFile)
          const base64Image = reader.result.split(',')[1];
          const formData = new FormData();
          formData.append('image', base64Image);
          // ä»ç„¶ç›´æ¥è¯·æ±‚ imgbbï¼Œå»ºè®®æ”¹ä¸ºåç«¯ä»£ç†
          const response = await fetch('https://api.imgbb.com/1/upload?key=040dbc9e6e680f321e09d9e05f447094', {
              method: 'POST',
              body: formData
          });
          const data = await response.json();
          if (data && data.success) {
              resolve(data.data.url);
          } else {
              reject(new Error('å›¾åºŠä¸Šä¼ å¤±è´¥'));
          }
        } catch (err) {
          reject(err);
        }
      };
      reader.readAsDataURL(compressedFile);
    });
  } catch (err) {
    console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥æˆ–ä¸Šä¼ åˆ°ImgBBå¤±è´¥:', err);
    throw err;
  }
}

// å›¾ç‰‡åˆ é™¤ / å±•å¼€é¢„è§ˆ / é€‰æ‹©æ’å…¥ äº‹ä»¶ç›‘å¬
galleryImageList.addEventListener('click', (e) => {
    const target = e.target;

    // --- é€»è¾‘ 0ï¼šç‚¹å‡»â€œå±•å¼€â€æŒ‰é’® â†’ åªé¢„è§ˆï¼Œä¸æ’å…¥ç¼–è¾‘å™¨ ---
    if (target.classList.contains('expand-btn')) {
        const item = target.closest('.gallery-image-item');
        const imgEl = item && item.querySelector('img');
        if (imgEl) {
            showGalleryPreview(imgEl.src, imgEl.alt || '');
        }
        return; // é˜»æ­¢åé¢ç»§ç»­æ‰§è¡Œ
    }

    // --- é€»è¾‘ 1ï¼šç‚¹å‡»åˆ é™¤æŒ‰é’® ---
    if (target.classList.contains('delete-btn')) {
        const item = target.closest('.gallery-image-item');
        const imageUrl = item.querySelector('img').src;
        galleryImages = galleryImages.filter(img => img !== imageUrl);
        renderGalleryImages();
    } 
    // --- é€»è¾‘ 2ï¼šç‚¹å‡»å›¾ç‰‡æœ¬èº« â†’ æ’å…¥åˆ°ç¼–è¾‘å™¨ ---
    else if (target.tagName === 'IMG') {
        const range = quill.getSelection(true);
        if (range) {
            quill.insertEmbed(range.index, 'image', target.src);
            quill.setSelection(range.index + 1);
            galleryModal.style.display = 'none';
            document.body.classList.remove('modal-active');
        } else {
            alert('è¯·å…ˆå°†å…‰æ ‡å®šä½åˆ°ç¼–è¾‘å™¨ä¸­éœ€è¦æ’å…¥å›¾ç‰‡çš„ä½ç½®ã€‚');
        }
    }
});


    // å–æ¶ˆæŒ‰é’®
    cancelGalleryBtn.addEventListener('click', () => {
        galleryModal.style.display = 'none';
        currentRoleForGallery = null;
      // æ–°å¢ï¼šå…³é—­å¼¹çª—æ—¶ç§»é™¤ç±»ï¼Œé‡æ–°æ˜¾ç¤ºå·¥å…·æ 
        document.body.classList.remove('modal-active');
    });

// ç¡®è®¤æŒ‰é’® (å°†å›¾åº“æ•°æ®å‘é€åˆ°åç«¯)
    confirmGalleryBtn.addEventListener('click', async () => {
        if (!currentRoleForGallery || !currentWorkId) {
            alert('é”™è¯¯ï¼ˆè¯·åœ¨è®¨è®ºé¡µ/è´´å§æ±‡æŠ¥ç»™ç«™é•¿ï¼ä½ å°†ä¼šæ”¶è·ä¸€ä»½è¯šå¿ƒè¯šæ„åœŸä¸‹åº§å¤§ç¤¼åŒ…ä»¥åŠä¿®å¤æ–¹æ¡ˆï¼‰ï¼šæ— æ³•ç¡®å®šå½“å‰ä½œå“æˆ–è§’è‰²ã€‚');
            return;
        }

        try {
            // è·å–ç”¨æˆ·çš„è®¤è¯ä»¤ç‰Œ
            const token = localStorage.getItem('token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const roleId = currentRoleForGallery._id;
            const url = `${API_BASE_URL}/${currentWorkId}/roles/${roleId}`; 

          // --- æ–°å¢è°ƒè¯•ä»£ç  ---
    console.log("å‰ç«¯å³å°†å‘é€ PUT è¯·æ±‚:");
    console.log("Work ID:", currentWorkId);
    console.log("Role ID:", roleId);
    console.log("Request URL:", url);
    // --- è°ƒè¯•ä»£ç ç»“æŸ ---
            
            // æ„å»ºå‘é€åˆ°åç«¯çš„æ•°æ®ï¼ŒåŒ…å« name, notes, color å’Œ gallery
            const roleData = {
                name: currentRoleForGallery.name,
                notes: currentRoleForGallery.notes,
                color: currentRoleForGallery.color,
                gallery: galleryImages // è¿™é‡Œçš„ galleryImages æ˜¯æˆ‘ä»¬åŠ¨æ€ç®¡ç†å›¾ç‰‡URLçš„æ•°ç»„
            };

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(roleData)
            });

            if (response.ok) {
                const updatedRole = await response.json();
                
                // å°†æ›´æ–°åçš„æ•°æ®åŒæ­¥åˆ°å‰ç«¯çš„è§’è‰²å¯¹è±¡
                Object.assign(currentRoleForGallery, updatedRole);
                
                alert('å›¾åº“ä¿å­˜æˆåŠŸï¼');
                galleryModal.style.display = 'none'; // å…³é—­å¼¹çª—
              // æ–°å¢ï¼šå…³é—­å¼¹çª—æ—¶ç§»é™¤ç±»ï¼Œé‡æ–°æ˜¾ç¤ºå·¥å…·æ 
                document.body.classList.remove('modal-active');
                renderRoles(); // é‡æ–°æ¸²æŸ“è§’è‰²åˆ—è¡¨ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
            } else {
                const errorData = await response.json();
                alert(`ä¿å­˜å¤±è´¥ï¼š${errorData.message}`);
            }

        } catch (error) {
            console.error('ä¿å­˜å›¾åº“å¤±è´¥:', error);
            alert('ä¿å­˜å›¾åº“å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åå†è¯•ã€‚');
        }
    });

      // è‡ªåŠ¨ä¿å­˜å¼€å…³æŒ‰é’®
const autoSaveToggleBtn = document.getElementById('autoSaveToggleBtn');

// é»˜è®¤å¼€å¯ï¼ˆä½ çš„ autoSaveEnabled = trueï¼‰
autoSaveToggleBtn.textContent = "è‡ªåŠ¨ä¿å­˜ï¼šå¼€";
autoSaveToggleBtn.classList.add("autosave-on");

// ç‚¹å‡»åˆ‡æ¢
autoSaveToggleBtn.addEventListener('click', () => {
    autoSaveEnabled = !autoSaveEnabled;

    if (autoSaveEnabled) {
        autoSaveToggleBtn.textContent = "è‡ªåŠ¨ä¿å­˜ï¼šå¼€";
        autoSaveToggleBtn.classList.remove("autosave-off");
        autoSaveToggleBtn.classList.add("autosave-on");

        startAutoSave(); // é‡æ–°å¯åŠ¨è‡ªåŠ¨ä¿å­˜
        console.log("è‡ªåŠ¨ä¿å­˜å·²å¼€å¯");
    } else {
        autoSaveToggleBtn.textContent = "è‡ªåŠ¨ä¿å­˜ï¼šå…³";
        autoSaveToggleBtn.classList.remove("autosave-on");
        autoSaveToggleBtn.classList.add("autosave-off");

        // åœæ­¢è‡ªåŠ¨ä¿å­˜ interval
        if (autoSaveTimer) clearInterval(autoSaveTimer);

        console.log("è‡ªåŠ¨ä¿å­˜å·²å…³é—­");
    }
});


    /* ---------- å…¶å®ƒ UI äº‹ä»¶ ---------- */
    // é€€å‡º
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('æ˜¯å¦é€€å‡ºç™»å½•ï¼Ÿ')) {
                localStorage.removeItem('token');
                window.location.href = 'https://zhidianworld.com/login/';
            }
        });
    }

    // è¿”å›ä½œå“åˆ—è¡¨
    backBtn.addEventListener('click', () => {
        sidebar.classList.remove('sidebar-collapsed');
        editorPage.classList.add('hidden');
        mainPage.classList.remove('hidden');
        currentWorkId = null;
        loadWorks();
    });

    /* ---------- å·¥å…·ï¼šé¡µé¢åˆå§‹è½½å…¥ ---------- */
    // é¦–æ¬¡è½½å…¥ä½œå“åˆ—è¡¨
    loadWorks();

    /* ---------- å¸®åŠ©ï¼šHTML è½¬ä¹‰ï¼ˆå®‰å…¨ï¼‰ ---------- */
    function escapeHtml(text) {
        const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
        return String(text || '').replace(/[&<>"']/g, function(m){ return map[m]; });
    }

  // æ­£ç¡®çš„äº‹ä»¶å§”æ‰˜ï¼šå¤„ç†è§’è‰²åˆ—è¡¨ä¸Šçš„ç‚¹å‡»äº‹ä»¶
    // æ­¤ä»£ç å—åº”æ”¾åœ¨æ‰€æœ‰å‡½æ•°å®šä¹‰ä¹‹åï¼Œä½†åœ¨ document.addEventListener å†…éƒ¨
    roleList.addEventListener('click', (e) => {
        const target = e.target.closest('span'); // ä½¿ç”¨ closest æ¥ç¡®ä¿æ‰¾åˆ°æ­£ç¡®çš„å…ƒç´ 
        if (!target) return;
        
        // å¤„ç†â€œæ˜¾ç¤ºç»‘å®šå›¾åº“â€æŒ‰é’®ç‚¹å‡»
        if (target.classList.contains('role-gallery-btn')) {
            const roleId = target.dataset.roleId;
            const role = roles.find(r => r._id === roleId);
            if (role) {
                currentRoleForGallery = role;
                galleryImages = role.gallery || [];
                renderGalleryImages();
                // æ–°å¢ï¼šåœ¨æ˜¾ç¤ºå¼¹çª—å‰ï¼Œä¸º body æ·»åŠ ç±»ä»¥éšè—å·¥å…·æ 
                document.body.classList.add('modal-active');
                galleryModal.style.display = 'flex'; // æ˜¾ç¤ºå¼¹çª—
            }
        }
    });

 

}); // end DOMContentLoaded
</script>
</head>
</html>
