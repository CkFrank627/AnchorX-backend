<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>创作页面</title>
    <link href="https://api.anchorx.ca/vendor_assets/quill.snow.css" rel="stylesheet">

<style> /* 隐藏类 */ .hidden {
  display:none !important;
}
/* 整个页面容器 */ body {
  margin:0;
  padding:0;
  font-family:Arial,sans-serif;
  background-color:#f0f2f5;
}
.page-container {
  display:flex;
  min-height:100vh;
  background-color:#fff;
}
/* 侧边栏 */ .sidebar-nav {
  flex-shrink:0;
  width:250px;
  padding:30px 20px;
  background-color:#f7f9fc;
  border-right:1px solid #eee;
  /* 新增：添加过渡效果，使展开和收起更平滑 */ transition:width 0.3s ease-in-out,padding 0.3s ease-in-out;
}
/* 新增：侧边栏收起时的样式 */ .sidebar-collapsed {
  width:70px;
  /* 调整为只容纳图标的宽度 */ padding:30px 10px;
}
.nav-link {
  display:flex;
  align-items:center;
  /* 新增：对齐方式，侧边栏收起时图标居中 */ justify-content:flex-start;
  padding:12px 15px;
  margin-bottom:8px;
  text-decoration:none;
  color:#333;
  border-radius:6px;
  transition:background-color 0.2s,color 0.2s,transform 0.2s;
}
/* 新增：侧边栏收起时链接图标居中 */ .sidebar-collapsed .nav-link {
  justify-content:center;
  padding:12px 0;
}
.nav-link:hover {
  background-color:#e6f7ff;
  color:#0077cc;
}
/* ... 保持原有样式不变 ... */ .nav-icon {
  margin-right:15px;
  display:flex;
  align-items:center;
  justify-content:center;
  /* 新增：添加过渡效果 */ transition:margin-right 0.3s ease-in-out;
}
/* 新增：侧边栏收起时移除图标右边距 */ .sidebar-collapsed .nav-icon {
  margin-right:0;
}
.nav-icon svg {
  width:20px;
  height:20px;
}
.nav-link.active .nav-icon svg {
  fill:#0077cc;
}
/* 新增：隐藏文字，并添加过渡效果 */ .nav-text {
  opacity:1;
  transition:opacity 0.2s ease-in-out;
}
.sidebar-collapsed .nav-text {
  opacity:0;
}
/* 主内容区域 */ .main-content {
  /* 保持原有样式 */ flex-grow:1;
  display:flex;
  flex-direction:column;
  padding:0 40px;
  /* 核心修改：添加右边距，数值需与工具栏宽度一致 */ margin-right:250px;
}
.content-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.header-left,.header-right {
  display:flex;
  align-items:center;
}
.header-left {
  gap:20px;
}
.header-title {
  display:flex;
  align-items:center;
}
.header-title h2 {
  font-size:1.5rem;
  margin:0;
  margin-left:10px;
}
.create-button {
  background-color:#0077cc;
  color:#fff;
  border:none;
  padding:10px 15px;
  border-radius:5px;
  cursor:pointer;
  font-size:1rem;
  display:flex;
  align-items:center;
  gap:5px;
  transition:background-color 0.3s ease;
}
.create-button:hover {
  background-color:#005aa7;
}
.sort-dropdown {
  position:relative;
}
.sort-button {
  background:none;
  border:1px solid #ccc;
  border-radius:5px;
  padding:8px 12px;
  cursor:pointer;
  font-size:1rem;
  color:#555;
  display:flex;
  align-items:center;
  gap:5px;
  transition:all 0.2s ease;
}
.sort-button:hover {
  border-color:#0077cc;
  color:#0077cc;
}
.sort-icon {
  margin-left:5px;
}
.work-list {
  display:flex;
  flex-direction:column;
}
.work-item-wrapper {
  position:relative;
  margin-bottom:15px;
  background-color:#fff;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,0.05);
  transition:transform 0.2s,box-shadow 0.2s;
}
.work-item-wrapper:hover {
  transform:translateY(-2px);
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
.work-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px;
  border:1px solid transparent;
  border-radius:8px;
  text-decoration:none;
  color:inherit;
}
.work-info {
  display:flex;
  flex-direction:column;
  flex-grow:1;
}
.work-date {
  font-size:0.85rem;
  color:#999;
}
.work-details {
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:5px;
}
.work-title {
  font-size:1rem;
  color:#333;
  font-weight:bold;
}
.work-status {
  font-size:0.8rem;
  color:#555;
  background-color:#f0f0f0;
  padding:2px 6px;
  border-radius:4px;
}
.item-divider {
  border:none;
  border-bottom:1px solid #eee;
  margin:10px 0;
}
.menu-button {
  background:none;
  border:none;
  cursor:pointer;
  font-size:1.2rem;
  color:#999;
}
.menu-button:hover {
  color:#333;
}
/* 作品菜单样式 */ .menu-container {
  position:absolute;
  top:50px;
  right:10px;
  width:150px;
  background-color:#fff;
  border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  z-index:10;
  overflow:hidden;
}
.menu-item {
  display:flex;
  align-items:center;
  padding:10px 15px;
  font-size:0.9rem;
  color:#333;
  cursor:pointer;
  transition:background-color 0.2s ease;
}
.menu-item:hover {
  background-color:#e6f7ff;
}
.menu-item svg {
  width:16px;
  height:16px;
  margin-right:10px;
  fill:#888;
}
.menu-item:hover svg {
  fill:#0077cc;
}
/* 对话框（Modal）样式 */ .modal {
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  overflow:auto;
  background-color:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
}
.modal-content {
  background-color:#fff;
  padding:30px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
  width:400px;
  max-width:90%;
  text-align:center;
}
.menu-modal-content {
  text-align:center;
  padding:20px;
}
.menu-modal-content h3 {
  margin-top:0;
  color:#333;
}
.modal-content input {
  width:100%;
  padding:10px;
  margin-top:15px;
  margin-bottom:20px;
  border:1px solid #ddd;
  border-radius:5px;
  box-sizing:border-box;
}
.modal-buttons {
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:20px;
}
.modal-buttons button {
  padding:8px 15px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:1rem;
}
#cancel-btn,#delete-cancel-btn {
  background-color:#f0f0f0;
  color:#555;
}
#confirm-btn,#delete-confirm-btn {
  background-color:#0077cc;
  color:#fff;
}
#delete-confirm-btn {
  background-color:#dc3545;
}
/* 编辑器页面样式 */ .editor-toolbar {
  background-color:#fff;
  padding:10px 30px;
  border-bottom:1px solid #ddd;
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
  display:flex;
  gap:15px;
  align-items:center;
  flex-wrap:wrap;
}
.editor-title {
  flex-grow:1;
  font-size:1.2rem;
  color:#333;
  font-weight:bold;
  margin-right:20px;
}
.back-button {
  padding:8px 12px;
  border:1px solid #adb5bd;
  border-radius:5px;
  background-color:#f8f9fa;
  cursor:pointer;
  color:#495057;
  /* 默认文字颜色 */ transition:background-color 0.2s,color 0.2s;
}
.back-button:hover {
  background-color:#0d6efd;
  /* 悬停时背景色 */ color:#fff;
  /* 悬停时文字颜色 */
}
#toolbar-quill {
  display:flex;
  gap:5px;
  flex-wrap:wrap;
  /* 允许工具栏按钮换行 */
}
.editor-main {
  flex-grow:1;
  /* 🎨 关键修改：减少外边距，以缩小工具栏和编辑器之间的灰色距离 */ padding:30px;
  display:flex;
  flex-direction:column;
  background-color:#f0f2f5;
  /* ❌ 移除 margin:20px;
  或将其改为更小的值 */ margin:10px 0;
}
#editor {
  max-width:900px;
  /* 與閱讀頁面一致的最大寬度 */ width:100%;
  /* 響應式寬度 */ padding:16px;
  font-size:16px;
  line-height:1.6;
  white-space:pre-wrap;
  /* 保留換行並自動換行 */ word-wrap:break-word;
  /* 單字過長時自動斷行 */ overflow-wrap:break-word;
  /* 防止文字溢出 */ box-sizing:border-box;
  border:1px solid #ccc;
  border-radius:8px;
  background-color:#fff;
  font-size:1.215rem;
}
.ql-container {
  flex-grow:1;
  display:flex;
  flex-direction:column;
}
.ql-editor {
  flex-grow:1;
  min-height:400px;
}
#plainEditor {
  background-color:#fff;
  border-radius:8px;
  height:100%;
  flex-grow:1;
  border:1px solid #ccc;
  box-sizing:border-box;
  min-height:500px;
}
/* 新增角色下拉菜单和弹窗样式 */ .dropdown-container {
  position:relative;
  border:1px solid #ccc;
  border-radius:5px;
  margin-bottom:10px;
}
.dropdown-header {
  width:100%;
  background-color:#fff;
  padding:10px 15px;
  font-size:0.9rem;
  text-align:left;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:5px;
}
.dropdown-header:hover {
  background-color:#e6f7ff;
}
.dropdown-header .arrow {
  transition:transform 0.3s;
}
.dropdown-header.open .arrow {
  transform:rotate(90deg);
}
.dropdown-content {
  display:none;
  padding:10px;
  border-top:1px solid #ddd;
  background-color:#f7f9fc;
}
.dropdown-content.open {
  display:block;
}
.role-list {
  list-style:none;
  padding:0;
  margin:0;
}
.role-item {
  font-size:0.9rem;
  border-bottom:1px dashed #ddd;
  padding:8px 0;
  cursor:pointer;
}
.role-item:last-child {
  border-bottom:none;
}
.role-title-wrapper {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.role-title {
  font-weight:bold;
}
.role-title .color-dot {
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:50%;
  margin-right:8px;
  border:1px solid #ccc;
}
.role-item .edit-btn {
  font-size:0.8rem;
  color:#0077cc;
  cursor:pointer;
  margin-left:10px;
}
.role-item-notes {
  font-size:0.8rem;
  color:#555;
  padding-left:18px;
  margin-top:5px;
  display:none;
}
.role-item-notes.open {
  display:block;
}
.add-role-btn {
  width:100%;
  background-color:#e9f5ff;
  color:#0077cc;
  border:1px dashed #0077cc;
  border-radius:5px;
  padding:8px;
  font-size:0.9rem;
  text-align:center;
  cursor:pointer;
  margin-top:10px;
}
.modal-content {
  background-color:#fefefe;
  margin:10% auto;
  padding:25px;
  border:1px solid #888;
  width:400px;
  border-radius:10px;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
}
.modal-content h3 {
  margin-top:0;
  border-bottom:2px solid #ddd;
  padding-bottom:10px;
  margin-bottom:20px;
}
.modal-content label {
  display:block;
  margin-bottom:5px;
  font-weight:bold;
}
.modal-content input,.modal-content textarea {
  width:95%;
  padding:8px;
  margin-bottom:15px;
  border:1px solid #ccc;
  border-radius:4px;
}
.modal-content .color-picker-wrapper {
  display:flex;
  align-items:center;
  margin-bottom:15px;
}
.modal-content .color-picker {
  width:40px;
  height:40px;
  margin-left:10px;
  border:none;
  cursor:pointer;
}
.modal-buttons {
  text-align:right;
}
.modal-buttons button {
  padding:8px 15px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin-left:10px;
}
.modal-buttons .confirm {
  background-color:#0077cc;
  color:white;
}
.modal-buttons .cancel {
  background-color:#ddd;
}
/* 批量刪除弹窗的特殊样式 */ #bulk-delete-modal .modal-content {
  width:500px;
  text-align:left;
}
#bulk-delete-modal .delete-list {
  max-height:300px;
  overflow-y:auto;
  border:1px solid #eee;
  border-radius:6px;
  margin-top:15px;
  padding:10px;
}
#bulk-delete-modal .delete-item {
  display:flex;
  align-items:center;
  padding:8px 10px;
  border-bottom:1px solid #f0f0f0;
}
#bulk-delete-modal .delete-item:last-child {
  border-bottom:none;
}
#bulk-delete-modal .delete-item span {
  flex-grow:1;
  margin-left:10px;
}
#bulk-delete-modal .delete-item input {
  width:auto;
  margin:0;
}
#bulk-delete-modal .delete-buttons {
  display:flex;
  justify-content:flex-end;
  margin-top:20px;
}
.editor-container {
  display:flex;
  flex-direction:row;
}
.right-sidebar {
  flex-shrink: 0;
  width: 250px;
  background-color: #f7f9fc;
  border-left: 1px solid #eee;
  padding: 20px;
  transition: width 0.3s ease-in-out;
  position: sticky;
  top: 70px; /* ✅ 向下错开，避免遮挡消息箱或页眉 */
  right: 0;
  height: calc(100vh - 70px); /* ✅ 同步调整高度 */
  overflow-y: auto;
  z-index: 50; /* ✅ 保证在编辑器上层但不盖住页眉 */
}

/* 新增角色選擇按钮样式 */ .role-select-btn {
  width:20px;
  height:20px;
  border-radius:50%;
  border:2px solid #ccc;
  cursor:pointer;
  display:flex;
  justify-content:center;
  align-items:center;
  transition:all 0.2s ease;
  margin-right:10px;
}
.role-select-btn.active {
  background-color:#0077cc;
  border-color:#0077cc;
}
.role-select-btn.active::after {
  content:'';
  width:8px;
  height:8px;
  border-radius:50%;
  background-color:#fff;
}
.role-item.selected .role-title-wrapper {
  background-color:#e6f7ff;
  border-radius:4px;
  padding:5px 10px;
}
/* 新增：页码控制器样式 */ .page-controls {
  position:relative;
  display:flex;
  align-items:center;
  margin-right:15px;
  /* 与Quill工具栏的间距 */
}
.page-current {
  cursor:pointer;
  font-size:14px;
  padding:8px 12px;
  border-radius:4px;
  background-color:#f0f0f0;
  transition:background-color 0.2s;
}
.page-current:hover {
  background-color:#e0e0e0;
}
/* 新增：页码下拉列表样式 */ .page-select-dropdown {
  position:absolute;
  top:100%;
  left:0;
  margin-top:5px;
  width:150px;
  background-color:#fff;
  border:1px solid #ddd;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
  border-radius:8px;
  z-index:9000;
}
.page-select-dropdown ul {
  list-style:none;
  padding:0;
  margin:0;
  max-height:200px;
  overflow-y:auto;
}
.page-select-dropdown li {
  padding:10px 15px;
  font-size:14px;
  cursor:pointer;
}
.page-select-dropdown li:hover {
  background-color:#f5f5f5;
}
.page-select-dropdown .active {
  background-color:#e0e2e6;
  font-weight:bold;
}
.add-page-btn {
  width:100%;
  padding:10px;
  background-color:#f7f9fc;
  border:none;
  cursor:pointer;
  text-align:center;
  border-top:1px solid #ddd;
  border-radius:0 0 8px 8px;
  color:#000;
}
.add-page-btn:hover {
  background-color:#e0e2e6;
}
/* 新增：编辑器分页和工具栏容器 */ .editor-controls {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
/* 新增：分页按钮容器 */ .pagination {
  display:flex;
  align-items:center;
  gap:10px;
}
/* 新增：分页按钮 */ .page-btn {
  padding:5px 10px;
  border:1px solid #ccc;
  background-color:#f7f9fc;
  border-radius:5px;
  cursor:pointer;
}
.page-btn:hover {
  background-color:#e6f7ff;
}
.page-number {
  font-weight:bold;
  color:#0077cc;
}
/* 新增：编辑器两级工具栏的整体容器，实现固定在顶部的效果 */ .editor-toolbar-container {
  position:sticky;
  top:0;
  z-index:999;
  background-color:#f0f2f5;
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
}
/* 新增：弹窗模式下隐藏工具栏 */ .modal-active .editor-toolbar-container {
  display:none;
}
.role-gallery-btn:hover {
  text-decoration:underline;
}
/* 新增：图库弹窗的样式 */ #galleryModal .modal-content {
  width:600px;
  text-align:left;
}
/* 图库图片容器 */ .gallery-image-list {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:10px;
  border:1px dashed #ccc;
  border-radius:8px;
  min-height:100px;
}
/* 单个图片项 */ .gallery-image-item {
  position:relative;
  width:100px;
  height:100px;
  border-radius:8px;
  overflow:hidden;
  cursor:pointer;
}
.gallery-image-item img {
  width:100%;
  height:100%;
  object-fit:cover;
}
/* 删除按钮 */ .gallery-image-item .delete-btn {
  position:absolute;
  top:5px;
  right:5px;
  background-color:rgba(220,53,69,0.8);
  color:white;
  border-radius:50%;
  width:20px;
  height:20px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  cursor:pointer;
  opacity:0;
  transition:opacity 0.2s;
}
.gallery-image-item:hover .delete-btn {
  opacity:1;
}
/* 添加图片按钮 */ .add-image-btn {
  width:100px;
  height:100px;
  background-color:#f7f9fc;
  border:1px dashed #ddd;
  border-radius:8px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:2rem;
  color:#ccc;
  cursor:pointer;
  transition:background-color 0.2s,color 0.2s;
}
.add-image-btn:hover {
  background-color:#e6f7ff;
  color:#0077cc;
}
/* ------------------------------------------- */ /* 新增：媒体查询 - 针对手机端布局优化（最大宽度 768px） */ /* ------------------------------------------- */ @media (max-width:768px) {
  /* 整体容器：改为上下堆叠布局 */ .page-container,.editor-container {
  flex-direction:column;
}
/* 侧边栏：变为全宽，并调整顺序 */ .sidebar-nav,.right-sidebar {
  width:100%;
  padding:20px 15px;
  border-right:none;
  border-left:none;
  border-bottom:1px solid #eee;
  /* 在底部添加分隔线 */ position:relative;
  /* 取消固定定位，让其随页面滚动 */ order:3;
  /* 将左侧导航栏放到最后 */
}
/* 主内容区域：变为全宽，并调整外边距 */ /* .main-content 包含了 .editor-main 和其他内容，我们假设编辑器页面使用的是这个结构 */ .main-content {
  width:100%;
  padding:0;
  /* 移除左右内边距，让子元素控制自己的边距 */ margin-right:0;
  /* 移除右侧外边距 */ order:2;
  /* 将主内容区域（包含编辑器主体）放在中间，但我们需要调整子元素的排列 */ /* 新增：在手机端，将 main-content 内部的元素也垂直排列，以支持工具栏和编辑器主体的顺序控制 */ display:flex;
  flex-direction:column;
}

/* 编辑器主区域：调整顺序和内边距 */ /* .editor-main 包含 Quill 编辑器本体，它应该紧跟在 fixed 的工具栏下方 */ .editor-main {
  flex-grow:1;
  padding:15px;
  /* 恢复正常的内边距 */ margin:0;
  /* 移除原有外边距 */ order:2;
  /* 紧随工具栏之后 */ /* 新增：为 fixed 的工具栏留出空间，防止内容被遮挡 */ padding-top:70px;
  /* 假设工具栏高度约为 50px，这里留出 70px 确保安全边距 */
}
/* 编辑器本身：调整最大宽度 */ #editor {
  max-width:100%;
  margin:0;
  padding:10px;
}
/* 顶部标题和按钮：变为上下堆叠 */ .content-header {
  flex-direction:column;
  align-items:flex-start;
  gap:10px;
  margin-bottom:15px;
}
/* 标题区域：调整样式 */ .header-title h2 {
  font-size:1.2rem;
}
/* 工具栏按钮：调整间距和样式 */ #toolbar-quill {
  gap:8px;
  justify-content:flex-start;
  /* 手机端左对齐更常见 */
}
/* 弹窗内容：适应小屏幕 */ .modal-content {
  width:95%;
  margin:10% auto;
}
}/* ------------------------------------------- */ /* 修正：隐藏文字 (Spoiler) Blot的CSS */ /* ------------------------------------------- */ /* 新增：确保 modal-active 类能够隐藏 Quill 工具栏（如果它被全局样式控制的话） */ .modal-active #toolbar-quill {
  /* 假设您的 Quill 工具栏也是一个独立的元素 */ z-index:1;
  /* 确保它在 modal 下面 */
}
/* Base style for both modes */ .ql-editor .spoiler-hidden {
  /* 默认隐藏样式：使用白色背景 (#fff) 遮盖黑色文字，达到隐藏效果 */ background-color:#000;
  /* 假设编辑器的底色是白色 */ color:#000;
  /* 文字颜色也设为白色，被背景色覆盖 */ padding:0 4px;
  border-radius:2px;
  transition:color 0.3s,background-color 0.3s;
}
/* 模式 1:剧透模式 (鼠标悬停即显示) */ .ql-editor .spoiler-hidden[data-mode="spoiler"] {
  cursor:pointer;
}
.ql-editor .spoiler-hidden[data-mode="spoiler"]:hover {
  /* 悬停时：将文字颜色改为黑色，背景色改为透明（或白色），显示正常文本 */ color:#000;
  /* 文字颜色改为黑色 */ background-color:transparent;
  /* 背景色改为透明或白色 */
}
/* 模式 2:暗骰模式 (在编辑器内始终隐藏，不响应悬停) */ .ql-editor .spoiler-hidden[data-mode="secret"] {
  /* 暗骰模式仍使用强烈的颜色区分和提示，并保持隐藏 */ background-color:#6a0000;
  color:#6a0000;
  cursor:default;
  border:1px solid #999;
}
/* 覆盖编辑器内悬停行为：暗骰在编辑器里保持隐藏 */ .ql-editor .spoiler-hidden[data-mode="secret"]:hover {
  color:#6a0000;
  background-color:#6a0000;
}
/* 新增：页码下拉菜单底部按钮的通用样式 */ .dropdown-footer-btn {
  width:100%;
  padding:10px;
  border:none;
  cursor:pointer;
  text-align:center;
  border-top:1px solid #ddd;
  transition:background-color 0.2s;
  font-size:14px;
}
/* 新增：删除当前页按钮样式 (使用红色表示危险操作) */ .delete-page-btn {
  background-color:#fff8f8;
  /* 浅红色背景 */ color:#dc3545;
  /* 红色文字 */ border-radius:0;
  /* 确保顶部没有圆角 */
}
.delete-page-btn:hover {
  background-color:#ffeaea;
  /* 悬停时颜色加深 */
}
/* 调整新增页面的按钮样式，移除其顶部边框，确保删除按钮紧贴其上 */ .page-select-dropdown .add-page-btn {
  /* 移除之前的 border-top:1px solid #ddd;
  避免双重边框 */ border-top:none;
  border-radius:0 0 8px 8px;
  /* 确保新增页面按钮仍然在底部圆角 */
}
/* ------------------------------------------- */ /* ✅ 工具栏和编辑器主体距离、按钮偏移和分组优化 */ /* ------------------------------------------- */ /* 1. 减少编辑器和工具栏之间的灰色距离 */ .editor-main {
  flex-grow:1;
  padding:30px;
  display:flex;
  flex-direction:column;
  background-color:#f0f2f5;
  /* 关键修改：将 20px 减小到 5px，并移除左右边距（如果父容器已处理） */ margin:5px 0;
}
/* 2. 清理和优化 #toolbar-quill 容器 */ #toolbar-quill {
  display:flex;
  justify-content:flex-start;
  /* 保持左对齐 */ gap:8px;
  /* 按钮组之间的间距，从 5px 增加到 8px */ flex-wrap:wrap;
}
/* 3. 实现工具栏按钮整体向右偏移（不移动工具栏背景和边框） */ /* 对第一个按钮组设置 margin-left */ #toolbar-quill .ql-formats:first-child {
  /* 增加左外边距，使所有按钮整体向右移动 */ margin-left:30px;
  /* 保持按钮组之间的间距 */ margin-right:8px;
}
/* 4. 清理和统一 ql-formats 样式 */ .ql-toolbar.ql-snow .ql-formats {
  display:flex;
  align-items:center;
  /* 移除冗余的 margin-right:35px，使用 #toolbar-quill 的 gap:8px 即可 */ margin-right:0;
}
/* 确保撤回/取消撤回按钮之间有小的间距 */ #toolbar-quill .ql-formats:first-child button {
  margin-right:3px;
}
/* 5. 清理和优化 #hiddenTextBtn 的样式 */ #toolbar-quill .ql-formats:nth-child(2) {
  /* 保持 “隐藏文本” 按钮在自己的组内垂直居中 */ display:flex;
  align-items:center;
}
#hiddenTextBtn {
  /* 统一使用一个 #hiddenTextBtn 样式块，并删除重复的定义 */ display:inline-flex;
  align-items:center;
  justify-content:center;
  white-space:nowrap;
  padding:6px 12px;
  /* 统一内边距 */ min-width:fit-content;
  font-size:14px;
  border:1px solid #ccc;
  border-radius:4px;
  background-color:#fff;
  color:#000;
  line-height:1.2;
  box-sizing:border-box;
  margin:0;
  /* 确保自身没有外部边距 */
}
#hiddenTextBtn:hover {
  background-color:#e6f7ff;
  border-color:#0077cc;
  color:#0077cc;
}
/* ---------- 📱 手机端优化 ---------- */ @media (max-width:768px) {
  .page-container {
  flex-direction:column;
}
.main-content {
  margin-right:0;
  padding:10px;
}
.right-sidebar {
  position:static;
  width:100%;
  height:auto;
  border-left:none;
  padding:10px;
  overflow-y:visible;
}
.editor-container {
  flex-direction:column;
}
.editor-main {
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
}/* ============ 新版右侧浮窗（取代原固定右栏） ============ */ /* 浮动按钮 */ /* 默认（PC）隐藏按钮，只在手机端显示 */
.floating-sidebar-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 80px;
  height: 80px;
  border-radius: 10px;          /* 小圆角方块 */
  background-color: #0077cc;
  color: #fff;
  border: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  cursor: pointer;
  display: none;                /* PC 端隐藏，在手机端用 @media 打开 */
  justify-content: center;
  align-items: center;
  flex-direction: column;       /* 图标在上、文字在下 */
  gap: 4px;
  z-index: 9999;
  transition: transform 0.2s ease, background-color 0.2s ease;
}

.floating-sidebar-btn:hover {
  background-color: #005fa3;
  transform: translateY(-2px);
}

.floating-sidebar-icon {
  width: 26px;
  height: 26px;
}

.floating-sidebar-label {
  font-size: 12px;
  line-height: 1.2;
}

.floating-sidebar-btn:hover {
  background-color:#005fa3;
  transform:scale(1.05);
}
/* 浮窗内容 */ .floating-sidebar {
  position:fixed;
  bottom:80px;
  right:20px;
  width:90vw;
  max-width:320px;
  height:70vh;
  background-color:#f7f9fc;
  border-radius:12px;
  box-shadow:0 6px 15px rgba(0,0,0,0.15);
  padding:16px;
  overflow-y:auto;
  z-index:9998;
  transform:translateY(20px);
  opacity:0;
  pointer-events:none;
  transition:all 0.3s ease;
}
/* 打开时 */ .floating-sidebar.open {
  transform:translateY(0);
  opacity:1;
  pointer-events:all;
}
/* 右上角关闭按钮 */ .floating-sidebar .close-btn {
  position:absolute;
  top:10px;
  right:10px;
  border:none;
  background:none;
  font-size:20px;
  color:#666;
  cursor:pointer;
}
.floating-sidebar .close-btn:hover {
  color:#000;
}
/* 手机端优化：按钮稍大一点 */ @media (max-width:768px) {
  .floating-sidebar-btn {
  width:56px;
  height:56px;
  bottom:15px;
  right:15px;
  font-size:20px;
}
}

  /* ------------------------------------------- */
/* 手机端模式：移除右侧工具栏，改为浮窗按钮模式 */
/* ------------------------------------------- */
@media (max-width: 768px) {

  /* 隐藏原右侧固定工具栏 */
  .right-sidebar {
    display: none !important;
  }

  /* 添加右下角浮窗按钮 */
  .floating-tool-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background-color: #0077cc;
    color: white;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    cursor: pointer;
    z-index: 1001;
    transition: background-color 0.3s ease;
  }

  .floating-tool-btn:hover {
    background-color: #005fa3;
  }

  /* 浮窗弹出面板样式 */
  .floating-tool-panel {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 85%;
    max-width: 360px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
    flex-direction: column;
    padding: 20px;
    animation: slideUp 0.3s ease-out;
  }

  /* 打开时显示 */
  .floating-tool-panel.active {
    display: flex;
  }

  /* 动画效果 */
  @keyframes slideUp {
    from { transform: translateY(40px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
}

/* ✅ 1️⃣ 只固定工具栏（而不是整个编辑区） */
.editor-toolbar-container {
  position: sticky;  /* 工具栏固定在顶部 */
  top: 0;
  z-index: 999;
  background-color: #f0f2f5;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* ✅ 2️⃣ 编辑器主体不要受 sticky 影响，让它正常滚动 */
.editor-main {
  flex-grow: 1;
  overflow-y: auto;  /* 允许滚动 */
  padding: 30px;
  margin: 0;         /* 去掉多余外边距，避免与 toolbar 叠层 */
}

/* ✅ 3️⃣ Quill 输入区本身非固定 */
#editor, .ql-container, .ql-editor {
  position: static !important;  /* 防止跟随 sticky 的容器吸附 */
}

  /* ============ 新版右侧浮窗（取代原固定右栏） ============ */

/* 默认（PC）隐藏按钮，只在手机端显示 */
.floating-sidebar-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 80px;
  height: 80px;
  border-radius: 10px;          /* 小圆角方块 */
  background-color: #0077cc;
  color: #fff;
  border: none;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  cursor: pointer;
  display: none;                /* PC 端隐藏，在手机端用 @media 打开 */
  justify-content: center;
  align-items: center;
  flex-direction: column;       /* 图标在上、文字在下 */
  gap: 4px;
  z-index: 9999;
  transition: transform 0.2s ease, background-color 0.2s ease;
}

.floating-sidebar-btn:hover {
  background-color: #005fa3;
  transform: translateY(-2px);
}

.floating-sidebar-icon {
  width: 26px;
  height: 26px;
}

.floating-sidebar-label {
  font-size: 12px;
  line-height: 1.2;
}


@media (max-width: 768px) {
  .floating-sidebar-btn {
    display: flex;          /* 手机上显示 */
    right: 16px;
    bottom: 16px;
    top: auto;              /* 避免以前写的 top:50% 之类继续生效 */
    transform: none;        /* 清理旧的 translateY(-50%) */
  }

  /* 浮窗本体也可以保持你现在的设置，略微调整尺寸即可 */
  .floating-sidebar {
    position: fixed;
    right: 16px;
    bottom: 104px;          /* 按钮上方留一点空间 */
    width: 80vw;
    max-width: 320px;
    height: 60vh;
    border-radius: 12px;
    background-color: #fff;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    padding: 16px;
    opacity: 0;
    pointer-events: none;
    transform: translateY(10px);
    transition: all 0.3s ease;
    z-index: 1000;
  }

  .floating-sidebar.open {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0);
  }
}



  #autoSaveToggleBtn {
    margin-left: 10px;
    padding: 8px 12px;
    font-size: 0.9rem;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid #0077cc;
    transition: background-color 0.2s, color 0.2s;
}

/* 开启状态（默认） */
.autosave-on {
    background-color: #e6f7ff;
    color: #0077cc;
}

/* 关闭状态 */
.autosave-off {
    background-color: #f8f9fa;
    color: #555;
    border-color: #999;
}

/* 整个图库浮窗遮罩层 */
#galleryModal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: none;              /* 默认隐藏，JS 用 display:flex 打开 */
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

/* 浮窗本体：加宽加高 */
#galleryModal .gallery-modal-content {
  width: min(1100px, 96vw);   /* 比原来宽很多 */
  max-height: 90vh;           /* 接近全屏高度 */
  background: #fff;
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);

  display: flex;
  flex-direction: column;
  gap: 12px;
}

/* 图片列表区域可滚动 */
#galleryImageList {
  flex: 1;
  overflow-y: auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
  padding-right: 4px;
}

  /* 单个图片格子 */
.gallery-image-item {
  position: relative;
  background: #f8f8f8;
  border-radius: 8px;
  padding: 6px 6px 4px;
  box-sizing: border-box;
}

/* 缩略图容器，保持大致比例但不裁掉头 */
.gallery-image-item .thumb-wrapper {
  width: 100%;
  /* 给个大致比例，比如立绘常见 3:4，你也可以改成 2:3 等 */
  aspect-ratio: 3 / 4;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* 关键：用 contain 而不是 cover，保证整张图都进来 */
.gallery-image-item img {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  display: block;
}

/* 文件名 / 表情名 */
.gallery-image-item .img-name {
  margin-top: 4px;
  font-size: 12px;
  line-height: 1.2;
  text-align: center;
  color: #555;
  word-break: break-all;
}

/* 删除按钮保持右上角小叉 */
.gallery-image-item .delete-btn {
  position: absolute;
  top: 4px;
  right: 4px;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-size: 12px;
  line-height: 18px;
  text-align: center;
  cursor: pointer;
}
/* 左上角“展开”按钮 */
.gallery-image-item .expand-btn {
  position: absolute;
  top: 4px;
  left: 4px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-size: 12px;
  line-height: 20px;
  text-align: center;
  cursor: pointer;
  z-index: 2;
}
/* 大图预览遮罩层 */
.gallery-preview-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 11000; /* 比图库弹窗略高 */
}

.gallery-preview-overlay.open {
  display: flex;
}

.gallery-preview-content {
  max-width: 90vw;
  max-height: 90vh;
  position: relative;
}

.gallery-preview-content img {
  max-width: 100%;
  max-height: 100%;
  border-radius: 10px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.4);
}

.gallery-preview-close {
  position: absolute;
  top: -12px;
  right: -12px;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: none;
  background: #fff;
  cursor: pointer;
  font-size: 18px;
  line-height: 28px;
}

  @media (max-width: 768px) {
  /* 工具栏整体上下排布，避免一行挤爆 */
  .editor-toolbar {
    flex-wrap: wrap;
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .editor-title {
    width: 100%;
    margin-right: 0;
  }

  .page-controls {
    margin-right: 0;
    margin-top: 4px;
  }

  /* 保存 / 发布按钮组：两列排布，便于点击 */
  .editor-toolbar-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
  }

  .editor-toolbar-actions button {
    flex: 1 0 calc(50% - 6px); /* 每行大概两个按钮 */
    font-size: 0.9rem;
    padding: 6px 4px;
  }

  /* 编辑正文在手机端上下留白稍微收紧一点 */
  .editor-main {
    padding: 16px 10px 20px;
    margin: 0;
  }
}

/* =========================
   AnchorX 创作端：图片缩放面板 UI（可读性增强）
   依赖：panel.id = 'ax-imgsize-panel'
   ========================= */

/* 主题变量：你可以只改这里就整体换风格 */
:root{
  --axPanelBg: rgba(22, 22, 22, 0.92);
  --axPanelFg: #ffffff;
  --axPanelBorder: rgba(255,255,255,0.14);
  --axShadow: 0 10px 26px rgba(0,0,0,0.28);

  --axBtnBg: rgba(255,255,255,0.12);
  --axBtnBd: rgba(255,255,255,0.18);
  --axBtnFg: #ffffff;

  --axBtnHoverBg: rgba(255,255,255,0.18);
  --axBtnActiveBg: rgba(255,255,255,0.26);

  --axPrimary: #4aa3ff;
  --axDanger: #ff5d5d;
}

/* 面板整体（覆盖你 JS 里 inline 的白底） */
#ax-imgsize-panel{
  background: var(--axPanelBg) !important;
  color: var(--axPanelFg) !important;
  border: 1px solid var(--axPanelBorder) !important;
  box-shadow: var(--axShadow) !important;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);

  /* 让面板更稳一点 */
  max-width: min(520px, calc(100vw - 18px));
}

/* 面板里文字 */
#ax-imgsize-panel span{
  color: var(--axPanelFg) !important;
}

/* 面板按钮统一风格 */
#ax-imgsize-panel button{
  appearance: none;
  -webkit-appearance: none;
  border: 1px solid var(--axBtnBd) !important;
  background: var(--axBtnBg) !important;
  color: var(--axBtnFg) !important;
  border-radius: 999px;
  padding: 6px 12px;
  font-size: 12px;
  line-height: 1;
  cursor: pointer;
  transition: transform .06s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
}

#ax-imgsize-panel button:hover{
  background: var(--axBtnHoverBg) !important;
  border-color: rgba(255,255,255,0.28) !important;
}

#ax-imgsize-panel button:active{
  transform: scale(0.98);
  background: var(--axBtnActiveBg) !important;
}

#ax-imgsize-panel button:focus-visible{
  outline: 2px solid color-mix(in oklab, var(--axPrimary) 70%, white);
  outline-offset: 2px;
}

/* 预设按钮（25/50/70/85/100）可以更像“胶囊标签” */
#ax-imgsize-panel button[data-preset]{
  padding: 6px 12px;
}

/* “重置”按钮稍微明显一点 */
#ax-imgsize-panel #imgSizeReset{
  border-radius: 10px !important;
  border-color: rgba(255,255,255,0.35) !important;
}

/* 关闭按钮：不要白到看不见 */
#ax-imgsize-panel #imgSizeClose{
  width: 30px;
  height: 30px;
  padding: 0;
  border-radius: 999px !important;
  border-color: rgba(255,255,255,0.24) !important;
  background: rgba(255,255,255,0.10) !important;
  font-size: 16px;
  line-height: 30px;
  text-align: center;
}

#ax-imgsize-panel #imgSizeClose:hover{
  background: rgba(255, 93, 93, 0.22) !important;
  border-color: rgba(255, 93, 93, 0.40) !important;
}

/* 滑条：让它在暗底上可见 */
#ax-imgsize-panel input[type="range"]{
  accent-color: var(--axPrimary);
}

/* Chrome / Edge */
#ax-imgsize-panel input[type="range"]::-webkit-slider-runnable-track{
  height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,0.18);
}
#ax-imgsize-panel input[type="range"]::-webkit-slider-thumb{
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  margin-top: -5px;
  border-radius: 999px;
  background: var(--axPrimary);
  border: 2px solid rgba(255,255,255,0.55);
}

/* Firefox */
#ax-imgsize-panel input[type="range"]::-moz-range-track{
  height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,0.18);
}
#ax-imgsize-panel input[type="range"]::-moz-range-thumb{
  width: 16px;
  height: 16px;
  border-radius: 999px;
  background: var(--axPrimary);
  border: 2px solid rgba(255,255,255,0.55);
}

/* 编辑器里图片：提示可点、避免太突兀 */
#editor .ql-editor img{
  cursor: pointer;
  max-width: 100%;
  height: auto;
  border-radius: 10px;
  transition: box-shadow .15s ease, transform .08s ease;
}

#editor .ql-editor img:hover{
  box-shadow: 0 8px 20px rgba(0,0,0,0.16);
}

/* （可选）有 data-width 的图片给一个更明显的“已可缩放”观感 */
#editor .ql-editor img[data-width]{
  outline: 1px dashed rgba(74,163,255,0.55);
  outline-offset: 4px;
}

/* =========================
   ✅ 精准：仅作用于作品标签弹窗（#tag-modal-backdrop）
   目标：按钮/输入框/标签chip上色 + hover/active
   ========================= */

:root{
  --tagBlue: #0d6efd;
  --tagBlueHover: #0b5ed7;
  --tagGreen: #16a34a;
  --tagGreenHover: #12813c;
  --tagRed: #dc3545;
  --tagBorder: rgba(0,0,0,0.14);
  --tagShadow: 0 8px 22px rgba(0,0,0,0.14);
}

/* 弹窗主体统一质感（覆盖 inline 白底/阴影） */
#tag-modal-backdrop > div{
  border-radius: 14px !important;
  box-shadow: var(--tagShadow) !important;
}

/* “✕” 关闭按钮 */
#tag-modal-x{
  background: #f1f3f5 !important;
  color: #444 !important;
  border: 1px solid var(--tagBorder) !important;
  border-radius: 10px !important;
}
#tag-modal-x:hover{
  background: #ffecec !important;
  border-color: rgba(220,53,69,0.35) !important;
  color: var(--tagRed) !important;
}

/* 输入框：更清晰 */
#tag-input{
  border: 1px solid rgba(0,0,0,0.16) !important;
  background: #fff !important;
  color: #222 !important;
  box-shadow: none !important;
}
#tag-input:focus{
  border-color: rgba(13,110,253,0.55) !important;
  box-shadow: 0 0 0 3px rgba(13,110,253,0.15) !important;
}

/* 主操作按钮：添加 / 保存 / 关闭 */
#tag-add-btn{
  background: var(--tagBlue) !important;
  color: #fff !important;
  border: 1px solid var(--tagBlue) !important;
  border-radius: 10px !important;
  font-weight: 700 !important;
}
#tag-add-btn:hover{
  background: var(--tagBlueHover) !important;
  border-color: var(--tagBlueHover) !important;
}

#tag-save-btn{
  background: var(--tagGreen) !important;
  color: #fff !important;
  border: 1px solid var(--tagGreen) !important;
  border-radius: 10px !important;
  font-weight: 800 !important;
}
#tag-save-btn:hover{
  background: var(--tagGreenHover) !important;
  border-color: var(--tagGreenHover) !important;
}

#tag-cancel-btn{
  background: #fff !important;
  color: #222 !important;
  border: 1px solid rgba(0,0,0,0.18) !important;
  border-radius: 10px !important;
}
#tag-cancel-btn:hover{
  background: #f3f4f6 !important;
  border-color: rgba(0,0,0,0.22) !important;
}

/* “一键添加”按钮（tag-add-workname） */
#tag-add-workname{
  background: #e7f1ff !important;
  color: #0b5ed7 !important;
  border: 1px solid rgba(13,110,253,0.35) !important;
  border-radius: 10px !important;
  font-weight: 700 !important;
}
#tag-add-workname:hover{
  background: #d8e9ff !important;
  border-color: rgba(13,110,253,0.55) !important;
}

/* 前缀按钮（题材/世界观/风格/警告/CP） */
#tag-modal-backdrop .tag-pref-btn{
  background: #fff !important;
  color: #333 !important;
  border: 1px solid rgba(0,0,0,0.16) !important;
  border-radius: 999px !important;
  padding: 6px 10px !important;
}
#tag-modal-backdrop .tag-pref-btn:hover{
  background: #f0f7ff !important;
  border-color: rgba(13,110,253,0.35) !important;
  color: #0b5ed7 !important;
}
#tag-modal-backdrop .tag-pref-btn:active{
  transform: scale(0.98);
}

/* 当前标签 chip（JS 往 #tag-chip-list 里塞的项）
   你没给 chip 的 class，所以我们“只在 chip-list 的直接子元素”上色 */
#tag-chip-list > *{
  background: #f1f3f5 !important;
  border: 1px solid rgba(0,0,0,0.10) !important;
  color: #333 !important;
  border-radius: 999px !important;
  padding: 6px 10px !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 6px !important;
}

/* chip 的 X（通常是 button/span）做成红色 hover */
#tag-chip-list > * button,
#tag-chip-list > * .chip-x,
#tag-chip-list > * .tag-x{
  background: transparent !important;
  border: none !important;
  color: rgba(220,53,69,0.85) !important;
  cursor: pointer !important;
  font-weight: 900 !important;
}
#tag-chip-list > * button:hover,
#tag-chip-list > * .chip-x:hover,
#tag-chip-list > * .tag-x:hover{
  color: var(--tagRed) !important;
}

/* 弹窗内 code 更好看一点 */
#tag-modal-backdrop code{
  border: 1px solid rgba(0,0,0,0.08) !important;
  color: #0b3d91 !important;
}
  
</style>
  
<body>
    <div class="page-container">

        <div id="create-modal" class="modal">
            <div class="modal-content">
                <h3>作品名</h3>
                <input type="text" id="work-title-input" placeholder="请輸入作品名" maxlength="100">
                <div class="modal-buttons">
                    <button id="cancel-btn">取消</button>
                    <button id="confirm-btn">确定</button>
                </div>
                <p id="create-message" style="color:red; font-size: 0.9em; margin-top: 10px;"></p>
            </div>
        </div>

        <div id="delete-modal" class="modal">
            <div class="modal-content menu-modal-content">
                <h3>确认刪除？</h3>
                <p>此操作不可恢復。</p>
                <div class="modal-buttons">
                    <button id="delete-cancel-btn">否</button>
                    <button id="delete-confirm-btn">是</button>
                </div>
            </div>
        </div>

        <div id="bulk-delete-modal" class="modal">
            <div class="modal-content">
                <h3>选择要刪除的作品</h3>
                <p style="color: #dc3545; font-size: 0.9em;">警告：刪除后无法恢复！</p>
                <div class="delete-list"></div>
                <div class="delete-buttons">
                    <button id="bulk-delete-cancel-btn" class="back-button">取消</button>
                    <button id="bulk-delete-confirm-btn" class="back-button">确认刪除</button>
                </div>
            </div>
        </div>

        <aside class="sidebar-nav" id="sidebar">
            <a href="#" class="nav-link active">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <path d="M12 12V4h6l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2h12a2 2 0 0 0 2-2V12z" />
                    </svg>
                </div>
                <span class="nav-text">作品列表</span>
            </a>

            <a href="https://zhidianworld.com/pictureshare/" class="nav-link">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9V9h2v8zm4 0h-2V9h2v8z" />
                    </svg>
                </div>
                <span class="nav-text">共享素材库</span>
            </a>

          <a href="https://zhidianworld.com/effect/" class="nav-link">
    <div class="nav-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L15 8l6 .5-4.5 4 1 6-5-3-5 3 1-6L3 8.5 9 8z" />
        </svg>
    </div>
    <span class="nav-text">⭐渲染特效</span>
</a>

            <a href="https://zhidianworld.com/usercenter/" class="nav-link">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                </div>
                <span class="nav-text">个人中心</span>
            </a>

            <a href="https://zhidianworld.com/home/" class="nav-link">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-8h-2v8zm4 0h-2v-8h2v8z" />
                    </svg>
                </div>
                <span class="nav-text">安科阅读</span>
            </a>

            <a href="#" class="nav-link" id="logout-btn">
                <div class="nav-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                        fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zm-8 4H2v2h7v-2zM4 22h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2z" />
                    </svg>
                </div>
                <span class="nav-text">退出登錄</span>
            </a>
        </aside>

        <main id="main-page" class="main-content">
            <div class="content-header">
                <div class="header-left">
                    <div class="header-title">
                        <span class="icon-plane">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                                fill="currentColor" viewBox="0 0 24 24">
                                <path d="M21 12l-18-9v18l18-9z" />
                            </svg>
                        </span>
                        <h2>作品列表 (<span id="work-count">0</span>)</h2>
                    </div>
                    <button id="create-btn" class="create-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                            fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                        <span>新建作品</span>
                    </button>
                    <button id="bulk-delete-btn" class="create-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                            fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.88l1.06-1.06L12 12.94l2.48-2.48 1.06 1.06L13.06 14l2.48 2.48-1.06 1.06L12 15.06l-2.48 2.48-1.06-1.06L10.94 14l-2.48-2.48zM15.5 4l-.71-.71c-.18-.18-.44-.29-.7-.29H9.91c-.26 0-.52.11-.7.29L8.5 4H6v2h12V4h-2.5z" />
                        </svg>
                        <span>刪除作品</span>
                    </button>
                </div>
                <div class="header-right">
                    <div class="sort-dropdown">
                        <button class="sort-button">
                            <span>最近打开</span>
                            <span class="sort-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
                                    fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M7 10l5 5 5-5z" />
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="work-list">
                <p style="text-align: center; color: #999; margin-top: 50px;">正在加载作品...</p>
            </div>
        </main>

        <main id="editor-page" class="main-content hidden">
            <div class="editor-toolbar-container">
                <div class="editor-toolbar">
                    <button class="back-button" id="backBtn">返回</button>
                    <div class="editor-title" id="editorTitle"></div>
                    <div class="page-controls">
                        <div class="page-current" id="pageCurrentDisplay">
                            第 <span id="currentPage">1</span> 页（展开）
                        </div>
                        <div class="page-select-dropdown hidden" id="pageDropdown">
                            <ul id="pageList">
                            </ul>
                            <button class="add-page-btn" id="addPageBtn">新增页面</button>
                            <button class="delete-page-btn" id="deletePageBtn">刪除页面</button> </div>
                    </div>
                   <div class="editor-toolbar-actions">
    <button class="back-button" id="localSaveBtn">保存到本地</button>
    <button class="back-button" id="saveBtn">保存草稿</button>
    <button id="autoSaveToggleBtn" class="autosave-on">自动保存：开</button>
    <button class="back-button" id="publishBtn">发布</button>
</div>


                </div>

                <div id="toolbar-quill" class="ql-toolbar ql-snow">
    <span class="ql-formats">
        <button class="ql-undo">
            <svg viewBox="0 0 18 18">
                <path d="M6 10l-4-4 4-4v3h7v2H6v3z"></path>
            </svg>
        </button>
        <button class="ql-redo">
            <svg viewBox="0 0 18 18">
                <path d="M12 10v-3H5V5h7V2l4 4-4 4z"></path>
            </svg>
        </button>
    </span>

    <span class="ql-formats">
        <button id="hiddenTextBtn" title="隐藏文本设置（剧透/暗骰）">隐藏文本</button>
    </span>
    
    <button class="ql-bold back-button">B</button>
    <button class="ql-italic back-button">I</button>
    <button class="ql-underline back-button">U</button>
    <button class="ql-strike"></button>
    <select class="ql-color"></select>
    <select class="ql-background"></select>
    
    <span class="ql-formats">
        <select class="ql-header">
            <option value="1"></option>
            <option value="2"></option>
            <option selected></option>
        </select>
        <button id="diceBtn">🎲</button>
        <button class="ql-list" value="ordered"></button>
        <button class="ql-list" value="bullet"></button>
    </span>
    <button class="back-button" id="listBtn">L10</button>
    <button id="insertThemeTriggerBtn" title="插入主题切换标记">🎨</button>
    
    <span class="ql-formats">
        <button id="uploadImageBtn">🖼️</button>
        <input type="file" id="uploadImageInput" accept="image/*" style="display:none;">
    </span>
</div>
            <div class="editor-main full-screen">
                <div class="editor-container">
                    <div class="editor-main">
                        <div id="editor"></div>
                        <textarea id="plainEditor" class="hidden"></textarea>
                    </div>
                    <aside id="rightSidebar" class="right-sidebar">
                        <div class="tool-section">
                            <h3>工具</h3>

                            <div class="dropdown-container">
                                <div class="dropdown-header" id="roleDropdownHeader">
                                    <span>角色</span>
                                    <span class="arrow">&gt;</span>
                                </div>
                                <div class="dropdown-content" id="roleDropdownContent">
                                    <ul class="role-list" id="roleList">
                                    </ul>
                                    <button class="add-role-btn" id="addRoleBtn">添加角色</button>
                                </div>
                            </div>

                            <div class="dropdown-container">
                                <div class="dropdown-header" id="historyDropdownHeader">
                                    <span>历史记录</span>
                                    <span class="arrow">&gt;</span>
                                </div>
                                <div class="dropdown-content" id="historyDropdownContent">
                                    <ul id="historyList"></ul>
                                </div>
                            </div>

                            <div class="dropdown-container">
                                <div class="dropdown-header" id="diceLogDropdownHeader">
                                    <span>🎲 骰子记录</span>
                                    <span class="arrow">&gt;</span>
                                </div>
                                <div class="dropdown-content open" id="diceLogDropdownContent">
                                    <ul class="role-list" id="diceLogList"
                                        style="list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto;">
                                    </ul>
                                </div>
                            </div>

                        </div>
                    </aside>
                    <div id="rightSidebarToggle" class="right-sidebar-toggle"></div>
                </div>
            </div>
        </main>
        <div id="roleModal" class="modal">
            <div class="modal-content">
                <h3>添加/编辑角色</h3>
                <label for="roleNameInput">名称</label>
                <input type="text" id="roleNameInput" placeholder="请輸入角色名称">

                <label for="roleNotesTextarea">备注</label>
                <textarea id="roleNotesTextarea" rows="4" placeholder="请輸入角色备注"></textarea>

                <div class="color-picker-wrapper">
                    <label for="roleColorPicker">选取颜色</label>
                    <input type="color" id="roleColorPicker" class="color-picker" value="#000000">
                </div>

                <div class="modal-buttons">
                    <button class="cancel" id="cancelRoleBtn">取消</button>
                    <button class="confirm" id="confirmRoleBtn">确认</button>
                </div>
            </div>
        </div>

        <div id="galleryModal" class="modal">
    <div class="modal-content gallery-modal-content">
        <h3>编辑图库</h3>
        <div class="gallery-image-list" id="galleryImageList">
            <label for="imageUploadInput" class="add-image-btn">
                <span>+</span>
                <input type="file" id="imageUploadInput" accept="image/*" multiple style="display:none;">
            </label>
        </div>
        <div class="modal-buttons">
            <button class="cancel" id="cancelGalleryBtn">取消</button>
            <button class="confirm" id="confirmGalleryBtn">确认</button>
        </div>
    </div>
</div>

      <!-- 新增：图库大图预览浮层 -->
<div id="galleryPreviewOverlay" class="gallery-preview-overlay">
  <div class="gallery-preview-content">
    <button id="galleryPreviewClose" class="gallery-preview-close">×</button>
    <img id="galleryPreviewImage" src="" alt="预览图片">
  </div>
</div>

        <div id="hiddenTextModal" class="modal hidden">
            <div class="modal-content hidden-text-modal-content">
                <h3>请选择隐藏模式</h3>
                <p>您选中的文本将以隐藏样式显示：</p>

                <button id="hiddenTextSpoilerOption" class="btn btn-primary">
                    1. 💬 剧透模式 (鼠标悬停即显示)
                </button>

                <button id="hiddenTextSecretOption" class="btn btn-warning">
                    2. 🎲 暗骰模式 (需点击并警告后才显示)
                </button>

                <button id="hiddenTextCloseBtn" class="btn btn-secondary close-btn">取消</button>
            </div>
        </div>
    </div>

<button class="floating-sidebar-btn" id="toggleSidebarBtn">
  <svg class="floating-sidebar-icon" xmlns="http://www.w3.org/2000/svg" 
       viewBox="0 0 24 24" fill="none" stroke="currentColor" 
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- 简单的工具箱图标 -->
    <rect x="3" y="8" width="18" height="11" rx="2" ry="2"></rect>
    <path d="M9 8V6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
    <path d="M3 12h18"></path>
    <path d="M10 12v3"></path>
    <path d="M14 12v3"></path>
  </svg>
  <span class="floating-sidebar-label">创作工具</span>
</button>


<div class="floating-sidebar" id="floatingSidebar">
  <div class="floating-sidebar-header">
    <span class="floating-sidebar-title">工具栏</span>
    <button class="close-btn" id="closeSidebarBtn">✕</button>
  </div>

  <hr>

  <!-- 这块是手机浮窗真正的内容区域，稍后用 JS 把 rightSidebar 的内容搬进来 -->
  <div class="floating-sidebar-body" id="floatingSidebarBody">
    <!-- JS 会在手机端把 #rightSidebar 里的工具列表移到这里 -->
  </div>
</div>

  
    </body>
  
  <script src="https://api.anchorx.ca/vendor_assets/quill.js"></script>
  <script src="https://api.anchorx.ca/vendor_assets/browser-image-compression.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.1/dist/html-docx.js"></script>
  
<script>
    /* --------- 安全检查（token）--------- */
    const token = localStorage.getItem('token');
    if (!token) {
        alert('请先登录以访问此页面。');
        window.location.href = 'https://zhidianworld.com/login/';
    }

    /* --------- 进入 DOMContentLoaded 后初始化所有逻辑 --------- */
    document.addEventListener('DOMContentLoaded', () => {

      // 【新增：自动保存状态】
let autoSaveTimer = null;
let hasUnsavedChanges = false;
let isSaving = false; // 防止多重保存请求
      let autoSaveEnabled = true;


        /* ---------- DOM 元素（按你页面的 id/class 名称来找）---------- */
        const mainPage = document.getElementById('main-page');
        const editorPage = document.getElementById('editor-page');
        const editorTitle = document.getElementById('editorTitle');
        const backBtn = document.getElementById('backBtn');
        const sidebar = document.getElementById('sidebar');
        const workList = document.querySelector('.work-list');
        const workCountSpan = document.getElementById('work-count');

        // 新建弹窗元素
        const createBtn = document.getElementById('create-btn');
        const createModal = document.getElementById('create-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        const workTitleInput = document.getElementById('work-title-input');
        const createMessage = document.getElementById('create-message');

        // 刪除弹窗
        const deleteModal = document.getElementById('delete-modal');
        const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
        const deleteCancelBtn = document.getElementById('delete-cancel-btn');
        let workToDelete = null;

        // 批量刪除
        const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
        const bulkDeleteModal = document.getElementById('bulk-delete-modal');
        const bulkDeleteList = bulkDeleteModal.querySelector('.delete-list');
        const bulkDeleteConfirmBtn = document.getElementById('bulk-delete-confirm-btn');
        const bulkDeleteCancelBtn = document.getElementById('bulk-delete-cancel-btn');

        // 编辑器相关
        const saveBtn = document.getElementById('saveBtn');
      const localSaveBtn = document.getElementById('localSaveBtn'); // ✅ 新增：本地保存按钮
        const publishBtn = document.getElementById('publishBtn');
        const quillEditor = document.getElementById('editor');
        const plainEditor = document.getElementById('plainEditor');
        const diceBtn = document.getElementById('diceBtn');
        const diceLogDropdownHeader = document.getElementById('diceLogDropdownHeader');
        const diceLogDropdownContent = document.getElementById('diceLogDropdownContent');
        const diceLogList = document.getElementById('diceLogList');
        const listBtn = document.getElementById('listBtn');

        // 页码控件
        const pageCurrentDisplay = document.getElementById('pageCurrentDisplay');
        const pageDropdown = document.getElementById('pageDropdown');
        const pageList = document.getElementById('pageList');
        const addPageBtn = document.getElementById('addPageBtn');
      const deletePageBtn = document.getElementById('deletePageBtn'); // <-- 新增此行
        const currentPageSpan = document.getElementById('currentPage');

        // 右侧与角色
        const rightSidebar = document.getElementById('rightSidebar');
        const rightSidebarToggle = document.getElementById('rightSidebarToggle');
        const roleDropdownHeader = document.getElementById('roleDropdownHeader');
        const roleDropdownContent = document.getElementById('roleDropdownContent');
        const roleList = document.getElementById('roleList');
        const addRoleBtn = document.getElementById('addRoleBtn');
        const roleModal = document.getElementById('roleModal');
        const roleNameInput = document.getElementById('roleNameInput');
        const roleNotesTextarea = document.getElementById('roleNotesTextarea');
        const roleColorPicker = document.getElementById('roleColorPicker');
        const confirmRoleBtn = document.getElementById('confirmRoleBtn');
        const cancelRoleBtn = document.getElementById('cancelRoleBtn');

        // 图片上传控件（Quill 工具栏里的 input）
        const uploadImageBtn = document.getElementById('uploadImageBtn');
        const uploadImageInput = document.getElementById('uploadImageInput');

        const historyDropdownHeader = document.getElementById('historyDropdownHeader');
        const historyDropdownContent = document.getElementById('historyDropdownContent');
        const historyList = document.getElementById('historyList');

        // 新增：图库弹窗元素
        const galleryModal = document.getElementById('galleryModal');
        const galleryImageList = document.getElementById('galleryImageList');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const cancelGalleryBtn = document.getElementById('cancelGalleryBtn');
        const confirmGalleryBtn = document.getElementById('confirmGalleryBtn');
      const galleryPreviewOverlay = document.getElementById('galleryPreviewOverlay');
const galleryPreviewImage = document.getElementById('galleryPreviewImage');
const galleryPreviewClose = document.getElementById('galleryPreviewClose');


 // ... 在其他变量定义之后

const hiddenTextModal = document.getElementById('hiddenTextModal');
const hiddenTextCloseBtn = document.getElementById('hiddenTextCloseBtn');
const hiddenTextSpoilerOption = document.getElementById('hiddenTextSpoilerOption');
const hiddenTextSecretOption = document.getElementById('hiddenTextSecretOption');
const hiddenTextBtn = document.getElementById('hiddenTextBtn');

const toggleBtn2 = document.getElementById('toggleSidebarBtn');
const sidebar2 = document.getElementById('floatingSidebar');
const closeBtn2 = document.getElementById('closeSidebarBtn');
const desktopSidebar = document.getElementById('rightSidebar');
const floatingBody = document.getElementById('floatingSidebarBody');

// --------- 📱 手机端：把右侧工具栏内容搬进浮窗（不再克隆） ---------
if (window.innerWidth <= 768) {
  if (floatingBody) {
    if (desktopSidebar) {
      if (!floatingBody.dataset.moved) {
        // 把 rightSidebar 里的所有子节点挪到浮窗 body
        while (desktopSidebar.firstChild) {
          floatingBody.appendChild(desktopSidebar.firstChild);
        }
        floatingBody.dataset.moved = '1';
      }
    }
  }
}

// --------- 浮窗开关逻辑（和之前类似，只保留这一份） ---------
if (toggleBtn2) {
  if (sidebar2) {
    const openSidebar = function () {
      sidebar2.classList.add('open');
    };

    const closeSidebarFn = function () {
      sidebar2.classList.remove('open');
    };

    // 点击右下角蓝色按钮：开 / 关
    toggleBtn2.addEventListener('click', function (e) {
      e.stopPropagation();
      if (sidebar2.classList.contains('open')) {
        closeSidebarFn();
      } else {
        openSidebar();
      }
    });

    // 关闭按钮
    if (closeBtn2) {
      closeBtn2.addEventListener('click', function () {
        closeSidebarFn();
      });
    }

    // 点击浮窗外收起
    document.addEventListener('click', function (e) {
      if (window.innerWidth <= 768) {
        const insideSidebar = sidebar2.contains(e.target);
        const onToggleBtn = toggleBtn2.contains(e.target);

        if (!insideSidebar) {
          if (!onToggleBtn) {
            closeSidebarFn();
          }
        }
      }
    });
  }
}

// 原来的 currentSelectionRange 可以接在后面
let currentSelectionRange = null;

      /* ---------- 自动保存的核心函数 ---------- */
function startAutoSave() {
    // 每次启动前先清空旧的定时器
    if (autoSaveTimer) {
        clearInterval(autoSaveTimer);
    }

    // 每隔 5 秒执行一次保存检查
    autoSaveTimer = setInterval(async () => {
          if (!autoSaveEnabled) return; // 🔹新增：删除期间不执行自动保存
        if (hasUnsavedChanges && currentWorkId && !isSaving) {
            console.log('自动保存触发...');
            const success = await saveWork(true); // 传入 true 表示是自动保存
            if (success) {
                hasUnsavedChanges = false; // 成功保存后重置状态
            }
        }
    }, 5000); // 5000 毫秒 = 5 秒
}

// 
/* ---------- 标记内容有变动 ---------- */
// ⚠️ 此函数在所有内容变动（Quill/Plain Text）的事件监听器中被调用
function markAsChanged() {
    if (!hasUnsavedChanges) {
        hasUnsavedChanges = true;
        saveBtn.textContent = '保存*'; // 给用户一个未保存的提示
        
        // 【新增：如果作品处于“已发布”状态并被编辑，重新启用按钮并改为“更新*”】
        if (publishBtn.disabled === true && publishBtn.textContent === '已发布') {
            publishBtn.textContent = '更新*';
            publishBtn.disabled = false;
        }
    }
}

/* ---------- 隐藏文本/暗骰模式逻辑 ---------- */

// 统一的弹窗关闭函数
function closeHiddenTextModal() {
    // 修正：将 'hidden' 类加回，以确保弹窗被隐藏
    hiddenTextModal.classList.add('hidden'); 
    
    // 移除 inline style（可选，但推荐）
    hiddenTextModal.style.display = ''; 

    // 重新显示 Quill 工具栏
    document.body.classList.remove('modal-active');
    currentSelectionRange = null; 
}

// 1. 绑定工具栏按钮点击事件
if (hiddenTextBtn) {
    hiddenTextBtn.addEventListener('click', () => {
        // 捕获选区
        currentSelectionRange = quill.getSelection(true); 

        if (!currentSelectionRange || currentSelectionRange.length === 0) {
            alert('请先选择要设置的文本！');
            return;
        }
        
        // 💥 关键修正：移除 'hidden' 类，才能覆盖 CSS 中的 display: none !important
        hiddenTextModal.classList.remove('hidden'); 

        // 新增：在显示弹窗前，为 body 添加类以隐藏工具栏（如您所要求）
        document.body.classList.add('modal-active');
        hiddenTextModal.style.display = 'flex'; // 显示弹窗
    });
}

// 2. 绑定弹窗选项和关闭事件
hiddenTextCloseBtn.addEventListener('click', closeHiddenTextModal);

function applyHiddenTextFormat(mode) {
    if (currentSelectionRange) {
        const { index, length } = currentSelectionRange;

        // 应用格式，并将 mode 作为 Blot 的值传递
        quill.formatText(
            index,
            length,
            'hiddenText', // Blot 的名称
            { mode: mode }, // 传递一个包含模式的对象
            Quill.sources.USER
        );
        // 确保光标保持在应用格式后的位置
        quill.setSelection(index + length, 0); 

        closeHiddenTextModal();
    }
}

// 绑定选项按钮
hiddenTextSpoilerOption.addEventListener('click', () => {
    applyHiddenTextFormat('spoiler');
});

hiddenTextSecretOption.addEventListener('click', () => {
    applyHiddenTextFormat('secret');
});

        let currentRoleForGallery = null; // 用于存储当前正在编辑图库的角色
        let galleryImages = []; // 用于存储当前角色的图库图片

        // 折叠/展开
        historyDropdownHeader.addEventListener('click', () => {
            historyDropdownContent.classList.toggle('open');
            historyDropdownHeader.classList.toggle('open');
        });

        // 新增历史记录的函数
        function addHistoryRecord(action) {
            const li = document.createElement('li');
            li.textContent = `${new Date().toLocaleString()} - ${action}`;
            historyList.prepend(li);
        }


        /* ---------- 全局状态 ---------- */
        let pages = [{ content: { ops: [] } }];
 // 始终和后端 schema 对齐：数组，每项至少有 content 字段
        let currentPageIndex = 0;       // 使用索引管理页码（避免自造 id）
        let currentWorkId = null;       // 编辑时的 work._id
        let roles = [];                 // 当前作品的角色数组（来自后端）
        let currentEditRoleId = null;   // 角色编辑时的 id
        let selectedRoleColor = null;
        let isQuillActive = true;

      let pageHistories = {};

        /* ---------- API 基础地址 ---------- */
        const API_BASE_URL = 'https://api.anchorx.ca/api/works';

/* ---------- 1. 注册自定义 Blot（插件） - 更新 HiddenTextBlot ---------- */

// 导入 Quill 核心 Blot 类
const Inline = Quill.import('blots/inline');

/* 1.1 隐藏文字（Inline Blot） - 更新以支持 mode 属性 */
class HiddenTextBlot extends Inline {
    static blotName = 'hiddenText';
    static tagName = 'span';
    static className = 'spoiler-hidden'; 

    // 静态方法：从 DOM 节点解析出格式值
    static formats(node) {
        // 默认返回 'spoiler'
        const mode = node.getAttribute('data-mode') || 'spoiler'; 
        return { mode };
    }

    // 静态方法：创建 DOM 节点
    static create(value) {
        const node = super.create(value);
        let mode = 'spoiler'; // 默认模式

        if (value && value.mode) {
            mode = value.mode;
        } else if (typeof value === 'object' && value.mode) {
            mode = value.mode;
        }

        // 设置自定义属性和可能的特定 class
        node.setAttribute('data-mode', mode);
        if (mode === 'secret') {
            node.classList.add('secret-dice');
        } else {
            node.classList.remove('secret-dice');
        }
        return node;
    }

    // 实例方法：更新格式属性
    format(name, value) {
        if (name === 'hiddenText' && value && value.mode) {
            this.domNode.setAttribute('data-mode', value.mode);
            if (value.mode === 'secret') {
                this.domNode.classList.add('secret-dice');
            } else {
                this.domNode.classList.remove('secret-dice');
            }
        } else {
            super.format(name, value);
        }
    }
}

// 注册自定义 Blot
Quill.register(HiddenTextBlot);

      /* =========================
   ✅ 可缩放图片：覆盖默认 image blot，让 Delta 能保存 width
   ========================= */
const BaseImage = Quill.import('formats/image');

class ResizableImage extends BaseImage {
  static create(value) {
    // 兼容旧数据：value 可能是 string（纯 src）
    const src = (typeof value === 'string')
      ? value
      : (value && typeof value === 'object' ? (value.src || value.url || '') : '');

    const node = super.create(src);

    // 基础展示（防止超出编辑器）
    node.setAttribute('loading', 'lazy');
    node.style.maxWidth = '100%';
    node.style.height = 'auto';
    node.style.display = 'block';
    node.style.margin = '8px auto';

    // 读取/应用 width（新数据）
    if (value && typeof value === 'object') {
      if (value.alt) node.setAttribute('alt', value.alt);

      if (value.width) {
        node.style.width = value.width;           // 例如 '70%' / '420px'
        node.setAttribute('data-width', value.width);
      } else {
        node.removeAttribute('data-width');
      }
    } else {
      // 兼容：如果 DOM 上已有 data-width，也应用
      const w = node.getAttribute('data-width');
      if (w) node.style.width = w;
    }

    return node;
  }

  static value(node) {
    const src = node.getAttribute('src') || '';
    const width = node.getAttribute('data-width') || node.style.width || '';
    const alt = node.getAttribute('alt') || '';

    // 兼容旧格式：如果没有 width/alt，就还原成 string，避免影响老内容
    if (!width && !alt) return src;

    return { src, width, alt };
  }
}

// 覆盖默认 image blot
Quill.register(ResizableImage, true);

      /* ---------- 初始化 Quill ---------- */
    const quill = new Quill('#editor', {
        modules: {
            toolbar: '#toolbar-quill'
        },
        theme: 'snow'
    });

      // --- 新增代码：获取 Blot Formatter 的核心 Actions ---

// ⚠️ 注意：Quill 初始化时 formats 列表必须包含 'hiddenText'
// 例如：formats: ['bold', ..., 'hiddenText']
      
      quill.on('text-change', markAsChanged); 

      /* =========================
   ✅ 图片缩放 UI：点击图片弹出缩放条（%）
   ========================= */
(function setupImageResizeUI(quill) {
  let selectedImg = null;

  // 创建面板
  const panel = document.createElement('div');
  panel.id = 'ax-imgsize-panel';
  panel.style.cssText = `
    position: fixed;
    z-index: 99999;
    display: none;
    padding: 10px 12px;
    background: rgba(255,255,255,0.96);
    border: 1px solid rgba(0,0,0,0.12);
    border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.18);
    font-size: 12px;
    color: #222;
    user-select: none;
  `;

  panel.innerHTML = `
    <div style="display:flex; align-items:center; gap:10px;">
      <span style="font-weight:700;">图片大小</span>
      <input id="imgSizeRange" type="range" min="20" max="100" step="1" style="width:180px;">
      <span id="imgSizeLabel" style="width:44px; text-align:right;">70%</span>
      <button id="imgSizeReset" type="button" style="border:1px solid #ccc;background:#fff;border-radius:8px;padding:4px 8px;cursor:pointer;">重置</button>
      <button id="imgSizeClose" type="button" style="border:0;background:transparent;cursor:pointer;font-size:16px;line-height:1;">×</button>
    </div>
    <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">
      ${[25,50,70,85,100].map(v=>`<button data-preset="${v}" type="button"
        style="border:1px solid #ddd;background:#fff;border-radius:999px;padding:4px 10px;cursor:pointer;">${v}%</button>`).join('')}
    </div>
  `;
  document.body.appendChild(panel);

  const range = panel.querySelector('#imgSizeRange');
  const label = panel.querySelector('#imgSizeLabel');
  const btnReset = panel.querySelector('#imgSizeReset');
  const btnClose = panel.querySelector('#imgSizeClose');

  function markChangedSafe() {
    if (typeof window.markAsChanged === 'function') window.markAsChanged();
  }

  function applyWidth(percent) {
    if (!selectedImg) return;
    const w = String(percent) + '%';
    selectedImg.style.width = w;
    selectedImg.setAttribute('data-width', w);
    quill.update('user');         // 让 Quill 感知 DOM 改动（用于导出/保存）
    markChangedSafe();
  }

  function showNear(node) {
    const r = node.getBoundingClientRect();
    const x = Math.min(window.innerWidth - 20, Math.max(10, r.left));
    const y = Math.min(window.innerHeight - 20, Math.max(10, r.top - 70));
    panel.style.left = x + 'px';
    panel.style.top = y + 'px';
    panel.style.display = 'block';
  }

  function hide() {
    panel.style.display = 'none';
    selectedImg = null;
  }

  // 面板交互
  range.addEventListener('input', () => {
    label.textContent = range.value + '%';
    applyWidth(range.value);
  });

  panel.addEventListener('click', (e) => {
    const preset = e.target && e.target.getAttribute && e.target.getAttribute('data-preset');
    if (preset) {
      range.value = preset;
      label.textContent = preset + '%';
      applyWidth(preset);
    }
  });

  btnReset.addEventListener('click', () => {
    if (!selectedImg) return;
    selectedImg.style.width = '';
    selectedImg.removeAttribute('data-width');
    quill.update('user');
    markChangedSafe();
    range.value = 100;
    label.textContent = '100%';
  });

  btnClose.addEventListener('click', hide);

  // 点击图片选中
  quill.root.addEventListener('click', (e) => {
    const t = e.target;
    if (t && t.tagName === 'IMG') {
      selectedImg = t;

      // 读取当前宽度（默认 70%）
      const w = (t.getAttribute('data-width') || t.style.width || '70%').trim();
      const num = parseInt(w.replace('%',''), 10);
      const val = (!isNaN(num) ? num : 70);

      range.value = val;
      label.textContent = val + '%';
      showNear(t);
      return;
    }
    hide();
  });

  // 滚动/缩放时隐藏，避免漂移
  window.addEventListener('scroll', hide, true);
  window.addEventListener('resize', hide);
})(quill);


        // 撤销/重做按钮（toolbar里）
        const undoBtn = document.querySelector('.ql-undo');
        const redoBtn = document.querySelector('.ql-redo');
        if (undoBtn) undoBtn.addEventListener('click', () => quill.history.undo());
        if (redoBtn) redoBtn.addEventListener('click', () => quill.history.redo());

        /* ---------- 帮助函数：headers ---------- */
        function authHeaders(jsonContent) {
            const h = { 'Authorization': `Bearer ${localStorage.getItem('token')}` };
            if (jsonContent === true) h['Content-Type'] = 'application/json';
            return h;
        }

        /* ---------- 图片上传（imggb helper）---------- */
        // 注意：强烈建议把 imgbb API key 放到后端，前端只调用后端上传接口以避免泄露。
        async function uploadFileToImgBB(file) {
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onloadend = async () => {
                    try {
                        const base64Image = reader.result.split(',')[1];
                        const formData = new FormData();
                        formData.append('image', base64Image);
                        // 目前仍然直接请求 imgbb（不安全），建议你改为：POST /api/upload （后端代理）
                        const response = await fetch('https://api.imgbb.com/1/upload?key=040dbc9e6e680f321e09d9e05f447094', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        if (data && data.success) {
                            resolve(data.data.url);
                        } else {
                            reject(new Error('图床上传失败'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        // Quill 工具栏里的文件輸入逻辑
        if (uploadImageBtn && uploadImageInput) {
            uploadImageBtn.addEventListener('click', () => uploadImageInput.click());
uploadImageInput.addEventListener('change', async () => {
    const file = uploadImageInput.files[0];
    if (!file) return;
    try {
        const imageUrl = await uploadFileToImgBB(file);
       const range = quill.getSelection(); // [cite: 528]
        if (range) {
            quill.insertEmbed(range.index, 'image', { src: imageUrl, width: '70%' });
        } else {
            quill.insertEmbed(quill.getLength(), 'image', imageUrl);// [cite: 529]
        }
        
        // 【新增：插入图片后自动触发保存】
        await saveWork(); 

    } catch (err) {
        console.error('图片上传失败', err);// [cite: 529]
        alert('图片上传失败，请稍后再试。');
    }
});
        }

/* ---------- 作品标签（弹窗 + PATCH to backend）---------- */

// 前端也做一次轻量清洗，体验更好（最终以后端为准）
function normalizeTagsClient(input) {
  const arr = Array.isArray(input) ? input : [];
  const out = [];
  const seen = new Set();
  for (var i = 0; i < arr.length; i++) {
    var t = String(arr[i] == null ? '' : arr[i]).replace(/\s+/g, ' ').trim();
    if (!t) continue;
    if (t.length > 32) t = t.slice(0, 32);
    var n = t.toLowerCase();
    if (seen.has(n)) continue;
    seen.add(n);
    out.push(t);
    if (out.length >= 30) break;
  }
  return out;
}

async function fetchWorkTagsForEdit(workId) {
  // 用 meta 且 noView=1，避免编辑端浏览量被刷
  const res = await fetch(`${API_BASE_URL}/${workId}/meta?noView=1`, {
    method: 'GET',
    headers: authHeaders(false)
  });
  const j = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(j.message || ('获取 tags 失败 ' + res.status));
  return Array.isArray(j.tags) ? j.tags : [];
}

async function saveWorkTags(workId, tags) {
  const res = await fetch(`${API_BASE_URL}/${workId}/tags`, {
    method: 'PATCH',
    headers: authHeaders(true),
    body: JSON.stringify({ tags: tags })
  });
  const j = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(j.message || ('保存 tags 失败 ' + res.status));
  return Array.isArray(j.tags) ? j.tags : [];
}

function showTagEditModal(workId, workTitle) {
  const modalHtml = `
    <div id="tag-modal-backdrop" style="position: fixed; inset: 0; background: rgba(0,0,0,0.45);
         display:flex; justify-content:center; align-items:center; z-index:10000;">
      <div style="background:#fff; width:520px; max-width: calc(100vw - 24px);
           border-radius:12px; padding:16px 16px 14px; box-shadow:0 10px 30px rgba(0,0,0,0.22);">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div>
            <div style="font-weight:800; font-size:1.1rem;">作品标签</div>
            <div style="margin-top:4px; color:#666; font-size:0.92rem;">
              当前作品：<span style="color:#222; font-weight:700;">《${String(workTitle || '未命名').replace(/[<>]/g,'')}》</span>
            </div>
          </div>
          <button id="tag-modal-x" style="border:none; background:#f2f2f2; border-radius:10px; padding:6px 10px; cursor:pointer;">✕</button>
        </div>

        <div style="margin-top:10px; padding:10px 12px; background:#f7fbff; border:1px solid #d9ecff; border-radius:10px; color:#245; font-size:0.9rem; line-height:1.45;">
          建议：至少加一个“作品名标签”，方便你未来做独立筛选。示例：<code style="background:#fff; padding:2px 6px; border-radius:6px;">作品:${String(workTitle || '').replace(/[<>]/g,'')}</code>
          <button id="tag-add-workname" style="margin-left:8px; border:1px solid #b8dcff; background:#fff; color:#0366d6; border-radius:8px; padding:4px 8px; cursor:pointer;">一键添加</button>
        </div>

        <div style="margin-top:12px;">
          <div style="color:#555; font-size:0.9rem; margin-bottom:6px;">当前标签（点击 ✕ 删除）：</div>
          <div id="tag-chip-list" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; align-items:center;">
          <input id="tag-input" placeholder="输入标签，回车添加（例如：题材:悬疑 / 世界观:幻想乡）"
                 style="flex:1; border:1px solid #ddd; border-radius:10px; padding:10px 12px; outline:none;">
          <button id="tag-add-btn" style="border:none; background:#0077cc; color:#fff; border-radius:10px; padding:10px 12px; cursor:pointer;">添加</button>
        </div>

        <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
          <button class="tag-pref-btn" data-pref="题材:" style="border:1px solid #ddd; background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer;">题材:</button>
          <button class="tag-pref-btn" data-pref="世界观:" style="border:1px solid #ddd; background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer;">世界观:</button>
          <button class="tag-pref-btn" data-pref="风格:" style="border:1px solid #ddd; background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer;">风格:</button>
          <button class="tag-pref-btn" data-pref="警告:" style="border:1px solid #ddd; background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer;">警告:</button>
          <button class="tag-pref-btn" data-pref="CP:" style="border:1px solid #ddd; background:#fff; border-radius:999px; padding:6px 10px; cursor:pointer;">CP:</button>
        </div>

        <div style="margin-top:14px; display:flex; justify-content:flex-end; gap:10px;">
          <button id="tag-cancel-btn" style="border:1px solid #ddd; background:#fff; border-radius:10px; padding:10px 12px; cursor:pointer;">关闭</button>
          <button id="tag-save-btn" style="border:none; background:#16a34a; color:#fff; border-radius:10px; padding:10px 12px; cursor:pointer;">保存</button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);

  const backdrop = document.getElementById('tag-modal-backdrop');
  const chipList = document.getElementById('tag-chip-list');
  const input = document.getElementById('tag-input');
  const addBtn = document.getElementById('tag-add-btn');
  const saveBtn = document.getElementById('tag-save-btn');
  const cancelBtn = document.getElementById('tag-cancel-btn');
  const closeX = document.getElementById('tag-modal-x');
  const addWorkNameBtn = document.getElementById('tag-add-workname');

  let tags = [];

  function renderChips() {
    chipList.innerHTML = '';
    if (!tags.length) {
      chipList.innerHTML = '<div style="color:#999; font-size:0.9rem;">（暂无标签）</div>';
      return;
    }
    tags.forEach((t) => {
      const safe = String(t).replace(/[<>]/g,'');
      const el = document.createElement('div');
      el.style.cssText = 'display:inline-flex; align-items:center; gap:6px; background:#f3f4f6; border-radius:999px; padding:6px 10px; font-size:0.88rem;';
      el.innerHTML = `<span>${safe}</span><span style="cursor:pointer; color:#666; font-weight:900;" data-del="${encodeURIComponent(t)}">✕</span>`;
      chipList.appendChild(el);
    });
  }

  function addTag(t) {
    if (!t) return;
    const merged = normalizeTagsClient(tags.concat([t]));
    tags = merged;
    renderChips();
  }

  // 加载现有 tags
  (async () => {
    try {
      const existing = await fetchWorkTagsForEdit(workId);
      tags = normalizeTagsClient(existing);
      renderChips();
    } catch (err) {
      console.error(err);
      alert('加载标签失败：' + err.message);
      tags = [];
      renderChips();
    }
  })();

  // 删除 chip
  chipList.addEventListener('click', (e) => {
    const del = e.target && e.target.getAttribute && e.target.getAttribute('data-del');
    if (!del) return;
    const val = decodeURIComponent(del);
    const lower = val.toLowerCase();
    tags = tags.filter(x => String(x).toLowerCase() !== lower);
    renderChips();
  });

  // 前缀按钮
  backdrop.querySelectorAll('.tag-pref-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pref = btn.getAttribute('data-pref') || '';
      input.value = (pref + (input.value || ''));
      input.focus();
    });
  });

  // 一键添加作品名标签
  if (addWorkNameBtn) {
    addWorkNameBtn.addEventListener('click', () => {
      const t = '作品:' + String(workTitle || '').replace(/\s+/g,' ').trim();
      if (t === '作品:') return;
      addTag(t);
    });
  }

  // 添加按钮 / 回车添加
  addBtn.addEventListener('click', () => {
    const v = String(input.value || '').trim();
    input.value = '';
    addTag(v);
    input.focus();
  });
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addBtn.click();
    }
  });

  function close() { backdrop && backdrop.remove(); }
  cancelBtn.addEventListener('click', close);
  closeX.addEventListener('click', close);
  backdrop.addEventListener('click', (e) => {
    if (e.target === backdrop) close();
  });

  // 保存
  saveBtn.addEventListener('click', async () => {
    try {
      const cleaned = normalizeTagsClient(tags);
      const saved = await saveWorkTags(workId, cleaned);
      tags = normalizeTagsClient(saved);
      alert('标签已保存！');
      close();
      // 刷新作品列表，让按钮上的 (N) 更新
      loadWorks();
    } catch (err) {
      console.error(err);
      alert('保存失败：' + err.message);
    }
  });
}
      
        /* ---------- 封面上传（弹窗 + PATCH to backend）---------- */
        function showCoverUploadModal(workId) {
            const modalHtml = `
                <div id="cover-modal-backdrop" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); display:flex; justify-content:center; align-items:center; z-index:10000;">
                    <div style="background:#fff;padding:18px;border-radius:10px; width:320px; text-align:center;">
                        <h3>上传/更改封面</h3>
                        <input type="file" id="cover-image-input" accept="image/*" style="display:none;">
                        <label for="cover-image-input" id="cover-label" style="display:inline-block; width:160px; height:120px; border:1px dashed #ccc; line-height:120px; cursor:pointer; margin:10px auto;">選擇图片</label>
                        <div style="margin-top:10px;">
                            <button id="upload-confirm-btn">确认</button>
                            <button id="upload-cancel-btn">取消</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const backdrop = document.getElementById('cover-modal-backdrop');
            const fileInput = document.getElementById('cover-image-input');
            const label = document.getElementById('cover-label');
            const confirmBtnLocal = document.getElementById('upload-confirm-btn');
            const cancelBtnLocal = document.getElementById('upload-cancel-btn');
            let selectedFile = null;

            fileInput.addEventListener('change', e => {
                selectedFile = e.target.files[0];
                if (!selectedFile) return;
                const reader = new FileReader();
                reader.onload = ev => {
                    label.innerHTML = `<img src="${ev.target.result}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;">`;
                };
                reader.readAsDataURL(selectedFile);
            });

            cancelBtnLocal.addEventListener('click', () => backdrop.remove());
            confirmBtnLocal.addEventListener('click', async () => {
                if (!selectedFile) {
                    alert('请先选择图片。');
                    return;
                }
                try {
                    // 上传图床并把 URL 发给后端
                    const imgUrl = await uploadFileToImgBB(selectedFile);
                    const res = await fetch(`${API_BASE_URL}/${workId}/cover`, {
                        method: 'PATCH',
                        headers: authHeaders(true),
                        body: JSON.stringify({ coverImageUrl: imgUrl })
                    });
                    if (res.ok) {
                        alert('封面更新成功！');
                        loadWorks(); // 刷新列表显示
                    } else {
                        const jd = await res.json();
                        alert('封面更新失败：' + (jd.message || res.status));
                    }
                } catch (err) {
                    console.error('封面上传失败', err);
                    alert('封面上传失败，请稍后再试。');
                } finally {
                    backdrop.remove();
                }
            });
        }

        /* ---------- 后端交互：作品列表 / 创建 / 刪除 / 获取单个 ---------- */
        async function fetchWorks() {
            try {
                const res = await fetch(API_BASE_URL, { headers: authHeaders(false) });
                if (res.status === 401) {
                    // token 过期
                    localStorage.removeItem('token');
                    alert('登录已失效，请重新登录。');
                    window.location.href = 'https://zhidianworld.com/login/';
                    return [];
                }
                if (!res.ok) {
                    const j = await res.json();
                    console.error('获取作品失败', j);
                    alert('获取作品失败：' + (j.message || res.status));
                    return [];
                }
                return await res.json();
            } catch (err) {
                console.error('fetchWorks error', err);
                alert('无法获取作品列表，请检查网络。');
                return [];
            }
        }

        async function createWork(title) {
            try {
                const body = { title: title, content: [{ content: { ops: [] } }] };
                const res = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: authHeaders(true),
                    body: JSON.stringify(body)
                });
                const j = await res.json();
                if (!res.ok) {
                    alert('创建失败：' + (j.message || res.status));
                    return null;
                }
                return j;
            } catch (err) {
                console.error('createWork error', err);
                alert('创建作品失败，请检查网络。');
                return null;
            }
        }

        async function deleteWork(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders(false)
                });
                if (!res.ok) {
                    const j = await res.json();
                    alert('刪除失败：' + (j.message || res.status));
                    return false;
                }
                return true;
            } catch (err) {
                console.error('deleteWork error', err);
                alert('刪除失败，请检查网络。');
                return false;
            }
        }

        async function fetchWorkById(id) {
            try {
                const res = await fetch(`${API_BASE_URL}/${id}`, { headers: authHeaders(false) });
                if (!res.ok) {
                    throw new Error('加载失败');
                }
                return await res.json();
            } catch (err) {
                console.error('fetchWorkById error', err);
                alert('加载作品失败');
                return null;
            }
        }

      // 编辑器加载页：走 /:id/pages（带 auth，不走 /:id 增加 views）
async function fetchWorkPagesForEditor(workId) {
  const res = await fetch(`${API_BASE_URL}/${workId}/pages`, {
    method: 'GET',
    headers: authHeaders(false),
  });
  const j = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(j.message || `获取 pages 失败 (${res.status})`);
  const pages = Array.isArray(j.pages) && j.pages.length ? j.pages : [{ content: { ops: [] } }];
  return pages;
}

// 保存单页：PATCH /:id/pages/:pageIndex
async function saveOnePage(workId, pageIndex, content, title) {
  const res = await fetch(`${API_BASE_URL}/${workId}/pages/${pageIndex}`, {
    method: 'PATCH',
    headers: authHeaders(true),
    body: JSON.stringify({ content, title }),
  });
  const j = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(j.message || `保存单页失败 (${res.status})`);
  return true;
}

// 新增页：POST /:id/pages
async function createPage(workId) {
  const res = await fetch(`${API_BASE_URL}/${workId}/pages`, {
    method: 'POST',
    headers: authHeaders(true),
    body: JSON.stringify({}),
  });
  const j = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(j.message || `新增页失败 (${res.status})`);
  return j.index; // 后端返回 { index }
}

// 删除页：DELETE /:id/pages/:pageIndex
async function deletePage(workId, pageIndex) {
  const res = await fetch(`${API_BASE_URL}/${workId}/pages/${pageIndex}`, {
    method: 'DELETE',
    headers: authHeaders(false),
  });
  const j = await res.json().catch(() => ({}));
  if (!res.ok) throw new Error(j.message || `删除页失败 (${res.status})`);
  return true;
}

      // ... 位于 fetchWorkById 之后或附近

// 位于 fetchWorkById 之后或附近

async function fetchDiceHistory(workId) {
    if (!workId) return [];
    try {
        // 🚀 关键修复：使用 API_BASE_URL (https://api.anchorx.ca/api/works)
        const res = await fetch(`${API_BASE_URL}/${workId}/dice-log`, { headers: authHeaders(false) });
        if (!res.ok) {
            console.error('加载骰子历史失败', res.status);
            return [];
        }
        return await res.json();
    } catch (err) {
        console.error('fetchDiceHistory error', err);
        return [];
    }
}

// 辅助函数：渲染骰子历史列表
function renderDiceHistory(history) {
    diceLogList.innerHTML = '';
    // 注意：历史记录通常是按时间升序或降序返回，这里按降序渲染（最新的在顶）
    history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    history.forEach(log => {
        // 使用 logDiceResult 函数来统一渲染样式
        logDiceResult(log.rollType, log.result, log.rollText, new Date(log.timestamp));
    });
}

// ... 紧接着在 loadWorkById 函数中添加调用（如下）

        /* ---------- 渲染作品列表（事件委托）---------- */
        async function loadWorks() {
            const works = await fetchWorks();
            workList.innerHTML = '';
            if (!works || works.length === 0) {
                workList.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">暂无作品，快来创建吧！</p>';
                workCountSpan.textContent = '0';
                return;
            }
            works.forEach(work => {
                const html = `
                    <div class="work-item-wrapper" data-id="${work._id}">
                        <div class="work-item">
                            <div class="work-info">
                                <div class="work-date">${new Date(work.updatedAt).toLocaleString()}</div>
                                <div class="work-details">
                                    <span class="work-title">${work.title}</span>
                                </div>
                            </div>
   <div class="work-actions-buttons">
  <button class="cover-settings-btn" data-work-id="${work._id}">封面设置</button>
  <button class="tag-settings-btn"
          data-work-id="${work._id}"
          data-work-title="${encodeURIComponent(work.title || '')}">
    作品标签${Array.isArray(work.tags) && work.tags.length ? `(${work.tags.length})` : ''}
  </button>
  <button class="menu-button" data-action="toggle-menu">⋯</button>
</div>
                        </div>
                        <div class="menu-container hidden">
                            <div class="menu-item" data-action="delete-single">刪除</div>
                        </div>
                    </div>
                `;
                workList.insertAdjacentHTML('beforeend', html);
            });
            workCountSpan.textContent = String(works.length);
        }

        // 事件委托：单个作品列表的各类操作
        workList.addEventListener('click', async (e) => {
            const wrapper = e.target.closest('.work-item-wrapper');
            if (!wrapper) return;
            const workId = wrapper.dataset.id;

            // 点击菜单按钮
            if (e.target.closest('.menu-button')) {
                // 切换当前菜单的显示，并隐藏其它菜单
                document.querySelectorAll('.menu-container').forEach(menu => {
                    if (menu !== wrapper.querySelector('.menu-container')) menu.classList.add('hidden');
                });
                const menu = wrapper.querySelector('.menu-container');
                menu.classList.toggle('hidden');
                return;
            }

            // 点击封面设置
            if (e.target.closest('.cover-settings-btn')) {
                showCoverUploadModal(workId);
                return;
            }

          // 点击作品标签
if (e.target.closest('.tag-settings-btn')) {
  const btn = e.target.closest('.tag-settings-btn');
  const title = btn && btn.dataset.workTitle ? decodeURIComponent(btn.dataset.workTitle) : '';
  showTagEditModal(workId, title);
  return;
}

            // 点击菜单里的刪除
            if (e.target.closest('[data-action="delete-single"]')) {
                workToDelete = await fetchWorkById(workId);
                if (!workToDelete) return;
                deleteModal.style.display = 'flex';
                return;
            }

            // 点击作品本体：加载作品到编辑器
            if (e.target.closest('.work-item')) {
                await loadWorkById(workId);
                return;
            }
        });

        // 点击页面空白处，隐藏所有菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.work-item-wrapper')) {
                document.querySelectorAll('.menu-container').forEach(menu => menu.classList.add('hidden'));
            }
        });

        // 刪除确认
        deleteConfirmBtn.addEventListener('click', async () => {
            if (!workToDelete) return;
            const id = workToDelete._id;
            const ok = await deleteWork(id);
            if (ok) {
                deleteModal.style.display = 'none';
                await loadWorks();
            }
        });
        deleteCancelBtn.addEventListener('click', () => deleteModal.style.display = 'none');

        /* ---------- 批量刪除 ---------- */
        bulkDeleteBtn.addEventListener('click', async () => {
            const works = await fetchWorks();
            if (!works || works.length === 0) {
                alert('没有作品可以刪除。');
                return;
            }
            bulkDeleteList.innerHTML = '';
            works.forEach(w => {
                const div = document.createElement('div');
                div.className = 'delete-item';
                div.innerHTML = `<input type="checkbox" id="work-${w._id}" value="${w._id}"><label for="work-${w._id}">${w.title}</label>`;
                bulkDeleteList.appendChild(div);
            });
            bulkDeleteModal.style.display = 'flex';
        });
        bulkDeleteCancelBtn.addEventListener('click', () => bulkDeleteModal.style.display = 'none');
        bulkDeleteConfirmBtn.addEventListener('click', async () => {
            const checked = bulkDeleteList.querySelectorAll('input[type="checkbox"]:checked');
            const ids = Array.from(checked).map(cb => cb.value);
            if (ids.length === 0) { alert('请至少選擇一个作品刪除。'); return; }
            if (!confirm(`确定刪除 ${ids.length} 个作品？此操作不可恢复。`)) return;
            let count = 0;
            for (const id of ids) {
                const ok = await deleteWork(id);
                if (ok) count++;
            }
            alert(`已刪除 ${count} 个作品。`);
            bulkDeleteModal.style.display = 'none';
            await loadWorks();
        });

        /* ---------- 新建作品弹窗 ---------- */
        createBtn.addEventListener('click', () => {
            createModal.style.display = 'flex';
            workTitleInput.value = '';
            createMessage.textContent = '';
            workTitleInput.focus();
        });
        cancelBtn.addEventListener('click', () => createModal.style.display = 'none');

        confirmBtn.addEventListener('click', async () => {
            const title = workTitleInput.value.trim();
            if (!title) { createMessage.textContent = '作品名称不能为空！'; return; }
            createMessage.textContent = '';
            const newWork = await createWork(title);
            if (newWork) {
                createModal.style.display = 'none';
                // 立即进入编辑器并加载（后端返回的 newWork）
                await loadWorkById(newWork._id);
            }
        });

        /* ---------- 切换到编辑器（设置状态）---------- */
        async function switchToEditor(work) {

  if (work && work.isPublished) {
        // 作品已发布：按钮显示“已发布”并禁用
        publishBtn.textContent = '已发布'; // 【修改点1：如果已发布，显示“已发布”】
        publishBtn.disabled = true;         // 【修改点2：如果已发布，禁用按钮】
    } else {
        // 作品未发布：按钮显示“发布”并启用
        publishBtn.textContent = '发布';
        publishBtn.disabled = false;        // 【修改点3：如果未发布，确保按钮可用】
    }

            mainPage.classList.add('hidden');
            editorPage.classList.remove('hidden');
            if (work && work.title) {
                editorTitle.textContent = `正在编辑：${work.title}`;
            } else {
                editorTitle.textContent = '正在编辑：未命名作品';
            }
            currentWorkId = work && work._id ? work._id : null;

            roles = await fetchRoles(currentWorkId);
            renderRoles();

            // 显示 Quill
            isQuillActive = true;
            quillEditor.classList.remove('hidden');
            plainEditor.classList.add('hidden');
        
            sidebar.classList.add('sidebar-collapsed');
        }


/* ---------- 载入单个作品（并初始化 pages）---------- */
/* ---------- 载入单个作品（并初始化 pages）---------- */
async function loadWorkById(id) {
  const work = await fetchWorkById(id);
  if (!work) return;

  // ✅ 加在这里：缓存当前作品的存储模式（separate / embedded）
  currentWorkPageStorage = work?.pageStorage || null;

  let loadedPages = [{ content: { ops: [] } }];
  try {
    loadedPages = await fetchWorkPagesForEditor(id);
  } catch (e) {
    console.warn('fetchWorkPagesForEditor failed, fallback to work.pages/content', e);
    if (Array.isArray(work.pages) && work.pages.length) loadedPages = work.pages;
    else if (Array.isArray(work.content) && work.content.length) loadedPages = work.content;
  }

  pages = loadedPages;
  currentPageIndex = 0;

  pageHistories = {};
  if (quill.history) quill.history.clear();

  await switchToEditor(work);

  const wasAutoSave = autoSaveEnabled;
  autoSaveEnabled = false;

  const diceHistory = await fetchDiceHistory(id);
  renderDiceHistory(diceHistory);

  try {
    const firstPageContent = pages[0]?.content || { ops: [] };
    quill.setContents(firstPageContent, 'silent');
  } catch (err) {
    console.warn('quill.setContents failed', err);
    quill.setContents({ ops: [] }, 'silent');
  }

  updatePageDisplay();
  renderPageList();

  setTimeout(() => {
    autoSaveEnabled = wasAutoSave;
    startAutoSave();
  }, 100);
}


      /* ---------- 保存作品的核心逻辑 (返回是否成功) ---------- */
/* ---------- 保存作品的核心逻辑 ---------- */
// 可选：缓存一下当前作品的 pageStorage，减少重复请求
let currentWorkPageStorage = null;

// ✅ 小工具：确保作品是 separate（否则单页保存一定失败）
async function ensureWorkIsSeparate(workId) {
  // 如果你在 loadWorkById 已经拿到 work.pageStorage，可以在那里赋值 currentWorkPageStorage
  if (currentWorkPageStorage === 'separate') return true;

  try {
    const w = await fetchWorkById(workId); // 你已有的函数
    currentWorkPageStorage = w?.pageStorage || null;
    return currentWorkPageStorage === 'separate';
  } catch (e) {
    console.warn('ensureWorkIsSeparate failed:', e);
    return false;
  }
}

/* ---------- 保存作品的核心逻辑 ---------- */
/* 只做：保存当前页 +（可选）保存 meta，绝不带 pages/content ---------- */
async function performSave({ isAuto = false } = {}) {
  if (!currentWorkId) return false;

  // 1) 同步当前页内容到 pages[currentPageIndex]
  if (!pages || !pages[currentPageIndex]) {
    pages = [{ content: { ops: [] } }];
    currentPageIndex = 0;
  }

  if (isQuillActive) {
    pages[currentPageIndex].content = quill.getContents();
  } else {
    const lines = plainEditor.value.split('\n');
    pages[currentPageIndex].content = { ops: lines.map(line => ({ insert: line + '\n' })) };
  }

  const title = editorTitle.textContent.replace('正在编辑：', '').trim();
  const currentContent = pages[currentPageIndex]?.content || { ops: [] };

  try {
    isSaving = true;

    // ✅ 2) 只保存“当前页”（让后端判断是否已迁移）
    await saveOnePage(currentWorkId, currentPageIndex, currentContent, title);

    // ✅ 3) 可选：保存 meta（绝不包含 pages/content）
    const meta = {};
    if (typeof effectsDraft !== 'undefined') meta.effectsDraft = effectsDraft;
    if (typeof effectsPublished !== 'undefined') meta.effectsPublished = effectsPublished;
    if (typeof backgroundDraft !== 'undefined') meta.backgroundDraft = backgroundDraft;
    if (typeof backgroundPublished !== 'undefined') meta.backgroundPublished = backgroundPublished;

    if (Object.keys(meta).length) {
      const res2 = await fetch(`${API_BASE_URL}/${currentWorkId}`, {
        method: 'PATCH',
        headers: authHeaders(true),
        body: JSON.stringify(meta),
      });
      const j2 = await res2.json().catch(() => ({}));
      if (!res2.ok) throw new Error(j2.message || `保存特效/背景失败 (${res2.status})`);
    }

    return true;
  } catch (err) {
    console.error('保存失败:', err);
    if (!isAuto) {
      // 这里的 err.message 就会是后端真实返回的原因（比如确实没迁移）
      alert('保存失败：' + (err.message || '网络错误'));
    }
    return false;
  } finally {
    isSaving = false;
  }
}


/* ---------- 保存作品（自动/手动）---------- */
async function saveWork(isAuto = false) {
  if (!currentWorkId) {
    if (!isAuto) alert('请先保存或创建作品。');
    return false;
  }

  // 手动保存时显示“正在保存...”
  if (!isAuto) saveBtn.textContent = '正在保存...';

  const success = await performSave({ isAuto });

  if (success) {
    saveBtn.textContent = '已保存';
    hasUnsavedChanges = false;
    addHistoryRecord(isAuto ? '自动保存' : '手动保存');

    setTimeout(() => {
      saveBtn.textContent = hasUnsavedChanges ? '保存*' : '保存';
    }, 1500);
  } else {
    if (!isAuto) {
      saveBtn.textContent = '保存失败';
      setTimeout(() => (saveBtn.textContent = '保存'), 1500);
    }
  }

  return success;
}

/* =========================
   ✅ Word(.docx) 导出：工具函数
   依赖：html-docx-js（全局 htmlDocx）
========================= */

// 复用下载逻辑
function downloadBlob(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// 离屏 Quill：用来把 Delta 渲染成 HTML（尽量保留格式）
let __exportQuill = null;
function ensureExportQuill() {
  if (__exportQuill) return __exportQuill;

  const holder = document.createElement('div');
  holder.id = '__export_quill_holder__';
  holder.style.position = 'fixed';
  holder.style.left = '-100000px';
  holder.style.top = '-100000px';
  holder.style.width = '800px';
  holder.style.height = '1px';
  holder.style.overflow = 'hidden';
  holder.style.opacity = '0';
  document.body.appendChild(holder);

  __exportQuill = new Quill(holder, { readOnly: true, theme: 'snow' });
  return __exportQuill;
}

function deltaToHtml(delta) {
  const q = ensureExportQuill();
  const safeDelta = delta && delta.ops ? delta : { ops: [{ insert: '\n' }] };
  q.setContents(safeDelta);
  return q.root.innerHTML || '';
}

function buildDocxHtmlFromBackup(backupData) {
  const title = (backupData?.meta?.title || '未命名作品').toString();
  const exportedAt = backupData?.meta?.exportedAt || new Date().toISOString();
  const pages = Array.isArray(backupData?.pages) ? backupData.pages : [];

  // 注意：Word 对 CSS 支持有限，这里只用最基础的结构
  let body = `
    <h1>${escapeHtml(title)}</h1>
    <p>导出时间：${escapeHtml(exportedAt)}</p>
    <hr/>
  `;

  pages.forEach((p, idx) => {
    const delta = p?.content || p; // 兼容你 pages 结构：每项至少有 content（:contentReference[oaicite:10]{index=10}）
    const pageHtml = deltaToHtml(delta);

    body += `
      <h2>第 ${idx + 1} 页</h2>
      ${pageHtml}
      <br style="page-break-after: always;" />
    `;
  });

  return `<!doctype html><html><head><meta charset="utf-8"></head><body>${body}</body></html>`;
}

function exportBackupAsDocx(backupData, safeTitle) {
  if (!window.htmlDocx || typeof window.htmlDocx.asBlob !== 'function') {
    alert('缺少 Word 导出库：请确认已在页面引入 html-docx-js。');
    return;
  }

  const html = buildDocxHtmlFromBackup(backupData);

  // README 推荐：htmlDocx.asBlob(html) 生成 Blob :contentReference[oaicite:11]{index=11}
  const docxBlob = window.htmlDocx.asBlob(html);

  const fname = `${safeTitle}_本地备份_${new Date().toISOString().slice(0,10)}.docx`;
  downloadBlob(docxBlob, fname);
}

      
/* ---------- 新增：导出所有楼层到本地 JSON ---------- */
async function downloadLocalBackup() {
    if (!currentWorkId) {
        alert('没找到需要保存的对象。请先保存或创建作品，再导出到本地。');
        return;
    }

    // 1️⃣ 先把当前页的内容写回 pages（和 performSave 里的逻辑保持一致）
    if (isQuillActive) {
        pages[currentPageIndex].content = quill.getContents();
    } else {
        const lines = plainEditor.value.split('\n');
        const ops = lines.map(line => ({ insert: line + '\n' }));
        pages[currentPageIndex].content = { ops };
    }

    // 2️⃣ 从后端再拿一次作品，主要是拿特效字段（effectsDraft / effectsPublished）
    let effectsDraft = [];
    let effectsPublished = [];
    try {
        const work = await fetchWorkById(currentWorkId);
        if (work) {
            if (Array.isArray(work.effectsDraft)) {
                effectsDraft = work.effectsDraft;
            }
            if (Array.isArray(work.effectsPublished)) {
                effectsPublished = work.effectsPublished;
            }
        }
    } catch (err) {
        console.error('获取作品特效失败（导出时忽略）：', err);
        // 即使失败也继续导出页面内容
    }

    // 3️⃣ 组装备份数据
    const backupData = {
        meta: {
            workId: currentWorkId,
            title: editorTitle.textContent.replace('正在编辑：', ''),
            exportedAt: new Date().toISOString(),
            source: 'AnchorX-write-local-backup-v1'
        },
        // 所有楼层内容：这里是 Quill 的 Delta，保留了颜色、加粗、标题等样式
        pages: pages,
        // 角色信息
        roles: roles,
        // 特效信息：以“代码格式”（JSON）保留下来
        effectsDraft: effectsDraft,
        effectsPublished: effectsPublished
    };

    // 4️⃣ 转成 JSON 文件并触发浏览器下载
    const jsonStr = JSON.stringify(backupData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    const rawTitle = backupData.meta.title || '未命名作品';
    const safeTitle = rawTitle.replace(/[\\/:*?"<>|]/g, '_');
    a.href = url;
    a.download = `${safeTitle}_本地备份_${new Date().toISOString().slice(0,10)}.json`;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

  // ✅ 新增：可选同时导出 Word(.docx)
if (confirm('同时导出 Word(.docx) 吗？')) {
  exportBackupAsDocx(backupData, safeTitle);
  addHistoryRecord('导出本地备份（DOCX）');
}
  
    // 可选：记一条历史记录
    addHistoryRecord('导出本地备份');
}

        saveBtn.addEventListener('click', (e) => {
  e.preventDefault();
  saveWork(false);
});


// ✅ 新增：给“保存到本地”按钮绑定点击事件
if (localSaveBtn) {
    localSaveBtn.addEventListener('click', () => {
        console.log('▶ 点击了【保存到本地】按钮');
        downloadLocalBackup();
    });
}

        // 转义 HTML（防止注入）
        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, function (m) { return map[m]; });
        }

          // 显示图库大图预览
    function showGalleryPreview(src, altText) {
        if (!galleryPreviewOverlay || !galleryPreviewImage) return;
        galleryPreviewImage.src = src;
        galleryPreviewImage.alt = altText || '';
        galleryPreviewOverlay.classList.add('open');
    }

    function hideGalleryPreview() {
        if (!galleryPreviewOverlay) return;
        galleryPreviewOverlay.classList.remove('open');
    }

    if (galleryPreviewClose && galleryPreviewOverlay) {
        galleryPreviewClose.addEventListener('click', hideGalleryPreview);

        // 点击遮罩空白区域也关闭
        galleryPreviewOverlay.addEventListener('click', (e) => {
            if (e.target === galleryPreviewOverlay) {
                hideGalleryPreview();
            }
        });
    }

/* ---------- 修复：history 序列化/反序列化（防止 delta.invert 丢失） ---------- */
const Delta = Quill.import('delta');

function _toOps(deltaLike) {
  if (!deltaLike) return [];
  if (Array.isArray(deltaLike)) return deltaLike;              // 直接就是 ops 数组
  if (Array.isArray(deltaLike.ops)) return deltaLike.ops;      // Delta 或 {ops:[]}
  return [];
}

function serializeHistoryStack(stack) {
  const pack = (list) => (Array.isArray(list) ? list : []).map(item => ({
    // 只存 ops，避免丢失 Delta 原型方法
    deltaOps: _toOps(item && item.delta),
    range: item && item.range ? { index: item.range.index, length: item.range.length } : null,
  }));
  return { undo: pack(stack && stack.undo), redo: pack(stack && stack.redo) };
}

function deserializeHistoryStack(saved) {
  const unpack = (list) => (Array.isArray(list) ? list : []).map(item => {
    // 兼容你旧的 JSON.stringify 版本：{ delta: { ops:[...] }, range:... }
    const ops = (item && item.deltaOps) || _toOps(item && item.delta) || [];
    return {
      delta: new Delta(ops),
      range: item && item.range ? { index: item.range.index, length: item.range.length } : null,
    };
  });
  return { undo: unpack(saved && saved.undo), redo: unpack(saved && saved.redo) };
}
      
/* ---------- 发布（手动保存 + 禁用按钮）---------- */
publishBtn.addEventListener('click', async () => {
    if (!currentWorkId) {
        alert('请先保存作品。');
        return;
    }
    
    // 记录当前按钮的文本（“发布”或“更新*”或“已发布”）
    const originalText = publishBtn.textContent;
    // 判断当前是否是已发布的作品（即按钮显示“更新*”或“已发布”的情况）
    const isCurrentlyPublished = originalText.startsWith('更新') || originalText === '已发布';

    // 1. 【新增：先将按钮禁用，防止重复点击】
    publishBtn.textContent = '处理中...'; // 统一显示处理中
    publishBtn.disabled = true; 

    // 2. 【保留：先执行手动保存逻辑】
    const saveSuccess = await saveWork(false); 

    if (saveSuccess) {
        
        // 3. 【新增：调用 PATCH API 将后端发布状态变为 true】
        try {
            const res = await fetch(`${API_BASE_URL}/${currentWorkId}/publish`, {
  method: 'PATCH',
  headers: authHeaders(true),
  body: JSON.stringify({ isPublished: true })
});
            
            if (!res.ok) {
                const j = await res.json();
                throw new Error(j.message || '发布状态更新失败');
            }
            
            // 4. 【成功后更新按钮状态为“已发布”并保持禁用】
            publishBtn.textContent = '已发布'; 
            publishBtn.disabled = true; 
            
            alert(isCurrentlyPublished ? '作品已更新成功！' : '作品已成功发布！');
            addHistoryRecord(isCurrentlyPublished ? '更新' : '发布');

            // 移除页面跳转逻辑
            // window.location.href = `https://zhidianworld.com/read/?id=${currentWorkId}`; 

        } catch (err) {
            console.error('发布/更新失败', err);
            alert('发布/更新失败：' + (err.message || '网络错误（请在讨论页/贴吧汇报给站长！你将会收获一份诚心诚意土下座大礼包以及修复方案）'));
            
            // 失败时恢复按钮状态
            publishBtn.textContent = isCurrentlyPublished ? '更新失败' : '发布失败';
            // 恢复按钮可用性
            publishBtn.disabled = false; 
            setTimeout(() => {
                // 恢复到上次的“更新”或“发布”状态
                publishBtn.textContent = isCurrentlyPublished ? '更新*' : '发布'; 
            }, 2000);
        }
    } else {
        // 如果 saveWork 失败，它已经弹窗提醒了用户
        // 恢复按钮状态
        publishBtn.textContent = originalText;
        publishBtn.disabled = false;
    }
});

// ✅ 删页：用新接口，不要再 PATCH /works/:id 带 pages/content
async function deleteCurrentPage() {
  if (!currentWorkId) return;
  const deleteIndex = currentPageIndex;

  // 先停自动保存（可选但推荐）
  const wasAutoSave = autoSaveEnabled;
  autoSaveEnabled = false;

  try {
    // 1) 后端删页（会自动把后面页 index -1，并更新 pageCount/wordCount）
    const r = await fetch(`${API_BASE_URL}/${currentWorkId}/pages/${deleteIndex}`, {
      method: 'DELETE',
      headers: authHeaders(true),
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j.message || `删除页失败 (${r.status})`);

    // 2) 前端本地同步（把当前 pages 数组也删一页）
    pages.splice(deleteIndex, 1);
    if (pages.length === 0) pages = [{ content: { ops: [] } }];

    currentPageIndex = Math.min(deleteIndex, pages.length - 1);

    // 3) 切到新当前页
    const nextContent = pages[currentPageIndex]?.content || { ops: [] };
    quill.setContents(nextContent, 'silent');

    // 4) UI
    renderPageList();
    updatePageDisplay();

  } catch (e) {
    console.error('删除页面失败:', e);
    alert('删除失败：' + (e.message || '网络错误'));
  } finally {
    autoSaveEnabled = wasAutoSave;
    if (autoSaveEnabled) startAutoSave();
  }
}


        /* ---------- 页码管理（统一使用 pages 与 currentPageIndex）---------- */
        function updatePageDisplay() {
            // 把当前页和总页数写回 DOM（你页面里有 currentPage span）
            if (currentPageSpan) {
                currentPageSpan.textContent = String(currentPageIndex + 1);
            }
        }

        function renderPageList() {
            pageList.innerHTML = '';
            pages.forEach((p, idx) => {
                const li = document.createElement('li');
                li.textContent = `第 ${idx + 1} 页`;
                li.dataset.pageIndex = String(idx);
                if (idx === currentPageIndex) li.classList.add('active');
                li.addEventListener('click', () => {
                    goToPage(idx);
                    pageDropdown.classList.add('hidden');
                });
                pageList.appendChild(li);
            });
        }

        pageCurrentDisplay.addEventListener('click', () => {
            pageDropdown.classList.toggle('hidden');
            renderPageList();
        });

deletePageBtn.addEventListener('click', deleteCurrentPage);

addPageBtn.addEventListener('click', async () => {
  if (!currentWorkId) return;

  const wasAutoSave = autoSaveEnabled;
  autoSaveEnabled = false;

  try {
    // 先把当前页内容落到 pages[currentPageIndex]
    pages[currentPageIndex].content = quill.getContents();

    const r = await fetch(`${API_BASE_URL}/${currentWorkId}/pages`, {
      method: 'POST',
      headers: authHeaders(true),
      body: JSON.stringify({}), // 后端不需要内容，默认空页
    });
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j.message || `新增页失败 (${r.status})`);

    const newIndex = j.index;           // 后端返回的新页 index
    pages[newIndex] = { content: { ops: [] } };
    currentPageIndex = newIndex;

    quill.setContents({ ops: [] }, 'silent');
    renderPageList();
    updatePageDisplay();
  } catch (e) {
    console.error(e);
    alert('新增页失败：' + (e.message || '网络错误'));
  } finally {
    autoSaveEnabled = wasAutoSave;
    if (autoSaveEnabled) startAutoSave();
  }
});



        /* ---------- 切换页码（带历史记录隔离）---------- */
function goToPage(index) {
    if (index < 0 || index >= pages.length || index === currentPageIndex) return;

    // 1. 暂停自动保存，防止切页过程中的状态混乱
    const wasAutoSave = autoSaveEnabled;
    autoSaveEnabled = false;

    // 2. 【保存旧页】：保存当前页内容
    pages[currentPageIndex].content = quill.getContents();

    // ✅【关键：保存旧页的历史记录】
    // Quill 的 history 模块包含 stack（undo/redo 栈）
    if (quill.history) {
        // 深拷贝 stack 以防引用被修改
        pageHistories[currentPageIndex] = serializeHistoryStack(quill.history.stack);
    }

    // 3. 【切换索引】
    currentPageIndex = index;

    // 4. 【加载新页内容】
    const nextContent = pages[currentPageIndex]?.content || { ops: [] };
    // 使用 'silent' 避免触发 user 来源的 change 事件
    quill.setContents(nextContent, 'silent');

    // 5. ✅【关键：恢复新页的历史记录】
    if (quill.history) {
        quill.history.clear();
if (pageHistories[currentPageIndex]) {
  quill.history.stack = deserializeHistoryStack(pageHistories[currentPageIndex]);
} else {
  quill.history.stack = { undo: [], redo: [] };
}

        // 如果没有存过（第一次点开这一页），history 就是空的，这是对的
    }

    // 6. 更新 UI
    updatePageDisplay();
    renderPageList();
    pageDropdown.classList.add('hidden'); // 顺手关掉下拉菜单

    // 7. 恢复自动保存
    setTimeout(() => {
        autoSaveEnabled = wasAutoSave;
    }, 50);
}

        /* ---------- 骰子（随机）---------- */
        // 2. 切换骰子记录的显示/隐藏状态 (使用现有下拉菜单的逻辑) 
        if (diceLogDropdownHeader) {
            diceLogDropdownHeader.addEventListener('click', () => {
                diceLogDropdownContent.classList.toggle('open');
            });
        }

 /* ---------- 骰子（随机）---------- */
// 核心逻辑：获取 N, 掷骰, 插入编辑器, 记录到后端和前端列表
async function rollDiceLogic() {
    const max = prompt("请输入骰子的最大值 (1到1000):");
    if (max === null) return;
    const maxNum = parseInt(max, 10);
    if (isNaN(maxNum) || maxNum < 1 || maxNum > 1000) {
        alert('请输入 1 到 1000 的整数');
        return;
    }

    const result = Math.floor(Math.random() * maxNum) + 1;
    const diceType = `1D${maxNum}`;
    const rollResultText = `【${diceType}=${result}】`;

    // 1. 插入结果到 Quill 编辑器
    const range = quill.getSelection(true);
    if (range) {
        quill.insertText(range.index, rollResultText + ' ');
        quill.setSelection(range.index + rollResultText.length + 1, 0);
    } else {
        quill.insertText(quill.getLength(), rollResultText);
        quill.setSelection(quill.getLength(), 0);
    }

    // 2. 本地记录（添加到下拉列表）
    logDiceResult(diceType, result, rollResultText, new Date());

    // 3. 调用后端 API 记录
    if (currentWorkId) {
        try {
            const data = {
  rollType: diceType,
  result: result,
  rollText: rollResultText
};

await fetch(`${API_BASE_URL}/${currentWorkId}/dice-log`, {
  method: 'POST',
  headers: authHeaders(true),
  body: JSON.stringify(data)
});


        } catch (error) {
            console.error('记录骰子结果到后端失败:', error);
        }
    } else {
        console.warn('未加载作品，跳过后端骰子记录。');
    }
}

// 2. 切换骰子记录的显示/隐藏状态 (使用现有下拉菜单的逻辑) 
if (diceLogDropdownHeader) {
    diceLogDropdownHeader.addEventListener('click', () => {
        diceLogDropdownContent.classList.toggle('open');
    });
}

// 3. 绑定骰子按钮点击事件 (现在调用整合后的核心逻辑)
if (diceBtn) {
    diceBtn.addEventListener('click', rollDiceLogic);
}

// (logDiceResult 函数保留在下方，无需修改)
// ...

        function logDiceResult(type, result, resultText, date) {
            const now = date || new Date(); // 使用传入的时间或当前时间
            // 格式化时间为 HH:mm:ss
            const timeString = now.toTimeString().split(' ')[0];

            const logItem = document.createElement('li');
            logItem.classList.add('role-item');
            logItem.style.padding = '8px 10px';
            logItem.style.borderBottom = '1px dashed #eee';
            logItem.style.cursor = 'default';

            logItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                    <span style="font-weight: bold; color: #0077cc;">${result}</span>
                    <span style="color: #666; font-size: 0.8rem;">${timeString}</span>
                </div>
                <div style="font-size: 0.8rem; color: #999; margin-top: 3px;">
                    掷骰类型: ${type}
                </div>
            `;

            // 将新记录添加到列表顶部 (最新记录在最上)
            if (diceLogList) {
                if (diceLogList.firstChild) {
                    diceLogList.insertBefore(logItem, diceLogList.firstChild);
                } else {
                    diceLogList.appendChild(logItem);
                }
            }
        }

        /* ---------------------------------------------------- */
        /* ---------- END: 骰子记录功能 (Dice Log) ---------- */
        /* ---------------------------------------------------- */

  /* ---------- L10 列表按鈕 ---------- */
listBtn.addEventListener('click', () => {
    // 插入一个从1到10的有序列表
    const listItems = Array.from({ length: 10 }, (_, i) => `${i + 1}. `).join('\n');
    const range = quill.getSelection();
    
    // 如果有選取範圍，將內容插入到選取位置
    if (range) {
        quill.insertText(range.index, listItems);
    } else {
        // 如果沒有選取範圍，將內容插入到編輯器結尾
        quill.insertText(quill.getLength(), listItems);
    }
});

      /* ---------- 2. 新增按钮逻辑 ---------- */

// 2.1 主题切换标记插入逻辑
// 假设您在 HTML 工具栏中添加了一个 ID 为 'insertThemeTriggerBtn' 的按钮
const insertThemeTriggerBtn = document.getElementById('insertThemeTriggerBtn');

if (insertThemeTriggerBtn) {
    insertThemeTriggerBtn.addEventListener('click', () => {
        const themeName = prompt("请输入要切换的主题名称 (例如: night-mode, chapter-2-theme):");
        if (!themeName) return;

        const range = quill.getSelection(true);
        if (range) {
            // 插入自定义 Block Embed Blot
            quill.insertEmbed(range.index, 'themeTrigger', themeName, Quill.sources.USER);
            quill.setSelection(range.index + 1, 0); // 移动光标到标记后
        }
    });
}

    /* ---------- 右侧栏切换 ---------- */
    if (rightSidebarToggle && rightSidebar) {
        rightSidebarToggle.addEventListener('click', () => rightSidebar.classList.toggle('collapsed'));
    }

    /* ---------- 角色相关：fetch/add/update/delete & render ---------- */
    async function fetchRoles(workId) {
        if (!workId) return [];
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles`, { headers: authHeaders(false) });
            if (!res.ok) {
                console.warn('fetchRoles failed', res.status);
                return [];
            }
            return await res.json();
        } catch (err) {
            console.error('fetchRoles error', err);
            return [];
        }
    }

    async function addRole(workId, roleData) {
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles`, {
                method: 'POST', headers: authHeaders(true), body: JSON.stringify(roleData)
            });
            if (!res.ok) throw new Error('addRole failed');
            return await res.json();
        } catch (err) {
            console.error('addRole error', err);
            return null;
        }
    }

    async function updateRole(workId, roleId, roleData) {
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles/${roleId}`, {
                method: 'PUT', headers: authHeaders(true), body: JSON.stringify(roleData)
            });
            if (!res.ok) throw new Error('updateRole failed');
            return await res.json();
        } catch (err) {
            console.error('updateRole error', err);
            return null;
        }
    }

    async function deleteRole(workId, roleId) {
        try {
            const res = await fetch(`${API_BASE_URL}/${workId}/roles/${roleId}`, {
                method: 'DELETE', headers: authHeaders(false)
            });
            return res.ok;
        } catch (err) {
            console.error('deleteRole error', err);
            return false;
        }
    }

    // 渲染角色列表（并绑定编辑/刪除/選擇事件）
    function renderRoles() {
        roleList.innerHTML = '';
        roles.forEach(role => {
            const li = document.createElement('li');
            li.className = 'role-item';
            li.innerHTML = `
                <div class="role-title-wrapper" data-role-id="${role._id}">
                    <span class="role-select-btn" data-color="${role.color}" title="选择角色"></span>
                    <div class="role-title">
                        <span class="color-dot" style="background-color: ${role.color};"></span>
                        ${escapeHtml(role.name)}
                    </div>
                    <div class="role-actions">
                        <span class="edit-btn" style="cursor:pointer;color:#0077cc;">编辑</span>
                        <span class="role-gallery-btn" data-role-id="${role._id}">显示绑定图库</span>
                        <span class="delete-btn" style="cursor:pointer;color:#dc3545;margin-left:8px;">刪除</span>
                    </div>
                </div>
                <div class="role-item-notes">${escapeHtml(role.notes || '')}</div>
            `;
            // 展开备注
            li.querySelector('.role-title-wrapper').addEventListener('click', (e) => {
                if (e.target.closest('.role-actions') || e.target.closest('.role-select-btn')) return;
                const notes = li.querySelector('.role-item-notes');
                notes.classList.toggle('open');
            });
            // 编辑
            li.querySelector('.edit-btn').addEventListener('click', () => {
                currentEditRoleId = role._id;
                roleModal.querySelector('h3').textContent = '编辑角色';
                roleNameInput.value = role.name || '';
                roleNotesTextarea.value = role.notes || '';
                roleColorPicker.value = role.color || '#000000';
                roleModal.style.display = 'block';
            });
            // 刪除
            li.querySelector('.delete-btn').addEventListener('click', async () => {
                if (!confirm(`确定刪除角色 "${role.name}" 吗？`)) return;
                const ok = await deleteRole(currentWorkId, role._id);
                if (ok) {
                    roles = roles.filter(r => r._id !== role._id);
                    renderRoles();
                } else alert('刪除失败');
            });
            // 選擇按钮
            const selectBtn = li.querySelector('.role-select-btn');
            selectBtn.addEventListener('click', () => {
                const wasActive = selectBtn.classList.contains('active');
                // 清除所有
                document.querySelectorAll('.role-select-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.role-item').forEach(it => it.classList.remove('selected'));
                if (!wasActive) {
                    selectBtn.classList.add('active');
                    li.classList.add('selected');
                    selectedRoleColor = selectBtn.dataset.color;
                    // 把颜色应用到 quill 的后续輸入
                    quill.format('color', selectedRoleColor);
                } else {
                    // 取消選擇
                    selectedRoleColor = null;
                    quill.format('color', false);
                }
            });

            // 如果当前颜色和 selectedRoleColor 一致，标记
            if (selectedRoleColor && selectedRoleColor === role.color) {
                selectBtn.classList.add('active');
                li.classList.add('selected');
            }


            roleList.appendChild(li);
        });
    }

    // 打开角色 modal
    addRoleBtn.addEventListener('click', () => {
        currentEditRoleId = null;
        roleModal.querySelector('h3').textContent = '添加角色';
        roleNameInput.value = '';
        roleNotesTextarea.value = '';
        roleColorPicker.value = '#000000';
        roleModal.style.display = 'block';
    });

    cancelRoleBtn.addEventListener('click', () => roleModal.style.display = 'none');

    confirmRoleBtn.addEventListener('click', async () => {
        const name = roleNameInput.value.trim();
        if (!name) { alert('角色名不能为空'); return; }
        const roleData = { name: name, notes: roleNotesTextarea.value.trim(), color: roleColorPicker.value };
        let result = null;
        if (currentEditRoleId) {
            result = await updateRole(currentWorkId, currentEditRoleId, roleData);
            if (result) {
                roles = roles.map(r => r._id === currentEditRoleId ? result : r);
            }
        } else {
            result = await addRole(currentWorkId, roleData);
            if (result) roles.push(result);
        }
        if (result) {
            renderRoles();
            roleModal.style.display = 'none';
            alert('角色操作成功');
        } else {
            alert('角色操作失败');
        }
    });

    roleDropdownHeader.addEventListener('click', () => {
        roleDropdownContent.classList.toggle('open');
        roleDropdownHeader.classList.toggle('open');
    });

  // 从 URL 中简单提取一个“文件名”当作预览名称
function getImageNameFromUrl(url) {
    try {
        const withoutQuery = url.split('?')[0];
        const parts = withoutQuery.split('/');
        return parts[parts.length - 1] || '未命名';
    } catch (e) {
        return '未命名';
    }
}

// 替换原来的 renderGalleryImages
function renderGalleryImages() {
    // 清空现有图片，保留上传按钮
    galleryImageList.querySelectorAll('.gallery-image-item').forEach(item => item.remove());
    
    galleryImages.forEach((imageUrl, idx) => {
        const imgItem = document.createElement('div');
        imgItem.className = 'gallery-image-item';

        const displayName = getImageNameFromUrl(imageUrl) || `图片 ${idx + 1}`;

                imgItem.innerHTML = `
            <div class="thumb-wrapper">
                <img src="${imageUrl}" alt="${escapeHtml(displayName)}">
            </div>
            <div class="img-name">${escapeHtml(displayName)}</div>
            <span class="expand-btn" title="放大预览">⤢</span>
            <span class="delete-btn">×</span>
        `;

        galleryImageList.prepend(imgItem);
    });
}


    // 图片上传事件监听
// 图片上传事件监听 (新版本，已加入压缩)
imageUploadInput.addEventListener('change', async (e) => {
    const files = e.target.files;
    if (files.length === 0) return;

    // 为了显示上传状态，可以添加一个加载指示器
    // showLoadingIndicator(); 

    for (const file of files) {
        try {
            // 定义压缩选项
            const options = {
                maxSizeMB: 0.5, // 最大文件大小，单位MB。如果图片小于这个值，则不压缩。
                maxWidthOrHeight: 1920, // 允许的最大宽度或高度
                useWebWorker: true // 使用 Web Worker，可以避免阻塞主线程
            };

            // 调用压缩函数
            const compressedFile = await imageCompression(file, options);
            console.log('原始文件大小:', (file.size / 1024).toFixed(2), 'KB');
            console.log('压缩后文件大小:', (compressedFile.size / 1024).toFixed(2), 'KB');
            
            // 使用 FormData 来包装压缩后的文件
            const formData = new FormData();
            // 在 append 时提供原始文件名，防止后端存储时丢失文件扩展名
            formData.append('image', compressedFile, file.name); 

            // 发送到后端上传接口
            const res = await fetch(`${API_BASE_URL}/upload`, {
                method: 'POST',
                headers: {
                    // 注意：上传 FormData 时，不要手动设置 'Content-Type'
                    'Authorization': `Bearer ${localStorage.getItem('token')}` 
                },
                body: formData
            });

            if (!res.ok) {
                throw new Error('图片上传失败');
            }

            const result = await res.json();
            
            // 将后端返回的真实 URL 添加到数组
            galleryImages.push(result.imageUrl);

        } catch (err) {
            console.error('上传错误（请在讨论页/贴吧汇报给站长！你将会收获一份诚心诚意土下座大礼包以及修复方案）:', err);
            alert('有图片上传失败，请重试。');
        }
    }

    // 所有图片处理完毕后，重新渲染图库
    renderGalleryImages();
    // hideLoadingIndicator();
});

// 同样，你也可以将压缩逻辑应用到 Quill 的图片上传中
// 找到 uploadFileToImgBB(file) 函数，并在内部调用 imageCompression
async function uploadFileToImgBB(file) {
  try {
    const compressedFile = await imageCompression(file, { maxSizeMB: 0.5, maxWidthOrHeight: 1280 });
    const reader = new FileReader();
    return new Promise((resolve, reject) => {
      reader.onloadend = async () => {
        try {
          // ... (此处保留你原有的 imgbb 上传逻辑，但使用 compressedFile)
          const base64Image = reader.result.split(',')[1];
          const formData = new FormData();
          formData.append('image', base64Image);
          // 仍然直接请求 imgbb，建议改为后端代理
          const response = await fetch('https://api.imgbb.com/1/upload?key=040dbc9e6e680f321e09d9e05f447094', {
              method: 'POST',
              body: formData
          });
          const data = await response.json();
          if (data && data.success) {
              resolve(data.data.url);
          } else {
              reject(new Error('图床上传失败'));
          }
        } catch (err) {
          reject(err);
        }
      };
      reader.readAsDataURL(compressedFile);
    });
  } catch (err) {
    console.error('图片压缩失败或上传到ImgBB失败:', err);
    throw err;
  }
}

// 图片删除 / 展开预览 / 选择插入 事件监听
galleryImageList.addEventListener('click', (e) => {
    const target = e.target;

    // --- 逻辑 0：点击“展开”按钮 → 只预览，不插入编辑器 ---
    if (target.classList.contains('expand-btn')) {
        const item = target.closest('.gallery-image-item');
        const imgEl = item && item.querySelector('img');
        if (imgEl) {
            showGalleryPreview(imgEl.src, imgEl.alt || '');
        }
        return; // 阻止后面继续执行
    }

    // --- 逻辑 1：点击删除按钮 ---
    if (target.classList.contains('delete-btn')) {
        const item = target.closest('.gallery-image-item');
        const imageUrl = item.querySelector('img').src;
        galleryImages = galleryImages.filter(img => img !== imageUrl);
        renderGalleryImages();
    } 
    // --- 逻辑 2：点击图片本身 → 插入到编辑器 ---
    else if (target.tagName === 'IMG') {
        const range = quill.getSelection(true);
        if (range) {
            quill.insertEmbed(range.index, 'image', target.src);
            quill.setSelection(range.index + 1);
            galleryModal.style.display = 'none';
            document.body.classList.remove('modal-active');
        } else {
            alert('请先将光标定位到编辑器中需要插入图片的位置。');
        }
    }
});


    // 取消按钮
    cancelGalleryBtn.addEventListener('click', () => {
        galleryModal.style.display = 'none';
        currentRoleForGallery = null;
      // 新增：关闭弹窗时移除类，重新显示工具栏
        document.body.classList.remove('modal-active');
    });

// 确认按钮 (将图库数据发送到后端)
    confirmGalleryBtn.addEventListener('click', async () => {
        if (!currentRoleForGallery || !currentWorkId) {
            alert('错误（请在讨论页/贴吧汇报给站长！你将会收获一份诚心诚意土下座大礼包以及修复方案）：无法确定当前作品或角色。');
            return;
        }

        try {
            // 获取用户的认证令牌
            const token = localStorage.getItem('token');
            if (!token) {
                alert('请先登录');
                return;
            }

            const roleId = currentRoleForGallery._id;
            const url = `${API_BASE_URL}/${currentWorkId}/roles/${roleId}`; 

          // --- 新增调试代码 ---
    console.log("前端即将发送 PUT 请求:");
    console.log("Work ID:", currentWorkId);
    console.log("Role ID:", roleId);
    console.log("Request URL:", url);
    // --- 调试代码结束 ---
            
            // 构建发送到后端的数据，包含 name, notes, color 和 gallery
            const roleData = {
                name: currentRoleForGallery.name,
                notes: currentRoleForGallery.notes,
                color: currentRoleForGallery.color,
                gallery: galleryImages // 这里的 galleryImages 是我们动态管理图片URL的数组
            };

            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(roleData)
            });

            if (response.ok) {
                const updatedRole = await response.json();
                
                // 将更新后的数据同步到前端的角色对象
                Object.assign(currentRoleForGallery, updatedRole);
                
                alert('图库保存成功！');
                galleryModal.style.display = 'none'; // 关闭弹窗
              // 新增：关闭弹窗时移除类，重新显示工具栏
                document.body.classList.remove('modal-active');
                renderRoles(); // 重新渲染角色列表以确保数据同步
            } else {
                const errorData = await response.json();
                alert(`保存失败：${errorData.message}`);
            }

        } catch (error) {
            console.error('保存图库失败:', error);
            alert('保存图库失败，请检查网络连接或稍后再试。');
        }
    });

      // 自动保存开关按钮
const autoSaveToggleBtn = document.getElementById('autoSaveToggleBtn');

// 默认开启（你的 autoSaveEnabled = true）
autoSaveToggleBtn.textContent = "自动保存：开";
autoSaveToggleBtn.classList.add("autosave-on");

// 点击切换
autoSaveToggleBtn.addEventListener('click', () => {
    autoSaveEnabled = !autoSaveEnabled;

    if (autoSaveEnabled) {
        autoSaveToggleBtn.textContent = "自动保存：开";
        autoSaveToggleBtn.classList.remove("autosave-off");
        autoSaveToggleBtn.classList.add("autosave-on");

        startAutoSave(); // 重新启动自动保存
        console.log("自动保存已开启");
    } else {
        autoSaveToggleBtn.textContent = "自动保存：关";
        autoSaveToggleBtn.classList.remove("autosave-on");
        autoSaveToggleBtn.classList.add("autosave-off");

        // 停止自动保存 interval
        if (autoSaveTimer) clearInterval(autoSaveTimer);

        console.log("自动保存已关闭");
    }
});


    /* ---------- 其它 UI 事件 ---------- */
    // 退出
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('是否退出登录？')) {
                localStorage.removeItem('token');
                window.location.href = 'https://zhidianworld.com/login/';
            }
        });
    }

    // 返回作品列表
    backBtn.addEventListener('click', () => {
        sidebar.classList.remove('sidebar-collapsed');
        editorPage.classList.add('hidden');
        mainPage.classList.remove('hidden');
        currentWorkId = null;
        loadWorks();
    });

    /* ---------- 工具：页面初始载入 ---------- */
    // 首次载入作品列表
    loadWorks();

    /* ---------- 帮助：HTML 转义（安全） ---------- */
    function escapeHtml(text) {
        const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
        return String(text || '').replace(/[&<>"']/g, function(m){ return map[m]; });
    }

  // 正确的事件委托：处理角色列表上的点击事件
    // 此代码块应放在所有函数定义之后，但在 document.addEventListener 内部
    roleList.addEventListener('click', (e) => {
        const target = e.target.closest('span'); // 使用 closest 来确保找到正确的元素
        if (!target) return;
        
        // 处理“显示绑定图库”按钮点击
        if (target.classList.contains('role-gallery-btn')) {
            const roleId = target.dataset.roleId;
            const role = roles.find(r => r._id === roleId);
            if (role) {
                currentRoleForGallery = role;
                galleryImages = role.gallery || [];
                renderGalleryImages();
                // 新增：在显示弹窗前，为 body 添加类以隐藏工具栏
                document.body.classList.add('modal-active');
                galleryModal.style.display = 'flex'; // 显示弹窗
            }
        }
    });

 

}); // end DOMContentLoaded
</script>
</head>
</html>
