<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnchorX é¡µçœ‰</title>
    <style>
        /* -------------------- æ•´ä½“å’Œæ¡Œé¢ç«¯æ ·å¼ -------------------- */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }

        /* ç¬¬ä¸€å±‚é¡µçœ‰ï¼šæ¬¢è¿è¯­å’Œç™»å½•/æ³¨å†ŒæŒ‰é’® */
        .header-top {
            background-color: #0b2452;
            color: white;
            padding: 10px 0;
            display: flex;
            justify-content: center;
        }

        /* ç¬¬äºŒå±‚é¡µçœ‰ï¼šä¸»å¯¼èˆª */
        .header-bottom {
            background-color: #fff;
            padding: 10px 0;
            display: flex;
            justify-content: center;
            border-bottom: 1px solid #ddd;
        }

        /* å±…ä¸­å†…å®¹å®¹å™¨ - ç¬¬ä¸€å±‚é¡µçœ‰ */
        .header-top-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* å±…ä¸­å†…å®¹å®¹å™¨ - ç¬¬äºŒå±‚é¡µçœ‰ */
        .header-bottom-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* æ ¸å¿ƒåŠŸèƒ½å…ƒç´ å®¹å™¨ - å±…ä¸­å¯¹é½ */
        .nav-search-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 0 auto;
        }

        /* æ–°å¢æ ·å¼ï¼šè®©ç¬¬äºŒå±‚é¡µçœ‰å†…å®¹å±…ä¸­å¹¶ç´§å‡‘ */
        .header-bottom-content {
            display: flex;
            justify-content: center;
        }

        .header-logo,
        .nav-search-container {
            margin: 0 10px;
        }

        /* Logoé“¾æ¥æ ·å¼ */
        .header-logo-link {
            text-decoration: none;
            color: inherit;
        }

        .header-top-text {
            font-size: 16px;
            font-weight: bold;
        }

        .header-buttons a {
            text-decoration: none;
            color: #007bff;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 5px 12px;
            margin-left: 8px;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .header-buttons a:hover {
            background-color: #f0f0f0;
        }

        .header-logo {
            font-size: 24px;
            font-weight: bold;
            font-style: italic;
            color: #333;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        /* é€šç”¨æŒ‰é’®æ ·å¼ */
        .nav-button,
        .main-nav-item {
            display: inline-block;
            padding: 10px 16px;
            font-size: 1rem;
            color: #333;
            text-decoration: none;
            background: #fff;
            border: 1px solid #000;
            border-radius: 4px;
            transition: background 0.2s, border-color 0.2s;
            cursor: pointer;
            box-sizing: border-box;
        }

        .nav-button:hover,
        .main-nav-item:hover {
            background: #f5f5f5;
            border-color: #333;
        }

        /* æœç´¢æ¡† */
        .search-container-v2 {
            display: flex;
            align-items: center;
            width: 300px;
            border-bottom: 2px solid #ccc;
            transition: border-bottom-color 0.3s ease;
        }

        .search-container-v2:focus-within {
            border-bottom-color: #0077cc;
        }

        .search-input-v2 {
            flex-grow: 1;
            padding: 8px 0;
            border: none;
            outline: none;
            background-color: transparent;
            font-size: 1rem;
            color: #333;
        }

        .search-input-v2::placeholder {
            color: #aaa;
        }

        .search-button-v2 {
            background-color: transparent;
            border: none;
            padding: 5px;
            cursor: pointer;
        }

        .search-button-v2 svg {
            fill: #0077cc;
            transition: fill 0.3s ease;
        }

        .search-button-v2:hover svg {
            fill: #005aa7;
        }

        /* æ¶ˆæ¯ç®±èœå• */
        .main-nav {
            position: relative;
            font-family: Arial, sans-serif;
            display: inline-block;
        }

        .nav-item-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 12px;
            width: 420px;
            z-index: 100;
        }

        .main-nav:hover .nav-item-dropdown {
            display: block;
        }

        .dropdown-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .tab-button {
            flex: 1;
            padding: 6px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            cursor: pointer;
            font-size: 0.85rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .tab-button:hover {
            background: #eee;
        }

        .tab-button.selected {
            background: #0077cc;
            color: white;
            border-color: #0077cc;
        }

        .tab-content { min-height: 120px; }
        .message-section { display: flex; flex-direction: column; gap: 10px; }
        .no-message-text { font-size: 0.9rem; color: #999; text-align: center; padding: 20px 0; }
        .message-item { display: flex; align-items: flex-start; gap: 10px; padding: 8px; border: 1px solid #eee; border-radius: 6px; background: #fafafa; transition: background 0.2s; }
        .message-item:hover { background: #f0f8ff; }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .message-info { flex: 1; }
        .message-title { margin: 0 0 4px; font-size: 0.9rem; color: #333; }
        .message-title span { color: #0077cc; font-weight: bold; }
        .message-time { font-size: 0.75rem; color: #999; }

        /* -------------------- æ‰‹æœºç«¯æ ·å¼ (å“åº”å¼) -------------------- */
        @media (max-width: 768px) {
            .header-top-content {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
                padding: 0 15px;
            }

            .header-bottom-content {
                flex-direction: column;
                align-items: center;
                padding: 0 15px;
            }

            /* æ–°å¢ï¼šè®© logo åœ¨æ‰‹æœºç‰ˆå±…å·¦å¯¹é½ */
            .header-logo-link {
                width: 100%;
                text-align: left;
                margin-bottom: 10px;
                order: -1;
            }

            /* æœç´¢æ¡†å’ŒåŠŸèƒ½æŒ‰é’®å‚ç›´æ’åˆ— */
            .nav-search-container {
                width: 100%;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin: 0;
            }

            /* åŠŸèƒ½æŒ‰é’®å’Œæ¶ˆæ¯ç®±åœ¨æ‰‹æœºç‰ˆæ°´å¹³æ’åˆ— */
            .nav-buttons-mobile {
                display: flex;
                width: 100%;
                justify-content: space-around;
                gap: 5px;
            }

            .header-top,
            .header-bottom {
                padding: 10px 0;
            }

            .header-buttons,
            .search-container-v2 {
                width: auto;
                margin-top: 0;
            }

            .header-buttons a {
                width: auto;
                text-align: center;
                margin-left: 5px;
            }

            .search-container-v2 {
                width: 100%;
                border-bottom: none;
                border: 1px solid #ccc;
                border-radius: 5px;
                padding: 0 10px;
            }

            .search-input-v2 {
                padding: 8px 0;
            }

            .nav-item-dropdown {
                width: 90%;
                right: 50%;
                transform: translateX(50%);
            }
        }

            /* ç¡®ä¿ .hidden èƒ½è¦†ç›– progress-overlay çš„é»˜è®¤ display */
        .hidden {
            display: none !important;
        }

        /* -------------------- è¿›åº¦æ¡æ ·å¼ -------------------- */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* åŠé€æ˜ç™½è‰²èƒŒæ™¯ */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }

        .progress-container {
            text-align: center;
            padding: 20px 40px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #0077cc; /* è“è‰²æ—‹è½¬éƒ¨åˆ† */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

#notification-badge {
    display: inline-block;
    width: 10px;
    height: 10px;
    background-color: #0077cc; /* è“è‰² */
    border-radius: 50%;
    position: absolute;
    top: 0;
    right: 0;
    transform: translate(50%, -50%);
    z-index: 10;
}

.main-nav-item {
    position: relative; /* ç¡®ä¿ badge å®šä½åŸºäºæŒ‰é’® */
}

.hidden {
    display: none !important;
}

      /* ğŸŸ¡ æœªè¯»æ¶ˆæ¯é«˜äº®æ ·å¼ */
.message-item.unread {
    background: #fff9e6;
    border-color: #ffe58f;
    box-shadow: 0 0 3px rgba(255, 200, 0, 0.3);
    transition: background 0.3s ease, opacity 0.3s ease;
}

/* ğŸ©¶ ç‚¹å‡»åæ¸æ·¡åŠ¨ç”» */
.message-item.read-fade {
    background: #f8f8f8 !important;
    opacity: 0.6;
}

      #mark-all-read-btn:hover {
    color: #005aa7;
}

      /* === è§£å†³æ¶ˆæ¯ç®±è¢«ç¼–è¾‘å™¨é®æŒ¡çš„é—®é¢˜ === */

/* ç¡®ä¿é¡µçœ‰æ•´ä½“åœ¨ç¼–è¾‘å™¨ä¹‹ä¸Š */
.header-top,
.header-bottom {
  position: relative;
  z-index: 100 !important;
}

/* æ¶ˆæ¯ä¸‹æ‹‰èœå•æµ®åœ¨æœ€ä¸Šå±‚ */
.nav-item-dropdown {
  z-index: 5000 !important;
  position: absolute;
  top: 100%;
  right: 0;
}

/* å¦‚æœç¼–è¾‘å™¨æˆ–å…¶å·¥å…·æ ä½¿ç”¨äº†è¿‡é«˜å±‚çº§ï¼Œç»Ÿä¸€é™ä½ */
.editor-toolbar-container,
.ql-toolbar.ql-snow,
.ql-container.ql-snow {
  z-index: 1000 !important;
}

      /* âœ… é¡¶éƒ¨æŒ‰é’®åŒºåŸŸæ ·å¼ */
.dropdown-header {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-bottom: 6px;
  position: relative;
}

#mark-all-read-btn {
  font-size: 0.8rem;
  color: #0077cc;
  background: none;
  border: none;
  cursor: pointer;
  text-decoration: underline;
  padding: 2px 4px;
  position: absolute;
  right: 10px;
  top: 5px;
}

#mark-all-read-btn:hover {
  color: #005aa7;
}

      /* ğŸ§© é€šç”¨æ ·å¼ */
.notification-dropdown {
  position: absolute;
  top: 50px;
  right: 0;
  background: white;
  width: 360px;
  max-height: 500px;
  overflow-y: auto;
  border-radius: 10px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.2);
  z-index: 3000;
  transition: all 0.3s ease;
}

@media (max-width: 768px) {
  .nav-item-dropdown {
    position: fixed !important;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 95vw;
    height: 80vh;
    max-height: none;
    overflow-y: auto;
    border-radius: 10px;
    background: white;
    box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
    z-index: 5000 !important;
    padding: 10px;
  }

  .dropdown-tabs {
    position: sticky;
    top: 0;
    background: white;
    z-index: 1;
  }

  .tab-content {
    height: calc(80vh - 80px);
    overflow-y: auto;
  }

  /* æ¶ˆæ¯æ¡ç›®æ›´å¤§äº›ï¼Œé€‚åˆè§¦æ§ */
  .message-item {
    padding: 12px;
    border-radius: 8px;
  }
}
      
    </style>
</head>
<body>
    <div id="progress-overlay" class="progress-overlay hidden">
        <div class="progress-container">
            <div class="spinner"></div>
            <p>æ­£åœ¨è½¬æ¢ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>
    
    <header class="header-top">
        <div class="header-top-content">
            <div class="header-top-text">æ¬¢è¿ä½¿ç”¨ è´¨ç‚¹å®‰ç§‘ç«™</div>
            <div class="header-buttons">
                <a id="logoutBtn" href="https://zhidianworld.com/login/" class="hidden">é€€å‡ºç™»å½•</a>
                <a id="loginBtn" href="https://zhidianworld.com/login/">ç™»å½•</a>
                <a id="registerBtn" href="https://zhidianworld.com/register/">æ³¨å†Œ</a>
            </div>
        </div>
    </header>

    <header class="header-bottom">
        <div class="header-bottom-content">
            <a href="https://zhidianworld.com/" class="header-logo-link">
                <div class="header-logo">AnchorX</div>
            </a>
            <div class="nav-search-container">
                <div class="nav-buttons nav-buttons-mobile">
                    <a href="https://zhidianworld.com/%e8%ae%a8%e8%ae%ba%e5%8c%ba/#topic-link-1" class="nav-button">è®¨è®ºåŒº</a>
                    <a href="https://zhidianworld.com/write/" class="nav-button">åˆ›ä½œ</a>
                    <a href="https://zhidianworld.com/home/" class="nav-button">ä¸»é¡µé¢ / é˜…è¯»</a>
                    <button id="lang-toggle" class="nav-button">ç¹/ç®€</button>
                    <nav class="main-nav">
                        <div class="main-nav-item">
    æ¶ˆæ¯ç®±â–¼
    <span id="notification-badge" class="hidden"></span>
</div>
                        <div class="nav-item-dropdown">
  <div class="dropdown-header">
    <button id="mark-all-read-btn">å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»</button>
  </div>
  <div class="dropdown-tabs">
    <button class="tab-button selected">èµ</button>
    <button class="tab-button">è¯„è®º</button>
    <button class="tab-button">ç³»ç»Ÿé€šçŸ¥</button>
  </div>
  <div class="tab-content">
    <p class="no-message-text">æš‚æ— æ¶ˆæ¯</p>
  </div>

                        </div>
                    </nav>
                </div>

                <div class="search-container-v2">
                    <input type="text" class="search-input-v2" placeholder="è¾“å…¥å…³é”®å­—...">
                    <button class="search-button-v2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 
                            4.99L20.49 19l-4.99-5zm-6 
                            0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 
                            14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

<script>
const API_URL = 'https://api.anchorx.ca/api/convert-text';

document.addEventListener('DOMContentLoaded', () => {
    // --- ç™»å½•/æ³¨å†Œ/é€€å‡ºæŒ‰é’®é€»è¾‘ ---
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const token = localStorage.getItem('token');

    if (token) {
        loginBtn.classList.add('hidden');
        registerBtn.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
    } else {
        loginBtn.classList.remove('hidden');
        registerBtn.classList.remove('hidden');
        logoutBtn.classList.add('hidden');
    }

    logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('token');
        window.location.href = 'https://zhidianworld.com/login/';
    });

    // --- æ¶ˆæ¯ç®±é€»è¾‘ (ä»£ç ä¿æŒä¸å˜) ---
    const dropdownTabs = document.querySelector('.dropdown-tabs');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContent = document.querySelector('.tab-content');
    const API_BASE_URL = 'https://api.anchorx.ca/api/notifications';
    let currentTab = 'èµ';

    fetchAndRenderNotifications();

    dropdownTabs.addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-button')) {
            tabButtons.forEach(btn => btn.classList.remove('selected'));
            e.target.classList.add('selected');
            currentTab = e.target.textContent;
            fetchAndRenderNotifications();
        }
    });

    async function fetchAndRenderNotifications() {
        tabContent.innerHTML = '<p class="no-message-text">åŠ è½½ä¸­...</p>';
        const token = localStorage.getItem('token');
        if (!token) {
            tabContent.innerHTML = '<p class="no-message-text">è¯·ç™»å½•åæŸ¥çœ‹æ¶ˆæ¯</p>';
            return;
        }

        try {
            const response = await fetch(API_BASE_URL, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('è·å–æ¶ˆæ¯å¤±è´¥');
            const notifications = await response.json();

            let filteredNotifications;
            if (currentTab === 'èµ') {
                filteredNotifications = notifications.filter(n => n.type === 'like');
            } else if (currentTab === 'è¯„è®º') {
                filteredNotifications = notifications.filter(n => n.type === 'comment');
            } else if (currentTab === 'ç³»ç»Ÿé€šçŸ¥') {
                filteredNotifications = notifications.filter(n => n.type === 'system');
            } else {
                filteredNotifications = [];
            }

            renderMessages(filteredNotifications);
        } catch (error) {
            console.error('è·å–æ¶ˆæ¯å‡ºé”™:', error);
            tabContent.innerHTML = '<p class="no-message-text" style="color: red;">ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•</p>';
        }
    }

async function updateNotificationBadge() {
    const token = localStorage.getItem('token');
    const badge = document.getElementById('notification-badge');

    if (!token) {
        badge.classList.add('hidden');
        return;
    }

    try {
        const response = await fetch(API_BASE_URL, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('è·å–æ¶ˆæ¯å¤±è´¥');

        const notifications = await response.json();
        const hasUnread = notifications.some(n => !n.read); // åˆ¤æ–­æ˜¯å¦æœ‰æœªè¯»

        if (hasUnread) {
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    } catch (err) {
        console.error('æ£€æŸ¥æœªè¯»æ¶ˆæ¯å¤±è´¥:', err);
        badge.classList.add('hidden');
    }
}

// åˆæ¬¡åŠ è½½å’Œæ¯æ¬¡æ‹‰å–æ¶ˆæ¯åæ›´æ–°


  document.querySelector('.main-nav-item').addEventListener('click', async () => {
    const token = localStorage.getItem('token');
    if (!token) return;

    try {
        const response = await fetch(API_BASE_URL, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const notifications = await response.json();

        const unreadIds = notifications.filter(n => !n.read).map(n => n._id);
        for (const id of unreadIds) {
            await fetch(`${API_BASE_URL}/mark-read/${id}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
        }

        // æ›´æ–° badge
        
        fetchAndRenderNotifications(); // åˆ·æ–°ä¸‹æ‹‰å†…å®¹
    } catch (err) {
        console.error('æ ‡è®°å·²è¯»å¤±è´¥', err);
    }
});

  
function renderMessages(notifications) {
  tabContent.innerHTML = '';
  const messageSection = document.createElement('div');
  messageSection.className = 'message-section';

  if (notifications.length === 0) {
    tabContent.innerHTML = '<p class="no-message-text">æš‚æ— æ¶ˆæ¯</p>';
    return;
  }

  const pageSize = 8;
  let currentPage = 1;
  const totalPages = Math.ceil(notifications.length / pageSize);

  // âœ… æ¸²æŸ“å½“å‰é¡µå‡½æ•°
  function renderPage(page) {
    messageSection.innerHTML = '';
    const start = (page - 1) * pageSize;
    const end = start + pageSize;
    const currentItems = notifications.slice(start, end);

    currentItems.forEach(notification => {
      const messageItem = document.createElement('div');
      messageItem.className = 'message-item';
      messageItem.style.cursor = 'pointer';
      if (!notification.read) messageItem.classList.add('unread');

      const senderName = notification.sender?.username || 'æœªçŸ¥ç”¨æˆ·';
      const messageTime = new Date(notification.createdAt).toLocaleString();
      let messageTitle = notification.message || '';
      if (!messageTitle.includes(senderName)) {
        messageTitle = `${senderName} ${messageTitle}`;
      }

      messageItem.innerHTML = `
        <div class="message-info">
          <p class="message-title">${messageTitle}</p>
          <p class="message-time">${messageTime}</p>
        </div>
      `;

      messageItem.addEventListener('click', async () => {
        // âœ… åŸæœ‰ç‚¹å‡»æ ‡è®°å·²è¯»+è·³è½¬é€»è¾‘ä¿æŒä¸å˜
        try {
          await fetch(`https://api.anchorx.ca/api/notifications/mark-read/${notification._id}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          messageItem.classList.add('read-fade');
          
          fetchAndRenderNotifications();
        } catch (err) {
          console.error('æ ‡è®°å·²è¯»å¤±è´¥', err);
        }
      });

      messageSection.appendChild(messageItem);
    });

    // âœ… æ·»åŠ åˆ†é¡µå¯¼èˆª
    const pagination = document.createElement('div');
    pagination.style = `
      text-align:center;
      margin-top:10px;
      font-size:0.85rem;
    `;
    pagination.innerHTML = `
      <button ${page === 1 ? 'disabled' : ''} id="prevPage">ä¸Šä¸€é¡µ</button>
      <span style="margin:0 8px;">ç¬¬ ${page} / ${totalPages} é¡µ</span>
      <button ${page === totalPages ? 'disabled' : ''} id="nextPage">ä¸‹ä¸€é¡µ</button>
    `;

    tabContent.innerHTML = ''; // æ¸…ç©ºæ—§é¡µ
    tabContent.appendChild(messageSection);
    tabContent.appendChild(pagination);

    // âœ… åˆ†é¡µæŒ‰é’®é€»è¾‘
    pagination.querySelector('#prevPage')?.addEventListener('click', () => renderPage(page - 1));
    pagination.querySelector('#nextPage')?.addEventListener('click', () => renderPage(page + 1));
  }

  renderPage(currentPage);
}


    // --- ç¹ç®€è½¬æ¢é€»è¾‘ (å·²ä¿®æ­£) ---
    const langToggleBtn = document.getElementById('lang-toggle');
    const progressOverlay = document.getElementById('progress-overlay');

    // **å…³é”®ä¿®æ”¹ç‚¹ 1: é»˜è®¤è¯­è¨€æ”¹ä¸º "s" (ç®€ä½“)**
    if (!document.body.dataset.lang) {
        document.body.dataset.lang = "s"; // s = ç®€ä½“, t = ç¹ä½“
    }
    // **å…³é”®ä¿®æ”¹ç‚¹ 2: æŒ‰é’®åˆå§‹æ–‡æœ¬æ ¹æ®æ–°çš„é»˜è®¤è¯­è¨€è®¾ç½®**
    // é»˜è®¤æ˜¯ç®€ä½“(s)ï¼Œæ‰€ä»¥æŒ‰é’®æ–‡æœ¬æ˜¾ç¤º â€œç¹/ç®€â€ï¼Œè¡¨ç¤ºç‚¹å‡»åä¼šè½¬æ¢æˆç¹ä½“
    langToggleBtn.textContent = document.body.dataset.lang === "t" ? "ç®€/ç¹" : "ç¹/ç®€";


    langToggleBtn.addEventListener('click', async () => {
        // 1. æ˜¾ç¤ºè¿›åº¦æ¡
        progressOverlay.classList.remove('hidden');
        
        const currentLang = document.body.dataset.lang;
        // å¦‚æœå½“å‰æ˜¯ "s" (ç®€ä½“), direction ä¸º "s2t" (ç®€è½¬ç¹)
        // å¦‚æœå½“å‰æ˜¯ "t" (ç¹ä½“), direction ä¸º "t2s" (ç¹è½¬ç®€)
        const direction = currentLang === "s" ? "s2t" : "t2s"; 

        function getTextNodes(node) {
            let textNodes = [];
            for (let child of node.childNodes) {
                if (child.nodeType === Node.TEXT_NODE && child.textContent.trim()) {
                    // å¿½ç•¥ <style> å’Œ <script> é‡Œçš„æ–‡æœ¬èŠ‚ç‚¹
                    if (node.tagName !== "STYLE" && node.tagName !== "SCRIPT") {
                        textNodes.push(child);
                    }
                } else if (child.nodeType === Node.ELEMENT_NODE) {
                    // åŒæ ·è·³è¿‡ä¸éœ€è¦è½¬æ¢çš„æ ‡ç­¾
                    if (!["STYLE", "SCRIPT", "SVG"].includes(child.tagName)) {
                        textNodes = textNodes.concat(getTextNodes(child));
                    }
                }
            }
            return textNodes;
        }


        const textNodes = getTextNodes(document.body);
        const fullText = textNodes.map(n => n.textContent).join("\n");

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: fullText, direction })
            });

            if (!response.ok) throw new Error("Conversion API request failed");

            const data = await response.json();
            const convertedText = data.convertedText.split("\n");

            textNodes.forEach((node, i) => {
                node.textContent = convertedText[i] || "";
            });

            // æ›´æ–°è¯­è¨€çŠ¶æ€å’ŒæŒ‰é’®æ–‡æœ¬
            document.body.dataset.lang = currentLang === "s" ? "t" : "s"; // åˆ‡æ¢è¯­è¨€çŠ¶æ€
            langToggleBtn.textContent = currentLang === "s" ? "ç®€/ç¹" : "ç¹/ç®€"; // åˆ‡æ¢æŒ‰é’®æ–‡æœ¬
        } catch (err) {
            console.error("ç¹ç®€è½¬æ¢å¤±è´¥:", err);
            alert("ç¹ç®€è½¬æ¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚");
        } finally {
            // 2. éšè—è¿›åº¦æ¡
            progressOverlay.classList.add('hidden');
        }
    });
});

// --- å…¨éƒ¨å·²è¯»æŒ‰é’®é€»è¾‘ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
document.addEventListener('click', async (e) => {
  if (e.target && e.target.id === 'mark-all-read-btn') {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('è¯·å…ˆç™»å½•æŸ¥çœ‹æ¶ˆæ¯');
      return;
    }

    try {
      const response = await fetch('https://api.anchorx.ca/api/notifications/mark-read/all', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!response.ok) throw new Error('æ‰¹é‡æ ‡è®°å¤±è´¥');
      const result = await response.json();
      console.log('âœ… æ‰¹é‡æ ‡è®°ç»“æœ:', result);

      // âœ… å®‰å…¨è°ƒç”¨å¾½ç« æ›´æ–°å‡½æ•°
      if (typeof updateNotificationBadge === 'function') {
        await updateNotificationBadge();
      } else {
        console.warn('âš ï¸ updateNotificationBadge æœªå®šä¹‰ï¼Œè·³è¿‡å¾½ç« æ›´æ–°');
      }

      // âœ… åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
      if (typeof fetchAndRenderNotifications === 'function') {
        await fetchAndRenderNotifications();
      }

      // âœ… å‰ç«¯å³æ—¶åé¦ˆï¼ˆå¼¹å‡ºç»¿è‰²æç¤ºï¼‰
      const tip = document.createElement('div');
      tip.textContent = 'âœ… å·²å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»';
      tip.style = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4caf50;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-size: 0.85rem;
        z-index: 9999;
      `;
      document.body.appendChild(tip);
      setTimeout(() => tip.remove(), 1500);

      // âœ… å°†æ‰€æœ‰æœªè¯»æ¶ˆæ¯é«˜äº®ç§»é™¤
      document.querySelectorAll('.message-item.unread').forEach(el => {
        el.classList.remove('unread');
        el.classList.add('read-fade');
      });

    } catch (err) {
      console.error('å…¨éƒ¨æ ‡è®°ä¸ºå·²è¯»å¤±è´¥:', err);
      alert('å…¨éƒ¨æ ‡è®°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
  }
});


</script>
</body>
</html>