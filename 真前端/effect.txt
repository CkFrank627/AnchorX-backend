<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ¸²æŸ“ç‰¹æ•ˆ</title>
    <link href="https://api.anchorx.ca/vendor_assets/quill.snow.css" rel="stylesheet">
  
<style> /* éšè—ç±» */ .hidden {
  display:none !important;
}
/* æ•´ä¸ªé¡µé¢å®¹å™¨ */ body {
  margin:0;
  padding:0;
  font-family:Arial,sans-serif;
  background-color:#f0f2f5;
}
.page-container {
  display:flex;
  min-height:100vh;
  background-color:#fff;
}
/* ä¾§è¾¹æ  */ .sidebar-nav {
  flex-shrink:0;
  width:250px;
  padding:30px 20px;
  background-color:#f7f9fc;
  border-right:1px solid #eee;
  /* æ–°å¢ï¼šæ·»åŠ è¿‡æ¸¡æ•ˆæœï¼Œä½¿å±•å¼€å’Œæ”¶èµ·æ›´å¹³æ»‘ */ transition:width 0.3s ease-in-out,padding 0.3s ease-in-out;
}
/* æ–°å¢ï¼šä¾§è¾¹æ æ”¶èµ·æ—¶çš„æ ·å¼ */ .sidebar-collapsed {
  width:70px;
  /* è°ƒæ•´ä¸ºåªå®¹çº³å›¾æ ‡çš„å®½åº¦ */ padding:30px 10px;
}
.nav-link {
  display:flex;
  align-items:center;
  /* æ–°å¢ï¼šå¯¹é½æ–¹å¼ï¼Œä¾§è¾¹æ æ”¶èµ·æ—¶å›¾æ ‡å±…ä¸­ */ justify-content:flex-start;
  padding:12px 15px;
  margin-bottom:8px;
  text-decoration:none;
  color:#333;
  border-radius:6px;
  transition:background-color 0.2s,color 0.2s,transform 0.2s;
}
/* æ–°å¢ï¼šä¾§è¾¹æ æ”¶èµ·æ—¶é“¾æ¥å›¾æ ‡å±…ä¸­ */ .sidebar-collapsed .nav-link {
  justify-content:center;
  padding:12px 0;
}
.nav-link:hover {
  background-color:#e6f7ff;
  color:#0077cc;
}
/* ... ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ ... */ .nav-icon {
  margin-right:15px;
  display:flex;
  align-items:center;
  justify-content:center;
  /* æ–°å¢ï¼šæ·»åŠ è¿‡æ¸¡æ•ˆæœ */ transition:margin-right 0.3s ease-in-out;
}
/* æ–°å¢ï¼šä¾§è¾¹æ æ”¶èµ·æ—¶ç§»é™¤å›¾æ ‡å³è¾¹è· */ .sidebar-collapsed .nav-icon {
  margin-right:0;
}
.nav-icon svg {
  width:20px;
  height:20px;
}
.nav-link.active .nav-icon svg {
  fill:#0077cc;
}
/* æ–°å¢ï¼šéšè—æ–‡å­—ï¼Œå¹¶æ·»åŠ è¿‡æ¸¡æ•ˆæœ */ .nav-text {
  opacity:1;
  transition:opacity 0.2s ease-in-out;
}
.sidebar-collapsed .nav-text {
  opacity:0;
}
/* ä¸»å†…å®¹åŒºåŸŸ */ .main-content {
  /* ä¿æŒåŸæœ‰æ ·å¼ */ flex-grow:1;
  display:flex;
  flex-direction:column;
  padding:0 40px;
  /* æ ¸å¿ƒä¿®æ”¹ï¼šæ·»åŠ å³è¾¹è·ï¼Œæ•°å€¼éœ€ä¸å·¥å…·æ å®½åº¦ä¸€è‡´ */ margin-right:250px;
}
.content-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
.header-left,.header-right {
  display:flex;
  align-items:center;
}
.header-left {
  gap:20px;
}
.header-title {
  display:flex;
  align-items:center;
}
.header-title h2 {
  font-size:1.5rem;
  margin:0;
  margin-left:10px;
}
.create-button {
  background-color:#0077cc;
  color:#fff;
  border:none;
  padding:10px 15px;
  border-radius:5px;
  cursor:pointer;
  font-size:1rem;
  display:flex;
  align-items:center;
  gap:5px;
  transition:background-color 0.3s ease;
}
.create-button:hover {
  background-color:#005aa7;
}
.sort-dropdown {
  position:relative;
}
.sort-button {
  background:none;
  border:1px solid #ccc;
  border-radius:5px;
  padding:8px 12px;
  cursor:pointer;
  font-size:1rem;
  color:#555;
  display:flex;
  align-items:center;
  gap:5px;
  transition:all 0.2s ease;
}
.sort-button:hover {
  border-color:#0077cc;
  color:#0077cc;
}
.sort-icon {
  margin-left:5px;
}
.work-list {
  display:flex;
  flex-direction:column;
}
.work-item-wrapper {
  position:relative;
  margin-bottom:15px;
  background-color:#fff;
  border-radius:8px;
  box-shadow:0 2px 5px rgba(0,0,0,0.05);
  transition:transform 0.2s,box-shadow 0.2s;
}
.work-item-wrapper:hover {
  transform:translateY(-2px);
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
}
.work-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px;
  border:1px solid transparent;
  border-radius:8px;
  text-decoration:none;
  color:inherit;
}
.work-info {
  display:flex;
  flex-direction:column;
  flex-grow:1;
}
.work-date {
  font-size:0.85rem;
  color:#999;
}
.work-details {
  display:flex;
  gap:10px;
  align-items:center;
  margin-top:5px;
}
.work-title {
  font-size:1rem;
  color:#333;
  font-weight:bold;
}
.work-status {
  font-size:0.8rem;
  color:#555;
  background-color:#f0f0f0;
  padding:2px 6px;
  border-radius:4px;
}
.item-divider {
  border:none;
  border-bottom:1px solid #eee;
  margin:10px 0;
}
.menu-button {
  background:none;
  border:none;
  cursor:pointer;
  font-size:1.2rem;
  color:#999;
}
.menu-button:hover {
  color:#333;
}
/* ä½œå“èœå•æ ·å¼ */ .menu-container {
  position:absolute;
  top:50px;
  right:10px;
  width:150px;
  background-color:#fff;
  border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
  z-index:10;
  overflow:hidden;
}
.menu-item {
  display:flex;
  align-items:center;
  padding:10px 15px;
  font-size:0.9rem;
  color:#333;
  cursor:pointer;
  transition:background-color 0.2s ease;
}
.menu-item:hover {
  background-color:#e6f7ff;
}
.menu-item svg {
  width:16px;
  height:16px;
  margin-right:10px;
  fill:#888;
}
.menu-item:hover svg {
  fill:#0077cc;
}
/* å¯¹è¯æ¡†ï¼ˆModalï¼‰æ ·å¼ */ .modal {
  display:none;
  position:fixed;
  z-index:1000;
  left:0;
  top:0;
  width:100%;
  height:100%;
  overflow:auto;
  background-color:rgba(0,0,0,0.4);
  justify-content:center;
  align-items:center;
}
.modal-content {
  background-color:#fff;
  padding:30px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.3);
  width:400px;
  max-width:90%;
  text-align:center;
}
.menu-modal-content {
  text-align:center;
  padding:20px;
}
.menu-modal-content h3 {
  margin-top:0;
  color:#333;
}
.modal-content input {
  width:100%;
  padding:10px;
  margin-top:15px;
  margin-bottom:20px;
  border:1px solid #ddd;
  border-radius:5px;
  box-sizing:border-box;
}
.modal-buttons {
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:20px;
}
.modal-buttons button {
  padding:8px 15px;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:1rem;
}
#cancel-btn,#delete-cancel-btn {
  background-color:#f0f0f0;
  color:#555;
}
#confirm-btn,#delete-confirm-btn {
  background-color:#0077cc;
  color:#fff;
}
#delete-confirm-btn {
  background-color:#dc3545;
}
/* ç¼–è¾‘å™¨é¡µé¢æ ·å¼ */ .editor-toolbar {
  background-color:#fff;
  padding:10px 30px;
  border-bottom:1px solid #ddd;
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
  display:flex;
  gap:15px;
  align-items:center;
  flex-wrap:wrap;
}
.editor-title {
  flex-grow:1;
  font-size:1.2rem;
  color:#333;
  font-weight:bold;
  margin-right:20px;
}
.back-button {
  padding:8px 12px;
  border:1px solid #adb5bd;
  border-radius:5px;
  background-color:#f8f9fa;
  cursor:pointer;
  color:#495057;
  /* é»˜è®¤æ–‡å­—é¢œè‰² */ transition:background-color 0.2s,color 0.2s;
}
.back-button:hover {
  background-color:#0d6efd;
  /* æ‚¬åœæ—¶èƒŒæ™¯è‰² */ color:#fff;
  /* æ‚¬åœæ—¶æ–‡å­—é¢œè‰² */
}
#toolbar-quill {
  display:flex;
  gap:5px;
  flex-wrap:wrap;
  /* å…è®¸å·¥å…·æ æŒ‰é’®æ¢è¡Œ */
}
.editor-main {
  flex-grow:1;
  /* ğŸ¨ å…³é”®ä¿®æ”¹ï¼šå‡å°‘å¤–è¾¹è·ï¼Œä»¥ç¼©å°å·¥å…·æ å’Œç¼–è¾‘å™¨ä¹‹é—´çš„ç°è‰²è·ç¦» */ padding:30px;
  display:flex;
  flex-direction:column;
  background-color:#f0f2f5;
  /* âŒ ç§»é™¤ margin:20px;
  æˆ–å°†å…¶æ”¹ä¸ºæ›´å°çš„å€¼ */ margin:10px 0;
}
#editor {
  max-width:900px;
  /* èˆ‡é–±è®€é é¢ä¸€è‡´çš„æœ€å¤§å¯¬åº¦ */ width:100%;
  /* éŸ¿æ‡‰å¼å¯¬åº¦ */ padding:16px;
  font-size:16px;
  line-height:1.6;
  white-space:pre-wrap;
  /* ä¿ç•™æ›è¡Œä¸¦è‡ªå‹•æ›è¡Œ */ word-wrap:break-word;
  /* å–®å­—éé•·æ™‚è‡ªå‹•æ–·è¡Œ */ overflow-wrap:break-word;
  /* é˜²æ­¢æ–‡å­—æº¢å‡º */ box-sizing:border-box;
  border:1px solid #ccc;
  border-radius:8px;
  background-color:#fff;
  font-size:1.215rem;
}
.ql-container {
  flex-grow:1;
  display:flex;
  flex-direction:column;
}
.ql-editor {
  flex-grow:1;
  min-height:400px;
}
#plainEditor {
  background-color:#fff;
  border-radius:8px;
  height:100%;
  flex-grow:1;
  border:1px solid #ccc;
  box-sizing:border-box;
  min-height:500px;
}
/* æ–°å¢è§’è‰²ä¸‹æ‹‰èœå•å’Œå¼¹çª—æ ·å¼ */ .dropdown-container {
  position:relative;
  border:1px solid #ccc;
  border-radius:5px;
  margin-bottom:10px;
}
.dropdown-header {
  width:100%;
  background-color:#fff;
  padding:10px 15px;
  font-size:0.9rem;
  text-align:left;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-radius:5px;
}
.dropdown-header:hover {
  background-color:#e6f7ff;
}
.dropdown-header .arrow {
  transition:transform 0.3s;
}
.dropdown-header.open .arrow {
  transform:rotate(90deg);
}
.dropdown-content {
  display:none;
  padding:10px;
  border-top:1px solid #ddd;
  background-color:#f7f9fc;
}
.dropdown-content.open {
  display:block;
}
.role-list {
  list-style:none;
  padding:0;
  margin:0;
}
.role-item {
  font-size:0.9rem;
  border-bottom:1px dashed #ddd;
  padding:8px 0;
  cursor:pointer;
}
.role-item:last-child {
  border-bottom:none;
}
.role-title-wrapper {
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.role-title {
  font-weight:bold;
}
.role-title .color-dot {
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:50%;
  margin-right:8px;
  border:1px solid #ccc;
}
.role-item .edit-btn {
  font-size:0.8rem;
  color:#0077cc;
  cursor:pointer;
  margin-left:10px;
}
.role-item-notes {
  font-size:0.8rem;
  color:#555;
  padding-left:18px;
  margin-top:5px;
  display:none;
}
.role-item-notes.open {
  display:block;
}
.add-role-btn {
  width:100%;
  background-color:#e9f5ff;
  color:#0077cc;
  border:1px dashed #0077cc;
  border-radius:5px;
  padding:8px;
  font-size:0.9rem;
  text-align:center;
  cursor:pointer;
  margin-top:10px;
}
.modal-content {
  background-color:#fefefe;
  margin:10% auto;
  padding:25px;
  border:1px solid #888;
  width:400px;
  border-radius:10px;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
}
.modal-content h3 {
  margin-top:0;
  border-bottom:2px solid #ddd;
  padding-bottom:10px;
  margin-bottom:20px;
}
.modal-content label {
  display:block;
  margin-bottom:5px;
  font-weight:bold;
}
.modal-content input,.modal-content textarea {
  width:95%;
  padding:8px;
  margin-bottom:15px;
  border:1px solid #ccc;
  border-radius:4px;
}
.modal-content .color-picker-wrapper {
  display:flex;
  align-items:center;
  margin-bottom:15px;
}
.modal-content .color-picker {
  width:40px;
  height:40px;
  margin-left:10px;
  border:none;
  cursor:pointer;
}
.modal-buttons {
  text-align:right;
}
.modal-buttons button {
  padding:8px 15px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  margin-left:10px;
}
.modal-buttons .confirm {
  background-color:#0077cc;
  color:white;
}
.modal-buttons .cancel {
  background-color:#ddd;
}
/* æ‰¹é‡åˆªé™¤å¼¹çª—çš„ç‰¹æ®Šæ ·å¼ */ #bulk-delete-modal .modal-content {
  width:500px;
  text-align:left;
}
#bulk-delete-modal .delete-list {
  max-height:300px;
  overflow-y:auto;
  border:1px solid #eee;
  border-radius:6px;
  margin-top:15px;
  padding:10px;
}
#bulk-delete-modal .delete-item {
  display:flex;
  align-items:center;
  padding:8px 10px;
  border-bottom:1px solid #f0f0f0;
}
#bulk-delete-modal .delete-item:last-child {
  border-bottom:none;
}
#bulk-delete-modal .delete-item span {
  flex-grow:1;
  margin-left:10px;
}
#bulk-delete-modal .delete-item input {
  width:auto;
  margin:0;
}
#bulk-delete-modal .delete-buttons {
  display:flex;
  justify-content:flex-end;
  margin-top:20px;
}
.editor-container {
  display:flex;
  flex-direction:row;
}
.right-sidebar {
  flex-shrink: 0;
  width: 250px;
  background-color: #f7f9fc;
  border-left: 1px solid #eee;
  padding: 20px;
  transition: width 0.3s ease-in-out;
  position: sticky;
  top: 70px; /* âœ… å‘ä¸‹é”™å¼€ï¼Œé¿å…é®æŒ¡æ¶ˆæ¯ç®±æˆ–é¡µçœ‰ */
  right: 0;
  height: calc(100vh - 70px); /* âœ… åŒæ­¥è°ƒæ•´é«˜åº¦ */
  overflow-y: auto;
  z-index: 50; /* âœ… ä¿è¯åœ¨ç¼–è¾‘å™¨ä¸Šå±‚ä½†ä¸ç›–ä½é¡µçœ‰ */
}

/* æ–°å¢è§’è‰²é¸æ“‡æŒ‰é’®æ ·å¼ */ .role-select-btn {
  width:20px;
  height:20px;
  border-radius:50%;
  border:2px solid #ccc;
  cursor:pointer;
  display:flex;
  justify-content:center;
  align-items:center;
  transition:all 0.2s ease;
  margin-right:10px;
}
.role-select-btn.active {
  background-color:#0077cc;
  border-color:#0077cc;
}
.role-select-btn.active::after {
  content:'';
  width:8px;
  height:8px;
  border-radius:50%;
  background-color:#fff;
}
.role-item.selected .role-title-wrapper {
  background-color:#e6f7ff;
  border-radius:4px;
  padding:5px 10px;
}
/* æ–°å¢ï¼šé¡µç æ§åˆ¶å™¨æ ·å¼ */ .page-controls {
  position:relative;
  display:flex;
  align-items:center;
  margin-right:15px;
  /* ä¸Quillå·¥å…·æ çš„é—´è· */
}
.page-current {
  cursor:pointer;
  font-size:14px;
  padding:8px 12px;
  border-radius:4px;
  background-color:#f0f0f0;
  transition:background-color 0.2s;
}
.page-current:hover {
  background-color:#e0e0e0;
}
/* æ–°å¢ï¼šé¡µç ä¸‹æ‹‰åˆ—è¡¨æ ·å¼ */ .page-select-dropdown {
  position:absolute;
  top:100%;
  left:0;
  margin-top:5px;
  width:150px;
  background-color:#fff;
  border:1px solid #ddd;
  box-shadow:0 4px 8px rgba(0,0,0,0.1);
  border-radius:8px;
  z-index:100;
}
.page-select-dropdown ul {
  list-style:none;
  padding:0;
  margin:0;
  max-height:200px;
  overflow-y:auto;
}
.page-select-dropdown li {
  padding:10px 15px;
  font-size:14px;
  cursor:pointer;
}
.page-select-dropdown li:hover {
  background-color:#f5f5f5;
}
.page-select-dropdown .active {
  background-color:#e0e2e6;
  font-weight:bold;
}
.add-page-btn {
  width:100%;
  padding:10px;
  background-color:#f7f9fc;
  border:none;
  cursor:pointer;
  text-align:center;
  border-top:1px solid #ddd;
  border-radius:0 0 8px 8px;
  color:#000;
}
.add-page-btn:hover {
  background-color:#e0e2e6;
}
/* æ–°å¢ï¼šç¼–è¾‘å™¨åˆ†é¡µå’Œå·¥å…·æ å®¹å™¨ */ .editor-controls {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
/* æ–°å¢ï¼šåˆ†é¡µæŒ‰é’®å®¹å™¨ */ .pagination {
  display:flex;
  align-items:center;
  gap:10px;
}
/* æ–°å¢ï¼šåˆ†é¡µæŒ‰é’® */ .page-btn {
  padding:5px 10px;
  border:1px solid #ccc;
  background-color:#f7f9fc;
  border-radius:5px;
  cursor:pointer;
}
.page-btn:hover {
  background-color:#e6f7ff;
}
.page-number {
  font-weight:bold;
  color:#0077cc;
}
/* æ–°å¢ï¼šç¼–è¾‘å™¨ä¸¤çº§å·¥å…·æ çš„æ•´ä½“å®¹å™¨ï¼Œå®ç°å›ºå®šåœ¨é¡¶éƒ¨çš„æ•ˆæœ */ .editor-toolbar-container {
  position:sticky;
  top:0;
  z-index:999;
  background-color:#f0f2f5;
  box-shadow:0 2px 4px rgba(0,0,0,0.05);
}
/* æ–°å¢ï¼šå¼¹çª—æ¨¡å¼ä¸‹éšè—å·¥å…·æ  */ .modal-active .editor-toolbar-container {
  display:none;
}
.role-gallery-btn:hover {
  text-decoration:underline;
}
/* æ–°å¢ï¼šå›¾åº“å¼¹çª—çš„æ ·å¼ */ #galleryModal .modal-content {
  width:600px;
  text-align:left;
}
/* å›¾åº“å›¾ç‰‡å®¹å™¨ */ .gallery-image-list {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  padding:10px;
  border:1px dashed #ccc;
  border-radius:8px;
  min-height:100px;
}
/* å•ä¸ªå›¾ç‰‡é¡¹ */ .gallery-image-item {
  position:relative;
  width:100px;
  height:100px;
  border-radius:8px;
  overflow:hidden;
  cursor:pointer;
}
.gallery-image-item img {
  width:100%;
  height:100%;
  object-fit:cover;
}
/* åˆ é™¤æŒ‰é’® */ .gallery-image-item .delete-btn {
  position:absolute;
  top:5px;
  right:5px;
  background-color:rgba(220,53,69,0.8);
  color:white;
  border-radius:50%;
  width:20px;
  height:20px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-weight:bold;
  cursor:pointer;
  opacity:0;
  transition:opacity 0.2s;
}
.gallery-image-item:hover .delete-btn {
  opacity:1;
}
/* æ·»åŠ å›¾ç‰‡æŒ‰é’® */ .add-image-btn {
  width:100px;
  height:100px;
  background-color:#f7f9fc;
  border:1px dashed #ddd;
  border-radius:8px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:2rem;
  color:#ccc;
  cursor:pointer;
  transition:background-color 0.2s,color 0.2s;
}
.add-image-btn:hover {
  background-color:#e6f7ff;
  color:#0077cc;
}
/* ------------------------------------------- */ /* æ–°å¢ï¼šåª’ä½“æŸ¥è¯¢ - é’ˆå¯¹æ‰‹æœºç«¯å¸ƒå±€ä¼˜åŒ–ï¼ˆæœ€å¤§å®½åº¦ 768pxï¼‰ */ /* ------------------------------------------- */ @media (max-width:768px) {
  /* æ•´ä½“å®¹å™¨ï¼šæ”¹ä¸ºä¸Šä¸‹å †å å¸ƒå±€ */ .page-container,.editor-container {
  flex-direction:column;
}
/* ä¾§è¾¹æ ï¼šå˜ä¸ºå…¨å®½ï¼Œå¹¶è°ƒæ•´é¡ºåº */ .sidebar-nav,.right-sidebar {
  width:100%;
  padding:20px 15px;
  border-right:none;
  border-left:none;
  border-bottom:1px solid #eee;
  /* åœ¨åº•éƒ¨æ·»åŠ åˆ†éš”çº¿ */ position:relative;
  /* å–æ¶ˆå›ºå®šå®šä½ï¼Œè®©å…¶éšé¡µé¢æ»šåŠ¨ */ order:3;
  /* å°†å·¦ä¾§å¯¼èˆªæ æ”¾åˆ°æœ€å */
}
/* ä¸»å†…å®¹åŒºåŸŸï¼šå˜ä¸ºå…¨å®½ï¼Œå¹¶è°ƒæ•´å¤–è¾¹è· */ /* .main-content åŒ…å«äº† .editor-main å’Œå…¶ä»–å†…å®¹ï¼Œæˆ‘ä»¬å‡è®¾ç¼–è¾‘å™¨é¡µé¢ä½¿ç”¨çš„æ˜¯è¿™ä¸ªç»“æ„ */ .main-content {
  width:100%;
  padding:0;
  /* ç§»é™¤å·¦å³å†…è¾¹è·ï¼Œè®©å­å…ƒç´ æ§åˆ¶è‡ªå·±çš„è¾¹è· */ margin-right:0;
  /* ç§»é™¤å³ä¾§å¤–è¾¹è· */ order:2;
  /* å°†ä¸»å†…å®¹åŒºåŸŸï¼ˆåŒ…å«ç¼–è¾‘å™¨ä¸»ä½“ï¼‰æ”¾åœ¨ä¸­é—´ï¼Œä½†æˆ‘ä»¬éœ€è¦è°ƒæ•´å­å…ƒç´ çš„æ’åˆ— */ /* æ–°å¢ï¼šåœ¨æ‰‹æœºç«¯ï¼Œå°† main-content å†…éƒ¨çš„å…ƒç´ ä¹Ÿå‚ç›´æ’åˆ—ï¼Œä»¥æ”¯æŒå·¥å…·æ å’Œç¼–è¾‘å™¨ä¸»ä½“çš„é¡ºåºæ§åˆ¶ */ display:flex;
  flex-direction:column;
}
/* ç¼–è¾‘å™¨å·¥å…·æ å®¹å™¨ï¼šæ”¹ä¸ºå…¨å®½ï¼Œå¹¶ç½®é¡¶ */ .editor-toolbar-container {
  /* æ ¸å¿ƒè°ƒæ•´ï¼šä½¿ç”¨ fixed å®šä½å®ç°å®Œå…¨ç½®é¡¶ */ position:fixed;
  top:0;
  left:0;
  width:100%;
  /* å…¨å®½ */ z-index:1000;
  /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */ order:1;
  /* å·¥å…·æ åœ¨æœ€é¡¶éƒ¨ (å¯¹äº flex-direction:column çš„çˆ¶å…ƒç´ ) */ padding:10px 15px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
  background-color:#fff;
  /* ç¡®ä¿æœ‰èƒŒæ™¯è‰²ç›–ä½ä¸‹é¢çš„å†…å®¹ */
}
/* ç¼–è¾‘å™¨ä¸»åŒºåŸŸï¼šè°ƒæ•´é¡ºåºå’Œå†…è¾¹è· */ /* .editor-main åŒ…å« Quill ç¼–è¾‘å™¨æœ¬ä½“ï¼Œå®ƒåº”è¯¥ç´§è·Ÿåœ¨ fixed çš„å·¥å…·æ ä¸‹æ–¹ */ .editor-main {
  flex-grow:1;
  padding:15px;
  /* æ¢å¤æ­£å¸¸çš„å†…è¾¹è· */ margin:0;
  /* ç§»é™¤åŸæœ‰å¤–è¾¹è· */ order:2;
  /* ç´§éšå·¥å…·æ ä¹‹å */ /* æ–°å¢ï¼šä¸º fixed çš„å·¥å…·æ ç•™å‡ºç©ºé—´ï¼Œé˜²æ­¢å†…å®¹è¢«é®æŒ¡ */ padding-top:70px;
  /* å‡è®¾å·¥å…·æ é«˜åº¦çº¦ä¸º 50pxï¼Œè¿™é‡Œç•™å‡º 70px ç¡®ä¿å®‰å…¨è¾¹è· */
}
/* ç¼–è¾‘å™¨æœ¬èº«ï¼šè°ƒæ•´æœ€å¤§å®½åº¦ */ #editor {
  max-width:100%;
  margin:0;
  padding:10px;
}
/* é¡¶éƒ¨æ ‡é¢˜å’ŒæŒ‰é’®ï¼šå˜ä¸ºä¸Šä¸‹å †å  */ .content-header {
  flex-direction:column;
  align-items:flex-start;
  gap:10px;
  margin-bottom:15px;
}
/* æ ‡é¢˜åŒºåŸŸï¼šè°ƒæ•´æ ·å¼ */ .header-title h2 {
  font-size:1.2rem;
}
/* å·¥å…·æ æŒ‰é’®ï¼šè°ƒæ•´é—´è·å’Œæ ·å¼ */ #toolbar-quill {
  gap:8px;
  justify-content:flex-start;
  /* æ‰‹æœºç«¯å·¦å¯¹é½æ›´å¸¸è§ */
}
/* å¼¹çª—å†…å®¹ï¼šé€‚åº”å°å±å¹• */ .modal-content {
  width:95%;
  margin:10% auto;
}
}/* ------------------------------------------- */ /* ä¿®æ­£ï¼šéšè—æ–‡å­— (Spoiler) Blotçš„CSS */ /* ------------------------------------------- */ /* æ–°å¢ï¼šç¡®ä¿ modal-active ç±»èƒ½å¤Ÿéšè— Quill å·¥å…·æ ï¼ˆå¦‚æœå®ƒè¢«å…¨å±€æ ·å¼æ§åˆ¶çš„è¯ï¼‰ */ .modal-active #toolbar-quill {
  /* å‡è®¾æ‚¨çš„ Quill å·¥å…·æ ä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å…ƒç´  */ z-index:1;
  /* ç¡®ä¿å®ƒåœ¨ modal ä¸‹é¢ */
}
/* Base style for both modes */ .ql-editor .spoiler-hidden {
  /* é»˜è®¤éšè—æ ·å¼ï¼šä½¿ç”¨ç™½è‰²èƒŒæ™¯ (#fff) é®ç›–é»‘è‰²æ–‡å­—ï¼Œè¾¾åˆ°éšè—æ•ˆæœ */ background-color:#000;
  /* å‡è®¾ç¼–è¾‘å™¨çš„åº•è‰²æ˜¯ç™½è‰² */ color:#000;
  /* æ–‡å­—é¢œè‰²ä¹Ÿè®¾ä¸ºç™½è‰²ï¼Œè¢«èƒŒæ™¯è‰²è¦†ç›– */ padding:0 4px;
  border-radius:2px;
  transition:color 0.3s,background-color 0.3s;
}
/* æ¨¡å¼ 1:å‰§é€æ¨¡å¼ (é¼ æ ‡æ‚¬åœå³æ˜¾ç¤º) */ .ql-editor .spoiler-hidden[data-mode="spoiler"] {
  cursor:pointer;
}
.ql-editor .spoiler-hidden[data-mode="spoiler"]:hover {
  /* æ‚¬åœæ—¶ï¼šå°†æ–‡å­—é¢œè‰²æ”¹ä¸ºé»‘è‰²ï¼ŒèƒŒæ™¯è‰²æ”¹ä¸ºé€æ˜ï¼ˆæˆ–ç™½è‰²ï¼‰ï¼Œæ˜¾ç¤ºæ­£å¸¸æ–‡æœ¬ */ color:#000;
  /* æ–‡å­—é¢œè‰²æ”¹ä¸ºé»‘è‰² */ background-color:transparent;
  /* èƒŒæ™¯è‰²æ”¹ä¸ºé€æ˜æˆ–ç™½è‰² */
}
/* æ¨¡å¼ 2:æš—éª°æ¨¡å¼ (åœ¨ç¼–è¾‘å™¨å†…å§‹ç»ˆéšè—ï¼Œä¸å“åº”æ‚¬åœ) */ .ql-editor .spoiler-hidden[data-mode="secret"] {
  /* æš—éª°æ¨¡å¼ä»ä½¿ç”¨å¼ºçƒˆçš„é¢œè‰²åŒºåˆ†å’Œæç¤ºï¼Œå¹¶ä¿æŒéšè— */ background-color:#6a0000;
  color:#6a0000;
  cursor:default;
  border:1px solid #999;
}
/* è¦†ç›–ç¼–è¾‘å™¨å†…æ‚¬åœè¡Œä¸ºï¼šæš—éª°åœ¨ç¼–è¾‘å™¨é‡Œä¿æŒéšè— */ .ql-editor .spoiler-hidden[data-mode="secret"]:hover {
  color:#6a0000;
  background-color:#6a0000;
}
/* æ–°å¢ï¼šé¡µç ä¸‹æ‹‰èœå•åº•éƒ¨æŒ‰é’®çš„é€šç”¨æ ·å¼ */ .dropdown-footer-btn {
  width:100%;
  padding:10px;
  border:none;
  cursor:pointer;
  text-align:center;
  border-top:1px solid #ddd;
  transition:background-color 0.2s;
  font-size:14px;
}
/* æ–°å¢ï¼šåˆ é™¤å½“å‰é¡µæŒ‰é’®æ ·å¼ (ä½¿ç”¨çº¢è‰²è¡¨ç¤ºå±é™©æ“ä½œ) */ .delete-page-btn {
  background-color:#fff8f8;
  /* æµ…çº¢è‰²èƒŒæ™¯ */ color:#dc3545;
  /* çº¢è‰²æ–‡å­— */ border-radius:0;
  /* ç¡®ä¿é¡¶éƒ¨æ²¡æœ‰åœ†è§’ */
}
.delete-page-btn:hover {
  background-color:#ffeaea;
  /* æ‚¬åœæ—¶é¢œè‰²åŠ æ·± */
}
/* è°ƒæ•´æ–°å¢é¡µé¢çš„æŒ‰é’®æ ·å¼ï¼Œç§»é™¤å…¶é¡¶éƒ¨è¾¹æ¡†ï¼Œç¡®ä¿åˆ é™¤æŒ‰é’®ç´§è´´å…¶ä¸Š */ .page-select-dropdown .add-page-btn {
  /* ç§»é™¤ä¹‹å‰çš„ border-top:1px solid #ddd;
  é¿å…åŒé‡è¾¹æ¡† */ border-top:none;
  border-radius:0 0 8px 8px;
  /* ç¡®ä¿æ–°å¢é¡µé¢æŒ‰é’®ä»ç„¶åœ¨åº•éƒ¨åœ†è§’ */
}
/* ------------------------------------------- */ /* âœ… å·¥å…·æ å’Œç¼–è¾‘å™¨ä¸»ä½“è·ç¦»ã€æŒ‰é’®åç§»å’Œåˆ†ç»„ä¼˜åŒ– */ /* ------------------------------------------- */ /* 1. å‡å°‘ç¼–è¾‘å™¨å’Œå·¥å…·æ ä¹‹é—´çš„ç°è‰²è·ç¦» */ .editor-main {
  flex-grow:1;
  padding:30px;
  display:flex;
  flex-direction:column;
  background-color:#f0f2f5;
  /* å…³é”®ä¿®æ”¹ï¼šå°† 20px å‡å°åˆ° 5pxï¼Œå¹¶ç§»é™¤å·¦å³è¾¹è·ï¼ˆå¦‚æœçˆ¶å®¹å™¨å·²å¤„ç†ï¼‰ */ margin:5px 0;
}
/* 2. æ¸…ç†å’Œä¼˜åŒ– #toolbar-quill å®¹å™¨ */ #toolbar-quill {
  display:flex;
  justify-content:flex-start;
  /* ä¿æŒå·¦å¯¹é½ */ gap:8px;
  /* æŒ‰é’®ç»„ä¹‹é—´çš„é—´è·ï¼Œä» 5px å¢åŠ åˆ° 8px */ flex-wrap:wrap;
}
/* 3. å®ç°å·¥å…·æ æŒ‰é’®æ•´ä½“å‘å³åç§»ï¼ˆä¸ç§»åŠ¨å·¥å…·æ èƒŒæ™¯å’Œè¾¹æ¡†ï¼‰ */ /* å¯¹ç¬¬ä¸€ä¸ªæŒ‰é’®ç»„è®¾ç½® margin-left */ #toolbar-quill .ql-formats:first-child {
  /* å¢åŠ å·¦å¤–è¾¹è·ï¼Œä½¿æ‰€æœ‰æŒ‰é’®æ•´ä½“å‘å³ç§»åŠ¨ */ margin-left:30px;
  /* ä¿æŒæŒ‰é’®ç»„ä¹‹é—´çš„é—´è· */ margin-right:8px;
}
/* 4. æ¸…ç†å’Œç»Ÿä¸€ ql-formats æ ·å¼ */ .ql-toolbar.ql-snow .ql-formats {
  display:flex;
  align-items:center;
  /* ç§»é™¤å†—ä½™çš„ margin-right:35pxï¼Œä½¿ç”¨ #toolbar-quill çš„ gap:8px å³å¯ */ margin-right:0;
}
/* ç¡®ä¿æ’¤å›/å–æ¶ˆæ’¤å›æŒ‰é’®ä¹‹é—´æœ‰å°çš„é—´è· */ #toolbar-quill .ql-formats:first-child button {
  margin-right:3px;
}
/* 5. æ¸…ç†å’Œä¼˜åŒ– #hiddenTextBtn çš„æ ·å¼ */ #toolbar-quill .ql-formats:nth-child(2) {
  /* ä¿æŒ â€œéšè—æ–‡æœ¬â€ æŒ‰é’®åœ¨è‡ªå·±çš„ç»„å†…å‚ç›´å±…ä¸­ */ display:flex;
  align-items:center;
}
#hiddenTextBtn {
  /* ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ª #hiddenTextBtn æ ·å¼å—ï¼Œå¹¶åˆ é™¤é‡å¤çš„å®šä¹‰ */ display:inline-flex;
  align-items:center;
  justify-content:center;
  white-space:nowrap;
  padding:6px 12px;
  /* ç»Ÿä¸€å†…è¾¹è· */ min-width:fit-content;
  font-size:14px;
  border:1px solid #ccc;
  border-radius:4px;
  background-color:#fff;
  color:#000;
  line-height:1.2;
  box-sizing:border-box;
  margin:0;
  /* ç¡®ä¿è‡ªèº«æ²¡æœ‰å¤–éƒ¨è¾¹è· */
}
#hiddenTextBtn:hover {
  background-color:#e6f7ff;
  border-color:#0077cc;
  color:#0077cc;
}
/* ---------- ğŸ“± æ‰‹æœºç«¯ä¼˜åŒ– ---------- */ @media (max-width:768px) {
  .page-container {
  flex-direction:column;
}
.main-content {
  margin-right:0;
  padding:10px;
}
.right-sidebar {
  position:static;
  width:100%;
  height:auto;
  border-left:none;
  padding:10px;
  overflow-y:visible;
}
.editor-container {
  flex-direction:column;
}
.editor-main {
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}
}/* ============ æ–°ç‰ˆå³ä¾§æµ®çª—ï¼ˆå–ä»£åŸå›ºå®šå³æ ï¼‰ ============ */ /* æµ®åŠ¨æŒ‰é’® */ .floating-sidebar-btn {
  position:fixed;
  bottom:20px;
  right:20px;
  width:52px;
  height:52px;
  border-radius:50%;
  background-color:#0077cc;
  color:white;
  border:none;
  box-shadow:0 4px 8px rgba(0,0,0,0.2);
  cursor:pointer;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:9999;
  transition:all 0.3s ease;
}
.floating-sidebar-btn:hover {
  background-color:#005fa3;
  transform:scale(1.05);
}
/* æµ®çª—å†…å®¹ */ .floating-sidebar {
  position:fixed;
  bottom:80px;
  right:20px;
  width:90vw;
  max-width:320px;
  height:70vh;
  background-color:#f7f9fc;
  border-radius:12px;
  box-shadow:0 6px 15px rgba(0,0,0,0.15);
  padding:16px;
  overflow-y:auto;
  z-index:9998;
  transform:translateY(20px);
  opacity:0;
  pointer-events:none;
  transition:all 0.3s ease;
}
/* æ‰“å¼€æ—¶ */ .floating-sidebar.open {
  transform:translateY(0);
  opacity:1;
  pointer-events:all;
}
/* å³ä¸Šè§’å…³é—­æŒ‰é’® */ .floating-sidebar .close-btn {
  position:absolute;
  top:10px;
  right:10px;
  border:none;
  background:none;
  font-size:20px;
  color:#666;
  cursor:pointer;
}
.floating-sidebar .close-btn:hover {
  color:#000;
}
/* æ‰‹æœºç«¯ä¼˜åŒ–ï¼šæŒ‰é’®ç¨å¤§ä¸€ç‚¹ */ @media (max-width:768px) {
  .floating-sidebar-btn {
  width:56px;
  height:56px;
  bottom:15px;
  right:15px;
  font-size:20px;
}
}

  /* ------------------------------------------- */
/* æ‰‹æœºç«¯æ¨¡å¼ï¼šç§»é™¤å³ä¾§å·¥å…·æ ï¼Œæ”¹ä¸ºæµ®çª—æŒ‰é’®æ¨¡å¼ */
/* ------------------------------------------- */
@media (max-width: 768px) {

  /* éšè—åŸå³ä¾§å›ºå®šå·¥å…·æ  */
  .right-sidebar {
    display: none !important;
  }

  /* æ·»åŠ å³ä¸‹è§’æµ®çª—æŒ‰é’® */
  .floating-tool-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background-color: #0077cc;
    color: white;
    font-size: 24px;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
    cursor: pointer;
    z-index: 1001;
    transition: background-color 0.3s ease;
  }

  .floating-tool-btn:hover {
    background-color: #005fa3;
  }

  /* æµ®çª—å¼¹å‡ºé¢æ¿æ ·å¼ */
  .floating-tool-panel {
    position: fixed;
    bottom: 80px;
    right: 20px;
    width: 85%;
    max-width: 360px;
    background-color: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    display: none;
    flex-direction: column;
    padding: 20px;
    animation: slideUp 0.3s ease-out;
  }

  /* æ‰“å¼€æ—¶æ˜¾ç¤º */
  .floating-tool-panel.active {
    display: flex;
  }

  /* åŠ¨ç”»æ•ˆæœ */
  @keyframes slideUp {
    from { transform: translateY(40px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
}

/* âœ… 1ï¸âƒ£ åªå›ºå®šå·¥å…·æ ï¼ˆè€Œä¸æ˜¯æ•´ä¸ªç¼–è¾‘åŒºï¼‰ */
.editor-toolbar-container {
  position: sticky;  /* å·¥å…·æ å›ºå®šåœ¨é¡¶éƒ¨ */
  top: 0;
  z-index: 999;
  background-color: #f0f2f5;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* âœ… 2ï¸âƒ£ ç¼–è¾‘å™¨ä¸»ä½“ä¸è¦å— sticky å½±å“ï¼Œè®©å®ƒæ­£å¸¸æ»šåŠ¨ */
.editor-main {
  flex-grow: 1;
  overflow-y: auto;  /* å…è®¸æ»šåŠ¨ */
  padding: 30px;
  margin: 0;         /* å»æ‰å¤šä½™å¤–è¾¹è·ï¼Œé¿å…ä¸ toolbar å å±‚ */
}

/* âœ… 3ï¸âƒ£ Quill è¾“å…¥åŒºæœ¬èº«éå›ºå®š */
#editor, .ql-container, .ql-editor {
  position: static !important;  /* é˜²æ­¢è·Ÿéš sticky çš„å®¹å™¨å¸é™„ */
}

  /* ============ æ–°ç‰ˆå³ä¾§æµ®çª—ï¼ˆå–ä»£åŸå›ºå®šå³æ ï¼‰ ============ */

/* é»˜è®¤ï¼ˆPC/ç½‘é¡µç‰ˆï¼‰ï¼šéšè—æµ®çª—æŒ‰é’® */
.floating-sidebar-btn {
    display: none; 
}


/* æ‰‹æœºç«¯æ¨¡å¼ï¼ˆæœ€å¤§å®½åº¦ 768pxï¼‰ï¼šè¦†ç›–é»˜è®¤æ ·å¼ï¼Œå®ç°å³ä¾§å‚ç›´å±…ä¸­ */
@media (max-width: 768px) {
    /* éšè—åŸå³ä¾§å›ºå®šå·¥å…·æ  (ä¿ç•™ï¼Œç¡®ä¿ä¸ä¼šäº’ç›¸å¹²æ‰°) */
    .right-sidebar {
      display: none !important;
    }

    /* æµ®çª—æŒ‰é’®çš„å®šä½ */
    .floating-sidebar-btn {
        position: fixed;
        
        /* 1. å®ç°å³ä¾§å¯¹é½ */
        right: 20px; /* è·ç¦»å³ä¾§è¾¹ç¼˜ 20px */
        
        /* 2. å®ç°å‚ç›´å±…ä¸­ */
        top: 50%; /* å®šä½åˆ°å±å¹•å‚ç›´ 50% çš„ä½ç½® */
        transform: translateY(-50%); /* å‘ä¸Šå¹³ç§»è‡ªèº«é«˜åº¦çš„ä¸€åŠï¼Œå®ç°ç²¾ç¡®å±…ä¸­ */
        
        /* ä¿æŒåŸæœ‰å°ºå¯¸å’Œé¢œè‰²ï¼Œå¹¶ç¡®ä¿æ˜¾ç¤º */
        width: 55px;
        height: 55px;
        border-radius: 50%;
        background-color: #0077cc;
        color: white;
        border: none;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
        cursor: pointer;
        display: flex; /* ç¡®ä¿æ˜¾ç¤º */
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-size: 24px;
        transition: all 0.3s ease;
    }

    .floating-sidebar-btn:hover {
        background-color: #005fa3;
        transform: translateY(-50%) scale(1.05); /* å‚ç›´å±…ä¸­çŠ¶æ€ä¸‹çš„æ‚¬åœæ”¾å¤§ */
    }
    
    /* æµ®çª—é¢æ¿çš„å°ºå¯¸è°ƒæ•´ */
    .floating-sidebar {
        position: fixed;
        bottom: auto; 
        
        /* è°ƒæ•´å®½åº¦ */
        width: 70vw;       /* å°†å®½åº¦ä» 85vw è°ƒå°åˆ° 70vw */
        max-width: 280px;  /* å°†æœ€å¤§å®½åº¦ä» 360px è°ƒå°åˆ° 280px */
        
        /* è°ƒæ•´é«˜åº¦ */
        height: 50vh;      /* å°†é«˜åº¦ä» 70vh è°ƒå°åˆ° 50vh */
        
        right: 85px;       /* è·ç¦»æŒ‰é’®ç¨å¾®å·¦ä¾§ä¸€ç‚¹çš„ä½ç½® */
        top: 50%;          /* ä¸æŒ‰é’®åŒæ­¥ï¼Œå®šä½åˆ°å‚ç›´ 50% */
        transform: translateY(-50%); /* å‚ç›´å±…ä¸­ */
        
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        opacity:0; 
        pointer-events:none;
        transition:all 0.3s ease;
        padding: 16px; /* ç¡®ä¿å†…è¾¹è·é€‚ä¸­ */
    }
    
    /* æµ®çª—é¢æ¿æ‰“å¼€æ—¶çš„çŠ¶æ€ */
    .floating-sidebar.open {
        transform: translateY(-50%); /* ä¿æŒå‚ç›´å±…ä¸­ */
        opacity: 1;
        pointer-events: all;
    }

  /* æ ¸å¿ƒä¿®æ”¹ï¼šåœ¨æ‰‹æœºç«¯ï¼Œå¢åŠ â€œåŠ ç²—â€æŒ‰é’®ç»„ä¸â€œéšè—æ–‡æœ¬â€æŒ‰é’®ç»„ä¹‹é—´çš„é—´è· */
    #toolbar-quill .ql-formats:first-child {
        /* ç§»é™¤ PC ç«¯çš„ 30px å·¦è¾¹è·ï¼Œæ‰‹æœºç«¯é€šå¸¸ä¸éœ€è¦æ•´ä½“åç§» */
        margin-left: 20px; 
        
        /* å¢åŠ å³è¾¹è·ä»¥éš”å¼€â€œéšè—æ–‡æœ¬â€æŒ‰é’®ã€‚
           ä¾‹å¦‚ï¼šä½¿ç”¨ 20px é—´è·ä»£æ›¿é»˜è®¤çš„ 8px æˆ– 0px */
        margin-right: 10px; 
    }
    
    /* ç¡®ä¿å·¥å…·æ æŒ‰é’®å®¹å™¨æœ¬èº«èƒ½æ­£å¸¸æ’åˆ— */
    #toolbar-quill {
        gap: 10px; /* ä¿æŒæŒ‰é’®ç»„ä¹‹é—´çš„é»˜è®¤é—´è· */
        justify-content: flex-start;
    }
}

    /* ====== è‡ªå®šä¹‰ç‰¹æ•ˆç®¡ç†é¡µ ====== */
    .custom-effect-layout {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }

    .custom-effect-list-panel {
      flex: 2;
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      max-height: 70vh;
      overflow-y: auto;
    }

    .custom-effect-editor-panel {
      flex: 3;
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      font-size: 0.9rem;
      color: #444;
    }

    .custom-effect-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .custom-effect-item {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color .15s;
    }

    .custom-effect-item:hover {
      background: #f5f9ff;
    }

    .custom-effect-item.active {
      background: #e6f3ff;
    }

    .custom-effect-name {
      font-weight: bold;
    }

    .custom-effect-meta {
      font-size: 0.8rem;
      color: #777;
    }

    .custom-effect-empty-tip {
      text-align: center;
      color: #999;
      margin-top: 20px;
    }

    .custom-effect-editor-panel label {
      display: block;
      margin-top: 8px;
      margin-bottom: 4px;
      font-size: 0.85rem;
      font-weight: bold;
      color: #555;
    }

    .custom-effect-editor-panel input,
    .custom-effect-editor-panel textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .custom-effect-editor-panel textarea {
      min-height: 220px;
      font-family: Consolas, Menlo, Monaco, monospace;
    }

    .custom-effect-help {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      background: #f8f9fa;
      font-size: 0.85rem;
      color: #444;
    }

    .custom-effect-sample {
      margin-top: 6px;
      background: #272822;
      color: #f8f8f2;
      padding: 6px;
      border-radius: 4px;
      font-size: 0.8rem;
      overflow: auto;
      white-space: pre;
    }

    .custom-effect-editor-buttons {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .custom-effect-editor-buttons .danger {
      background-color: #dc3545;
      color: #fff;
    }

    .custom-effect-editor-buttons .danger:hover {
      background-color: #c82333;
    }

    /* ====== ç¼–è¾‘å™¨é¡¶éƒ¨è‡ªå®šä¹‰ç‰¹æ•ˆä¸‹æ‹‰ ====== */
    .custom-effect-dropdown {
      position: relative;
      display: inline-block;
      margin-left: 8px;
    }

    .custom-effect-dropdown-panel {
      position: absolute;
      top: 110%;
      right: 0;
      width: 230px;
      max-height: 260px;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 8px;
      z-index: 50;
    }

    .custom-effect-dropdown-panel.hidden {
      display: none;
    }

    .custom-effect-dropdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .custom-effect-dropdown-header h4 {
      margin: 0;
      font-size: 0.9rem;
    }

    .custom-effect-dropdown-header .close-btn {
      border: none;
      background: none;
      font-size: 16px;
      cursor: pointer;
      color: #666;
    }

    .custom-effect-dropdown-header .close-btn:hover {
      color: #000;
    }

    .custom-effect-dropdown-list {
      list-style: none;
      margin: 0;
      padding: 0;
      max-height: 180px;
      overflow-y: auto;
    }

    .custom-effect-dropdown-list li {
      margin-bottom: 4px;
    }

    .custom-effect-dropdown-list button {
      width: 100%;
      text-align: left;
      border: 1px solid #ddd;
      background: #f9fafb;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
        color: #000 !important;
    }

    .custom-effect-dropdown-list button:hover {
      background: #e6f7ff;
      border-color: #0077cc;
    }

    .custom-effect-dropdown-footer {
      margin-top: 6px;
      text-align: right;
    }

    .custom-effect-dropdown-footer button {
      font-size: 0.8rem;
    }

    @media (max-width: 768px) {
      .custom-effect-layout {
        flex-direction: column;
      }
      .custom-effect-list-panel,
      .custom-effect-editor-panel {
        max-height: none;
      }
    }

  .effect-toolbar-group {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.effect-bg-btn {
  padding: 6px 10px;
  border-radius: 4px;
  border: 1px solid #ced4da;
  background-color: #fff;
  cursor: pointer;
  font-size: 0.9rem;
}

.effect-bg-btn:hover {
  background-color: #e6f7ff;
  border-color: #0077cc;
}

.bg-panel {
  margin-top: 16px;
  padding: 10px;
  border-radius: 8px;
  background-color: #f1f3f5;
  border: 1px solid #dee2e6;
}

.bg-panel-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 10px;
}

.bg-panel .back-button {
  width: 100%;
  justify-content: center;
}

.bg-danger-btn {
  border-color: #dc3545;
  color: #dc3545;
}

.bg-danger-btn:hover {
  background-color: #dc3545;
  color: #fff;
}

.bg-image-list {
  list-style: none;
  padding: 0;
  margin: 0;
  max-height: 200px;
  overflow-y: auto;
  border-radius: 6px;
  border: 1px dashed #ced4da;
  background-color: #fff;
}

.bg-image-item {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  border-bottom: 1px solid #f1f3f5;
  cursor: pointer;
}

.bg-image-item:last-child {
  border-bottom: none;
}

.bg-image-thumb {
  width: 40px;
  height: 40px;
  border-radius: 4px;
  object-fit: cover;
  margin-right: 8px;
  border: 1px solid #dee2e6;
}

.bg-image-name {
  flex: 1;
  font-size: 0.9rem;
  color: #333;
}

.bg-image-item.active {
  background-color: #e6f7ff;
}

.bg-image-empty {
  padding: 10px;
  font-size: 0.9rem;
  color: #999;
}

.bg-panel-tip {
  margin-top: 6px;
  font-size: 0.8rem;
  color: #666;
}

/* è¡Œé‡Œçš„èµ·å§‹/ç»“æŸæ ‡ç­¾ + è½¬åœºè¡Œ */
.bg-tag {
  display: inline-block;
  margin-left: 4px;
  padding: 2px 4px;
  border-radius: 4px;
  font-size: 0.8rem;
}

.bg-tag-start {
  background-color: #e3f2fd;
  color: #0d47a1;
}

.bg-tag-end {
  background-color: #fce4ec;
  color: #880e4f;
}

.bg-transition-item {
  padding: 4px 8px;
  font-size: 0.9rem;
  color: #6c757d;
  text-align: center;
}

  /* âœ… æç¤ºæ ï¼šé«˜äº® + é—ªçƒä¸¤æ¬¡ */
.effect-toolbar-left{
  position: relative;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

#effect-selected-line-label.tip-highlight{
  background: #fff3cd;
  color: #6c5200;
  padding: 2px 6px;
  border-radius: 6px;
}

@keyframes tipBlinkTwice {
  0%   { box-shadow: 0 0 0 rgba(255,193,7,0); filter: none; }
  50%  { box-shadow: 0 0 0 4px rgba(255,193,7,0.35); filter: brightness(1.05); }
  100% { box-shadow: 0 0 0 rgba(255,193,7,0); filter: none; }
}

#effect-selected-line-label.tip-blink{
  animation: tipBlinkTwice 0.45s ease-in-out 2;
}

/* âœ… â€œå–æ¶ˆé«˜äº®â€æŒ‰é’®ï¼šé»˜è®¤ä¸æ˜¾ç¤ºï¼Œhover æ—¶å‡ºç°ï¼ˆä¸æŒ¤å å¸ƒå±€ï¼‰ */
.tip-cancel-highlight-btn{
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  display: none;

  padding: 3px 8px;
  border: 1px solid #ced4da;
  background: #fff;
  border-radius: 6px;
  font-size: 12px;
  color: #555;
  cursor: pointer;
}

.effect-toolbar-left.tip-highlight-active:hover .tip-cancel-highlight-btn{
  display: inline-flex;
}

.tip-cancel-highlight-btn:hover{
  background: #f1f3f5;
}


</style>
  
<body>
  <div class="page-container">

    <aside class="sidebar-nav" id="sidebar">
      <a href="https://zhidianworld.com/write/" class="nav-link">
        <div class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <path d="M12 12V4h6l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-2h12a2 2 0 0 0 2-2V12z" />
          </svg>
        </div>
        <span class="nav-text">ä½œå“åˆ—è¡¨</span>
      </a>

      <a href="https://zhidianworld.com/pictureshare/" class="nav-link">
        <div class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9V9h2v8zm4 0h-2V9h2v8z" />
          </svg>
        </div>
        <span class="nav-text">å…±äº«ç´ æåº“</span>
      </a>

      <a href="https://zhidianworld.com/usercenter/" class="nav-link">
        <div class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
          </svg>
        </div>
        <span class="nav-text">ä¸ªäººä¸­å¿ƒ</span>
      </a>

      <a href="https://zhidianworld.com/effect/" class="nav-link active">
        <div class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L15 8l6 .5-4.5 4 1 6-5-3-5 3 1-6L3 8.5 9 8z" />
          </svg>
        </div>
        <span class="nav-text">æ¸²æŸ“ç‰¹æ•ˆ</span>
      </a>

      <a href="https://zhidianworld.com/home/" class="nav-link">
        <div class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h2v-8h-2v8z" />
          </svg>
        </div>
        <span class="nav-text">å®‰ç§‘é˜…è¯»</span>
      </a>

      <a href="#" class="nav-link" id="logout-btn">
        <div class="nav-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"
            fill="currentColor" viewBox="0 0 24 24">
            <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5-5-5zm-8 4H2v2h7v-2zM4 22h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2z" />
          </svg>
        </div>
        <span class="nav-text">é€€å‡ºç™»å½•</span>
      </a>
    </aside>

    <main class="main-content">

      <section id="effect-list-page">
        <div class="content-header">
          <div class="header-left">
            <div class="header-title">
              <h2>é€‰æ‹©ä½œå“ï¼ˆç‰¹æ•ˆç¼–è¾‘ï¼‰(<span id="effect-work-count">0</span>)</h2>
            </div>
          </div>
          <div class="header-right">
            <button id="custom-effect-manage-btn" class="back-button">
              ç®¡ç†è‡ªå®šä¹‰ç‰¹æ•ˆ
            </button>
          </div>
        </div>

        <div id="effect-work-list" class="work-list">
          <p style="text-align:center;color:#999;margin-top:50px;">æ­£åœ¨åŠ è½½ä½œå“...</p>
        </div>
      </section>

      <section id="custom-effect-page" class="hidden">
        <div class="content-header">
          <div class="header-left">
            <button id="custom-effect-back-btn" class="back-button">è¿”å›ç‰¹æ•ˆåˆ—è¡¨</button>
            <div class="header-title">
              <h2>è‡ªå®šä¹‰ç‰¹æ•ˆåˆ—è¡¨</h2>
            </div>
          </div>
          <div class="header-right">
            <button id="custom-effect-new-btn" class="create-button">æ–°å»ºè‡ªå®šä¹‰ç‰¹æ•ˆ</button>
          </div>
        </div>

        <div class="custom-effect-layout">
          <div class="custom-effect-list-panel">
            <ul id="custom-effect-list" class="custom-effect-list"></ul>
            <p id="custom-effect-empty-tip" class="custom-effect-empty-tip">
              æš‚æ— è‡ªå®šä¹‰ç‰¹æ•ˆï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’â€œæ–°å»ºè‡ªå®šä¹‰ç‰¹æ•ˆâ€ã€‚
            </p>
          </div>

          <div id="custom-effect-editor-panel" class="custom-effect-editor-panel hidden">
            
            <h3 id="custom-effect-editor-title">è¯·é€‰æ‹©å·¦ä¾§ç‰¹æ•ˆï¼Œæˆ–ç‚¹å‡»â€œæ–°å»ºè‡ªå®šä¹‰ç‰¹æ•ˆâ€</h3>

            <label for="custom-effect-name-input">ç‰¹æ•ˆåç§°ï¼ˆæ˜¾ç¤ºç”¨ï¼‰ï¼š</label>
            <input id="custom-effect-name-input" type="text" placeholder="ä¾‹å¦‚ï¼šé—ªçƒ+æ‘‡æ™ƒä¸€æ¬¡">

            <label for="custom-effect-key-input">ç‰¹æ•ˆ keyï¼ˆè‹±æ–‡ï¼Œç”¨äºæ ‡è®°ï¼‰ï¼š</label>
            <input id="custom-effect-key-input" type="text" placeholder="ä¾‹å¦‚ï¼šflashShakeOnce">

            <label for="custom-effect-code-input">ç‰¹æ•ˆä»£ç ï¼ˆJSï¼‰ï¼š</label>
            <textarea id="custom-effect-code-input"></textarea>

            <div class="custom-effect-help">
              ä¸ä¼šå†™çš„ä»£ç å¯ä»¥é—® AIã€‚ï¼ˆè¯·åŠ¡å¿…æŠŠä»¥ä¸‹ä»£ç å¤åˆ¶ç»™AIï¼Œè®©å®ƒç…§ç€è¿™ä¸ªæ ¼å¼åšå‡ºä»£ç ï¼‰
              <div class="custom-effect-sample">
/**
 * ã€ŒåŠ è½½ã€è‡ªå®šä¹‰ç‰¹æ•ˆç¤ºä¾‹
 * ç³»ç»Ÿä¼šæŠŠå½“å‰å¥å­çš„ DOM å…ƒç´ ä¼ è¿›æ¥ï¼Œåªéœ€å®ç° applyEffect(targetEl)
 */
function applyEffect(targetEl) {
  if (!targetEl) return;

  // é˜²æ­¢åŒä¸€å¥è¯è¢«å¤šæ¬¡åº”ç”¨è¿™ä¸ªç‰¹æ•ˆ
  if (targetEl.dataset.customLoadingApplied === '1') {
    return;
  }
  targetEl.dataset.customLoadingApplied = '1';

  // è®°å½•åŸå§‹å†…å®¹
  const originalHtml = targetEl.innerHTML;

  // å¤–å±‚å®¹å™¨ï¼šåŒ…ä½â€œåŠ è½½ UI + åŸæ–‡æœ¬â€
  const wrapper = document.createElement('span');
  wrapper.style.display = 'inline-block';
  wrapper.style.position = 'relative';
  wrapper.style.verticalAlign = 'baseline';

  // ================== é¡¶éƒ¨ï¼šè¿›åº¦æ¡ + ç™¾åˆ†æ¯” ==================
  const loadingBox = document.createElement('div');
  loadingBox.style.display = 'flex';
  loadingBox.style.flexDirection = 'column';
  loadingBox.style.alignItems = 'center';
  loadingBox.style.justifyContent = 'center';
  loadingBox.style.fontSize = '0.85em';

  // è¿›åº¦æ¡å¤–æ¡†
  const barOuter = document.createElement('div');
  barOuter.style.position = 'relative';
  barOuter.style.width = '140px';
  barOuter.style.height = '8px';
  barOuter.style.borderRadius = '999px';
  barOuter.style.overflow = 'hidden';
  barOuter.style.border = '1px solid rgba(255, 255, 255, 0.7)';
  barOuter.style.background = 'rgba(255,255,255,0.08)';
  barOuter.style.boxSizing = 'border-box';

  // è¿›åº¦æ¡å†…éƒ¨æ¡
  const barInner = document.createElement('div');
  barInner.style.width = '0%';
  barInner.style.height = '100%';
  barInner.style.borderRadius = '999px';
  barInner.style.background = 'linear-gradient(90deg, #4ade80, #22d3ee)';
  barInner.style.transition = 'width 0.08s linear';

  barOuter.appendChild(barInner);

  // ç™¾åˆ†æ¯”æ–‡å­—
  const percentText = document.createElement('div');
  percentText.style.marginTop = '4px';
  percentText.style.textAlign = 'center';
  percentText.style.opacity = '0.9';
  percentText.style.userSelect = 'none';
  percentText.textContent = 'åŠ è½½ä¸­â€¦ 0%';

  loadingBox.appendChild(barOuter);
  loadingBox.appendChild(percentText);

  // ================== åº•éƒ¨ï¼šåŸæ–‡æœ¬ï¼ˆå…ˆéšè—ï¼Œåé¢æ·¡å…¥ï¼‰ ==================
  const originalSpan = document.createElement('span');
  originalSpan.innerHTML = originalHtml; // ä¿ç•™åŸæœ‰æ ‡ç­¾/æ ·å¼
  originalSpan.style.display = 'inline-block';
  originalSpan.style.marginTop = '6px';
  originalSpan.style.opacity = '0';
  originalSpan.style.transition = 'opacity 0.6s ease';

  // ================== æ‹¼è£…ç»“æ„ ==================
  targetEl.innerHTML = '';
  wrapper.appendChild(loadingBox);
  wrapper.appendChild(originalSpan);
  targetEl.appendChild(wrapper);

  // ================== è¿›åº¦é€»è¾‘ ==================
  let progress = 0;
  const totalDuration = 2000; // æ€»åŠ è½½æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
  const step = 40;            // å®šæ—¶å™¨é—´éš”ï¼ˆæ¯«ç§’ï¼‰
  const inc = (100 * step) / totalDuration;

  const timer = setInterval(() => {
    progress += inc;
    if (progress >= 100) {
      progress = 100;
    }

    const showPercent = Math.round(progress);
    barInner.style.width = showPercent + '%';
    percentText.textContent = 'åŠ è½½ä¸­â€¦ ' + showPercent + '%';

    if (progress >= 100) {
      clearInterval(timer);

      // è¿›åº¦åˆ° 100%ï¼šæ”¹æˆâ€œåŠ è½½æˆåŠŸâ€
      percentText.textContent = 'åŠ è½½æˆåŠŸ';

      // ç¨ä½œåœé¡¿ï¼Œç„¶åï¼šä¸Šé¢çš„åŠ è½½ UI æ·¡å‡ºï¼Œä¸‹é¢çš„åŸæ–‡æœ¬æ·¡å…¥
      setTimeout(() => {
        loadingBox.style.transition = 'opacity 0.6s ease';
        loadingBox.style.opacity = '0';
        originalSpan.style.opacity = '1';

        // åŠ¨ç”»ç»“æŸåå¯ä»¥é€‰æ‹©æŠŠ loadingBox ä» DOM ä¸­ç§»é™¤
        const cleanup = () => {
          loadingBox.removeEventListener('transitionend', cleanup);
          if (loadingBox.parentNode) {
            loadingBox.parentNode.removeChild(loadingBox);
          }
        };
        loadingBox.addEventListener('transitionend', cleanup);

        // å…œåº•ï¼šé˜²æ­¢æŸäº›æµè§ˆå™¨ä¸è§¦å‘ transitionend
        setTimeout(() => {
          if (loadingBox.parentNode) {
            loadingBox.parentNode.removeChild(loadingBox);
          }
        }, 900);
      }, 400); // â€œåŠ è½½æˆåŠŸâ€ åœç•™ 0.4s å†å¼€å§‹æ·¡å‡º
    }
  }, step);
}
              </div>
            </div>

            <div class="custom-effect-editor-buttons">
              <button id="custom-effect-save-btn" class="create-button">ä¿å­˜è‰ç¨¿</button>
              <button id="custom-effect-delete-btn" class="back-button danger">åˆ é™¤å½“å‰ç‰¹æ•ˆ</button>
            </div>
          </div>
        </div>
      </section>

      
      <section id="effect-editor-page" class="hidden">
        <div class="content-header">
          <div class="header-left">
            <button id="effect-back-btn" class="back-button">è¿”å›ä½œå“åˆ—è¡¨</button>
            <div class="header-title">
              <h2>ç‰¹æ•ˆç¼–è¾‘ï¼š<span id="effect-editor-title"></span></h2>
            </div>
          </div>
          <div class="header-right">
            <button id="effect-preview-btn" class="back-button">é¢„è§ˆç‰¹æ•ˆ</button>
            <button id="effect-save-draft-btn" class="create-button">ä¿å­˜ç‰¹æ•ˆè‰ç¨¿</button>
            <button id="effect-publish-btn" class="create-button">å‘å¸ƒç‰¹æ•ˆ</button>
          </div>
        </div>

        <div class="effect-toolbar">
  <div class="effect-toolbar-left">
    <!-- è¿™ä¸ªä½ç½®ä»¥åå°±æ˜¯â€œæç¤ºè¡Œâ€ -->
    <span id="effect-toolbar-tip-prefix">å½“å‰é€‰ä¸­è¡Œï¼š</span>
    <span id="effect-selected-line-label">æ— </span>
  </div>

  <div class="effect-toolbar-right">
    <span id="effect-insert-label" style="margin-right:8px;">æ’å…¥ç‰¹æ•ˆï¼š</span>

    <!-- æ–‡å­—ç‰¹æ•ˆæŒ‰é’®ç»„ -->
    <div id="text-effect-toolbar-group" class="effect-toolbar-group">
      <button class="effect-btn" data-effect="shake">éœ‡åŠ¨</button>
      <button class="effect-btn" data-effect="flash">é—ªçƒ</button>
      <button class="effect-btn" data-effect="fade">æ·¡å…¥æ·¡å‡º</button>
      <button class="effect-btn" data-effect="highlight">é«˜äº®</button>

      <!-- âœ… ä¿ç•™è‡ªå®šä¹‰ç‰¹æ•ˆä¸‹æ‹‰ -->
      <div class="custom-effect-dropdown">
        <button id="custom-effect-toggle-btn" type="button">
          è‡ªå®šä¹‰ç‰¹æ•ˆ â–¾
        </button>
        <div id="custom-effect-dropdown-list" class="custom-effect-dropdown-list hidden">
          <!-- è¿™é‡Œç”± JS å¡«å……è‡ªå®šä¹‰ç‰¹æ•ˆæŒ‰é’® -->
        </div>
      </div>

      <button id="effect-remove-btn">ç§»é™¤ç‰¹æ•ˆ</button>
    </div>

    <!-- èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆæŒ‰é’®ç»„ï¼ˆé»˜è®¤éšè—ï¼Œåœ¨â€œç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆâ€æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
    <div id="bg-effect-toolbar-group" class="effect-toolbar-group hidden">
      <button class="effect-bg-btn" data-bg-effect="crossfade">äº¤å‰æ·¡å…¥æ·¡å‡º</button>
      <button class="effect-bg-btn" data-bg-effect="matrix">çŸ©é˜µ</button>
      <button class="effect-bg-btn" data-bg-effect="ink">å¢¨æŸ“</button>
    </div>
  </div>
</div>

        <div class="effect-editor-layout">
          <div class="effect-line-panel">
            <ul id="effect-line-list" class="effect-line-list">
              </ul>
          </div>
          <div class="effect-preview-panel">
             <h3>è¯´æ˜ / å°æç¤º</h3>
  <p id="effect-tip-text">
    ã€Œç¼–è¾‘æ–‡å­—ç‰¹æ•ˆã€æ¨¡å¼ï¼šç‚¹å‡»å·¦ä¾§å¥å­ï¼Œå†åœ¨ä¸Šæ–¹æ’å…¥ç‰¹æ•ˆã€‚<br>
    ã€Œç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆã€æ¨¡å¼ï¼šå…ˆåœ¨ä¸‹æ–¹èƒŒæ™¯å›¾åº“é€‰æ‹©å›¾ç‰‡ï¼Œå†ä¾æ¬¡ç‚¹èµ·å§‹å¥ / ç»“æŸå¥ã€‚
  </p>

  <!-- âœ… æ–°å¢ï¼šèƒŒæ™¯å›¾åº“ä¸Šä¼ é¢æ¿ -->
  <div id="bg-panel" class="bg-panel hidden">
    <h4>èƒŒæ™¯å›¾åº“ä¸Šä¼ </h4>

    <div class="bg-panel-actions">
      <button id="bg-upload-local-btn" class="back-button">æœ¬åœ°ä¸Šä¼ </button>
      <button id="bg-add-from-shared-btn" class="back-button" disabled>
        ä»å…±äº«å›¾åº“ä¸­æ·»åŠ ï¼ˆå¼€å‘ä¸­ï¼‰
      </button>
      <button id="bg-remove-image-btn" class="back-button bg-danger-btn">
        ç§»é™¤
      </button>
      <input type="file" id="bg-upload-input" accept="image/*" style="display:none;">
    </div>

    <ul id="bg-image-list" class="bg-image-list">
      <li class="bg-image-empty">æš‚æ— èƒŒæ™¯å›¾ç‰‡ï¼Œè¯·å…ˆæœ¬åœ°ä¸Šä¼ ã€‚</li>
    </ul>

    <p class="bg-panel-tip">
      ç‚¹å‡»ä¸Šæ–¹å›¾ç‰‡æ¡ç›®æ¥é€‰æ‹©è¦åº”ç”¨çš„èƒŒæ™¯ã€‚
    </p>
  </div>

  <h4>å½“å‰ç‰¹æ•ˆé…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰</h4>
  <pre id="effect-debug-json">{}</pre>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- â­ ç‰¹æ•ˆç¼–è¾‘å™¨ä¸“ç”¨æ ·å¼ï¼ˆå…¨å±€å¸ƒå±€ä»ç”¨ write çš„ CSSï¼‰ -->
  <style>
    .hidden { display:none !important; }

    .effect-toolbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 15px;
      margin-bottom:10px;
      background:#fff;
      border-radius:8px;
      box-shadow:0 1px 3px rgba(0,0,0,0.08);
      gap:10px;
      flex-wrap:wrap;
    }
    .effect-toolbar-left { font-size:0.9rem; color:#555; }
    .effect-toolbar-right { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }

    .effect-btn {
      padding:6px 10px;
      border-radius:5px;
      border:1px solid #0077cc;
      background:#e6f3ff;
      color:#0077cc;
      cursor:pointer;
      font-size:0.9rem;
    }
    .effect-btn:hover {
      background:#0077cc;
      color:#fff;
    }

    .effect-editor-layout {
      display:flex;
      gap:20px;
      margin-top:10px;
    }
    .effect-line-panel {
      flex:3;
      background:#fff;
      border-radius:8px;
      padding:10px 0;
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
      max-height:70vh;
      overflow-y:auto;
    }
    .effect-preview-panel {
      flex:2;
      background:#fff;
      border-radius:8px;
      padding:15px;
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
      font-size:0.9rem;
      color:#444;
    }

    .effect-line-list {
      list-style:none;
      margin:0;
      padding:0;
    }
    .effect-line-item {
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:6px 12px;
      border-bottom:1px solid #f0f0f0;
      cursor:pointer;
      transition:background-color .15s;
    }
    .effect-line-item:hover {
      background:#f5f9ff;
    }
    .effect-line-item.selected {
      background:#e6f3ff;
    }
    .effect-line-num {
      width:40px;
      flex-shrink:0;
      text-align:right;
      font-size:0.8rem;
      color:#999;
      user-select:none;
    }
    .effect-line-text {
      flex:1;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:0.95rem;
    }
    .effect-line-tags {
      flex-shrink:0;
      min-width:80px;
      text-align:right;
      font-size:0.8rem;
      color:#666;
    }
    .effect-tag {
      display:inline-block;
      padding:2px 6px;
      border-radius:4px;
      margin-left:4px;
      background:#ffe9b3;
      color:#a66b00;
    }

    .effect-debug-json {
      max-height:260px;
      overflow:auto;
      background:#f8f9fa;
      border-radius:6px;
      padding:8px;
      font-size:0.8rem;
      line-height:1.4;
    }

    /* â­ ç®€å•å‡ ç§ç‰¹æ•ˆåŠ¨ç”»ï¼ˆé¢„è§ˆç”¨ï¼‰ */
    .effect-shake {
      animation: effect-shake .25s infinite alternate;
    }
    @keyframes effect-shake {
      from { transform:translateX(-1px); }
      to   { transform:translateX(2px); }
    }

    .effect-flash {
      animation: effect-flash .6s infinite;
    }
    @keyframes effect-flash {
      0%   { background-color:transparent; }
      50%  { background-color:#fff3cd; }
      100% { background-color:transparent; }
    }

    .effect-fade {
      animation: effect-fade 1.2s forwards;
    }
    @keyframes effect-fade {
      from { opacity:0; transform:translateY(4px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .effect-highlight {
      animation: effect-highlight 1s forwards;
    }
    @keyframes effect-highlight {
      from { background:#fff3cd; }
      to   { background:transparent; }
    }

    /* æ‰‹æœºç«¯ç®€å•é€‚é… */
    @media (max-width: 768px) {
      .effect-editor-layout { flex-direction:column; }
      .effect-preview-panel { order:-1; }
    }

    .work-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.work-bg-button {
  background-color: #6c757d;
}

.work-bg-button:hover {
  background-color: #545b62;
}

  </style>

  <!-- â­ JSï¼šä½œå“åˆ—è¡¨ + ç‰¹æ•ˆç¼–è¾‘é€»è¾‘ -->
  <script>
    // å’Œ write ä¿æŒä¸€è‡´çš„ API åœ°å€
    const API_BASE_URL = 'https://api.anchorx.ca/api/works';
     const EFFECT_API_BASE_URL = 'https://api.anchorx.ca/api/effects'; // â­ æ–°å¢è¿™ä¸€è¡Œ
      const IMGBB_API_KEY = '040dbc9e6e680f321e09d9e05f447094';
    const WORK_UPLOAD_URL = 'https://api.anchorx.ca/api/works/upload';

    // ç”Ÿæˆå¸¦ Authorization çš„è¯·æ±‚å¤´
    function authHeaders(json) {
      const h = { 'Authorization': 'Bearer ' + (localStorage.getItem('token') || '') };
      if (json) h['Content-Type'] = 'application/json';
      return h;
    }

    // Delta -> çº¯æ–‡æœ¬ï¼ˆç”¨äºè‡ªåŠ¨æŒ‰è¡Œæ‹†ï¼‰
    function deltaToPlainText(delta) {
      if (!delta || typeof delta !== 'object' || !Array.isArray(delta.ops)) return '';
      let text = '';
      delta.ops.forEach(op => {
        if (typeof op.insert === 'string') text += op.insert;
      });
      return text;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const listPage = document.getElementById('effect-list-page');
      const editorPage = document.getElementById('effect-editor-page');
      const workListEl = document.getElementById('effect-work-list');
      const workCountEl = document.getElementById('effect-work-count');

      const backBtn = document.getElementById('effect-back-btn');
      const editorTitleEl = document.getElementById('effect-editor-title');

      const lineListEl = document.getElementById('effect-line-list');
      const selectedLineLabel = document.getElementById('effect-selected-line-label');
      const debugJsonEl = document.getElementById('effect-debug-json');

      const previewBtn = document.getElementById('effect-preview-btn');
      const saveDraftBtn = document.getElementById('effect-save-draft-btn');
      const publishBtn = document.getElementById('effect-publish-btn');
      const removeEffectBtn = document.getElementById('effect-remove-btn');

      // ====== æ¨¡å¼ / èƒŒæ™¯å›¾åº“ç›¸å…³ ======
let currentEffectMode = 'text'; // 'text' | 'background'

const effectToolbarTipPrefix = document.getElementById('effect-toolbar-tip-prefix');
const effectInsertLabel      = document.getElementById('effect-insert-label');
const textEffectGroup        = document.getElementById('text-effect-toolbar-group');
const bgEffectGroup          = document.getElementById('bg-effect-toolbar-group');
const bgPanel                = document.getElementById('bg-panel');

const bgUploadLocalBtn   = document.getElementById('bg-upload-local-btn');
const bgUploadInput      = document.getElementById('bg-upload-input');
const bgAddFromSharedBtn = document.getElementById('bg-add-from-shared-btn');
const bgRemoveImageBtn   = document.getElementById('bg-remove-image-btn');
const bgImageListEl      = document.getElementById('bg-image-list');

      const bgBindingListEl    = document.getElementById('bg-binding-list');      // â­ æ–°å¢
const bgTransitionListEl = document.getElementById('bg-transition-list');   // â­ æ–°å¢


// èƒŒæ™¯ç›¸å…³æ•°æ®ç»“æ„
let bgImages = [];      // [{ id, name, url }]
let bgBindings = [];    // [{ imageId, imageName, startLine, endLine }]
let bgTransitions = []; // [{ fromLine, toLine, effectType }]

let bgSelectionPhase = 'idle'; // 'idle' | 'chooseStart' | 'chooseEnd' | 'chooseTransitionEnd'
let currentBgImageId   = null;
let currentBgImageName = '';
let bgTempStartLine    = null;
let currentTransitionEffectType = null;
let bgImageAutoId = 1;

      // â­ æ–°å¢ï¼šè‡ªå®šä¹‰ç‰¹æ•ˆç®¡ç†é¡µ DOM
      const customEffectPage = document.getElementById('custom-effect-page');
      const customEffectManageBtn = document.getElementById('custom-effect-manage-btn');
      const customEffectBackBtn = document.getElementById('custom-effect-back-btn');
      const customEffectNewBtn = document.getElementById('custom-effect-new-btn');
      const customEffectListEl = document.getElementById('custom-effect-list');
      const customEffectEmptyTip = document.getElementById('custom-effect-empty-tip');
      const customEffectEditorTitle = document.getElementById('custom-effect-editor-title');
      const customEffectNameInput = document.getElementById('custom-effect-name-input');
      const customEffectKeyInput = document.getElementById('custom-effect-key-input');
      const customEffectCodeInput = document.getElementById('custom-effect-code-input');
      const customEffectSaveBtn = document.getElementById('custom-effect-save-btn');
      const customEffectEditorPanel = document.getElementById('custom-effect-editor-panel'); // â­ æ–°å¢
      const customEffectDeleteBtn = document.getElementById('custom-effect-delete-btn');

      // â­ æ–°å¢ï¼šç¼–è¾‘å™¨é¡¶éƒ¨è‡ªå®šä¹‰ç‰¹æ•ˆä¸‹æ‹‰ DOM
      const customEffectToggleBtn = document.getElementById('custom-effect-toggle-btn');
      const customEffectDropdownPanel = document.getElementById('custom-effect-dropdown-panel');
      const customEffectDropdownClose = document.getElementById('custom-effect-dropdown-close');
      const customEffectDropdownList = document.getElementById('custom-effect-dropdown-list');
      const customEffectOpenManageBtn = document.getElementById('custom-effect-open-manage-btn');

      let currentWorkId = null;
      let currentLines = [];         // æ‰€æœ‰è¡Œæ–‡æœ¬ï¼ˆåŒ…å«ç©ºè¡Œï¼‰
      let rawToEffectiveIndex = [];  // åŸå§‹è¡Œå· -> â€œé˜…è¯»ç«¯å¥å­ç¼–å·â€ï¼ˆç©ºè¡Œä¸º nullï¼‰
      let selectedLineIndex = null;  // å½“å‰é€‰ä¸­è¡Œï¼ˆæŒ‰â€œæœ‰æ•ˆå¥å­ç¼–å·â€è®¡æ•°ï¼‰
      let effectsDraft = [];         // [{ lineIndex, effectType }]ï¼ŒlineIndex å­˜çš„æ˜¯â€œæœ‰æ•ˆå¥å­ç¼–å·â€
      let isPreviewing = false;


       // â­ æ–°å¢ï¼šè‡ªå®šä¹‰ç‰¹æ•ˆçŠ¶æ€
      let customEffects = [];
      let currentCustomEffectId = null;
      const DEFAULT_SAMPLE_CODE =
`/**
 * çº¦å®šï¼šç³»ç»Ÿå°†æ¥ä¼šæŠŠå½“å‰å¥å­çš„ DOM å…ƒç´ ä¼ å…¥è¿™ä¸ªå‡½æ•°
 * ä½ åªéœ€è¦å®ç° applyEffect(targetEl) å³å¯
 */
function applyEffect(targetEl) {
  // ç¤ºä¾‹ï¼šç»™å¥å­åŠ ä¸Šã€Œeffect-shakeã€ç±»ï¼Œè®©å®ƒæ™ƒåŠ¨ä¸€ä¸‹
  targetEl.classList.add('effect-shake');
  setTimeout(() => {
    targetEl.classList.remove('effect-shake');
  }, 600);
}`;

      /* ---------- ä½œå“ç›¸å…³ ---------- */

      async function fetchMyWorks() {
        try {
          const res = await fetch(API_BASE_URL, { headers: authHeaders(false) });
          if (res.status === 401) {
            alert('ç™»å½•å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•');
            window.location.href = 'https://zhidianworld.com/login/';
            return [];
          }
          if (!res.ok) {
            const j = await res.json().catch(() => ({}));
            alert('è·å–ä½œå“å¤±è´¥ï¼š' + (j.message || res.status));
            return [];
          }
          return await res.json();
        } catch (e) {
          console.error(e);
          alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½ä½œå“');
          return [];
        }
      }

      async function loadWorkList() {
  workListEl.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">æ­£åœ¨åŠ è½½ä½œå“...</p>';
  const works = await fetchMyWorks();
  if (!works || works.length === 0) {
    workListEl.innerHTML = '<p style="text-align:center;color:#999;margin-top:50px;">æš‚æ— ä½œå“ã€‚</p>';
    workCountEl.textContent = '0';
    return;
  }

  workListEl.innerHTML = '';
  works.forEach(w => {
    const div = document.createElement('div');
    div.className = 'work-item-wrapper';
    div.dataset.id = w._id;
    div.innerHTML = `
      <div class="work-item">
        <div class="work-info">
          <div class="work-date">${new Date(w.updatedAt).toLocaleString()}</div>
          <div class="work-details">
            <span class="work-title">${w.title}</span>
          </div>
        </div>

        <div class="work-actions">
          <button class="create-button" data-action="edit-text-effects">
            ç¼–è¾‘æ–‡å­—ç‰¹æ•ˆ
          </button>
          <button class="create-button work-bg-button" data-action="edit-bg-effects">
            ç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆ
          </button>
        </div>
      </div>
    `;
    workListEl.appendChild(div);
  });
  workCountEl.textContent = String(works.length);
}


      workListEl.addEventListener('click', async e => {
  const textBtn = e.target.closest('[data-action="edit-text-effects"]');
  const bgBtn   = e.target.closest('[data-action="edit-bg-effects"]');
  const btn = textBtn || bgBtn;
  if (!btn) return;

  const wrapper = btn.closest('.work-item-wrapper');
  if (!wrapper) return;
  const id = wrapper.dataset.id;

  const mode = bgBtn ? 'background' : 'text';
  await enterEffectEditor(id, mode);
});

      /* ---------- è¿›å…¥ç‰¹æ•ˆç¼–è¾‘å™¨ ---------- */

      async function fetchWorkById(id) {
        try {
          const res = await fetch(API_BASE_URL + '/' + id, { headers: authHeaders(false) });
          if (!res.ok) {
            throw new Error('åŠ è½½å¤±è´¥');
          }
          return await res.json();
        } catch (e) {
          console.error(e);
          alert('åŠ è½½ä½œå“å¤±è´¥');
          return null;
        }
      }

      async function enterEffectEditor(workId, mode = 'text') {
        const work = await fetchWorkById(workId);
        if (!work) return;

        currentWorkId = workId;
        setEditorMode(mode);
        editorTitleEl.textContent = work.title || '';
        // è¯»å–å·²æœ‰è‰ç¨¿/å·²å‘å¸ƒç‰¹æ•ˆï¼ˆå¦‚æœä½ åœ¨åç«¯åŠ äº†å­—æ®µï¼‰
        // ä¼˜å…ˆåŠ è½½ effectsDraftï¼›è‹¥è‰ç¨¿ä¸ºç©ºåˆ™åŠ è½½å·²å‘å¸ƒ
// â­ æ­£ç¡®é€»è¾‘ï¼šåªè¦ effectsDraft å­—æ®µå­˜åœ¨ï¼Œå°±ä½¿ç”¨å®ƒï¼ˆå³ä½¿ä¸ºç©ºæ•°ç»„ä¹Ÿæ˜¯æœ‰æ•ˆè‰ç¨¿ï¼‰
//    åªæœ‰å­—æ®µä¸å­˜åœ¨ï¼ˆundefinedï¼‰æ—¶ï¼Œæ‰ fallback ä½¿ç”¨ effectsPublished
if (Array.isArray(work.effectsDraft)) {
    effectsDraft = work.effectsDraft.map(e => ({
        lineIndex: e.lineIndex,
        effectType: e.effectType
    }));
} else if (Array.isArray(work.effectsPublished)) {
    effectsDraft = work.effectsPublished.map(e => ({
        lineIndex: e.lineIndex,
        effectType: e.effectType
    }));
} else {
    effectsDraft = [];
}

// ===== èƒŒæ™¯é…ç½®ï¼šä¼˜å…ˆç”¨ backgroundDraftï¼Œè‹¥æœªå®šä¹‰å† fallback åˆ° backgroundPublished =====
// ===== èƒŒæ™¯é…ç½®ï¼šä¼˜å…ˆç”¨ backgroundDraftï¼Œè‹¥æœªå®šä¹‰å† fallback åˆ° backgroundPublished =====
function pickBackgroundConfig(work) {
  if (work.backgroundDraft && typeof work.backgroundDraft === 'object') {
    return work.backgroundDraft;
  }
  if (work.backgroundPublished && typeof work.backgroundPublished === 'object') {
    return work.backgroundPublished;
  }
  return { images: [], bindings: [], transitions: [] };
}

const bgCfg = pickBackgroundConfig(work);

// ---------- æŠŠæ¥å£é‡Œçš„ backgroundXXX æ˜ å°„æˆå‰ç«¯å†…éƒ¨ä½¿ç”¨çš„ç»“æ„ ----------
// å†…éƒ¨çº¦å®šï¼š
//   bgImages:     [{ id, name, url }]
//   bgBindings:   [{ imageId, imageName, startLine, endLine }]
//   bgTransitions:[{ fromLine, toLine, effectType }]

// 1ï¼‰å›¾ç‰‡åˆ—è¡¨
if (Array.isArray(bgCfg.images) && bgCfg.images.length > 0) {
  bgImages = bgCfg.images.map(function (img, idx) {
    // å…¼å®¹è€æ•°æ®ï¼šå¯èƒ½åªæœ‰ name+urlï¼Œæˆ–è€…åªæœ‰ imageId
    var id = img.id || img.imageId;
    if (!id) {
      // è€æ•°æ®å®Œå…¨æ²¡æœ‰ idï¼Œå°±æŒ‰é¡ºåºè¡¥ä¸€ä¸ª
      id = 'bg-' + String(idx + 1);
    }
    return {
      id: id,
      // é¡ºæ‰‹æŠŠ imageId ä¹Ÿå¸¦ä¸€ä»½ï¼Œæ–¹ä¾¿è°ƒè¯•
      imageId: id,
      name: img.name || img.imageName || '',
      url: img.url || ''
    };
  });

  // æ ¹æ®å·²æœ‰ id è®¡ç®—ä¸‹ä¸€ä¸ªè‡ªå¢å€¼ï¼šbgImageAutoId
  var maxNum = 0;
  bgImages.forEach(function (img) {
    var m = String(img.id).match(/^bg-(\d+)$/);
    if (m) {
      var n = parseInt(m[1], 10);
      if (n > maxNum) maxNum = n;
    }
  });
  bgImageAutoId = maxNum + 1;

  // é»˜è®¤é€‰ä¸­ç¬¬ä¸€å¼ ï¼Œæ–¹ä¾¿åé¢ç»‘å®š
  currentBgImageId = bgImages[0] ? bgImages[0].id : null;
} else {
  bgImages = [];
  bgImageAutoId = 1;
  currentBgImageId = null;
}

// 2ï¼‰ç»‘å®šåŒºé—´
bgBindings = Array.isArray(bgCfg.bindings)
  ? bgCfg.bindings.map(function (b) {
      return {
        imageId: b.imageId,
        imageName: b.imageName || '',
        startLine: Number(b.startLine),
        endLine: Number(b.endLine),
      };
    })
  : [];

// 3ï¼‰è½¬åœºç‰¹æ•ˆ
bgTransitions = Array.isArray(bgCfg.transitions)
  ? bgCfg.transitions.map(function (t) {
      return {
        fromLine: Number(t.fromLine),
        toLine: Number(t.toLine),
        effectType: t.effectType || 'crossfade',
      };
    })
  : [];

// 4ï¼‰æŠŠæ•°æ®å›å¡«åˆ°å³ä¾§èƒŒæ™¯é¢æ¿
renderBgImageList();
renderBgBindingList();
renderBgTransitionList();


        // åˆå¹¶æ‰€æœ‰é¡µé¢æ–‡æœ¬
        const pages = Array.isArray(work.content) ? work.content : [];
        let fullText = '';
        pages.forEach((p, idx) => {
          const t = deltaToPlainText(p.content || {});
          if (idx > 0) fullText += '\n';       // é¡µé¢ä¹‹é—´ä¹Ÿæ¢ä¸€è¡Œ
          fullText += t;
        });

        currentLines = fullText.split(/\r?\n/);

        renderLineList();
        updateDebugJson();

        listPage.classList.add('hidden');
        customEffectPage.classList.add('hidden');  // â­ æ–°å¢
        editorPage.classList.remove('hidden');
      }

      backBtn.addEventListener('click', () => {
        editorPage.classList.add('hidden');
        listPage.classList.remove('hidden');
        currentWorkId = null;
        currentLines = [];
        effectsDraft = [];
        selectedLineIndex = null;
        isPreviewing = false;
        lineListEl.innerHTML = '';
        selectedLineLabel.textContent = 'æ— ';
        previewBtn.textContent = 'é¢„è§ˆç‰¹æ•ˆ';
      });

      /* ---------- è¡Œåˆ—è¡¨ / é€‰ä¸­è¡Œ / è®¾ç½®ç‰¹æ•ˆ ---------- */

      function bgEffectLabel(type) {
  switch (type) {
    case 'crossfade': return 'äº¤å‰æ·¡å…¥æ·¡å‡º';
    case 'matrix':    return 'çŸ©é˜µ';
    case 'ink':       return 'å¢¨æŸ“';
    default:          return type || 'èƒŒæ™¯å˜åŒ–';
  }
}

// âœ… æç¤ºé«˜äº®/é—ªçƒæ§åˆ¶ï¼ˆæœ¬é¡µé¢ç”Ÿå‘½å‘¨æœŸå†…ï¼‰
const tipCancelHighlightBtn = document.getElementById('effect-tip-cancel-highlight');
let tipHighlightDisabled = false;

function clearToolbarTipHighlight() {
  selectedLineLabel.classList.remove('tip-highlight');
  selectedLineLabel.classList.remove('tip-blink');
  if (selectedLineLabel && selectedLineLabel.parentElement) {
    selectedLineLabel.parentElement.classList.remove('tip-highlight-active');
  }
}

function blinkToolbarTipTwice() {
  if (tipHighlightDisabled) return;

  selectedLineLabel.classList.add('tip-highlight');

  if (selectedLineLabel && selectedLineLabel.parentElement) {
    selectedLineLabel.parentElement.classList.add('tip-highlight-active');
  }

  // å…³é”®ï¼šé‡å¯åŠ¨ç”»ï¼ˆä¿è¯æ¯æ¬¡éƒ½é—ªä¸¤æ¬¡ï¼‰
  selectedLineLabel.classList.remove('tip-blink');
  void selectedLineLabel.offsetWidth; // reflow
  selectedLineLabel.classList.add('tip-blink');
}

// ä½ ç°åœ¨çš„éœ€æ±‚ï¼šä¸»è¦é’ˆå¯¹ â€œè¯·é€‰æ‹©ä¸€ä¸ªèƒŒæ™¯å›¾ç‰‡â€ è¿™ç§æç¤º
function maybeBlinkToolbarTip() {
  if (tipHighlightDisabled) return;

  // éèƒŒæ™¯æ¨¡å¼ï¼šä¸é«˜äº®
  if (currentEffectMode !== 'background') {
    clearToolbarTipHighlight();
    return;
  }

  const t = (selectedLineLabel.textContent || '').trim();

  // åªåœ¨â€œè¯·é€‰æ‹© + èƒŒæ™¯/å›¾ç‰‡â€æ—¶è§¦å‘ï¼ˆé¿å…è¯¯ä¼¤å…¶å®ƒæç¤ºï¼‰
  if (t.indexOf('è¯·é€‰æ‹©') !== -1 && (t.indexOf('èƒŒæ™¯') !== -1 || t.indexOf('å›¾ç‰‡') !== -1)) {
    blinkToolbarTipTwice();
  } else {
    clearToolbarTipHighlight();
  }
}

if (tipCancelHighlightBtn) {
  tipCancelHighlightBtn.addEventListener('click', function (e) {
    e.preventDefault();
    tipHighlightDisabled = true;
    clearToolbarTipHighlight();
  });
}

// âœ… ä¿é™©ï¼šä»»ä½•åœ°æ–¹åªè¦æ”¹äº†æç¤ºæ–‡æœ¬ï¼Œéƒ½è‡ªåŠ¨åˆ¤æ–­è¦ä¸è¦é—ª
if (selectedLineLabel) {
  const tipObserver = new MutationObserver(function () {
    maybeBlinkToolbarTip();
  });
  tipObserver.observe(selectedLineLabel, { childList: true, characterData: true, subtree: true });
}

      
function renderLineList() {
  lineListEl.innerHTML = '';

  if (!currentLines || currentLines.length === 0) {
    lineListEl.innerHTML = '<li>æš‚æ— å†…å®¹ï¼Œè¯·å…ˆåœ¨åˆ›ä½œç«¯å†™ä½œã€‚</li>';
    return;
  }

  rawToEffectiveIndex = [];
  let effIndexCounter = 0;

  currentLines.forEach((line, rawIdx) => {
    const trimmed = line.replace(/\r?\n$/, '');
    let effIndex = null;
    if (trimmed.trim()) {
      effIndex = effIndexCounter++;
    }
    rawToEffectiveIndex[rawIdx] = effIndex;

    const li = document.createElement('li');
    li.className = 'effect-line-item';
    li.dataset.index = String(rawIdx);
    if (effIndex != null) li.dataset.effIndex = String(effIndex);

    const displayNum  = effIndex != null ? (effIndex + 1) : '-';
    const displayText = trimmed ? trimmed : 'ï¼ˆç©ºè¡Œï¼‰';

    const tags = [];

    // æ–‡å­—ç‰¹æ•ˆ tag
    if (effIndex != null) {
      const tag = effectsDraft.find(e => e.lineIndex === effIndex);
      if (tag) {
        tags.push(`<span class="effect-tag">${escapeHtml(effectTypeLabel(tag.effectType))}</span>`);
      }

      // èƒŒæ™¯èµ·å§‹ / ç»“æŸ tag
      const bindingsForLine = bgBindings.filter(
        b => b.startLine === effIndex || b.endLine === effIndex
      );
      bindingsForLine.forEach(b => {
        const isStart = b.startLine === effIndex;
        const label = (isStart ? 'èµ·å§‹' : 'ç»“æŸ') + `ï¼šã€${escapeHtml(b.imageName)}ã€‘`;
        tags.push(
          `<span class="bg-tag ${isStart ? 'bg-tag-start' : 'bg-tag-end'}">${label}</span>`
        );
      });
    }

    const tagsHtml = tags.join(' ');

    li.innerHTML = `
      <span class="effect-line-num">${displayNum}</span>
      <span class="effect-line-text">${escapeHtml(displayText)}</span>
      <span class="effect-line-tags">${tagsHtml}</span>
    `;
    lineListEl.appendChild(li);

    // åœ¨è¿™ä¸€è¡Œåé¢æ’å…¥èƒŒæ™¯è½¬åœºè¡Œï¼ˆfromLine = å½“å‰å¥ï¼‰
    if (effIndex != null) {
      const transitions = bgTransitions.filter(t => t.fromLine === effIndex);
      transitions.forEach(t => {
        const trLi = document.createElement('li');
        trLi.className = 'bg-transition-item';
        trLi.dataset.from = String(t.fromLine);
        trLi.dataset.to   = String(t.toLine);
        trLi.textContent  = `ã€${bgEffectLabel(t.effectType)}ã€‘`;
        lineListEl.appendChild(trLi);
      });
    }
  });

  // æ–‡å­—æ¨¡å¼ä¸‹ï¼Œé‡æ–°é«˜äº®å½“å‰è¡Œ
  if (currentEffectMode === 'text' && selectedLineIndex != null) {
    document.querySelectorAll('.effect-line-item').forEach(li => {
      li.classList.remove('selected');
      if (String(selectedLineIndex) === li.dataset.effIndex) {
        li.classList.add('selected');
      }
    });
  }
}


      function setEditorMode(mode) {
  currentEffectMode = mode === 'background' ? 'background' : 'text';

  if (currentEffectMode === 'text') {
    effectToolbarTipPrefix.textContent = 'å½“å‰é€‰ä¸­è¡Œï¼š';
    selectedLineLabel.textContent = selectedLineIndex == null
      ? 'æ— '
      : `ç¬¬ ${selectedLineIndex + 1} å¥ï¼ˆæŒ‰é˜…è¯»ç«¯è®¡æ•°ï¼‰`;

    effectInsertLabel.textContent = 'æ’å…¥ç‰¹æ•ˆï¼š';
    textEffectGroup.classList.remove('hidden');
    bgEffectGroup.classList.add('hidden');
    bgPanel.classList.add('hidden');

  } else {
    // èƒŒæ™¯æ¨¡å¼ï¼šæç¤ºè¡Œå®Œå…¨ç”± selectedLineLabel æ–‡æœ¬è´Ÿè´£
    effectToolbarTipPrefix.textContent = '';
    selectedLineLabel.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªèƒŒæ™¯å›¾ç‰‡';
    maybeBlinkToolbarTip(); // âœ… æ–°å¢ï¼šé«˜äº® + é—ªä¸¤æ¬¡

    effectInsertLabel.textContent = 'æ’å…¥èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆï¼š';
    textEffectGroup.classList.add('hidden');
    bgEffectGroup.classList.remove('hidden');
    bgPanel.classList.remove('hidden');

    // è¿›å…¥èƒŒæ™¯æ¨¡å¼æ—¶ä¸å†å¼ºè°ƒâ€œå½“å‰é€‰ä¸­è¡Œâ€
    selectedLineIndex = null;
    document.querySelectorAll('.effect-line-item.selected')
      .forEach(li => li.classList.remove('selected'));
  }
}

      // æŠŠ File å¯¹è±¡è½¬æˆ base64 çº¯æ•°æ®ï¼ˆä¸å¸¦ data:image/... å‰ç¼€ï¼‰
function fileToBase64Data(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const result = e.target.result; // data:image/png;base64,xxxx
      const parts = String(result).split(',');
      if (parts.length < 2) {
        return reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œbase64 æ ¼å¼ä¸æ­£ç¡®'));
      }
      resolve(parts[1]); // åªè¦é€—å·åé¢çš„ base64 éƒ¨åˆ†
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

      // â­ ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡åˆ°è‡ªå·±æœåŠ¡å™¨çš„ /api/works/uploadï¼Œè¿”å› { url, name }
async function uploadBgImageToServer(file, name) {
  // 1ï¸âƒ£ ç»„è£… FormData
  const formData = new FormData();
  formData.append('image', file);

  // 2ï¸âƒ£ å‘é€åˆ°åç«¯
  const res = await fetch(WORK_UPLOAD_URL, {
    method: 'POST',
    // è¿™ä¸ªæ¥å£ç›®å‰ä¸æ ¡éªŒç™»å½•çš„è¯ï¼Œå¯ä»¥ä¸å¸¦å¤´ï¼›å¸¦ä¸Š Authorization ä¹Ÿæ²¡å…³ç³»ï¼š
    // headers: authHeaders(false),
    body: formData,
  });

  const data = await res.json().catch(function () { return {}; });

  if (!res.ok) {
    throw new Error(data.message || 'ä¸Šä¼ å¤±è´¥');
  }

  if (!data.imageUrl) {
    throw new Error('æœåŠ¡å™¨æœªè¿”å› imageUrl');
  }

  // ä¸ºäº†å’Œä¹‹å‰ä»£ç ä¸€è‡´ï¼Œè¿™é‡Œä¹Ÿè¿”å› { url, name }
  return {
    url: data.imageUrl,        // ä¾‹å¦‚ https://api.anchorx.ca/uploads/image-1759....jpg
    name: name || '',
  };
}

      
// â­ ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡åˆ° imgbbï¼Œè¿”å› { url, name } å·²ç»èˆå¼ƒï¼ï¼ï¼
async function uploadBgImageToImgbb(file, name) {
  if (!IMGBB_API_KEY || IMGBB_API_KEY === 'åœ¨ imgBB åå°å¤åˆ¶æ¥çš„å®Œæ•´ API Key') {
    throw new Error('å°šæœªé…ç½® IMGBB_API_KEY');
  }

  // 1ï¸âƒ£ è¯»å–æˆ base64
  const base64Data = await fileToBase64Data(file);

  // 2ï¸âƒ£ å‘é€åˆ° imgbb
  const formData = new FormData();
  formData.append('image', base64Data);
  if (name) {
    formData.append('name', name);
  }

  const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
    method: 'POST',
    body: formData,
  });

  const data = await res.json();
  if (!res.ok || !data || !data.success) {
    console.error('imgbb ä¸Šä¼ å¤±è´¥:', data);
    throw new Error('ä¸Šä¼ åˆ°å›¾åºŠå¤±è´¥');
  }

  const d = data.data;
  const url = d.display_url || d.url;
  const finalName = name || d.title || 'èƒŒæ™¯å›¾ç‰‡';

  if (!url) {
    throw new Error('å›¾åºŠæœªè¿”å›æœ‰æ•ˆå›¾ç‰‡é“¾æ¥');
  }

  return { url, name: finalName };
}

            /* ---------- è‡ªå®šä¹‰ç‰¹æ•ˆï¼šä¸åç«¯äº¤äº’ ---------- */

      async function fetchCustomEffects() {
        try {
          const res = await fetch(EFFECT_API_BASE_URL, {
            headers: authHeaders(false),
          });
          if (res.status === 401) {
            alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è‡ªå®šä¹‰ç‰¹æ•ˆåŠŸèƒ½');
            return [];
          }
          const j = await res.json().catch(() => []);
          if (!res.ok) {
            alert('è·å–è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥ï¼š' + (j.message || res.status));
            return [];
          }
          customEffects = Array.isArray(j) ? j : [];
          return customEffects;
        } catch (e) {
          console.error(e);
          alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è‡ªå®šä¹‰ç‰¹æ•ˆ');
          return [];
        }
      }

            async function fetchCustomEffects() {
        try {
          const res = await fetch(EFFECT_API_BASE_URL, {
            headers: authHeaders(false),
          });
          if (res.status === 401) {
            alert('è¯·å…ˆç™»å½•åå†ä½¿ç”¨è‡ªå®šä¹‰ç‰¹æ•ˆåŠŸèƒ½');
            return [];
          }
          const j = await res.json().catch(() => []);
          if (!res.ok) {
            alert('è·å–è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥ï¼š' + (j.message || res.status));
            return [];
          }
          customEffects = Array.isArray(j) ? j : [];
          return customEffects;
        } catch (e) {
          console.error(e);
          alert('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½è‡ªå®šä¹‰ç‰¹æ•ˆ');
          return [];
        }
      }

      function renderCustomEffectManageList() {
        // ... ä½ çš„åŸä»£ç  ...
      }

      // â­ æ–°å¢ï¼šæ ¹æ® key åœ¨å½“å‰ customEffects é‡Œæ‰¾åˆ°ä»£ç å¹¶æ‰§è¡Œ applyEffect
      function runCustomEffectOnElement(effectKey, targetEl) {
        if (!effectKey || !targetEl) return;
        const effect = customEffects.find(e => e.key === effectKey);
        if (!effect || !effect.code) return;

        try {
          const wrapped = new Function(
            'targetEl',
            effect.code + `
              if (typeof applyEffect === 'function') {
                applyEffect(targetEl);
              }
            `
          );
          wrapped(targetEl);
        } catch (err) {
          console.error('è‡ªå®šä¹‰ç‰¹æ•ˆæ‰§è¡Œå¤±è´¥:', err);
        }
      }


      function renderCustomEffectManageList() {
        customEffectListEl.innerHTML = '';

        if (!customEffects.length) {
          customEffectEmptyTip.style.display = 'block';
          return;
        }
        customEffectEmptyTip.style.display = 'none';

        customEffects.forEach(effect => {
          const li = document.createElement('li');
          li.className = 'custom-effect-item' + (effect._id === currentCustomEffectId ? ' active' : '');
          li.dataset.id = effect._id;
          li.innerHTML = `
            <span class="custom-effect-name">${escapeHtml(effect.name || '(æœªå‘½åç‰¹æ•ˆ)')}</span>
            <span class="custom-effect-meta">${escapeHtml(effect.key || '')}</span>
          `;
          customEffectListEl.appendChild(li);
        });
      }

      function resetCustomEffectEditorToEmpty() {
  currentCustomEffectId = null;
  customEffectNameInput.value = '';
  customEffectKeyInput.value = '';
  customEffectCodeInput.value = '';
  customEffectEditorTitle.textContent = 'è¯·é€‰æ‹©å·¦ä¾§ç‰¹æ•ˆï¼Œæˆ–ç‚¹å‡»â€œæ–°å»ºè‡ªå®šä¹‰ç‰¹æ•ˆâ€';

  // â­ é»˜è®¤éšè—å³ä¾§ç¼–è¾‘å™¨
  if (customEffectEditorPanel) {
    customEffectEditorPanel.classList.add('hidden');
  }
}


      async function openCustomEffectPage() {
        listPage.classList.add('hidden');
        editorPage.classList.add('hidden');
        customEffectPage.classList.remove('hidden');

        resetCustomEffectEditorToEmpty();
        await fetchCustomEffects();
        renderCustomEffectManageList();
      }

      /* ---------- è‡ªå®šä¹‰ç‰¹æ•ˆç®¡ç†é¡µï¼šäº‹ä»¶ç»‘å®š ---------- */

      if (customEffectManageBtn) {
        customEffectManageBtn.addEventListener('click', () => {
          openCustomEffectPage();
        });
      }

      if (customEffectBackBtn) {
        customEffectBackBtn.addEventListener('click', () => {
          customEffectPage.classList.add('hidden');
          editorPage.classList.add('hidden');
          listPage.classList.remove('hidden');
        });
      }

      if (customEffectNewBtn) {
  customEffectNewBtn.addEventListener('click', () => {
    currentCustomEffectId = null;
    customEffectNameInput.value = '';
    customEffectKeyInput.value = '';
    customEffectCodeInput.value = DEFAULT_SAMPLE_CODE;
    customEffectEditorTitle.textContent = 'æ–°å»ºè‡ªå®šä¹‰ç‰¹æ•ˆ';

    // â­ æ˜¾ç¤ºç¼–è¾‘å™¨
    if (customEffectEditorPanel) {
      customEffectEditorPanel.classList.remove('hidden');
    }

    renderCustomEffectManageList();
  });
}


      customEffectListEl.addEventListener('click', (e) => {
  const item = e.target.closest('.custom-effect-item');
  if (!item) return;

  const id = item.dataset.id;
  const effect = customEffects.find(x => x._id === id);
  if (!effect) return;

  currentCustomEffectId = id;
  customEffectNameInput.value = effect.name || '';
  customEffectKeyInput.value = effect.key || '';
  customEffectCodeInput.value = effect.code || '';
  customEffectEditorTitle.textContent = 'æ­£åœ¨ç¼–è¾‘ï¼š' + (effect.name || '(æœªå‘½åç‰¹æ•ˆ)');

  // â­ æ˜¾ç¤ºç¼–è¾‘å™¨
  if (customEffectEditorPanel) {
    customEffectEditorPanel.classList.remove('hidden');
  }

  renderCustomEffectManageList();
});


      if (customEffectSaveBtn) {
        customEffectSaveBtn.addEventListener('click', async () => {
          const name = customEffectNameInput.value.trim();
          const key = customEffectKeyInput.value.trim();
          const code = customEffectCodeInput.value;

          if (!name || !key || !code.trim()) {
            alert('åç§°ã€key å’Œä»£ç éƒ½ä¸èƒ½ä¸ºç©º');
            return;
          }

          const payload = { name, key, code };

          try {
            let res;
            if (currentCustomEffectId) {
              res = await fetch(`${EFFECT_API_BASE_URL}/${currentCustomEffectId}`, {
                method: 'PATCH',
                headers: authHeaders(true),
                body: JSON.stringify(payload),
              });
            } else {
              res = await fetch(EFFECT_API_BASE_URL, {
                method: 'POST',
                headers: authHeaders(true),
                body: JSON.stringify(payload),
              });
            }

            const j = await res.json().catch(() => ({}));
            if (!res.ok) {
              alert('ä¿å­˜è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥ï¼š' + (j.message || res.status));
              return;
            }

            alert('è‡ªå®šä¹‰ç‰¹æ•ˆå·²ä¿å­˜ï¼');

            // æ›´æ–°å½“å‰ idï¼ˆæ–°å»ºæ—¶è¿”å›çš„ _idï¼‰
            if (j && j._id) {
              currentCustomEffectId = j._id;
            }

            await fetchCustomEffects();
            renderCustomEffectManageList();
          } catch (err) {
            console.error(err);
            alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
          }
        });
      }

      if (customEffectDeleteBtn) {
        customEffectDeleteBtn.addEventListener('click', async () => {
          if (!currentCustomEffectId) {
            alert('è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„è‡ªå®šä¹‰ç‰¹æ•ˆ');
            return;
          }
          if (!confirm('ç¡®å®šåˆ é™¤å½“å‰è‡ªå®šä¹‰ç‰¹æ•ˆï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚')) return;

          try {
            const res = await fetch(`${EFFECT_API_BASE_URL}/${currentCustomEffectId}`, {
              method: 'DELETE',
              headers: authHeaders(false),
            });
            const j = await res.json().catch(() => ({}));
            if (!res.ok) {
              alert('åˆ é™¤å¤±è´¥ï¼š' + (j.message || res.status));
              return;
            }

            alert('è‡ªå®šä¹‰ç‰¹æ•ˆå·²åˆ é™¤');
            resetCustomEffectEditorToEmpty();
            await fetchCustomEffects();
            renderCustomEffectManageList();
          } catch (err) {
            console.error(err);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
          }
        });
      }

      /* ---------- ç¼–è¾‘å™¨é¡¶éƒ¨ï¼šå±•å¼€è‡ªå®šä¹‰ç‰¹æ•ˆä¸‹æ‹‰ ---------- */

      function renderCustomEffectDropdownList() {
        customEffectDropdownList.innerHTML = '';

        if (!customEffects.length) {
          const li = document.createElement('li');
          li.innerHTML = '<span style="font-size:0.8rem;color:#999;">æš‚æ— è‡ªå®šä¹‰ç‰¹æ•ˆï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹â€œç®¡ç†è‡ªå®šä¹‰ç‰¹æ•ˆâ€æ–°å»ºã€‚</span>';
          customEffectDropdownList.appendChild(li);
          return;
        }

        customEffects.forEach(effect => {
          const li = document.createElement('li');
          li.innerHTML = `
            <button type="button" data-effect-key="${effect.key}">
              ${escapeHtml(effect.name || '(æœªå‘½åç‰¹æ•ˆ)')} (${escapeHtml(effect.key)})
            </button>
          `;
          customEffectDropdownList.appendChild(li);
        });
      }

      if (customEffectToggleBtn) {
        customEffectToggleBtn.addEventListener('click', async () => {
          const isHidden = customEffectDropdownPanel.classList.contains('hidden');
          if (isHidden) {
            await fetchCustomEffects();
            renderCustomEffectDropdownList();
            customEffectDropdownPanel.classList.remove('hidden');
          } else {
            customEffectDropdownPanel.classList.add('hidden');
          }
        });
      }

      if (customEffectDropdownClose) {
        customEffectDropdownClose.addEventListener('click', () => {
          customEffectDropdownPanel.classList.add('hidden');
        });
      }

      customEffectDropdownList.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-effect-key]');
        if (!btn) return;

        if (selectedLineIndex == null) {
          alert('è¯·å…ˆç‚¹å‡»å·¦ä¾§æŸä¸€è¡Œï¼Œå†åº”ç”¨è‡ªå®šä¹‰ç‰¹æ•ˆ');
          return;
        }

        const key = btn.dataset.effectKey;
        if (!key) return;

        // â­ çº¦å®šï¼šè‡ªå®šä¹‰ç‰¹æ•ˆåœ¨ effectsDraft ä¸­çš„æ ‡è®°æ–¹å¼
        const effectType = 'custom:' + key;

        setEffectForLine(selectedLineIndex, effectType);
      });

      if (customEffectOpenManageBtn) {
        customEffectOpenManageBtn.addEventListener('click', () => {
          customEffectDropdownPanel.classList.add('hidden');
          openCustomEffectPage();
        });
      }

      
      function escapeHtml(str) {
        return str.replace(/[&<>"']/g, s => ({
          '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
        }[s]));
      }

            function effectTypeLabel(type) {
        if (!type) return '';

        // â­ æ–°å¢ï¼šcustom:xxx ç±»å‹çš„æ˜¾ç¤º
        if (typeof type === 'string' && type.startsWith('custom:')) {
          const key = type.slice('custom:'.length) || '';
          return 'è‡ªå®šä¹‰ï¼š' + key;
        }

        switch (type) {
          case 'shake': return 'éœ‡åŠ¨';
          case 'flash': return 'é—ªçƒ';
          case 'fade': return 'æ·¡å…¥';
          case 'highlight': return 'é«˜äº®';
          default: return type;
        }
      }


            lineListEl.addEventListener('click', e => {
  const item = e.target.closest('.effect-line-item');
  if (!item) return;

  const effStr = item.dataset.effIndex;
  if (!effStr && effStr !== '0') {
    alert('è¯¥è¡Œä¸ºç©ºè¡Œæˆ–ä¸å¯è®¾ç½®ç‰¹æ•ˆ');
    return;
  }
  const effIdx = Number(effStr);
  if (Number.isNaN(effIdx)) return;

  if (currentEffectMode === 'text') {
    // ===== æ–‡å­—ç‰¹æ•ˆæ¨¡å¼ï¼šä¿ç•™åŸæ¥çš„è¡Œä¸º =====
    selectedLineIndex = effIdx;

    document.querySelectorAll('.effect-line-item').forEach(li => {
      li.classList.remove('selected');
    });
    item.classList.add('selected');

    selectedLineLabel.textContent = `ç¬¬ ${effIdx + 1} å¥ï¼ˆæŒ‰é˜…è¯»ç«¯è®¡æ•°ï¼‰`;
    return;
  }

  // ===== èƒŒæ™¯ç‰¹æ•ˆæ¨¡å¼ =====
  // èƒŒæ™¯æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ selectedLineIndex é«˜äº®ï¼Œç”¨æç¤ºè¡Œ + èµ·å§‹/ç»“æŸ tag
  document.querySelectorAll('.effect-line-item').forEach(li => {
    li.classList.remove('selected');
  });
  item.classList.add('selected');

  if (bgSelectionPhase === 'chooseStart') {
    // é€‰æ‹©èµ·å§‹å¥
    bgTempStartLine = effIdx;
    bgSelectionPhase = 'chooseEnd';
    selectedLineLabel.textContent = `è¯·é€‰ä¸­èƒŒæ™¯ç»“æŸåº”ç”¨çš„å¥å­ï¼ˆå½“å‰èµ·å§‹ï¼šç¬¬ ${effIdx + 1} å¥ï¼‰`;
    return;
  }

  if (bgSelectionPhase === 'chooseEnd') {
    // é€‰æ‹©ç»“æŸå¥
    if (bgTempStartLine == null || currentBgImageId == null) {
      alert('è¯·é€‰æ‹©èƒŒæ™¯å›¾ç‰‡ï¼Œå¹¶é‡æ–°é€‰æ‹©èµ·å§‹å¥ã€‚');
      resetBgSelectionState();
      return;
    }
    if (effIdx < bgTempStartLine) {
      alert('ç»“æŸå¥å¿…é¡»åœ¨èµ·å§‹å¥ä¹‹åã€‚');
      return;
    }

    // æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰èƒŒæ™¯åŒºé—´é‡å 
    const newStart = bgTempStartLine;
    const newEnd   = effIdx;
    const overlap = bgBindings.some(b =>
      !(newEnd < b.startLine || newStart > b.endLine)
    );
    if (overlap) {
      alert('èµ·å§‹å¥å’Œç»“æŸå¥ä¹‹é—´å·²ç»æœ‰å…¶å®ƒèƒŒæ™¯åŒºé—´ï¼Œä¸èƒ½å åŠ è®¾ç½®ã€‚');
      return;
    }

    bgBindings.push({
      imageId:   currentBgImageId,
      imageName: currentBgImageName,
      startLine: newStart,
      endLine:   newEnd,
    });

    renderLineList();
    updateDebugJson();
    resetBgSelectionState();
    return;
  }

  if (bgSelectionPhase === 'chooseTransitionEnd') {
    // é€‰æ‹©â€œç»“æŸå¥â€ï¼ˆä¸Šä¸€æ®µèƒŒæ™¯çš„ç»“æŸå¥ï¼‰
    const bindAsEnd = bgBindings.find(b => b.endLine === effIdx);
    if (!bindAsEnd) {
      alert('è¿™ä¸€å¥è¿˜æ²¡æœ‰ä½œä¸ºèƒŒæ™¯çš„ç»“æŸå¥ï¼Œè¯·å…ˆå®ŒæˆèƒŒæ™¯åŒºé—´è®¾ç½®ã€‚');
      return;
    }

    // æ‰¾â€œä¸‹ä¸€å¥â€æœ‰æ–°çš„èµ·å§‹å¥ï¼ˆå¿½ç•¥ç©ºè¡Œ â†’ æˆ‘ä»¬ç”¨ startLine > endLine æ¥æ‰¾ï¼‰
    const nextBinding = bgBindings
      .filter(b => b.startLine > effIdx)
      .sort((a, b) => a.startLine - b.startLine)[0];

    if (!nextBinding) {
      alert('è¯·å…ˆæŠŠä¸‹ä¸€ä¸ªéç©ºè¡Œè®¾ç½®å‡ºèƒŒæ™¯ï¼Œç„¶åå†è®¾ç½®èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆã€‚');
      return;
    }

    bgTransitions.push({
      fromLine: effIdx,
      toLine:   nextBinding.startLine,
      effectType: currentTransitionEffectType || 'crossfade',
    });

    renderLineList();
    updateDebugJson();
    resetBgSelectionState();
    return;
  }

  // å…¶å®ƒæƒ…å†µï¼šæ¯”å¦‚ idle
  if (bgImages.length === 0) {
    selectedLineLabel.textContent = 'è¯·å…ˆåœ¨å³ä¾§ä¸Šä¼ ä¸€å¼ èƒŒæ™¯å›¾ç‰‡';
  } else {
    selectedLineLabel.textContent = 'è¯·å…ˆåœ¨å³ä¾§é€‰æ‹©ä¸€å¼ èƒŒæ™¯å›¾ç‰‡';
  }
});

function resetBgSelectionState() {
  bgSelectionPhase = 'idle';
  currentBgImageId = null;
  currentBgImageName = '';
  bgTempStartLine = null;
  currentTransitionEffectType = null;

  document.querySelectorAll('.bg-image-item').forEach(li => {
    li.classList.remove('active');
  });
  document.querySelectorAll('.effect-line-item').forEach(li => {
    li.classList.remove('selected');
  });

  if (currentEffectMode === 'background') {
    selectedLineLabel.textContent = bgImages.length
      ? 'è¯·é€‰æ‹©ä¸€ä¸ªèƒŒæ™¯å›¾ç‰‡'
      : 'è¯·å…ˆä¸Šä¼ ä¸€å¼ èƒŒæ™¯å›¾ç‰‡';
  }
}

function renderBgImageList() {
  bgImageListEl.innerHTML = '';

  if (!bgImages.length) {
    bgImageListEl.innerHTML = '<li class="bg-image-empty">æš‚æ— èƒŒæ™¯å›¾ç‰‡ï¼Œè¯·å…ˆæœ¬åœ°ä¸Šä¼ ã€‚</li>';
    return;
  }

  bgImages.forEach(img => {
    const li = document.createElement('li');
    li.className = 'bg-image-item';
    li.dataset.id = img.id;

    if (img.id === currentBgImageId) {
      li.classList.add('active');
    }

    li.innerHTML = `
      <img class="bg-image-thumb" src="${img.url}" alt="${escapeHtml(img.name)}">
      <span class="bg-image-name">${escapeHtml(img.name)}</span>
    `;
    bgImageListEl.appendChild(li);
  });
}
function renderBgBindingList() {
  // å¦‚æœå³ä¾§é¢æ¿è¿˜æ²¡æ”¾è¿™ä¸ªåˆ—è¡¨ï¼Œç›´æ¥è·³è¿‡ï¼Œé˜²æ­¢æŠ¥é”™
  if (!bgBindingListEl) return;

  bgBindingListEl.innerHTML = '';

  if (!bgBindings.length) {
    bgBindingListEl.innerHTML =
      '<li class="bg-binding-empty">æš‚æ— èƒŒæ™¯åŒºé—´ã€‚</li>';
    return;
  }

  // æŒ‰èµ·å§‹å¥ä»å°åˆ°å¤§æ’åºå±•ç¤º
  const sorted = bgBindings.slice().sort(function (a, b) {
    return Number(a.startLine) - Number(b.startLine);
  });

  sorted.forEach(function (b, idx) {
    const li = document.createElement('li');
    li.className = 'bg-binding-item';
    li.dataset.imageId = b.imageId;
    li.dataset.startLine = String(b.startLine);
    li.dataset.endLine = String(b.endLine);

    const label =
      (b.imageName || b.imageId || 'æœªå‘½åèƒŒæ™¯') +
      'ï¼šç¬¬ ' +
      (Number(b.startLine) + 1) +
      ' å¥ ~ ç¬¬ ' +
      (Number(b.endLine) + 1) +
      ' å¥';

    li.textContent = label;
    bgBindingListEl.appendChild(li);
  });
}

function renderBgTransitionList() {
  if (!bgTransitionListEl) return;

  bgTransitionListEl.innerHTML = '';

  if (!bgTransitions.length) {
    bgTransitionListEl.innerHTML =
      '<li class="bg-transition-empty">æš‚æ— èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆã€‚</li>';
    return;
  }

  const sorted = bgTransitions.slice().sort(function (a, b) {
    return Number(a.fromLine) - Number(b.fromLine);
  });

  sorted.forEach(function (t) {
    const li = document.createElement('li');
    li.className = 'bg-transition-item';
    li.dataset.from = String(t.fromLine);
    li.dataset.to = String(t.toLine);

    const label =
      'ã€' +
      bgEffectLabel(t.effectType || 'crossfade') +
      'ã€‘ ç¬¬ ' +
      (Number(t.fromLine) + 1) +
      ' å¥ â†’ ç¬¬ ' +
      (Number(t.toLine) + 1) +
      ' å¥';

    li.textContent = label;
    bgTransitionListEl.appendChild(li);
  });
}

// æœ¬åœ°ä¸Šä¼ 
if (bgUploadLocalBtn && bgUploadInput) {
  bgUploadLocalBtn.addEventListener('click', () => {
    if (currentEffectMode !== 'background') {
      alert('è¯·å…ˆé€šè¿‡â€œç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆâ€è¿›å…¥èƒŒæ™¯æ¨¡å¼å†ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡ã€‚');
      return;
    }
    bgUploadInput.click();
  });

  bgUploadInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    // è®©ç”¨æˆ·ç»™è¿™å¼ èƒŒæ™¯èµ·ä¸ªåå­—
    let name = prompt(
      'è¯·ä¸ºè¯¥èƒŒæ™¯å›¾ç‰‡è®¾ç½®ä¸€ä¸ªåç§°ï¼š',
      file.name ? file.name.replace(/\.[^.]+$/, '') : ''
    );
    if (!name) {
      name = 'æœªå‘½åèƒŒæ™¯';
    }

        try {
      // UI æç¤ºï¼šæ­£åœ¨ä¸Šä¼ 
      selectedLineLabel.textContent = 'å›¾ç‰‡ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™...';

      // â­ æ”¹æˆä¸Šä¼ åˆ°è‡ªå·±æœåŠ¡å™¨ï¼Œæ‹¿åˆ° /uploads/... çš„ URL
      const result = await uploadBgImageToServer(file, name);
      const url = result.url;
      const finalName = result.name || name;

      // åœ¨æœ¬åœ°èƒŒæ™¯å›¾åº“ä¸­ç™»è®°ä¸€æ¡è®°å½•
      const id = 'bg-' + (bgImageAutoId++);
      bgImages.push({
        id: id,
        name: finalName,
        url: url,
      });

      // è®¾ä¸ºå½“å‰é€‰ä¸­çš„èƒŒæ™¯ï¼Œå¹¶è¿›å…¥ã€Œé€‰æ‹©èµ·å§‹å¥ã€é˜¶æ®µ
      currentBgImageId = id;
      currentBgImageName = finalName;
      bgSelectionPhase = 'chooseStart';

      // é‡æ–°æ¸²æŸ“å³ä¾§ã€ŒèƒŒæ™¯å›¾åº“ä¸Šä¼ ã€åˆ—è¡¨
      renderBgImageList();

      // æ›´æ–°æç¤ºè¡Œï¼šä¸‹ä¸€æ­¥è¯·é€‰èµ·å§‹å¥
      selectedLineLabel.textContent = 'è¯·é€‰ä¸­èƒŒæ™¯å¼€å§‹åº”ç”¨çš„å¥å­';

      // æ›´æ–°è°ƒè¯• JSON
      updateDebugJson();
    } catch (err) {
      console.error('ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡å¤±è´¥:', err);
      alert('ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡å¤±è´¥ï¼š' + (err.message || 'ç½‘ç»œé”™è¯¯'));
      resetBgSelectionState();
    } finally {
      // æ¸…ç©º inputï¼Œæ–¹ä¾¿ä¸‹æ¬¡é€‰åŒä¸€å¼ å›¾
      bgUploadInput.value = '';
    }
  });
}

// åˆ—è¡¨é€‰æ‹©å›¾ç‰‡
if (bgImageListEl) {
  bgImageListEl.addEventListener('click', e => {
    const item = e.target.closest('.bg-image-item');
    if (!item) return;

    const id = item.dataset.id;
    const img = bgImages.find(x => x.id === id);
    if (!img) return;

    currentBgImageId = img.id;
    currentBgImageName = img.name;
    bgSelectionPhase = 'chooseStart';

    document.querySelectorAll('.bg-image-item').forEach(li => {
      li.classList.remove('active');
    });
    item.classList.add('active');

    selectedLineLabel.textContent = 'è¯·é€‰ä¸­èƒŒæ™¯å¼€å§‹åº”ç”¨çš„å¥å­';
  });
}

// ç§»é™¤å›¾ç‰‡
if (bgRemoveImageBtn) {
  bgRemoveImageBtn.addEventListener('click', () => {
    if (!currentBgImageId) {
      alert('è¯·å…ˆåœ¨ã€ŒèƒŒæ™¯å›¾åº“ä¸Šä¼ ã€ä¸­é€‰ä¸­è¦ç§»é™¤çš„å›¾ç‰‡ã€‚');
      return;
    }

    const img = bgImages.find(x => x.id === currentBgImageId);
    const name = img ? img.name : '';

    if (!confirm(`ç¡®å®šè¦åˆ é™¤èƒŒæ™¯ã€Œ${name || currentBgImageId}ã€å—ï¼Ÿ\nè¯¥èƒŒæ™¯ç»‘å®šçš„æ‰€æœ‰èƒŒæ™¯åŒºé—´å’Œè½¬åœºéƒ½ä¼šä¸€å¹¶ç§»é™¤ã€‚`)) {
      return;
    }

    // ç§»é™¤å›¾ç‰‡
    bgImages = bgImages.filter(x => x.id !== currentBgImageId);

    // ç§»é™¤ç»‘å®šå’Œè½¬åœº
    const validImageIds = new Set(bgImages.map(x => x.id));
    bgBindings = bgBindings.filter(b => validImageIds.has(b.imageId));
    bgTransitions = bgTransitions.filter(t => {
      // è½¬åœºæŒ‰å¥å­è¿æ¥ï¼Œè¿™é‡Œç®€å•ä¿ç•™ï¼›å¦‚æœå¯¹åº”èƒŒæ™¯å¥å­éƒ½æ²¡äº†ï¼Œä¹Ÿå¯ä»¥åç»­æ•´ä½“æ¸…ç†
      return true;
    });

    renderBgImageList();
    renderLineList();
    updateDebugJson();
    resetBgSelectionState();
  });
}

// å…±äº«å›¾åº“å ä½
if (bgAddFromSharedBtn) {
  bgAddFromSharedBtn.addEventListener('click', () => {
    alert('ã€Œä»å…±äº«å›¾åº“ä¸­æ·»åŠ ã€æš‚æ—¶å…ˆæç½®ï¼Œåç»­æ¥å¥½åå°æ¥å£åå†å¯ç”¨ã€‚');
  });
}


      // è®¾ç½®/æ¸…é™¤æŸä¸€è¡Œç‰¹æ•ˆ
      function setEffectForLine(lineIndex, effectType) {
        const existingIndex = effectsDraft.findIndex(e => e.lineIndex === lineIndex);
        if (!effectType) {
          if (existingIndex >= 0) effectsDraft.splice(existingIndex, 1);
        } else {
          if (existingIndex >= 0) {
            effectsDraft[existingIndex].effectType = effectType;
          } else {
            effectsDraft.push({ lineIndex, effectType });
          }
        }
        updateDebugJson();
        renderLineList();
      }

      document.querySelectorAll('.effect-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (currentEffectMode !== 'text') {
      alert('å½“å‰å¤„äºâ€œèƒŒæ™¯ç‰¹æ•ˆâ€æ¨¡å¼ï¼Œè¯·ç‚¹å‡»ä½œå“åˆ—è¡¨ä¸­çš„ã€Œç¼–è¾‘æ–‡å­—ç‰¹æ•ˆã€è¿›å…¥æ–‡å­—æ¨¡å¼åå†æ’å…¥æ–‡å­—ç‰¹æ•ˆã€‚');
      return;
    }
    if (selectedLineIndex == null) {
      alert('è¯·å…ˆç‚¹å‡»å·¦ä¾§æŸä¸€è¡Œå†æ’å…¥ç‰¹æ•ˆ');
      return;
    }
    const effectType = btn.dataset.effect;
    setEffectForLine(selectedLineIndex, effectType);
  });
});

      // èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆæŒ‰é’®
document.querySelectorAll('.effect-bg-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    if (currentEffectMode !== 'background') {
      alert('è¯·å…ˆé€šè¿‡ã€Œç¼–è¾‘èƒŒæ™¯ç‰¹æ•ˆã€è¿›å…¥èƒŒæ™¯æ¨¡å¼ã€‚');
      return;
    }
    if (!bgBindings.length) {
      alert('è¯·å…ˆä¸ºè‡³å°‘ä¸¤æ®µæ–‡å­—è®¾ç½®èƒŒæ™¯ï¼Œå†è®¾ç½®èƒŒæ™¯å˜åŒ–ç‰¹æ•ˆã€‚');
      return;
    }

    currentTransitionEffectType = btn.dataset.bgEffect || 'crossfade';
    bgSelectionPhase = 'chooseTransitionEnd';
    selectedLineLabel.textContent = 'è¯·é€‰æ‹©å¯¹åº”ç»“æŸå¥ï¼ˆä¸Šä¸€æ®µèƒŒæ™¯çš„ç»“æŸè¡Œï¼‰';

    document.querySelectorAll('.effect-line-item').forEach(li => {
      li.classList.remove('selected');
    });
  });
});


      removeEffectBtn.addEventListener('click', () => {
        if (selectedLineIndex == null) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€è¡Œ');
          return;
        }
        setEffectForLine(selectedLineIndex, null);
      });

      /* ---------- é¢„è§ˆç‰¹æ•ˆ ---------- */

            function applyPreviewClasses() {
        document.querySelectorAll('.effect-line-item').forEach(li => {
          const textEl = li.querySelector('.effect-line-text');
          if (!textEl) return;

          // å…ˆæ¸…ç†å†…ç½®ç‰¹æ•ˆç”¨åˆ°çš„ class
          textEl.classList.remove('effect-shake', 'effect-flash', 'effect-fade', 'effect-highlight');

          const effStr = li.dataset.effIndex;
          if (!effStr && effStr !== '0') return; // ç©ºè¡Œ / æ— æ•ˆè¡Œ

          const effIdx = Number(effStr);
          if (Number.isNaN(effIdx)) return;

          const tag = effectsDraft.find(e => e.lineIndex === effIdx);
          if (!tag) return;

          const type = tag.effectType;

          // â­ æ–°å¢ï¼šè‡ªå®šä¹‰ç‰¹æ•ˆé¢„è§ˆï¼ˆeffectType å½¢å¦‚ custom:damieï¼‰
          if (typeof type === 'string' && type.startsWith('custom:')) {
            const key = type.slice('custom:'.length);
            if (key) {
              runCustomEffectOnElement(key, textEl);
            }
            // è‡ªå®šä¹‰ç‰¹æ•ˆä¸å†å¾€ä¸‹èµ° switch
            return;
          }

          // åŸæ¥çš„å†…ç½®ç‰¹æ•ˆé€»è¾‘
          switch (type) {
            case 'shake':     textEl.classList.add('effect-shake'); break;
            case 'flash':     textEl.classList.add('effect-flash'); break;
            case 'fade':      textEl.classList.add('effect-fade'); break;
            case 'highlight': textEl.classList.add('effect-highlight'); break;
          }
        });
      }


      function clearPreviewClasses() {
        document.querySelectorAll('.effect-line-text').forEach(el => {
          el.classList.remove('effect-shake', 'effect-flash', 'effect-fade', 'effect-highlight');
        });
      }

        previewBtn.addEventListener('click', async () => {
        isPreviewing = !isPreviewing;
        if (isPreviewing) {
          // â­ è¿›å…¥é¢„è§ˆæ—¶ï¼Œç¡®ä¿æ‹¿åˆ°æœ€æ–°çš„è‡ªå®šä¹‰ç‰¹æ•ˆåˆ—è¡¨
          await fetchCustomEffects();
          applyPreviewClasses();
          previewBtn.textContent = 'å…³é—­é¢„è§ˆ';
        } else {
          clearPreviewClasses();
          previewBtn.textContent = 'é¢„è§ˆç‰¹æ•ˆ';
        }
      });


      /* ---------- ä¿å­˜è‰ç¨¿ / å‘å¸ƒç‰¹æ•ˆ ---------- */
      function updateDebugJson() {
  const payload = {
    textEffects: effectsDraft,
    backgroundDraft: {
      images: bgImages,
      bindings: bgBindings,
      transitions: bgTransitions,
    },
  };
  debugJsonEl.textContent = JSON.stringify(payload, null, 2);
}



      // â­ ä¿®æ”¹åï¼šå‘å¸ƒæ—¶åŒæ—¶æ›´æ–° effectsDraft å’Œ effectsPublished
async function saveEffectsDraft(isPublish) {
  if (!currentWorkId) {
    alert('æœªé€‰æ‹©ä½œå“');
    return;
  }

  // â¬‡ï¸ è¿™é‡Œæ”¹æˆæ ¹æ® isPublish æ„é€ ä¸åŒçš„ payload
// ç»„è£…èƒŒæ™¯é…ç½®
// ç»„è£…èƒŒæ™¯é…ç½®ï¼ˆå¸¦ imageIdï¼‰
const backgroundPayload = {
  images: bgImages.map(function (img, idx) {
    var imageId = img.id;
    if (!imageId) {
      imageId = 'bg-' + String(idx);
    }
    return {
      imageId: imageId,           // â­ å…³é”®ï¼šæŠŠ id å†™è¿› imageId
      name: img.name || '',
      url: img.url || '',
    };
  }),
  bindings: bgBindings.map(function (b) {
    return {
      imageId: b.imageId,         // å’Œä¸Šé¢çš„ imageId å¯¹åº”
      imageName: b.imageName || '',
      startLine: Number(b.startLine),
      endLine: Number(b.endLine),
    };
  }),
  transitions: bgTransitions.map(function (t) {
    return {
      fromLine: Number(t.fromLine),
      toLine: Number(t.toLine),
      effectType: t.effectType || 'fade',
    };
  }),
};


const payload = isPublish
  ? {
      // å‘å¸ƒï¼šæ–‡å­— + èƒŒæ™¯ éƒ½åŒæ­¥è‰ç¨¿ & å·²å‘å¸ƒ
      effectsDraft: effectsDraft,
      effectsPublished: effectsDraft,
      backgroundDraft: backgroundPayload,
      backgroundPublished: backgroundPayload,
    }
  : {
      // åªä¿å­˜è‰ç¨¿ï¼šåªæ›´æ–°è‰ç¨¿
      effectsDraft: effectsDraft,
      backgroundDraft: backgroundPayload,
    };


  try {
    const res = await fetch(API_BASE_URL + '/' + currentWorkId, {
      method: 'PATCH',
      headers: authHeaders(true),
      body: JSON.stringify(payload),
    });

    const j = await res.json().catch(() => ({}));
    if (!res.ok) {
      alert((isPublish ? 'å‘å¸ƒ' : 'ä¿å­˜è‰ç¨¿') + 'å¤±è´¥ï¼š' + (j.message || res.status));
      return;
    }

    alert(
      isPublish
        ? 'ç‰¹æ•ˆå·²å‘å¸ƒï¼Œå¹¶å·²åŒæ­¥ä¿å­˜ä¸ºè‰ç¨¿ï¼'
        : 'è‰ç¨¿å·²ä¿å­˜ï¼'
    );

    // ğŸ”¥ è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œå›å¡« UI
    // è‡ªåŠ¨åˆ·æ–°æ•°æ®ï¼Œå›å¡« UIï¼ˆä¿æŒå½“å‰æ¨¡å¼ï¼‰
enterEffectEditor(currentWorkId, currentEffectMode);

// è‹¥åœ¨èƒŒæ™¯æ¨¡å¼ï¼Œé‡ç½®æç¤ºè¡Œ
if (currentEffectMode === 'background') {
  resetBgSelectionState();
}

  } catch (e) {
    console.error(e);
    alert((isPublish ? 'å‘å¸ƒ' : 'ä¿å­˜') + 'å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
  }
}


      saveDraftBtn.addEventListener('click', () => saveEffectsDraft(false));
      publishBtn.addEventListener('click', () => {
        if (!confirm('ç¡®å®šå‘å¸ƒå½“å‰ç‰¹æ•ˆé…ç½®ï¼Ÿ')) return;
        saveEffectsDraft(true);
      });

      /* ---------- åˆå§‹åŒ– ---------- */
      loadWorkList();
    });
  </script>
</body>

</head>
</html>
