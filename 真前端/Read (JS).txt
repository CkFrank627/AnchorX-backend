   <script>
  /* ---------- 1. æ³¨å†Œè‡ªå®šä¹‰ Blotï¼ˆæ’ä»¶ï¼‰ - ç¡®ä¿é˜…è¯»ç«¯èƒ½è§£æ HiddenTextBlot ---------- */
    // å¯¼å…¥ Quill æ ¸å¿ƒ Blot ç±»
    const Inline = Quill.import('blots/inline');

    /* éšè—æ–‡å­—ï¼ˆInline Blotï¼‰ */
    class HiddenTextBlot extends Inline {
        static blotName = 'hiddenText';
        static tagName = 'span';
        static className = 'spoiler-hidden';

        // é™æ€æ–¹æ³•ï¼šä» DOM èŠ‚ç‚¹è§£æå‡ºæ ¼å¼å€¼
        static formats(node) {
            const mode = node.getAttribute('data-mode') || 'spoiler';
            return { mode };
        }

        // é™æ€æ–¹æ³•ï¼šåˆ›å»º DOM èŠ‚ç‚¹ (åœ¨é˜…è¯»ç«¯ setContents æ—¶ä½¿ç”¨)
static create(value) {
    const node = super.create(value);
    let mode = 'spoiler'; // é»˜è®¤æ¨¡å¼

    // âœ… ä¼˜åŒ–: ç²¾ç®€åˆ¤æ–­é€»è¾‘
    if (value && typeof value === 'object' && value.mode) {
        mode = value.mode;
    }

    // è®¾ç½®è‡ªå®šä¹‰å±æ€§å’Œå¯èƒ½çš„ç‰¹å®š class
    node.setAttribute('data-mode', mode);
    if (mode === 'secret') {
        node.classList.add('secret-dice');
    } else {
        node.classList.remove('secret-dice');
    }
    return node;
}

        // å®ä¾‹æ–¹æ³•ï¼šæ›´æ–°æ ¼å¼å±æ€§ (åœ¨é˜…è¯»ç«¯ readOnly=true, ä»…ä¾›å®Œæ•´æ€§ä¿ç•™)
        format(name, value) {
            if (name === 'hiddenText' && value && value.mode) {
                this.domNode.setAttribute('data-mode', value.mode);
                if (value.mode === 'secret') {
                    this.domNode.classList.add('secret-dice');
                } else {
                    this.domNode.classList.remove('secret-dice');
                }
            } else {
                super.format(name, value);
            }
        }
    }

    // æ³¨å†Œè‡ªå®šä¹‰ Blot
    Quill.register(HiddenTextBlot);
      
    document.addEventListener('DOMContentLoaded', () => {
        // DOM å…ƒç´ 
        const workTitle = document.getElementById('work-title');
        const workAuthor = document.getElementById('work-author');
        const workDate = document.getElementById('work-date');
        const bookContent = document.getElementById('book-content');
        const commentPanel = document.getElementById('comment-panel');
        const closeCommentBtn = document.getElementById('close-comment-panel-btn');
        const commentList = document.getElementById('comment-list');
        const commentTextarea = document.getElementById('comment-textarea');
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        const likeWorkBtn = document.getElementById('like-work-btn');
        const likeCounter = likeWorkBtn.querySelector('.like-counter');
        const likeIcon = likeWorkBtn.querySelector('.like-icon');
        const sidebar = document.getElementById('sidebar');

      // ã€æ–°å¢ä»£ç ã€‘ï¼šä¾§è¾¹æ æŠ˜å æŒ‰é’®
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarToggleIcon = document.getElementById('sidebar-toggle-icon');

        const API_WORKS = 'https://api.anchorx.ca/api/works';
        const API_COMMENTS = 'https://api.anchorx.ca/api/comments';


        // å…¨å±€çŠ¶æ€
        let activeWork = null;      // å®Œæ•´ work å¯¹è±¡
        let activePages = [{content: {ops: []}}]; // array of pages
        let currentMode = 'scroll';  // 'scroll' | 'page'
        let currentPageIndex = 0;
        let activeSentenceEl = null; // è¢«ç‚¹å‡»ç”¨äºè¯„è®ºçš„æ®µè½å…ƒç´ 
        let pageQuill = null;        // åœ¨ç¿»é¡µæ¨¡å¼ä¸‹åŠ¨æ€åˆ›å»ºçš„ Quill å®ä¾‹
        let rendererQuill = null;    // éšè—çš„ Quill ç”¨äº Delta -> HTML è½¬æ¢

          let contentIndexCounter = 0; // å…¨å±€è®¡æ•°å™¨ï¼Œç”¨äºç”Ÿæˆå”¯ä¸€ID

      // ã€æ–°å¢æ ¸å¿ƒçŠ¶æ€ã€‘
let allComments = [];                 // å­˜å‚¨ä½œå“æ‰€æœ‰è¯„è®º (ç”¨äºè¿‡æ»¤)
let commentedSentenceIds = new Set(); // å­˜å‚¨æ‰€æœ‰æœ‰è¯„è®ºçš„ sentenceId (ç”¨äºæ ‡è®°)
let currentViewingSentenceId = null;  // å½“å‰è¯„è®ºåŒºæ˜¾ç¤ºçš„ç‰¹å®šå¥å­ ID
let currentViewingPageSentenceIds = null; // å½“å‰è¯„è®ºåŒºæ˜¾ç¤ºçš„é¡µé¢å¥å­ ID åˆ—è¡¨

        // å±€éƒ¨ä¿®æ”¹: å…³é—­è¯„è®ºåŒºæ—¶ï¼ŒåŒæ—¶å–æ¶ˆâ€œæŸ¥çœ‹æ¨¡å¼â€
closeCommentBtn.addEventListener('click', () => {
    commentPanel.classList.remove('show');
    disableCommentInputArea(false); // <--- æ–°å¢: æ¢å¤è¯„è®ºåŠŸèƒ½
    commentPanel.querySelector('h4').textContent = `è¯„è®º`; // <--- æ¢å¤æ ‡é¢˜
});

//åº”ç”¨ç‰¹æ•ˆä¸€å¼€å§‹è¦åšçš„åˆ†å¥å­
      function applyEffectsToLines(text, effectsPublished) {
  const lines = text.split(/\r?\n/);

  effectsPublished.forEach(effect => {
    const idx = effect.lineIndex;
    const type = effect.effectType;

    if (lines[idx] != null) {
      // åŒ…è£¹ä¸€å±‚ span
      lines[idx] =
        `<span class="effect-${type}">${lines[idx]}</span>`;
    }
  });

  return lines.join("\n");
}


        // å¦‚æœéœ€è¦ tokenï¼ˆå‘è¡¨è¯„è®º/ç‚¹èµï¼‰
        function getAuthHeader() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        /* ---------- åˆå§‹åŒ–éšè—çš„ renderer Quillï¼ˆç”¨äºæŠŠ Delta è½¬ä¸º HTMLï¼‰ ---------- */
        (function initRendererQuill() {
            const r = document.createElement('div');
            r.style.position = 'absolute';
            r.style.left = '-9999px';
            r.style.top = '-9999px';
            r.style.width = '10px';
            r.style.height = '10px';
            document.body.appendChild(r);
            // readOnly ä¸å½±å“ setContents çš„è¾“å‡º
            rendererQuill = new Quill(r, { theme: 'snow', modules: { toolbar: false }, readOnly: true });
        })();

// Delta -> HTMLï¼ˆå®‰å…¨é™çº§ï¼šå¦‚æœä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²å°±ç›´æ¥è¿”å›å­—ç¬¦ä¸²ï¼‰
function deltaToHtml(deltaOrHtml) {
    try {
        if (!deltaOrHtml) return '<p>ï¼ˆç©ºç™½ï¼‰</p>';
if (typeof deltaOrHtml === 'string') {
    // æ£€æµ‹å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ JSON æ ¼å¼çš„ Delta
    try {
        const maybeDelta = JSON.parse(deltaOrHtml);
        if (maybeDelta && maybeDelta.ops) {
            rendererQuill.setContents(maybeDelta);
            return rendererQuill.root.innerHTML;
        }
    } catch {}
    // å¦åˆ™ç›´æ¥å½“ HTML ä½¿ç”¨ï¼Œä¸åš escape
    return deltaOrHtml;
}
        
        rendererQuill.setContents(deltaOrHtml);
        const contentHtml = rendererQuill.root.innerHTML;

        // ğŸ’¥ å…³é”®ä¿®æ”¹ï¼šæ£€æµ‹æ˜¯å¦å·²æœ‰ .ql-editor å®¹å™¨ï¼Œé˜²æ­¢åµŒå¥—
// âœ… ä¿®æ”¹åï¼šä¸å†åŒ…è£¹ .ql-editorï¼Œä»¥å…åµŒå¥—
if (/<div class="ql-editor">/i.test(contentHtml)) {
    return contentHtml; 
}

// ç›´æ¥è¿”å›ç”Ÿæˆçš„ HTMLï¼Œä¸å†æ·»åŠ  .ql-editor å®¹å™¨
return contentHtml;
        
    } catch (e) {
        console.warn('deltaToHtml fallback', e);
        return '<p>ï¼ˆæ— æ³•æ˜¾ç¤ºæ­¤å†…å®¹ï¼‰</p>';
    }
}

/* ========== å…¨å±€åŠ è½½è¿›åº¦æ¡æ§åˆ¶å‡½æ•° ========== */
function startGlobalLoading() {
  const bar = document.getElementById('global-loading-bar');
  if (!bar) return;
  bar.style.width = '0%';
  bar.style.transition = 'none';
  requestAnimationFrame(() => {
    bar.style.transition = 'width 0.3s ease';
    bar.style.width = '10%';
  });
}

function updateGlobalLoadingProgress(percent, message) {
  const bar = document.getElementById('global-loading-bar');
  if (!bar) return;
  bar.style.width = `${percent}%`;
  if (message) console.log(`ğŸ“˜ ${message}`);
}

function endGlobalLoading() {
  const bar = document.getElementById('global-loading-bar');
  if (!bar) return;
  bar.style.width = '100%';
  setTimeout(() => {
    bar.style.width = '0%';
  }, 500);
}

async function loadWorkContentById(id) {
    if (!id) return displayError('ä½œå“IDæ— æ•ˆï¼Œè¯·è¿”å›ä¸»é¡µã€‚');

    // âœ… æ–°å¢ï¼šå¼€å§‹è¿›åº¦æ¡
    startGlobalLoading();

    try {
        const token = localStorage.getItem('token');
        const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
        const res = await fetch(`${API_WORKS}/${id}`, { headers });
        if (!res.ok) throw new Error(`HTTP ${res.status} - è·å–ä½œå“å¤±è´¥`);

        // âœ… è¿›åº¦æ›´æ–°
        updateGlobalLoadingProgress(30, 'æ­£åœ¨è§£æä½œå“æ•°æ®...');

        const work = await res.json();
        activeWork = work;

      // æ–°å¢ï¼šåŠ è½½ç‰¹æ•ˆ
const effectsPublished = work.effectsPublished || [];
activeWork.effectsPublished = effectsPublished;
console.log("ğŸ¨ å·²åŠ è½½ç‰¹æ•ˆï¼š", effectsPublished);


        // âœ… è¿›åº¦æ›´æ–°
        updateGlobalLoadingProgress(50, 'æ­£åœ¨åŠ è½½è¯„è®º...');

        // è·å–ä½œå“çš„æ‰€æœ‰è¯„è®º
        await fetchAllWorkComments(work.workId || id);

        // âœ… è¿›åº¦æ›´æ–°
        updateGlobalLoadingProgress(70, 'æ­£åœ¨æ¸²æŸ“ä½œå“å†…å®¹...');

        // å¤„ç† pages / content
        if (Array.isArray(work.pages) && work.pages.length > 0) {
            activePages = work.pages;
        } else if (Array.isArray(work.content) && work.content.length > 0) {
            activePages = work.content;
        } else {
            activePages = [{ content: { ops: [] } }];
        }

        // æ›´æ–°é¡µé¢åŸºæœ¬ä¿¡æ¯
        document.title = (work.title || 'ä½œå“') + ' - ä½œå“è¯¦æƒ…';
        workTitle.textContent = work.title || 'æœªå‘½å';
        workAuthor.textContent = work.author ? (work.author.username || 'ä½œè€…') : 'æœªçŸ¥';
        workDate.textContent = work.updatedAt
            ? `æ›´æ–°æ—¶é—´ï¼š${new Date(work.updatedAt).toLocaleString()}`
            : `æ›´æ–°æ—¶é—´ï¼šæœªçŸ¥`;

        // -------------------------
        // å¤„ç†æ¯é¡µå†…å®¹
        // -------------------------
        let sentenceIndex = 0;
        activePages.forEach(page => {
            if (!page.content) page.content = { ops: [] };
            let html = '';

            if (typeof page.content === 'object' && page.content.ops) {
                rendererQuill.setContents(page.content);
let rawHtml = rendererQuill.root.innerHTML;

// ğŸ“Œ 1) å…ˆæŠŠ HTML æŒ‰è¡Œåˆ‡å‰²
let plainText = rawHtml
  .replace(/<\/p>/g, "\n")
  .replace(/<[^>]+>/g, "")
  .trim();

// ğŸ“Œ 2) åº”ç”¨ç‰¹æ•ˆ
plainText = applyEffectsToLines(plainText, activeWork.effectsPublished || []);

// ğŸ“Œ 3) è½¬æ¢å› HTMLï¼ˆå°†\næ¢æˆ<p>ï¼‰
let effectedHtml = plainText.split("\n")
    .map(line => `<p>${line}</p>`)
    .join("");

// ğŸ“Œ 4) å†è¿›è¡Œåˆ†å¥å­ + æ³¨å…¥ID
const { element: tempDiv, nextIndex } = segmentContentAndAddIds(effectedHtml, work._id, sentenceIndex);
sentenceIndex = nextIndex;
page.segmentedHtml = tempDiv.innerHTML;

                console.log("âœ… Quill ç”Ÿæˆ HTML:", rawHtml.slice(0, 200));

                const { element: tempDiv, nextIndex } = segmentContentAndAddIds(rawHtml, work._id, sentenceIndex);
                sentenceIndex = nextIndex;
                page.segmentedHtml = tempDiv.innerHTML;
            } else {
                html = page.content || '<p>ï¼ˆç©ºç™½é¡µé¢ï¼‰</p>';
                const { element: tempDiv, nextIndex } = segmentContentAndAddIds(html, work._id, sentenceIndex);
                sentenceIndex = nextIndex;
                page.segmentedHtml = tempDiv.innerHTML;
            }
        });

        renderCurrentMode();

        // âœ… åŠ è½½å®Œæˆ
        updateGlobalLoadingProgress(100, 'åŠ è½½å®Œæˆï¼');

    } catch (err) {
        console.error('loadWorkContentById é”™è¯¯:', err);
        displayError(`åŠ è½½ä½œå“å¤±è´¥: ${err.message}`);
        updateGlobalLoadingProgress(100, 'åŠ è½½å¤±è´¥');
    } finally {
        // âœ… æ–°å¢ï¼šç»“æŸè¿›åº¦æ¡
        endGlobalLoading();
    }
}


function segmentContentAndAddIds(rawHtmlContent, workId, startIndex = 0) {
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = rawHtmlContent;
  let counter = startIndex;
  Array.from(tempDiv.children).forEach(el => {
    if (el.nodeType === 1 && el.tagName !== 'SCRIPT' && el.textContent.trim() !== '') {
      if (!el.hasAttribute('data-sentence-id')) {
        const sentenceId = `s_${workId}_${counter++}`;
        el.setAttribute('data-sentence-id', sentenceId);
      }
    }
  });

  console.log("ğŸ§© segmentContentAndAddIds ç”Ÿæˆçš„ ID:", 
      Array.from(tempDiv.querySelectorAll('[data-sentence-id]')).map(el => el.dataset.sentenceId)
  );

  return { element: tempDiv, nextIndex: counter };
}



      // ã€æ–°å¢å‡½æ•°ã€‘ï¼šè·å–ä½œå“æ‰€æœ‰è¯„è®ºï¼Œå¹¶æ›´æ–°å…¨å±€çŠ¶æ€
async function fetchAllWorkComments(workId) {
  try {
    const headers = getAuthHeader();
    const commentsRes = await fetch(`${API_COMMENTS}/work/${workId}`, { headers });
    if (!commentsRes.ok) throw new Error('è·å–æ‰€æœ‰ä½œå“è¯„è®ºå¤±è´¥');
    allComments = await commentsRes.json();
    commentedSentenceIds = new Set(allComments.map(c => c.sentenceId));

    console.log("ğŸ§© allComments ç¤ºä¾‹ï¼š", allComments.slice(0, 5));
    console.log("ğŸ§© commentedSentenceIds ç¤ºä¾‹ï¼š", Array.from(commentedSentenceIds).slice(0, 5));
    console.log(`ä½œå“å…±æœ‰ ${allComments.length} æ¡è¯„è®ºï¼Œåˆ†å¸ƒåœ¨ ${commentedSentenceIds.size} ä¸ªå¥å­ä¸Šã€‚`);
  } catch (error) {
    console.error('åŠ è½½è¯„è®ºæ•°æ®å¤±è´¥:', error);
  }
}


        /* ---------- displayErrorï¼ˆä¸è¦æ“ä½œ Quill çš„ DOMï¼‰ ---------- */
        function displayError(message) {
            // ç»Ÿä¸€æŠŠé”™è¯¯ç›´æ¥å†™å…¥ bookContentï¼ˆæˆ‘ä»¬ä¸åœ¨è¿™é‡Œç»‘å®š Quill åˆ° bookContentï¼‰
            bookContent.innerHTML = `<p style="color:red;text-align:center;">${escapeHtml(message)}</p>`;
            workTitle.textContent = 'é”™è¯¯';
        }

        function escapeHtml(text) {
            const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }

 // ...
/* ---------- æ¸²æŸ“å™¨ï¼šæ¥¼å±‚ï¼ˆæ»šåŠ¨ï¼‰æ¨¡å¼ ---------- */
function renderScrollMode() {
    // 1. æ¸…ç†ç¯å¢ƒ
    destroyPageModeQuill();
    bookContent.innerHTML = ''; // bookContent ä¸å†æ˜¯ quill çš„ container

    // 2. éå†å¹¶æ¸²æŸ“æ‰€æœ‰æ¥¼å±‚
    activePages.forEach((page, pageIndex) => {
        const floorDiv = document.createElement('div');
        floorDiv.className = 'floor';
        floorDiv.dataset.pageIndex = String(pageIndex);

        const header = document.createElement('div');
        header.className = 'floor-header';
        
        // 1. å·¦ä¾§ï¼šæ¥¼å±‚ä¿¡æ¯
        const updatedAt = page.updatedAt 
    ? new Date(page.updatedAt).toLocaleString()
    : (activeWork.updatedAt 
        ? new Date(activeWork.updatedAt).toLocaleString() 
        : 'æœªçŸ¥');
        const leftText = document.createElement('span');
        leftText.textContent = `ç¬¬ ${pageIndex + 1} æ¥¼ Â· æ›´æ–°æ—¶é—´ï¼š${updatedAt}`;

        // 2. å³ä¾§ï¼šæŸ¥çœ‹è¯„è®ºæŒ‰é’®
        const commentBtn = document.createElement('button');
        commentBtn.className = 'comment-view-btn';
        // å‡è®¾ page.commentsCount å­—æ®µå­˜åœ¨
        const commentCount = getCommentsCountForPage(pageIndex);
        commentBtn.textContent = `æŸ¥çœ‹è¯„è®º (${commentCount})`; 
        commentBtn.dataset.pageIndex = String(pageIndex);
        
        commentBtn.addEventListener('click', () => {
            // ç‚¹å‡»æ—¶ä»¥æŸ¥çœ‹æ¨¡å¼æ‰“å¼€è¯¥æ¥¼å±‚çš„æ‰€æœ‰è¯„è®º
            openCommentPanelForPage(pageIndex); 
        });

        header.appendChild(leftText);
        header.appendChild(commentBtn); 

        const body = document.createElement('div');
        body.className = 'floor-body';
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šç›´æ¥ä½¿ç”¨ç¼“å­˜çš„å¸¦æœ‰ ID çš„ HTML
        // ID æ³¨å…¥å’Œè®¡æ•°å™¨æ›´æ–°å·²ç»åœ¨ loadWorkContentById ä¸­å®Œæˆ
        body.innerHTML = page.segmentedHtml || ''; 

        floorDiv.appendChild(header);
        floorDiv.appendChild(body);
        
        bookContent.appendChild(floorDiv);
    });


    // 4. æ¸²æŸ“å·¦ä¾§æ¥¼å±‚å¯¼èˆª
    renderSidebar(activePages.length, 'floor');
  processContentForSentenceIds(bookContent);

}

        /* ---------- æ¸²æŸ“å™¨ï¼šç¿»é¡µï¼ˆå•é¡µï¼‰æ¨¡å¼ ---------- */
        function destroyPageModeQuill() {
            // å¦‚æœä¹‹å‰å­˜åœ¨ pageQuillï¼Œéœ€è¦åˆ é™¤å®ƒçš„å®¹å™¨å¹¶é‡Šæ”¾å¼•ç”¨
            if (pageQuill) {
                const container = pageQuill.root && pageQuill.root.parentElement;
                try { pageQuill.disable(); } catch(e) {}
                pageQuill = null;
                if (container && container.parentNode) container.parentNode.removeChild(container);
            }
        }

function renderPageMode() {
    // 1. æ¸…ç†ç¯å¢ƒ
    destroyPageModeQuill();
    bookContent.innerHTML = '';
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page-view';
    // container for Quill
    const quillContainer = document.createElement('div');
    quillContainer.id = 'quill-page-view';
    quillContainer.style.minHeight = '200px';
    pageDiv.appendChild(quillContainer);

    // 2. é¡µè„šï¼ˆåŒ…å«è¯„è®ºæŒ‰é’®ï¼‰
    const footer = document.createElement('div');
    footer.className = 'page-footer';
    
    // å¢åŠ è¯„è®ºæŒ‰é’®çš„ HTML ç»“æ„
    footer.innerHTML = `
        <button id="prev-page">ä¸Šä¸€é¡µ</button>
        <span id="page-indicator">ç¬¬ ${currentPageIndex + 1} / ${activePages.length}</span>
        <button id="next-page">ä¸‹ä¸€é¡µ</button>
         
    `;

    pageDiv.appendChild(footer);
    bookContent.appendChild(pageDiv); // ğŸ’¥ æ­¤æ—¶æŒ‰é’®å·²è¿›å…¥ DOM

    // 3. åˆå§‹åŒ– Quill
    pageQuill = new Quill('#quill-page-view', { theme: 'snow', readOnly: true, modules: { toolbar: false } });

    // 4. åŠ è½½å½“å‰é¡µå†…å®¹
    loadPageIntoPageQuill(currentPageIndex);

    // 5. ç»‘å®šç¿»é¡µæŒ‰é’®
    document.getElementById('prev-page')?.addEventListener('click', () => { // å¢åŠ  ?. æ£€æŸ¥
        if (currentPageIndex > 0) {
            currentPageIndex--;
            loadPageIntoPageQuill(currentPageIndex);
            window.scrollTo(0,0);
        }
    });
    document.getElementById('next-page')?.addEventListener('click', () => { // å¢åŠ  ?. æ£€æŸ¥
        if (currentPageIndex < activePages.length - 1) {
            currentPageIndex++;
            loadPageIntoPageQuill(currentPageIndex);
            window.scrollTo(0,0);
        }
    });

    // 6. ç»‘å®šç¿»é¡µæ¨¡å¼ä¸‹çš„è¯„è®ºæŒ‰é’®äº‹ä»¶ (ä¿®å¤é‡å¤ç»‘å®š + å¥å£®æ€§)
    
    // ğŸ’¥ ä¿®å¤é‡å¤ç»‘å®šï¼šç”¨å…‹éš†èŠ‚ç‚¹æ›¿æ¢è‡ªèº«ï¼Œä»¥æ¸…é™¤æ—§ç›‘å¬å™¨
    let commentBtn = document.getElementById('page-view-comment-btn');
    
    // ğŸ’¥ å…³é”®å¥å£®æ€§æ£€æŸ¥: å¦‚æœæŒ‰é’®ä¸å­˜åœ¨ï¼Œåˆ™åœæ­¢åç»­æ“ä½œ
    if (!commentBtn) {
         console.error('è¯„è®ºæŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶ã€‚');
         return; 
    }
    
    const newCommentBtn = commentBtn.cloneNode(true);
    commentBtn.replaceWith(newCommentBtn); // æ›¿æ¢æ—§å…ƒç´ ï¼Œæ¸…é™¤æ—§ç›‘å¬å™¨

    // ç»‘å®šäº‹ä»¶åˆ°æ–°çš„æŒ‰é’®ä¸Š
    newCommentBtn.addEventListener('click', () => {
        // ç¿»é¡µæ¨¡å¼ä¸‹ï¼Œç›´æ¥ä½¿ç”¨å½“å‰çš„ currentPageIndex ä½œä¸º pageIndex
        openCommentPanelForPage(currentPageIndex);
    });

    // 7. æ¸²æŸ“å·¦ä¾§é¡µç å¯¼èˆª
    renderSidebar(activePages.length, 'page');

  const pageCommentBtn = document.getElementById('page-view-comment-btn');
if (pageCommentBtn) {
    const commentCount = getCommentsCountForPage(pageIndex);
    pageCommentBtn.textContent = `æŸ¥çœ‹è¯„è®º (${commentCount})`;
}
processContentForSentenceIds(bookContent);
}

        // ã€ä¿®æ”¹ script.txt: 91-96 è¡Œé™„è¿‘ï¼Œåœ¨ loadPageIntoPageQuill å‡½æ•°ä½“å†…éƒ¨ã€‘
function loadPageIntoPageQuill(pageIndex) {
    if (!pageQuill) return;
    const pageObj = activePages[pageIndex] || { content: { ops: [] } };
    
    let contentHtml = '';
    
    // 1. è·å–åŸå§‹å†…å®¹ï¼ˆé€šå¸¸æ˜¯ Delta æˆ– HTMLï¼‰
    try {
        if (typeof pageObj.content === 'object') {
            // å°† Delta è½¬æ¢ä¸º HTML
            contentHtml = deltaToHtml(pageObj.content); 
        } else {
            // å¦‚æœåç«¯å­˜çš„æ˜¯ html å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
            contentHtml = pageObj.content || '<p>ï¼ˆç©ºç™½ï¼‰</p>';
        }
    } catch (e) {
        console.warn('loadPageIntoPageQuill deltaToHtml fallback', e);
        contentHtml = '<p>ï¼ˆæ— æ³•æ˜¾ç¤ºï¼‰</p>';
    }
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šä½¿ç”¨ç¼“å­˜çš„èµ·å§‹ç´¢å¼•é‡æ–°æ³¨å…¥ SentenceId
    // 2. ç¡®å®šè¯¥é¡µé¢çš„èµ·å§‹ç´¢å¼•ï¼ˆå·²åœ¨ loadWorkContentById ä¸­ç¼“å­˜ï¼‰
    const pageStartIndex = pageObj.sentenceStartIndex ?? 0;
    
    // 3. è°ƒç”¨æ— å‰¯ä½œç”¨çš„ ID æ³¨å…¥å‡½æ•°ï¼Œä½¿ç”¨å›ºå®šçš„èµ·å§‹ç´¢å¼•
    // æ³¨æ„ï¼šä¸æ›´æ–°å…¨å±€ contentIndexCounter
    const result = segmentContentAndAddIds(contentHtml, activeWork._id, pageStartIndex);
    
    // 4. å°†å¸¦æœ‰ ID çš„ HTML æ³¨å…¥åˆ° Quill çš„æ ¹å…ƒç´ ä¸­ (ç»•è¿‡ setContents å¯¼è‡´çš„ ID ä¸¢å¤±)
    // âš ï¸ å¿…é¡»ç›´æ¥æ“ä½œ root.innerHTML
    pageQuill.root.innerHTML = result.element.innerHTML;

    // æ›´æ–°é¡µç æŒ‡ç¤º
    const indicator = document.getElementById('page-indicator');
    if (indicator) indicator.textContent = `ç¬¬ ${pageIndex + 1} / ${activePages.length}`;
    
    // 5. æ ‡è®°å†…å®¹å¹¶ç»‘å®šäº‹ä»¶ (ç»‘å®šå¥æœ«è¯„è®ºæ ‡è¯†å’Œå¥å­ç‚¹å‡»äº‹ä»¶)
const pageCommentBtn = document.getElementById('page-view-comment-btn');
if (pageCommentBtn) {
    const commentCount = getCommentsCountForPage(pageIndex);
    pageCommentBtn.textContent = `æŸ¥çœ‹è¯„è®º (${commentCount})`;
}
  processContentForSentenceIds(pageQuill.root);

}

// ã€ä¿®æ”¹ script.txt: 87 è¡Œé™„è¿‘ï¼Œåœ¨ renderPageMode å‡½æ•°ä½“å†…éƒ¨ã€‘
    // æ–°å¢: ç»‘å®šç¿»é¡µæ¨¡å¼ä¸‹çš„è¯„è®ºæŒ‰é’®äº‹ä»¶
const pageContainer = document.getElementById('page-container'); // æŒ‰é’®çš„çˆ¶å®¹å™¨
if (pageContainer) {
    pageContainer.addEventListener('click', (e) => {
        if (e.target && e.target.id === 'page-view-comment-btn') {
            openCommentPanelForPage(currentPageIndex);
        }
    });
}


    // ã€åˆ é™¤æˆ–æ³¨é‡Šæ‰æ—§çš„ addCommentListenersToContainer è°ƒç”¨ã€‘
    // addCommentListenersToContainer(pageQuill.root, currentPageIndex); [cite: 88]
        

/* ---------- æ¸²æŸ“å·¦ä¾§å¯¼èˆªï¼ˆæ¥¼å±‚æˆ–é¡µç ï¼‰ ---------- */
function renderSidebar(total, type) {
    // æ¨¡å¼åˆ‡æ¢æŒ‰é’®å’Œå¤œé—´æ¨¡å¼æŒ‰é’®å·²åœ¨ HTML ä¸­å†™æ­»
    // æˆ‘ä»¬åªåœ¨ JS ä¸­ä¸ºå®ƒä»¬ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    // ğŸš¨ ç§»é™¤äº† scrollBtnGroup å’Œ pageBtnGroup çš„è·å–å’Œç›‘å¬å™¨ç»‘å®š
    const navToggleBtnGroup = document.getElementById('nav-toggle-btn');
    const navToggleIcon = navToggleBtnGroup.querySelector('button');

    // æ›´æ–°å¯¼èˆªæŒ‰é’®çš„å›¾æ ‡
    navToggleIcon.innerHTML = type === 'floor' ? '&#8635;' : '&#x2194;';

    // ğŸš¨ ç§»é™¤äº† navToggleBtnGroup çš„äº‹ä»¶ç›‘å¬å™¨ç»‘å®š
    /*
    // åŸæ¥çš„ scroll/page/navToggleBtnGroup.addEventListener('click', ...) ä»£ç å·²ç§»é™¤
    // è¿™äº›äº‹ä»¶ç›‘å¬å™¨åªéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶ç»‘å®šä¸€æ¬¡
    */

    // é‡æ–°åˆ›å»ºå¯¼èˆªç½‘æ ¼æµ®çª—ï¼ˆè¿™éƒ¨åˆ†æ˜¯æ­£ç¡®çš„ï¼Œéœ€è¦ä¿ç•™ï¼‰
    const navPopup = document.getElementById('nav-grid-popup');
    navPopup.innerHTML = '';
    for (let i = 0; i < total; i++) {
        const cell = document.createElement('div');
        cell.className = 'nav-cell';
        cell.textContent = i + 1;
        cell.dataset.targetIndex = String(i);
        cell.addEventListener('click', () => {
            if (type === 'floor') {
                const el = document.querySelector(`[data-page-index="${i}"]`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                currentPageIndex = i;
                currentMode = 'page';
                // è¿™é‡Œè°ƒç”¨ renderCurrentMode æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºå®ƒåªæ›´æ–°ä¸»ä½“å†…å®¹
                renderCurrentMode(); 
                window.scrollTo(0, 0);
            }
            // ç‚¹å‡»åå…³é—­æµ®çª—
            navPopup.classList.remove('show');
        });
        navPopup.appendChild(cell);
    }
}

   // åˆ‡æ¢å¤œé—´æ¨¡å¼
function toggleDarkMode() {
    const isDarkMode = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false');
    // åŒæ—¶æ›´æ–°å…¶ä»–å…ƒç´ 
    document.querySelector('.book-container').classList.toggle('dark-mode', isDarkMode);
    document.querySelector('.comment-panel').classList.toggle('dark-mode', isDarkMode);
    document.getElementById('nav-grid-popup').classList.toggle('dark-mode', isDarkMode);
    document.querySelectorAll('.floor, .page-view').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
    document.querySelectorAll('.sidebar-btn-group').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
    // ğŸ’¥ å…³é”®ä¿®æ­£: ç¡®ä¿ #sidebar æœ¬èº«è·å¾— dark-mode ç±»
    document.getElementById('sidebar').classList.toggle('dark-mode', isDarkMode);
    
    // ğŸ’¥ æ–°å¢: éå†æ‰€æœ‰å·²å­˜åœ¨çš„è¯„è®ºé¡¹å¹¶æ›´æ–°ç±»
    document.querySelectorAll('.comment-item').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
    // ğŸ’¥ æ–°å¢: æ›´æ–°ç¿»é¡µæŒ‰é’®çš„ dark-mode ç±» (å¦‚æœå­˜åœ¨)
    document.querySelector('.page-footer')?.classList.toggle('dark-mode', isDarkMode);
}

// åˆå§‹åŒ–å¤œé—´æ¨¡å¼
function initDarkMode() {
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.querySelector('.book-container').classList.add('dark-mode');
        document.querySelector('.comment-panel').classList.add('dark-mode');
        document.getElementById('nav-grid-popup').classList.add('dark-mode');
        document.querySelectorAll('.floor, .page-view').forEach(el => el.classList.add('dark-mode'));
        document.querySelectorAll('.sidebar-btn-group').forEach(el => el.classList.add('dark-mode'));
        // ğŸ’¥ å…³é”®ä¿®æ­£: ç¡®ä¿ #sidebar æœ¬èº«è·å¾— dark-mode ç±»
        document.getElementById('sidebar').classList.add('dark-mode');
        // ğŸ’¥ æ–°å¢: æ›´æ–°ç¿»é¡µæŒ‰é’®çš„ dark-mode ç±» (å¦‚æœå­˜åœ¨)
        document.querySelector('.page-footer')?.classList.add('dark-mode');
    }
}

// ã€æ–°å¢å‡½æ•°ã€‘ï¼šè®¾ç½®è¯„è®ºåˆ—è¡¨çš„äº‹ä»¶å§”æ‰˜ï¼ˆåªéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰
function setupCommentDelegation() {
    // 1. å›å¤ï¼ˆç‚¹å‡» comment-itemï¼‰å’Œç‚¹èµï¼ˆç‚¹å‡» .like-btnï¼‰çš„äº‹ä»¶å§”æ‰˜
    commentList.addEventListener('click', (e) => {
        const item = e.target.closest('.comment-item');
        const btn = e.target.closest('.like-btn');

        if (btn) {
            // --- ç‚¹èµé€»è¾‘ ---
            e.stopPropagation(); 
            const token = localStorage.getItem('token');
            if (!token) { alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµã€‚'); return; }
            
            const commentItem = btn.closest('.comment-item');
            const commentId = commentItem.dataset.commentId;
            
            // å¼‚æ­¥æ‰§è¡Œç‚¹èµæ“ä½œ
            (async () => {
                try {
                    const res = await fetch(`${API_COMMENTS}/${commentId}/like`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error('ç‚¹èµå¤±è´¥');
                    const data = await res.json();
                    
                    // æ›´æ–° UI
                    const countSpan = commentItem.querySelector('.like-count');
                    countSpan.textContent = data.likesCount;
                    btn.classList.toggle('liked', data.isLikedByCurrentUser);
                } catch (err) {
                    console.error('like error', err);
                    alert('ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                }
            })();

        } else if (item) {
            // --- å›å¤é€»è¾‘ ---
            const author = item.querySelector('.comment-author')?.textContent || 'åŒ¿å';
            commentTextarea.value = `@${author} `;
            commentTextarea.focus();
        }
    });
}
      
        /* ---------- è¯„è®ºï¼šæ¸²æŸ“ & æ“ä½œ ---------- */
        function renderComments(comments) {
            commentList.innerHTML = '';
            if (!comments || comments.length === 0) {
                commentList.innerHTML = '<p class="no-comments-tip">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>';
                return;
            }
            comments.forEach(c => {
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.dataset.commentId = c._id;
                const author = escapeHtml(c.author || 'åŒ¿å');
                const content = escapeHtml(c.content || '');
                const likes = Number(c.likesCount || 0);
                const likedClass = c.isLikedByCurrentUser ? 'liked' : '';
                item.innerHTML = `
                    <strong class="comment-author">${author}</strong>
                    <p class="comment-content">${content}</p>
                    <div class="comment-actions">
                        <button class="like-btn ${likedClass}">â¤</button>
                        <span class="like-count">${likes}</span>
                    </div>
                `;
                commentList.appendChild(item);
            });
            // ç»‘å®šåŠ¨ä½œ
            //addCommentActionListeners(); ï¼ˆå¸®æˆ‘æ£€æŸ¥ä¸€éï¼Œä¸å†éœ€è¦è¿™ä¸ªäº†æ˜¯å§ï¼Ÿï¼‰
        }


      // ... ç´§æ¥åœ¨ submitComment å‡½æ•°ä¹‹å‰
function disableCommentInputArea(disable) {
    const commentPanel = document.getElementById('comment-panel');
    // viewer-mode æ ·å¼åº”è´Ÿè´£éšè—è¯„è®ºè¾“å…¥æ¡†
    commentPanel.classList.toggle('viewer-mode', disable);
}

      // ã€æ–°å¢å‡½æ•°ï¼šåœ¨ renderComments æˆ– fetchPageComments é™„è¿‘æ’å…¥ã€‘

function openCommentPanelForPage(pageIndex) {
    const pageObj = activePages[pageIndex];
    if (!pageObj) return;
    
    const pageTitle = `ç¬¬ ${pageIndex + 1} æ¥¼/é¡µ`;
    const commentPanel = document.getElementById('comment-panel');
    const header = commentPanel.querySelector('h4');
    
    disableCommentInputArea(true);
    activeSentenceEl = null;

    // âœ… æ”¹åŠ¨ç‚¹ï¼šç›´æ¥ä½¿ç”¨å·²ç¼“å­˜çš„ HTMLï¼Œè€Œä¸æ˜¯å†è·‘ deltaToHtml
    const htmlContent = pageObj.segmentedHtml || '<p>ï¼ˆç©ºç™½ï¼‰</p>';

    // ä¸´æ—¶è§£æ HTMLï¼Œæå–æ‰€æœ‰å¥å­ ID
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    const pageSentenceIds = Array.from(tempDiv.querySelectorAll('[data-sentence-id]'))
        .map(el => el.getAttribute('data-sentence-id'));

    // è¿‡æ»¤å‡ºè¯¥é¡µçš„æ‰€æœ‰è¯„è®º
    const commentsForPage = allComments.filter(c => pageSentenceIds.includes(c.sentenceId));
    
    renderComments(commentsForPage);
    header.textContent = `${pageTitle} çš„æ‰€æœ‰è¯„è®º (${commentsForPage.length} æ¡)`;
    
    commentPanel.classList.add('show');
}


// ã€æ–°å¢å‡½æ•°ã€‘ï¼šæ‰“å¼€è¯„è®ºåŒºå¹¶åŠ è½½/è¿‡æ»¤è¯„è®º (å¥å­çº§åˆ«ï¼šç»Ÿä¸€å…¥å£)
function openCommentPanelForSentence(sentenceId, isNewCommentMode = false) {
    const panel = document.getElementById('comment-panel');
    const header = panel.querySelector('h4');
    
    // 1. è¿‡æ»¤è¯„è®ºï¼šåªä¿ç•™ç›®æ ‡å¥å­IDçš„è¯„è®º
  console.log("ğŸ§© æ‰“å¼€å¥å­è¯„è®ºé¢æ¿:", sentenceId);
  const filteredComments = allComments.filter(c => c.sentenceId === sentenceId);
  console.log("ğŸ§© å½“å‰å¥å­å¯¹åº”çš„è¯„è®º:", filteredComments);
    
    // 2. æ¸²æŸ“è¯„è®ºåˆ—è¡¨
    renderComments(filteredComments);

    // 3. åˆ‡æ¢è¯„è®ºåŒºçŠ¶æ€
    if (isNewCommentMode) {
        header.textContent = `è¯„è®ºç›®æ ‡å¥å­`;
        disableCommentInputArea(false); // å¯ç”¨è¾“å…¥åŒº (æ’°å†™æ¨¡å¼)
        
        // æ›´æ–°å…¨å±€çŠ¶æ€ï¼Œä¾› submitComment ä½¿ç”¨
        activeSentenceEl = document.querySelector(`[data-sentence-id="${sentenceId}"]`);
    } else {
        header.textContent = `å¥å­è¯„è®º (${filteredComments.length} æ¡)`;
        disableCommentInputArea(true); // ç¦ç”¨è¾“å…¥åŒº (ä»…æŸ¥çœ‹æ¨¡å¼)
        activeSentenceEl = null; 
    }

    // 4. é«˜äº®å½“å‰å¥å­
    // ç§»é™¤æ‰€æœ‰é«˜äº®
    document.querySelectorAll('.active-comment-target').forEach(el => el.classList.remove('active-comment-target'));
    // ä¸ºç›®æ ‡å¥å­å…ƒç´ æ·»åŠ é«˜äº®
    const targetEl = document.querySelector(`[data-sentence-id="${sentenceId}"]`);
    if (targetEl) {
        targetEl.classList.add('active-comment-target');
    }

    // 5. æ˜¾ç¤ºè¯„è®ºåŒº
    panel.classList.add('show');
}

// ã€æ–°å¢å‡½æ•°ã€‘ï¼šå¤„ç†æ¸²æŸ“åçš„å†…å®¹ï¼Œæ·»åŠ è¯„è®ºæ ‡è¯†å’Œäº‹ä»¶ (æ³¨ï¼šè¯·å¸®æˆ‘çœ‹çœ‹è¿™è¾¹æ˜¯å¦å’Œä¸Šé¢çš„æœ‰é‡å¤ï¼Œå› æ­¤éœ€è¦åˆ é™¤)
function processContentForSentenceIds(containerEl) {
    // ç¡®ä¿ç§»é™¤æ—§çš„é«˜äº®å’Œæ ‡è¯†
    document.querySelectorAll('.active-comment-target').forEach(el => el.classList.remove('active-comment-target'));
    containerEl.querySelectorAll('.comment-indicator').forEach(el => el.remove());

    const sentenceElements = containerEl.querySelectorAll('[data-sentence-id]');
    
    sentenceElements.forEach(el => {
        const sentenceId = el.getAttribute('data-sentence-id');
        
        // 1. æ·»åŠ å¥æœ«è¯„è®ºæ ‡è¯† (å¦‚æœè¯¥å¥å­æœ‰è¯„è®º)
        if (commentedSentenceIds.has(sentenceId)) {
            const indicator = document.createElement('span');
            indicator.className = 'comment-indicator';
            indicator.setAttribute('data-sentence-id', sentenceId);
            
            // å°†æ ‡è¯†æ·»åŠ åˆ°å¥å­å†…å®¹çš„æœ«å°¾
            el.appendChild(indicator);
            
            // ç›‘å¬ç‚¹å‡»äº‹ä»¶ï¼šå±•å¼€è¯„è®ºåŒºå¹¶è¿‡æ»¤åˆ°è¯¥å¥å­ (ä»…æŸ¥çœ‹æ¨¡å¼)
            indicator.addEventListener('click', (e) => {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶çº§
                openCommentPanelForSentence(sentenceId, false); 
            });
        }

        // 2. ç›‘å¬æ•´ä¸ªå¥å­çš„ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºå‘è¡¨æ–°è¯„è®ºï¼‰
        el.addEventListener('click', (e) => {
            // å¦‚æœç‚¹å‡»çš„æ˜¯è¯„è®ºæ ‡è¯†ï¼Œåˆ™è·³è¿‡
            if (e.target.classList.contains('comment-indicator')) {
                return;
            }
            // åˆ‡æ¢ç›®æ ‡å¥å­çš„æ¿€æ´»çŠ¶æ€ & å¼€å¯è¯„è®ºåŒºï¼Œè¿›å…¥æ’°å†™è¯„è®ºæ¨¡å¼
            openCommentPanelForSentence(sentenceId, true); 
        });
    });
}

// ã€ä¿®æ”¹ openCommentPanelForViewerMode å‡½æ•°ä½“ï¼Œçº¦ é™„è¿‘ã€‘
// ç”¨æ–°çš„å‡½æ•°æ›¿æ¢æ—§çš„å¤æ‚é€»è¾‘
async function openCommentPanelForViewerMode(workId, pageIndex) {
    openCommentPanelForPage(pageIndex);
}


// æäº¤è¯„è®º async function submitComment() { ... (ä¿æŒä¸å˜)
      
        // æäº¤è¯„è®º
        async function submitComment() {
            const token = localStorage.getItem('token');
            if (!token) { alert('è¯·å…ˆç™»å½•æ‰èƒ½å‘è¡¨è¯„è®ºã€‚'); return; }
            if (!activeWork || !activeWork._id || !activeSentenceEl) { alert('è¯„è®ºç›®æ ‡æœªé€‰ä¸­ã€‚'); return; }
            const sentenceId = activeSentenceEl.dataset.sentenceId;
            if (!sentenceId) { alert('è¯¥æ®µè½æ— æ³•è¯„è®ºã€‚'); return; }
            const content = commentTextarea.value.trim();
            if (!content) { alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºã€‚'); return; }
            try {
                const res = await fetch(API_COMMENTS, {
                    method: 'POST',
                    headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeader()),
                    body: JSON.stringify({
  workId: activeWork._id || activeWork.workId,
  sentenceId,
  content
})

                });
                if (!res.ok) {
                    const errJson = await res.json().catch(()=>null);
                    throw new Error(errJson?.message || 'å‘è¡¨è¯„è®ºå¤±è´¥');
                }
                alert('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
                commentTextarea.value = '';
                // ã€æ–°å¢ã€‘ï¼šæˆåŠŸåï¼Œé‡æ–°è·å–å¹¶æ ‡è®°å†…å®¹
                await fetchAllWorkComments(activeWork._id); // é‡æ–°è·å–æ•°æ®
                // åˆ·æ–°å½“å‰æ¨¡å¼çš„ UI (é‡æ–°è¿è¡Œæ ‡è®°é€»è¾‘)
                renderCurrentMode(); 
                // é‡æ–°åŠ è½½å¹¶æ˜¾ç¤ºå½“å‰å¥å­çš„è¯„è®ºåˆ—è¡¨ï¼Œä¿æŒæ’°å†™æ¨¡å¼
                openCommentPanelForSentence(sentenceId, true);
            } catch (err) {
                console.error('submitComment error', err);
                alert('å‘è¡¨è¯„è®ºå¤±è´¥ï¼š' + (err.message || err));
            }
        }
        submitCommentBtn.addEventListener('click', submitComment);

        /* ---------- åˆ‡æ¢/æ¸²æŸ“å½“å‰æ¨¡å¼ ---------- */
function renderCurrentMode() {
    if (!activeWork) return;
    if (currentMode === 'scroll') {
        renderScrollMode();
    } else {
        renderPageMode();
    }

    // âœ… å»¶è¿Ÿç»‘å®šï¼Œç¡®ä¿ Quill/HTML å®Œå…¨æ¸²æŸ“åå†æ‰§è¡Œ
    setTimeout(() => {
        const root = currentMode === 'scroll' ? bookContent : (pageQuill?.root || bookContent);
        if (root) {
            processContentForSentenceIds(root);
            console.log('âœ… è¯„è®ºå¥å­ç‚¹å‡»ç»‘å®šå®Œæˆ');
        }
    }, 50);
}

        /* ---------- ä½œå“ç‚¹èµåŠŸèƒ½ ---------- */
        async function toggleWorkLike() {
            if (!activeWork || !activeWork._id) return;
            const token = localStorage.getItem('token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµä½œå“ã€‚');
                return;
            }
            try {
                const res = await fetch(`${API_WORKS}/${activeWork._id}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('ç‚¹èµå¤±è´¥');
                const data = await res.json();
                updateLikeStatus(data.likesCount, data.isLikedByCurrentUser);
            } catch (err) {
                console.error('work like error', err);
                alert('ç‚¹èµæ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }

        function updateLikeStatus(likesCount, isLiked) {
            likeCounter.textContent = likesCount;
            likeIcon.classList.toggle('liked', isLiked);
        }

        likeWorkBtn.addEventListener('click', toggleWorkLike);
        
        // ç»‘å®šå¤œé—´æ¨¡å¼åˆ‡æ¢æŒ‰é’®
        document.getElementById('light-switch-btn').addEventListener('click', toggleDarkMode);


        /* ---------- å¯åŠ¨ï¼šä» URL è·å– ID å¹¶åŠ è½½ä½œå“ ---------- */
        function getWorkIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

          // ğŸ’¥ æ–°å¢ï¼šåªéœ€è°ƒç”¨ä¸€æ¬¡ï¼Œè®¾ç½®è¯„è®ºåˆ—è¡¨çš„äº‹ä»¶å§”æ‰˜
      setupCommentDelegation();

        const workId = getWorkIdFromUrl();
        loadWorkContentById(workId);


        initDarkMode();

      // ğŸš¨ VVVV ä¿®å¤æ¨¡å¼åˆ‡æ¢é‡å¤ç»‘å®š VVVV

Â  Â  Â  Â  // ä»…åœ¨ DOM åŠ è½½æ—¶ç»‘å®šä¸€æ¬¡æ¨¡å¼åˆ‡æ¢å’Œå¯¼èˆªæµ®çª—å¼€å…³çš„äº‹ä»¶ç›‘å¬å™¨
Â  Â  Â  Â  const scrollBtnGroup = document.getElementById('scroll-mode-btn');
Â  Â  Â  Â  const pageBtnGroup = document.getElementById('page-mode-btn');
Â  Â  Â  Â  const navToggleBtnGroup = document.getElementById('nav-toggle-btn');

Â  Â  Â  Â  scrollBtnGroup.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  currentMode = 'scroll';
Â  Â  Â  Â  Â  Â  renderCurrentMode();
Â  Â  Â  Â  Â  Â  // å…³é—­å¯¼èˆªæµ®çª—
Â  Â  Â  Â  Â  Â  const navPopup = document.getElementById('nav-grid-popup');
Â  Â  Â  Â  Â  Â  if (navPopup) navPopup.classList.remove('show');
Â  Â  Â  Â  });

Â  Â  Â  Â  pageBtnGroup.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  currentMode = 'page';
Â  Â  Â  Â  Â  Â  renderCurrentMode();
Â  Â  Â  Â  Â  Â  const navPopup = document.getElementById('nav-grid-popup');
Â  Â  Â  Â  Â  Â  if (navPopup) navPopup.classList.remove('show');
Â  Â  Â  Â  });

Â  Â  Â  Â  navToggleBtnGroup.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  const navPopup = document.getElementById('nav-grid-popup');
Â  Â  Â  Â  Â  Â  if (navPopup) {
Â  Â  Â  Â  Â  Â  Â  Â  navPopup.classList.toggle('show');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

                              console.log(sidebarToggleBtn);  

      sidebarToggleBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isMobile = window.matchMedia("(max-width: 1050px)").matches;

    if (isMobile) {
        const isShown = sidebar.classList.toggle('show');
        sidebarToggleIcon.textContent = isShown ? 'â®Ÿ' : 'â®'; // å·¦å³ç®­å¤´
        sidebarToggleBtn.setAttribute('aria-expanded', isShown ? 'true' : 'false');
        sidebarToggleBtn.setAttribute('title', isShown ? 'æ”¶èµ·ä¾§è¾¹æ ' : 'å±•å¼€ä¾§è¾¹æ ');
    } else {
        const isCollapsed = sidebar.classList.toggle('collapsed');
        sidebarToggleIcon.textContent = isCollapsed ? 'â®' : 'â®Ÿ';
        sidebarToggleBtn.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        sidebarToggleBtn.setAttribute('title', isCollapsed ? 'å±•å¼€ä¾§è¾¹æ ' : 'æ”¶èµ·ä¾§è¾¹æ ');
    }
});

function getCommentsCountForPage(pageIndex) {
  const pageObj = activePages[pageIndex];
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = pageObj.segmentedHtml || '';
  const pageSentenceIds = Array.from(tempDiv.querySelectorAll('[data-sentence-id]')).map(el => el.getAttribute('data-sentence-id'));
  const commentsForPage = allComments.filter(c => pageSentenceIds.includes(c.sentenceId));
  
  console.log(`ğŸ§© Page ${pageIndex + 1} çš„å¥å­IDs:`, pageSentenceIds);
  console.log(`ğŸ§© Page ${pageIndex + 1} åŒ¹é…çš„è¯„è®ºæ•°:`, commentsForPage.length);
  
  return commentsForPage.length;
}



      const container = document.getElementById('book-content');
console.log(container);

      
Â  Â  }); // ç»“æŸ DOMContentLoaded ç›‘å¬å™¨


// æ³¨æ„ï¼šåŸæœ‰çš„ navToggleBtnGroup.addEventListener('click', ...) å·²ç»æœ‰äº† e.stopPropagation()
// è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œå®ƒå¯ä»¥é˜²æ­¢ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè¯¥å…¨å±€ç›‘å¬å™¨ç«‹å³å°†æµ®çª—å…³é—­ã€‚
    </script>