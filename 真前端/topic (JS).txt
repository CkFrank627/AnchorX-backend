<script>
document.addEventListener('DOMContentLoaded', () => {
    // -------------------------------------------------------------------
    // --- é…ç½®éƒ¨åˆ† ---
    // -------------------------------------------------------------------
    // **æ³¨æ„ï¼šåœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œè¯·ç¡®ä¿æ­¤ API_BASE_URL æ˜¯æ‚¨çš„æœåŠ¡å™¨åœ°å€**
    const API_BASE_URL = 'https://api.anchorx.ca/api/topics'; 
    const REPLIES_PER_PAGE = 20; 

    // è·å– URL ä¸­çš„ä¸»é¢˜ ID
    const urlParams = new URLSearchParams(window.location.search);
    const topicId = urlParams.get('id');

    // æ£€æŸ¥ä¸»é¢˜ ID
    if (!topicId) {
        document.getElementById('topicContent').innerHTML = '<h2>é”™è¯¯ï¼šç¼ºå°‘ä¸»é¢˜IDå‚æ•°ã€‚</h2>';
        return;
    }

    let replyCurrentPage = 1;
    let replyTotalPages = 1;
    let isLiked = false; 

    // -------------------------------------------------------------------
    // --- DOM & Quill åˆå§‹åŒ– ---
    // -------------------------------------------------------------------

    // åˆå§‹åŒ– Quill 
    const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'], 
        ['blockquote', { 'list': 'ordered' }, { 'list': 'bullet' }],
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
        [{ 'color': [] }, { 'background': [] }],
        ['link', 'image', 'clean'] // ã€é‡è¦ã€‘Quill å·¥å…·æ æ–°å¢ 'image'
    ];
// åˆå§‹åŒ– Quill 
    // ... (çœç•¥å·¥å…·æ é…ç½®)
    const replyQuill = new Quill('#replyEditor', {
        theme: 'snow',
        placeholder: 'è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„å›å¤...',
        modules: {
            toolbar: toolbarOptions,
            // ã€é‡è¦ã€‘æ–°å¢å›¾ç‰‡ç¼©æ”¾æ¨¡å—
            imageResize: {
                modules: [ 'Resize', 'DisplaySize', 'Toolbar' ]
            },
            // ã€é‡è¦ã€‘è‡ªå®šä¹‰å›¾ç‰‡å¤„ç†å¥æŸ„
            toolbar: {
                container: toolbarOptions,
                handlers: {
                    'image': imageHandler // ç»‘å®šè‡ªå®šä¹‰å‡½æ•°
                }
            }
        }
    });

    const submitReplyBtn = document.getElementById('submitReplyBtn');
    const replyStatusMessage = document.getElementById('replyStatusMessage');
    const likeButton = document.getElementById('likeButton'); 
    const replyToIdInput = document.getElementById('replyToId'); // æ¥¼ä¸­æ¥¼ ID å­˜å‚¨
    const replyingToMessage = document.getElementById('replyingToMessage'); // æ¥¼ä¸­æ¥¼æç¤ºä¿¡æ¯


    // å¯ç”¨/ç¦ç”¨å›å¤æŒ‰é’® (ç®€å•çš„å†…å®¹æ ¡éªŒ)
    replyQuill.on('text-change', () => {
        const text = replyQuill.getText().trim();
        submitReplyBtn.disabled = text.length === 0 || text.length > 5000; 
    });
    
    // -------------------------------------------------------------------
    // --- å›¾ç‰‡ä¸Šä¼ ç›¸å…³å‡½æ•°ï¼ˆé—®é¢˜ 4 ä¿®æ­£ï¼‰ ---
    // -------------------------------------------------------------------
    
    /**
     * ã€æ ¸å¿ƒä¸Šä¼ å‡½æ•°ã€‘
     * æ¥æ”¶æ–‡ä»¶ï¼Œå‹ç¼©åå‘é€åˆ°åç«¯ API
     * @param {File} file - åŸå§‹å›¾ç‰‡æ–‡ä»¶
     * @returns {Promise<string>} - è¿”å›åç«¯å­˜å‚¨çš„å›¾ç‰‡ URL
     */
    async function uploadImageFile(file) {
        // å®šä¹‰å‹ç¼©é€‰é¡¹
        const options = {
            maxSizeMB: 0.5, // æœ€å¤§æ–‡ä»¶å¤§å°ï¼Œå•ä½MBã€‚
            maxWidthOrHeight: 1920, // å…è®¸çš„æœ€å¤§å®½åº¦æˆ–é«˜åº¦
            useWebWorker: true // ä½¿ç”¨ Web Worker
        };

        const token = getAuthToken();
        if (!token) {
             throw new Error("ç”¨æˆ·æœªç™»å½•");
        }
        
        // è°ƒç”¨å‹ç¼©å‡½æ•° (éœ€è¦å¼•å…¥ browser-image-compression åº“)
        const compressedFile = await imageCompression(file, options);
        console.log('åŸå§‹æ–‡ä»¶å¤§å°:', (file.size / 1024).toFixed(2), 'KB');
        console.log('å‹ç¼©åæ–‡ä»¶å¤§å°:', (compressedFile.size / 1024).toFixed(2), 'KB');
        
        // ä½¿ç”¨ FormData æ¥åŒ…è£…å‹ç¼©åçš„æ–‡ä»¶
        const formData = new FormData();
        // ä½¿ç”¨åŸå§‹æ–‡ä»¶åï¼Œä»¥ä¾¿åç«¯å¯ä»¥è·å–æ­£ç¡®çš„æ–‡ä»¶æ‰©å±•å
        formData.append('image', compressedFile, file.name); 

        // å‘é€åˆ°åç«¯ä¸Šä¼ æ¥å£
        const res = await fetch(`${API_BASE_URL}/upload`, { // å‡è®¾æ‚¨çš„ä¸Šä¼ æ¥å£æ˜¯ /api/topics/upload
            method: 'POST',
            headers: {
                // ä¸Šä¼  FormData æ—¶ï¼Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½® 'Content-Type'ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è®¾ç½®
                'Authorization': `Bearer ${token}` 
            },
            body: formData
        });

        if (!res.ok) {
            const errorResult = await res.json();
            throw new Error(errorResult.message || 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
        }

        const result = await res.json();
        
        // ã€æ³¨æ„ã€‘è¿™é‡Œå‡è®¾åç«¯è¿”å›çš„ JSON ä¸­åŒ…å«ä¸€ä¸ªåä¸º imageUrl çš„å­—æ®µ
        if (!result.imageUrl) {
            throw new Error('åç«¯æœªè¿”å›å›¾ç‰‡ URL');
        }
        return result.imageUrl; 
    }


    /**
     * ã€Quill å›¾ç‰‡å·¥å…·æ å¤„ç†å¥æŸ„ã€‘
     * æ‹¦æˆª Quill çš„å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
     */
    function imageHandler() {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
            if (input.files && input.files.length > 0) {
                const file = input.files[0];
                const range = replyQuill.getSelection(true);
                
                // 1. åœ¨ç¼–è¾‘å™¨ä¸­æ’å…¥å ä½æ–‡æœ¬
                const placeholderText = " [å›¾ç‰‡ä¸Šä¼ ä¸­...] ";
                replyQuill.insertText(range.index, placeholderText, { 'color': '#999' });
                replyQuill.setSelection(range.index + placeholderText.length, 0, Quill.sources.SILENT);
                replyQuill.focus();
                
                // å­˜å‚¨å ä½æ–‡æœ¬çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ï¼Œä»¥ä¾¿åç»­åˆ é™¤
                const startIndex = range.index;
                const length = placeholderText.length;


                try {
                    // 2. è°ƒç”¨æ ¸å¿ƒä¸Šä¼ å‡½æ•°
                    const imageUrl = await uploadImageFile(file);
                    
                    // 3. ç§»é™¤å ä½æ–‡æœ¬ï¼Œæ’å…¥å›¾ç‰‡
                    replyQuill.deleteText(startIndex, length, Quill.sources.USER);
                    replyQuill.insertEmbed(startIndex, 'image', imageUrl, Quill.sources.USER);
                    replyQuill.setSelection(startIndex + 1, 0, Quill.sources.SILENT);

                } catch (error) {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                    // 4. ä¸Šä¼ å¤±è´¥ï¼Œç§»é™¤å ä½æ–‡æœ¬å¹¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    replyQuill.deleteText(startIndex, length, Quill.sources.USER);
                    replyStatusMessage.textContent = `å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯'}`; 
                    setTimeout(() => { replyStatusMessage.textContent = ''; }, 4000);
                }
            }
        };
    }

  
    // -------------------------------------------------------------------
    // --- è¾…åŠ©å‡½æ•° ---
    // -------------------------------------------------------------------
    
    function formatDate(dateString) {
        if (!dateString) return 'æœªçŸ¥æ—¥æœŸ';
        try {
            return new Date(dateString).toLocaleDateString('zh-CN', { 
                year: 'numeric', month: '2-digit', day: '2-digit', 
                hour: '2-digit', minute: '2-digit' 
            });
        } catch (e) {
            return 'æ—¥æœŸé”™è¯¯';
        }
    }

    function getAuthToken() {
        // **æ­£ç¡®å®ç°ï¼š**
        const token = localStorage.getItem('token');
        return token;
    }

    // ---------- è¾…åŠ©ï¼šç¡®ä¿ replyLoadingMessage å­˜åœ¨å¹¶è¿”å›å®ƒ ----------
    function ensureReplyLoadingMessage(message = 'æ­£åœ¨åŠ è½½å›å¤...') {
        let loading = document.getElementById('replyLoadingMessage');
        const list = document.getElementById('replyList');
        if (!list) return null; 
        if (!loading) {
            loading = document.createElement('p');
            loading.id = 'replyLoadingMessage';
            loading.style.textAlign = 'center';
            loading.style.color = '#999';
            loading.style.padding = '20px 0';
            list.appendChild(loading);
        }
        loading.textContent = message;
        return loading;
    }

    // ---------- è¾…åŠ©ï¼šç®€å•è½¬ä¹‰ï¼ˆç”¨äºç”¨æˆ·åç­‰æ’å…¥ innerHTML çš„åœºæ™¯ï¼‰ ----------
    function escapeHtml(unsafe) {
        return String(unsafe || '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }


    // -------------------------------------------------------------------
    // --- æ¸²æŸ“å‡½æ•° ---
    // -------------------------------------------------------------------

    // ... renderTopicDetail (ä¿æŒä¸å˜) ...
    function renderTopicDetail(topic, _isLiked) {
        document.getElementById('topicTitle').textContent = topic.title;
        document.getElementById('topicAuthor').textContent = `ä½œè€…: ${topic.author ? escapeHtml(topic.author.username) : 'åŒ¿å'}`;
        document.getElementById('topicCreatedAt').textContent = formatDate(topic.createdAt);
        document.getElementById('topicViews').textContent = topic.viewsCount || 0;
        document.getElementById('topicRepliesCount').textContent = topic.repliesCount || 0;
        document.getElementById('replyCountHeader').textContent = topic.repliesCount || 0;

        const topicSectionEl = document.getElementById('topicSection');
        if (topic.section && topic.section.name) {
            topicSectionEl.textContent = topic.section.name;
            topicSectionEl.style.display = 'inline-block';
        } else {
            topicSectionEl.style.display = 'none'; 
        }

        const likeCountEl = document.getElementById('likeCount');
        likeCountEl.textContent = topic.likesCount || 0;
        isLiked = _isLiked; 

        if (isLiked) {
            likeButton.classList.add('liked');
            likeButton.innerHTML = `ğŸ§¡ <span>${likeCountEl.textContent}</span>`;
        } else {
            likeButton.classList.remove('liked');
            likeButton.innerHTML = `â¤ï¸ <span>${likeCountEl.textContent}</span>`;
        }
        likeButton.disabled = false; 

        const contentContainer = document.getElementById('topicContent');
        if (topic.content) {
            contentContainer.innerHTML = topic.content;
        } else {
            contentContainer.innerHTML = '<p>ä¸»é¢˜å†…å®¹ä¸ºç©ºã€‚</p>';
        }
    }


    /**
     * æ¸²æŸ“å›å¤åˆ—è¡¨ (é—®é¢˜ 1 æ¥¼ä¸­æ¥¼å®ç°)
     * ã€æ³¨æ„ã€‘ï¼šæ­¤å¤„ä»…å®ç°æ‰å¹³åŒ–æ¸²æŸ“ï¼Œæ¥¼ä¸­æ¥¼çš„åµŒå¥—é€»è¾‘éœ€è¦åç«¯æ•°æ®ç»“æ„æ”¯æŒã€‚
     * * @param {Array<Object>} replies - å›å¤åˆ—è¡¨ã€‚
     */
    function renderReplies(replies) {
        const list = document.getElementById('replyList');
        if (!list) return;

        const loadingMsg = ensureReplyLoadingMessage();
        if (loadingMsg) loadingMsg.style.display = 'none';

        list.innerHTML = '';
        if (loadingMsg) list.appendChild(loadingMsg);

        if (!replies || replies.length === 0) {
            if (loadingMsg) {
                loadingMsg.style.display = 'block';
                loadingMsg.textContent = 'æš‚æ— å›å¤ã€‚';
            } else {
                list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">æš‚æ— å›å¤ã€‚</p>';
            }
            return;
        }

        // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºå•ä¸ªå›å¤çš„ DOM ç»“æ„
        const createReplyItem = (reply, index, isNested = false) => {
            const authorName = reply.author ? reply.author.username : 'åŒ¿åç”¨æˆ·';
            const initial = authorName ? escapeHtml(authorName[0]).toUpperCase() : 'U';
            const replyId = reply._id || '';

            const item = document.createElement('div');
            item.className = isNested ? 'nested-reply-item' : 'reply-item';
            item.dataset.replyId = replyId;

            let replyIndexHtml = '';
            if (!isNested) {
                // ä¸»å›å¤æ‰æ˜¾ç¤ºæ¥¼å±‚å·
                replyIndexHtml = `<span>#${(replyCurrentPage - 1) * REPLIES_PER_PAGE + index + 1} | ${formatDate(reply.createdAt)}</span>`;
            } else {
                // æ¥¼ä¸­æ¥¼åªæ˜¾ç¤ºæ—¶é—´
                replyIndexHtml = `<span>${formatDate(reply.createdAt)}</span>`;
            }

            item.innerHTML = `
                <div class="${isNested ? 'reply-avatar' : 'reply-avatar'}" style="${isNested ? 'width: 30px; height: 30px; font-size: 0.9rem;' : ''}">${initial}</div>
                <div class="reply-body">
                    <div class="reply-user-meta">
                        ${escapeHtml(authorName)} ${replyIndexHtml}
                    </div>
                    <div class="reply-content">${reply.content || ''}</div>
                    <div class="reply-actions" data-reply-id="${replyId}" data-username="${escapeHtml(authorName)}">å›å¤TA</div>
                </div>
            `;
            
            // ã€æ¥¼ä¸­æ¥¼æ¸²æŸ“é€»è¾‘ã€‘å‡è®¾å›å¤æ•°æ®ç»“æ„ä¸­æœ‰ nestedReplies æ•°ç»„
            if (reply.nestedReplies && reply.nestedReplies.length > 0) {
                const nestedList = document.createElement('div');
                nestedList.className = 'nested-reply-list';
                reply.nestedReplies.forEach((nestedReply, nestedIndex) => {
                    nestedList.appendChild(createReplyItem(nestedReply, nestedIndex, true)); // é€’å½’è°ƒç”¨ï¼Œæ ‡è®°ä¸ºåµŒå¥—
                });
                item.querySelector('.reply-body').appendChild(nestedList);
            }

            return item;
        };

        replies.forEach((reply, index) => {
            list.appendChild(createReplyItem(reply, index, false));
        });

        // ã€é—®é¢˜ 1 ä¿®æ­£ã€‘ç»‘å®šæ¥¼ä¸­æ¥¼å›å¤äº‹ä»¶
        list.querySelectorAll('.reply-actions').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const username = e.currentTarget.dataset.username || '';
                const replyId = e.currentTarget.dataset.replyId || '';
                
                // 1. è®¾ç½®å›å¤ç›®æ ‡ ID å’Œç”¨æˆ·å
                replyToIdInput.value = replyId;
                document.getElementById('replyToUsername').value = username;
                replyingToMessage.textContent = ` (æ­£åœ¨å›å¤ï¼š${username})`;

                // 2. æ¸…ç©ºç¼–è¾‘å™¨å¹¶æ’å…¥ @ æåŠ (ä¿ç•™ @ é€»è¾‘ï¼Œä½†ç°åœ¨æ˜¯æ¥¼ä¸­æ¥¼çš„ä¸€éƒ¨åˆ†)
                replyQuill.setContents([{ insert: '\n' }]); // æ¸…ç©ºç¼–è¾‘å™¨
                const mention = `@${username} `;
                replyQuill.insertText(0, mention, Quill.sources.USER);
                replyQuill.setSelection(mention.length, 0, Quill.sources.SILENT);
                replyQuill.focus();

                // 3. æ»šåŠ¨åˆ°ç¼–è¾‘å™¨ä½ç½®
                document.querySelector('.reply-editor-container').scrollIntoView({ behavior: 'smooth' });
            });
        });
    }

    // ... renderReplyPagination (ä¿æŒä¸å˜) ...
    function renderReplyPagination() {
        const container = document.getElementById('replyPaginationContainer');
        container.innerHTML = '';
        if (replyTotalPages <= 1) return;

        const prevBtn = `<button id="prevReplyBtn" class="pagination-btn" style="padding:8px; border:1px solid #ccc; margin-right: 10px;" ${replyCurrentPage === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>`;
        const info = `<span>ç¬¬ ${replyCurrentPage} / ${replyTotalPages} é¡µ</span>`;
        const nextBtn = `<button id="nextReplyBtn" class="pagination-btn" style="padding:8px; border:1px solid #ccc; margin-left: 10px;" ${replyCurrentPage === replyTotalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>`;

        container.innerHTML = prevBtn + info + nextBtn;
        
        // ç»‘å®šåˆ†é¡µäº‹ä»¶
        document.getElementById('prevReplyBtn').addEventListener('click', () => {
            if (replyCurrentPage > 1) {
                fetchReplies(replyCurrentPage - 1);
            }
        });
        document.getElementById('nextReplyBtn').addEventListener('click', () => {
            if (replyCurrentPage < replyTotalPages) {
                fetchReplies(replyCurrentPage + 1);
            }
        });
    }

    // -------------------------------------------------------------------
    // --- API äº¤äº’å‡½æ•° ---
    // -------------------------------------------------------------------
    
    // ... submitLike (ä¿æŒä¸å˜) ...
    async function submitLike() {
        const token = getAuthToken();
        if (!token) {
            alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµï¼');
            return;
        }

        likeButton.disabled = true; 
        
        try {
            const response = await fetch(`${API_BASE_URL}/${topicId}/like`, {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify({}) 
            });

            const result = await response.json();

            if (response.ok) {
                const newLikesCount = result.likesCount || 0;
                const newIsLiked = result.isLiked; 

                renderTopicDetail({
                    ...data.topic, 
                    likesCount: newLikesCount
                }, newIsLiked);

            } else {
                alert(`æ“ä½œå¤±è´¥: ${result.message || 'æœåŠ¡å™¨é”™è¯¯'}`);
            }

        } catch (error) {
            console.error('æäº¤ç‚¹èµæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
            alert('æäº¤å¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯ã€‚');
        } finally {
            likeButton.disabled = false;
        }
    }

async function fetchTopicAndReplies() {
    const progressContainer = document.getElementById('topic-load-progress-container');
    const progressText = document.getElementById('topic-load-progress-text');
    const progressBar = document.getElementById('topic-load-progress-bar');

    // å¯åŠ¨åŠ è½½æ¡
    progressContainer.style.display = 'block';
    progressText.textContent = 'æ­£åœ¨è¯·æ±‚ä¸»é¢˜æ•°æ®...';
    progressBar.style.width = '10%';

    try {
        const token = getAuthToken();
        const topicUrl = `${API_BASE_URL}/${topicId}?page=1&limit=${REPLIES_PER_PAGE}`;
        
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const response = await fetch(topicUrl, { headers });

        if (!response.ok) throw new Error(`æ‚¨çš„æµè§ˆå™¨ä¼¼ä¹æƒ³å’Œæˆ‘ä»¬å¯¹ç€å¹²ï¼è¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ (${response.status})`);
        progressText.textContent = 'æ­£åœ¨è§£ææ•°æ®...';
        progressBar.style.width = '40%';

        const data = await response.json();

        // æ¸²æŸ“ä¸»é¢˜éƒ¨åˆ†
        renderTopicDetail(data.topic, !!data.isLiked);
        progressText.textContent = 'æ­£åœ¨æ¸²æŸ“ä¸»é¢˜å†…å®¹...';
        progressBar.style.width = '60%';

        // æ¸²æŸ“å›å¤éƒ¨åˆ†
        if (Array.isArray(data.replies)) {
            renderReplies(data.replies);
            renderReplyPagination();
        }
        progressText.textContent = 'æ­£åœ¨åŠ è½½å›å¤...';
        progressBar.style.width = '80%';

        // å›å¤é¡µæ•°ä¿¡æ¯
        replyCurrentPage = data.replyPage || 1;
        replyTotalPages = data.replyTotalPages || 1;

        // å®ŒæˆçŠ¶æ€
        progressText.textContent = 'åŠ è½½å®Œæˆï¼';
        progressBar.style.width = '100%';
        progressBar.style.background = '#4caf50';
        setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.background = '#0077cc';
        }, 1000);

    } catch (error) {
        console.error('åŠ è½½ä¸»é¢˜æˆ–å›å¤å¤±è´¥:', error);
        const headerEl = document.querySelector('.topic-header');
        if (headerEl) headerEl.style.display = 'none';

        const contentContainer = document.getElementById('topicContent');
        if (contentContainer) {
            contentContainer.innerHTML = `<p style="color:red; text-align:center;">è¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ï¼ˆä½ çš„æµè§ˆå™¨æ¯”è¾ƒæ¾å¼›ï¼‰ï¼š${escapeHtml(error.message)}</p>`;
        }

        const loadingMsg = ensureReplyLoadingMessage('ä¸»é¢˜åŠ è½½å¤±è´¥ï¼Œå›å¤æ— æ³•æ˜¾ç¤ºã€‚');
        if (loadingMsg) loadingMsg.style.display = 'block';

        const pagination = document.getElementById('replyPaginationContainer');
        if (pagination) pagination.style.display = 'none';

        progressText.textContent = 'åŠ è½½å¤±è´¥';
        progressBar.style.background = '#e53935';
        setTimeout(() => (progressContainer.style.display = 'none'), 1200);
    }
}

    
    // ... fetchReplies (ä¿æŒä¸å˜) ...
    async function fetchReplies(page) {
        const loadingMsg = ensureReplyLoadingMessage('æ­£åœ¨åŠ è½½å›å¤...');
        if (loadingMsg) loadingMsg.style.display = 'block';

        const list = document.getElementById('replyList');
        if (list) {
            list.innerHTML = '';
            if (loadingMsg) list.appendChild(loadingMsg);
        }

        window.scrollTo(0, 0); 

        try {
            const topicUrl = `${API_BASE_URL}/${topicId}?page=${page}&limit=${REPLIES_PER_PAGE}`;
            const response = await fetch(topicUrl);
            if (!response.ok) throw new Error(`åŠ è½½å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
            const data = await response.json();

            replyCurrentPage = data.replyPage || 1;
            replyTotalPages = data.replyTotalPages || 1;

            renderReplies(data.replies);
            renderReplyPagination();
        } catch (error) {
            console.error('åŠ è½½å›å¤é¡µå¤±è´¥:', error);
            const loadingMsg = ensureReplyLoadingMessage('å›å¤é¡µåŠ è½½å¤±è´¥ã€‚');
            if (loadingMsg) loadingMsg.style.display = 'block';
        }
    }

    /**
     * æäº¤æ–°å›å¤ (é—®é¢˜ 1 æ¥¼ä¸­æ¥¼ä¿®æ­£)
     */
    async function submitReply() {
        const contentHTML = replyQuill.root.innerHTML; 
        const replyToId = replyToIdInput.value; // è·å–å›å¤ç›®æ ‡çš„ ID

        if (replyQuill.getText().trim().length === 0) {
            replyStatusMessage.textContent = 'å›å¤å†…å®¹ä¸èƒ½ä¸ºç©ºï¼';
            return;
        }

        const token = getAuthToken();
        if (!token) {
            replyStatusMessage.textContent = 'è¯·å…ˆç™»å½•æ‰èƒ½å›å¤ï¼';
            return;
        }

        submitReplyBtn.disabled = true;
        replyStatusMessage.textContent = 'æ­£åœ¨æäº¤å›å¤...';
        
        try {
            const payload = {
                content: contentHTML,
            };
            
            // ã€ä¿®æ­£ç‚¹ã€‘å¦‚æœæœ‰ replyToIdï¼Œåˆ™å°†å…¶æ·»åŠ åˆ° payload ä¸­ï¼Œä½œä¸ºæ¥¼ä¸­æ¥¼çš„ä¾æ®
            if (replyToId) {
                payload.parentId = replyToId; // å‡è®¾æ‚¨çš„åç«¯ä½¿ç”¨ parentId æ¥æ ‡è¯†æ¥¼ä¸­æ¥¼
            }

            const response = await fetch(`${API_BASE_URL}/${topicId}/replies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify(payload) // åŒ…å« parentId
            });

            const result = await response.json();

            if (response.ok) {
                replyStatusMessage.textContent = 'å›å¤æˆåŠŸï¼æ­£åœ¨åˆ·æ–°...';
                
                // æˆåŠŸåæ¸…é™¤æ¥¼ä¸­æ¥¼çŠ¶æ€
                replyToIdInput.value = '';
                document.getElementById('replyToUsername').value = '';
                replyingToMessage.textContent = '';

                replyQuill.setContents([{ insert: '\n' }]); 
                setTimeout(() => {
                    replyStatusMessage.textContent = '';
                    submitReplyBtn.disabled = false;
                    // é‡æ–°åŠ è½½ä¸»é¢˜å’Œå›å¤ï¼Œæœ€å¥½æ˜¯å®šä½åˆ°æ–°å›å¤æ‰€åœ¨é¡µ
                    fetchTopicAndReplies(); 
                }, 1000);

            } else {
                replyStatusMessage.textContent = `å›å¤å¤±è´¥: ${result.message || 'æœåŠ¡å™¨é”™è¯¯'}`;
                submitReplyBtn.disabled = false;
            }

        } catch (error) {
            console.error('æäº¤å›å¤æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
            replyStatusMessage.textContent = 'æäº¤å¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯ã€‚';
            submitReplyBtn.disabled = false;
        }
    }
    
    // -------------------------------------------------------------------
    // --- äº‹ä»¶ç»‘å®šåŠåˆå§‹æ‰§è¡Œ ---
    // -------------------------------------------------------------------
    
    // ç»‘å®šæäº¤å›å¤æŒ‰é’®
    submitReplyBtn.addEventListener('click', submitReply);
    
    // ç»‘å®šç‚¹èµæŒ‰é’®
    likeButton.addEventListener('click', submitLike);

    // ã€ç§»é™¤ã€‘åŸå›¾ç‰‡ä¸Šä¼ æŒ‰é’®çš„å ä½ä»£ç ï¼Œå› ä¸ºæˆ‘ä»¬å·²å°†é€»è¾‘é›†æˆåˆ° Quill çš„ imageHandler ä¸­
    
    // åˆå§‹åŠ è½½æ•°æ®
    fetchTopicAndReplies();
});
</script>