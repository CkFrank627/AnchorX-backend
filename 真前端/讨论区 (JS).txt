<script>
document.addEventListener('DOMContentLoaded', () => {
    // -------------------------------------------------------------------
    // --- é…ç½®éƒ¨åˆ† (è¯·æ ¹æ®ä½ çš„å®é™…éƒ¨ç½²æƒ…å†µä¿®æ”¹) ---
    // -------------------------------------------------------------------
    const API_BASE_URL = 'https://api.anchorx.ca/api/topics'; // TODO: æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨åŸŸå
    const TOPIC_DETAIL_PAGE_BASE_URL = '/topic/'; // TODO: æ›¿æ¢ä¸ºä½ å®é™…çš„ä¸»é¢˜è¯¦æƒ…é¡µURLå‰ç¼€
    const POSTS_PER_PAGE = 10; // æ¯é¡µæ˜¾ç¤ºçš„ä¸»é¢˜æ•°é‡

  // æ–°å¢ï¼šåˆ†åŒºç­›é€‰ DOM
    const sectionFilterSelect = document.getElementById('sectionFilter');
    
    // å¼¹çª—ç›¸å…³ DOM (æ–°å¢åˆ†åŒºé€‰æ‹©æ¡†)
    // const modalOverlay = document.getElementById('newTopicModalOverlay'); // ä¿æŒåŸæ ·
    // ... å…¶ä»– modal DOM
    const topicSectionSelect = document.getElementById('topicSectionSelect'); // <-- æ–°å¢
    
    /**
     * TODO: è·å–ç”¨æˆ·ç™»å½• Token çš„å‡½æ•°
     * åœ¨ä½ çš„å®é™…åº”ç”¨ä¸­ï¼Œä½ éœ€è¦ä» LocalStorage æˆ– Cookie ä¸­è·å– JWTã€‚
     */
/**
 * âœ… ä¿®æ­£åçš„ Token è·å–å‡½æ•°
 */
function getAuthToken() {
    // å‡è®¾ token å­˜å‚¨åœ¨ localStorage ä¸­ï¼Œä¸”é”®åæ˜¯ 'token'
    const token = localStorage.getItem('token'); 
    
    if (!token) {
        console.warn('è­¦å‘Šï¼šæ— æ³•è·å–åˆ°æœ¬åœ°å­˜å‚¨ä¸­çš„ç”¨æˆ· Tokenã€‚');
    }
    
    // è¿”å›çœŸå®çš„ Token å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯æ¼”ç¤ºå ä½ç¬¦
    return token; 
}

    // -------------------------------------------------------------------
    // --- DOM å…ƒç´ è·å– ---
    // -------------------------------------------------------------------
    const discussionList = document.getElementById('discussionList');
    const loadingMessage = document.getElementById('loadingMessage');
    const paginationContainer = document.getElementById('paginationContainer');
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const pageInfoSpan = document.getElementById('pageInfo');
    const newPostBtn = document.getElementById('newPostBtn'); // å‘å¸ƒæ–°ä¸»é¢˜æŒ‰é’®

    // å¼¹çª—ç›¸å…³ DOM
    const modalOverlay = document.getElementById('newTopicModalOverlay');
    const closeModalIcon = document.getElementById('closeModalIcon');
    const topicTitleInput = document.getElementById('topicTitleInput');
    const topicContentTextarea = document.getElementById('topicContentTextarea');
    const titleCharCountSpan = document.getElementById('titleCharCount');
    const publishTopicBtn = document.getElementById('publishTopicBtn');
    const topicStatusMessage = document.getElementById('topicStatusMessage');
    
    let currentPage = 1;
    let totalPages = 1;

    // -------------------------------------------------------------------
    // --- æ¨¡æ€å¼¹çª—æ§åˆ¶å‡½æ•° ---
    // -------------------------------------------------------------------

    function openModal() {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        if (!getAuthToken()) {
            alert('è¯·å…ˆç™»å½•æ‰èƒ½å‘å¸ƒæ–°ä¸»é¢˜ï¼');
            // TODO: åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è·³è½¬åˆ°ç™»å½•é¡µé¢
            return;
        }

        // é‡ç½®è¡¨å•
        topicTitleInput.value = '';
        topicContentTextarea.value = '';
        topicStatusMessage.textContent = '';
        titleCharCountSpan.textContent = '0';
        publishTopicBtn.disabled = false;

      // æ–°å¢ï¼šé‡ç½®åˆ†åŒºé€‰æ‹©
        topicSectionSelect.value = ''; 
        
        modalOverlay.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
    }

    function closeModal() {
        modalOverlay.style.display = 'none';
        document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
    }

    // -------------------------------------------------------------------
    // --- å‘å¸ƒä¸»é¢˜é€»è¾‘ ---
    // -------------------------------------------------------------------
    
async function publishTopic() {
        const title = topicTitleInput.value.trim();
        const content = topicContentTextarea.value.trim();
        const section = topicSectionSelect.value; // <-- æ–°å¢ï¼šè·å–é€‰ä¸­çš„åˆ†åŒº
        const token = getAuthToken();

        if (!title || !content) {
            topicStatusMessage.textContent = 'æ ‡é¢˜å’Œå†…å®¹éƒ½æ˜¯å¿…å¡«çš„ï¼';
            return;
        }
        
        if (!section) { // <-- å¿…å¡«æ ¡éªŒ
            topicStatusMessage.textContent = 'è¯·é€‰æ‹©ä¸»é¢˜åˆ†åŒºï¼';
            return;
        }

        if (title.length > 30) {
             topicStatusMessage.textContent = 'æ ‡é¢˜ä¸èƒ½è¶…è¿‡30ä¸ªå­—ç¬¦ï¼';
            return;
        }

        publishTopicBtn.disabled = true;
        topicStatusMessage.textContent = 'æ­£åœ¨å‘å¸ƒ...';

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                // ä¿®æ”¹ï¼šå‘é€ section å­—æ®µ
                body: JSON.stringify({ title, content, section }) 
            });

            const result = await response.json();

            if (response.ok) {
                topicStatusMessage.textContent = 'å‘å¸ƒæˆåŠŸï¼æ­£åœ¨åˆ·æ–°åˆ—è¡¨...';
                
                // æˆåŠŸåå…³é—­å¼¹çª—å¹¶åˆ·æ–°åˆ—è¡¨
                setTimeout(() => {
                    closeModal();
                    fetchAndRenderTopics(1); // åˆ·æ–°åˆ°ç¬¬ä¸€é¡µæŸ¥çœ‹æ–°å¸–å­
                }, 1000);

            } else {
                // åç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯
                topicStatusMessage.textContent = `å‘å¸ƒå¤±è´¥: ${result.message || result.error || 'æœªçŸ¥é”™è¯¯'}`;
                publishTopicBtn.disabled = false;
            }

        } catch (error) {
            console.error('å‘å¸ƒä¸»é¢˜æ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
            topicStatusMessage.textContent = 'å‘å¸ƒå¤±è´¥: ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨é”™è¯¯ã€‚';
            publishTopicBtn.disabled = false;
        }
    }


    // -------------------------------------------------------------------
    // --- åˆ—è¡¨åŠ è½½è¾…åŠ©å‡½æ•° (ä¸ä¹‹å‰ç›¸åŒ) ---
    // -------------------------------------------------------------------

    function formatDate(dateString) {
        if (!dateString) return 'æœªçŸ¥æ—¥æœŸ';
        try {
            return new Date(dateString).toLocaleDateString('zh-CN');
        } catch (e) {
            return 'æ—¥æœŸé”™è¯¯';
        }
    }

function renderTopics(topics) {
    discussionList.innerHTML = ''; 
    loadingMessage.style.display = 'none';

    if (!topics || topics.length === 0) {
        discussionList.innerHTML =
            '<p style="text-align: center; color: #999; padding: 50px;">æš‚æ— è®¨è®ºä¸»é¢˜ã€‚</p>';
        paginationContainer.style.display = 'none';
        return;
    }

    const currentUserId = // TODO: åœ¨è¿™é‡Œè·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ ID
        // ç¡®ä¿ä½ æœ‰ä¸€ä¸ªå‡½æ•°æˆ–æ–¹æ³•èƒ½è·å–å½“å‰ç”¨æˆ·çš„ ID
        // å‡è®¾ä½ çš„ auth token ä¸­åŒ…å«äº† userIdï¼Œæˆ–è€…ä½ å¯ä»¥é€šè¿‡å¦ä¸€ä¸ª API è·å–
        getUserIdFromToken(getAuthToken()) || null; 

    topics.forEach(topic => {
        const authorName = topic.author ? topic.author.username : 'ğŸ‘¤ åŒ¿åç”¨æˆ·';
        const lastReplyUserName = topic.lastRepliedBy ? topic.lastRepliedBy.username : 'æ— ';
        const lastReplyTime = topic.lastReplyAt ? formatDate(topic.lastReplyAt) : 'æ— ';

        // â­ æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿ topic.likedBy å­˜åœ¨ä¸”æ˜¯æ•°ç»„ï¼Œå†è°ƒç”¨ .includes()
        const isLiked = currentUserId && Array.isArray(topic.likedBy) && topic.likedBy.includes(currentUserId);
        const likeClass = isLiked ? 'liked' : '';
        const likeText = isLiked ? 'â¤ï¸' : 'ğŸ¤'; // ä½¿ç”¨å¿ƒå½¢å›¾æ ‡
        
        let summary = 'æš‚æ— æ‘˜è¦å†…å®¹...';
        if (topic.content && typeof topic.content === 'string') {
            summary = topic.content.substring(0, 100) + (topic.content.length > 100 ? '...' : '');
        } 

        const itemHtml = `
            <article class="topic-item" data-topic-id="${topic._id}">
                <div class="topic-main-content">
                    <span style="display: inline-block; margin-right: 10px; padding: 2px 8px; font-size: 0.75rem; color: #0077cc; background: #e6f7ff; border-radius: 3px; font-weight: bold;">
                        [${topic.section || 'æœªåˆ†åŒº'}]
                    </span>
                    
                    <a href="${TOPIC_DETAIL_PAGE_BASE_URL}?id=${topic._id}" class="topic-title-link">
                        <h4 class="topic-title" style="display: inline;">${topic.title}</h4>
                    </a>
                    
                    <p class="topic-meta">
                        <span class="info-author">ğŸ‘¤ ${authorName} å‘å¸ƒ</span>
                        <span class="info-date">ğŸ”„ ${lastReplyTime} æœ€æ–°å›å¤ï¼ˆ${lastReplyUserName}ï¼‰</span>
                        <span class="info-views">ğŸ‘€ ${topic.viewsCount || 0} æµè§ˆ</span>
                        <span class="like-control ${likeClass}" data-id="${topic._id}" data-type="topic">
                            <span class="icon">${likeText}</span>
                            <span class="like-count">${topic.likesCount || 0}</span>
                        </span>
                    </p>
                    <p class="topic-summary">${summary}</p>
                </div>
                <div class="topic-stats">
                    <div class="stats-item stats-replies">${topic.repliesCount || 0}</div>
                    <div class="stats-label">å›å¤</div>
                </div>
            </article>
        `;
        discussionList.insertAdjacentHTML('beforeend', itemHtml);
    });
    
    paginationContainer.style.display = 'flex';
    updatePaginationUI();
}
      
    
    function updatePaginationUI() {
        prevPageBtn.disabled = currentPage === 1;
        nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
        pageInfoSpan.textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
    }

async function fetchAndRenderTopics(page = 1, section = '') {
    const progressContainer = document.getElementById('topic-progress-container');
    const progressText = document.getElementById('topic-progress-text');
    const progressBar = document.getElementById('topic-progress-bar');

    loadingMessage.style.display = 'block';
    discussionList.innerHTML = '';
    paginationContainer.style.display = 'none';

    progressContainer.style.display = 'block';
    progressText.textContent = 'æ­£åœ¨è¯·æ±‚æœåŠ¡å™¨æ•°æ®...';
    progressBar.style.width = '5%';

    let url = `${API_BASE_URL}?page=${page}&limit=${POSTS_PER_PAGE}`;
    if (section) url += `&section=${encodeURIComponent(section)}`;

    try {
        const response = await fetch(url, { method: 'GET' });
        if (!response.ok) throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥ (${response.status})`);
        progressBar.style.width = '20%';
        progressText.textContent = 'è§£ææ•°æ®ä¸­...';

        const data = await response.json();
        currentPage = data.currentPage;
        totalPages = data.totalPages;
        const topics = data.topics || [];

        if (!topics.length) {
            discussionList.innerHTML = '<p style="text-align:center;color:#999;padding:50px;">æš‚æ— è®¨è®ºä¸»é¢˜ã€‚</p>';
            loadingMessage.style.display = 'none';
            progressContainer.style.display = 'none';
            return;
        }

        loadingMessage.style.display = 'none';
        discussionList.innerHTML = '';
        paginationContainer.style.display = 'flex';

        const total = topics.length;
        let count = 0;

        for (const topic of topics) {
            const authorName = topic.author ? topic.author.username : 'ğŸ‘¤ åŒ¿åç”¨æˆ·';
            const lastReplyUserName = topic.lastRepliedBy ? topic.lastRepliedBy.username : 'æ— ';
            const lastReplyTime = topic.lastReplyAt ? formatDate(topic.lastReplyAt) : 'æ— ';
            const summary = topic.content
                ? topic.content.substring(0, 100) + (topic.content.length > 100 ? '...' : '')
                : 'æš‚æ— æ‘˜è¦å†…å®¹...';

            const itemHtml = `
                <article class="topic-item" data-topic-id="${topic._id}">
                    <div class="topic-main-content">
                        <span style="display:inline-block;margin-right:10px;padding:2px 8px;font-size:0.75rem;color:#0077cc;background:#e6f7ff;border-radius:3px;font-weight:bold;">
                            [${topic.section || 'æœªåˆ†åŒº'}]
                        </span>
                        <a href="${TOPIC_DETAIL_PAGE_BASE_URL}?id=${topic._id}" class="topic-title-link">
                            <h4 class="topic-title">${topic.title}</h4>
                        </a>
                        <p class="topic-meta">
                            <span class="info-author">ğŸ‘¤ ${authorName} å‘å¸ƒ</span>
                            <span class="info-date">ğŸ”„ ${lastReplyTime} æœ€æ–°å›å¤ï¼ˆ${lastReplyUserName}ï¼‰</span>
                            <span class="info-views">ğŸ‘€ ${topic.viewsCount || 0} æµè§ˆ</span>
                            <span class="info-replies">ğŸ’¬ ${topic.repliesCount || 0} å›å¤</span>
                        </p>
                        <p class="topic-summary">${summary}</p>
                    </div>
                    <div class="topic-stats">
                        <div class="stats-item stats-replies">${topic.repliesCount || 0}</div>
                        <div class="stats-label">å›å¤</div>
                    </div>
                </article>
            `;

            discussionList.insertAdjacentHTML('beforeend', itemHtml);

            count++;
            const percent = 20 + Math.round((count / total) * 75);
            progressBar.style.width = `${percent}%`;
            progressText.textContent = `åŠ è½½ä¸»é¢˜ï¼š${count} / ${total} (${percent}%)`;

            // å¾®å»¶è¿Ÿé˜²æ­¢å¡é¡¿
            await new Promise(r => setTimeout(r, 5));
        }

        updatePaginationUI();

        progressText.textContent = 'åŠ è½½å®Œæˆï¼';
        progressBar.style.width = '100%';
        progressBar.style.background = '#4caf50';
        setTimeout(() => {
            progressContainer.style.display = 'none';
            progressBar.style.background = '#0077cc';
        }, 800);
    } catch (err) {
        console.error('è·å–ä¸»é¢˜åˆ—è¡¨å¤±è´¥:', err);
        discussionList.innerHTML =
            '<p style="text-align:center;color:red;padding:50px;">åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– APIã€‚</p>';
        progressContainer.style.display = 'none';
    }
}

  /**
     * è¾…åŠ©å‡½æ•°ï¼šå°è¯•ä» JWT Token ä¸­è§£æå‡ºç”¨æˆ· ID
     * è¿™æ˜¯ä¸€ä¸ªç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…åº”ç”¨ä¸­ä½ å¯èƒ½éœ€è¦ä¸€ä¸ªæ›´å¥å£®çš„å®ç°
     */
    function getUserIdFromToken(token) {
        if (!token) return null;
        try {
            // JWT ç»“æ„é€šå¸¸æ˜¯ header.payload.signature
            const payload = token.split('.')[1];
            const decoded = JSON.parse(atob(payload));
            return decoded.userId || null; // å‡è®¾ç”¨æˆ· ID å­˜å‚¨åœ¨ token payload çš„ userId å­—æ®µ
        } catch (e) {
            console.error("æ— æ³•è§£æ token:", e);
            return null;
        }
    }
    
    // -------------------------------------------------------------------
    // --- æ–°å¢ï¼šç‚¹èµ/å–æ¶ˆç‚¹èµ ä¸»é¢˜ æˆ– å›å¤ çš„é€šç”¨é€»è¾‘ ---
    // -------------------------------------------------------------------

    async function toggleLike(id, type) {
        const token = getAuthToken();
        if (!token) {
            alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµï¼');
            // TODO: è·³è½¬åˆ°ç™»å½•é¡µé¢
            return;
        }

        const url = (type === 'topic') 
            ? `${API_BASE_URL}/${id}/like`
            : `${API_BASE_URL}/replies/${id}/like`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}` 
                }
            });

            const result = await response.json();

            if (response.ok) {
                // æ›´æ–° UI
                const likeControl = document.querySelector(`.like-control[data-id="${id}"][data-type="${type}"]`);
                if (likeControl) {
                    const likeCountSpan = likeControl.querySelector('.like-count');
                    const likeIconSpan = likeControl.querySelector('.icon');
                    
                    if (result.isLiked) {
                        likeControl.classList.add('liked');
                        likeIconSpan.textContent = 'â¤ï¸';
                    } else {
                        likeControl.classList.remove('liked');
                        likeIconSpan.textContent = 'ğŸ¤';
                    }
                    likeCountSpan.textContent = result.likesCount;
                }
                
            } else {
                alert(`ç‚¹èµå¤±è´¥: ${result.message || 'æœåŠ¡å™¨é”™è¯¯'}`);
            }

        } catch (error) {
            console.error('ç‚¹èµæ“ä½œå‘ç”Ÿç½‘ç»œé”™è¯¯:', error);
            alert('ç‚¹èµå¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯ã€‚');
        }
    }

  
    // -------------------------------------------------------------------
    // --- äº‹ä»¶ç»‘å®š ---
    // -------------------------------------------------------------------

  
    // 1. åˆ—è¡¨åˆ†é¡µæŒ‰é’® (ä¿®æ”¹ï¼šä¼ é€’å½“å‰é€‰ä¸­çš„ç­›é€‰åˆ†åŒº)
    prevPageBtn.addEventListener('click', () => {
        const currentSection = sectionFilterSelect.value;
        if (currentPage > 1) {
            fetchAndRenderTopics(currentPage - 1, currentSection); // <-- ä¼ é€’ section
            window.scrollTo(0, 0); 
        }
    });

    nextPageBtn.addEventListener('click', () => {
        const currentSection = sectionFilterSelect.value;
        if (currentPage < totalPages) {
            fetchAndRenderTopics(currentPage + 1, currentSection); // <-- ä¼ é€’ section
            window.scrollTo(0, 0); 
        }
    });

     // 2. æ–°å¢ï¼šåˆ†åŒºç­›é€‰å™¨äº‹ä»¶ç›‘å¬
    sectionFilterSelect.addEventListener('change', () => {
        const selectedSection = sectionFilterSelect.value;
        fetchAndRenderTopics(1, selectedSection); // é‡æ–°ä»ç¬¬ä¸€é¡µåŠ è½½
    });
    
    // 3. æ–°å¢ï¼šä¸»é¢˜ç‚¹èµäº‹ä»¶å§”æ‰˜
    discussionList.addEventListener('click', (e) => {
        const likeControl = e.target.closest('.like-control');
        if (likeControl) {
            const id = likeControl.dataset.id;
            const type = likeControl.dataset.type; // topic æˆ– reply
            
            if (id && type === 'topic') {
                toggleLike(id, type);
            }
            // TODO: å¦‚æœä½ å¸Œæœ›åœ¨åˆ—è¡¨é¡µçš„å›å¤ä¸­ä¹Ÿæ”¯æŒç‚¹èµï¼Œéœ€è¦ä¿®æ”¹è¿™é‡Œ
        }
    });

    // 2. â€œå‘å¸ƒæ–°ä¸»é¢˜â€æŒ‰é’® - æ‰“å¼€æ¨¡æ€çª—
    newPostBtn.addEventListener('click', (e) => {
        e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„é“¾æ¥è·³è½¬è¡Œä¸º
        openModal();
    });

    // 3. æ¨¡æ€çª—å…³é—­æŒ‰é’®
    closeModalIcon.addEventListener('click', closeModal);
    modalOverlay.addEventListener('click', (e) => {
        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        if (e.target === modalOverlay) {
            closeModal();
        }
    });
    
    // 4. æ ‡é¢˜å­—æ•°ç»Ÿè®¡
    topicTitleInput.addEventListener('input', () => {
        const count = topicTitleInput.value.length;
        titleCharCountSpan.textContent = count;
        // å¯é€‰ï¼šæ·»åŠ è¶…é™æç¤º
        topicStatusMessage.textContent = count > 30 ? 'æ ‡é¢˜è¶…è¿‡é™åˆ¶ï¼' : '';
    });

    // 5. â€œå‘è¡¨â€æŒ‰é’® - æäº¤ä¸»é¢˜
    publishTopicBtn.addEventListener('click', publishTopic);

   // åˆå§‹åŠ è½½ä¸»é¢˜åˆ—è¡¨
    // åˆå§‹åŠ è½½æ—¶è·å–ç­›é€‰å™¨çš„å€¼
    const initialSection = sectionFilterSelect.value;
    fetchAndRenderTopics(currentPage, initialSection); 
}); // ç»“æŸ DOMContentLoaded ç›‘å¬å™¨
</script>