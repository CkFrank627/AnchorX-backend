 <!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä½œå“é˜…è¯»</title>
    <link href="https://api.anchorx.ca/vendor_assets/quill.snow.css" rel="stylesheet">
  
    <style>
        /* ===================
        Quill é»˜è®¤æ ·å¼è¦†ç›–
        =================== */
        #book-content .ql-editor {
            padding: 0;
            /* æ–°å¢: å¼ºåˆ¶é•¿æ–‡æœ¬æ¢è¡Œ */
            overflow-wrap: break-word;
            word-wrap: break-word;
          /* ã€ä¿®æ”¹ç‚¹ 1ï¼šå¢å¤§è¡Œé—´è·ã€‘ 1.8 å€é€šå¸¸éå¸¸èˆ’é€‚ */
        line-height: 1.8; 
        
        /* ã€ä¿®æ”¹ç‚¹ 2ï¼šè®¾ç½®å­—ä½“æ ·å¼ã€‘ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„è¡¬çº¿/æ— è¡¬çº¿ä¸­æ–‡å­—ä½“ */
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
        
        #book-content .ql-container.ql-snow {
            border: none !important;
        }
        #book-content .ql-toolbar.ql-snow {
            display: none !important;
        }
        /* éšè— Quill é»˜è®¤çš„ç©ºå†…å®¹æç¤º */
        #book-content .ql-editor.ql-blank::before {
            content: none !important;
            display: none !important;
        }

        /* ===================
        é˜…è¯»é¡µæ•´ä½“æ ·å¼
        =================== */
        .book-container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            margin: 20px auto; /* å±…ä¸­ */
        }

        .book-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .book-header h1 {
            font-size: 2.2rem;
            color: #222;
            margin: 0 0 10px;
        }
        .book-header p {
            font-size: 0.9rem;
            color: #888;
            margin: 0;
        }

        .book-content {
            line-height: 1.8;
            font-size: 1.1rem;
            color: #333;
        }

        /* å³ä¾§è¯„è®ºåŒºå®¹å™¨ */
        .comment-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 350px; /* è¯„è®ºåŒºå®½åº¦ */
            height: 100%;
            background-color: #f8f9fa;
            box-shadow: -2px 0 6px rgba(0,0,0,0.1);
            transform: translateX(100%); /* é»˜è®¤éšè—åœ¨å³ä¾§ */
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        .comment-panel.show {
            transform: translateX(0); /* æ˜¾ç¤ºæ—¶æ»‘å…¥ */
        }
        /* ä¸“é—¨ç”¨äºæŠ˜å çš„ç±» */
        .collapsed {
            display: none !important;
        }
        /* è¯„è®ºåŒºå¤´éƒ¨ */
        .comment-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .comment-panel-header h4 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }
        #close-comment-panel-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        /* è¯„è®ºåˆ—è¡¨ */
        .comment-list {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .comment-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        /* æ–°å¢ï¼šè¯„è®ºç‚¹èµå’Œå›å¤æ ·å¼ */
        .comment-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #888;
        }
        .like-btn, .reply-link {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            color: #888;
        }
        .like-btn.liked {
            color: #e53e3e; /* ç‚¹èµåå˜çº¢è‰² */
        }
        .reply-link {
            text-decoration: underline;
            font-size: 0.85rem;
        }
        .like-count {
            margin-left: -5px;
        }
          
        .comment-item:last-child {
            border-bottom: none;
        }
        .comment-item strong {
            color: #0077cc;
        }
        .no-comments-tip {
            text-align: center;
            color: #999;
            margin-top: 20px;
        }
        /* è¾“å…¥åŒº */
        .comment-input-area {
            padding: 15px;
            border-top: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #comment-textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            resize: none;
        }
        #submit-comment-btn {
            padding: 8px 15px;
            background-color: #0077cc;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            align-self: flex-end;
        }

        .floor {
            border: 1px solid #ccc;
            margin: 20px auto;
            padding: 20px;
            max-width: 800px;
            border-radius: 6px;
            background: #fff;
        }
/* ------------------------------------------- */
/* å±€éƒ¨ä»£ç ä¿®æ”¹å’Œæ–°å¢ */
/* ------------------------------------------- */

/* ä¿®æ”¹ .floor-header ä»¥æ”¯æŒå®šä½å³ä¸Šè§’çš„æŒ‰é’® */
.floor-header {
    font-weight: bold;
    margin-bottom: 10px;
    display: flex; /* æ–°å¢: å¯ç”¨ Flexbox */
    justify-content: space-between; /* æ–°å¢: åˆ†æ•£å†…å®¹ */
    align-items: center; /* æ–°å¢: å‚ç›´å±…ä¸­ */
}

/* æ¥¼å±‚/ç¿»é¡µæ¨¡å¼ä¸‹çš„è¯„è®ºæŒ‰é’®æ ·å¼ */
.comment-view-btn {
    background: none;
    border: none;
    color: #0077cc; /* ä½¿ç”¨ä¸»é¢˜è‰² */
    font-size: 0.9rem;
    cursor: pointer;
    padding: 0 5px;
    white-space: nowrap;
    transition: color 0.2s;
}

.comment-view-btn:hover {
    color: #005fa3;
}

/* ç¿»é¡µæ¨¡å¼ä¸‹ï¼Œé¡µè„šéœ€è¦ä¸€ä¸ªå®šä½åŸºç‚¹æ¥æ”¾ç½®æŒ‰é’® */
.page-footer {
    /* åŸæœ‰æ ·å¼ä¸å˜ï¼Œä½†ç¡®ä¿å®ƒæ˜¯å®šä½ä¸Šä¸‹æ–‡ */
    position: relative; /* ç¡®ä¿å®ƒèƒ½ä½œä¸º .page-view-comment-btn çš„å®šä½çˆ¶çº§ */
    text-align: center;
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* ç¿»é¡µæ¨¡å¼ä¸‹è¯„è®ºæŒ‰é’®çš„å®šä½ (å³ä¸Šè§’) */
.page-view-comment-btn {
Â  Â  position: absolute;
Â  Â  /* è°ƒæ•´ top å’Œ rightï¼Œä½¿å…¶ä½äº 30px padding åŒºåŸŸå†…ï¼Œçœ‹èµ·æ¥æ›´è´´åˆè¾¹è§’ */
Â  Â  right: 15px;Â  
Â  Â  top: 15px; 
    /* ç§»é™¤åŸæœ‰å±…ä¸­å®šä½å±æ€§ */
Â  Â  transform: none; 
    z-index: 10; /* ç¡®ä¿æŒ‰é’®åœ¨æ–‡å­—å†…å®¹ä¹‹ä¸Š */
}

/* ------------------------------------------- */
/* B. æ–°å¢ï¼šç¦ç”¨è¯„è®ºè¾“å…¥åŒºæ ·å¼ */
/* ------------------------------------------- */

/* ç¦ç”¨è¯„è®ºè¾“å…¥åŒºæ ·å¼ (Viewer Mode) */
.comment-panel.viewer-mode .comment-input-area {
    /* è§†è§‰ä¸Šç¦ç”¨ */
    background-color: #e9ecef; 
    opacity: 0.7;
    pointer-events: none; /* å½»åº•ç¦ç”¨æ‰€æœ‰äº¤äº’ */
}

/* ç¡®ä¿å¤œé—´æ¨¡å¼ä¸‹çš„ç¦ç”¨æ ·å¼ä¹Ÿç”Ÿæ•ˆ */
.comment-panel.dark-mode.viewer-mode .comment-input-area {
    background-color: #33363b;
    opacity: 0.7;
}
.page-view {
Â  Â  Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  Â  Â  max-width: 100%;Â  Â  Â  Â  Â /* ä¸å…è®¸è¶…å‡ºå®¹å™¨å®½åº¦ */
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  margin: 20px auto;
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  Â  Â  background: #fff;

Â  Â  Â  Â  Â  word-break: break-all;Â  Â /* ä¸­æ–‡ã€è‹±æ–‡é•¿ä¸²éƒ½å¼ºåˆ¶æ¢è¡Œ */
Â  Â  overflow-wrap: anywhere; /* ç°ä»£æµè§ˆå™¨æ¨è */
Â  Â  /*white-space: pre-wrap;*/Â  Â /* æ—¢ä¿ç•™æ¢è¡Œï¼Œåˆå…è®¸æŠ˜è¡Œ */
Â  Â  Â  Â  }


/* ------------------------------------------- */
/* é€šç”¨éƒ¨åˆ†ï¼šä¾§è¾¹æ æŠ˜å é€»è¾‘ + æŒ‰é’®æ ·å¼ */
/* ------------------------------------------- */

/* ä¾§è¾¹æ æŠ˜å æ—¶æ•´ä½“å·¦ç§»éšè— */
#sidebar.collapsed {
    transform: translateX(-100%);
}

/* ä¾§è¾¹æ å›ºå®šæ ·å¼ï¼ˆä¿æŒåŸæ¥ä½ç½®ï¼‰ */
#sidebar {
    position: fixed;
    left: calc(50% - 400px - 70px - 50px);
    top: 50%;
    transform: translateY(-50%);
    width: 70px;
    background: #f5f5f5;
    border-radius: 0 8px 8px 0;
    box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    z-index: 1000;
    transition: transform 0.3s ease-in-out, left 0.3s ease-in-out;
}

/* æ¡Œé¢ç«¯ï¼šæŒ‰é’®ç´§è´´ä¾§è¾¹æ é¡¶éƒ¨ */
#sidebar-toggle-container {
    position: fixed;
    /* ä¸ä¾§è¾¹æ ä¿æŒç›¸åŒ left åŸºå‡†ï¼Œåªéœ€ç•¥å¾®å±…ä¸­ */
    left: calc(50% - 400px - 70px - 50px + 35px);
    top: calc(50% - 70px / 2); /* ç²¾ç¡®å¯¹é½ï¼šä¾§è¾¹æ ä¸­å¿ƒå¾€ä¸Š ä¾§è¾¹æ ä¸€åŠé«˜åº¦ + å¾®è°ƒ */
  transform: translateY(-470%); /* è®©æŒ‰é’®åˆšå¥½é¡¶åœ¨ä¾§è¾¹æ ä¸Šæ–¹ */
    z-index: 1001;

    background: #f5f5f5;
    border-radius: 8px 8px 0 0;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    padding: 4px 6px;
    transition: left 0.3s ease-in-out, top 0.3s ease-in-out;
}

/* æ–°å¢ï¼šæ‰‹æœºç«¯â€œå›åˆ°é¡¶éƒ¨â€æŒ‰é’®ï¼Œé»˜è®¤éšè—ï¼ˆæ¡Œé¢ä¸æ˜¾ç¤ºï¼‰ */
#back-to-top-mobile {
    display: none;
}

#back-to-top-mobile-btn {
    border: none;
    background-color: transparent;
    cursor: pointer;
}

      /* æ–°å¢ï¼šæ‰‹æœºç«¯â€œèƒŒæ™¯é€è§†â€æŒ‰é’®ï¼Œé»˜è®¤éšè—ï¼ˆæ¡Œé¢ä¸æ˜¾ç¤ºï¼‰ */
#bg-peek-mobile {
  display: none;
}
#bg-peek-mobile-btn {
  border: none;
  background-color: transparent;
  cursor: pointer;
}

      
/* æŒ‰é’®æ ·å¼ */
#sidebar-toggle-btn {
    padding: 0;
    border: none;
    background-color: transparent;
    color: #333;
    font-size: 1.4rem;
    cursor: pointer;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
}
#sidebar-toggle-btn:hover {
    color: #0077cc;
}

/* ------------------------------------------- */
/* æ‰‹æœºç«¯é€‚é…ï¼šæŒ‰é’®æµ®åœ¨å·¦ä¸Šè§’ï¼Œä¾§è¾¹æ è¦†ç›–å…¨å±å·¦ä¾§ */
/* ------------------------------------------- */

@media (max-width: 1050px) {
    /* è®©ä¾§è¾¹æ æˆä¸ºå·¦æ»‘èœå• */
    #sidebar {
        top: 0;
        left: 0;
        transform: translateX(-100%);
        width: 240px; /* ç§»åŠ¨ç«¯å®½åº¦ */
        height: 100vh;
        border-radius: 0;
        justify-content: flex-start;
        padding-top: 60px;
        box-shadow: 2px 0 10px rgba(0,0,0,0.3);
        transition: transform 0.3s ease-in-out;
    }

    #sidebar.show {
        transform: translateX(0);
    }

    /* æŒ‰é’®å›ºå®šåœ¨å·¦ä¸Šè§’ */
    #sidebar-toggle-container {
        position: fixed;
        top: 120px;
        left: 12px;
        transform: none;
        z-index: 1200;
        background: rgba(245, 245, 245, 0.95);
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        padding: 6px 8px;
    }

    #sidebar-toggle-btn {
        font-size: 1.6rem;
        color: #333;
    }

    /* æŠ˜å æ—¶æŒ‰é’®æ ·å¼å˜åŒ– */
    #sidebar-toggle-btn[aria-expanded="false"] {
        color: #0077cc;
    }

    /* æ–°å¢ï¼šæ‰‹æœºç«¯ç‹¬ç«‹â€œå›åˆ°é¡¶éƒ¨â€æŒ‰é’®ï¼Œæµ®åœ¨å·¥å…·æ æŒ‰é’®ä¸Šæ–¹ */
    #back-to-top-mobile {
        position: fixed;
        top: 80px;          /* æ¯” toggle æŒ‰é’®ï¼ˆ120pxï¼‰ç•¥é«˜ä¸€ç‚¹ */
        left: 12px;
        z-index: 1200;
        background: rgba(245, 245, 245, 0.95);
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        padding: 6px;
        display: flex;      /* è¦†ç›–é»˜è®¤çš„ display:none */
        align-items: center;
        justify-content: center;
    }

    #back-to-top-mobile-btn {
        font-size: 1.4rem;
        color: #333;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

  
}


      .page-view, .floor-body, #book-content .ql-editor {
    word-break: break-all;   /* ä¸­æ–‡ã€è‹±æ–‡é•¿ä¸²éƒ½å¼ºåˆ¶æ¢è¡Œ */
    overflow-wrap: anywhere; /* ç°ä»£æµè§ˆå™¨æ¨è */
    white-space: pre-wrap;   /* æ—¢ä¿ç•™æ¢è¡Œï¼Œåˆå…è®¸æŠ˜è¡Œ */
}
          
        .sidebar-btn-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 6px;
        }
        .sidebar-btn-group:hover {
            background-color: #e0e0e0;
        }
        .sidebar-btn-group button {
            width: 40px;
            height: 40px;
            padding: 0;
            border: none;
            background-color: transparent;
            color: #333;
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .sidebar-btn-group span {
            font-size: 0.75rem;
            color: #666;
            line-height: 1;
        }
        .like-counter {
            font-size: 0.8rem;
            color: #666;
            margin-top: -5px;
            line-height: 1;
            text-align: center;
        }
        .like-icon.liked {
            color: #e53e3e;
        }
          
        .nav-toggle-icon {
            font-size: 1.2rem;
            line-height: 1;
        }
          

        /* å¯¼èˆªç½‘æ ¼æµ®çª— */
        .nav-grid-popup {
            position: fixed;
            left: 70px; /* ç´§è´´ä¾§è¾¹æ  */
            top: 50%;
            transform: translateY(-50%);
            width: 250px;
            max-height: 400px;
            padding: 15px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1010;
            display: none; /* é»˜è®¤éšè— */
            flex-wrap: wrap;
            gap: 10px;
            overflow-y: auto;
        }
        .nav-grid-popup.show {
            display: flex;
        }
        .nav-cell {
            flex-grow: 1;
            flex-basis: 40px;
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #f0f2f5;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .nav-cell:hover {
            background: #e9ecef;
        }
      
/* ------------------------------------------- */
/* ä¿®æ­£ï¼šå½»åº•çš„å¤œé—´æ¨¡å¼æ ·å¼ (DARK MODE) */
/* ------------------------------------------- */

/* 1. å…¨å±€èƒŒæ™¯å’Œé»˜è®¤æ–‡å­—é¢œè‰² */
body.dark-mode {
    /* æ ¸å¿ƒï¼šæœ€æ·±çš„èƒŒæ™¯è‰² */
    background-color: #1a1a1a; 
    color: #c9d1d9; 
}

/* 2. ä¸»è¦å†…å®¹å®¹å™¨ (Book Container) */
.book-container.dark-mode {
    background-color: #2d3035 !important; 
    /* å…³é”®ä¿®æ­£: ä½¿ç”¨æ·±è‰²é˜´å½±ï¼Œé˜²æ­¢è¾¹ç¼˜å‡ºç°æµ…è‰²å…‰æ™• */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6); 
    /* ä¿®æ­£: è¾¹æ¡†æ”¹ä¸ºæ·±è‰² */
    border: 1px solid #444 !important; 
}

/* 3. æ¥¼å±‚/ç¿»é¡µæ¨¡å¼å®¹å™¨ (Floor / Page View) */
.floor.dark-mode, 
.page-view.dark-mode {
    background: #2d3035 !important; /* å¼ºåˆ¶æ·±è‰²èƒŒæ™¯ */
    /* å…³é”®ä¿®æ­£: è¦†ç›–æ™®é€šæ¨¡å¼ä¸‹çš„æµ…è‰²è¾¹æ¡† */
    border: 1px solid #444 !important; 
    color: #c9d1d9; 
    /* ç¿»é¡µ/æ¥¼å±‚æ¨¡å¼å¯èƒ½æ²¡æœ‰é˜´å½±ï¼Œä½†å¦‚æœæœ‰ï¼Œç¡®ä¿å…¶è¢«è¦†ç›– */
    box-shadow: none; 
}

/* 4. å·¦ä¾§æ“ä½œæ ï¼ˆ#sidebarï¼‰ */
#sidebar.dark-mode { 
    background: #2d3035;
    box-shadow: 2px 0 5px rgba(0,0,0,0.4);
    /* ä¿®æ­£: ç§»é™¤ä¾§è¾¹æ é»˜è®¤çš„ç™½è‰²èƒŒæ™¯æˆ–è¾¹æ¡† */
    border: none; 
    border-right: 1px solid #444; /* ä¿ç•™åˆ†éš”çº¿ */
}
.sidebar-btn-group.dark-mode {
    background-color: transparent; 
}
.sidebar-btn-group.dark-mode:hover {
    background-color: #3d4147;
}
.sidebar-btn-group.dark-mode button {
    color: #c9d1d9;
}
.sidebar-btn-group.dark-mode span {
    color: #aaa;
}


/* 5. è¯„è®ºåŒºï¼ˆComment Panelï¼‰ */
.comment-panel.dark-mode {
    background-color: #22252a; 
    box-shadow: -2px 0 6px rgba(0,0,0,0.4);
    border-left: 1px solid #444;
}
/* è¯„è®ºåˆ—è¡¨é¡¹ã€è¾“å…¥åŒºå’Œè¾¹æ¡† */
.comment-item.dark-mode {
    border-bottom: 1px solid #444;
    color: #c9d1d9;
}
.comment-panel.dark-mode .comment-input-area,
.comment-panel.dark-mode #comment-textarea {
    background-color: #2d3035;
    border: 1px solid #444;
    color: #c9d1d9;
}
.comment-panel-header.dark-mode {
    border-bottom: 1px solid #444;
}
.comment-panel.dark-mode .comment-list {
    border-top: 1px solid #444;
}


/* 6. å¯¼èˆªæµ®çª— (Nav Grid Popup) */
.nav-grid-popup.dark-mode {
    background-color: #2d3035;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.nav-cell.dark-mode {
    background-color: #33363b;
    /* ä¿®æ­£: è¦†ç›–æµ…è‰²è¾¹æ¡† */
    border: 1px solid #444 !important; 
    color: #c9d1d9;
}
.nav-cell.dark-mode:hover {
    background: #444;
}

/* 7. Quill å†…å®¹è¦†ç›–ï¼ˆç¡®ä¿å†…å®¹åŒºå†…éƒ¨æ— ç™½è‰²ï¼‰ */
/* å…³é”®è¦†ç›– 1ï¼šç¡®ä¿ Quill å®¹å™¨å’Œä¸»å†…å®¹åŒºçš„èƒŒæ™¯æ˜¯æ·±è‰² */
.book-container.dark-mode #book-content,
.book-container.dark-mode .floor-body {
    background-color: #2d3035 !important; 
    color: #c9d1d9;
}

/* å…³é”®è¦†ç›– 2ï¼šé’ˆå¯¹ Quill ç¼–è¾‘å™¨æ ¸å¿ƒ (ql-editor) */
.book-container.dark-mode #book-content .ql-editor {
    color: #c9d1d9 !important; 
    background-color: transparent !important; 
}

/* å…³é”®è¦†ç›– 3ï¼šé’ˆå¯¹ Quill å†…éƒ¨çš„å…ƒç´  */
.book-container.dark-mode .ql-editor p,
.book-container.dark-mode .ql-editor h1,
.book-container.dark-mode .ql-editor h2,
.book-container.dark-mode .ql-editor li,
.book-container.dark-mode .ql-editor blockquote {
    color: #c9d1d9 !important;  
    background-color: transparent !important; 
    border-color: #444 !important; 
}

/* å…³é”®è¦†ç›– 4ï¼šç¡®ä¿ Quill Snow ä¸»é¢˜çš„å¤–éƒ¨å®¹å™¨ä¸ä¼šæ˜¯ç™½è‰² */
.book-container.dark-mode .ql-container.ql-snow {
    background-color: transparent !important;
}

/* ... ä¿æŒå…¶ä»–å¦‚ Page Footer å’Œ Spoiler/Secret çš„ dark-mode è§„åˆ™ä¸å˜ ... */

/* 8. ç¿»é¡µæŒ‰é’® (Page Footer) */
.page-footer.dark-mode {
    background-color: transparent;  
}
.page-footer.dark-mode button {
    background-color: #444;
    color: #c9d1d9;
    border: 1px solid #666;
}
.page-footer.dark-mode button:hover:not(:disabled) {
    background-color: #555;
}
.page-footer.dark-mode #page-indicator {
    color: #c9d1d9;
}

/* 9. å‰§é€å’Œæš—éª°æ ·å¼ (Spoiler/Secret) */
body.dark-mode .ql-editor .spoiler-hidden {
    background-color: #33363b;  
    color: #33363b;  
}
body.dark-mode .ql-editor .spoiler-hidden[data-mode="spoiler"]:hover {
    color: #c9d1d9;
    background-color: transparent;
}
body.dark-mode .ql-editor .spoiler-hidden[data-mode="secret"],
body.dark-mode .ql-editor .spoiler-hidden[data-mode="secret"]:hover {
    background-color: #4a0000;
    color: #4a0000;
    border: 1px solid #666;
}

      #quill-page-view .ql-editor {
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: pre-wrap;
}

      /* ------------------------------------------- */
/* æ–°å¢ï¼šéšè—æ–‡å­— (Spoiler) Blotçš„é˜…è¯»ç«¯CSS */
/* ------------------------------------------- */

/* Base style for both modes */
.ql-editor .spoiler-hidden {
    /* é»˜è®¤éšè—æ ·å¼ï¼šç™½åº•è—ç™½å­—ï¼Œç¡®ä¿åœ¨é˜…è¯»ç«¯çœ‹èµ·æ¥åƒé»˜è®¤æ–‡æœ¬ */
    background-color: #000; 
    color: #000; 
    padding: 0 4px; 
    border-radius: 2px;
    transition: color 0.3s, background-color 0.3s;
}

/* æ¨¡å¼ 1: å‰§é€æ¨¡å¼ (é¼ æ ‡æ‚¬åœå³æ˜¾ç¤º) */
.ql-editor .spoiler-hidden[data-mode="spoiler"] {
    cursor: pointer;
}
.ql-editor .spoiler-hidden[data-mode="spoiler"]:hover {
    color: #000; /* æ‚¬åœæ—¶æ˜¾ç¤ºæ–‡å­—ä¸ºé»‘è‰² */
    background-color: transparent; /* èƒŒæ™¯é€æ˜ */
}

/* æ¨¡å¼ 2: æš—éª°æ¨¡å¼ (åœ¨é˜…è¯»å™¨å†…å§‹ç»ˆéšè—) */
.ql-editor .spoiler-hidden[data-mode="secret"] {
    background-color: #6a0000; /* ä½¿ç”¨ç‰¹æ®Šçš„æš—è‰²åŒºåˆ† */
    color: #6a0000;
    cursor: default; 
    border: 1px solid #999;
}

/* ç¡®ä¿æš—éª°åœ¨é˜…è¯»ç«¯ä¿æŒéšè— */
.ql-editor .spoiler-hidden[data-mode="secret"]:hover {
    color: #6a0000;
    background-color: #6a0000;
}

/* å¤œé—´æ¨¡å¼è¦†ç›– */
body.dark-mode .ql-editor .spoiler-hidden {
    background-color: #33363b; 
    color: #33363b; 
}
body.dark-mode .ql-editor .spoiler-hidden[data-mode="spoiler"]:hover {
    color: #c9d1d9; 
    background-color: transparent;
}
body.dark-mode .ql-editor .spoiler-hidden[data-mode="secret"],
body.dark-mode .ql-editor .spoiler-hidden[data-mode="secret"]:hover {
    background-color: #4a0000;
    color: #4a0000;
    border: 1px solid #666;
}

/* ------------------------------------------- */
/* æ–°å¢ï¼šå›¾ç‰‡æœ€å¤§æ˜¾ç¤ºèŒƒå›´é™åˆ¶æœºåˆ¶ */
/* ------------------------------------------- */

/* é’ˆå¯¹ #book-content å®¹å™¨å†…çš„æ‰€æœ‰å›¾ç‰‡è¿›è¡Œé™åˆ¶ */
#book-content img {
    /* 1. é™åˆ¶å®½åº¦å’Œé«˜åº¦ï¼Œç¡®ä¿å›¾ç‰‡ä¸ä¼šè¶…å‡ºé˜…è¯»åŒº */
    max-width: 100%; /* å›¾ç‰‡æœ€å¤§å®½åº¦ä¸èƒ½è¶…è¿‡å…¶çˆ¶å…ƒç´ ï¼ˆé˜…è¯»å†…å®¹åŒºï¼‰çš„å®½åº¦ */
    max-height: 80vh; /* é™åˆ¶å›¾ç‰‡çš„æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„ 80% (ä¾‹å¦‚ï¼Œé˜²æ­¢è¶…é•¿å›¾ç‰‡éœ¸å±) */
    
    /* 2. ä¿æŒå›¾ç‰‡çš„å®½é«˜æ¯” */
    height: auto; 
    width: auto; /* é€šå¸¸ max-width: 100% å·²ç»ä¿è¯äº†ç­‰æ¯”ä¾‹ç¼©æ”¾ */
    
    /* å¯é€‰: ç¡®ä¿å›¾ç‰‡åœ¨é¡µé¢ä¸­å±…ä¸­æ˜¾ç¤º */
    display: block;
    margin: 10px auto; 
    
    /* å¯é€‰: å¢åŠ è¿‡æ¸¡æ•ˆæœï¼Œä½¿å›¾ç‰‡è°ƒæ•´æ›´å¹³æ»‘ */
    transition: max-width 0.3s, max-height 0.3s; 
}

/* æ–°å¢ï¼šå¥æœ«è¯„è®ºæ ‡è¯†æ ·å¼ */
.comment-indicator {
    margin-left: 5px;
    font-size: 0.9em;
    font-weight: bold;
    color: #0077cc; /* ä½¿ç”¨ä¸»é¢˜è‰² */
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.2s;
    user-select: none; /* é˜²æ­¢è¢«é€‰ä¸­ */
    white-space: nowrap; /* é¿å…æ¢è¡Œ */
}

.comment-indicator:hover {
    opacity: 1;
    text-decoration: underline;
}

/* é»˜è®¤æ˜¾ç¤º emoji + æ–‡å­— */
.comment-indicator::before {
    content: "ğŸ’¬"; 
}

/* ç‚¹å‡»å¥å­åï¼Œé«˜äº®å½“å‰è¯„è®ºç›®æ ‡ */
.active-comment-target {
    background-color: rgba(0, 119, 204, 0.1); /* æµ…è“è‰²èƒŒæ™¯é«˜äº® */
    padding: 2px 0;
    border-radius: 4px;
    transition: background-color 0.2s;
}

  /* =============== ä¿®å¤éšè—æ–‡å­—æ ·å¼ä¸ç”Ÿæ•ˆçš„é—®é¢˜ =============== */
/* è®©é Quill å®¹å™¨ï¼ˆå¦‚æ¥¼å±‚/ç¿»é¡µå†…å®¹ï¼‰ä¸­çš„éšè—æ–‡å­—ä¹Ÿèƒ½æ˜¾ç¤ºæ•ˆæœ */
.floor-body .spoiler-hidden,
.page-view .spoiler-hidden,
.book-content .spoiler-hidden {
    background-color: #000;
    color: #000;
    padding: 0 4px;
    border-radius: 2px;
    transition: color 0.3s, background-color 0.3s;
}

/* æ¨¡å¼1ï¼šå‰§é€ï¼ˆhover æ˜¾ç¤ºï¼‰ */
.floor-body .spoiler-hidden[data-mode="spoiler"],
.page-view .spoiler-hidden[data-mode="spoiler"],
.book-content .spoiler-hidden[data-mode="spoiler"] {
    cursor: pointer;
}
.floor-body .spoiler-hidden[data-mode="spoiler"]:hover,
.page-view .spoiler-hidden[data-mode="spoiler"]:hover,
.book-content .spoiler-hidden[data-mode="spoiler"]:hover {
    color: #000;
    background-color: transparent;
}

/* æ¨¡å¼2ï¼šæš—éª°ï¼ˆå§‹ç»ˆéšè—ï¼‰ */
.floor-body .spoiler-hidden[data-mode="secret"],
.page-view .spoiler-hidden[data-mode="secret"],
.book-content .spoiler-hidden[data-mode="secret"] {
    background-color: #6a0000;
    color: #6a0000;
    border: 1px solid #999;
}

/* å¤œé—´æ¨¡å¼è¦†ç›– */
body.dark-mode .floor-body .spoiler-hidden,
body.dark-mode .page-view .spoiler-hidden,
body.dark-mode .book-content .spoiler-hidden {
    background-color: #33363b;
    color: #33363b;
}
body.dark-mode .floor-body .spoiler-hidden[data-mode="spoiler"]:hover,
body.dark-mode .page-view .spoiler-hidden[data-mode="spoiler"]:hover,
body.dark-mode .book-content .spoiler-hidden[data-mode="spoiler"]:hover {
    color: #c9d1d9;
    background-color: transparent;
}
body.dark-mode .floor-body .spoiler-hidden[data-mode="secret"],
body.dark-mode .page-view .spoiler-hidden[data-mode="secret"],
body.dark-mode .book-content .spoiler-hidden[data-mode="secret"] {
    background-color: #4a0000;
    color: #4a0000;
    border: 1px solid #666;
}

/* ===================
ç¿»é¡µæ¨¡å¼ä¸‹â€œæŸ¥çœ‹è¯„è®ºâ€æŒ‰é’®å®šä½
=================== */
.book-content {
    position: relative; /* å…³é”®ï¼šå»ºç«‹å®šä½ä¸Šä¸‹æ–‡ */
}

.page-view-comment-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 20;
    background-color: #0077cc;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.page-view-comment-btn:hover {
    background-color: #005fa3;
}

/* å¤œé—´æ¨¡å¼é€‚é…ï¼ˆå¯é€‰ï¼‰ */
body.dark-mode .page-view-comment-btn {
    background-color: #444;
    color: #c9d1d9;
}
body.dark-mode .page-view-comment-btn:hover {
    background-color: #555;
}     

  /* ========== å…¨å±€åŠ è½½è¿›åº¦æ¡æ ·å¼ ========== */
#global-loading-bar {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  background-color: #0077cc;
  width: 0%;
  transition: width 0.3s ease;
  z-index: 2000;
}
body.dark-mode #global-loading-bar {
  background-color: #66b0ff;
}

      /* shake */


/* flash */
.effect-flash {
  animation: effect-flash 0.6s infinite;
}
@keyframes effect-flash {
  0% { background-color: transparent; }
  50% { background-color: #fff3cd; }
  100% { background-color: transparent; }
}

/* fade in */
.effect-fade {
  animation: effect-fade 1.2s forwards;
}
@keyframes effect-fade {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

/* highlight */
.effect-highlight {
  animation: effect-highlight 1s forwards;
}
@keyframes effect-highlight {
  from { background: #fff3cd; }
  to { background: transparent; }
}

/* shakeï¼šåªç»™å†…éƒ¨ span ç”¨ */
.effect-shake {
    display: inline-block;
    animation: shake 0.25s infinite;
}

@keyframes shake {
    0%   { transform: translateX(0); }
    25%  { transform: translateX(1px); }
    50%  { transform: translateX(-1px); }
    75%  { transform: translateX(1px); }
    100% { transform: translateX(0); }
}
.effect-glow {
    animation: glow 2s ease-in-out infinite;
}
@keyframes glow {
    0%,100% { text-shadow: 0 0 2px rgba(255,255,255,0.5); }
    50% { text-shadow: 0 0 10px rgba(255,255,255,1); }
}

      /* èƒŒæ™¯å±‚ï¼šé“ºæ»¡å…¨å±ï¼Œåœ¨æœ€åº•ä¸‹ */
#read-bg-wrapper {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
}

.read-bg-image {
  position: absolute;
  inset: 0;
  background-size: cover;
  background-position: center center;
  background-repeat: no-repeat;
  opacity: 0;
  transition: opacity 0.8s ease;
}

/* å…¶å®ƒå†…å®¹ï¼šæµ®åœ¨èƒŒæ™¯å›¾ä¹‹ä¸Š */
/* åŸæ¥æ˜¯æŠŠ sidebar / comment-panel ä¹Ÿä¸€èµ·å†™è¿›æ¥äº† */
/* æ”¹æˆåªç»™å¤–å±‚å®¹å™¨å’Œä¹¦æœ¬å®¹å™¨æ z-index */

.read-page-wrapper,
.book-container {
    position: relative;
    z-index: 1;
}

/* ===================
é˜…è¯»é¡µæ•´ä½“æ ·å¼ï¼ˆæ–°å¢èƒŒæ™¯æ”¯æŒï¼‰
=================== */

/* å¤–å±‚å®¹å™¨ï¼šä¿è¯é˜…è¯»å†…å®¹åœ¨èƒŒæ™¯å›¾ä¸Šæ–¹ */
.read-page-wrapper {
    position: relative;
    z-index: 1;
    min-height: 100vh;
}

/* èƒŒæ™¯åŒ…è£¹å±‚ï¼šå›ºå®šè¦†ç›–æ•´å±ï¼Œæ”¾åœ¨æœ€åº•å±‚ */
#read-bg-wrapper {
    position: fixed;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: 0; /* å†…å®¹å±‚åœ¨ z=1ï¼Œä¸Šé¢ */
}

/* èƒŒæ™¯å›¾ç‰‡åŒå±‚ï¼šåšæ·¡å…¥æ·¡å‡º */
.read-bg-layer,
#read-bg-layer-a,
#read-bg-layer-b {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    opacity: 0;
    transition: opacity 0.7s ease;
}

      /* âœ… å…³é”®ä¿®å¤ï¼šæŠŠè¿‡æ¸¡å†™åˆ°â€œé»˜è®¤æ€â€ï¼Œè¿™æ ·å¼€å¯/å…³é—­éƒ½ä¼šåŠ¨ç”» */
#global-loading-bar,
.read-page-wrapper > :not(#read-bg-wrapper) {
  opacity: 1;
  filter: none;
  transition: opacity 0.15s ease, filter 0.15s ease;
  will-change: opacity, filter; /* å¯é€‰ï¼šè®©åŠ¨ç”»æ›´ç¨³ */
}

      /* =========================
   èƒŒæ™¯é€è§†æ¨¡å¼ï¼ˆPCï¼‰ï¼šé™¤èƒŒæ™¯å¤–å…¨éƒ¨è™šåŒ–
   ========================= */
body.bg-peek-mode #global-loading-bar,
body.bg-peek-mode .read-page-wrapper > :not(#read-bg-wrapper) {
  opacity: 0.12;              /* é€æ˜åº¦è°ƒé«˜å¾ˆå¤šï¼ˆæ›´â€œæ·¡â€ï¼‰ */
  filter: blur(2px);          /* è½»å¾®è™šåŒ– */
  transition: opacity 0.15s ease, filter 0.15s ease;
}

/* å·¥å…·æ æŒ‰é’®æ¿€æ´»æ€ï¼ˆå¯é€‰ï¼Œä½†å»ºè®®åŠ ï¼‰ */
#bg-peek-btn.active {
  background-color: #e6f7ff;
}
#bg-peek-btn.active:hover {
  background-color: #d7f1ff;
}
#bg-peek-btn.active button {
  color: #0077cc;
}

      @media (max-width: 1050px) {
  /* æ–°å¢ï¼šæ‰‹æœºç«¯â€œèƒŒæ™¯é€è§†â€æŒ‰é’®ï¼Œæµ®åœ¨å›åˆ°é¡¶éƒ¨æŒ‰é’®ä¸Šæ–¹ */
  #bg-peek-mobile {
    position: fixed;
    top: 40px;         /* âœ… æ¯”å›åˆ°é¡¶éƒ¨ï¼ˆ80pxï¼‰æ›´é ä¸Š */
    left: 12px;
    z-index: 1200;
    background: rgba(245, 245, 245, 0.95);
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    padding: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #bg-peek-mobile-btn {
    font-size: 1.2rem;
    color: #333;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* æ¿€æ´»æ€ï¼ˆå¯é€‰ï¼‰ */
  #bg-peek-mobile.active {
    outline: 2px solid rgba(0,119,204,0.35);
  }
}
/* =========================
   ç§»åŠ¨ç«¯ï¼šèƒŒæ™¯é€è§†æ¨¡å¼ï¼ˆåªä¿ç•™èƒŒæ™¯ + è¿™ä¸ªæŒ‰é’®ä¸è™šåŒ–ï¼‰
   ========================= */
body.bg-peek-mobile-mode #global-loading-bar,
body.bg-peek-mobile-mode .read-page-wrapper > :not(#read-bg-wrapper):not(#bg-peek-mobile) {
  opacity: 0.12;
  filter: blur(2px);
  transition: opacity 0.15s ease, filter 0.15s ease;
}

      /* ===== æ‡’åŠ è½½ / å¼±ç½‘æç¤º Toastï¼ˆåº•éƒ¨ï¼‰ ===== */
.lazy-load-toast{
  position: fixed;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%) translateY(10px);
  background: rgba(25,25,25,0.88);
  color: #fff;
  padding: 10px 14px;
  border-radius: 999px;
  font-size: 13px;
  display: none;
  align-items: center;
  gap: 10px;
  z-index: 3000;
  box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  opacity: 0;
  transition: opacity .22s ease, transform .22s ease;
}
.lazy-load-toast.show{
  display: flex;
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}
.lazy-load-toast .spinner{
  width: 14px;
  height: 14px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.35);
  border-top-color: #fff;
  animation: lazySpin .9s linear infinite;
}
@keyframes lazySpin { to { transform: rotate(360deg); } }

.lazy-load-toast .nav-btn{
  display: none;               /* é»˜è®¤éšè— */
  background: rgba(255,255,255,0.14);
  color: #fff;
  border: 1px solid rgba(255,255,255,0.25);
  padding: 6px 10px;
  border-radius: 999px;
  cursor: pointer;
  font-size: 12px;
}
.lazy-load-toast.weak .nav-btn{ display: inline-flex; }

/* æ¥¼å±‚å†…å®¹å°šæœªå‡†å¤‡å¥½æ—¶çš„å ä½ */
.lazy-floor-placeholder{
  padding: 16px 0;
  display: flex;
  align-items: center;
  gap: 10px;
  color: #888;
}
.lazy-floor-placeholder .spinner{
  width: 16px;
  height: 16px;
  border-radius: 50%;
  border: 2px solid rgba(0,0,0,0.12);
  border-top-color: rgba(0,0,0,0.55);
  animation: lazySpin .9s linear infinite;
}

      
    </style>
<div id="global-loading-bar"></div>

<!-- â­ æ–°å¢ï¼šé˜…è¯»é¡µå¤–å±‚å®¹å™¨ -->
<div class="read-page-wrapper">

  <!-- â­ æ–°å¢ï¼šèƒŒæ™¯å±‚ï¼ˆA/B ä¸¤å±‚åšæ·¡å…¥æ·¡å‡ºï¼‰ -->
  <div id="read-bg-wrapper">
    <div id="read-bg-layer-a" class="read-bg-layer"></div>
    <div id="read-bg-layer-b" class="read-bg-layer"></div>
  </div>

  <!-- ä¸‹é¢æ˜¯åŸæ¥çš„å†…å®¹ï¼Œç»“æ„ä¸å˜ï¼Œåªæ˜¯åŒ…è¿› read-page-wrapper é‡Œ -->
  <div class="book-container">
      <div class="book-header">
          <h1 id="work-title">æ­£åœ¨åŠ è½½...</h1>
          <p id="work-info">ä½œè€…ï¼š<span id="work-author">æœªçŸ¥</span> | æ›´æ–°æ—¶é—´ï¼š<span id="work-date">æœªçŸ¥</span></p>
      </div>
      <div class="book-content" id="book-content">
        <!-- âœ… æ–°å¢æŸ¥çœ‹è¯„è®ºæŒ‰é’® -->
        <button class="page-view-comment-btn" id="open-comment-panel-btn">æŸ¥çœ‹è¯„è®º</button>
        <p>ä½œå“å†…å®¹æ­£åœ¨åŠ è½½ä¸­...</p>
      </div>
  </div>

  <div id="sidebar-toggle-container">
    <button id="sidebar-toggle-btn" aria-expanded="true" title="æ”¶èµ·ä¾§è¾¹æ ">
      <span id="sidebar-toggle-icon">â®</span>
    </button>
  </div>

  <!-- æ–°å¢ï¼šæ‰‹æœºç«¯â€œèƒŒæ™¯é€è§†â€æŒ‰é’®ï¼ˆPC ç«¯è¢« CSS éšè—ï¼‰ -->
<div id="bg-peek-mobile">
  <button id="bg-peek-mobile-btn" title="èƒŒæ™¯é€è§†ï¼ˆè™šåŒ–é™¤èƒŒæ™¯å¤–å†…å®¹ï¼‰">ğŸ‘</button>
</div>

  <!-- æ–°å¢ï¼šæ‰‹æœºç«¯ç‹¬ç«‹â€œå›åˆ°é¡¶éƒ¨â€æŒ‰é’®ï¼ˆPC ç«¯è¢« CSS éšè—ï¼‰ -->
  <div id="back-to-top-mobile">
    <button id="back-to-top-mobile-btn" title="å›åˆ°é¡¶éƒ¨">â†‘</button>
  </div>

  <aside id="sidebar">
    <div class="sidebar-btn-group" id="scroll-mode-btn">
      <button>&#x1F4DC;</button>
      <span>æ¥¼å±‚æ¨¡å¼</span>
    </div>
    <div class="sidebar-btn-group" id="page-mode-btn">
      <button>&#x1F4D6;</button>
      <span>ç¿»é¡µæ¨¡å¼</span>
    </div>
    <div class="sidebar-btn-group" id="bg-peek-btn">
  <button title="Shiftï¼šèƒŒæ™¯é€è§†">â‡§</button>
  <span>èƒŒæ™¯é€è§†</span>
</div>

    <div class="sidebar-btn-group" id="nav-toggle-btn">
      <button class="nav-toggle-icon">&#8635;</button>
      <span>å¯¼èˆª</span>
    </div>
    <div class="sidebar-btn-group" id="back-to-top-btn">
      <button>â†‘</button>
      <span>å›åˆ°é¡¶éƒ¨</span>
    </div>
    <div class="sidebar-btn-group" id="light-switch-btn">
      <button>&#x1F311;</button>
      <span>å¤œé—´æ¨¡å¼</span>
    </div>
    <div class="sidebar-btn-group" id="like-work-btn">
      <button class="like-icon">â¤</button>
      <span class="like-counter">0</span>
      <span>ç‚¹èµ</span>
    </div>
  </aside>

  <aside id="comment-panel" class="comment-panel">
    <div class="comment-panel-header">
      <h4>è¯„è®º</h4>
      <button id="close-comment-panel-btn">Ã—</button>
    </div>
    <div id="comment-list" class="comment-list">
      <p class="no-comments-tip">æš‚æ— è¯„è®º</p>
    </div>
    <div class="comment-input-area">
      <textarea id="comment-textarea" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
      <button id="submit-comment-btn">å‘è¡¨</button>
    </div>
  </aside>

  <div class="nav-grid-popup" id="nav-grid-popup"></div>
<!-- æ‡’åŠ è½½ / å¼±ç½‘åˆ‡æ¢ æç¤º -->
<div id="lazy-load-toast" class="lazy-load-toast" aria-live="polite">
  <div class="spinner" aria-hidden="true"></div>
  <div id="lazy-load-toast-text" class="text">æ­£åœ¨åŠ è½½â€¦</div>
  <button id="lazy-load-toast-nav-btn" type="button" class="nav-btn">å¯¼èˆª</button>
</div>

  
</div>


  <script src="https://cdn.jsdelivr.net/npm/quill-image-resize-module@3.0.0/image-resize.min.js"></script>
     <script src="https://api.anchorx.ca/vendor_assets/quill.js"></script>
       <script>
  /* ---------- 1. æ³¨å†Œè‡ªå®šä¹‰ Blotï¼ˆæ’ä»¶ï¼‰ - ç¡®ä¿é˜…è¯»ç«¯èƒ½è§£æ HiddenTextBlot ---------- */
    // å¯¼å…¥ Quill æ ¸å¿ƒ Blot ç±»
    const Inline = Quill.import('blots/inline');

    /* éšè—æ–‡å­—ï¼ˆInline Blotï¼‰ */
    class HiddenTextBlot extends Inline {
        static blotName = 'hiddenText';
        static tagName = 'span';
        static className = 'spoiler-hidden';

        // é™æ€æ–¹æ³•ï¼šä» DOM èŠ‚ç‚¹è§£æå‡ºæ ¼å¼å€¼
        static formats(node) {
            const mode = node.getAttribute('data-mode') || 'spoiler';
            return { mode };
        }

        // é™æ€æ–¹æ³•ï¼šåˆ›å»º DOM èŠ‚ç‚¹ (åœ¨é˜…è¯»ç«¯ setContents æ—¶ä½¿ç”¨)
static create(value) {
    const node = super.create(value);
    let mode = 'spoiler'; // é»˜è®¤æ¨¡å¼

    if (value) {
    if (typeof value === 'object') {
        if (value.mode) {
            mode = value.mode;
        }
    }
}


    // è®¾ç½®è‡ªå®šä¹‰å±æ€§å’Œå¯èƒ½çš„ç‰¹å®š class
    node.setAttribute('data-mode', mode);
    if (mode === 'secret') {
        node.classList.add('secret-dice');
    } else {
        node.classList.remove('secret-dice');
    }
    return node;
}

        // å®ä¾‹æ–¹æ³•ï¼šæ›´æ–°æ ¼å¼å±æ€§ (åœ¨é˜…è¯»ç«¯ readOnly=true, ä»…ä¾›å®Œæ•´æ€§ä¿ç•™)
        format(name, value) {
    if (name === 'hiddenText') {
        if (value) {
            if (value.mode) {
                this.domNode.setAttribute('data-mode', value.mode);
                if (value.mode === 'secret') {
                    this.domNode.classList.add('secret-dice');
                } else {
                    this.domNode.classList.remove('secret-dice');
                }
                return; // æ¡ä»¶æ»¡è¶³æ—¶å°±ä¸å†èµ° super.format äº†
            }
        }
    }

    // åªè¦ä¸Šé¢çš„æ¡ä»¶æ²¡å®Œå…¨æ»¡è¶³ï¼Œå°±èµ°åŸæ¥çš„ else åˆ†æ”¯é€»è¾‘
    super.format(name, value);
}

    }

    // æ³¨å†Œè‡ªå®šä¹‰ Blot
    Quill.register(HiddenTextBlot);

      // ================= è‡ªå®šä¹‰ç‰¹æ•ˆï¼ˆé˜…è¯»ç«¯ï¼‰å…¨å±€é…ç½® =================
const EFFECT_API_BASE_URL = 'https://api.anchorx.ca/api/effects/public';

let customEffectFnMap = {};
let customEffectsLoaded = false;

      const EFFECT_DEBUG = true;           // â­ æ‰“å¼€è°ƒè¯•æ—¥å¿—
      const EFFECT_BG_DEBUG = true;        // â­ æ–°å¢ï¼šèƒŒæ™¯ç³»ç»Ÿè°ƒè¯•å¼€å…³
const EFFECT_USE_OBSERVER = true;    // â­ å¼€å¯ IntersectionObserver æ»šåŠ¨è§¦å‘æ¨¡å¼


// ç”¨äºâ€œæ»šåŠ¨åˆ°è§†å£ä¸€å®šæ¯”ä¾‹æ‰è§¦å‘â€çš„è§‚å¯Ÿå™¨
let effectObserver = null;

// åˆå§‹åŒ– IntersectionObserverï¼ˆåœ¨å¥å­åˆ°è¾¾è§†å£ä¸Šæ–¹ 1/5 é™„è¿‘è§¦å‘ï¼‰
// ---------------------------------------------------------------------
// é‡å†™ initEffectObserver â€”â€” è§¦å‘æ¡ä»¶æ”¹æˆâ€œå¥å­åˆ°è¾¾å±å¹•ä¸‹æ–¹ 1/5â€
// ---------------------------------------------------------------------


// åˆå§‹åŒ– IntersectionObserverï¼ˆåœ¨å¥å­åˆ°è¾¾è§†å£ä¸Šæ–¹ 1/5 é™„è¿‘è§¦å‘ï¼‰
// ---------------------------------------------------------------------
// é‡å†™ initEffectObserver â€”â€” è§¦å‘æ¡ä»¶æ”¹æˆâ€œå¥å­åˆ°è¾¾å±å¹•ä¸‹æ–¹ 1/5â€
// ---------------------------------------------------------------------
function initEffectObserver() {
    if (!('IntersectionObserver' in window)) {
        if (EFFECT_DEBUG) {
            console.log('âš ï¸ [effects] å½“å‰ç¯å¢ƒä¸æ”¯æŒ IntersectionObserverï¼Œæ”¹ç”¨æ»šåŠ¨ç›‘å¬æ–¹æ¡ˆ');
        }
        return null;
    }

    // è®¡ç®—è§†å£é«˜åº¦ï¼Œç”¨æ¥ç¡®å®šâ€œä¸‹æ–¹ 1/5â€è¿™æ¡å¸¦çŠ¶åŒºåŸŸ
    var viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
    // ä¸‹æ–¹ 1/5 çš„ä¸Šè¾¹ç•Œï¼Œä¾‹å¦‚ 0.8 * height
    var lowerBandTop = viewportHeight * 0.8;
    // ä¸‹æ–¹ 1/5 çš„ä¸‹è¾¹ç•Œå°±æ˜¯è§†å£åº•éƒ¨
    var lowerBandBottom = viewportHeight;

    if (EFFECT_DEBUG) {
        console.log(
            'ğŸ”§ [effects] IntersectionObserver åˆå§‹åŒ–å®Œæˆï¼š\n',
            '   viewportHeight =', viewportHeight,
            '   lowerBandTop =', lowerBandTop,
            '   lowerBandBottom =', lowerBandBottom
        );
    }

    // æ„é€ ä¸€ç»„ thresholdï¼Œè®©å…ƒç´ åœ¨è§†å£å†…éƒ¨ç§»åŠ¨æ—¶ä¹Ÿèƒ½å¤šæ¬¡è§¦å‘å›è°ƒ
    var thresholds = [];
    var t = 0.0;
    while (t <= 1.0) {
        thresholds.push(t);
        t = t + 0.1;     // æ¯ 0.1 ä¸€ä¸ªç‚¹ï¼Œä½ ä¹Ÿå¯ä»¥æ”¹æˆ 0.05 æ›´ç»†
    }

    effectObserver = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
            var target = entry.target;
            var cb = target.__effectTrigger;
            if (!cb) return;

            var rect = target.getBoundingClientRect();
            var shouldTrigger = false;

            // ç”¨å…ƒç´ ä¸­å¿ƒç‚¹åˆ¤æ–­
            var centerY = rect.top + rect.height / 2;
            if (centerY >= lowerBandTop) {
                if (centerY <= lowerBandBottom) {
                    shouldTrigger = true;
                }
            }

            if (!shouldTrigger) {
                return;
            }

            if (EFFECT_DEBUG) {
                console.log(
                    'ğŸš€ [IO] è§¦å‘ç‰¹æ•ˆï¼š',
                    target.getAttribute('data-sentence-id'),
                    ' rect.top =', rect.top.toFixed(1),
                    ' rect.bottom =', rect.bottom.toFixed(1),
                    ' centerY =', centerY.toFixed(1),
                    ' lowerBandTop =', lowerBandTop.toFixed(1),
                    ' lowerBandBottom =', lowerBandBottom.toFixed(1),
                    ' ratio =', entry.intersectionRatio.toFixed(2)
                );
            }

            try {
                cb(target);
            } catch (err) {
                console.error('æ‰§è¡Œç‰¹æ•ˆæ—¶å‡ºé”™:', err);
            }

            // åªè§¦å‘ä¸€æ¬¡å°±å–æ¶ˆç›‘å¬
            effectObserver.unobserve(target);
            delete target.__effectTrigger;
        });
    }, {
        root: null,
        threshold: thresholds
    });


    return effectObserver;
}



// æŠŠæŸä¸ªå…ƒç´ æ³¨å†Œè¿›â€œæ»šåŠ¨è§¦å‘ä¸€æ¬¡â€çš„é˜Ÿåˆ—
// æŠŠæŸä¸ªå…ƒç´ æ³¨å†Œè¿›â€œæ»šåŠ¨è§¦å‘ä¸€æ¬¡â€çš„é˜Ÿåˆ—ï¼ˆè°ƒè¯•ç‰ˆï¼‰
function registerEffectTrigger(targetEl, cb) {
    if (!targetEl || typeof cb !== 'function') return;

    const sid = targetEl.getAttribute('data-sentence-id') || '(no-id)';

    if (EFFECT_DEBUG) {
    var useObserver = false;

    // å…ˆåˆ¤æ–­æ˜¯å¦å¯ç”¨ Observer
    if (EFFECT_USE_OBSERVER) {
        // å†åˆ¤æ–­æµè§ˆå™¨æ˜¯å¦æ”¯æŒ IntersectionObserver
        if ('IntersectionObserver' in window) {
            useObserver = true;
        }
    }

    console.log(
        'ğŸ§ª [registerEffectTrigger] ç›®æ ‡å¥å­ =',
        sid,
        'ï¼Œå½“å‰åœ¨ DOM ä¸­ =',
        document.body.contains(targetEl),
        'ï¼Œä½¿ç”¨ Observer =',
        useObserver
    );
}


    // è°ƒè¯•é˜¶æ®µï¼šå¦‚æœå…³é—­æ‡’åŠ è½½ï¼Œæˆ–è€…æµè§ˆå™¨ä¸æ”¯æŒ IOï¼Œå°±ç›´æ¥æ‰§è¡Œä¸€æ¬¡ç‰¹æ•ˆ
    if (!EFFECT_USE_OBSERVER || !('IntersectionObserver' in window)) {
        try {
            cb(targetEl);
        } catch (err) {
            console.error('âŒ [registerEffectTrigger] ç›´æ¥æ‰§è¡Œç‰¹æ•ˆå‡ºé”™:', sid, err);
        }
        return;
    }

            initEffectObserver();
    if (!effectObserver) {
        try {
            cb(targetEl);
        } catch (err) {
            console.error('âŒ [registerEffectTrigger] effectObserver ä¸å­˜åœ¨ï¼Œfallback æ‰§è¡Œç‰¹æ•ˆå¤±è´¥:', sid, err);
        }
        return;
    }

    // â­ æ–°å¢ï¼šé¡¶éƒ¨è¡¥è§¦å‘é€»è¾‘ï¼ˆæ—  && ç‰ˆæœ¬ï¼‰
    (function () {
        var rect = targetEl.getBoundingClientRect();
        var viewportHeight = window.innerHeight || document.documentElement.clientHeight || 0;
        var lowerBandTop = viewportHeight * 0.8;   // ä¿æŒ 0.8 ä¸å˜
        var lowerBandBottom = viewportHeight;

        // è®¡ç®—æ˜¯å¦åœ¨è§†å£å†…ï¼ˆä¸ä½¿ç”¨ &&ï¼‰
        var inViewport = false;
        if (rect.bottom > 0) {
            if (rect.top < viewportHeight) {
                inViewport = true;
            }
        }

        var centerY = rect.top + rect.height / 2;

        // å¦‚æœå½“å‰å·²ç»åœ¨è§†å£é‡Œï¼Œä½†ä¸­å¿ƒç‚¹åœ¨ä¸‹æ–¹ 1/5 ä»¥ä¸Šï¼Œç›´æ¥æ’­ä¸€æ¬¡ç‰¹æ•ˆï¼ˆä¸ä½¿ç”¨ &&ï¼‰
        if (inViewport) {
            if (centerY < lowerBandTop) {
                if (EFFECT_DEBUG) {
                    console.log(
                        'âš¡ [registerEffectTrigger] é¡¶éƒ¨è¡¥è§¦å‘ï¼š',
                        sid,
                        ' rect.top =', rect.top.toFixed(1),
                        ' rect.bottom =', rect.bottom.toFixed(1),
                        ' centerY =', centerY.toFixed(1),
                        ' lowerBandTop =', lowerBandTop.toFixed(1),
                        ' lowerBandBottom =', lowerBandBottom.toFixed(1)
                    );
                }
                try {
                    cb(targetEl);
                } catch (err) {
                    console.error('âŒ [registerEffectTrigger] é¡¶éƒ¨è¡¥è§¦å‘å¤±è´¥:', sid, err);
                }
                // ä¸å†äº¤ç»™ Observer
                return;
            }
        }
    })();

    // æ­£å¸¸æƒ…å†µï¼šäº¤ç»™ IntersectionObserverï¼Œç­‰å®ƒæ»šåˆ°å±å¹•ä¸‹æ–¹ 1/5 å†è§¦å‘
    targetEl.__effectTrigger = cb;
    effectObserver.observe(targetEl);
}

      function sanitizeEffectCode(raw) {
  if (raw == null) return '';
  var s = String(raw);

  // ç»Ÿä¸€æ¢è¡Œ
  s = s.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

  // å» BOM / é›¶å®½å­—ç¬¦ / è½¯è¿å­—ç¬¦
  if (s.charCodeAt(0) === 0xFEFF) s = s.slice(1);
  s = s.replace(/[\u200B-\u200D\u2060\u00AD]/g, '');

  // æŸäº›ç¯å¢ƒä¼šæŠŠ U+2028/U+2029 å½“â€œéæ³•æ¢è¡Œâ€
  s = s.replace(/\u2028/g, '\n').replace(/\u2029/g, '\n');

  // æ™ºèƒ½å¼•å· â†’ æ™®é€šå¼•å·ï¼ˆç‰¹åˆ«å¸¸è§ï¼šä»å¯Œæ–‡æœ¬/æ–‡æ¡£é‡Œå¤åˆ¶ä»£ç ï¼‰
  s = s.replace(/[â€œâ€]/g, '"').replace(/[â€˜â€™]/g, "'");

  // å¸¸è§å…¨è§’æ ‡ç‚¹ï¼ˆå¯é€‰ä½†å»ºè®®ï¼‰
  s = s.replace(/ï¼›/g, ';').replace(/ï¼Œ/g, ',').replace(/ï¼ˆ/g, '(').replace(/ï¼‰/g, ')');

  // å¦‚æœæ˜æ˜¾åƒè¢« HTML/å¯Œæ–‡æœ¬åŒ…è¿‡ï¼Œå°è¯•â€œè¿˜åŸæˆçº¯æ–‡æœ¬â€
  var looksHtml = false;
  if (s.indexOf('&lt;') !== -1) looksHtml = true;
  if (s.indexOf('&gt;') !== -1) looksHtml = true;
  if (s.indexOf('&nbsp;') !== -1) looksHtml = true;
  if (s.indexOf('<br') !== -1) looksHtml = true;
  if (s.indexOf('<div') !== -1) looksHtml = true;
  if (looksHtml) {
    var div = document.createElement('div');
    div.innerHTML = s;
    // innerText æ¯” textContent æ›´åƒâ€œå¤åˆ¶å‡ºæ¥çš„ä»£ç â€ï¼Œä¼šä¿ç•™æ¢è¡Œ
    s = div.innerText || div.textContent || s;
  }

  return s;
}

function findFirstSuspiciousChar(raw) {
  if (raw == null) return null;
  var s = String(raw);
  for (var i = 0; i < s.length; i++) {
    var code = s.charCodeAt(i);

    // æ§åˆ¶å­—ç¬¦ï¼šé™¤ tab / \n / \r å¤–éƒ½å¯ç–‘
    if (code < 32) {
      if (code !== 9) {
  if (code !== 10) {
    if (code !== 13) {
      return { index: i, code: code };
    }
  }
}

    }

    // BOM / è¡Œåˆ†éš”ç¬¦ / é›¶å®½
    if (code === 0xFEFF || code === 0x2028 || code === 0x2029) return { index: i, code: code };
    if (code >= 0x200B && code <= 0x200D) return { index: i, code: code };
    if (code === 0x2060 || code === 0x00AD) return { index: i, code: code };
  }
  return null;
}


// åªåœ¨ç¬¬ä¸€æ¬¡éœ€è¦æ—¶ï¼Œä»åç«¯åŠ è½½è‡ªå®šä¹‰ç‰¹æ•ˆåˆ—è¡¨
async function ensureCustomEffectsLoaded() {
    if (customEffectsLoaded) return;

    try {
        const res = await fetch(`${EFFECT_API_BASE_URL}`);
        if (!res.ok) throw new Error('è¯·æ±‚å¤±è´¥');

        const data = await res.json();
        const list = Array.isArray(data) ? data : (data.data || []);

        customEffectFnMap = Object.create(null);

list.forEach(function (item) {
  if (!item) return;

  var key = '';
  if (item.key != null) key = String(item.key).trim();
  if (!key) return;

  var rawCode = '';
  if (item.code != null) rawCode = String(item.code);
  if (!rawCode) return;

  var code = sanitizeEffectCode(rawCode);
  var srcURL = '\n//# sourceURL=anchorx-custom-effect/' + encodeURIComponent(key) + '.js\n';
  var keyLiteral = JSON.stringify(key); // å®‰å…¨åµŒå…¥åˆ°åŠ¨æ€ä»£ç é‡Œ

  // å…ˆ strict æ¨¡å¼å°è¯•ï¼ˆæ›´å®¹æ˜“æš´éœ²é—®é¢˜ï¼‰
  try {
    var bodyStrict =
      '"use strict";\n' +
      code + '\n' +
      'if (typeof applyEffect === "function") { return applyEffect(targetEl); }\n' +
      'throw new Error("Custom effect " + ' + keyLiteral + ' + " must define applyEffect(targetEl)");\n' +
      srcURL;

    customEffectFnMap[key] = new Function('targetEl', bodyStrict);
    return;
  } catch (err1) {
    // fallbackï¼šé strict å†è¯•ä¸€æ¬¡ï¼ˆæœ‰äº›äººä¼šå†™ with / ä¸€äº›ä¸¥æ ¼æ¨¡å¼ä¸å…è®¸çš„ä¸œè¥¿ï¼‰
    try {
      var bodyLoose =
        code + '\n' +
        'if (typeof applyEffect === "function") { return applyEffect(targetEl); }\n' +
        'throw new Error("Custom effect " + ' + keyLiteral + ' + " must define applyEffect(targetEl)");\n' +
        srcURL;

      customEffectFnMap[key] = new Function('targetEl', bodyLoose);
      console.warn('âš ï¸ [effects] ç‰¹æ•ˆåœ¨é strict æ¨¡å¼ä¸‹æ‰ç¼–è¯‘é€šè¿‡:', key);
      return;
    } catch (err2) {
      var bad = findFirstSuspiciousChar(rawCode);
      console.error('ç¼–è¯‘è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥ï¼š', key, err2, {
        badChar: bad,
        preview: rawCode.slice(0, 200)
      });
    }
  }
});


        customEffectsLoaded = true;
    } catch (err) {
        console.error('åŠ è½½è‡ªå®šä¹‰ç‰¹æ•ˆå¤±è´¥:', err);
    }
}
      
    document.addEventListener('DOMContentLoaded', () => {
        // DOM å…ƒç´ 
        const workTitle = document.getElementById('work-title');
        const workAuthor = document.getElementById('work-author');
        const workDate = document.getElementById('work-date');
        const bookContent = document.getElementById('book-content');
        const commentPanel = document.getElementById('comment-panel');
        const closeCommentBtn = document.getElementById('close-comment-panel-btn');
        const commentList = document.getElementById('comment-list');
        const commentTextarea = document.getElementById('comment-textarea');
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        const likeWorkBtn = document.getElementById('like-work-btn');
        const likeCounter = likeWorkBtn.querySelector('.like-counter');
        const likeIcon = likeWorkBtn.querySelector('.like-icon');
        const sidebar = document.getElementById('sidebar');

      const lazyToast = document.getElementById('lazy-load-toast');
const lazyToastText = document.getElementById('lazy-load-toast-text');
const lazyToastNavBtn = document.getElementById('lazy-load-toast-nav-btn');

function showLazyToast(text, { weak=false, showNav=false } = {}) {
  if (!lazyToast) return;
  lazyToastText && (lazyToastText.textContent = text || '');
  lazyToast.classList.toggle('weak', !!weak);
  lazyToast.classList.add('show');

  if (lazyToastNavBtn) {
    lazyToastNavBtn.style.display = showNav ? 'inline-flex' : 'none';
  }
}
function hideLazyToast() {
  if (!lazyToast) return;
  lazyToast.classList.remove('show');
}
if (lazyToastNavBtn) {
  lazyToastNavBtn.addEventListener('click', () => {
    const navBtn = document.getElementById('nav-toggle-btn');
    navBtn && navBtn.click();
  });
}


        // ã€æ–°å¢ã€‘å›åˆ°é¡¶éƒ¨æŒ‰é’®ï¼ˆPC + Mobileï¼‰
        const backToTopBtn = document.getElementById('back-to-top-btn');
        const backToTopMobileBtn = document.getElementById('back-to-top-mobile-btn');

      // ã€æ–°å¢ä»£ç ã€‘ï¼šä¾§è¾¹æ æŠ˜å æŒ‰é’®
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarToggleIcon = document.getElementById('sidebar-toggle-icon');

        const API_WORKS = 'https://api.anchorx.ca/api/works';
        const API_COMMENTS = 'https://api.anchorx.ca/api/comments';

      const bgPeekMobile = document.getElementById('bg-peek-mobile');
const bgPeekMobileBtn = document.getElementById('bg-peek-mobile-btn');


                // å…¨å±€çŠ¶æ€
        let activeWork = null;      // å®Œæ•´ work å¯¹è±¡
        let activePages = [{content: {ops: []}}]; // array of pages
        let currentMode = 'scroll';  // 'scroll' | 'page'
        let currentPageIndex = 0;
        let activeSentenceEl = null; // è¢«ç‚¹å‡»ç”¨äºè¯„è®ºçš„æ®µè½å…ƒç´ 
        let pageQuill = null;        // åœ¨ç¿»é¡µæ¨¡å¼ä¸‹åŠ¨æ€åˆ›å»ºçš„ Quill å®ä¾‹
        let rendererQuill = null;    // éšè—çš„ Quill ç”¨äº Delta -> HTML è½¬æ¢

        // æ¥¼å±‚æ‡’åŠ è½½ç›¸å…³

      // ======================
// âœ… çœŸÂ·æ‡’åŠ è½½ï¼šæŒ‰éœ€æ‹‰ pagesï¼ˆä¾èµ–åç«¯æ–°å¢ /:id/meta ä¸ /:id/pagesï¼‰
// ======================

let totalPageCount = 0;

// è¿ç»­å·²æ‹‰åˆ°çš„ pages æ¸¸æ ‡ï¼šè¡¨ç¤º [0, pagesFetchCursor) çš„ content éƒ½å·²æ‹¿åˆ°
let pagesFetchCursor = 0;
let pagesFetchInFlight = null;
let pagesFetchAbort = null;

function getActiveWorkIdForRead() {
  return (activeWork && (activeWork._id || activeWork.workId)) || null;
}

async function fetchWorkMeta(id) {
  const headers = getAuthHeader();
  const res = await fetch(`${API_WORKS}/${id}/meta`, { headers });
  if (!res.ok) throw new Error(`HTTP ${res.status} - è·å–ä½œå“ meta å¤±è´¥`);
  return res.json();
}

// çº¦å®šåç«¯è¿”å›ï¼š{ pageCount, pages: [ { index, content, sentenceStartIndex? } ... ] }
async function fetchWorkPagesBatch(id, start, limit, weak = false) {
  const headers = getAuthHeader();

  // âœ… æ”¹æˆåç«¯å·²æœ‰çš„ /page-batchï¼Œå¹¶ç”¨ offset
  const qs = new URLSearchParams({
    offset: String(start),
    limit: String(limit),
    weak: weak ? "1" : "0",
  });

  if (pagesFetchAbort) {
    try { pagesFetchAbort.abort(); } catch (_) {}
  }
  pagesFetchAbort = new AbortController();

  const res = await fetch(`${API_WORKS}/${id}/page-batch?${qs.toString()}`, {
    headers,
    signal: pagesFetchAbort.signal
  });
  if (!res.ok) throw new Error(`HTTP ${res.status} - è·å–ä½œå“ pages å¤±è´¥`);
  return res.json();
}

async function ensurePagesFetchedUpTo(targetEnd, weak = false) {
  const workId = getActiveWorkIdForRead();
  if (!workId) return;

  while (pagesFetchCursor < targetEnd) {
    if (pagesFetchInFlight) {
      await pagesFetchInFlight;
      continue;
    }

    const start = pagesFetchCursor;
    const batch = weak ? WEAK_INITIAL_PAGES : FLOOR_BATCH_SIZE;
    const limit = Math.min(batch, targetEnd - start);

    pagesFetchInFlight = (async () => {
      const data = await fetchWorkPagesBatch(workId, start, limit, weak);
      const pages = Array.isArray(data.pages) ? data.pages : [];

      // âœ… å…¼å®¹åç«¯è¿”å› pageCountï¼ˆä»¥åŠä½ æœªæ¥å¯èƒ½æ”¹æˆ totalPagesï¼‰
      const serverTotal =
        (typeof data.totalPages === "number" && data.totalPages > 0) ? data.totalPages :
        (typeof data.pageCount === "number" && data.pageCount > 0) ? data.pageCount :
        0;

      if (serverTotal) {
        totalPageCount = serverTotal;
        if (!Array.isArray(activePages) || activePages.length !== totalPageCount) {
          const old = Array.isArray(activePages) ? activePages : [];
          activePages = new Array(totalPageCount).fill(null);
          for (let i = 0; i < Math.min(old.length, activePages.length); i++) {
            if (old[i]) activePages[i] = old[i];
          }
        }
      }

      for (let i = 0; i < pages.length; i++) {
        const p = pages[i] || {};
        const idx = (typeof p.index === "number") ? p.index : (start + i);

        if (!activePages[idx]) activePages[idx] = {};
        activePages[idx].content = p.content || { ops: [] };

        if (typeof p.sentenceStartIndex === "number") {
          activePages[idx].sentenceStartIndex = p.sentenceStartIndex;
        }
      }

      pagesFetchCursor = start + pages.length;
    })().finally(() => {
      pagesFetchInFlight = null;
    });

    await pagesFetchInFlight;
  }
}

        const FLOOR_BATCH_SIZE = 5;          // ä¸€æ¬¡æ¸²æŸ“ 5 æ¥¼
        let renderedFloorCount = 0;          // å½“å‰å·²ç»æ¸²æŸ“åˆ°ç¬¬å‡ æ¥¼ï¼ˆæ•°é‡ï¼‰
        let floorLazyScrollHandler = null;   // æ¥¼å±‚æ¨¡å¼æ»šåŠ¨ç›‘å¬å™¨

      // ===== æ‡’æ‡’åŠ è½½ï¼ˆåŠ å¼ºç‰ˆæ‡’åŠ è½½ï¼›å†…å®¹å‡†å¤‡ä¹Ÿåˆ†æ‰¹ï¼‰ =====
const LAZY_SLOW_THRESHOLD_MS = 60 * 1000;
const WEAK_INITIAL_PAGES = 2;

let isWeakLazyMode = false;
let lazySlowTimer = null;
let isLoadingMoreFloors = false;

// é¡ºåºâ€œå†…å®¹å‡†å¤‡â€æ¸¸æ ‡ï¼šä¿è¯ sentenceStartIndex / segmentedHtml å…¨å±€ç¼–å·ä¸€è‡´
let pagePrepareCursor = 0;
let pageSentenceCounter = 0;
let pagePrepareToken = 0;
let pagePrepareRunning = false;

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }


        let contentIndexCounter = 0; // å…¨å±€è®¡æ•°å™¨ï¼Œç”¨äºç”Ÿæˆå”¯ä¸€ID

       // ========== æ–°å¢ï¼šè®°å½•é˜…è¯»ä½ç½®ï¼ˆæ¥¼å±‚/é¡µç ï¼‰ ==========
        let lastSavedView = null;     // { mode: 'scroll' | 'page', pageIndex: number, ts: number }
        let hasAppliedLastView = false;

              // ===== èƒŒæ™¯å›¾ç›¸å…³ DOM =====
        const bgWrapper = document.getElementById('read-bg-wrapper');
        const bgLayerA = document.getElementById('read-bg-layer-a');
        const bgLayerB = document.getElementById('read-bg-layer-b');

        // ===== èƒŒæ™¯ç³»ç»ŸçŠ¶æ€ =====
        let bgConfig = { images: [], bindings: [], transitions: [] };
        let bgSegments = [];          // æ¯ä¸€æ®µèƒŒæ™¯åŒºé—´ï¼š{ imageId, imageUrl, startLine, endLine, startEl, endEl, startTop, endBottom }
        let currentBgSegment = null;  // å½“å‰æ­£åœ¨ç”Ÿæ•ˆçš„åŒºé—´
        let currentBgImageId = null;  // å½“å‰èƒŒæ™¯å›¾ç‰‡å¯¹åº”çš„ imageId
        let currentBgLayerFlag = 'A'; // ç”¨ A/B ä¸¤å±‚äº¤æ›¿åšæ·¡å…¥æ·¡å‡º
        let bgScrollTicking = false;

      // ===== èƒŒæ™¯å¿ƒè·³ï¼ˆè‡ªåŠ¨çº åï¼‰ =====
let bgHeartbeatTimer = null;
let bgHeartbeatFastUntil = 0;
let bgHeartbeatLastScrollY = -1;
let bgHeartbeatLastDocH = -1;
let bgHeartbeatMismatchStreak = 0;


        function getLastViewStorageKey() {
            if (!activeWork) return null;
            const workId = activeWork._id || activeWork.workId || getWorkIdFromUrl();
            if (!workId) return null;
            return `anchorx_read_last_view_${workId}`;
        }

        function loadLastViewFromStorage() {
            const key = getLastViewStorageKey();
            if (!key) return null;
            try {
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                return JSON.parse(raw);
            } catch (e) {
                console.warn('è§£æé˜…è¯»ä½ç½®å¤±è´¥:', e);
                return null;
            }
        }

        function saveLastViewToStorage(mode, pageIndex) {
            const key = getLastViewStorageKey();
            if (!key) return;
            const total = Array.isArray(activePages) ? activePages.length : 0;
            if (total <= 0) return;

            const idx = Math.min(Math.max(pageIndex || 0, 0), total - 1);

            // å¦‚æœæ²¡æœ‰å˜åŒ–å°±ä¸å†™ localStorageï¼Œå‡å°‘é¢‘ç‡
            if (lastSavedView) {
    if (lastSavedView.mode === mode) {
        if (lastSavedView.pageIndex === idx) {
            return;
        }
    }
}


            const payload = {
                mode,
                pageIndex: idx,
                ts: Date.now()
            };
            lastSavedView = payload;

            try {
                localStorage.setItem(key, JSON.stringify(payload));
            } catch (e) {
                console.warn('ä¿å­˜é˜…è¯»ä½ç½®å¤±è´¥:', e);
            }
        }


      // ã€æ–°å¢æ ¸å¿ƒçŠ¶æ€ã€‘
let allComments = [];                 // å­˜å‚¨ä½œå“æ‰€æœ‰è¯„è®º (ç”¨äºè¿‡æ»¤)
let commentedSentenceIds = new Set(); // å­˜å‚¨æ‰€æœ‰æœ‰è¯„è®ºçš„ sentenceId (ç”¨äºæ ‡è®°)
let currentViewingSentenceId = null;  // å½“å‰è¯„è®ºåŒºæ˜¾ç¤ºçš„ç‰¹å®šå¥å­ ID
let currentViewingPageSentenceIds = null; // å½“å‰è¯„è®ºåŒºæ˜¾ç¤ºçš„é¡µé¢å¥å­ ID åˆ—è¡¨

      let hasLoadedAllComments = false;
let commentedIdsReadyPromise = null;
let commentedIdsReady = false;

      // ===== è¯„è®ºæ‰¹é‡ç¼“å­˜ï¼ˆè·Ÿéšæ¥¼å±‚æ³¨å…¥æ‰¹é‡åŠ è½½ï¼‰=====
let commentLoadedWorkId = null;
let loadedCommentSentenceIds = new Set();
let commentBySentenceId = new Map();
let commentCountByPage = new Map();

function resetCommentCacheForWork(workId) {
  commentLoadedWorkId = workId;
  loadedCommentSentenceIds = new Set();
  commentBySentenceId = new Map();
  commentCountByPage = new Map();
}

function getActiveWorkIdForComments() {
  if (!activeWork) return null;
  if (activeWork._id) return activeWork._id;
  if (activeWork.workId) return activeWork.workId;
  return null;
}

async function ensureCommentedIdsReadyNow() {
  if (commentedIdsReady) return;
  if (commentedIdsReadyPromise) {
    await commentedIdsReadyPromise;
    return;
  }
}

async function fetchCommentsBySentenceIds(workId, sentenceIds) {
  const headers = getAuthHeader();
  headers['Content-Type'] = 'application/json';

  const res = await fetch(`${API_COMMENTS}/work/by-sentence-ids/${workId}`, {
    method: 'POST',
    headers,
    body: JSON.stringify({ sentenceIds })
  });

  if (!res.ok) {
    let msg = 'æ‰¹é‡è·å–è¯„è®ºå¤±è´¥';
    try {
      const j = await res.json();
      if (j) {
        if (j.message) msg = j.message;
      }
    } catch (e) {}
    throw new Error(msg);
  }

  const data = await res.json();
  return Array.isArray(data) ? data : [];
}

function buildSentenceId(workId, idx) {
  return 's_' + workId + '_' + String(idx);
}

function updateFloorCommentButton(pageIndex) {
  const btn = document.querySelector(`.floor[data-page-index="${pageIndex}"] .comment-view-btn`);
  if (!btn) return;
  const countText = getCommentsCountForPage(pageIndex);
  btn.textContent = `æŸ¥çœ‹æœ¬æ¥¼è¯„è®ºï¼ˆ${countText}ï¼‰`;
}

function updateFloorCommentButtonsRange(startPage, endPage) {
  for (let i = startPage; i < endPage; i++) {
    updateFloorCommentButton(i);
  }
}

function computePageHasAnyComment(pageIndex, workId) {
  if (!commentedIdsReady) return null;

  const page = activePages[pageIndex];
  if (!page) return null;

  const start = page.sentenceStartIndex;
  const count = page.__sentenceIdsCount;

  if (typeof start !== 'number') return null;
  if (typeof count !== 'number') return null;

  for (let k = 0; k < count; k++) {
    const sid = buildSentenceId(workId, start + k);
    if (commentedSentenceIds.has(sid)) return true;
  }
  return false;
}

function recomputeCommentCountForPage(pageIndex, workId) {
  const page = activePages[pageIndex];
  if (!page) return;

  const start = page.sentenceStartIndex;
  const count = page.__sentenceIdsCount;

  if (typeof start !== 'number') return;
  if (typeof count !== 'number') return;

  let total = 0;
  let needEllipsis = false;
  let anyCommented = false;

  for (let k = 0; k < count; k++) {
    const sid = buildSentenceId(workId, start + k);
    if (commentedSentenceIds.has(sid)) {
      anyCommented = true;

      if (loadedCommentSentenceIds.has(sid)) {
        const arr = commentBySentenceId.get(sid);
        if (Array.isArray(arr)) total += arr.length;
      } else {
        needEllipsis = true;
      }
    }
  }

  if (!anyCommented) {
    commentCountByPage.set(pageIndex, 0);
    return;
  }

  if (needEllipsis) {
    commentCountByPage.delete(pageIndex);
    return;
  }

  commentCountByPage.set(pageIndex, total);
}

function chunkArray(arr, size) {
  const out = [];
  let i = 0;
  while (i < arr.length) {
    out.push(arr.slice(i, i + size));
    i += size;
  }
  return out;
}

async function ensureCommentsLoadedForPagesRange(startPage, endPage) {
  const workId = getActiveWorkIdForComments();
  if (!workId) return;

  if (commentLoadedWorkId !== workId) {
    resetCommentCacheForWork(workId);
  }

  await ensureCommentedIdsReadyNow();

  if (!Array.isArray(activePages)) return;

  const idsToFetch = [];
  const pagesTouched = new Set();

  for (let p = startPage; p < endPage; p++) {
    pagesTouched.add(p);

    const page = activePages[p];
    if (!page) continue;

    const start = page.sentenceStartIndex;
    const count = page.__sentenceIdsCount;

    if (typeof start !== 'number') continue;
    if (typeof count !== 'number') continue;

    for (let k = 0; k < count; k++) {
      const sid = buildSentenceId(workId, start + k);

      if (commentedSentenceIds.has(sid)) {
        if (!loadedCommentSentenceIds.has(sid)) {
          idsToFetch.push(sid);
        }
      }
    }
  }

  const chunks = chunkArray(idsToFetch, 200);

  for (let c = 0; c < chunks.length; c++) {
    const part = chunks[c];
    if (part.length === 0) continue;

    const rows = await fetchCommentsBySentenceIds(workId, part);

    const grouped = new Map();
    for (let i = 0; i < rows.length; i++) {
      const item = rows[i];
      const sid = item ? item.sentenceId : null;
      if (!sid) continue;

      if (!grouped.has(sid)) grouped.set(sid, []);
      grouped.get(sid).push(item);
    }

    grouped.forEach((arr, sid) => {
      commentBySentenceId.set(sid, arr);
      loadedCommentSentenceIds.add(sid);
    });

    for (let i = 0; i < part.length; i++) {
      const sid = part[i];
      loadedCommentSentenceIds.add(sid);
      if (!commentBySentenceId.has(sid)) commentBySentenceId.set(sid, []);
    }
  }

  pagesTouched.forEach(p => {
    recomputeCommentCountForPage(p, workId);
  });

  updateFloorCommentButtonsRange(startPage, endPage);
}

async function ensureCommentsLoadedForSentenceId(sentenceId) {
  const workId = getActiveWorkIdForComments();
  if (!workId) return;

  if (commentLoadedWorkId !== workId) {
    resetCommentCacheForWork(workId);
  }

  await ensureCommentedIdsReadyNow();

  if (loadedCommentSentenceIds.has(sentenceId)) return;

  const rows = await fetchCommentsBySentenceIds(workId, [sentenceId]);

  const arr = [];
  for (let i = 0; i < rows.length; i++) {
    const it = rows[i];
    if (!it) continue;
    if (it.sentenceId === sentenceId) arr.push(it);
  }

  commentBySentenceId.set(sentenceId, arr);
  loadedCommentSentenceIds.add(sentenceId);

  const el = document.querySelector(`[data-sentence-id="${sentenceId}"]`);
  if (el) {
    const floor = el.closest('.floor');
    if (floor) {
      const s = floor.getAttribute('data-page-index');
      const p = parseInt(s || '-1', 10);
      if (!Number.isNaN(p)) {
        recomputeCommentCountForPage(p, workId);
        updateFloorCommentButton(p);
      }
    }
  }
}

function triggerCommentsRenderForFloors(startPage, endPage) {
  ensureCommentsLoadedForPagesRange(startPage, endPage)
    .catch(err => console.error('è¯„è®ºæ‰¹é‡åŠ è½½å¤±è´¥:', err));
}


async function fetchCommentedSentenceIds(workId) {
  try {
    const headers = getAuthHeader();
    const res = await fetch(`${API_COMMENTS}/work/commented-sentences/${workId}`, { headers });
    if (!res.ok) throw new Error('è·å– commentedSentenceIds å¤±è´¥');
    const ids = await res.json();
    commentedSentenceIds = new Set(Array.isArray(ids) ? ids : []);
  } catch (e) {
    console.error('åŠ è½½ commentedSentenceIds å¤±è´¥:', e);
    commentedSentenceIds = new Set();
  } finally {
    commentedIdsReady = true;
  }
}

function refreshRenderedFloorCommentCounts() {
  document.querySelectorAll('.floor').forEach(floor => {
    const idx = parseInt(floor.dataset.pageIndex || '-1', 10);
    if (Number.isNaN(idx) || idx < 0) return;
    const btn = floor.querySelector('.comment-view-btn');
    if (!btn) return;
    const countText = getCommentsCountForPage(idx);
    btn.textContent = `æŸ¥çœ‹æœ¬æ¥¼è¯„è®ºï¼ˆ${countText}ï¼‰`;
  });
}

function refreshRenderedCommentMarkers() {
  document.querySelectorAll('.floor-body[data-hydrated="1"]').forEach(body => {
    processContentForSentenceIds(body); // ä¸‹æ–‡æˆ‘ä¼šæŠŠå®ƒæ”¹æˆâ€œå¹‚ç­‰â€ï¼Œå¯é‡å¤è°ƒç”¨
  });
}


        // å±€éƒ¨ä¿®æ”¹: å…³é—­è¯„è®ºåŒºæ—¶ï¼ŒåŒæ—¶å–æ¶ˆâ€œæŸ¥çœ‹æ¨¡å¼â€
closeCommentBtn.addEventListener('click', () => {
    commentPanel.classList.remove('show');
    disableCommentInputArea(false); // <--- æ–°å¢: æ¢å¤è¯„è®ºåŠŸèƒ½
    commentPanel.querySelector('h4').textContent = `è¯„è®º`; // <--- æ¢å¤æ ‡é¢˜
});

// åªåœ¨â€œé˜…è¯»ç«¯çœŸæ­£æ˜¾ç¤ºå‡ºæ¥çš„ DOM å®¹å™¨â€ä¸Šåº”ç”¨ç‰¹æ•ˆ
// ========== åº”ç”¨ç‰¹æ•ˆï¼ˆå†…ç½® + è‡ªå®šä¹‰ï¼‰ã€è°ƒè¯•ç‰ˆã€‘ ==========
// ========== æŒ‰ data-sentence-id + workId åº”ç”¨ç‰¹æ•ˆï¼ˆå¸¦è°ƒè¯•æ—¥å¿—ï¼‰ ==========
function applyEffectsToBlocks(rootEl, effectsPublished, workId) {
    // åŸºç¡€é˜²å¾¡
    if (!rootEl) {
        console.warn('âš  [effects] applyEffectsToBlocks: rootEl ä¸ºç©ºï¼Œç›´æ¥è¿”å›');
        return;
    }
    if (!Array.isArray(effectsPublished) || !effectsPublished.length) {
        console.log('â„¹ [effects] å½“å‰ä½œå“æ²¡æœ‰ä»»ä½•ç‰¹æ•ˆï¼Œè·³è¿‡');
        return;
    }
    if (!workId) {
        console.warn('âš  [effects] ç¼ºå°‘ workIdï¼Œæ— æ³•æ„é€ å¥å­ ID');
        return;
    }

    // æ‰¾å‡ºå½“å‰ container é‡Œæ‰€æœ‰å¸¦ data-sentence-id çš„å¥å­
    const sentenceEls = rootEl.querySelectorAll('[data-sentence-id]');
    if (!sentenceEls.length) {
        console.log('â„¹ [effects] root å†…æ²¡æœ‰ä»»ä½• data-sentence-id èŠ‚ç‚¹ï¼Œæš‚ä¸åº”ç”¨ç‰¹æ•ˆ');
        return;
    }

    console.log('ğŸ§ª [effects] applyEffectsToBlocks è¢«è°ƒç”¨ï¼š', {
        workId,
        effectCount: effectsPublished.length,
        sentenceCount: sentenceEls.length,
        sampleIds: Array.from(sentenceEls)
            .slice(0, 10)
            .map(el => el.getAttribute('data-sentence-id'))
    });

    // é¿å…é‡å¤åŒ…è£¹ / é‡å¤æ·»åŠ  class
    const appliedSet = new Set();

    effectsPublished.forEach(effect => {
        if (!effect) return;

        const rawIndex = effect.lineIndex;
        const type = effect.effectType;

        // è¡Œå·å®¹é”™å¤„ç†
        let lineIndex = typeof rawIndex === 'number'
            ? rawIndex
            : parseInt(rawIndex, 10);

        if (Number.isNaN(lineIndex) || lineIndex < 0) {
            console.warn('âš  [effects] éæ³• lineIndexï¼š', rawIndex, effect);
            return;
        }
        if (!type) return;

        // ç»Ÿä¸€å’Œ segmentContentAndAddIds ç”Ÿæˆè§„åˆ™ï¼š
        // data-sentence-id="s_<workId>_<è¡Œå·>"
        const sentenceId = `s_${workId}_${lineIndex}`;
        const selector = `[data-sentence-id="${sentenceId}"]`;
        const target = rootEl.querySelector(selector);

        console.log('ğŸ¯ [effects] å¤„ç†ç‰¹æ•ˆ:', {
            lineIndex,
            sentenceId,
            type,
            found: !!target
        });

        if (!target) return;

        // é˜²æ­¢å¯¹åŒä¸€å¥å¤šæ¬¡é‡å¤åº”ç”¨
        const key = sentenceId + '::' + type;
        if (appliedSet.has(key)) return;
        appliedSet.add(key);

        // è°ƒè¯•å¯è§†åŒ–ï¼šç”»ä¸€ä¸ªæ·¡æ·¡çš„è½®å»“ï¼Œæ–¹ä¾¿ä½ è‚‰çœ¼çœ‹åˆ°â€œå“ªä¸€è¡Œè¢«åŒ¹é…åˆ°äº†â€
        target.style.outline = '1px dashed rgba(255,0,0,0.25)';

        // --- å®é™…ç‰¹æ•ˆå¤„ç† ---
        // è‡ªå®šä¹‰ç‰¹æ•ˆï¼šeffectType å½¢å¦‚ "custom:xxx"
        // è‡ªå®šä¹‰ç‰¹æ•ˆï¼šeffectType å½¢å¦‚ "custom:xxx"
if (typeof type === 'string' && type.startsWith('custom:')) {
    const customKey = type.slice('custom:'.length) || '';

    // è°ƒè¯•ç”¨ï¼šå…ˆåŠ ä¸€ä¸ªå ä½ classï¼Œæ–¹ä¾¿è‚‰çœ¼ç¡®è®¤å‘½ä¸­
    target.classList.add('effect-custom-placeholder');

    console.log('ğŸ§ª [effects] å‘½ä¸­è‡ªå®šä¹‰ç‰¹æ•ˆå ä½:', {
        customKey,
        sentenceId
    });

    // â­ å…³é”®ï¼šä»æ˜ å°„é‡Œå–å‡ºå¯¹åº”çš„æ‰§è¡Œå‡½æ•°
    const runner = customEffectFnMap && customEffectFnMap[customKey];

    if (!runner) {
        console.warn('âš  [effects] æœªæ‰¾åˆ°è‡ªå®šä¹‰ç‰¹æ•ˆå‡½æ•°:', customKey);
        return;
    }

    // ç”¨ç»Ÿä¸€çš„è§¦å‘å™¨åŒ…è£…ä¸€ä¸‹ï¼Œä¾¿äºä»¥ååˆ‡å› IntersectionObserver æ‡’åŠ è½½
    registerEffectTrigger(target, (el) => {
        try {
            // è¿™é‡ŒçœŸæ­£æ‰§è¡Œä½ å†™åœ¨åç«¯çš„ä»£ç ï¼š
            // new Function('targetEl', `"use strict"; ${item.code} ...`)(el)
            runner(el);
        } catch (err) {
            console.error('âŒ [effects] è‡ªå®šä¹‰ç‰¹æ•ˆæ‰§è¡Œå¤±è´¥:', customKey, err);
        }
    });

    return;
}

        // å†…ç½® shakeï¼šåŒ…ä¸€å±‚ spanï¼Œè®©æ•´å¥æŠ–åŠ¨
        if (type === 'shake') {
            if (!target.querySelector('.effect-shake')) {
                const span = document.createElement('span');
                span.className = 'effect-shake';
                while (target.firstChild) {
                    span.appendChild(target.firstChild);
                }
                target.appendChild(span);
            }
            return;
        }

        // å…¶å®ƒå†…ç½®ç‰¹æ•ˆï¼šç›´æ¥åŠ  class
        if (type === 'flash') {
            target.classList.add('effect-flash');
            return;
        }
        if (type === 'fade') {
            target.classList.add('effect-fade');
            return;
        }
        if (type === 'highlight') {
            target.classList.add('effect-highlight');
            return;
        }
        if (type === 'glow') {
            target.classList.add('effect-glow');
            return;
        }

        // æœªè¯†åˆ«çš„ç±»å‹ï¼Œä»…åš log
        console.log('â„¹ [effects] æœªè¯†åˆ«çš„ effectTypeï¼š', type, 'ï¼Œå·²è·³è¿‡');
    });
}


        // å¦‚æœéœ€è¦ tokenï¼ˆå‘è¡¨è¯„è®º/ç‚¹èµï¼‰
        function getAuthHeader() {
            const token = localStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        /* ---------- åˆå§‹åŒ–éšè—çš„ renderer Quillï¼ˆç”¨äºæŠŠ Delta è½¬ä¸º HTMLï¼‰ ---------- */
        (function initRendererQuill() {
            const r = document.createElement('div');
            r.style.position = 'absolute';
            r.style.left = '-9999px';
            r.style.top = '-9999px';
            r.style.width = '10px';
            r.style.height = '10px';
            document.body.appendChild(r);
            // readOnly ä¸å½±å“ setContents çš„è¾“å‡º
            rendererQuill = new Quill(r, { theme: 'snow', modules: { toolbar: false }, readOnly: true });
        })();

// Delta -> HTMLï¼ˆå®‰å…¨é™çº§ï¼šå¦‚æœä¼ å…¥çš„æ˜¯å­—ç¬¦ä¸²å°±ç›´æ¥è¿”å›å­—ç¬¦ä¸²ï¼‰
function deltaToHtml(deltaOrHtml) {
    try {
        if (!deltaOrHtml) return '<p>ï¼ˆç©ºç™½ï¼‰</p>';
if (typeof deltaOrHtml === 'string') {
    // æ£€æµ‹å­—ç¬¦ä¸²æ˜¯å¦æ˜¯ JSON æ ¼å¼çš„ Delta
    try {
        const maybeDelta = JSON.parse(deltaOrHtml);
        if (maybeDelta) {
    if (maybeDelta.ops) {
        rendererQuill.setContents(maybeDelta);
        return rendererQuill.root.innerHTML;
    }
}

    } catch {}
    // å¦åˆ™ç›´æ¥å½“ HTML ä½¿ç”¨ï¼Œä¸åš escape
    return deltaOrHtml;
}
        
        rendererQuill.setContents(deltaOrHtml);
        const contentHtml = rendererQuill.root.innerHTML;

        // ğŸ’¥ å…³é”®ä¿®æ”¹ï¼šæ£€æµ‹æ˜¯å¦å·²æœ‰ .ql-editor å®¹å™¨ï¼Œé˜²æ­¢åµŒå¥—
// âœ… ä¿®æ”¹åï¼šä¸å†åŒ…è£¹ .ql-editorï¼Œä»¥å…åµŒå¥—
if (/<div class="ql-editor">/i.test(contentHtml)) {
    return contentHtml; 
}

// ç›´æ¥è¿”å›ç”Ÿæˆçš„ HTMLï¼Œä¸å†æ·»åŠ  .ql-editor å®¹å™¨
return contentHtml;
        
    } catch (e) {
        console.warn('deltaToHtml fallback', e);
        return '<p>ï¼ˆæ— æ³•æ˜¾ç¤ºæ­¤å†…å®¹ï¼‰</p>';
    }
}

/* ========== å…¨å±€åŠ è½½è¿›åº¦æ¡æ§åˆ¶å‡½æ•° ========== */
function startGlobalLoading() {
  const bar = document.getElementById('global-loading-bar');
  if (!bar) return;
  bar.style.width = '0%';
  bar.style.transition = 'none';
  requestAnimationFrame(() => {
    bar.style.transition = 'width 0.3s ease';
    bar.style.width = '10%';
  });
}

function updateGlobalLoadingProgress(percent, message) {
  const bar = document.getElementById('global-loading-bar');
  if (!bar) return;
  bar.style.width = `${percent}%`;
  if (message) console.log(`ğŸ“˜ ${message}`);
}

function endGlobalLoading() {
  const bar = document.getElementById('global-loading-bar');
  if (!bar) return;
  bar.style.width = '100%';
  setTimeout(() => {
    bar.style.width = '0%';
  }, 500);
}

async function loadWorkContentById(id) {
  if (!id) return displayError('ä½œå“IDæ— æ•ˆï¼Œè¯·è¿”å›ä¸»é¡µã€‚');

  startGlobalLoading();

  try {
    updateGlobalLoadingProgress(15, 'æ­£åœ¨è·å–ä½œå“ä¿¡æ¯â€¦');

    // âœ… 1) ä¼˜å…ˆèµ° metaï¼ˆå°åŒ…ï¼‰
    let meta = null;
    try {
      meta = await fetchWorkMeta(id);
    } catch (e) {
      // å…œåº•ï¼šå¦‚æœä½ åç«¯è¿˜æ²¡ä¸Š meta/pagesï¼Œå°±é€€å›æ—§æ¥å£ï¼ˆä½†å°±ä¸æ˜¯çœŸæ‡’åŠ è½½äº†ï¼‰
      console.warn('meta æ¥å£ä¸å¯ç”¨ï¼Œå›é€€åˆ°æ•´æœ¬åŠ è½½ï¼š', e);
      const headers = getAuthHeader();
      const res = await fetch(`${API_WORKS}/${id}`, { headers });
      if (!res.ok) throw new Error(`HTTP ${res.status} - è·å–ä½œå“å¤±è´¥`);
      meta = await res.json();
      meta.__fallbackFull = true;
    }

    activeWork = meta;

    // âœ… 2) ç‰¹æ•ˆï¼ˆä»ç„¶åªåŠ è½½ä¸€æ¬¡ï¼‰
    const effectsPublished = meta.effectsPublished || [];
    await ensureCustomEffectsLoaded();
    activeWork.effectsPublished = effectsPublished;

    // âœ… 3) pagesï¼šçœŸæ‡’åŠ è½½æ¨¡å¼ä¸‹åªå»ºâ€œç©ºå£³æ•°ç»„â€ï¼Œä¸å¡« content
    if (meta.__fallbackFull) {
      // æ—§æ¨¡å¼ï¼šä½ åŸæ¥é‚£å¥—
      updateGlobalLoadingProgress(45, 'æ­£åœ¨åŠ è½½è¯„è®ºâ€¦');
      commentedIdsReady = false;
commentedIdsReadyPromise = fetchCommentedSentenceIds(meta.workId || id);
      updateGlobalLoadingProgress(70, 'æ­£åœ¨æ¸²æŸ“ä½œå“å†…å®¹â€¦');

      if (Array.isArray(meta.pages) && meta.pages.length > 0) activePages = meta.pages;
      else if (Array.isArray(meta.content) && meta.content.length > 0) activePages = meta.content;
      else activePages = [{ content: { ops: [] } }];

      totalPageCount = activePages.length;
      pagesFetchCursor = totalPageCount; // å·²ç»å…¨é‡
    } else {
      // âœ… çœŸæ‡’åŠ è½½ï¼šåªçŸ¥é“æ€»é¡µæ•°ï¼Œä¸ä¸€æ¬¡æ€§æ‹¿ content
      totalPageCount = meta.totalPages || meta.pageCount || meta.pagesCount || 0;
      if (!totalPageCount) totalPageCount = 1;

      activePages = new Array(totalPageCount).fill(null);
      pagesFetchCursor = 0;

      // âœ… è¯„è®ºï¼šåˆ«ä¸€è¿›æ¥å°±æ‹‰å…¨é‡ï¼ˆä½ åŸæ¥è¿™é‡Œä¼š await fetchAllWorkCommentsï¼‰ :contentReference[oaicite:2]{index=2}
      // å»ºè®®ï¼šå…ˆä¸æ‹‰ï¼Œæˆ–ä»…æ‹‰è½»é‡â€œå·²è¯„è®º sentenceId åˆ—è¡¨â€ï¼ˆåç«¯å·²æœ‰ /work/commented-sentences/:workId æ›´åˆé€‚ï¼‰
      // â€”â€”è¿™é‡Œå…ˆä¿æŒä¸æ‹‰å…¨é‡ï¼Œé¿å…å¼±ç½‘å¡æ­»
      allComments = [];
      commentedSentenceIds = new Set();

      const workIdForComments = meta.workId || id;
commentedIdsReadyPromise = fetchCommentedSentenceIds(workIdForComments).then(() => {
  // ç­‰å¥å­IDåˆ°ä½åï¼Œç»™å·²æ¸²æŸ“çš„æ¥¼å±‚è¡¥ä¸Šâ€œè¯„è®ºç¬¦å·â€
  refreshRenderedCommentMarkers();
  refreshRenderedFloorCommentCounts();
});

    }

    // é¡µé¢ä¿¡æ¯
    document.title = (activeWork.title || 'ä½œå“') + ' - ä½œå“è¯¦æƒ…';
    workTitle.textContent = activeWork.title || 'æœªå‘½å';
    workAuthor.textContent = activeWork.author ? (activeWork.author.username || 'ä½œè€…') : 'æœªçŸ¥';
    workDate.textContent = activeWork.updatedAt
      ? `æ›´æ–°æ—¶é—´ï¼š${new Date(activeWork.updatedAt).toLocaleString()}`
      : `æ›´æ–°æ—¶é—´ï¼šæœªçŸ¥`;

    // âœ… å…³é”®ï¼šé‡ç½®æ‡’åŠ è½½çŠ¶æ€ï¼ˆä½ æœ¬æ¥å°±æœ‰è¿™å¥ï¼‰
    resetLazyPrepareState();

    updateGlobalLoadingProgress(80, 'æ­£åœ¨æ¸²æŸ“â€¦');
    renderCurrentMode();

    updateGlobalLoadingProgress(100, 'åŠ è½½å®Œæˆï¼');
  } catch (err) {
    console.error(err);
    displayError('åŠ è½½ä½œå“å¤±è´¥ï¼š' + (err.message || err));
  } finally {
    endGlobalLoading();
  }
}

function resetLazyPrepareState() {
  pagePrepareCursor = 0;
  pageSentenceCounter = 0;
  pagePrepareToken++;

  // âœ… çœŸæ‡’åŠ è½½ï¼šfetch æ¸¸æ ‡ä¹Ÿé‡ç½®
  pagesFetchCursor = 0;
  pagesFetchInFlight = null;
  if (pagesFetchAbort) {
    try { pagesFetchAbort.abort(); } catch (_) {}
  }
  pagesFetchAbort = null;

  if (!Array.isArray(activePages)) return;
  activePages.forEach((p) => {
    if (!p) return; // âœ… å…³é”®ï¼šå…è®¸ null å ä½
    // åªæ¸…ç†å‡†å¤‡æ€ç¼“å­˜
    delete p.segmentedHtml;
    delete p.__sentenceIdsCount;
    // sentenceStartIndex ä½ å¯ä»¥ä¿ç•™ï¼ˆå¦‚æœåç«¯ç»™äº†å°±åˆ«åˆ ï¼‰
  });
}


// â­ å·¥å…·å‡½æ•°ï¼šä¸ºå†…å®¹æŒ‰â€œæœ‰æ•ˆå¥å­â€ç¼–å·å¹¶å†™å…¥ data-sentence-id / data-sentence-index
function segmentContentAndAddIds(rawHtmlContent, workId, startIndex = 0) {
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = rawHtmlContent;
  let counter = startIndex;

  // å’Œ applyEffectsToBlocks ç”¨åŒä¸€å¥—â€œè¡Œâ€çš„å®šä¹‰
  const blocks = tempDiv.querySelectorAll('p, h1, h2, h3, li, blockquote, pre');

  blocks.forEach(function (el) {
    const text = el.textContent.trim();

    // è·³è¿‡çº¯ç©ºç™½
    if (text === '') {
      return;
    }

    // ç”Ÿæˆ / ä¿ç•™ data-sentence-id
    if (!el.hasAttribute('data-sentence-id')) {
      const sentenceId = 's_' + workId + '_' + counter;
      el.setAttribute('data-sentence-id', sentenceId);
    }
    // åŒæ­¥åˆ° datasetï¼Œæ–¹ä¾¿åé¢ä½¿ç”¨
    el.dataset.sentenceId = el.getAttribute('data-sentence-id');

    // â­ æ–°å¢ï¼šè®°å½•â€œé˜…è¯»ç«¯å¥å­ç¼–å·â€ï¼Œç»™èƒŒæ™¯ç”¨
    el.dataset.sentenceIndex = String(counter);

    counter = counter + 1;
  });

  // â­ è°ƒè¯•ï¼šæ‰“å°å‰ 30 æ¡å¥å­çš„ è¡Œå· + ID + æ–‡æœ¬ç‰‡æ®µ
  if (window.READER_DEBUG_VERBOSE) {
    const sample = Array.from(tempDiv.querySelectorAll('[data-sentence-id]'))
      .slice(0, 30)
      .map(function (el) {
        return {
          index: el.dataset.sentenceIndex,
          id: el.dataset.sentenceId,
          text: el.textContent.trim().slice(0, 20)
        };
      });

    console.log('ğŸ§© segmentContentAndAddIds ç¤ºä¾‹ï¼ˆå‰ 30 æ¡ï¼‰:', sample);
  }

  return { element: tempDiv, nextIndex: counter };
}

async function ensurePagesPreparedUpTo(targetCount, { userInitiated = false } = {}) {
  if (!activeWork || !activeWork._id) return;
  if (!Array.isArray(activePages) || activePages.length === 0) return;

  const hardTarget = Math.min(targetCount, activePages.length);
  const myToken = pagePrepareToken;

  // ç­‰å¾…åˆ«çš„ prepare ç»“æŸ
  while (pagePrepareRunning && myToken === pagePrepareToken) {
    await sleep(40);
  }
  if (myToken !== pagePrepareToken) return;
  if (pagePrepareCursor >= hardTarget) return;

  pagePrepareRunning = true;
  const loopStart = Date.now();

  try {
    while (pagePrepareCursor < hardTarget) {
      if (myToken !== pagePrepareToken) return;

      // å¼±ç½‘æ¨¡å¼ï¼šå¦‚æœä¸æ˜¯ç”¨æˆ·è§¦å‘çš„åŠ è½½ï¼Œåªå‡†å¤‡å‰ä¸¤é¡µå°±åœ
      if (isWeakLazyMode) {
  if (!userInitiated) {
    if (pagePrepareCursor >= WEAK_INITIAL_PAGES) {
      return;
    }
  }
}


      // âœ… çœŸæ‡’åŠ è½½å…³é”®ï¼šå¦‚æœè¿™ä¸€é¡µè¿˜æ²¡æ‹¿åˆ° contentï¼ˆå¯èƒ½æ˜¯ null å ä½ / ç©ºå¯¹è±¡ï¼‰ï¼Œå…ˆå»åç«¯æ‹‰
      let page = activePages[pagePrepareCursor];
      const needFetch = !page || !page.content || !Array.isArray(page.content.ops);

      if (needFetch) {
        // è‹¥ä½ è¿˜æ²¡å®ç° ensurePagesFetchedUpToï¼Œè¿™é‡Œä¼šç›´æ¥ returnï¼ˆé¿å…æ­»å¾ªç¯ï¼‰
        if (typeof ensurePagesFetchedUpTo !== 'function') {
          return;
        }

        // åªç¡®ä¿å½“å‰é¡µï¼ˆcursor è¿™é¡µï¼‰æ‹¿åˆ°å³å¯
        await ensurePagesFetchedUpTo(pagePrepareCursor + 1, { userInitiated });

        if (myToken !== pagePrepareToken) return;
        page = activePages[pagePrepareCursor];

        // æ‹‰å®Œä¾ç„¶æ²¡æœ‰ï¼Œè¯´æ˜åˆ°å¤´äº†/å¤±è´¥äº†ï¼Œé¿å…æ­»å¾ªç¯
        if (!page || !page.content || !Array.isArray(page.content.ops)) {
          return;
        }
      }

      // âœ… å·²å‡†å¤‡è¿‡å°±è·³è¿‡
      if (typeof page.sentenceStartIndex === 'number' && typeof page.segmentedHtml === 'string') {
        pagePrepareCursor++;
        continue;
      }

      // âœ… ç”Ÿæˆ sentenceStartIndex + segmentedHtml
      const startIndex = pageSentenceCounter;
      page.sentenceStartIndex = startIndex;

      const rawHtml = deltaToHtml(page.content || { ops: [] });
      const segmented = segmentContentAndAddIds(rawHtml, activeWork._id, startIndex);

// è®°å½•æœ¬é¡µâ€œæœ‰æ•ˆå¥å­æ•°é‡â€ï¼ˆç»™è¯„è®ºè®¡æ•°ä¸æ‰¹é‡åŠ è½½ç”¨ï¼‰
let cnt = 0;
if (segmented) {
  if (typeof segmented.nextIndex === 'number') {
    cnt = segmented.nextIndex - page.sentenceStartIndex;
  }
}
if (typeof cnt !== 'number') cnt = 0;
if (cnt < 0) cnt = 0;
page.__sentenceIdsCount = cnt;

pageSentenceCounter = segmented.nextIndex;
page.segmentedHtml = segmented.element.innerHTML;

      pagePrepareCursor++;

      // è®©å‡ºä¸»çº¿ç¨‹ï¼Œé¿å…é•¿å¾ªç¯å¡æ­»
      if (Date.now() - loopStart > 12) {
        await sleep(0);
      }
    }
  } finally {
    pagePrepareRunning = false;
  }
}


function floorPlaceholderHtml() {
  return `<div class="lazy-floor-placeholder"><span class="spinner"></span><span>æ­£åœ¨åŠ è½½â€¦</span></div>`;
}

function hydrateRenderedFloorsRange(startIndex, endIndex) {
  for (let i = startIndex; i < endIndex; i++) {
    const page = activePages[i];
    const floorBody = document.querySelector(`.floor[data-page-index="${i}"] .floor-body`);
    if (!floorBody) continue;
    if (!page || !page.segmentedHtml) continue;

    floorBody.innerHTML = page.segmentedHtml;
    floorBody.dataset.hydrated = '1';
    processContentForSentenceIds(floorBody);
    // å¦‚æœè¯„è®ºæ ‡è®°è¿˜åœ¨è·¯ä¸Šï¼šç­‰å®ƒåˆ°äº†å†ç»™æœ¬æ¥¼è¡¥ä¸€æ¬¡â€œè¯„è®ºç¬¦å·â€
if (commentedIdsReadyPromise) {
  if (!commentedIdsReady) {
    if (!floorBody.dataset.commentMarkPending) {
      floorBody.dataset.commentMarkPending = '1';
      commentedIdsReadyPromise.then(() => {
        if (floorBody.isConnected) {
          processContentForSentenceIds(floorBody);
        }
      });
    }
  }
}


  }

  triggerCommentsRenderForFloors(startIndex, endIndex);

  // å¼±ç½‘ï¼šä¸åŠ è½½èƒŒæ™¯ç‰¹æ•ˆï¼ˆçœå†…å­˜ï¼‰
  if (isWeakLazyMode) {
    setBgEffectsDisabled(true);
    return;
  }

  if (isBgEffectsDisabled()) return;

  // âœ… å…³é”®ï¼šå†…å®¹çœŸæ­£è¿›å…¥ DOM åï¼Œé‡æ–° initï¼ˆé‡å»º bgSegmentsï¼‰
  if (typeof initReadingBackgroundSystem === 'function') {
    initReadingBackgroundSystem();
    return;
  }

  if (typeof recalcBgSegmentPositions === 'function') {
    if (typeof updateReadingBackgroundByScroll === 'function') {
      recalcBgSegmentPositions();
      updateReadingBackgroundByScroll(false);
    }
  }
}


function startLazySlowWatchdog() {
  clearTimeout(lazySlowTimer);
  lazySlowTimer = setTimeout(() => {
    if (currentMode !== 'scroll') return;
    if (isWeakLazyMode) return;

    const need = Math.min(renderedFloorCount, activePages.length);

    var notReady = false;

    if (typeof pagePrepareCursor === 'number') {
      if (pagePrepareCursor < need) notReady = true;
    }

    // é€‚é…â€œçœŸÂ·æ‡’åŠ è½½æŒ‰éœ€æ‹‰ pagesâ€
    if (!notReady) {
      if (typeof pagesFetchCursor === 'number') {
        if (pagesFetchCursor < need) notReady = true;
      }
    }

    if (!notReady) {
      if (typeof pagesFetchInFlight !== 'undefined') {
        if (pagesFetchInFlight) notReady = true;
      }
    }

    if (notReady) {
      switchToWeakLazyMode();
    }
  }, LAZY_SLOW_THRESHOLD_MS);
}

function switchToWeakLazyMode() {
  if (isWeakLazyMode) return;
isWeakLazyMode = true;
setBgEffectsDisabled(true); // âœ… å¼±ç½‘ï¼šå…³é—­èƒŒæ™¯ç³»ç»Ÿ
  pagePrepareToken++; // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ prepare

  showLazyToast(
    'æ£€æµ‹åˆ°å¼± wifi ç¯å¢ƒ/ä¸æœåŠ¡å™¨çš„è¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨åˆ‡æ¢åŠ è½½æ ·å¼â€¦è¯·ç‚¹å‡»â€œå¯¼èˆªâ€ä»¥è·³è½¬é˜…è¯»ä½ç½®',
    { weak:true, showNav:true }
  );

if (currentMode === 'scroll') {
  if (bookContent) {
    if (Array.isArray(activePages)) {
      bookContent.innerHTML = '';
      renderedFloorCount = 0;

      const total = activePages.length;
      const initialEnd = Math.min(total, WEAK_INITIAL_PAGES);

      resetLazyPrepareState(); // âœ… å¿…é¡»ï¼šé‡ç½® cursor/token/counter
      renderFloorsRange(0, initialEnd);
      renderedFloorCount = initialEnd;

      window.scrollTo({ top: 0, behavior: 'smooth' });

      // åªç¡®ä¿å‰ä¸¤é¡µå‡†å¤‡å¥½
      ensurePagesPreparedUpTo(initialEnd, { userInitiated: true })
        .then(() => {
          hydrateRenderedFloorsRange(0, initialEnd);
        })
        .finally(() => {
          // å¼±ç½‘æç¤ºé»˜è®¤ä¸è‡ªåŠ¨éšè—ï¼ˆä½ è¦éšè—å°±æ‰‹åŠ¨ hideLazyToast()ï¼‰
        });
    }
  }
}

}



        /* ---------- displayErrorï¼ˆä¸è¦æ“ä½œ Quill çš„ DOMï¼‰ ---------- */
        function displayError(message) {
            // ç»Ÿä¸€æŠŠé”™è¯¯ç›´æ¥å†™å…¥ bookContentï¼ˆæˆ‘ä»¬ä¸åœ¨è¿™é‡Œç»‘å®š Quill åˆ° bookContentï¼‰
            bookContent.innerHTML = `<p style="color:red;text-align:center;">${escapeHtml(message)}</p>`;
            workTitle.textContent = 'é”™è¯¯';
        }

        function escapeHtml(text) {
            const map = { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' };
            return String(text || '').replace(/[&<>"']/g, m => map[m]);
        }

function renderFloorsRange(startIndex, endIndex) {
  if (!activePages || activePages.length === 0) return;
  if (!bookContent) return;

  var didRenderHydrated = false;

  for (let pageIndex = startIndex; pageIndex < endIndex; pageIndex++) {
    if (pageIndex >= activePages.length) break;

    const page = activePages[pageIndex];

    const floorDiv = document.createElement('div');
    floorDiv.className = 'floor';
    floorDiv.dataset.pageIndex = String(pageIndex);

    const countText = getCommentsCountForPage(pageIndex);

    floorDiv.innerHTML = `
      <div class="floor-header">
        <span>${pageIndex + 1} æ¥¼</span>
        <button class="comment-view-btn" data-page-index="${pageIndex}">
          æŸ¥çœ‹æœ¬æ¥¼è¯„è®ºï¼ˆ${countText}ï¼‰
        </button>
      </div>
      <div class="floor-body ql-editor" data-hydrated="0">
        ${page && page.segmentedHtml ? page.segmentedHtml : floorPlaceholderHtml()}
      </div>
    `;

    bookContent.appendChild(floorDiv);

    const floorBody = floorDiv.querySelector('.floor-body');
    if (!floorBody) continue;

    const commentBtn = floorDiv.querySelector('.comment-view-btn');
    if (commentBtn) {
      commentBtn.addEventListener('click', () => {
        openCommentPanelForPage(pageIndex);
      });
    }

    // åªæœ‰çœŸæ­£æœ‰å†…å®¹æ—¶æ‰ç»‘å®šå¥å­ç‚¹å‡»
    if (page && page.segmentedHtml) {
      didRenderHydrated = true;
      floorBody.dataset.hydrated = '1';
      processContentForSentenceIds(floorBody);
    }
  }

  // âœ… å…³é”®ï¼šå ä½æ¸²æŸ“é˜¶æ®µä¸è¦ init èƒŒæ™¯ï¼ˆå¦åˆ™æ‰«ä¸åˆ°å¥å­èŠ‚ç‚¹å°±â€œæ¸…ç©ºèƒŒæ™¯â€ï¼‰
  if (isBgEffectsDisabled()) return;
  if (!didRenderHydrated) return;

  if (typeof initReadingBackgroundSystem === 'function') {
    initReadingBackgroundSystem();
  } else {
    if (typeof recalcBgSegmentPositions === 'function') {
      if (typeof updateReadingBackgroundByScroll === 'function') {
        recalcBgSegmentPositions();
        updateReadingBackgroundByScroll(false);
      }
    }
  }
}

      // ====== èƒŒæ™¯ç³»ç»Ÿå¼€å…³ï¼ˆå¼±ç½‘æ¨¡å¼ç¦ç”¨ä»¥çœå†…å­˜ï¼‰ ======
let bgEffectsDisabled = false;

function isBgEffectsDisabled() {
  if (isWeakLazyMode) return true;
  if (bgEffectsDisabled) return true;
  return false;
}

function setBgEffectsDisabled(disabled) {
  bgEffectsDisabled = !!disabled;

  // éšè—èƒŒæ™¯å®¹å™¨ï¼ˆå¦‚æœä½ èƒŒæ™¯ç³»ç»Ÿç”¨çš„å°±æ˜¯è¿™ä¸ª idï¼‰
  var wrap = document.getElementById('read-bg-wrapper');
  if (wrap) {
    wrap.style.display = bgEffectsDisabled ? 'none' : '';
  }

  if (bgEffectsDisabled) {
    // ç«‹åˆ»æ¸…æ‰èƒŒæ™¯å›¾ï¼Œé‡Šæ”¾æ˜¾å­˜/å†…å­˜
    try {
      if (typeof stopBgHeartbeat === 'function') stopBgHeartbeat();
    } catch (_) {}
    try {
      if (typeof clearReadingBackground === 'function') clearReadingBackground();
    } catch (_) {}

    // å¼±ç½‘ä¸‹ä¹Ÿç¦ç”¨â€œèƒŒæ™¯é€è§†â€
    try { setBgPeekMode(false); } catch (_) {}
  }
}


     // ====== èƒŒæ™¯é€è§†ï¼ˆShift / æŒ‰é’®ï¼‰ ======
const bgPeekBtn = document.getElementById('bg-peek-btn');
let isBgPeekMode = false;

// ä¸ CSS æ–­ç‚¹ä¿æŒä¸€è‡´ï¼ˆmax-width: 1050pxï¼‰
function bgPeekIsMobile() {
  return window.matchMedia('(max-width: 1050px)').matches;
}
function bgPeekIsDesktop() {
  return !bgPeekIsMobile();
}

// ç»Ÿä¸€åº”ç”¨ï¼šæ¡Œé¢ç”¨ bg-peek-modeï¼Œç§»åŠ¨ç«¯ç”¨ bg-peek-mobile-mode
function applyBgPeekState() {
  // å¼±ç½‘/ç¦ç”¨èƒŒæ™¯ï¼šå¼ºåˆ¶å…³é—­é€è§†
  if (isBgEffectsDisabled()) {
    isBgPeekMode = false;
  }

  document.body.classList.remove('bg-peek-mode');
  document.body.classList.remove('bg-peek-mobile-mode');

  if (bgPeekBtn) {
    bgPeekBtn.classList.remove('active');
  }
  if (typeof bgPeekMobile !== 'undefined') {
    if (bgPeekMobile) {
      bgPeekMobile.classList.remove('active');
    }
  }

  if (!isBgPeekMode) return;

  if (bgPeekIsMobile()) {
    document.body.classList.add('bg-peek-mobile-mode');
    if (typeof bgPeekMobile !== 'undefined') {
      if (bgPeekMobile) {
        bgPeekMobile.classList.add('active');
      }
    }
  } else {
    document.body.classList.add('bg-peek-mode');
    if (bgPeekBtn) {
      bgPeekBtn.classList.add('active');
    }
  }
}



function setBgPeekMode(on) {
  isBgPeekMode = !!on;
  applyBgPeekState();
}

function toggleBgPeekMode() {
  setBgPeekMode(!isBgPeekMode);
}

// â€”â€” å°è´´å£«å¼¹çª—ï¼ˆåªåœ¨ PC æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®æ—¶å¼¹ï¼‰
function showBgPeekShiftTip() {
  if (!bgPeekIsDesktop()) return;

  var id = 'bg-peek-shift-tip';
  var tip = document.getElementById(id);
  if (!tip) {
    tip = document.createElement('div');
    tip.id = id;
    tip.setAttribute('role', 'status');
    tip.setAttribute('aria-live', 'polite');
    tip.style.position = 'fixed';
    tip.style.left = '14px';
    tip.style.bottom = '14px';
    tip.style.zIndex = '3000';
    tip.style.maxWidth = '320px';
    tip.style.background = 'rgba(20, 20, 20, 0.85)';
    tip.style.color = '#fff';
    tip.style.padding = '10px 12px';
    tip.style.borderRadius = '12px';
    tip.style.fontSize = '14px';
    tip.style.lineHeight = '1.4';
    tip.style.boxShadow = '0 6px 18px rgba(0,0,0,0.25)';
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(8px)';
    tip.style.transition = 'opacity 160ms ease, transform 160ms ease';
    document.body.appendChild(tip);
  }

  tip.textContent = 'å°è´´å£«ï¼šæŒ‰ Shift ä¹Ÿå¯ä»¥åˆ‡æ¢èƒŒæ™¯é€è§†æ¨¡å¼';

  requestAnimationFrame(function () {
    tip.style.opacity = '1';
    tip.style.transform = 'translateY(0)';
  });

  if (tip.__hideTimer) {
    clearTimeout(tip.__hideTimer);
  }
  tip.__hideTimer = setTimeout(function () {
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(8px)';
  }, 2000);
}

// æ‰‹åŠ¨æŒ‰é’®ï¼šç‚¹å‡»åˆ‡æ¢ï¼ˆPC æŒ‰é’®ï¼‰
if (bgPeekBtn) {
  bgPeekBtn.addEventListener('click', function (e) {
    if (e) e.preventDefault();
    toggleBgPeekMode();
    showBgPeekShiftTip();
  });
}

// ç§»åŠ¨ç«¯æŒ‰é’®ï¼šç‚¹å‡»åˆ‡æ¢
if (typeof bgPeekMobileBtn !== 'undefined') {
  if (bgPeekMobileBtn) {
    bgPeekMobileBtn.addEventListener('click', function (e) {
      if (e) e.preventDefault();
      toggleBgPeekMode();
    });
  }
}

// å±å¹•å°ºå¯¸åˆ‡æ¢æ—¶ï¼šå¦‚æœå¤„åœ¨å¼€å¯çŠ¶æ€ï¼ŒæŠŠ class æŒ‚åˆ°æ­£ç¡®ç«¯
window.addEventListener('resize', function () {
  if (!isBgPeekMode) return;
  applyBgPeekState();
});

/**
 * âœ… å…³é”®ç‚¹ï¼šåªåœ¨â€œå•ç‹¬æŒ‰ä¸€ä¸‹ Shiftï¼ˆæ²¡æœ‰æ­é…å…¶å®ƒæŒ‰é”®/é¼ æ ‡åŠ¨ä½œï¼‰â€æ—¶è§¦å‘
 */
let shiftDown = false;
let shiftUsedWithOther = false;

function shouldIgnoreKeyTarget(target) {
  if (!target) return false;
  if (target.isContentEditable) return true;

  var tag = (target.tagName || '').toLowerCase();
  if (tag === 'input') return true;
  if (tag === 'textarea') return true;
  if (tag === 'select') return true;
  return false;
}

document.addEventListener('keydown', function (e) {
  if (!bgPeekIsDesktop()) return;

  if (e.key === 'Shift') {
    if (shiftDown) return;
    if (shouldIgnoreKeyTarget(e.target)) return;
    shiftDown = true;
    shiftUsedWithOther = false;
    return;
  }

  if (shiftDown) {
    shiftUsedWithOther = true;
  }
});

// åªè¦ Shift æŒ‰ç€æ—¶å‘ç”Ÿé¼ æ ‡åŠ¨ä½œï¼Œå°±è§†ä¸ºâ€œæ­é…å…¶å®ƒåŠ¨ä½œâ€
document.addEventListener('mousedown', function () {
  if (shiftDown) shiftUsedWithOther = true;
}, true);

document.addEventListener('keyup', function (e) {
  if (!bgPeekIsDesktop()) return;
  if (e.key !== 'Shift') return;

  if (!shouldIgnoreKeyTarget(e.target)) {
    if (shiftDown) {
      if (!shiftUsedWithOther) {
        toggleBgPeekMode();
      }
    }
  }

  shiftDown = false;
  shiftUsedWithOther = false;
});



// åˆå§‹åŒ– / é‡æ–°æ¸²æŸ“æ¥¼å±‚æ¨¡å¼
async function renderScrollMode(initialTargetPageIndex = 0) {
  currentMode = 'scroll';
  if (!bookContent) return;

  bookContent.innerHTML = '';
  renderedFloorCount = 0;

  const total = Array.isArray(activePages) ? activePages.length : 0;
  if (!total) return;

  // âœ… å…³é”®ï¼šè¿›å…¥ scroll æ¨¡å¼æ—¶ï¼Œé‡ç½®â€œæŒ‰éœ€å†…å®¹å‡†å¤‡â€æ¸¸æ ‡ï¼ˆä¸è¦å…¨é‡é¢„å¤„ç†ï¼‰
  resetLazyPrepareState();

  // å¼±ç½‘æ¨¡å¼ï¼šå¼ºåˆ¶ä»ç¬¬ 1 æ¥¼å¼€å§‹ï¼Œä¸è·³è½¬åˆ°ç›®æ ‡æ¥¼å±‚
  const safeTarget = isWeakLazyMode
    ? 0
    : Math.min(Math.max(initialTargetPageIndex, 0), total - 1);

  const initialEnd = isWeakLazyMode
    ? Math.min(total, WEAK_INITIAL_PAGES)
    : Math.min(total, Math.max(FLOOR_BATCH_SIZE, safeTarget + 1));

  // å…ˆæ¸²æŸ“æ¥¼å±‚å£³ï¼ˆfloor-body ä¼šæ˜¯å ä½â€œæ­£åœ¨åŠ è½½...â€ï¼‰
  renderFloorsRange(0, initialEnd);
  renderedFloorCount = initialEnd;

  // ä¾§è¾¹æ åªè´Ÿè´£æ€»æ¥¼å±‚å¯¼èˆª
  renderSidebar(total, 'floor');

  // ç»‘å®šæ‡’åŠ è½½æ»šåŠ¨
  setupFloorLazyLoading();

  // âœ… æ˜¾ç¤ºåŠ è½½æç¤º + å¯åŠ¨è¶…æ—¶ç›‘æµ‹
  showLazyToast('æ­£åœ¨åŠ è½½â€¦');
  startLazySlowWatchdog();

  try {
    // âœ… æŒ‰éœ€å‡†å¤‡é¦–æ‰¹æ¥¼å±‚å†…å®¹ï¼ˆç”¨æˆ·è¿›å…¥é¡µé¢ï¼šç®— userInitiatedï¼‰
    await ensurePagesPreparedUpTo(initialEnd, { userInitiated: true });

    // âœ… hydrateï¼šæŠŠå ä½æ›¿æ¢ä¸ºçœŸå®å†…å®¹
    hydrateRenderedFloorsRange(0, initialEnd);

    // âœ… æŠŠè¯„è®ºæ•°ï¼ˆâ€¦ï¼‰æ›´æ–°æˆçœŸå®æ•°å­—
    for (let i = 0; i < initialEnd; i++) {
      const btn = document.querySelector(`.floor[data-page-index="${i}"] .comment-view-btn`);
      if (btn) btn.textContent = `æŸ¥çœ‹æœ¬æ¥¼è¯„è®ºï¼ˆ${getCommentsCountForPage(i)}ï¼‰`;
    }
  } finally {
    // å¼±ç½‘æ¨¡å¼æç¤ºä¸€èˆ¬è¦å¸¸é©»ï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆå»¶æ—¶éšè—ï¼‰
    if (!isWeakLazyMode) hideLazyToast();
  }

  // âœ… éå¼±ç½‘æ¨¡å¼ä¸‹æ‰æ»šåŠ¨åˆ°ç›®æ ‡æ¥¼å±‚
  if (!isWeakLazyMode) {
  if (safeTarget > 0) {
    const targetFloor = document.querySelector(`.floor[data-page-index="${safeTarget}"]`);
    if (targetFloor) {
      boostBgHeartbeat(6000);
      targetFloor.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
}


  // âœ… è®°å½•ä½ç½®ï¼šå¼±ç½‘æ¨¡å¼ä¸€å®šè®° 0ï¼ˆç¬¬ 1 æ¥¼ï¼‰
  saveLastViewToStorage('scroll', safeTarget);
}

// ç¡®ä¿æŸä¸€æ¥¼å·²ç»è¢«æ¸²æŸ“ï¼ˆä¾›å¯¼èˆª/å¤–éƒ¨è·³è½¬ä½¿ç”¨ï¼‰
function ensureFloorRendered(targetPageIndex) {
    const total = activePages ? activePages.length : 0;
    if (!total) return;

    if (targetPageIndex < renderedFloorCount) return;

    const needEnd = Math.min(
        total,
        Math.max(renderedFloorCount, targetPageIndex + 1 + FLOOR_BATCH_SIZE)
    );

    if (needEnd > renderedFloorCount) {
        renderFloorsRange(renderedFloorCount, needEnd);
        renderedFloorCount = needEnd;
    }
}

function setupFloorLazyLoading() {
  if (floorLazyScrollHandler) {
    window.removeEventListener('scroll', floorLazyScrollHandler);
  }

  let lastTriggerAt = 0;

  floorLazyScrollHandler = () => {
    if (currentMode !== 'scroll') return;

    // â­ 1) è®°å½•æœ€è¿‘é˜…è¯»æ¥¼å±‚ï¼ˆä¿ç•™ä½ åŸé€»è¾‘ï¼‰
    if (bookContent) {
      const floorEls = bookContent.querySelectorAll('.floor');
      if (floorEls.length > 0) {
        const viewportTop = window.scrollY;
        const viewportMiddle = viewportTop + window.innerHeight * 0.3;

        let nearestIndex = 0;
        let minDiff = Infinity;

        floorEls.forEach(el => {
          const rect = el.getBoundingClientRect();
          const floorTop = rect.top + window.scrollY;
          const diff = Math.abs(floorTop - viewportMiddle);
          if (diff < minDiff) {
            minDiff = diff;
            const idxStr = el.getAttribute('data-page-index') || '0';
            const idx = parseInt(idxStr, 10);
            if (!isNaN(idx)) nearestIndex = idx;
          }
        });

        saveLastViewToStorage('scroll', nearestIndex);
      }
    }

    // â­ 2) è§¦åº•æ‡’åŠ è½½ï¼ˆæ”¹ä¸º requestLoadMoreFloorsï¼‰
    const scrollPos = window.scrollY + window.innerHeight;
    const docHeight = document.documentElement.scrollHeight || document.body.scrollHeight;

    // é˜²æŠ–ï¼šé¿å…æ»šåŠ¨å›å¼¹/å¤šæ¬¡è§¦å‘
    if (scrollPos + 300 >= docHeight) {
      const now = Date.now();
      if (now - lastTriggerAt < 350) return;
      lastTriggerAt = now;

      requestLoadMoreFloors();
    }

    // â­ 3) å¼±ç½‘æ¨¡å¼ï¼šå½“åªæ¸²æŸ“äº†å‰ä¸¤æ¥¼æ—¶ï¼Œç”¨æˆ·ç»§ç»­æ»‘åˆ°åº•ä¹Ÿä¼šç»§ç»­åŠ è½½ï¼ˆrequestLoadMoreFloors å·²è¦†ç›–ï¼‰
    // ä¸éœ€è¦é¢å¤–åˆ†æ”¯
  };

  // å»ºè®® passiveï¼Œå‡å°‘æ»šåŠ¨å¼€é”€
  window.addEventListener('scroll', floorLazyScrollHandler, { passive: true });
}


async function requestLoadMoreFloors() {
  if (isLoadingMoreFloors) return;
  if (currentMode !== 'scroll') return;
  if (!Array.isArray(activePages)) return;

  const total = activePages.length;
  if (renderedFloorCount >= total) return;

  isLoadingMoreFloors = true;

  const prevStart = renderedFloorCount;

  // âœ… å…³é”®æ”¹åŠ¨ï¼šå¼±ç½‘æ¯æ¬¡ +2ï¼ˆæ‡’æ‡’åŠ è½½ï¼‰ï¼Œæ­£å¸¸æ¯æ¬¡ +FLOOR_BATCH_SIZEï¼ˆæ¯”å¦‚ 5ï¼‰
  const step = isWeakLazyMode ? WEAK_INITIAL_PAGES : FLOOR_BATCH_SIZE;
  const nextEnd = Math.min(total, renderedFloorCount + step);

  // é˜²å¾¡ï¼šä¸‡ä¸€ step é…ç½®å¼‚å¸¸å¯¼è‡´ nextEnd ä¸åŠ¨ï¼Œé¿å…æ­»å¾ªç¯
  if (nextEnd <= prevStart) {
    isLoadingMoreFloors = false;
    return;
  }

  // å…ˆæ¸²æŸ“æ¥¼å±‚å£³ï¼ˆfloor-body ç”¨å ä½â€œæ­£åœ¨åŠ è½½...â€ï¼‰
  showLazyToast('æ­£åœ¨åŠ è½½â€¦');
  renderFloorsRange(prevStart, nextEnd);
  renderedFloorCount = nextEnd;

  // å¯åŠ¨ 60s ç›‘æµ‹ï¼šå‡†å¤‡å¤ªä¹…å°±åˆ‡å¼±ç½‘æ¨¡å¼
  startLazySlowWatchdog();

  try {
    // å…³é”®ï¼šæŒ‰éœ€å‡†å¤‡å†…å®¹ï¼ˆç”¨æˆ·è§¦å‘ï¼šå¼±ç½‘æ¨¡å¼ä¹Ÿå…è®¸ç»§ç»­ï¼‰
    await ensurePagesPreparedUpTo(nextEnd, { userInitiated: true });

    // æŠŠå ä½æ›¿æ¢ä¸ºçœŸå® segmentedHtml
    hydrateRenderedFloorsRange(prevStart, nextEnd);

    // æ›´æ–°è¯„è®ºæ•°æŒ‰é’®ï¼ˆæŠŠ â€¦ æ›¿æ¢æˆæ•°å­—ï¼‰
    for (let i = prevStart; i < nextEnd; i++) {
      const btn = document.querySelector(`.floor[data-page-index="${i}"] .comment-view-btn`);
      if (btn) btn.textContent = `æŸ¥çœ‹æœ¬æ¥¼è¯„è®ºï¼ˆ${getCommentsCountForPage(i)}ï¼‰`;
    }
  } finally {
    isLoadingMoreFloors = false;
    // å¼±ç½‘æ¨¡å¼ä¸‹ä½ å¯èƒ½å¸Œæœ›æç¤ºå¸¸é©»ï¼Œæ‰€ä»¥è¿™é‡Œä»…åœ¨éå¼±ç½‘æ—¶éšè—
    if (!isWeakLazyMode) hideLazyToast();
  }
}


        /* ---------- æ¸²æŸ“å™¨ï¼šç¿»é¡µï¼ˆå•é¡µï¼‰æ¨¡å¼ ---------- */
        function destroyPageModeQuill() {
            // å¦‚æœä¹‹å‰å­˜åœ¨ pageQuillï¼Œéœ€è¦åˆ é™¤å®ƒçš„å®¹å™¨å¹¶é‡Šæ”¾å¼•ç”¨
            if (pageQuill) {
    let container = null;

    if (pageQuill.root) {
        container = pageQuill.root.parentElement;
    }

    try {
        pageQuill.disable();
    } catch (e) {}

    pageQuill = null;

    if (container) {
        if (container.parentNode) {
            container.parentNode.removeChild(container);
        }
    }
}

        }

function renderPageMode() {
    // 1. æ¸…ç†ç¯å¢ƒ
    destroyPageModeQuill();
    bookContent.innerHTML = '';
    const pageDiv = document.createElement('div');
    pageDiv.className = 'page-view';
  pageDiv.id = 'page-view'; // âœ… æ–°å¢ï¼šè®©èƒŒæ™¯ç³»ç»Ÿèƒ½å‡†ç¡®æ‹¿åˆ°å®¹å™¨
    // container for Quill
    const quillContainer = document.createElement('div');
    quillContainer.id = 'quill-page-view';
    quillContainer.style.minHeight = '200px';
    pageDiv.appendChild(quillContainer);

   const footer = document.createElement('div');
footer.className = 'page-footer';

footer.innerHTML = `
    <button id="prev-page">ä¸Šä¸€é¡µ</button>
    <span id="page-indicator">ç¬¬ ${currentPageIndex + 1} / ${activePages.length}</span>
    <button id="next-page">ä¸‹ä¸€é¡µ</button>
    <button id="page-view-comment-btn" class="page-view-comment-btn">
        æŸ¥çœ‹è¯„è®º (0)
    </button>
`;


    pageDiv.appendChild(footer);
    bookContent.appendChild(pageDiv); // ğŸ’¥ æ­¤æ—¶æŒ‰é’®å·²è¿›å…¥ DOM

    // 3. åˆå§‹åŒ– Quill
    pageQuill = new Quill('#quill-page-view', { theme: 'snow', readOnly: true, modules: { toolbar: false } });

    // 4. åŠ è½½å½“å‰é¡µå†…å®¹
    loadPageIntoPageQuill(currentPageIndex);

    // 5. ç»‘å®šç¿»é¡µæŒ‰é’®
    document.getElementById('prev-page')?.addEventListener('click', () => { // å¢åŠ  ?. æ£€æŸ¥
        if (currentPageIndex > 0) {
            currentPageIndex--;
            loadPageIntoPageQuill(currentPageIndex);
            window.scrollTo(0,0);
        }
    });
    document.getElementById('next-page')?.addEventListener('click', () => { // å¢åŠ  ?. æ£€æŸ¥
        if (currentPageIndex < activePages.length - 1) {
            currentPageIndex++;
            loadPageIntoPageQuill(currentPageIndex);
            window.scrollTo(0,0);
        }
    });

    // 6. ç»‘å®šç¿»é¡µæ¨¡å¼ä¸‹çš„è¯„è®ºæŒ‰é’®äº‹ä»¶ (ä¿®å¤é‡å¤ç»‘å®š + å¥å£®æ€§)
    
    // ğŸ’¥ ä¿®å¤é‡å¤ç»‘å®šï¼šç”¨å…‹éš†èŠ‚ç‚¹æ›¿æ¢è‡ªèº«ï¼Œä»¥æ¸…é™¤æ—§ç›‘å¬å™¨
    let commentBtn = document.getElementById('page-view-comment-btn');
    
    // ğŸ’¥ å…³é”®å¥å£®æ€§æ£€æŸ¥: å¦‚æœæŒ‰é’®ä¸å­˜åœ¨ï¼Œåˆ™åœæ­¢åç»­æ“ä½œ
    if (!commentBtn) {
         console.error('è¯„è®ºæŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶ã€‚');
         return; 
    }
    
    const newCommentBtn = commentBtn.cloneNode(true);
    commentBtn.replaceWith(newCommentBtn); // æ›¿æ¢æ—§å…ƒç´ ï¼Œæ¸…é™¤æ—§ç›‘å¬å™¨

    // ç»‘å®šäº‹ä»¶åˆ°æ–°çš„æŒ‰é’®ä¸Š
    newCommentBtn.addEventListener('click', () => {
        // ç¿»é¡µæ¨¡å¼ä¸‹ï¼Œç›´æ¥ä½¿ç”¨å½“å‰çš„ currentPageIndex ä½œä¸º pageIndex
        openCommentPanelForPage(currentPageIndex);
    });

    // 7. æ¸²æŸ“å·¦ä¾§é¡µç å¯¼èˆª
    renderSidebar(activePages.length, 'page');

  const pageCommentBtn = document.getElementById('page-view-comment-btn');
if (pageCommentBtn) {
    const commentCount = getCommentsCountForPage(pageIndex);
    pageCommentBtn.textContent = `æŸ¥çœ‹è¯„è®º (${commentCount})`;
}
processContentForSentenceIds(bookContent);
}

        // ã€ä¿®æ”¹ script.txt: 91-96 è¡Œé™„è¿‘ï¼Œåœ¨ loadPageIntoPageQuill å‡½æ•°ä½“å†…éƒ¨ã€‘
function loadPageIntoPageQuill(pageIndex) {
    if (!pageQuill) return;
    const pageObj = activePages[pageIndex] || { content: { ops: [] } };
    
    let contentHtml = '';
    
    // 1. è·å–åŸå§‹å†…å®¹ï¼ˆé€šå¸¸æ˜¯ Delta æˆ– HTMLï¼‰
    try {
        if (typeof pageObj.content === 'object') {
            // å°† Delta è½¬æ¢ä¸º HTML
            contentHtml = deltaToHtml(pageObj.content); 
        } else {
            // å¦‚æœåç«¯å­˜çš„æ˜¯ html å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
            contentHtml = pageObj.content || '<p>ï¼ˆç©ºç™½ï¼‰</p>';
        }
    } catch (e) {
        console.warn('loadPageIntoPageQuill deltaToHtml fallback', e);
        contentHtml = '<p>ï¼ˆæ— æ³•æ˜¾ç¤ºï¼‰</p>';
    }
    
    // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šä½¿ç”¨ç¼“å­˜çš„èµ·å§‹ç´¢å¼•é‡æ–°æ³¨å…¥ SentenceId
    // 2. ç¡®å®šè¯¥é¡µé¢çš„èµ·å§‹ç´¢å¼•ï¼ˆå·²åœ¨ loadWorkContentById ä¸­ç¼“å­˜ï¼‰
    const pageStartIndex = pageObj.sentenceStartIndex ?? 0;
    
    // 3. è°ƒç”¨æ— å‰¯ä½œç”¨çš„ ID æ³¨å…¥å‡½æ•°ï¼Œä½¿ç”¨å›ºå®šçš„èµ·å§‹ç´¢å¼•
    // æ³¨æ„ï¼šä¸æ›´æ–°å…¨å±€ contentIndexCounter
    const result = segmentContentAndAddIds(contentHtml, activeWork._id, pageStartIndex);
    
    // 4. å°†å¸¦æœ‰ ID çš„ HTML æ³¨å…¥åˆ° Quill çš„æ ¹å…ƒç´ ä¸­ (ç»•è¿‡ setContents å¯¼è‡´çš„ ID ä¸¢å¤±)
    // âš ï¸ å¿…é¡»ç›´æ¥æ“ä½œ root.innerHTML
    pageQuill.root.innerHTML = result.element.innerHTML;

    // æ›´æ–°é¡µç æŒ‡ç¤º
    const indicator = document.getElementById('page-indicator');
    if (indicator) indicator.textContent = `ç¬¬ ${pageIndex + 1} / ${activePages.length}`;
    
    // 5. æ ‡è®°å†…å®¹å¹¶ç»‘å®šäº‹ä»¶ (ç»‘å®šå¥æœ«è¯„è®ºæ ‡è¯†å’Œå¥å­ç‚¹å‡»äº‹ä»¶)
const pageCommentBtn = document.getElementById('page-view-comment-btn');
if (pageCommentBtn) {
    const commentCount = getCommentsCountForPage(currentPageIndex);
    pageCommentBtn.textContent = `æŸ¥çœ‹è¯„è®º (${commentCount})`;
}
  processContentForSentenceIds(pageQuill.root);
  // æ–°å¢ï¼šç¿»é¡µæ¨¡å¼ä¸‹è®°å½•å½“å‰é¡µ
    saveLastViewToStorage('page', pageIndex);
}

// ã€ä¿®æ”¹ script.txt: 87 è¡Œé™„è¿‘ï¼Œåœ¨ renderPageMode å‡½æ•°ä½“å†…éƒ¨ã€‘
    // æ–°å¢: ç»‘å®šç¿»é¡µæ¨¡å¼ä¸‹çš„è¯„è®ºæŒ‰é’®äº‹ä»¶
const pageContainer = document.getElementById('page-container'); // æŒ‰é’®çš„çˆ¶å®¹å™¨
if (pageContainer) {
    pageContainer.addEventListener('click', (e) => {
        if (e.target) {
    if (e.target.id === 'page-view-comment-btn') {
        openCommentPanelForPage(currentPageIndex);
    }
}

    });
}
              // é˜…è¯»ç«¯ç”¨çš„èƒŒæ™¯é…ç½®é€‰æ‹©ï¼šä¼˜å…ˆå·²å‘å¸ƒï¼Œå…¶æ¬¡è‰ç¨¿ï¼ˆä½œè€…é¢„è§ˆæ—¶ä¹Ÿèƒ½çœ‹åˆ°ï¼‰
        function pickBackgroundConfigForRead(work) {
            if (!work || typeof work !== 'object') {
                return { images: [], bindings: [], transitions: [] };
            }
            if (work.backgroundPublished && typeof work.backgroundPublished === 'object') {
                return work.backgroundPublished;
            }
            if (work.backgroundDraft && typeof work.backgroundDraft === 'object') {
                return work.backgroundDraft;
            }
            return { images: [], bindings: [], transitions: [] };
        }
        // å½“å‰æ¨¡å¼ä¸‹çœŸæ­£æ˜¾ç¤ºå¥å­çš„å®¹å™¨
        function getCurrentReadingContainer() {
            // scroll æ¨¡å¼ï¼šæ•´ç¯‡æ¥¼å±‚åˆ—è¡¨
            if (currentMode === 'scroll') {
                return bookContent; // ä½ åŸæ¥çš„æ¥¼å±‚å®¹å™¨
            }
            // page æ¨¡å¼ï¼šç¿»é¡µåŒºåŸŸ
            const pageView = document.getElementById('page-view');
            return pageView || bookContent;
        }
        // åˆå§‹åŒ– / é‡å»º èƒŒæ™¯åŒºé—´åˆ—è¡¨ï¼ˆèµ·å§‹å¥ / ç»“æŸå¥ -> å‚ç›´ä½ç½®ï¼‰
function initReadingBackgroundSystem() {
  // 1ï¸âƒ£ ä½œå“æ˜¯å¦å­˜åœ¨
  if (!activeWork) {
    if (EFFECT_BG_DEBUG) {
      console.log('ğŸ§© [BG] æ²¡æœ‰ activeWorkï¼Œè·³è¿‡èƒŒæ™¯ç³»ç»Ÿ');
    }
    return;
  }

  // 2ï¸âƒ£ èƒŒæ™¯ DOM æ˜¯å¦å°±ç»ª
  if (!bgWrapper || !bgLayerA || !bgLayerB) {
    if (EFFECT_BG_DEBUG) {
      console.log('ğŸ§© [BG] èƒŒæ™¯ DOM ä¸å®Œæ•´ï¼Œwrapper / layerA / layerB æœ‰ç¼ºå¤±ï¼š', {
        bgWrapper: !!bgWrapper,
        bgLayerA: !!bgLayerA,
        bgLayerB: !!bgLayerB
      });
    }
    return;
  }

  // 3ï¸âƒ£ è¯»å–ä½œå“é‡Œçš„èƒŒæ™¯é…ç½®
  const conf = pickBackgroundConfigForRead(activeWork);
  const images = Array.isArray(conf.images) ? conf.images : [];
  const bindings = Array.isArray(conf.bindings) ? conf.bindings : [];

   // â­ æ–°å¢ï¼šæŠŠå½“å‰é…ç½®è®°åˆ°å…¨å±€ï¼Œç»™ pickBgTransitionEffect ç”¨
  bgConfig = {
    images,
    bindings,
    transitions: Array.isArray(conf.transitions) ? conf.transitions : []
  };

  if (EFFECT_BG_DEBUG) {
    console.log('ğŸ§© [BG] åŸå§‹ background é…ç½®:', conf);
    console.log('ğŸ§© [BG] images:', images);
    console.log('ğŸ§© [BG] bindings:', bindings);
  }

  bgSegments = [];
  const imageMap = {};

  // 4ï¸âƒ£ å»ºç«‹ imageId -> å›¾ç‰‡ä¿¡æ¯ çš„æ˜ å°„
  images.forEach(function (img, idx) {
    if (!img) {
      return;
    }

    var key = img.imageId || img.id;
    if (!key) {
      key = 'bg-' + String(idx);
    }

    imageMap[String(key)] = {
      id: String(key),
      url: img.url,
      name: img.name || ''
    };
  });

  if (EFFECT_BG_DEBUG) {
    console.log('ğŸ§© [BG] imageMap:', imageMap);
  }

  // 5ï¸âƒ£ æ‰¾åˆ°å½“å‰çœŸæ­£æ˜¾ç¤ºå¥å­çš„å®¹å™¨
  const containerEl = getCurrentReadingContainer();
  if (!containerEl) {
    if (EFFECT_BG_DEBUG) {
      console.log('ğŸ§© [BG] æ‰¾ä¸åˆ°é˜…è¯»å®¹å™¨');
    }
    return;
  }

  if (EFFECT_BG_DEBUG) {
    const allNodes = containerEl.querySelectorAll('[data-sentence-index]');
    let maxIdx = -1;
    allNodes.forEach(el => {
      const n = Number(el.dataset.sentenceIndex);
      if (!Number.isNaN(n) && n > maxIdx) maxIdx = n;
    });
    console.log('ğŸ§© [BG] å½“å‰ DOM é‡Œå¥å­èŠ‚ç‚¹æ•°é‡ =', allNodes.length, 'ï¼Œæœ€å¤§ index =', maxIdx);
  }

  // 6ï¸âƒ£ æŒ‰ç»‘å®šç”Ÿæˆæ¯ä¸€æ®µèƒŒæ™¯åŒºé—´
  bindings.forEach(function (b, idx) {
    if (!b) {
      return;
    }

    const startLine = Number(b.startLine);
    const endLine = Number(b.endLine);
    const img = imageMap[String(b.imageId)];

    const startSelector = '[data-sentence-index="' + startLine + '"]';
    const endSelector   = '[data-sentence-index="' + endLine + '"]';
    const startEl = containerEl.querySelector(startSelector);
    const endEl   = containerEl.querySelector(endSelector);

    if (EFFECT_BG_DEBUG) {
      console.log('ğŸ§© [BG] å¤„ç†ç»‘å®š #' + idx, {
        imageId: b.imageId,
        imageName: b.imageName,
        startLine: startLine,
        endLine: endLine,
        startSelector: startSelector,
        endSelector: endSelector,
        hasImg: !!img,
        hasStartEl: !!startEl,
        hasEndEl: !!endEl,
        startText: startEl ? startEl.textContent.trim().slice(0, 20) : null,
        endText: endEl ? endEl.textContent.trim().slice(0, 20) : null
      });
    }

    if (!img) {
      return;
    }
    if (!startEl) {
      return;
    }
    if (!endEl) {
      return;
    }

    bgSegments.push({
      imageId: img.id,
      imageUrl: img.url,
      imageName: b.imageName || img.name,
      startLine: startLine,
      endLine: endLine,
      startEl: startEl,
      endEl: endEl,
      startTop: 0,
      endBottom: 0
    });
  });

  if (EFFECT_BG_DEBUG) {
    console.log('ğŸ§© [BG] æœ€ç»ˆç”Ÿæˆçš„ bgSegments:', bgSegments);
  }

  if (!bgSegments.length) {
    if (EFFECT_BG_DEBUG) {
      console.log('ğŸ§© [BG] æ²¡æœ‰ä»»ä½•æœ‰æ•ˆçš„èƒŒæ™¯åŒºé—´ï¼Œä¿æŒé»˜è®¤ç°è‰²èƒŒæ™¯');
    }
    clearReadingBackground();
    return;
  }

  // 7ï¸âƒ£ å…ˆè®¡ç®—ä¸€æ¬¡å„åŒºé—´çš„ä½ç½®ï¼Œå†æŒ‰å½“å‰æ»šåŠ¨ä½ç½®æ›´æ–°ä¸€æ¬¡èƒŒæ™¯
  recalcBgSegmentPositions();
  updateReadingBackgroundByScroll(true);

  // 8ï¸âƒ£ åªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ç»‘å®š scroll / resize äº‹ä»¶
  if (!window.__BG_SCROLL_BOUND__) {
    window.addEventListener(
      'scroll',
      function () {
        boostBgHeartbeat(900); 
        updateReadingBackgroundByScroll(false);
      },
      { passive: true }
    );

    window.addEventListener('resize', function () {
      boostBgHeartbeat(1500); 
      recalcBgSegmentPositions();
      updateReadingBackgroundByScroll(false);
    });

    window.__BG_SCROLL_BOUND__ = true;
    startBgHeartbeat();

    if (EFFECT_BG_DEBUG) {
      console.log('ğŸ§© [BG] å·²ç»‘å®š scroll / resize äº‹ä»¶');
    }
  }
}

        // é‡æ–°è®¡ç®—æ¯ä¸ªâ€œèƒŒæ™¯åŒºé—´â€çš„èµ·å§‹ / ç»“æŸ Y åæ ‡ï¼ˆç»å¯¹ä½ç½®ï¼‰
        function recalcBgSegmentPositions() {
            if (!bgSegments.length) return;
            const scrollY = window.scrollY || document.documentElement.scrollTop || 0;

            bgSegments.forEach(seg => {
                if (!seg.startEl || !seg.endEl) return;
                const startRect = seg.startEl.getBoundingClientRect();
                const endRect = seg.endEl.getBoundingClientRect();
                seg.startTop = startRect.top + scrollY;
                seg.endBottom = endRect.bottom + scrollY;
            });
        }

function boostBgHeartbeat(ms) {
  const dur = (typeof ms === 'number') ? ms : 3000;
  const until = Date.now() + dur;
  if (until > bgHeartbeatFastUntil) {
    bgHeartbeatFastUntil = until;
  }
}

function startBgHeartbeat() {
  if (bgHeartbeatTimer) return;
  bgHeartbeatLastScrollY = -1;
  bgHeartbeatLastDocH = -1;
  bgHeartbeatMismatchStreak = 0;

  bgHeartbeatTimer = setInterval(bgHeartbeatTick, 250);
}

function stopBgHeartbeat() {
  if (!bgHeartbeatTimer) return;
  clearInterval(bgHeartbeatTimer);
  bgHeartbeatTimer = null;
}

function bgHeartbeatTick() {
  if (!bgSegments) return;
  if (bgSegments.length === 0) return;
  if (!bgLayerA) return;
  if (!bgLayerB) return;

  const now = Date.now();
  const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
  const docH = document.documentElement.scrollHeight || 0;

  // é¡µé¢é™æ­¢ä¸”ä¸åœ¨â€œå¿«é€Ÿçº åçª—å£â€ â†’ ä¸åšäº‹ï¼ˆçœæ€§èƒ½ï¼‰
  if (now >= bgHeartbeatFastUntil) {
    if (scrollY === bgHeartbeatLastScrollY) {
      if (docH === bgHeartbeatLastDocH) {
        return;
      }
    }
  }
  bgHeartbeatLastScrollY = scrollY;
  bgHeartbeatLastDocH = docH;

  const centerY = scrollY + window.innerHeight * 0.4;

  // currentBgSegment å¯èƒ½åœ¨é‡å»º bgSegments åâ€œå¼•ç”¨å¤±æ•ˆâ€
  if (currentBgSegment) {
    if (bgSegments.indexOf(currentBgSegment) === -1) {
      currentBgSegment = null;
    }
  }

  // 1) å…ˆå¿«é€Ÿåˆ¤æ–­ï¼šå½“å‰æ®µç”¨â€œå®æ—¶ rectâ€æ˜¯å¦ä»è¦†ç›– centerY
  if (currentBgSegment) {
    const seg = currentBgSegment;
    if (seg.startEl) {
      if (seg.endEl) {
        const sRect = seg.startEl.getBoundingClientRect();
        const eRect = seg.endEl.getBoundingClientRect();
        const freshStart = sRect.top + scrollY;
        const freshEnd = eRect.bottom + scrollY;

        if (centerY >= freshStart) {
          if (centerY <= freshEnd) {
            if (currentBgImageId === seg.imageId) {
              bgHeartbeatMismatchStreak = 0;
              return;
            }
          }
        }
      }
    }
  }

  // 2) æ‰¾åˆ°â€œå®æ—¶ä½ç½®â€ä¸‹ï¼ŒcenterY åº”è¯¥å±äºå“ªä¸€æ®µï¼ˆæˆ–æœ€è¿‘æ®µï¼‰
  let expectedSeg = null;
  let nearestSeg = null;
  let minDist = Infinity;

  for (let i = 0; i < bgSegments.length; i++) {
    const seg2 = bgSegments[i];
    if (!seg2) continue;
    if (!seg2.startEl) continue;
    if (!seg2.endEl) continue;

    const sRect2 = seg2.startEl.getBoundingClientRect();
    const eRect2 = seg2.endEl.getBoundingClientRect();
    const start2 = sRect2.top + scrollY;
    const end2 = eRect2.bottom + scrollY;

    if (centerY >= start2) {
      if (centerY <= end2) {
        expectedSeg = seg2;
        break;
      }
    }

    let dist = 0;
    if (centerY < start2) dist = start2 - centerY;
    else if (centerY > end2) dist = centerY - end2;
    else dist = 0;

    if (dist < minDist) {
      minDist = dist;
      nearestSeg = seg2;
    }
  }

  if (!expectedSeg) expectedSeg = nearestSeg;
  if (!expectedSeg) return;

  // 3) è¿ç»­é”™ä¸¤æ¬¡ï¼ˆæˆ–å¤„äº fast çª—å£ï¼‰æ‰çº åï¼Œé¿å… smooth scroll ä¸­é—´æ€æŠ–åŠ¨
  if (currentBgImageId !== expectedSeg.imageId) {
    bgHeartbeatMismatchStreak++;
  } else {
    bgHeartbeatMismatchStreak = 0;
  }

  let shouldFix = false;
  if (bgHeartbeatMismatchStreak >= 2) shouldFix = true;
  if (now < bgHeartbeatFastUntil) shouldFix = true;

  if (!shouldFix) return;

  bgHeartbeatMismatchStreak = 0;

  // âœ… æ ¸å¿ƒï¼šé‡ç®—åŒºé—´åæ ‡ + ç«‹å³æŒ‰æ»šåŠ¨ä½ç½®åˆ·æ–°èƒŒæ™¯
  recalcBgSegmentPositions();
  updateReadingBackgroundByScroll(true);
}

      
        function handleBgScrollThrottled() {
            if (bgScrollTicking) return;
            bgScrollTicking = true;
            requestAnimationFrame(() => {
                bgScrollTicking = false;
                updateReadingBackgroundByScroll(false);
            });
        }

        // æ ¹æ®å½“å‰æ»šåŠ¨ä½ç½®ï¼ˆè§†å£ä¸­å¿ƒï¼‰å†³å®šåº”è¯¥ä½¿ç”¨å“ªä¸ªèƒŒæ™¯
        function updateReadingBackgroundByScroll(isImmediate) {
    // 1ï¸âƒ£ æ²¡æœ‰ä»»ä½•èƒŒæ™¯åŒºé—´ï¼Œç›´æ¥ä¿æŒé»˜è®¤ç°è‰²
    if (!bgSegments.length) {
        clearReadingBackground();
        return;
    }

    const scrollY = window.scrollY || document.documentElement.scrollTop || 0;
    const vh = window.innerHeight || document.documentElement.clientHeight || 0;
    const centerY = scrollY + vh / 2;   // è§†å£ä¸­å¿ƒä½œä¸ºâ€œåˆ¤å®šç‚¹â€

    // 2ï¸âƒ£ å…ˆæŒ‰æ­£å¸¸é€»è¾‘ï¼Œçœ‹çœ‹ centerY æ˜¯å¦è½åœ¨æŸä¸ªåŒºé—´å†…
    let targetSeg = null;
    for (let i = 0; i < bgSegments.length; i++) {
        const seg = bgSegments[i];
        if (seg.startTop <= centerY) {
            if (centerY <= seg.endBottom) {
                targetSeg = seg;
                break;
            }
        }
    }

    // 3ï¸âƒ£ å¦‚æœæ²¡å‘½ä¸­ä»»ä½•åŒºé—´ï¼šå°è¯•é€‰æ‹©â€œè·ç¦»æœ€è¿‘çš„ä¸€æ®µâ€
    if (!targetSeg) {
        let nearestSeg = null;
        let minDist = Infinity;

        for (let j = 0; j < bgSegments.length; j++) {
            const seg2 = bgSegments[j];

            let dist = 0;
            if (centerY < seg2.startTop) {
                dist = seg2.startTop - centerY;   // åœ¨è¯¥æ®µä¸Šæ–¹
            } else if (centerY > seg2.endBottom) {
                dist = centerY - seg2.endBottom;  // åœ¨è¯¥æ®µä¸‹æ–¹
            } else {
                dist = 0;
            }

            if (dist < minDist) {
                minDist = dist;
                nearestSeg = seg2;
            }
        }

        const threshold = vh * 0.5;

        // â­ æ–°å¢ï¼šåˆ¤æ–­æ˜¯å¦â€œå…è®¸é€€å›ç°è‰²èƒŒæ™¯â€
        // å¦‚æœ bindings æ€»æ•° > å·²æˆåŠŸç”Ÿæˆçš„ bgSegments æ•°ï¼Œè¯´æ˜æœ‰ä¸€éƒ¨åˆ†ç»‘å®šè¿˜æ²¡è¢«æ‡’åŠ è½½åˆ° DOM é‡Œï¼Œ
        // è¿™æ—¶å€™ä¸è¦æ¸…ç©ºèƒŒæ™¯ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä½ ç°åœ¨é‡åˆ°çš„â€œæå‰å˜ç°ä¸€ä¸‹â€çš„æƒ…å†µã€‚
        let allowClearToDefault = true;
        if (bgConfig && Array.isArray(bgConfig.bindings)) {
            if (bgConfig.bindings.length > bgSegments.length) {
                allowClearToDefault = false;
            }
        }

        if (nearestSeg) {
            // æ˜¯å¦é‡‡ç”¨æœ€è¿‘çš„ä¸€æ®µèƒŒæ™¯
            let useNearest = false;

            if (minDist < threshold) {
                useNearest = true;
            } else {
                // å³ä½¿ç¦»å¾—æ¯”è¾ƒè¿œï¼Œåªè¦è¿˜æœ‰â€œæœªè½åœ°çš„ç»‘å®šâ€ï¼Œä¹Ÿå¼ºè¡Œç”¨æœ€è¿‘çš„ä¸€æ®µï¼Œ
                // é¿å…åœ¨æ‡’åŠ è½½è¿‡ç¨‹ä¸­å‡ºç°è«åå…¶å¦™çš„ç°è‰²é—ªä¸€ä¸‹
                if (!allowClearToDefault) {
                    useNearest = true;
                }
            }

            if (useNearest) {
                targetSeg = nearestSeg;
            } else {
                // çœŸæ­£ç¦»æ‰€æœ‰èƒŒæ™¯éƒ½å¾ˆè¿œï¼Œä¸”å·²ç»ç¡®è®¤â€œæ‰€æœ‰ç»‘å®šéƒ½è½åœ°â€æ—¶ï¼Œæ‰é€€å›é»˜è®¤ç°è‰²
                if (allowClearToDefault) {
                    if (currentBgImageId !== null) {
                        playBackgroundTransition(null, 'fade', isImmediate);
                        currentBgImageId = null;
                        currentBgSegment = null;
                    }
                }
                return;
            }
        } else {
            // è¿æœ€è¿‘çš„ä¸€æ®µéƒ½æ²¡æœ‰ï¼ˆæç«¯æƒ…å†µï¼‰ï¼ŒåŒæ ·åªæœ‰åœ¨å…è®¸çš„å‰æä¸‹æ‰æ¸…ç©º
            if (allowClearToDefault) {
                if (currentBgImageId !== null) {
                    playBackgroundTransition(null, 'fade', isImmediate);
                    currentBgImageId = null;
                    currentBgSegment = null;
                }
            }
            return;
        }
    }

    // 4ï¸âƒ£ å¦‚æœåˆ¤å®šç»“æœå’Œå½“å‰èƒŒæ™¯å®Œå…¨ä¸€æ ·ï¼Œå°±ä¸é‡å¤åˆ‡æ¢ï¼ˆä¿æŒä½ ä¹‹å‰çš„â€œæ—  &&â€å†™æ³•ï¼‰
    if (currentBgSegment) {
        if (currentBgSegment === targetSeg) {
            if (currentBgImageId === targetSeg.imageId) {
                return;
            }
        }
    }

    // 5ï¸âƒ£ æ ¹æ® from / to å†³å®šè½¬åœºç‰¹æ•ˆ
    const effectType = pickBgTransitionEffect(currentBgSegment, targetSeg);

    currentBgSegment = targetSeg;
    currentBgImageId = targetSeg.imageId;
    playBackgroundTransition(targetSeg.imageUrl, effectType, isImmediate);
}


        // æ ¹æ® fromSeg / toSeg å’Œ bgTransitions å†³å®šè½¬åœºç‰¹æ•ˆç±»å‹
        function pickBgTransitionEffect(fromSeg, toSeg) {
            if (!bgConfig || !Array.isArray(bgConfig.transitions)) {
                return 'fade';
            }
            if (!fromSeg || !toSeg) {
                // ä»é»˜è®¤ç°èƒŒæ™¯è¿›å…¥æŸä¸€æ®µï¼Œæˆ–ä»æŸä¸€æ®µé€€å‡ºåˆ°é»˜è®¤èƒŒæ™¯ï¼šç”¨æ™®é€šæ·¡å…¥æ·¡å‡º
                return 'fade';
            }
            const fromLine = fromSeg.endLine;
            const toLine = toSeg.startLine;
            const found = bgConfig.transitions.find(t =>
                Number(t.fromLine) === fromLine &&
                Number(t.toLine) === toLine
            );
            return (found && found.effectType) || 'fade';
        }
        function clearReadingBackground() {
            if (!bgLayerA || !bgLayerB) return;
            bgLayerA.style.opacity = '0';
            bgLayerB.style.opacity = '0';
            bgLayerA.style.backgroundImage = '';
            bgLayerB.style.backgroundImage = '';
            currentBgImageId = null;
            currentBgSegment = null;
        }

        // æ ¹æ® effectType åˆ‡æ¢èƒŒæ™¯å›¾ç‰‡
        function playBackgroundTransition(nextImageUrl, effectType, isImmediate) {
    if (!bgLayerA || !bgLayerB) return;

    if (EFFECT_BG_DEBUG) {
        console.log('ğŸ§© [BG] playBackgroundTransition è°ƒç”¨', {
            nextImageUrl,
            effectType,
            isImmediate,
            currentBgLayerFlag
        });
    }

    const currentLayer = currentBgLayerFlag === 'A' ? bgLayerA : bgLayerB;
    const nextLayer = currentBgLayerFlag === 'A' ? bgLayerB : bgLayerA;

    if (!nextImageUrl) {
        currentLayer.style.opacity = '0';
        nextLayer.style.opacity = '0';
        return;
    }

    nextLayer.style.backgroundImage = `url("${nextImageUrl}")`;

    if (isImmediate) {
                nextLayer.style.transition = 'none';
                currentLayer.style.transition = 'none';

                nextLayer.style.opacity = '1';
                currentLayer.style.opacity = '0';

                requestAnimationFrame(() => {
                    nextLayer.style.transition = '';
                    currentLayer.style.transition = '';
                });

                currentBgLayerFlag = currentBgLayerFlag === 'A' ? 'B' : 'A';
      if (EFFECT_BG_DEBUG) {
            console.log('ğŸ§© [BG] ç«‹å³åˆ‡æ¢åˆ°èƒŒæ™¯', {
                layerId: nextLayer.id,
                bg: nextLayer.style.backgroundImage,
                opacity: nextLayer.style.opacity
            });
        }
                return;
            }


    nextLayer.style.opacity = '1';
    currentLayer.style.opacity = '0';
    currentBgLayerFlag = currentBgLayerFlag === 'A' ? 'B' : 'A';

    if (EFFECT_BG_DEBUG) {
        console.log('ğŸ§© [BG] åŠ¨ç”»åˆ‡æ¢åˆ°èƒŒæ™¯', {
            layerId: nextLayer.id,
            bg: nextLayer.style.backgroundImage,
            opacity: nextLayer.style.opacity
        });
    }
}




    // ã€åˆ é™¤æˆ–æ³¨é‡Šæ‰æ—§çš„ addCommentListenersToContainer è°ƒç”¨ã€‘
    // addCommentListenersToContainer(pageQuill.root, currentPageIndex); [cite: 88]
        

/* ---------- æ¸²æŸ“å·¦ä¾§å¯¼èˆªï¼ˆæ¥¼å±‚æˆ–é¡µç ï¼‰ ---------- */
function renderSidebar(total, type) {
    // æ¨¡å¼åˆ‡æ¢æŒ‰é’®å’Œå¤œé—´æ¨¡å¼æŒ‰é’®å·²åœ¨ HTML ä¸­å†™æ­»
    const navToggleBtnGroup = document.getElementById('nav-toggle-btn');
    const navToggleIcon = navToggleBtnGroup.querySelector('button');

    // æ›´æ–°å¯¼èˆªæŒ‰é’®çš„å›¾æ ‡ï¼ˆæ¥¼å±‚ <-> é¡µç ï¼‰
    if (type === 'floor') {
        navToggleIcon.innerHTML = '&#8635;'; // æ¥¼å±‚æ¨¡å¼å›¾æ ‡
    } else {
        navToggleIcon.innerHTML = '&#x2194;'; // ç¿»é¡µæ¨¡å¼å›¾æ ‡
    }

    // é‡æ–°åˆ›å»ºå¯¼èˆªç½‘æ ¼æµ®çª—
    const navPopup = document.getElementById('nav-grid-popup');
    navPopup.innerHTML = '';

    for (let i = 0; i < total; i++) {
        const cell = document.createElement('div');
        cell.className = 'nav-cell';
        cell.textContent = i + 1;
        cell.dataset.targetIndex = String(i);

        // â­ æŠŠç‚¹å‡»é€»è¾‘æ”¾åœ¨çœŸæ­£çš„ç‚¹å‡»å›è°ƒé‡Œï¼Œè€Œä¸æ˜¯ for å¾ªç¯é‡Œç›´æ¥æ‰§è¡Œ
        cell.addEventListener('click', function () {
            // ç‚¹å‡»åå…³é—­æµ®çª—
            navPopup.classList.remove('show');

            if (type === 'floor') {
                // æ¥¼å±‚æ¨¡å¼ï¼šå…ˆä¿è¯è¯¥æ¥¼å·²ç»æ¸²æŸ“ï¼Œå†æ»šè¿‡å»
                if (typeof ensureFloorRendered === 'function') {
                    ensureFloorRendered(i);
                }

                // ä¸‹ä¸€å¸§å†æ»šåŠ¨ï¼Œé¿å…åˆš append æ—¶å¸ƒå±€æ²¡æ›´æ–°
                setTimeout(function () {
                    const selector = '.floor[data-page-index="' + i + '"]';
                    const targetFloor = document.querySelector(selector);
                    if (targetFloor) {
                        targetFloor.scrollIntoView({ behavior: 'smooth', block: 'start' });
               
                    }
                  // â­ ç‚¹å‡»å¯¼èˆªåç«‹åˆ»è®°å½•å½“å‰æ¥¼å±‚
                    saveLastViewToStorage('scroll', i);
                }, 0);
            } else {
                // ç¿»é¡µæ¨¡å¼ï¼šåˆ‡æ¢ currentPageIndex å¹¶é‡æ–°æ¸²æŸ“
                currentPageIndex = i;
                currentMode = 'page';
                renderCurrentMode();
                window.scrollTo(0, 0);
              // â­ ç¿»é¡µæ¨¡å¼å¯¼èˆªåè®°å½•é¡µç 
                saveLastViewToStorage('page', i);
            }
        });

        navPopup.appendChild(cell);
    }
}


   // åˆ‡æ¢å¤œé—´æ¨¡å¼
function toggleDarkMode() {
    const isDarkMode = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDarkMode ? 'true' : 'false');
    // åŒæ—¶æ›´æ–°å…¶ä»–å…ƒç´ 
    document.querySelector('.book-container').classList.toggle('dark-mode', isDarkMode);
    document.querySelector('.comment-panel').classList.toggle('dark-mode', isDarkMode);
    document.getElementById('nav-grid-popup').classList.toggle('dark-mode', isDarkMode);
    document.querySelectorAll('.floor, .page-view').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
    document.querySelectorAll('.sidebar-btn-group').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
    // ğŸ’¥ å…³é”®ä¿®æ­£: ç¡®ä¿ #sidebar æœ¬èº«è·å¾— dark-mode ç±»
    document.getElementById('sidebar').classList.toggle('dark-mode', isDarkMode);
    
    // ğŸ’¥ æ–°å¢: éå†æ‰€æœ‰å·²å­˜åœ¨çš„è¯„è®ºé¡¹å¹¶æ›´æ–°ç±»
    document.querySelectorAll('.comment-item').forEach(el => el.classList.toggle('dark-mode', isDarkMode));
    // ğŸ’¥ æ–°å¢: æ›´æ–°ç¿»é¡µæŒ‰é’®çš„ dark-mode ç±» (å¦‚æœå­˜åœ¨)
    document.querySelector('.page-footer')?.classList.toggle('dark-mode', isDarkMode);
}

// åˆå§‹åŒ–å¤œé—´æ¨¡å¼
function initDarkMode() {
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if (isDarkMode) {
        document.body.classList.add('dark-mode');
        document.querySelector('.book-container').classList.add('dark-mode');
        document.querySelector('.comment-panel').classList.add('dark-mode');
        document.getElementById('nav-grid-popup').classList.add('dark-mode');
        document.querySelectorAll('.floor, .page-view').forEach(el => el.classList.add('dark-mode'));
        document.querySelectorAll('.sidebar-btn-group').forEach(el => el.classList.add('dark-mode'));
        // ğŸ’¥ å…³é”®ä¿®æ­£: ç¡®ä¿ #sidebar æœ¬èº«è·å¾— dark-mode ç±»
        document.getElementById('sidebar').classList.add('dark-mode');
        // ğŸ’¥ æ–°å¢: æ›´æ–°ç¿»é¡µæŒ‰é’®çš„ dark-mode ç±» (å¦‚æœå­˜åœ¨)
        document.querySelector('.page-footer')?.classList.add('dark-mode');
    }
}

// ã€æ–°å¢å‡½æ•°ã€‘ï¼šè®¾ç½®è¯„è®ºåˆ—è¡¨çš„äº‹ä»¶å§”æ‰˜ï¼ˆåªéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨ä¸€æ¬¡ï¼‰
function setupCommentDelegation() {
    // 1. å›å¤ï¼ˆç‚¹å‡» comment-itemï¼‰å’Œç‚¹èµï¼ˆç‚¹å‡» .like-btnï¼‰çš„äº‹ä»¶å§”æ‰˜
    commentList.addEventListener('click', (e) => {
        const item = e.target.closest('.comment-item');
        const btn = e.target.closest('.like-btn');

        if (btn) {
            // --- ç‚¹èµé€»è¾‘ ---
            e.stopPropagation(); 
            const token = localStorage.getItem('token');
            if (!token) { alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµã€‚'); return; }
            
            const commentItem = btn.closest('.comment-item');
            const commentId = commentItem.dataset.commentId;
            
            // å¼‚æ­¥æ‰§è¡Œç‚¹èµæ“ä½œ
            (async () => {
                try {
                    const res = await fetch(`${API_COMMENTS}/${commentId}/like`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (!res.ok) throw new Error('ç‚¹èµå¤±è´¥');
                    const data = await res.json();
                    
                    // æ›´æ–° UI
                    const countSpan = commentItem.querySelector('.like-count');
                    countSpan.textContent = data.likesCount;
                    btn.classList.toggle('liked', data.isLikedByCurrentUser);
                } catch (err) {
                    console.error('like error', err);
                    alert('ç‚¹èµå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
                }
            })();

        } else if (item) {
            // --- å›å¤é€»è¾‘ ---
            const author = item.querySelector('.comment-author')?.textContent || 'åŒ¿å';
            commentTextarea.value = `@${author} `;
            commentTextarea.focus();
        }
    });
}
      
        /* ---------- è¯„è®ºï¼šæ¸²æŸ“ & æ“ä½œ ---------- */
        function renderComments(comments) {
            commentList.innerHTML = '';
            if (!comments || comments.length === 0) {
                commentList.innerHTML = '<p class="no-comments-tip">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>';
                return;
            }
            comments.forEach(c => {
                const item = document.createElement('div');
                item.className = 'comment-item';
                item.dataset.commentId = c._id;
                const author = escapeHtml(c.author || 'åŒ¿å');
                const content = escapeHtml(c.content || '');
                const likes = Number(c.likesCount || 0);
                const likedClass = c.isLikedByCurrentUser ? 'liked' : '';
                item.innerHTML = `
                    <strong class="comment-author">${author}</strong>
                    <p class="comment-content">${content}</p>
                    <div class="comment-actions">
                        <button class="like-btn ${likedClass}">â¤</button>
                        <span class="like-count">${likes}</span>
                    </div>
                `;
                commentList.appendChild(item);
            });
            // ç»‘å®šåŠ¨ä½œ
            //addCommentActionListeners(); ï¼ˆå¸®æˆ‘æ£€æŸ¥ä¸€éï¼Œä¸å†éœ€è¦è¿™ä¸ªäº†æ˜¯å§ï¼Ÿï¼‰
        }


      // ... ç´§æ¥åœ¨ submitComment å‡½æ•°ä¹‹å‰
function disableCommentInputArea(disable) {
    const commentPanel = document.getElementById('comment-panel');
    // viewer-mode æ ·å¼åº”è´Ÿè´£éšè—è¯„è®ºè¾“å…¥æ¡†
    commentPanel.classList.toggle('viewer-mode', disable);
}

      // ã€æ–°å¢å‡½æ•°ï¼šåœ¨ renderComments æˆ– fetchPageComments é™„è¿‘æ’å…¥ã€‘

async function openCommentPanelForPage(pageIndex) {
  const pageObj = activePages[pageIndex];
  if (!pageObj) return;

  // æ²¡å‡†å¤‡å¥½å°±å…ˆå‡†å¤‡ï¼ˆç”¨æˆ·è§¦å‘ï¼šå…è®¸å¼±ç½‘æ¨¡å¼ç»§ç»­åŠ è½½ï¼‰
  if (!pageObj.segmentedHtml) {
    showLazyToast('æ­£åœ¨åŠ è½½æœ¬æ¥¼å†…å®¹â€¦');
    await ensurePagesPreparedUpTo(pageIndex + 1, { userInitiated:true });
    hydrateRenderedFloorsRange(pageIndex, pageIndex + 1);
    hideLazyToast();
  }

  // â†“â†“â†“ ä¸‹é¢ä¿ç•™ä½ åŸæ¥çš„é€»è¾‘å³å¯
  const pageTitle = `ç¬¬ ${pageIndex + 1} æ¥¼/é¡µ`;
    const commentPanel = document.getElementById('comment-panel');
    const header = commentPanel.querySelector('h4');
    
    disableCommentInputArea(true);
    activeSentenceEl = null;

    // âœ… æ”¹åŠ¨ç‚¹ï¼šç›´æ¥ä½¿ç”¨å·²ç¼“å­˜çš„ HTMLï¼Œè€Œä¸æ˜¯å†è·‘ deltaToHtml
    const htmlContent = pageObj.segmentedHtml || '<p>ï¼ˆç©ºç™½ï¼‰</p>';

    // ä¸´æ—¶è§£æ HTMLï¼Œæå–æ‰€æœ‰å¥å­ ID
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    const pageSentenceIds = Array.from(tempDiv.querySelectorAll('[data-sentence-id]'))
        .map(el => el.getAttribute('data-sentence-id'));

  const workId = getActiveWorkIdForComments();
  if (!workId) { alert('ä½œå“å°šæœªåŠ è½½å®Œæˆ'); return; }



  if (typeof pageObj.sentenceStartIndex === 'number') {
    if (typeof pageObj.__sentenceIdsCount === 'number') {
      const start = pageObj.sentenceStartIndex;
      const count = pageObj.__sentenceIdsCount;

      if (count > 0) {
        for (let k = 0; k < count; k++) {
          pageSentenceIds.push(buildSentenceId(workId, start + k));
        }
      }
    }
  }

  if (pageSentenceIds.length === 0) {
    const htmlContent = pageObj.segmentedHtml || '<p>ï¼ˆç©ºç™½ï¼‰</p>';
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;

    pageSentenceIds = Array.from(tempDiv.querySelectorAll('[data-sentence-id]'))
      .map(el => el.getAttribute('data-sentence-id'))
      .filter(v => v);
  }

  // å…³é”®ï¼šåªç¡®ä¿æœ¬æ¥¼èŒƒå›´çš„è¯„è®ºå·²åŠ è½½ï¼ˆä¸ä¼šå…¨é‡æ‹‰æ•´ç¯‡ï¼‰
  await ensureCommentsLoadedForPagesRange(pageIndex, pageIndex + 1);

  // æ±‡æ€»æœ¬æ¥¼è¯„è®º
  const commentsForPage = [];
  for (let i = 0; i < pageSentenceIds.length; i++) {
    const sid = pageSentenceIds[i];
    const arr = commentBySentenceId.get(sid);
    if (!Array.isArray(arr)) continue;

    for (let j = 0; j < arr.length; j++) {
      commentsForPage.push(arr[j]);
    }
  }

  commentsForPage.sort((a, b) => {
    const ta = new Date(a.createdAt).getTime();
    const tb = new Date(b.createdAt).getTime();
    if (ta < tb) return -1;
    if (ta > tb) return 1;
    return 0;
  });

  renderComments(commentsForPage);
  header.textContent = `${pageTitle} çš„æ‰€æœ‰è¯„è®º (${commentsForPage.length} æ¡)`;
  commentPanel.classList.add('show');
    
    renderComments(commentsForPage);
    header.textContent = `${pageTitle} çš„æ‰€æœ‰è¯„è®º (${commentsForPage.length} æ¡)`;
    
    commentPanel.classList.add('show');

}

      
async function openCommentPanelForSentence(sentenceId, isNewCommentMode = false) {
  const panel = document.getElementById('comment-panel');
  const header = panel.querySelector('h4');

  if (!sentenceId) {
    alert('å¥å­IDæ— æ•ˆ');
    return;
  }

  // ç»Ÿä¸€å– workIdï¼ˆä¼˜å…ˆç”¨ä½ æ‰¹é‡æ–¹æ¡ˆé‡Œçš„å‡½æ•°ï¼‰
  let workId = null;
  if (typeof getActiveWorkIdForComments === 'function') {
    workId = getActiveWorkIdForComments();
  } else {
    if (activeWork) {
      if (activeWork._id) workId = activeWork._id;
      else if (activeWork.workId) workId = activeWork.workId;
    }
  }

  if (!workId) {
    alert('ä½œå“å°šæœªåŠ è½½å®Œæˆ');
    return;
  }

  // å…ˆæ˜¾ç¤ºåŠ è½½æ€
  header.textContent = 'æ­£åœ¨åŠ è½½è¯„è®ºâ€¦';
  renderComments([]);

  // âœ… å…³é”®ï¼šåªåŠ è½½è¯¥å¥çš„è¯„è®ºï¼ˆä¸å†å…¨é‡æ‹‰å–ï¼‰
  try {
    await ensureCommentsLoadedForSentenceId(sentenceId);
  } catch (e) {
    console.error('åŠ è½½å¥å­è¯„è®ºå¤±è´¥:', e);
    header.textContent = 'åŠ è½½è¯„è®ºå¤±è´¥';
    renderComments([]);
    panel.classList.add('show');
    return;
  }

  const arr = commentBySentenceId.get(sentenceId);
  const filteredComments = Array.isArray(arr) ? arr : [];
  renderComments(filteredComments);

  if (isNewCommentMode) {
    header.textContent = `è¯„è®ºç›®æ ‡å¥å­ï¼ˆå·²æœ‰ ${filteredComments.length} æ¡ï¼‰`;
    disableCommentInputArea(false);

    if (!activeSentenceEl) {
      activeSentenceEl = document.querySelector(`[data-sentence-id="${sentenceId}"]`);
    } else {
      if (activeSentenceEl.dataset) {
        if (activeSentenceEl.dataset.sentenceId !== sentenceId) {
          activeSentenceEl = document.querySelector(`[data-sentence-id="${sentenceId}"]`);
        }
      } else {
        activeSentenceEl = document.querySelector(`[data-sentence-id="${sentenceId}"]`);
      }
    }

    currentViewingSentenceId = sentenceId;
    setTimeout(() => commentTextarea?.focus?.(), 0);
  } else {
    header.textContent = `å¥å­è¯„è®º (${filteredComments.length} æ¡)`;
    disableCommentInputArea(true);
    currentViewingSentenceId = sentenceId;
    activeSentenceEl = null;
  }

  // æ¸…ç†æ—§é«˜äº®
  const oldTargets = document.querySelectorAll('.active-comment-target');
  oldTargets.forEach(el => el.classList.remove('active-comment-target'));

  // æ ‡è®°å½“å‰å¥å­
  const targetEl = document.querySelector(`[data-sentence-id="${sentenceId}"]`);
  if (targetEl) targetEl.classList.add('active-comment-target');

  panel.classList.add('show');
}


function processContentForSentenceIds(containerEl) {
  // åªæ¸…æœ¬å®¹å™¨çš„è¯„è®ºç¬¦å·ï¼ˆé¿å…è¶Šè·‘è¶Šå¤šï¼‰
  containerEl.querySelectorAll('.comment-indicator').forEach(el => el.remove());

  // ç‰¹æ•ˆåªåº”ç”¨ä¸€æ¬¡ï¼ˆé¿å…é‡å¤åŒ…è£¹/é‡å¤æ³¨å…¥ï¼‰
  if (!containerEl.dataset.effectsApplied) {
    if (activeWork && Array.isArray(activeWork.effectsPublished) && activeWork.effectsPublished.length) {
      const workIdForEffect = activeWork._id || activeWork.workId;
      applyEffectsToBlocks(containerEl, activeWork.effectsPublished, workIdForEffect);
    }
    containerEl.dataset.effectsApplied = '1';
  }

  const sentenceElements = containerEl.querySelectorAll('[data-sentence-id]');

  sentenceElements.forEach(el => {
    const sentenceId = el.getAttribute('data-sentence-id');
    if (!sentenceId) return;

    // âœ… å¥æœ«è¯„è®ºç¬¦å·ï¼šæœ‰è¯„è®ºæ‰æ˜¾ç¤º
    if (commentedSentenceIds.has(sentenceId)) {
      const indicator = document.createElement('span');
      indicator.className = 'comment-indicator';
      indicator.setAttribute('data-sentence-id', sentenceId);
      el.appendChild(indicator);

      // âœ… å…³é”®ï¼šç‚¹å‡»ç¬¦å·ä¹Ÿè¿›å…¥â€œå¯è¾“å…¥æ¨¡å¼â€ï¼Œå¹¶æŠŠ activeSentenceEl æŒ‡å‘è¿™å¥
      indicator.addEventListener('click', (e) => {
        e.stopPropagation();
        activeSentenceEl = el;
        Promise.resolve(openCommentPanelForSentence(sentenceId, true)).catch(console.error);
      });
    }

    // âœ… å¥å­ç‚¹å‡»ï¼šåªç»‘å®šä¸€æ¬¡ï¼ˆé¿å…å¤šæ¬¡ hydrate/åˆ·æ–°å¯¼è‡´é‡å¤è§¦å‘ï¼‰
    if (!el.dataset.commentBound) {
      el.dataset.commentBound = '1';
      el.addEventListener('click', (e) => {
        if (e.target && e.target.classList && e.target.classList.contains('comment-indicator')) return;
        activeSentenceEl = el;
        Promise.resolve(openCommentPanelForSentence(sentenceId, true)).catch(console.error);
      });
    }
  });
}

// ã€ä¿®æ”¹ openCommentPanelForViewerMode å‡½æ•°ä½“ï¼Œçº¦ é™„è¿‘ã€‘
// ç”¨æ–°çš„å‡½æ•°æ›¿æ¢æ—§çš„å¤æ‚é€»è¾‘
async function openCommentPanelForViewerMode(workId, pageIndex) {
    openCommentPanelForPage(pageIndex);
}


// æäº¤è¯„è®º async function submitComment() { ... (ä¿æŒä¸å˜)
      
        // æäº¤è¯„è®º
async function submitComment() {
  const token = localStorage.getItem('token');
  if (!token) { alert('è¯·å…ˆç™»å½•æ‰èƒ½å‘è¡¨è¯„è®ºã€‚'); return; }

  if (!activeWork) { alert('ä½œå“å°šæœªåŠ è½½å®Œæˆã€‚'); return; }
  if (!activeSentenceEl) { alert('è¯„è®ºç›®æ ‡æœªé€‰ä¸­ã€‚'); return; }

  const workIdRaw = activeWork._id || activeWork.workId;
  if (!workIdRaw) { alert('ä½œå“IDç¼ºå¤±ã€‚'); return; }

  const sentenceId = activeSentenceEl.dataset ? activeSentenceEl.dataset.sentenceId : null;
  if (!sentenceId) { alert('è¯¥æ®µè½æ— æ³•è¯„è®ºã€‚'); return; }

  const content = String(commentTextarea.value || '').trim();
  if (!content) { alert('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©ºã€‚'); return; }

  try {
    const res = await fetch(API_COMMENTS, {
      method: 'POST',
      headers: Object.assign({ 'Content-Type': 'application/json' }, getAuthHeader()),
      body: JSON.stringify({
        workId: workIdRaw,
        sentenceId: sentenceId,
        content: content
      })
    });

    if (!res.ok) {
      const errJson = await res.json().catch(() => null);
      const msg = errJson && errJson.message ? errJson.message : 'å‘è¡¨è¯„è®ºå¤±è´¥';
      throw new Error(msg);
    }

    // âœ… å…³é”®ï¼šæ‹¿åˆ°æ–°è¯„è®º
    const saved = await res.json();

    alert('è¯„è®ºå‘è¡¨æˆåŠŸï¼');
    commentTextarea.value = '';

    // ====== âœ… å†™å…¥â€œå“ªäº›å¥å­æœ‰è¯„è®ºâ€çš„é›†åˆ ======
    if (!commentedSentenceIds) commentedSentenceIds = new Set();
    if (saved && saved.sentenceId) commentedSentenceIds.add(saved.sentenceId);
    commentedIdsReady = true;

    // ====== âœ… å†™å…¥â€œè¯„è®ºå†…å®¹ç¼“å­˜â€ ======
    let workId = null;
    if (typeof getActiveWorkIdForComments === 'function') {
      workId = getActiveWorkIdForComments();
    } else {
      workId = workIdRaw;
    }

    if (workId) {
      if (typeof resetCommentCacheForWork === 'function') {
        if (typeof commentLoadedWorkId !== 'undefined') {
          if (commentLoadedWorkId !== workId) resetCommentCacheForWork(workId);
        }
      }

      const sid = saved.sentenceId;

      if (typeof commentBySentenceId !== 'undefined') {
        const old = commentBySentenceId.get(sid);
        if (Array.isArray(old)) old.push(saved);
        else commentBySentenceId.set(sid, [saved]);
      }

      if (typeof loadedCommentSentenceIds !== 'undefined') {
        loadedCommentSentenceIds.add(sid);
      }

      // ====== âœ… åˆ·æ–°è¯¥å¥å­çš„â€œå¯è¯„è®ºæ ‡è®°â€ï¼ˆä»…å±€éƒ¨ï¼‰ ======
      const el = document.querySelector(`[data-sentence-id="${sid}"]`);
      if (el) {
        const floorBody = el.closest('.floor-body');
        if (floorBody) {
          if (typeof processContentForSentenceIds === 'function') {
            processContentForSentenceIds(floorBody);
          }
        }

        // ====== âœ… æ›´æ–°æ‰€åœ¨æ¥¼å±‚æŒ‰é’®è®¡æ•°ï¼ˆä»…å±€éƒ¨ï¼‰ ======
        const floor = el.closest('.floor');
        if (floor) {
          const s = floor.getAttribute('data-page-index');
          const p = parseInt(s || '-1', 10);
          if (!Number.isNaN(p)) {
            if (typeof recomputeCommentCountForPage === 'function') {
              recomputeCommentCountForPage(p, workId);
            }
            if (typeof updateFloorCommentButton === 'function') {
              updateFloorCommentButton(p);
            }
          }
        }
      }
    }

    // âœ… é‡æ–°æ‰“å¼€è¯¥å¥å­çš„è¯„è®ºé¢æ¿ï¼ˆä¿æŒæ’°å†™æ¨¡å¼ï¼‰
    await openCommentPanelForSentence(sentenceId, true);

  } catch (err) {
    console.error('submitComment error', err);
    alert('å‘è¡¨è¯„è®ºå¤±è´¥ï¼š' + (err && err.message ? err.message : err));
  }
}

        submitCommentBtn.addEventListener('click', submitComment);

        /* ---------- åˆ‡æ¢/æ¸²æŸ“å½“å‰æ¨¡å¼ ---------- */
/* ---------- åˆ‡æ¢/æ¸²æŸ“å½“å‰æ¨¡å¼ ---------- */
function renderCurrentMode() {
    if (!activeWork) return;

    // â­ é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œå°è¯•æ ¹æ®æœ¬åœ°è®°å½•æ¢å¤é˜…è¯»ä½ç½®
    if (!hasAppliedLastView) {
        const lastView = loadLastViewFromStorage();
        if (lastView && typeof lastView.pageIndex === 'number') {
            // ä¼˜å…ˆæ¢å¤åˆ°å½“æ—¶çš„æ¨¡å¼ï¼ˆpage / scrollï¼‰
            if (lastView.mode === 'page') {
                currentMode = 'page';
                currentPageIndex = Math.min(
                    Math.max(lastView.pageIndex, 0),
                    (activePages?.length || 1) - 1
                );
            } else {
                currentMode = 'scroll';
            }

            hasAppliedLastView = true;

            if (currentMode === 'scroll') {
                // æ¥¼å±‚æ¨¡å¼ï¼šæŠŠç›®æ ‡æ¥¼å±‚ä¼ ç»™æ¸²æŸ“å‡½æ•°ï¼Œè®©å®ƒä¼˜å…ˆåŠ è½½å¹¶æ»šåŠ¨è¿‡å»
                renderScrollMode(lastView.pageIndex);
            } else {
                renderPageMode();
            }

            setTimeout(() => {
                const root = currentMode === 'scroll'
                    ? bookContent
                    : (pageQuill?.root || bookContent);
                if (root) {
                    processContentForSentenceIds(root);
                    console.log('âœ… è¯„è®ºå¥å­ç‚¹å‡»ç»‘å®šå®Œæˆï¼ˆæ¢å¤é˜…è¯»ä½ç½®ï¼‰');
                }
            }, 50);
            return; // å·²æŒ‰è®°å½•æ¸²æŸ“ï¼Œä¸å†èµ°ä¸‹é¢çš„é»˜è®¤é€»è¾‘
        }

        // æ²¡æœ‰è®°å½•ï¼Œä¹Ÿæ ‡è®°å·²å¤„ç†ï¼Œä¹‹ååˆ‡æ¢æ¨¡å¼ä¸ç”¨å†æ£€æŸ¥
        hasAppliedLastView = true;
    }

    // é»˜è®¤ï¼šæŒ‰å½“å‰æ¨¡å¼æ¸²æŸ“
    if (currentMode === 'scroll') {
        renderScrollMode();
    } else {
        renderPageMode();
    }

    setTimeout(() => {
        const root = currentMode === 'scroll'
            ? bookContent
            : (pageQuill?.root || bookContent);
        if (root) {
            processContentForSentenceIds(root);
            console.log('âœ… è¯„è®ºå¥å­ç‚¹å‡»ç»‘å®šå®Œæˆ');
        }
    }, 50);
}

        /* ---------- ä½œå“ç‚¹èµåŠŸèƒ½ ---------- */
        async function toggleWorkLike() {
            if (!activeWork || !activeWork._id) return;
            const token = localStorage.getItem('token');
            if (!token) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½ç‚¹èµä½œå“ã€‚');
                return;
            }
            try {
                const res = await fetch(`${API_WORKS}/${activeWork._id}/like`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('ç‚¹èµå¤±è´¥');
                const data = await res.json();
                updateLikeStatus(data.likesCount, data.isLikedByCurrentUser);
            } catch (err) {
                console.error('work like error', err);
                alert('ç‚¹èµæ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            }
        }

        function updateLikeStatus(likesCount, isLiked) {
            likeCounter.textContent = likesCount;
            likeIcon.classList.toggle('liked', isLiked);
        }

        likeWorkBtn.addEventListener('click', toggleWorkLike);
        
        // ç»‘å®šå¤œé—´æ¨¡å¼åˆ‡æ¢æŒ‰é’®
        document.getElementById('light-switch-btn').addEventListener('click', toggleDarkMode);


        /* ---------- å¯åŠ¨ï¼šä» URL è·å– ID å¹¶åŠ è½½ä½œå“ ---------- */
        function getWorkIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

          // ğŸ’¥ æ–°å¢ï¼šåªéœ€è°ƒç”¨ä¸€æ¬¡ï¼Œè®¾ç½®è¯„è®ºåˆ—è¡¨çš„äº‹ä»¶å§”æ‰˜
      setupCommentDelegation();

        const workId = getWorkIdFromUrl();
        loadWorkContentById(workId);


        initDarkMode();

      // ğŸš¨ VVVV ä¿®å¤æ¨¡å¼åˆ‡æ¢é‡å¤ç»‘å®š VVVV

Â  Â  Â  Â  // ä»…åœ¨ DOM åŠ è½½æ—¶ç»‘å®šä¸€æ¬¡æ¨¡å¼åˆ‡æ¢å’Œå¯¼èˆªæµ®çª—å¼€å…³çš„äº‹ä»¶ç›‘å¬å™¨
Â  Â  Â  Â  const scrollBtnGroup = document.getElementById('scroll-mode-btn');
Â  Â  Â  Â  const pageBtnGroup = document.getElementById('page-mode-btn');
Â  Â  Â  Â  const navToggleBtnGroup = document.getElementById('nav-toggle-btn');

Â  Â  Â  Â  scrollBtnGroup.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  currentMode = 'scroll';
Â  Â  Â  Â  Â  Â  renderCurrentMode();
Â  Â  Â  Â  Â  Â  // å…³é—­å¯¼èˆªæµ®çª—
Â  Â  Â  Â  Â  Â  const navPopup = document.getElementById('nav-grid-popup');
Â  Â  Â  Â  Â  Â  if (navPopup) navPopup.classList.remove('show');
Â  Â  Â  Â  });

Â  Â  Â  Â  pageBtnGroup.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  currentMode = 'page';
Â  Â  Â  Â  Â  Â  renderCurrentMode();
Â  Â  Â  Â  Â  Â  const navPopup = document.getElementById('nav-grid-popup');
Â  Â  Â  Â  Â  Â  if (navPopup) navPopup.classList.remove('show');
Â  Â  Â  Â  });

Â  Â  Â  Â  navToggleBtnGroup.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  const navPopup = document.getElementById('nav-grid-popup');
Â  Â  Â  Â  Â  Â  if (navPopup) {
Â  Â  Â  Â  Â  Â  Â  Â  navPopup.classList.toggle('show');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

                              console.log(sidebarToggleBtn);  

      sidebarToggleBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    const isMobile = window.matchMedia("(max-width: 1050px)").matches;

    if (isMobile) {
        const isShown = sidebar.classList.toggle('show');
        sidebarToggleIcon.textContent = isShown ? 'â®Ÿ' : 'â®'; // å·¦å³ç®­å¤´
        sidebarToggleBtn.setAttribute('aria-expanded', isShown ? 'true' : 'false');
        sidebarToggleBtn.setAttribute('title', isShown ? 'æ”¶èµ·ä¾§è¾¹æ ' : 'å±•å¼€ä¾§è¾¹æ ');
    } else {
        const isCollapsed = sidebar.classList.toggle('collapsed');
        sidebarToggleIcon.textContent = isCollapsed ? 'â®' : 'â®Ÿ';
        sidebarToggleBtn.setAttribute('aria-expanded', isCollapsed ? 'false' : 'true');
        sidebarToggleBtn.setAttribute('title', isCollapsed ? 'å±•å¼€ä¾§è¾¹æ ' : 'æ”¶èµ·ä¾§è¾¹æ ');
    }
});

              // æ–°å¢ï¼šç»Ÿä¸€çš„â€œå›åˆ°é¡¶éƒ¨â€å‡½æ•°
        function scrollToTopSmooth() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        if (backToTopBtn) {
            backToTopBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                scrollToTopSmooth();
            });
        }

        if (backToTopMobileBtn) {
            backToTopMobileBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                scrollToTopSmooth();
            });
        }


function getCommentsCountForPage(pageIndex) {
  const workId = getActiveWorkIdForComments();
  if (!workId) return 'â€¦';

  if (commentCountByPage.has(pageIndex)) {
    return commentCountByPage.get(pageIndex);
  }

  const hasAny = computePageHasAnyComment(pageIndex, workId);
  if (hasAny === false) return 0;

  return 'â€¦';
}

      const container = document.getElementById('book-content');
console.log(container);

      
Â  Â  }); // ç»“æŸ DOMContentLoaded ç›‘å¬å™¨


// æ³¨æ„ï¼šåŸæœ‰çš„ navToggleBtnGroup.addEventListener('click', ...) å·²ç»æœ‰äº† e.stopPropagation()
// è¿™ä¸€æ­¥å¾ˆé‡è¦ï¼Œå®ƒå¯ä»¥é˜²æ­¢ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè¯¥å…¨å±€ç›‘å¬å™¨ç«‹å³å°†æµ®çª—å…³é—­ã€‚
    </script>
</html>